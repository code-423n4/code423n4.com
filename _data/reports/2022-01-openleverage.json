{
  "circa": {
    "title": "OpenLeverage contest",
    "sponsor": "OpenLeverage",
    "slug": "2022-01-openleverage",
    "date": "2022-03-09",
    "findings": "https://github.com/code-423n4/2022-01-openleverage-findings/issues",
    "contest": 72
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 code contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the code contest outlined in this document, C4 conducted an analysis of the OpenLeverage smart contract system written in Solidity. The code contest took place between January 27—February 2 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>31 Wardens contributed reports to the OpenLeverage contest:</p>\n<ol>\n<li>hyh</li>\n<li><a href=\"https://twitter.com/defsec_\">defsec</a></li>\n<li><a href=\"https://twitter.com/gzeon\">gzeon</a></li>\n<li>WatchPug (<a href=\"https://github.com/jack-the-pug\">jtp</a> and <a href=\"https://github.com/mingwatch\">ming</a>)</li>\n<li>robee</li>\n<li>mics</li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li><a href=\"https://twitter.com/JustDravee\">Dravee</a></li>\n<li><a href=\"https://twitter.com/SolidityDev\">pauliax</a></li>\n<li>jayjonah8</li>\n<li><a href=\"https://twitter.com/cmichelio\">cmichel</a></li>\n<li><a href=\"https://twitter.com/jonah1005w\">jonah1005</a></li>\n<li><a href=\"https://www.instagram.com/riyan_rfa/\">rfa</a></li>\n<li>samruna</li>\n<li><a href=\"https://twitter.com/SirH4shalot\">sirhashalot</a></li>\n<li>cccz</li>\n<li>0x1f8b</li>\n<li>0x0x0x</li>\n<li><a href=\"https://tqts.ar/\">tqts</a></li>\n<li><a href=\"https://twitter.com/meidhiwirara\">Tomio</a></li>\n<li><a href=\"https://twitter.com/_no_handlebars\">throttle</a></li>\n<li><a href=\"https://twitter.com/_0v3rf10w\">0v3rf10w</a></li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li>p4st13r4 (<a href=\"https://github.com/0x69e8\">0x69e8</a> and 0xb4bb4)</li>\n<li><a href=\"https://twitter.com/fitraldys\">Fitraldys</a></li>\n<li>m_smirnova2020</li>\n<li>IllIllI</li>\n<li>GeekyLumberjack</li>\n<li><a href=\"https://twitter.com/wuwe19\">wuwe1</a></li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/liam_eastwood13\">0xleastwood</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a> and <a href=\"https://twitter.com/CloudEllie1\">CloudEllie</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 21 unique vulnerabilities and 83 total findings. All of the issues presented here are linked back to their original finding.</p>\n<p>Of these vulnerabilities, 1 received a risk rating in the category of HIGH severity, 5 received a risk rating in the category of MEDIUM severity, and 15 received a risk rating in the category of LOW severity.</p>\n<p>C4 analysis also identified 22 non-critical recommendations and 40 gas optimizations.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-01-openleverage\">C4 OpenLeverage contest repository</a>, and is composed of 33 smart contracts written in the Solidity programming language and includes 4251 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code423n4.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-1\" style=\"position:relative;\"><a href=\"#high-risk-findings-1\" aria-label=\"high risk findings 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (1)</h1>\n<h2 id=\"h-01-openlevv1libs-and-lpools-dotransferout-functions-call-native-payabletransfer-which-can-be-unusable-for-smart-contract-calls\" style=\"position:relative;\"><a href=\"#h-01-openlevv1libs-and-lpools-dotransferout-functions-call-native-payabletransfer-which-can-be-unusable-for-smart-contract-calls\" aria-label=\"h 01 openlevv1libs and lpools dotransferout functions call native payabletransfer which can be unusable for smart contract calls permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/75\">[H-01] OpenLevV1Lib’s and LPool’s <code>doTransferOut</code> functions call native <code>payable.transfer</code>, which can be unusable for smart contract calls</a></h2>\n<p><em>Submitted by hyh</em></p>\n<p>When OpenLev operations use a wrapped native token, the whole user withdraw is being handled with a <code>payable.transfer()</code> call.</p>\n<p>This is unsafe as <code>transfer</code> has hard coded gas budget and can fail when the user is a smart contract. This way any programmatical usage of OpenLevV1 and LPool is at risk.</p>\n<p>Whenever the user either fails to implement the payable fallback function or cumulative gas cost of the function sequence invoked on a native token transfer exceeds 2300 gas consumption limit the native tokens sent end up undelivered and the corresponding user funds return functionality will fail each time.</p>\n<p>As OpenLevV1 <code>closeTrade</code> is affected this includes user’s principal funds freeze scenario, so marking the issue as a high severity one.</p>\n<h4 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>OpenLevV1Lib and LPool have <code>doTransferOut</code> function that calls native token payable.transfer:</p>\n<p>OpenLevV1Lib.doTransferOut</p>\n<p><a href=\"https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/OpenLevV1Lib.sol#L253\">https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/OpenLevV1Lib.sol#L253</a></p>\n<p>LPool.doTransferOut</p>\n<p><a href=\"https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/liquidity/LPool.sol#L297\">https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/liquidity/LPool.sol#L297</a></p>\n<p>LPool.doTransferOut is used in LPool redeem and borrow, while OpenLevV1Lib.doTransferOut is used in OpenLevV1 trade manipulation logic:</p>\n<p>closeTrade</p>\n<p><a href=\"https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/OpenLevV1.sol#L204\">https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/OpenLevV1.sol#L204</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/OpenLevV1.sol#L215\">https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/OpenLevV1.sol#L215</a></p>\n<p>liquidate</p>\n<p><a href=\"https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/OpenLevV1.sol#L263\">https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/OpenLevV1.sol#L263</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/OpenLevV1.sol#L295\">https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/OpenLevV1.sol#L295</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/OpenLevV1.sol#L304\">https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/OpenLevV1.sol#L304</a></p>\n<h4 id=\"references\" style=\"position:relative;\"><a href=\"#references\" aria-label=\"references permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>References</h4>\n<p>The issues with <code>transfer()</code> are outlined here:</p>\n<p><a href=\"https://consensys.net/diligence/blog/2019/09/stop-using-soliditys-transfer-now/\">https://consensys.net/diligence/blog/2019/09/stop-using-soliditys-transfer-now/</a></p>\n<h4 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>OpenLevV1’s <code>closeTrade</code> and <code>liquidate</code> as well as LPool’s <code>redeem</code>, <code>redeemUnderlying</code>, <code>borrowBehalf</code>, <code>repayBorrowBehalf</code>, <code>repayBorrowEndByOpenLev</code> are all <code>nonReentrant</code>, so reentrancy isn’t an issue and <code>transfer()</code> can be just replaced.</p>\n<p>Using low-level <code>call.value(amount)</code> with the corresponding result check or using the OpenZeppelin <code>Address.sendValue</code> is advised:</p>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/Address.sol#L60\">https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/Address.sol#L60</a></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/75\">ColaM12 (OpenLeverage) confirmed and resolved</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/75#issuecomment-1045627508\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Awesome find! Completely agree with the warden here. This would prevent users from calling sensitive functions which withdraw their funds in some way. </p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-5\" style=\"position:relative;\"><a href=\"#medium-risk-findings-5\" aria-label=\"medium risk findings 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (5)</h1>\n<h2 id=\"m-01-univ2classdexsoluniclasssell-tokens-with-fee-on-transfer-are-not-fully-supported\" style=\"position:relative;\"><a href=\"#m-01-univ2classdexsoluniclasssell-tokens-with-fee-on-transfer-are-not-fully-supported\" aria-label=\"m 01 univ2classdexsoluniclasssell tokens with fee on transfer are not fully supported permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/208\">[M-01] <code>UniV2ClassDex.sol#uniClassSell()</code> Tokens with fee on transfer are not fully supported</a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-01-openleverage/blob/501e8f5c7ebaf1242572712626a77a3d65bdd3ad/openleverage-contracts/contracts/dex/bsc/UniV2ClassDex.sol#L31-L56\">https://github.com/code-423n4/2022-01-openleverage/blob/501e8f5c7ebaf1242572712626a77a3d65bdd3ad/openleverage-contracts/contracts/dex/bsc/UniV2ClassDex.sol#L31-L56</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">uniClassSell</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DexInfo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dexInfo</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">buyToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sellToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sellAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minBuyAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payer</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">buyAmount</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pair</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getUniClassPair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">buyToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">sellToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">dexInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">factory</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IUniswapV2Pair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">sync</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token0Reserves</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token1Reserves</span><span class=\"mtk1\">,) = </span><span class=\"mtk11\">IUniswapV2Pair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getReserves</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">sellAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">transferOut</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sellToken</span><span class=\"mtk1\">), </span><span class=\"mtk12\">payer</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">, </span><span class=\"mtk12\">sellAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceBefore</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">buyToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">payee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">dexInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fees</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getPairFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">dexInfo</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">buyToken</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">sellToken</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">buyAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getAmountOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sellAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token1Reserves</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token0Reserves</span><span class=\"mtk1\">, </span><span class=\"mtk12\">dexInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fees</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IUniswapV2Pair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">swap</span><span class=\"mtk1\">(</span><span class=\"mtk12\">buyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">payee</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">buyAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getAmountOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sellAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token0Reserves</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token1Reserves</span><span class=\"mtk1\">, </span><span class=\"mtk12\">dexInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fees</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IUniswapV2Pair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">swap</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">buyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">payee</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">buyAmount</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">minBuyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&#39;buy amount less than min&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bought</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">buyToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">payee</span><span class=\"mtk1\">).</span><span class=\"mtk11\">sub</span><span class=\"mtk1\">(</span><span class=\"mtk12\">balanceBefore</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bought</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>While <code>uniClassBuy()</code> correctly checks the actually received amount by comparing the before and after the balance of the receiver, <code>uniClassSell()</code> trusted the result given by <code>getAmountOut()</code>. This makes <code>uniClassSell()</code> can result in an output amount fewer than <code>minBuyAmount</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2022-01-openleverage/blob/501e8f5c7ebaf1242572712626a77a3d65bdd3ad/openleverage-contracts/contracts/dex/bsc/UniV2ClassDex.sol#L101-L102\">https://github.com/code-423n4/2022-01-openleverage/blob/501e8f5c7ebaf1242572712626a77a3d65bdd3ad/openleverage-contracts/contracts/dex/bsc/UniV2ClassDex.sol#L101-L102</a></p>\n<h4 id=\"recommendation\" style=\"position:relative;\"><a href=\"#recommendation\" aria-label=\"recommendation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h4>\n<p>Change to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">uniClassSell</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DexInfo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dexInfo</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">buyToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sellToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sellAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minBuyAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payer</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bought</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pair</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getUniClassPair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">buyToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">sellToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">dexInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">factory</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IUniswapV2Pair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">sync</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token0Reserves</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token1Reserves</span><span class=\"mtk1\">,) = </span><span class=\"mtk11\">IUniswapV2Pair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getReserves</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">sellAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">transferOut</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sellToken</span><span class=\"mtk1\">), </span><span class=\"mtk12\">payer</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">, </span><span class=\"mtk12\">sellAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceBefore</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">buyToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">payee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">dexInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fees</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getPairFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">dexInfo</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">buyToken</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">sellToken</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">buyAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getAmountOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sellAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token1Reserves</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token0Reserves</span><span class=\"mtk1\">, </span><span class=\"mtk12\">dexInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fees</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IUniswapV2Pair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">swap</span><span class=\"mtk1\">(</span><span class=\"mtk12\">buyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">payee</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">buyAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getAmountOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sellAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token0Reserves</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token1Reserves</span><span class=\"mtk1\">, </span><span class=\"mtk12\">dexInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fees</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IUniswapV2Pair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">swap</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">buyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">payee</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bought</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">buyToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">payee</span><span class=\"mtk1\">).</span><span class=\"mtk11\">sub</span><span class=\"mtk1\">(</span><span class=\"mtk12\">balanceBefore</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bought</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">minBuyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&#39;buy amount less than min&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/208\">ColaM12 (OpenLeverage) confirmed and resolved</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/208#issuecomment-1050844620\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with this finding! Uniswap token swaps are meant to support all types of tokens. It does seem possible for there to be <code>payer</code> to experience increased slippage because the check operates on <code>getAmountOut()</code> and not the <code>bought</code> output.</p>\n<p>It’s fair to say that this will lead to value leakage, so I think <code>medium</code> severity is justified.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-missing-payable\" style=\"position:relative;\"><a href=\"#m-02-missing-payable\" aria-label=\"m 02 missing payable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/61\">[M-02] Missing payable</a></h2>\n<p><em>Submitted by robee</em></p>\n<p>The following functions are not payable but uses msg.value - therefore the function must be payable.\nThis can lead to undesired behavior.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    LPool.sol, addReserves should be payable since using msg.value</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/61\">ColaM12 (OpenLeverage) confirmed and resolved</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/61#issuecomment-1045990204\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Nice find! The warden has identified a function which is missing the <code>payable</code> keyword. Preventing any users from adding reserves using native ether.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-eth-sent-to-timelock-will-be-locked-in-current-implementation\" style=\"position:relative;\"><a href=\"#m-03-eth-sent-to-timelock-will-be-locked-in-current-implementation\" aria-label=\"m 03 eth sent to timelock will be locked in current implementation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/80\">[M-03] Eth sent to Timelock will be locked in current implementation</a></h2>\n<p><em>Submitted by defsec</em></p>\n<p>Eth sent to Timelock will be locked in current implementation. I came across this problem while playing around with the governance contract.</p>\n<h4 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ul>\n<li>Setup the governance contracts (GovernanceAlpha, Timelock)</li>\n<li>Send eth to timelock contract</li>\n<li>Setup a proposal to send 0.1 eth out. Code snippet in ether.js below. proxy refers to GovernorAlpha.</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proxy</span><span class=\"mtk1\">.</span><span class=\"mtk11\">propose</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    [</span><span class=\"mtk12\">signers</span><span class=\"mtk1\">[</span><span class=\"mtk7\">3</span><span class=\"mtk1\">].</span><span class=\"mtk12\">address</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    [</span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">utils</span><span class=\"mtk1\">.</span><span class=\"mtk11\">parseEther</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;0.1&quot;</span><span class=\"mtk1\">)],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    [</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    [</span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">BigNumber</span><span class=\"mtk1\">.</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&quot;Send funds to 3rd signer&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<ul>\n<li>Vote and have the proposal succeed.</li>\n<li>Execute the proposal, the proposal number here is arbitrary.</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proxy</span><span class=\"mtk1\">.</span><span class=\"mtk11\">execute</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\">);  </span><span class=\"mtk3\">// this fails</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proxy</span><span class=\"mtk1\">.</span><span class=\"mtk11\">execute</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\">, {</span><span class=\"mtk12\">value:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">utils</span><span class=\"mtk1\">.</span><span class=\"mtk11\">parseEther</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;0.1&quot;</span><span class=\"mtk1\">)})  </span><span class=\"mtk3\">// this would work</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">0.1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">eth</span><span class=\"mtk1\"> </span><span class=\"mtk12\">will</span><span class=\"mtk1\"> </span><span class=\"mtk12\">be</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sent</span><span class=\"mtk1\"> </span><span class=\"mtk12\">out</span><span class=\"mtk1\">, </span><span class=\"mtk12\">but</span><span class=\"mtk1\"> </span><span class=\"mtk12\">it</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sent</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\"> </span><span class=\"mtk12\">the</span><span class=\"mtk1\"> </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> </span><span class=\"mtk12\">not</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\"> </span><span class=\"mtk12\">the</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timelock</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contract</span><span class=\"mtk1\">.</span></span></span></code></pre>\n<h4 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Consider implementing the following code.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">execute</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">state</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">) == </span><span class=\"mtk12\">ProposalState</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Queued</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;GovernorAlpha::execute: proposal can only be executed if it is queued&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Proposal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">proposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">executed</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">targets</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">timelock</span><span class=\"mtk1\">.</span><span class=\"mtk11\">executeTransaction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">targets</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">], </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">values</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">], </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">signatures</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">], </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">calldatas</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">], </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">eta</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ProposalExecuted</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h4 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h4>\n<p><a href=\"https://github.com/compound-finance/compound-protocol/pull/177/files\">https://github.com/compound-finance/compound-protocol/pull/177/files</a></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/80\">ColaM12 (OpenLeverage) acknowledged</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/80#issuecomment-1045994865\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I agree with this finding!</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-openlevv1closetrade-with-v3-dex-doesnt-correctly-accounts-fee-on-transfer-tokens-for-repayments\" style=\"position:relative;\"><a href=\"#m-04-openlevv1closetrade-with-v3-dex-doesnt-correctly-accounts-fee-on-transfer-tokens-for-repayments\" aria-label=\"m 04 openlevv1closetrade with v3 dex doesnt correctly accounts fee on transfer tokens for repayments permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/104\">[M-04] OpenLevV1.closeTrade with V3 DEX doesn’t correctly accounts fee on transfer tokens for repayments</a></h2>\n<p><em>Submitted by hyh</em></p>\n<p>The amount that OpenLevV1 will receive can be less than V3 DEX indicated as a swap result, while it is used as given for position debt repayment accounting.</p>\n<p>This way actual funds received can be less than accounted, leaving to system funds deficit, which can be exploited by a malicious user, draining contract funds with multiple open/close with a taxed token.</p>\n<p>In the <code>trade.depositToken != longToken</code> case when <code>flashSell</code> is used this can imply inability to send remainder funds to a user and the failure of the whole closeTrade function, the end result is a freezing of user’s funds within the system.</p>\n<h4 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><code>trade.depositToken != longToken</code> case, can be wrong repayment accounting, which will lead to a deficit if the received funds are less than DEX returned <code>closeTradeVars.receiveAmount</code>.</p>\n<p>As a side effect, <code>doTransferOut</code> is done without balance check, so the whole position close can revert, leading to inability to close the position and freeze of user’s funds this way:</p>\n<p><a href=\"https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/OpenLevV1.sol#L197-204\">https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/OpenLevV1.sol#L197-204</a></p>\n<p>I.e. if there is enough funds in the system they will be drained, if there is not enough funds, user’s position close will fail.</p>\n<p>V3 sell function doesn’t check for balance change, using DEX returned amount as is:</p>\n<p><a href=\"https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/dex/eth/UniV3Dex.sol#L61-70\">https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/dex/eth/UniV3Dex.sol#L61-70</a></p>\n<h4 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>If fee on tranfer tokens are fully in scope, do control all the accounting and amounts to be returned to a user via balance before/after calculations for DEX V3 logic as well.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/104\">ColaM12 (OpenLeverage) confirmed and resolved</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/104#issuecomment-1045996325\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Awesome find. I was able to confirm that <code>UniV3Dex.uniV3Sell()</code> does not properly handle fee-on-transfer tokens by treating the amount received as the difference between before balance and after balance.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-anti-flashloan-mechanism-may-lead-to-protocol-default\" style=\"position:relative;\"><a href=\"#m-05-anti-flashloan-mechanism-may-lead-to-protocol-default\" aria-label=\"m 05 anti flashloan mechanism may lead to protocol default permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/233\">[M-05] anti-flashloan mechanism may lead to protocol default</a></h2>\n<p><em>Submitted by gzeon</em></p>\n<p>There is a price check to avoid flash loan attacks which significantly moved the price. If current price is 5% lower than the stored twap price, the liquidation will fail. This design can be dangerous as it is to openleverage’s benefit to close under-collateralized position ASAP when there is a huge market drawdown. When the market keep trading downward, it is possible that the spot price keep trading 5% lower than the twap, which prevent any liquidation from happening and causing the protocol to be under-collateralized.</p>\n<h4 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://github.com/code-423n4/2022-01-openleverage/blob/501e8f5c7ebaf1242572712626a77a3d65bdd3ad/openleverage-contracts/contracts/OpenLevV1Lib.sol#L191\">https://github.com/code-423n4/2022-01-openleverage/blob/501e8f5c7ebaf1242572712626a77a3d65bdd3ad/openleverage-contracts/contracts/OpenLevV1Lib.sol#L191</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Avoid flash loan</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">prices</span><span class=\"mtk1\">.</span><span class=\"mtk12\">price</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">prices</span><span class=\"mtk1\">.</span><span class=\"mtk12\">cAvgPrice</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">differencePriceRatio</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">prices</span><span class=\"mtk1\">.</span><span class=\"mtk12\">cAvgPrice</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk7\">100</span><span class=\"mtk1\">).</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk12\">prices</span><span class=\"mtk1\">.</span><span class=\"mtk12\">price</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">differencePriceRatio</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">100</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">maxLiquidationPriceDiffientRatio</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&#39;MPT&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h4 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Instead of revert with <code>maxLiquidationPriceDiffientRatio</code>, use the twap price to determine if the position is healthy.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/233\">ColaM12 (OpenLeverage) disputed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/233#issuecomment-1045995096\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>From first impression, this finding seems legitimate. Can I get some more details on why it was disputed? @ColaM12 </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/233#issuecomment-1046409471\">ColaM12 (OpenLeverage) commented</a>:</strong></p>\n<blockquote>\n<p>There is always a chance to front run a flash loan transaction before trading in OpenLev. Also, see in line <a href=\"https://github.com/code-423n4/2022-01-openleverage/blob/501e8f5c7ebaf1242572712626a77a3d65bdd3ad/openleverage-contracts/contracts/OpenLevV1Lib.sol#L196\">196</a>, position is considered not healthy only if all three price check failed including the twap price.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/233#issuecomment-1046517723\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>It looks like only one condition would need to be satisfied for <code>isPositionHealthy</code> to return false as it uses <code>||</code> and not <code>&#x26;&#x26;</code>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/233#issuecomment-1046560642\">ColaM12 (OpenLeverage) commented</a>:</strong></p>\n<blockquote>\n<p>Do you mean return true? All 3 price checks should fail when liquidating. But the position may still hold funds to pay off debt. by using maxLiquidationPriceDiffientRatio, under-priced-swaps can be limited . Otherwise, all remaining funds in the position could be drained from a flash loan attack which directly leads to a bad debt to lender.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/233#issuecomment-1046580257\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Ahh sorry my mistake. I misinterpreted that.</p>\n<p>I agree with the sponsor here. The issue outlined by the warden seems to be safeguarded by the two other checks in <code>isPositionHealthy()</code></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/233#issuecomment-1046623163\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Actually thinking about this more, I think the warden raised an issue related to the liquidations continuing to fail if the price keeps trending downward at an accelerated pace. I don’t think the protocol would be able to respond to such events if <a href=\"https://github.com/code-423n4/2022-01-openleverage/blob/501e8f5c7ebaf1242572712626a77a3d65bdd3ad/openleverage-contracts/contracts/OpenLevV1Lib.sol#L194\">this</a> reverts.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/233#issuecomment-1046665362\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>After discussion with the sponsor, we have agreed that this issue is valid. It is expected that the TWAP is only valid for 1 min. By removing this condition, there is potential for even larger security issues. So the sponsor has decided to make this a wont-fix but I’ll keep the issue open as it is valid.</p>\n<p>This was an awesome find!</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-findings-15\" style=\"position:relative;\"><a href=\"#low-risk-findings-15\" aria-label=\"low risk findings 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Findings (15)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/220\">[L-01] Funds can be lost</a> <em>Submitted by csanuragjain</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/160\">[L-02] endTime can be before startTime</a> <em>Submitted by samruna, also found by defsec and WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/228\">[L-03] transfer() may break in future ETH upgrade</a> <em>Submitted by gzeon, also found by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/164\">[L-04] The check for <code>max rate 1000 ole</code> should be inclusive</a> <em>Submitted by Dravee</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/215\">[L-05] User reward can get stuck</a> <em>Submitted by csanuragjain</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/56\">[L-06] Anyone can call release() in OLETokenLock.sol</a> <em>Submitted by jayjonah8</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/87\">[L-07] Race condition in approve()</a> <em>Submitted by cccz, also found by defsec, mics, and sirhashalot</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/107\">[L-08] Anyone can claim airdrop amounts on behalf of anyone</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/43\">[L-09] Assert instead require to validate user inputs</a> <em>Submitted by mics, also found by defsec, Dravee, and hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/261\">[L-10] Anyone can crash transferTo</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/64\">[L-11] UniV2Dex and UniV2ClassDex use hard coded factory addresses for Pair and PairFees getters</a> <em>Submitted by hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/23\">[L-12] Mult instead div in compares</a> <em>Submitted by mics</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/44\">[L-13] In the following public update functions no value is returned</a> <em>Submitted by mics</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/88\">[L-14] UniV3Dex uniV3Buy slippage check error message is misleading</a> <em>Submitted by hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/195\">[L-15] Bad actor may steal deposit return when liquidating a trade</a> <em>Submitted by jonah1005</em></li>\n</ul>\n<h1 id=\"non-critical-findings-22\" style=\"position:relative;\"><a href=\"#non-critical-findings-22\" aria-label=\"non critical findings 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-Critical Findings (22)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/30\">[N-01] Require with empty message</a> <em>Submitted by mics</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/31\">[N-02] Require with not comprehensive message</a> <em>Submitted by mics</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/83\">[N-03] transferAllowed does not fail</a> <em>Submitted by GeekyLumberjack</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/67\">[N-04] The initialize function can be called multiple times</a> <em>Submitted by cccz, also found by 0x1f8b, Dravee, Fitraldys, hyh, p4st13r4, rfa, sirhashalot, and wuwe1</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/57\">[N-05] no validation checks in ControllerV1.sol initialize function()</a> <em>Submitted by jayjonah8, also found by 0v3rf10w, cccz, Dravee, and hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/146\">[N-06] <code>ControllerStorage</code>: related market data should be grouped in a struct</a> <em>Submitted by Dravee</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/53\">[N-07] No validation for constructor arguments in OLEToken.sol</a> <em>Submitted by jayjonah8</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/270\">[N-08] Multiple potential reentrancies</a> <em>Submitted by 0v3rf10w</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/60\">[N-09] Use of tx.origin in ControllerV1.sol</a> <em>Submitted by jayjonah8</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/46\">[N-10] Two arrays length mismatch</a> <em>Submitted by mics</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/65\">[N-11] No Transfer Ownership Pattern</a> <em>Submitted by cccz, also found by Dravee</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/55\">[N-12] mint() function doesn’t require 0 to be larger than 0</a> <em>Submitted by jayjonah8</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/76\">[N-13] FarmingPools’ notifyRewardAmounts and initDistributions do not check the lengths of input arrays</a> <em>Submitted by hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/79\">[N-14] Unused parameters in OpenLevV1 and ControllerV1 functions</a> <em>Submitted by hyh, also found by samruna</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/39\">[N-15] Named return issue</a> <em>Submitted by mics</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/198\">[N-16] Misc</a> <em>Submitted by 0x1f8b</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/218\">[N-17] Last reward is discarded when reward added twice</a> <em>Submitted by csanuragjain</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/49\">[N-18] Not verified input</a> <em>Submitted by mics</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/50\">[N-19] Does not validate the input fee parameter</a> <em>Submitted by mics</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/45\">[N-20] Never used parameters</a> <em>Submitted by mics</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/2\">[N-21] Unused imports</a> <em>Submitted by mics</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/247\">[N-22] Timelock.sol modification removes logic checks</a> <em>Submitted by sirhashalot</em></li>\n</ul>\n<h1 id=\"gas-optimizations-40\" style=\"position:relative;\"><a href=\"#gas-optimizations-40\" aria-label=\"gas optimizations 40 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations (40)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/132\">[G-01] Gas: Tautology on “variable >= 0” which is always true as variable is uint</a> <em>Submitted by Dravee, also found by 0v3rf10w, gzeon, and pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/250\">[G-02] Optimize <code>OpenLevV1.sol#addMarket</code></a> <em>Submitted by 0x0x0x</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/13\">[G-03] Prefix increments are cheaper than postfix increments</a> <em>Submitted by mics, also found by 0x1f8b, defsec, Dravee, IllIllI, m</em>smirnova2020, p4st13r4, and throttle_</li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/11\">[G-04] State variables that could be set immutable</a> <em>Submitted by mics, also found by 0x1f8b, gzeon, pauliax, Ruhum, and throttle</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/115\">[G-05] Gas saving optimizing setImplementation</a> <em>Submitted by 0x1f8b</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/116\">[G-06] Gas saving optimizing storage</a> <em>Submitted by 0x1f8b, also found by Dravee</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/140\">[G-07] Gas Optimization: Tight variable packing in <code>LPoolStorage.sol</code></a> <em>Submitted by Dravee</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/123\">[G-08] Gas: “constants” expressions are expressions, not constants. Use “immutable” instead.</a> <em>Submitted by Dravee, also found by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/3\">[G-09] Use bytes32 instead of string to save gas whenever possible</a> <em>Submitted by mics, also found by Dravee</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/15\">[G-10] Caching array length can save gas</a> <em>Submitted by mics, also found by defsec, Dravee, pauliax, throttle, and WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/6\">[G-11] Short the following require messages</a> <em>Submitted by robee, also found by Dravee, mics, and sirhashalot</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/18\">[G-12] Upgrade pragma to at least 0.8.4</a> <em>Submitted by mics, also found by defsec, Dravee, and gzeon</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/131\">[G-13] Gas: Shift Right instead of Dividing by 2</a> <em>Submitted by Dravee</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/21\">[G-14] Use != 0 instead of > 0</a> <em>Submitted by mics, also found by Dravee and gzeon</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/29\">[G-15] Use calldata instead of memory</a> <em>Submitted by mics, also found by defsec, Dravee, rfa, Ruhum, Tomio, and WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/137\">[G-16] Gas in <code>Adminable.sol:acceptAdmin()</code>: SLOADs minimization</a> <em>Submitted by Dravee, also found by Fitraldys, mics, p4st13r4, pauliax, Tomio, and WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/153\">[G-17] Gas: <code>// Shh - currently unused</code></a> <em>Submitted by Dravee, also found by sirhashalot</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/148\">[G-18] Gas in <code>LPool.sol:availableForBorrow()</code>: Avoid expensive calculation with an inclusive inequality</a> <em>Submitted by Dravee</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/26\">[G-19] Inline one time use functions</a> <em>Submitted by mics, also found by Dravee and robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/20\">[G-20] Unnecessary equals boolean</a> <em>Submitted by mics, also found by Dravee</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/63\">[G-21] Using <code>require</code> instead of <code>&#x26;&#x26;</code> can save gas</a> <em>Submitted by Tomio, also found by rfa</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/209\">[G-22] Unused library <code>ReentrancyGuard</code></a> <em>Submitted by WatchPug, also found by defsec</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/212\">[G-23] Gas savings and corrections</a> <em>Submitted by csanuragjain</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/225\">[G-24] Gas Optimization: No need to use SafeMath everywhere</a> <em>Submitted by gzeon</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/236\">[G-25] Gas Optimization: Redundant check</a> <em>Submitted by gzeon</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/102\">[G-26] OpenLevV1.closeTrade can save trade.deposited to memory</a> <em>Submitted by hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/86\">[G-27] uniV2Buy calls buyAmount.toAmountBeforeTax twice, while it’s constant</a> <em>Submitted by hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/12\">[G-28] Unnecessary array boundaries check when loading an array element twice</a> <em>Submitted by mics</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/19\">[G-29] Check if amount is not zero to save gas</a> <em>Submitted by mics</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/22\">[G-30] Unused inheritance</a> <em>Submitted by mics</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/100\">[G-31] using > instead of >=</a> <em>Submitted by rfa</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/117\">[G-32] unnecessary uint declaration</a> <em>Submitted by rfa</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/121\">[G-33] use require instead if/else</a> <em>Submitted by rfa</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/66\">[G-34] set pancakeFactory to constant</a> <em>Submitted by rfa</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/68\">[G-35] unnecessary _unsedFactory call</a> <em>Submitted by rfa</em></li>\n<li>[[G-36] pass the <code>dexInfo[dexName[i]</code> value without caching <code>DexInfo struct</code>](<a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/71\">https://github.com/code-423n4/2022-01-openleverage-findings/issues/71</a>) <em>Submitted by rfa</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/72\">[G-37] caching struct data type in memory cost more gas</a> <em>Submitted by rfa</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/73\">[G-38] declaring that contract is using <code>Utils</code> lib can use more gas</a> <em>Submitted by rfa</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/77\">[G-39] unnecessary msg.sender cache</a> <em>Submitted by rfa</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-openleverage-findings/issues/82\">[G-40] Gas saving by caching state variables</a> <em>Submitted by tqts</em></li>\n</ul>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-1\">High Risk Findings (1)</a></p>\n<ul>\n<li><a href=\"#h-01-openlevv1libs-and-lpools-dotransferout-functions-call-native-payabletransfer-which-can-be-unusable-for-smart-contract-calls\">[H-01] OpenLevV1Lib’s and LPool’s <code>doTransferOut</code> functions call native <code>payable.transfer</code>, which can be unusable for smart contract calls</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-5\">Medium Risk Findings (5)</a></p>\n<ul>\n<li><a href=\"#m-01-univ2classdexsoluniclasssell-tokens-with-fee-on-transfer-are-not-fully-supported\">[M-01] <code>UniV2ClassDex.sol#uniClassSell()</code> Tokens with fee on transfer are not fully supported</a></li>\n<li><a href=\"#m-02-missing-payable\">[M-02] Missing payable</a></li>\n<li><a href=\"#m-03-eth-sent-to-timelock-will-be-locked-in-current-implementation\">[M-03] Eth sent to Timelock will be locked in current implementation</a></li>\n<li><a href=\"#m-04-openlevv1closetrade-with-v3-dex-doesnt-correctly-accounts-fee-on-transfer-tokens-for-repayments\">[M-04] OpenLevV1.closeTrade with V3 DEX doesn’t correctly accounts fee on transfer tokens for repayments</a></li>\n<li><a href=\"#m-05-anti-flashloan-mechanism-may-lead-to-protocol-default\">[M-05] anti-flashloan mechanism may lead to protocol default</a></li>\n</ul>\n</li>\n<li><a href=\"#low-risk-findings-15\">Low Risk Findings (15)</a></li>\n<li><a href=\"#non-critical-findings-22\">Non-Critical Findings (22)</a></li>\n<li><a href=\"#gas-optimizations-40\">Gas Optimizations (40)</a></li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 code contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the code contest outlined in this document, C4 conducted an analysis of the OpenLeverage smart contract system written in Solidity. The code contest took place between January 27—February 2 2022.\n\n## Wardens\n\n31 Wardens contributed reports to the OpenLeverage contest:\n\n  1. hyh\n  1. [defsec](https://twitter.com/defsec_)\n  1. [gzeon](https://twitter.com/gzeon)\n  1. WatchPug ([jtp](https://github.com/jack-the-pug) and [ming](https://github.com/mingwatch))\n  1. robee\n  1. mics\n  1. [csanuragjain](https://twitter.com/csanuragjain)\n  1. [Dravee](https://twitter.com/JustDravee)\n  1. [pauliax](https://twitter.com/SolidityDev)\n  1. jayjonah8\n  1. [cmichel](https://twitter.com/cmichelio)\n  1. [jonah1005](https://twitter.com/jonah1005w)\n  1. [rfa](https://www.instagram.com/riyan_rfa/)\n  1. samruna\n  1. [sirhashalot](https://twitter.com/SirH4shalot)\n  1. cccz\n  1. 0x1f8b\n  1. 0x0x0x\n  1. [tqts](https://tqts.ar/)\n  1. [Tomio](https://twitter.com/meidhiwirara)\n  1. [throttle](https://twitter.com/_no_handlebars)\n  1. [0v3rf10w](https://twitter.com/_0v3rf10w)\n  1. [Ruhum](https://twitter.com/0xruhum)\n  1. p4st13r4 ([0x69e8](https://github.com/0x69e8) and 0xb4bb4)\n  1. [Fitraldys](https://twitter.com/fitraldys)\n  1. m_smirnova2020\n  1. IllIllI\n  1. GeekyLumberjack\n  1. [wuwe1](https://twitter.com/wuwe19)\n\nThis contest was judged by [0xleastwood](https://twitter.com/liam_eastwood13).\n\nFinal report assembled by [liveactionllama](https://twitter.com/liveactionllama) and [CloudEllie](https://twitter.com/CloudEllie1).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 21 unique vulnerabilities and 83 total findings. All of the issues presented here are linked back to their original finding.\n\nOf these vulnerabilities, 1 received a risk rating in the category of HIGH severity, 5 received a risk rating in the category of MEDIUM severity, and 15 received a risk rating in the category of LOW severity.\n\nC4 analysis also identified 22 non-critical recommendations and 40 gas optimizations.\n\n# Scope\n\nThe code under review can be found within the [C4 OpenLeverage contest repository](https://github.com/code-423n4/2022-01-openleverage), and is composed of 33 smart contracts written in the Solidity programming language and includes 4251 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code423n4.com).\n\n# High Risk Findings (1)\n## [[H-01] OpenLevV1Lib's and LPool's `doTransferOut` functions call native `payable.transfer`, which can be unusable for smart contract calls](https://github.com/code-423n4/2022-01-openleverage-findings/issues/75)\n_Submitted by hyh_\n\nWhen OpenLev operations use a wrapped native token, the whole user withdraw is being handled with a `payable.transfer()` call.\n\nThis is unsafe as `transfer` has hard coded gas budget and can fail when the user is a smart contract. This way any programmatical usage of OpenLevV1 and LPool is at risk.\n\nWhenever the user either fails to implement the payable fallback function or cumulative gas cost of the function sequence invoked on a native token transfer exceeds 2300 gas consumption limit the native tokens sent end up undelivered and the corresponding user funds return functionality will fail each time.\n\nAs OpenLevV1 `closeTrade` is affected this includes user's principal funds freeze scenario, so marking the issue as a high severity one.\n\n#### Proof of Concept\n\nOpenLevV1Lib and LPool have `doTransferOut` function that calls native token payable.transfer:\n\nOpenLevV1Lib.doTransferOut\n\n<https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/OpenLevV1Lib.sol#L253>\n\nLPool.doTransferOut\n\n<https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/liquidity/LPool.sol#L297>\n\nLPool.doTransferOut is used in LPool redeem and borrow, while OpenLevV1Lib.doTransferOut is used in OpenLevV1 trade manipulation logic:\n\ncloseTrade\n\n<https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/OpenLevV1.sol#L204>\n\n<https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/OpenLevV1.sol#L215>\n\nliquidate\n\n<https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/OpenLevV1.sol#L263>\n\n<https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/OpenLevV1.sol#L295>\n\n<https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/OpenLevV1.sol#L304>\n\n#### References\n\nThe issues with `transfer()` are outlined here:\n\n<https://consensys.net/diligence/blog/2019/09/stop-using-soliditys-transfer-now/>\n\n#### Recommended Mitigation Steps\n\nOpenLevV1's `closeTrade` and `liquidate` as well as LPool's `redeem`, `redeemUnderlying`, `borrowBehalf`, `repayBorrowBehalf`, `repayBorrowEndByOpenLev` are all `nonReentrant`, so reentrancy isn't an issue and `transfer()` can be just replaced.\n\nUsing low-level `call.value(amount)` with the corresponding result check or using the OpenZeppelin `Address.sendValue` is advised:\n\n<https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/Address.sol#L60>\n\n**[ColaM12 (OpenLeverage) confirmed and resolved](https://github.com/code-423n4/2022-01-openleverage-findings/issues/75)**\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-01-openleverage-findings/issues/75#issuecomment-1045627508):**\n > Awesome find! Completely agree with the warden here. This would prevent users from calling sensitive functions which withdraw their funds in some way. \n\n\n\n***\n\n \n# Medium Risk Findings (5)\n## [[M-01] `UniV2ClassDex.sol#uniClassSell()` Tokens with fee on transfer are not fully supported](https://github.com/code-423n4/2022-01-openleverage-findings/issues/208)\n_Submitted by WatchPug_\n\n<https://github.com/code-423n4/2022-01-openleverage/blob/501e8f5c7ebaf1242572712626a77a3d65bdd3ad/openleverage-contracts/contracts/dex/bsc/UniV2ClassDex.sol#L31-L56>\n\n```solidity\nfunction uniClassSell(DexInfo memory dexInfo,\n    address buyToken,\n    address sellToken,\n    uint sellAmount,\n    uint minBuyAmount,\n    address payer,\n    address payee\n) internal returns (uint buyAmount){\n    address pair = getUniClassPair(buyToken, sellToken, dexInfo.factory);\n    IUniswapV2Pair(pair).sync();\n    (uint256 token0Reserves, uint256 token1Reserves,) = IUniswapV2Pair(pair).getReserves();\n    sellAmount = transferOut(IERC20(sellToken), payer, pair, sellAmount);\n    uint balanceBefore = IERC20(buyToken).balanceOf(payee);\n    dexInfo.fees = getPairFees(dexInfo, pair);\n    if (buyToken < sellToken) {\n        buyAmount = getAmountOut(sellAmount, token1Reserves, token0Reserves, dexInfo.fees);\n        IUniswapV2Pair(pair).swap(buyAmount, 0, payee, \"\");\n    } else {\n        buyAmount = getAmountOut(sellAmount, token0Reserves, token1Reserves, dexInfo.fees);\n        IUniswapV2Pair(pair).swap(0, buyAmount, payee, \"\");\n    }\n\n    require(buyAmount >= minBuyAmount, 'buy amount less than min');\n    uint bought = IERC20(buyToken).balanceOf(payee).sub(balanceBefore);\n    return bought;\n}\n```\n\nWhile `uniClassBuy()` correctly checks the actually received amount by comparing the before and after the balance of the receiver, `uniClassSell()` trusted the result given by `getAmountOut()`. This makes `uniClassSell()` can result in an output amount fewer than `minBuyAmount`.\n\n<https://github.com/code-423n4/2022-01-openleverage/blob/501e8f5c7ebaf1242572712626a77a3d65bdd3ad/openleverage-contracts/contracts/dex/bsc/UniV2ClassDex.sol#L101-L102>\n\n#### Recommendation\n\nChange to:\n\n```solidity\nfunction uniClassSell(DexInfo memory dexInfo,\n    address buyToken,\n    address sellToken,\n    uint sellAmount,\n    uint minBuyAmount,\n    address payer,\n    address payee\n) internal returns (uint bought){\n    address pair = getUniClassPair(buyToken, sellToken, dexInfo.factory);\n    IUniswapV2Pair(pair).sync();\n    (uint256 token0Reserves, uint256 token1Reserves,) = IUniswapV2Pair(pair).getReserves();\n    sellAmount = transferOut(IERC20(sellToken), payer, pair, sellAmount);\n    uint balanceBefore = IERC20(buyToken).balanceOf(payee);\n    dexInfo.fees = getPairFees(dexInfo, pair);\n    if (buyToken < sellToken) {\n        buyAmount = getAmountOut(sellAmount, token1Reserves, token0Reserves, dexInfo.fees);\n        IUniswapV2Pair(pair).swap(buyAmount, 0, payee, \"\");\n    } else {\n        buyAmount = getAmountOut(sellAmount, token0Reserves, token1Reserves, dexInfo.fees);\n        IUniswapV2Pair(pair).swap(0, buyAmount, payee, \"\");\n    }\n    uint bought = IERC20(buyToken).balanceOf(payee).sub(balanceBefore);\n    require(bought >= minBuyAmount, 'buy amount less than min');\n}\n```\n\n**[ColaM12 (OpenLeverage) confirmed and resolved](https://github.com/code-423n4/2022-01-openleverage-findings/issues/208)**\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-01-openleverage-findings/issues/208#issuecomment-1050844620):**\n > Agree with this finding! Uniswap token swaps are meant to support all types of tokens. It does seem possible for there to be `payer` to experience increased slippage because the check operates on `getAmountOut()` and not the `bought` output.\n >\n > It's fair to say that this will lead to value leakage, so I think `medium` severity is justified.\n\n\n\n***\n\n## [[M-02] Missing payable](https://github.com/code-423n4/2022-01-openleverage-findings/issues/61)\n_Submitted by robee_\n\nThe following functions are not payable but uses msg.value - therefore the function must be payable.\nThis can lead to undesired behavior.\n\n        LPool.sol, addReserves should be payable since using msg.value\n\n**[ColaM12 (OpenLeverage) confirmed and resolved](https://github.com/code-423n4/2022-01-openleverage-findings/issues/61)**\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-01-openleverage-findings/issues/61#issuecomment-1045990204):**\n > Nice find! The warden has identified a function which is missing the `payable` keyword. Preventing any users from adding reserves using native ether.\n\n\n\n***\n\n## [[M-03] Eth sent to Timelock will be locked in current implementation](https://github.com/code-423n4/2022-01-openleverage-findings/issues/80)\n_Submitted by defsec_\n\nEth sent to Timelock will be locked in current implementation. I came across this problem while playing around with the governance contract.\n\n#### Proof of Concept\n\n*   Setup the governance contracts (GovernanceAlpha, Timelock)\n*   Send eth to timelock contract\n*   Setup a proposal to send 0.1 eth out. Code snippet in ether.js below. proxy refers to GovernorAlpha.\n\n```js\nawait proxy.propose(\n    [signers[3].address],\n    [ethers.utils.parseEther(\"0.1\")],\n    [\"\"],\n    [ethers.BigNumber.from(0)],\n    \"Send funds to 3rd signer\"\n);\n```\n*   Vote and have the proposal succeed.\n*   Execute the proposal, the proposal number here is arbitrary.\n\n```js\nawait proxy.execute(2);  // this fails\n    await proxy.execute(2, {value: ethers.utils.parseEther(\"0.1\")})  // this would work\n    0.1 eth will be sent out, but it is sent from the msg.sender not from the timelock contract.\n```\n\n#### Recommended Mitigation Steps\n\nConsider implementing the following code.\n```solidity\n\nfunction execute(uint proposalId) external {\n    require(state(proposalId) == ProposalState.Queued, \"GovernorAlpha::execute: proposal can only be executed if it is queued\");\n    Proposal storage proposal = proposals[proposalId];\n    proposal.executed = true;\n    for (uint i = 0; i < proposal.targets.length; i++) {\n        timelock.executeTransaction(proposal.targets[i], proposal.values[i], proposal.signatures[i], proposal.calldatas[i], proposal.eta);\n    }\n    emit ProposalExecuted(proposalId);\n}\n```\n\n#### Reference\n\n<https://github.com/compound-finance/compound-protocol/pull/177/files>\n\n**[ColaM12 (OpenLeverage) acknowledged](https://github.com/code-423n4/2022-01-openleverage-findings/issues/80)**\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-01-openleverage-findings/issues/80#issuecomment-1045994865):**\n > I agree with this finding!\n\n\n\n***\n\n## [[M-04] OpenLevV1.closeTrade with V3 DEX doesn't correctly accounts fee on transfer tokens for repayments](https://github.com/code-423n4/2022-01-openleverage-findings/issues/104)\n_Submitted by hyh_\n\nThe amount that OpenLevV1 will receive can be less than V3 DEX indicated as a swap result, while it is used as given for position debt repayment accounting.\n\nThis way actual funds received can be less than accounted, leaving to system funds deficit, which can be exploited by a malicious user, draining contract funds with multiple open/close with a taxed token.\n\nIn the `trade.depositToken != longToken` case when `flashSell` is used this can imply inability to send remainder funds to a user and the failure of the whole closeTrade function, the end result is a freezing of user's funds within the system.\n\n#### Proof of Concept\n\n`trade.depositToken != longToken` case, can be wrong repayment accounting, which will lead to a deficit if the received funds are less than DEX returned `closeTradeVars.receiveAmount`.\n\nAs a side effect, `doTransferOut` is done without balance check, so the whole position close can revert, leading to inability to close the position and freeze of user's funds this way:\n\n<https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/OpenLevV1.sol#L197-204>\n\nI.e. if there is enough funds in the system they will be drained, if there is not enough funds, user's position close will fail.\n\nV3 sell function doesn't check for balance change, using DEX returned amount as is:\n\n<https://github.com/code-423n4/2022-01-openleverage/blob/main/openleverage-contracts/contracts/dex/eth/UniV3Dex.sol#L61-70>\n\n#### Recommended Mitigation Steps\n\nIf fee on tranfer tokens are fully in scope, do control all the accounting and amounts to be returned to a user via balance before/after calculations for DEX V3 logic as well.\n\n**[ColaM12 (OpenLeverage) confirmed and resolved](https://github.com/code-423n4/2022-01-openleverage-findings/issues/104)**\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-01-openleverage-findings/issues/104#issuecomment-1045996325):**\n > Awesome find. I was able to confirm that `UniV3Dex.uniV3Sell()` does not properly handle fee-on-transfer tokens by treating the amount received as the difference between before balance and after balance.\n\n\n\n***\n\n## [[M-05] anti-flashloan mechanism may lead to protocol default](https://github.com/code-423n4/2022-01-openleverage-findings/issues/233)\n_Submitted by gzeon_\n\nThere is a price check to avoid flash loan attacks which significantly moved the price. If current price is 5% lower than the stored twap price, the liquidation will fail. This design can be dangerous as it is to openleverage's benefit to close under-collateralized position ASAP when there is a huge market drawdown. When the market keep trading downward, it is possible that the spot price keep trading 5% lower than the twap, which prevent any liquidation from happening and causing the protocol to be under-collateralized.\n\n#### Proof of Concept\n\n<https://github.com/code-423n4/2022-01-openleverage/blob/501e8f5c7ebaf1242572712626a77a3d65bdd3ad/openleverage-contracts/contracts/OpenLevV1Lib.sol#L191>\n\n```solidity\n// Avoid flash loan\nif (prices.price < prices.cAvgPrice) {\n    uint differencePriceRatio = prices.cAvgPrice.mul(100).div(prices.price);\n    require(differencePriceRatio - 100 < maxLiquidationPriceDiffientRatio, 'MPT');\n}\n``` \n\n#### Recommended Mitigation Steps\n\nInstead of revert with `maxLiquidationPriceDiffientRatio`, use the twap price to determine if the position is healthy.\n\n**[ColaM12 (OpenLeverage) disputed](https://github.com/code-423n4/2022-01-openleverage-findings/issues/233)**\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-01-openleverage-findings/issues/233#issuecomment-1045995096):**\n > From first impression, this finding seems legitimate. Can I get some more details on why it was disputed? @ColaM12 \n\n**[ColaM12 (OpenLeverage) commented](https://github.com/code-423n4/2022-01-openleverage-findings/issues/233#issuecomment-1046409471):**\n > There is always a chance to front run a flash loan transaction before trading in OpenLev. Also, see in line [196]( https://github.com/code-423n4/2022-01-openleverage/blob/501e8f5c7ebaf1242572712626a77a3d65bdd3ad/openleverage-contracts/contracts/OpenLevV1Lib.sol#L196), position is considered not healthy only if all three price check failed including the twap price.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-01-openleverage-findings/issues/233#issuecomment-1046517723):**\n > It looks like only one condition would need to be satisfied for `isPositionHealthy` to return false as it uses `||` and not `&&`.\n\n**[ColaM12 (OpenLeverage) commented](https://github.com/code-423n4/2022-01-openleverage-findings/issues/233#issuecomment-1046560642):**\n > Do you mean return true? All 3 price checks should fail when liquidating. But the position may still hold funds to pay off debt. by using maxLiquidationPriceDiffientRatio, under-priced-swaps can be limited . Otherwise, all remaining funds in the position could be drained from a flash loan attack which directly leads to a bad debt to lender.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-01-openleverage-findings/issues/233#issuecomment-1046580257):**\n > Ahh sorry my mistake. I misinterpreted that.\n >\n > I agree with the sponsor here. The issue outlined by the warden seems to be safeguarded by the two other checks in `isPositionHealthy()`\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-01-openleverage-findings/issues/233#issuecomment-1046623163):**\n > Actually thinking about this more, I think the warden raised an issue related to the liquidations continuing to fail if the price keeps trending downward at an accelerated pace. I don't think the protocol would be able to respond to such events if [this](https://github.com/code-423n4/2022-01-openleverage/blob/501e8f5c7ebaf1242572712626a77a3d65bdd3ad/openleverage-contracts/contracts/OpenLevV1Lib.sol#L194) reverts.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-01-openleverage-findings/issues/233#issuecomment-1046665362):**\n > After discussion with the sponsor, we have agreed that this issue is valid. It is expected that the TWAP is only valid for 1 min. By removing this condition, there is potential for even larger security issues. So the sponsor has decided to make this a wont-fix but I'll keep the issue open as it is valid.\n >\n > This was an awesome find!\n\n\n\n***\n\n# Low Risk Findings (15)\n- [[L-01] Funds can be lost](https://github.com/code-423n4/2022-01-openleverage-findings/issues/220) _Submitted by csanuragjain_\n- [[L-02] endTime can be before startTime](https://github.com/code-423n4/2022-01-openleverage-findings/issues/160) _Submitted by samruna, also found by defsec and WatchPug_\n- [[L-03] transfer() may break in future ETH upgrade](https://github.com/code-423n4/2022-01-openleverage-findings/issues/228) _Submitted by gzeon, also found by pauliax_\n- [[L-04] The check for `max rate 1000 ole` should be inclusive](https://github.com/code-423n4/2022-01-openleverage-findings/issues/164) _Submitted by Dravee_\n- [[L-05] User reward can get stuck](https://github.com/code-423n4/2022-01-openleverage-findings/issues/215) _Submitted by csanuragjain_\n- [[L-06] Anyone can call release() in OLETokenLock.sol](https://github.com/code-423n4/2022-01-openleverage-findings/issues/56) _Submitted by jayjonah8_\n- [[L-07] Race condition in approve()](https://github.com/code-423n4/2022-01-openleverage-findings/issues/87) _Submitted by cccz, also found by defsec, mics, and sirhashalot_\n- [[L-08] Anyone can claim airdrop amounts on behalf of anyone](https://github.com/code-423n4/2022-01-openleverage-findings/issues/107) _Submitted by cmichel_\n- [[L-09] Assert instead require to validate user inputs](https://github.com/code-423n4/2022-01-openleverage-findings/issues/43) _Submitted by mics, also found by defsec, Dravee, and hyh_\n- [[L-10] Anyone can crash transferTo](https://github.com/code-423n4/2022-01-openleverage-findings/issues/261) _Submitted by pauliax_\n- [[L-11] UniV2Dex and UniV2ClassDex use hard coded factory addresses for Pair and PairFees getters](https://github.com/code-423n4/2022-01-openleverage-findings/issues/64) _Submitted by hyh_\n- [[L-12] Mult instead div in compares](https://github.com/code-423n4/2022-01-openleverage-findings/issues/23) _Submitted by mics_\n- [[L-13] In the following public update functions no value is returned](https://github.com/code-423n4/2022-01-openleverage-findings/issues/44) _Submitted by mics_\n- [[L-14] UniV3Dex uniV3Buy slippage check error message is misleading](https://github.com/code-423n4/2022-01-openleverage-findings/issues/88) _Submitted by hyh_\n- [[L-15] Bad actor may steal deposit return when liquidating a trade](https://github.com/code-423n4/2022-01-openleverage-findings/issues/195) _Submitted by jonah1005_\n\n# Non-Critical Findings (22)\n- [[N-01] Require with empty message](https://github.com/code-423n4/2022-01-openleverage-findings/issues/30) _Submitted by mics_\n- [[N-02] Require with not comprehensive message](https://github.com/code-423n4/2022-01-openleverage-findings/issues/31) _Submitted by mics_\n- [[N-03] transferAllowed does not fail](https://github.com/code-423n4/2022-01-openleverage-findings/issues/83) _Submitted by GeekyLumberjack_\n- [[N-04] The initialize function can be called multiple times](https://github.com/code-423n4/2022-01-openleverage-findings/issues/67) _Submitted by cccz, also found by 0x1f8b, Dravee, Fitraldys, hyh, p4st13r4, rfa, sirhashalot, and wuwe1_\n- [[N-05] no validation checks in ControllerV1.sol initialize function()](https://github.com/code-423n4/2022-01-openleverage-findings/issues/57) _Submitted by jayjonah8, also found by 0v3rf10w, cccz, Dravee, and hyh_\n- [[N-06] `ControllerStorage`: related market data should be grouped in a struct](https://github.com/code-423n4/2022-01-openleverage-findings/issues/146) _Submitted by Dravee_\n- [[N-07] No validation for constructor arguments in OLEToken.sol](https://github.com/code-423n4/2022-01-openleverage-findings/issues/53) _Submitted by jayjonah8_\n- [[N-08] Multiple potential reentrancies](https://github.com/code-423n4/2022-01-openleverage-findings/issues/270) _Submitted by 0v3rf10w_\n- [[N-09] Use of tx.origin in ControllerV1.sol](https://github.com/code-423n4/2022-01-openleverage-findings/issues/60) _Submitted by jayjonah8_\n- [[N-10] Two arrays length mismatch](https://github.com/code-423n4/2022-01-openleverage-findings/issues/46) _Submitted by mics_\n- [[N-11] No Transfer Ownership Pattern](https://github.com/code-423n4/2022-01-openleverage-findings/issues/65) _Submitted by cccz, also found by Dravee_\n- [[N-12] mint() function doesn't require 0 to be larger than 0](https://github.com/code-423n4/2022-01-openleverage-findings/issues/55) _Submitted by jayjonah8_\n- [[N-13] FarmingPools' notifyRewardAmounts and initDistributions do not check the lengths of input arrays](https://github.com/code-423n4/2022-01-openleverage-findings/issues/76) _Submitted by hyh_\n- [[N-14] Unused parameters in OpenLevV1 and ControllerV1 functions](https://github.com/code-423n4/2022-01-openleverage-findings/issues/79) _Submitted by hyh, also found by samruna_\n- [[N-15] Named return issue](https://github.com/code-423n4/2022-01-openleverage-findings/issues/39) _Submitted by mics_\n- [[N-16] Misc](https://github.com/code-423n4/2022-01-openleverage-findings/issues/198) _Submitted by 0x1f8b_\n- [[N-17] Last reward is discarded when reward added twice](https://github.com/code-423n4/2022-01-openleverage-findings/issues/218) _Submitted by csanuragjain_\n- [[N-18] Not verified input](https://github.com/code-423n4/2022-01-openleverage-findings/issues/49) _Submitted by mics_\n- [[N-19] Does not validate the input fee parameter](https://github.com/code-423n4/2022-01-openleverage-findings/issues/50) _Submitted by mics_\n- [[N-20] Never used parameters](https://github.com/code-423n4/2022-01-openleverage-findings/issues/45) _Submitted by mics_\n- [[N-21] Unused imports](https://github.com/code-423n4/2022-01-openleverage-findings/issues/2) _Submitted by mics_\n- [[N-22] Timelock.sol modification removes logic checks](https://github.com/code-423n4/2022-01-openleverage-findings/issues/247) _Submitted by sirhashalot_\n\n# Gas Optimizations (40)\n- [[G-01] Gas: Tautology on \"variable >= 0\" which is always true as variable is uint](https://github.com/code-423n4/2022-01-openleverage-findings/issues/132) _Submitted by Dravee, also found by 0v3rf10w, gzeon, and pauliax_\n- [[G-02] Optimize `OpenLevV1.sol#addMarket`](https://github.com/code-423n4/2022-01-openleverage-findings/issues/250) _Submitted by 0x0x0x_\n- [[G-03] Prefix increments are cheaper than postfix increments](https://github.com/code-423n4/2022-01-openleverage-findings/issues/13) _Submitted by mics, also found by 0x1f8b, defsec, Dravee, IllIllI, m_smirnova2020, p4st13r4, and throttle_\n- [[G-04] State variables that could be set immutable](https://github.com/code-423n4/2022-01-openleverage-findings/issues/11) _Submitted by mics, also found by 0x1f8b, gzeon, pauliax, Ruhum, and throttle_\n- [[G-05] Gas saving optimizing setImplementation](https://github.com/code-423n4/2022-01-openleverage-findings/issues/115) _Submitted by 0x1f8b_\n- [[G-06] Gas saving optimizing storage](https://github.com/code-423n4/2022-01-openleverage-findings/issues/116) _Submitted by 0x1f8b, also found by Dravee_\n- [[G-07] Gas Optimization: Tight variable packing in `LPoolStorage.sol`](https://github.com/code-423n4/2022-01-openleverage-findings/issues/140) _Submitted by Dravee_\n- [[G-08] Gas: \"constants\" expressions are expressions, not constants. Use \"immutable\" instead.](https://github.com/code-423n4/2022-01-openleverage-findings/issues/123) _Submitted by Dravee, also found by pauliax_\n- [[G-09] Use bytes32 instead of string to save gas whenever possible](https://github.com/code-423n4/2022-01-openleverage-findings/issues/3) _Submitted by mics, also found by Dravee_\n- [[G-10] Caching array length can save gas](https://github.com/code-423n4/2022-01-openleverage-findings/issues/15) _Submitted by mics, also found by defsec, Dravee, pauliax, throttle, and WatchPug_\n- [[G-11] Short the following require messages](https://github.com/code-423n4/2022-01-openleverage-findings/issues/6) _Submitted by robee, also found by Dravee, mics, and sirhashalot_\n- [[G-12] Upgrade pragma to at least 0.8.4](https://github.com/code-423n4/2022-01-openleverage-findings/issues/18) _Submitted by mics, also found by defsec, Dravee, and gzeon_\n- [[G-13] Gas: Shift Right instead of Dividing by 2](https://github.com/code-423n4/2022-01-openleverage-findings/issues/131) _Submitted by Dravee_\n- [[G-14] Use != 0 instead of > 0](https://github.com/code-423n4/2022-01-openleverage-findings/issues/21) _Submitted by mics, also found by Dravee and gzeon_\n- [[G-15] Use calldata instead of memory](https://github.com/code-423n4/2022-01-openleverage-findings/issues/29) _Submitted by mics, also found by defsec, Dravee, rfa, Ruhum, Tomio, and WatchPug_\n- [[G-16] Gas in `Adminable.sol:acceptAdmin()`: SLOADs minimization](https://github.com/code-423n4/2022-01-openleverage-findings/issues/137) _Submitted by Dravee, also found by Fitraldys, mics, p4st13r4, pauliax, Tomio, and WatchPug_\n- [[G-17] Gas: `// Shh - currently unused`](https://github.com/code-423n4/2022-01-openleverage-findings/issues/153) _Submitted by Dravee, also found by sirhashalot_\n- [[G-18] Gas in `LPool.sol:availableForBorrow()`: Avoid expensive calculation with an inclusive inequality](https://github.com/code-423n4/2022-01-openleverage-findings/issues/148) _Submitted by Dravee_\n- [[G-19] Inline one time use functions](https://github.com/code-423n4/2022-01-openleverage-findings/issues/26) _Submitted by mics, also found by Dravee and robee_\n- [[G-20] Unnecessary equals boolean](https://github.com/code-423n4/2022-01-openleverage-findings/issues/20) _Submitted by mics, also found by Dravee_\n- [[G-21] Using `require` instead of `&&` can save gas](https://github.com/code-423n4/2022-01-openleverage-findings/issues/63) _Submitted by Tomio, also found by rfa_\n- [[G-22] Unused library `ReentrancyGuard`](https://github.com/code-423n4/2022-01-openleverage-findings/issues/209) _Submitted by WatchPug, also found by defsec_\n- [[G-23] Gas savings and corrections](https://github.com/code-423n4/2022-01-openleverage-findings/issues/212) _Submitted by csanuragjain_\n- [[G-24] Gas Optimization: No need to use SafeMath everywhere](https://github.com/code-423n4/2022-01-openleverage-findings/issues/225) _Submitted by gzeon_\n- [[G-25] Gas Optimization: Redundant check](https://github.com/code-423n4/2022-01-openleverage-findings/issues/236) _Submitted by gzeon_\n- [[G-26] OpenLevV1.closeTrade can save trade.deposited to memory](https://github.com/code-423n4/2022-01-openleverage-findings/issues/102) _Submitted by hyh_\n- [[G-27] uniV2Buy calls buyAmount.toAmountBeforeTax twice, while it's constant](https://github.com/code-423n4/2022-01-openleverage-findings/issues/86) _Submitted by hyh_\n- [[G-28] Unnecessary array boundaries check when loading an array element twice](https://github.com/code-423n4/2022-01-openleverage-findings/issues/12) _Submitted by mics_\n- [[G-29] Check if amount is not zero to save gas](https://github.com/code-423n4/2022-01-openleverage-findings/issues/19) _Submitted by mics_\n- [[G-30] Unused inheritance](https://github.com/code-423n4/2022-01-openleverage-findings/issues/22) _Submitted by mics_\n- [[G-31] using > instead of >=](https://github.com/code-423n4/2022-01-openleverage-findings/issues/100) _Submitted by rfa_\n- [[G-32] unnecessary uint declaration](https://github.com/code-423n4/2022-01-openleverage-findings/issues/117) _Submitted by rfa_\n- [[G-33] use require instead if/else](https://github.com/code-423n4/2022-01-openleverage-findings/issues/121) _Submitted by rfa_\n- [[G-34] set pancakeFactory to constant](https://github.com/code-423n4/2022-01-openleverage-findings/issues/66) _Submitted by rfa_\n- [[G-35] unnecessary _unsedFactory call](https://github.com/code-423n4/2022-01-openleverage-findings/issues/68) _Submitted by rfa_\n- [[G-36] pass the `dexInfo[dexName[i]` value without caching `DexInfo struct`](https://github.com/code-423n4/2022-01-openleverage-findings/issues/71) _Submitted by rfa_\n- [[G-37] caching struct data type in memory cost more gas](https://github.com/code-423n4/2022-01-openleverage-findings/issues/72) _Submitted by rfa_\n- [[G-38] declaring that contract is using `Utils` lib can use more gas](https://github.com/code-423n4/2022-01-openleverage-findings/issues/73) _Submitted by rfa_\n- [[G-39] unnecessary msg.sender cache](https://github.com/code-423n4/2022-01-openleverage-findings/issues/77) _Submitted by rfa_\n- [[G-40] Gas saving by caching state variables](https://github.com/code-423n4/2022-01-openleverage-findings/issues/82) _Submitted by tqts_\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}