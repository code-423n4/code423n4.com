{
  "circa": {
    "title": "Union Finance contest",
    "sponsor": "Union Finance",
    "slug": "2021-10-union",
    "date": "2021-12-08",
    "findings": "https://github.com/code-423n4/2021-10-union-findings/issues",
    "contest": 45
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 code contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the code contest outlined in this document, C4 conducted an analysis of the Union Finance smart contract system written in Solidity. The code contest took place between October 14—October 20 2021.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>14 Wardens contributed reports to the Union Finance contest:</p>\n<ol>\n<li><a href=\"https://twitter.com/cmichelio\">cmichel</a></li>\n<li>WatchPug (<a href=\"https://github.com/jack-the-pug\">jtp</a> and <a href=\"https://github.com/mingwatch\">ming</a>)</li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li><a href=\"https://twitter.com/itsmeSTYJ\">itsmeSTYJ</a></li>\n<li><a href=\"https://twitter.com/KenzoAgada\">kenzo</a></li>\n<li><a href=\"https://twitter.com/gpersoon\">gpersoon</a></li>\n<li>pants</li>\n<li><a href=\"https://twitter.com/merkleplant_eth\">pmerkleplant</a></li>\n<li><a href=\"https://twitter.com/SolidityDev\">pauliax</a></li>\n<li>hyh</li>\n<li><a href=\"https://twitter.com/defsec_\">defsec</a></li>\n<li><a href=\"https://twitter.com/_ye0lde\">ye0lde</a></li>\n<li><a href=\"https://twitter.com/loop_225\">loop</a></li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/gallodasballo\">AlexTheEntreprenerd</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/money_lego\">moneylegobatman</a> and <a href=\"https://twitter.com/CloudEllie1\">CloudEllie</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 25 unique vulnerabilities and 81 total findings. All of the issues presented here are linked back to their original finding.</p>\n<p>Of these vulnerabilities, 2 received a risk rating in the category of HIGH severity, 11 received a risk rating in the category of MEDIUM severity, and 12 received a risk rating in the category of LOW severity.</p>\n<p>C4 analysis also identified 13 non-critical recommendations and 43 gas optimizations.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2021-10-union\">C4 Union Finance contest repository</a>, and is composed of 98 smart contracts written in the Solidity programming language and includes 4,834 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code423n4.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-2\" style=\"position:relative;\"><a href=\"#high-risk-findings-2\" aria-label=\"high risk findings 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (2)</h1>\n<h2 id=\"h-01-borrow-must-accrueinterest-first\" style=\"position:relative;\"><a href=\"#h-01-borrow-must-accrueinterest-first\" aria-label=\"h 01 borrow must accrueinterest first permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/66\">[H-01] <code>borrow</code> must <code>accrueInterest</code> first</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>The <code>UToken.borrow</code> function first checks the borrowed balance and the old credit limit <em>before</em> accruing the actual interest on the market:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// @audit this uses the old value</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">borrowBalanceView</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">) + </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">maxBorrow</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;UToken: amount large than borrow size max&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// @audit this calls uToken.calculateInterest(account) which returns old value</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_getCreditLimit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">)) &gt;= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&quot;UToken: The loan amount plus fee is greater than credit limit&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// @audit accrual only happens here</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">accrueInterest</span><span class=\"mtk1\">(), </span><span class=\"mtk8\">&quot;UToken: accrue interest failed&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Thus the borrowed balance of the user does not include the latest interest as it uses the old global <code>borrowIndex</code> but the new <code>borrowIndex</code> is only set in <code>accrueInterest</code>.</p>\n<h4 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>In low-activity markets, it could be that the <code>borrowIndex</code> accruals (<code>accrueInterest</code> calls) happen infrequently and a long time is between them.\nA borrower could borrow tokens, and borrow more tokens later at a different time without first having their latest debt accrued.\nThis will lead to borrowers being able to borrow more than <code>maxBorrow</code> and <strong>more than their credit limit</strong> as these checks are performed before updating accruing interest.</p>\n<h4 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>The <code>require(accrueInterest(), \"UToken: accrue interest failed\");</code> call should happen at the beginning of the function.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/66\">GeraldHost (Union Finance) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/66#issuecomment-965931329\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with the finding, this fundamentally breaks the accounting of the protocol</p>\n<p>In protocols that calculate interest, and that have to recalculate state after something changed, it is vital that you accrue all changes up to this point before proceeding with any other state-changing logic</p>\n</blockquote>\n<h2 id=\"h-02-wrong-implementation-of-creditlimitbymediansolgetlockedamount-makes-it-unable-to-unlock-lockedamount-in-creditlimitbymedian-model\" style=\"position:relative;\"><a href=\"#h-02-wrong-implementation-of-creditlimitbymediansolgetlockedamount-makes-it-unable-to-unlock-lockedamount-in-creditlimitbymedian-model\" aria-label=\"h 02 wrong implementation of creditlimitbymediansolgetlockedamount makes it unable to unlock lockedamount in creditlimitbymedian model permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/80\">[H-02] Wrong implementation of <code>CreditLimitByMedian.sol#getLockedAmount()</code> makes it unable to unlock <code>lockedAmount</code> in <code>CreditLimitByMedian</code> model</a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p><a href=\"https://github.com/code-423n4/2021-10-union/blob/4176c366986e6d1a6b3f6ec0079ba547b040ac0f/contracts/user/CreditLimitByMedian.sol#L27-L78\"><code>CreditLimitByMedian.sol</code> L27-L78</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getLockedAmount</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">LockedInfo</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">array</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isIncrease</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">array</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newLockedAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">isIncrease</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">array</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">array</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">lockedAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">newLockedAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">array</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">lockedAmount</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">newLockedAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">account</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">array</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">staker</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newLockedAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><code>getLockedAmount()</code> is used by <code>UserManager.sol#updateLockedData()</code> to update locked amounts.</p>\n<p>Based on the context, at L66, <code>newLockedAmount = array[i].lockedAmount - 1;</code> should be <code>newLockedAmount = array[i].lockedAmount - amount;</code>.</p>\n<p>The current implementation is wrong and makes it impossible to unlock <code>lockedAmount</code> in <code>CreditLimitByMedian</code> model.</p>\n<h5 id=\"recommendation\" style=\"position:relative;\"><a href=\"#recommendation\" aria-label=\"recommendation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h5>\n<p>Change to:</p>\n<p><code>newLockedAmount = array[i].lockedAmount - amount;</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/80\">kingjacob (Union) acknowledged</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/80#issuecomment-966740802\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden identified a mistake in the accounting that would make it impossible to unlock funds, mitigation seems to be straightfoward</p>\n</blockquote>\n<h1 id=\"medium-risk-findings-11\" style=\"position:relative;\"><a href=\"#medium-risk-findings-11\" aria-label=\"medium risk findings 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (11)</h1>\n<h2 id=\"m-01-wrong-implementation-of-creditlimitbymediansolgetlockedamount-will-lock-a-much-bigger-total-amount-of-staked-tokens-than-expected\" style=\"position:relative;\"><a href=\"#m-01-wrong-implementation-of-creditlimitbymediansolgetlockedamount-will-lock-a-much-bigger-total-amount-of-staked-tokens-than-expected\" aria-label=\"m 01 wrong implementation of creditlimitbymediansolgetlockedamount will lock a much bigger total amount of staked tokens than expected permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/81\">[M-01] Wrong implementation of <code>CreditLimitByMedian.sol#getLockedAmount()</code> will lock a much bigger total amount of staked tokens than expected</a></h2>\n<p><em>Submitted by WatchPug, also found by itsmeSTYJ</em></p>\n<p><a href=\"https://github.com/code-423n4/2021-10-union/blob/4176c366986e6d1a6b3f6ec0079ba547b040ac0f/contracts/user/CreditLimitByMedian.sol#L27-L63\"><code>CreditLimitByMedian.sol</code> L27-L63</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getLockedAmount</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">LockedInfo</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">array</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isIncrease</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">array</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newLockedAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">isIncrease</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">array</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">remainingVouchingAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">array</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">vouchingAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">array</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">lockedAmount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">remainingVouchingAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">array</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">vouchingAmount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">array</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">lockedAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">remainingVouchingAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">remainingVouchingAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">array</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">availableStakingAmount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">array</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">availableStakingAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">newLockedAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">array</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">lockedAmount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">newLockedAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">array</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">lockedAmount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">array</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">availableStakingAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">remainingVouchingAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">newLockedAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">array</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">lockedAmount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">newLockedAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">array</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">lockedAmount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">remainingVouchingAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">account</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">array</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">staker</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newLockedAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span></code></pre>\n<p><code>getLockedAmount()</code> is used by <code>UserManager.sol#updateLockedData()</code> to update locked amounts.</p>\n<p>The current implementation is wrong and locks every staker for the amount of the borrowed amount or all the <code>vouchingAmount</code> if the <code>vouchingAmount</code> is smaller than the borrowed amount in <code>CreditLimitByMedian</code> model.</p>\n<h5 id=\"poc\" style=\"position:relative;\"><a href=\"#poc\" aria-label=\"poc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PoC</h5>\n<ul>\n<li>10 stakers each give <code>100</code> of <code>vouchingAmount</code> to Alice;</li>\n<li>Alice borrows <code>100</code>;</li>\n</ul>\n<p>The protocol will now lock <code>100</code> of each of the 10 stakers, making the total locked amount being <code>1000</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/81#issuecomment-953713681\">kingjacob (Union) disputed</a>:</strong></p>\n<blockquote>\n<p>This is as designed.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/81#issuecomment-966742505\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>With the evidence shown and the comment of the sponsor, it seems to me like this is a bad idea, the protocol will lock funds at a rate of N * X, where X was the original amount borrowed and N is the number of stakers that are covering for it.</p>\n<p>This seems to be a surefire way for griefing, DOS attacks, and potentially to block other people funds in the protocol</p>\n<p>I would highly recommend the sponsor to consider the possibility that this behaviour can be used against the users of the protocol and can potentially kill the protocol in it’s infancy</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/81#issuecomment-966985653\">kingjacob (Union) commented</a>:</strong></p>\n<blockquote>\n<p>While creditlimitbymedian seems inefficient from a capital locked per loans outstanding view, it is a valid if agressive model. We’ve run agent simulation on both it and sumoftrust and theres tradeoffs with both.</p>\n<p> For clarity of whats deployed, we’ll be deleting creditlimitbymedian from the repo but it is a valid implementation.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/81#issuecomment-967218554\">kingjacob (Union) commented</a>:</strong></p>\n<blockquote>\n<p>@GalloDaSballo this issue id argue is invalid as the implementation is correct and locks funds as instructed by creditlimitbymedian. Which is as designed.</p>\n<p>Locking > $M in underwriting per $M in borrowed funds is also not a “loss of funds” its common practice in credit markets, and might actually end up be required if default rates are high enough. And in the above model, the only one who can lock funds is the person the user chose to give the right to borrow (and lock the funds). Which I’d argue is distinct from an actual grief or DoS. (Unless you had something else in mind?)</p>\n<p>But all thats a bit offtopic, as this issue is reporting a wrong implementation, not an inefficient underwriting  model.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/81#issuecomment-968193970\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@kingjacob (Union) For the sake of understarding, let’s assume I convince 10 people to each put 1MLN so I can borrow 1 MLN.\nIf I then run away with the money and default, their 10 MLN would get locked.</p>\n<p>What would happen after?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/81#issuecomment-968202955\">kingjacob (Union) commented</a>:</strong></p>\n<blockquote>\n<p>@GalloDaSballo nothing. Stake stays locked earning interest which slowly fills the whole left by the default. Unless one of the stakers calls writeoffdebt.</p>\n<p>We dont solve the problem of what if someone trusts someone they shouldnt. Email me at jacob@union.finance, can hop on a call to explain in more detail.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/81#issuecomment-969115108\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Me and the sponsor have scheduled a clarification call, the conversation should help clarify our different opinions</p>\n<p>Before the call I’d like to record my current opinion:</p>\n<ul>\n<li>The system does what the sponsor designed (locks funds on default)</li>\n<li>To my understanding the system will lock N times the tokens necessary (again by design)</li>\n<li>By my experience in DeFi this means that potentially a lot of people can get locked</li>\n<li>There is a technicality with the findings that says “Wrong Implementation”, the implementation is as the sponsor specified, however, for a myriad of reasons, <code>wrong</code> is a synonym with “fallacious” / “errouneous”, hence my interpretation of the finding at this time is that it’s not a warning for the code not being to spec, but rather the code allowing for a risky situation (tons of people with funds locked)</li>\n</ul>\n<p>Ref: Google’s synonims for <code>wrong</code>\n<img width=\"700\" alt=\"Screenshot 2021-11-15 at 17 58 27\" src=\"https://user-images.githubusercontent.com/13383782/141822630-ca321ff5-52b6-4c3b-bd48-2a89f9c52ecc.png\"></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/81#issuecomment-969116616\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Given the specifics of this risk I am conflicted between a High (can lock arbitrary funds for an arbitrary amount of people) and Medium (they agreed to the dynamic, the time being locked is proportional to yield, higher yield = less time) severity finding, however believe it is correct for me to talk with the sponsor to hear their side of the story</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/81#issuecomment-970423305\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>After the conversation and the clarifications from the sponsor we both agree that the finding is of medium severity.\nAllowing someone to borrow is a situation closer to giving your allowance, more of a feature than a risk.\nHowever, locking a disproportional amount of people on default can be problematic and I think there should be a cap on that.</p>\n<p>The sponsor will mitigate by removing <code>CrediLimitByMedian</code> from the codebase</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/81#issuecomment-970436329\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>For the sake of transparency, we have recorded the call here\n<a href=\"https://us02web.zoom.us/rec/share/kx789PdETc3NqJ7J9gy1tNHazJAmYufFfwKD-ob_Ct6akpnC-sZPp84cLozLOlpm.khrAW4nfFCPxJZCx\">https://us02web.zoom.us/rec/share/kx789PdETc3NqJ7J9gy1tNHazJAmYufFfwKD-ob_Ct6akpnC-sZPp84cLozLOlpm.khrAW4nfFCPxJZCx</a> Passcode: 2A07bsS@</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/81#issuecomment-970437434\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I’ve re-rated the severity of the issue given the specifics of the risk, as per CodeArena docs:\n2 — Med: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.</p>\n</blockquote>\n<h2 id=\"m-02-rebalance-will-fail-due-to-low-precision-of-percentages\" style=\"position:relative;\"><a href=\"#m-02-rebalance-will-fail-due-to-low-precision-of-percentages\" aria-label=\"m 02 rebalance will fail due to low precision of percentages permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/64\">[M-02] Rebalance will fail due to low precision of percentages</a></h2>\n<p><em>Submitted by cmichel, also found by hyh</em></p>\n<p>The <code>AssetManager.rebalance</code> function has a check at the end to ensure that all tokens are deposited again:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;AssetManager: there are remaining funds in the fund pool&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The idea is that the last market deposits all <code>remainingTokens</code> but the last market does not have to support the token in which case the transaction will fail, or the <code>percentages</code> parameter needs to be chosen to distribute all tokens before the last one (they need to add up to <code>1e4</code>). However, these percentages have a low precision as they are in base points, i.e, the lowest unit is <code>1 = 0.01%</code>.\nThis will leave dust in the contract in most cases as the tokens have much higher precision.</p>\n<h4 id=\"poc-1\" style=\"position:relative;\"><a href=\"#poc-1\" aria-label=\"poc 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>POC</h4>\n<p>Assume the last market does not support the token and thus <code>percentages</code> are chosen as <code>[5000, 5000]</code> to rebalance the first two markets.\nWithdrawing all tokens form the markets leads to a <code>tokenSupply = token.balanceOf(address(this)) = 10,001</code>:</p>\n<p>Then the deposited amount is <code>amountToDeposit = (tokenSupply * percentages[i]) / 10000 = 10,001 * 5,000 / 10,000 = 5,000</code>.\nThe two deposits will leave dust of <code>10,001 - 2 * 5,000 = 1</code> in the contract and the <code>token.balanceOf(address(this)) == 0</code> balance check will revert.</p>\n<h4 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>Rebalancing will fail in most cases if the last market does not support the token due to precision errors.</p>\n<h4 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Remove the final zero balance check, or make sure that the last market that is actually deposited to receives all remaining tokens.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/64\">kingjacob (Union) confirmed</a></strong></p>\n<h2 id=\"m-03-uniontoken-should-check-whitelist-on-from\" style=\"position:relative;\"><a href=\"#m-03-uniontoken-should-check-whitelist-on-from\" aria-label=\"m 03 uniontoken should check whitelist on from permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/69\">[M-03] <code>UnionToken</code> should check whitelist on <code>from</code>?</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>The <code>UnionToken</code> can check for a whitelist on each transfer in <code>_beforeTokenTransfer</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">whitelistEnabled</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">isWhitelisted</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">) || </span><span class=\"mtk12\">to</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Whitelistable: address not whitelisted&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>This whitelist is checked on <code>msg.sender</code> not on <code>from</code>, the token owner.</p>\n<h4 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>A single whitelisted account can act as an operator (everyone calls <code>unionToken.allow(operator, max)</code> where the operator is a whitelisted trusted smart contract) for all other accounts. This essentially bypasses the whitelist.</p>\n<h4 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Think about if the whitelist on <code>msg.sender</code> is correct or if it should be on <code>from</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/69\">GeraldHost (Union Finance) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/69#issuecomment-966418580\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with the warden findings, since <code>_beforeTokenTransfer</code> is called on all transfers (transfer and transferFrom)[https://github.com/OpenZeppelin/openzeppelin-contracts/blob/e63b09c9ad3a45484b6dc304e0e99640a9dc3036/contracts/token/ERC20/ERC20.sol#L229]</p>\n<p>In order to enforce the whitelist you need to check against from and not msg.sender</p>\n<p>msg.sender could be a relayer or another contract, while <code>from</code> will be the account the tokens are being moved from</p>\n<p>Given the context and info I have this is a way to sidestep the guestList, hence a medium severity attack</p>\n</blockquote>\n<h2 id=\"m-04-change-in-interest-rate-can-disable-repay-of-loan\" style=\"position:relative;\"><a href=\"#m-04-change-in-interest-rate-can-disable-repay-of-loan\" aria-label=\"m 04 change in interest rate can disable repay of loan permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/21\">[M-04] Change in interest rate can disable repay of loan</a></h2>\n<p><em>Submitted by pmerkleplant</em></p>\n<h4 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>The ability of a borrower to repay a loan is disabled if the interest rate is\nset too high by the <code>InterestRateModel</code>.</p>\n<p>However, there is neither a check when setting the interest rate nor an\nindication in the <code>IInterestRateModel</code>’s specs of this behavior.</p>\n<p>But this issue could also be used in an adversarial fashion by the\n<code>FixedInterestRateModel</code>-owner if he/she would disable the repay functionality\nfor some time and enables it at a later point again with the demand of a\nhigher interest to be paid by the borrower.</p>\n<h4 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>If an account wants to repay a loan, the function\n<code>UToken::_repayBorrowFresh()</code> is used. This function calls\n<code>UToken::accrueInterest()</code> (<a href=\"https://github.com/code-423n4/2021-10-union/blob/main/contracts/market/UToken.sol#L465\">line</a> 465)\nwhich fetches the current borrow rate of the interest rate model\n(<a href=\"https://github.com/code-423n4/2021-10-union/blob/main/contracts/market/UToken.sol#L546\">line</a> 546\nand <a href=\"https://github.com/code-423n4/2021-10-union/blob/main/contracts/market/UToken.sol#L330\">line</a> 330).</p>\n<p>The function <code>UToken::borrowRatePerBlock()</code> requires an not “absurdly high”\nrate, or fails otherwise (<a href=\"https://github.com/code-423n4/2021-10-union/blob/main/contracts/market/UToken.sol#L331\">line</a> 331).</p>\n<p>However, there is no check or indicator in <code>FixedInterestRateModel.sol</code> to\nprevent the owner to set such a high rate that effectively disables repay\nof borrowed funds (<a href=\"https://github.com/code-423n4/2021-10-union/blob/main/contracts/market/FixedInterestRateModel.sol#L36\">line</a> 36).</p>\n<h4 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Disallow setting the interest rate too high with a check in\n<code>FixedInterestRateModel::setInterestRate()</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/21\">kingjacob (Union) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/21#issuecomment-966425305\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with the need for a check on the <code>setInterestRate</code> function\nSince the warden showed a specific way to negate certain protocol functionality, under specific assumptions, the finding is of medium severity</p>\n</blockquote>\n<h2 id=\"m-05-comptroller-rewards-can-be-artificially-inflated-and-drained-by-manipulating-totalstaked---totalfrozen-or-wrong-rewards-calculation\" style=\"position:relative;\"><a href=\"#m-05-comptroller-rewards-can-be-artificially-inflated-and-drained-by-manipulating-totalstaked---totalfrozen-or-wrong-rewards-calculation\" aria-label=\"m 05 comptroller rewards can be artificially inflated and drained by manipulating totalstaked   totalfrozen or wrong rewards calculation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/78\">[M-05] Comptroller rewards can be artificially inflated and drained by manipulating [totalStaked - totalFrozen] (or: wrong rewards calculation)</a></h2>\n<p><em>Submitted by kenzo</em></p>\n<p>By adding a small of amount of staking to a normal user scenario, and not approving this small amount as a loan for anybody, a staker can gain disproportionate amounts of comptroller rewards, even to the point of draining the contract.\nFor example:\nStakers A,B,C stake 100, 65, 20, approve it for borrower Z, then staker B stakes an additional 0.07 DAI, and borrower Z borrows 185. This will result in disproportionate amount of rewards.</p>\n<p>As far as I see, this is the main line that causes the inflated amount (<em>deep breath</em>):\nIn <code>calculateRewardsByBlocks</code>, you set:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">userManagerData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">totalStaked</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">userManagerContract</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalStaked</span><span class=\"mtk1\">() - </span><span class=\"mtk12\">userManagerData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">totalFrozen</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2021-10-union/blob/main/contracts/token/Comptroller.sol#L140\"><code>Comptroller.sol</code> L140</a></p>\n<p>Note that a staker can make this amount very small (depending of course on the current numbers of the protocol).\n(A more advanced attacker might diminish the effect of the current numbers of the protocol by initiating fake loans to himself and not paying them.)\nThis field is then passed to <code>calculateRewards</code>, and passed further to <code>getInflationIndexNew</code>, and further to <code>getInflationIndex</code>.\npassed to <code>calculateRewards</code> : <a href=\"https://github.com/code-423n4/2021-10-union/blob/main/contracts/token/Comptroller.sol#L167\"><code>Comptroller.sol</code> L167</a></p>\n<p>passed to <code>getInflationIndexNew</code> : <a href=\"https://github.com/code-423n4/2021-10-union/blob/main/contracts/token/Comptroller.sol#L259\"><code>Comptroller.sol</code> L259</a></p>\n<p>passed to <code>getInflationIndex</code> :  <a href=\"https://github.com/code-423n4/2021-10-union/blob/main/contracts/token/Comptroller.sol#L238\"><code>Comptroller.sol</code> L238</a></p>\n<p>Now we actually use it in the following line (as <code>effectiveAmount</code>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">blockDelta</span><span class=\"mtk1\"> * </span><span class=\"mtk11\">inflationPerBlock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">effectiveAmount</span><span class=\"mtk1\">).</span><span class=\"mtk11\">wadDiv</span><span class=\"mtk1\">(</span><span class=\"mtk12\">effectiveAmount</span><span class=\"mtk1\">) + </span><span class=\"mtk12\">inflationIndex</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2021-10-union/blob/main/contracts/token/Comptroller.sol#L315\"><code>Comptroller.sol</code> L315</a></p>\n<p>So 2 things are happening here:</p>\n<ol>\n<li>mul by <code>inflationPerBlock(effectiveAmount)</code> - uses the lookup table in Comptroller. This value gets bigger as effectiveAmount gets smaller, and if effectiveAmount is in the area of 10**18, we will get the maximum amount of the lookup.</li>\n<li>div by <code>effectiveAmount</code> - as we saw, this can be made small, thereby enlarging the result.</li>\n</ol>\n<p>All together, this calculation will be set to <code>curInflationIndex</code> and then used in the following line:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">return (curInflationIndex - startInflationIndex).wadMul(effectiveStakeAmount).wadMul(inflationIndex);</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2021-10-union/blob/main/contracts/token/Comptroller.sol#L263\"><code>Comptroller.sol</code> L263</a></p>\n<p>Note the <code>curInflationIndex - startInflationIndex</code>: per my POC (see below), this can result in a curInflationIndex which is orders of magnitude larger (200x) than startInflationIndex. This creates a huge inflation of rewards.</p>\n<h4 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>Comptroller rewards can be drained.</p>\n<h4 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>See the following script for a POC of reward drainage. It is based on the scenario in test/integration/<code>testUserManager</code>:</p>\n<p>Stakers A,B,C stake 100, 65, 20, and borrower Z borrows 185. But the difference in my script is that just before borrower Z borrows 185, staker B stakes an additional 0.07 DAI. (This will be the small amount that is <code>totalStaked - totalFrozen</code>).</p>\n<p>Then, we wait 11 blocks to make the loan overdue, call <code>updateOverdueInfo</code> so <code>totalFrozen</code> would be updated, and then staker B calls <code>withdrawRewards</code>.\nHe ends up with 873 unionTokens out of the 1000 the Comptroller has been seeded with. And this number can be enlarged by changing the small additional amount that staker B staked.</p>\n<p>In this scenario, when calling <code>withdrawRewards</code>, the calculated <code>curInflationIndex</code> will be 215 WAD, while <code>startInflationIndex</code> is 1 WAD, and this is the main issue as I understand it.</p>\n<p>File password: “union”.\n<a href=\"https://pastebin.com/3bJF8mTe\">https://pastebin.com/3bJF8mTe</a></p>\n<h4 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<p>Manual analysis, hardhat</p>\n<h4 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Are you sure that this line should deduct the <code>totalFrozen</code>?</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">userManagerData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">totalStaked</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">userManagerContract</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalStaked</span><span class=\"mtk1\">() - </span><span class=\"mtk12\">userManagerData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">totalFrozen</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2021-10-union/blob/main/contracts/token/Comptroller.sol#L140\"><code>Comptroller.sol</code> L140</a></p>\n<p>Per my tests, if we change it to just</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">userManagerData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">totalStaked</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">userManagerContract</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalStaked</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p>Then we are getting normal results again and no drainage. And the var <em>is</em> called just <code>totalStaked</code>…\nSo maybe this is the change that needs to be made? But maybe you have a reason to deduct the <code>totalFrozen</code>.\nIf so, then a mitigation will perhaps be to limit curInflationIndex somehow, maybe by changing the lookup table, or limiting it to a percentage from startInflationIndex ; but even then, there is also the issue of dividing by <code>userManagerData.totalStaked</code> which can be made quite small as the user has control over that.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/78\">kingjacob (Union) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/78#issuecomment-966593455\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with the finding, the warden has found a specific attack that can leak value, while the leak value marks it as Medium Severity, will think over if the economic exploit is big enough to warrant a high severity</p>\n</blockquote>\n<h2 id=\"m-06-debtwriteoff-updates-totalfrozen-immaturely-thereby-losing-staker-rewards\" style=\"position:relative;\"><a href=\"#m-06-debtwriteoff-updates-totalfrozen-immaturely-thereby-losing-staker-rewards\" aria-label=\"m 06 debtwriteoff updates totalfrozen immaturely thereby losing staker rewards permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/28\">[M-06] debtWriteOff updates <code>totalFrozen</code> immaturely, thereby losing staker rewards</a></h2>\n<p><em>Submitted by kenzo, also found by itsmeSTYJ</em></p>\n<p><code>debtWriteOff</code> updates <code>totalFrozen</code> before withdrawing <code>unionToken</code> rewards.\nAs the borrower is overdue, this means the staker calling debtWriteOff will lose his rewards if for example <code>totalStaked</code> == <code>totalFrozen</code>.\n(Note: If the borrower would to first call <code>withdrawRewards</code>/stake/unstake before calling debtWriteOff, he would get the rewards.)</p>\n<h4 id=\"impact-5\" style=\"position:relative;\"><a href=\"#impact-5\" aria-label=\"impact 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>Staker loses rewards.\n(Or at the very least, inconsistency at rewards calculation between debtWriteOff and stake/unstake/<code>withdrawRewards</code>.)</p>\n<h4 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><code>debtWriteOff</code> first calls <code>updateTotalFrozen</code>, and then <code>comptroller.withdrawRewards</code>: <a href=\"https://github.com/code-423n4/2021-10-union/blob/main/contracts/user/UserManager.sol#L710:#L712\"><code>L710:</code> L712</a></p>\n<p><code>updateTotalFrozen</code> can update <code>totalFrozen</code> to be same as <code>totalStaked</code>.\n<code>comptroller.withdrawRewards</code> calls <code>calculateRewardsByBlocks</code>: <a href=\"https://github.com/code-423n4/2021-10-union/blob/main/contracts/token/Comptroller.sol#L98\"><code>Comptroller.sol</code> L98</a></p>\n<p><code>calculateRewardsByBlocks</code> is calculating <code>userManagerContract.totalStaked() - userManagerData.totalFrozen</code>, which can be 0 in certain cases,\n<a href=\"https://github.com/code-423n4/2021-10-union/blob/main/contracts/token/Comptroller.sol#L140\"><code>Comptroller.sol</code> L140</a></p>\n<p>and passing it as the third parameter to <code>calculateRewards</code>: <a href=\"https://github.com/code-423n4/2021-10-union/blob/main/contracts/token/Comptroller.sol#L167\"><code>Comptroller.sol</code> L167</a></p>\n<p>In <code>calculateRewards</code>, if the third parameter is 0, the user won’t get any rewards.</p>\n<p><a href=\"https://github.com/code-423n4/2021-10-union/blob/main/contracts/token/Comptroller.sol#L253\"><code>Comptroller.sol</code> L253</a></p>\n<p>So in this scenario the user won’t get any rewards after calling <code>debtWriteOff</code>.</p>\n<p>If we were to call <code>updateTotalFrozen</code> <em>after</em> the withdrawing of the rewards, or if the staker would call <code>withdrawRewards</code> before calling <code>debtWriteOff</code>, the <code>totalFrozen</code> would not have been updated, and the user would get his rewards by calling <code>debtWriteOff</code>.\nAs I mentioned earlier, if there’s a reason I’m not seeing as to why <code>updateTotalFrozen</code> is updated in <code>debtWriteOff</code> before <code>withdrawRewards</code> is called, then it is not consistent with stake/unstake/<code>withdrawRewards</code> functions.</p>\n<p>I have a created an (admittedly hacky) script to show the bug.\nIt will run two scenarios which are almost the same (based on integration/<code>testUserManager</code>.js).\nIn the first the staker will call <code>debtWriteOff</code> at some point,\nand at the second the staker will call <code>withdrawRewards</code> at the same point,\nand the test will print the difference in unionToken balance after each call.\nFile password: “union”.\n<a href=\"https://pastebin.com/xkS0PXtq\">https://pastebin.com/xkS0PXtq</a></p>\n<h4 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<p>Manual analysis, hardhat.</p>\n<h4 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>If I am not missing anything, in <code>debtWriteOff</code> I would move the <code>withdrawRewards</code> to before <code>updateTotalFrozen</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2021-10-union/blob/main/contracts/user/UserManager.sol#L710:#L712\"><code>UserManager.sol</code> L710:L712</a></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/28\">kingjacob (Union) acknowledged</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/28#issuecomment-966598345\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>As described by the warden, the <code>debtWriteOff</code> function causes users to loose rewards, since this is a loss of yield will maintain a Med Risk severity</p>\n</blockquote>\n<h2 id=\"m-07-usermanager-totalstaked--totalfrozen-should-be-checked-before-and-after-totalfrozen-is-updated\" style=\"position:relative;\"><a href=\"#m-07-usermanager-totalstaked--totalfrozen-should-be-checked-before-and-after-totalfrozen-is-updated\" aria-label=\"m 07 usermanager totalstaked  totalfrozen should be checked before and after totalfrozen is updated permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/47\">[M-07] <code>UserManager</code>: <code>totalStaked</code> ≥ totalFrozen should be checked before and after totalFrozen is updated</a></h2>\n<p><em>Submitted by itsmeSTYJ</em></p>\n<p>The require statement in <code>updateTotalFrozen</code> and <code>batchUpdateTotalFrozen</code> to check that <code>totalStaked</code> ≥ <code>totalFrozen</code> should be done both before and after <code>_updateTotalFrozen</code> is called to ensure that totalStake is still ≥ <code>totalFrozen</code>. This will serve as a sanity check to ensure that the integrity of the system is not compromised.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/47\">kingjacob (Union) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/47#issuecomment-966599422\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with the finding and the recommendation of adding an additional require to ensure protocol invariants aren’t broken</p>\n</blockquote>\n<h2 id=\"m-08-max_trust_limit-might-be-too-high\" style=\"position:relative;\"><a href=\"#m-08-max_trust_limit-might-be-too-high\" aria-label=\"m 08 max_trust_limit might be too high permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/5\">[M-08] <code>MAX_TRUST_LIMIT</code> might be too high</a></h2>\n<p><em>Submitted by gpersoon</em></p>\n<p>Both <code>SumOfTrust.sol</code> and <code>CreditLimitByMedian.sol</code> contain an expensive sort function. This is used by <code>UserManager.sol</code> via the functions <code>getLockedAmount</code> and <code>getCreditLimit</code>.</p>\n<p>If the list of stakers would be very long then the sort would take up all the gas and revert.\nAttackers could make the list of stakers longer by voting in themselves (as soon as they have 3 accounts voted in), this would result in a griefing attack.</p>\n<p>Luckily the number of stakers and borrowers is limited in the function updateTrust by applying a limit of <code>MAX_TRUST_LIMIT</code>.</p>\n<p>However this limit is quite high (100), if that amount of stakers would be present then an out of gas error would probably occur with the sort.\nNote: there are also other for loops in the code that could have a similar problem, however sort is the most expensive.</p>\n<h4 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-10-union/blob/4176c366986e6d1a6b3f6ec0079ba547b040ac0f/contracts/user/SumOfTrust.sol#L98-L121\">https://github.com/code-423n4/2021-10-union/blob/4176c366986e6d1a6b3f6ec0079ba547b040ac0f/contracts/user/SumOfTrust.sol#L98-L121</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union/blob/4176c366986e6d1a6b3f6ec0079ba547b040ac0f/contracts/user/CreditLimitByMedian.sol#L107-L122\">https://github.com/code-423n4/2021-10-union/blob/4176c366986e6d1a6b3f6ec0079ba547b040ac0f/contracts/user/CreditLimitByMedian.sol#L107-L122</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union/blob/4176c366986e6d1a6b3f6ec0079ba547b040ac0f/contracts/user/UserManager.sol#L594\">https://github.com/code-423n4/2021-10-union/blob/4176c366986e6d1a6b3f6ec0079ba547b040ac0f/contracts/user/UserManager.sol#L594</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union/blob/4176c366986e6d1a6b3f6ec0079ba547b040ac0f/contracts/user/UserManager.sol#L368\">https://github.com/code-423n4/2021-10-union/blob/4176c366986e6d1a6b3f6ec0079ba547b040ac0f/contracts/user/UserManager.sol#L368</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union/blob/4176c366986e6d1a6b3f6ec0079ba547b040ac0f/contracts/user/UserManager.sol#L50\">https://github.com/code-423n4/2021-10-union/blob/4176c366986e6d1a6b3f6ec0079ba547b040ac0f/contracts/user/UserManager.sol#L50</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union/blob/4176c366986e6d1a6b3f6ec0079ba547b040ac0f/contracts/user/UserManager.sol#L423-L427\">https://github.com/code-423n4/2021-10-union/blob/4176c366986e6d1a6b3f6ec0079ba547b040ac0f/contracts/user/UserManager.sol#L423-L427</a></li>\n</ul>\n<h4 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Do a test with a <code>MAX_TRUST_LIMIT</code> number of stakers and borrowers and check if the code still works.</p>\n<p>Set the <code>MAX_TRUST_LIMIT</code> so that everything still works, probably include a margin for future changes in gas costs.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/5#issuecomment-949844802\">GeraldHost (Union Finance) acknowledged</a>:</strong></p>\n<blockquote>\n<p>yes we have tested for this and landed on the 100 limit. We have plans to improve gas efficiency considerably in future.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/5#issuecomment-966600028\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has indentify a griefing exploit that can be applied only under specific circumstances, I agree with the severity</p>\n</blockquote>\n<h2 id=\"m-09-duplicate-utoken-and-usermanager-can-be-added-which-cannot-be-deleted\" style=\"position:relative;\"><a href=\"#m-09-duplicate-utoken-and-usermanager-can-be-added-which-cannot-be-deleted\" aria-label=\"m 09 duplicate utoken and usermanager can be added which cannot be deleted permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/8\">[M-09] Duplicate <code>utoken</code> and <code>usermanager</code> can be added which cannot be deleted</a></h2>\n<p><em>Submitted by csanuragjain</em></p>\n<p>If Admin decides to delete the market, only the first instance of <code>utoken</code> and <code>usermanager</code> gets deleted. This means duplicate instance remains and Admin has actually not deleted the market</p>\n<h4 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ol>\n<li>Navigate to <a href=\"https://github.com/code-423n4/2021-10-union/blob/main/contracts/market/MarketRegistry.sol\">https://github.com/code-423n4/2021-10-union/blob/main/contracts/market/MarketRegistry.sol</a></li>\n<li>Check the <code>addUToken</code> function</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">addUToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uToken</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">newToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">) </span><span class=\"mtk11\">onlyAdmin</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uTokenList</span><span class=\"mtk1\">.</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uToken</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">].</span><span class=\"mtk12\">uToken</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">uToken</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LogAddUToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uToken</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<ol start=\"3\">\n<li>As we can see there is no check to see if the utoken already existed in uTokenList which means now uTokenList can have now duplicate entries</li>\n<li>Same case goes for userManagerList</li>\n</ol>\n<h4 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Modify <code>addUToken</code> and <code>addUserManager</code> function to check if the usermanager/utoken already existed</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/8#issuecomment-966606301\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with the finding, since the warden showed a specific attack with stated conditions, this a medium severity finding</p>\n</blockquote>\n<h2 id=\"m-10-user-fund-loss-in-case-of-unsupported-market-token-deposit\" style=\"position:relative;\"><a href=\"#m-10-user-fund-loss-in-case-of-unsupported-market-token-deposit\" aria-label=\"m 10 user fund loss in case of unsupported market token deposit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/9\">[M-10] User Fund loss in case of Unsupported Market token deposit</a></h2>\n<p><em>Submitted by csanuragjain</em></p>\n<h4 id=\"impact-6\" style=\"position:relative;\"><a href=\"#impact-6\" aria-label=\"impact 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>User funds can be lost as current logic cannot withdraw unsupported market token even though deposit can be done for same</p>\n<h4 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ol>\n<li>Navigate to <a href=\"https://github.com/code-423n4/2021-10-union/blob/main/contracts/asset/AssetManager.sol\">https://github.com/code-423n4/2021-10-union/blob/main/contracts/asset/AssetManager.sol</a></li>\n<li>Check the function deposit</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">whenNotPaused</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">onlyAuth</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">nonReentrant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">remaining</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">isMarketSupported</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">remaining</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">poolToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<ol start=\"3\">\n<li>If this function was called with unsupported market token then <code>isMarketSupported(token)</code> will result in false. Although remaining remains true. This means <code>poolToken.safeTransferFrom(msg.sender, address(this), amount);</code> will get executed and user money will be debited</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">remaining</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">poolToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<ol start=\"4\">\n<li>Lets say user decides to withdraw using withdraw function</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">whenNotPaused</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyAuth</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">) </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">isMarketSupported</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk11\">_isUToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">balances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">][</span><span class=\"mtk12\">token</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">balances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">][</span><span class=\"mtk12\">token</span><span class=\"mtk1\">] - </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">remaining</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">totalPrincipal</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">totalPrincipal</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">] - </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">remaining</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LogWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">remaining</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<ol start=\"5\">\n<li>As User is trying to withdraw unsupported market token so <code>isMarketSupported</code> function will return false. This means user wont be able to withdraw the funds</li>\n</ol>\n<h4 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p><code>Deposit</code> function should revert in case of non supported market tokens</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/9\">kingjacob (Union) acknowledged and disagreed with severity</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/9#issuecomment-966713507\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with the adjusted severity of Medium, this is a loss of funds that can happen under specific conditions</p>\n<p>That said, the finding is valid, a simple mitigation would be to return / stop the execution if the token is not supported (or revert if you prefer that)</p>\n</blockquote>\n<h2 id=\"m-11-rebalance-will-fail-if-a-market-has-high-utilization\" style=\"position:relative;\"><a href=\"#m-11-rebalance-will-fail-if-a-market-has-high-utilization\" aria-label=\"m 11 rebalance will fail if a market has high utilization permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/63\">[M-11] Rebalance will fail if a market has high utilization</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>The <code>AssetManager.rebalance</code> function iterates through the markets and withdraws <strong>all</strong> tokens in the <code>moneyMarkets[i].withdrawAll</code> call.</p>\n<p>Note that in peer-to-peer lending protocols like Compound/Aave the borrower takes the tokens from the supplier and it might not be possible for the supplier to withdraw all tokens if the utilisation ratio of the market is high.</p>\n<p>See this check for example in <a href=\"https://github.com/compound-finance/compound-protocol/blob/master/contracts/CToken.sol#L680\">Compound’s cToken</a>.</p>\n<h4 id=\"impact-7\" style=\"position:relative;\"><a href=\"#impact-7\" aria-label=\"impact 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>Rebalancing will fail if a single market has a liquidity crunch.</p>\n<h4 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Withdraw only what’s available and rebalance on that instead of trying to pull all tokens from each market first.\nAdmittedly, this might be hard to compute for some protocols.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/63\">kingjacob (Union) acknowledged</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/63#issuecomment-966611620\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with the finding, at this time this potential vulnerability is a feature of the protocol</p>\n<p>I recommend in the long term, that the sponsor rewrites the <code>rebalance</code> function to account for liquidity crunches</p>\n</blockquote>\n<h1 id=\"low-risk-findings-12\" style=\"position:relative;\"><a href=\"#low-risk-findings-12\" aria-label=\"low risk findings 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Findings (12)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/3\">[L-01] Zero-address checks are missing</a> <em>Submitted by defsec, also found by pants and pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/109\">[L-02] Lack of precision in <code>wadDiv</code> </a> <em>Submitted by pants</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/6\">[L-03] <code>setHalfDecayPoint</code> check allowed values</a> <em>Submitted by gpersoon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/68\">[L-04] <code>withdrawRewards</code> should send remaining balance</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/67\">[L-05] <code>repayBorrowWithPermit</code> is missing <code>nonReentrant</code></a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/65\">[L-06] Unbounded iteration in <code>deleteMarket</code></a> <em>Submitted by cmichel, also found by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/62\">[L-07] <code>withdrawSeq</code> might not be set</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/97\">[L-08] UToken._<em>UToken</em>init can be frontrun</a> <em>Submitted by pants</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/77\">[L-09] <code>UToken.sol</code> should inherits and complies with <code>IUToken.sol</code></a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/13\">[L-10] Improper Upper Bound Definition on the New Member Fee </a> <em>Submitted by defsec</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/2\">[L-11] Governor contract is not matching Contract source</a> <em>Submitted by csanuragjain</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/84\">[L-12] Two-step change of a critical parameter</a> <em>Submitted by pauliax, also found by pants</em></li>\n</ul>\n<h1 id=\"non-critical-findings-13\" style=\"position:relative;\"><a href=\"#non-critical-findings-13\" aria-label=\"non critical findings 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-Critical Findings (13)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/18\">[N-01] Unneeded Named Returns (UToken.sol)</a> <em>Submitted by ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/89\">[N-02] list of _admins</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/110\">[N-03] WadRayMath state variables</a> <em>Submitted by pants</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/46\">[N-04] UserManager: _getFrozenCoinAge is not used</a> <em>Submitted by itsmeSTYJ</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/45\">[N-05] AssetManager: getLoanableAmount() can be made more readable</a> <em>Submitted by itsmeSTYJ</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/61\">[N-06] Code Style: constants should be named in all caps</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/55\">[N-07] Unused imports</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/52\">[N-08] Code Style: consistency</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/83\">[N-09] deposit onlyAssetManager</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/94\">[N-10] Open TODOs in <code>Treasury.sol</code></a> <em>Submitted by pants</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/14\">[N-11] Missing events for owner only functions that change critical parameters</a> <em>Submitted by defsec</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/19\">[N-12] Inconsistent use of <code>UToken::getBorrowed()</code></a> <em>Submitted by pmerkleplant</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/20\">[N-13] Inconsistent use of <code>UToken::getLastRepay()</code></a> <em>Submitted by pmerkleplant</em></li>\n</ul>\n<h1 id=\"gas-optimizations-43\" style=\"position:relative;\"><a href=\"#gas-optimizations-43\" aria-label=\"gas optimizations 43 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations (43)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/27\">[G-01] For Loops Need Break Statements (UserManager.sol)</a> <em>Submitted by ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/26\">[G-02] Function getFrozenCoinAge Can Be Made More Efficient (UserManager.sol)</a> <em>Submitted by ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/23\">[G-03] Function checkIsOverDue Can Be Made More Efficient (UToken.sol)</a> <em>Submitted by ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/22\">[G-04] Functions TotalSupplyView/TotalSupply Can Be Made More Efficient (AssetManager.sol)</a> <em>Submitted by ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/17\">[G-05] Long Revert Strings</a> <em>Submitted by ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/93\">[G-06] Unchecked math operations</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/92\">[G-07] .length in a loop</a> <em>Submitted by pauliax, also found by pants</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/91\">[G-08] Zero transfers</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/90\">[G-09] Pre-calculate known values</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/88\">[G-10] Struct with only 1 element</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/87\">[G-11] Immutable variables</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/86\">[G-12] getSupply and getSupplyView are identical</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/98\">[G-13] UToken.uErc20 field could be immutable </a> <em>Submitted by pants</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/95\">[G-14] UToken.sol _redeemFresh could be set private instead internal</a> <em>Submitted by pants</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/106\">[G-15] caching multiple used variables</a> <em>Submitted by pants</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/103\">[G-16] double reading from memory inside a for loop.</a> <em>Submitted by pants</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/102\">[G-17] —j is more gas efficient than j—.</a> <em>Submitted by pants</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/100\">[G-18] More efficient loops</a> <em>Submitted by pants</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/24\">[G-19] stake function in <code>UserManager</code> checks for allowance, which is also done in ERC20 transferFrom</a> <em>Submitted by loop</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/16\">[G-20] Tautologies in require statements</a> <em>Submitted by loop</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/44\">[G-21] <code>UserManager</code>: debtWriteOff() doesn’t need if borrower has sufficient assets frozen before subtracting</a> <em>Submitted by itsmeSTYJ</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/41\">[G-22] <code>UserManager</code>: registerMember() can be optimized further</a> <em>Submitted by itsmeSTYJ</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/40\">[G-23] <code>UserManager</code>: cancelVouch() should break from loop when address is found.</a> <em>Submitted by itsmeSTYJ</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/39\">[G-24] <code>UserManager</code>: use mapping to avoid iteration</a> <em>Submitted by itsmeSTYJ</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/38\">[G-25] <code>UserManager</code>: addMember() contains redundant require check</a> <em>Submitted by itsmeSTYJ</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/37\">[G-26] <code>UserManager</code>: getCreditLimit() can be optimized further</a> <em>Submitted by itsmeSTYJ</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/36\">[G-27] <code>UserManager</code>: getTotalLockedStake() redundant assignment</a> <em>Submitted by itsmeSTYJ</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/34\">[G-28] CreditLimitByMedian: getLockedAmount() can be optimized further.</a> <em>Submitted by itsmeSTYJ</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/33\">[G-29] UToken: revert on over/underflow checks in addReserve() and removeReserve() are unnecessary</a> <em>Submitted by itsmeSTYJ</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/31\">[G-30] UToken: _repayBorrowFresh() function can be optimized further</a> <em>Submitted by itsmeSTYJ</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/29\">[G-31] AssetManager: Deposit() function has redundant continue statement.</a> <em>Submitted by itsmeSTYJ, also found by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/105\">[G-32] Gas efficiency suggestions</a> <em>Submitted by hyh, also found by csanuragjain</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/7\">[G-33] Overusage of gas due to non needed loop</a> <em>Submitted by csanuragjain, also found by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/75\">[G-34] Gas: Explicit overflow checks even though solidity 0.8 is used (2)</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/74\">[G-35] Gas: Explicit overflow checks even though solidity 0.8 is used (1)</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/72\">[G-36] Gas: <code>AssetManager.getMoneyMarket</code> use assignment</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/71\">[G-37] Gas: <code>AssetManager.rebalance</code> cache last market</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/60\">[G-38] Cache array length in for loops can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/57\">[G-39] Cache and read storage variables from the stack can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/58\">[G-40] Adding unchecked directive can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/56\">[G-41] Avoid unnecessary code execution can save some gas in edge cases</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/51\">[G-42] Use short circuiting can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-union-findings/issues/43\">[G-43] <code>UserManager</code>: _updateTotalFrozen can be optimized further</a> <em>Submitted by itsmeSTYJ</em></li>\n</ul>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-2\">High Risk Findings (2)</a></p>\n<ul>\n<li><a href=\"#h-01-borrow-must-accrueinterest-first\">[H-01] <code>borrow</code> must <code>accrueInterest</code> first</a></li>\n<li><a href=\"#h-02-wrong-implementation-of-creditlimitbymediansolgetlockedamount-makes-it-unable-to-unlock-lockedamount-in-creditlimitbymedian-model\">[H-02] Wrong implementation of <code>CreditLimitByMedian.sol#getLockedAmount()</code> makes it unable to unlock <code>lockedAmount</code> in <code>CreditLimitByMedian</code> model</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-11\">Medium Risk Findings (11)</a></p>\n<ul>\n<li><a href=\"#m-01-wrong-implementation-of-creditlimitbymediansolgetlockedamount-will-lock-a-much-bigger-total-amount-of-staked-tokens-than-expected\">[M-01] Wrong implementation of <code>CreditLimitByMedian.sol#getLockedAmount()</code> will lock a much bigger total amount of staked tokens than expected</a></li>\n<li><a href=\"#m-02-rebalance-will-fail-due-to-low-precision-of-percentages\">[M-02] Rebalance will fail due to low precision of percentages</a></li>\n<li><a href=\"#m-03-uniontoken-should-check-whitelist-on-from\">[M-03] <code>UnionToken</code> should check whitelist on <code>from</code>?</a></li>\n<li><a href=\"#m-04-change-in-interest-rate-can-disable-repay-of-loan\">[M-04] Change in interest rate can disable repay of loan</a></li>\n<li><a href=\"#m-05-comptroller-rewards-can-be-artificially-inflated-and-drained-by-manipulating-totalstaked---totalfrozen-or-wrong-rewards-calculation\">[M-05] Comptroller rewards can be artificially inflated and drained by manipulating [totalStaked - totalFrozen] (or: wrong rewards calculation)</a></li>\n<li><a href=\"#m-06-debtwriteoff-updates-totalfrozen-immaturely-thereby-losing-staker-rewards\">[M-06] debtWriteOff updates <code>totalFrozen</code> immaturely, thereby losing staker rewards</a></li>\n<li><a href=\"#m-07-usermanager-totalstaked--totalfrozen-should-be-checked-before-and-after-totalfrozen-is-updated\">[M-07] <code>UserManager</code>: <code>totalStaked</code> ≥ totalFrozen should be checked before and after totalFrozen is updated</a></li>\n<li><a href=\"#m-08-max_trust_limit-might-be-too-high\">[M-08] <code>MAX_TRUST_LIMIT</code> might be too high</a></li>\n<li><a href=\"#m-09-duplicate-utoken-and-usermanager-can-be-added-which-cannot-be-deleted\">[M-09] Duplicate <code>utoken</code> and <code>usermanager</code> can be added which cannot be deleted</a></li>\n<li><a href=\"#m-10-user-fund-loss-in-case-of-unsupported-market-token-deposit\">[M-10] User Fund loss in case of Unsupported Market token deposit</a></li>\n<li><a href=\"#m-11-rebalance-will-fail-if-a-market-has-high-utilization\">[M-11] Rebalance will fail if a market has high utilization</a></li>\n</ul>\n</li>\n<li><a href=\"#low-risk-findings-12\">Low Risk Findings (12)</a></li>\n<li><a href=\"#non-critical-findings-13\">Non-Critical Findings (13)</a></li>\n<li><a href=\"#gas-optimizations-43\">Gas Optimizations (43)</a></li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 code contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the code contest outlined in this document, C4 conducted an analysis of the Union Finance smart contract system written in Solidity. The code contest took place between October 14—October 20 2021.\n\n## Wardens\n\n14 Wardens contributed reports to the Union Finance contest:\n\n1. [cmichel](https://twitter.com/cmichelio)\n2. WatchPug ([jtp](https://github.com/jack-the-pug) and [ming](https://github.com/mingwatch))\n3. [csanuragjain](https://twitter.com/csanuragjain)\n4. [itsmeSTYJ](https://twitter.com/itsmeSTYJ)\n5. [kenzo](https://twitter.com/KenzoAgada)\n6. [gpersoon](https://twitter.com/gpersoon)\n7. pants\n8. [pmerkleplant](https://twitter.com/merkleplant_eth)\n9. [pauliax](https://twitter.com/SolidityDev)\n10. hyh\n11. [defsec](https://twitter.com/defsec_)\n12. [ye0lde](https://twitter.com/_ye0lde)\n13. [loop](https://twitter.com/loop_225)\n\nThis contest was judged by [AlexTheEntreprenerd](https://twitter.com/gallodasballo).\n\nFinal report assembled by [moneylegobatman](https://twitter.com/money_lego) and [CloudEllie](https://twitter.com/CloudEllie1).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 25 unique vulnerabilities and 81 total findings. All of the issues presented here are linked back to their original finding.\n\nOf these vulnerabilities, 2 received a risk rating in the category of HIGH severity, 11 received a risk rating in the category of MEDIUM severity, and 12 received a risk rating in the category of LOW severity.\n\nC4 analysis also identified 13 non-critical recommendations and 43 gas optimizations.\n\n# Scope\n\nThe code under review can be found within the [C4 Union Finance contest repository](https://github.com/code-423n4/2021-10-union), and is composed of 98 smart contracts written in the Solidity programming language and includes 4,834 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code423n4.com).\n\n# High Risk Findings (2)\n\n## [[H-01] `borrow` must `accrueInterest` first](https://github.com/code-423n4/2021-10-union-findings/issues/66)\n_Submitted by cmichel_\n\nThe `UToken.borrow` function first checks the borrowed balance and the old credit limit *before* accruing the actual interest on the market:\n\n```solidity\n// @audit this uses the old value\nrequire(borrowBalanceView(msg.sender) + amount + fee <= maxBorrow, \"UToken: amount large than borrow size max\");\n\nrequire(\n    // @audit this calls uToken.calculateInterest(account) which returns old value\n    uint256(_getCreditLimit(msg.sender)) >= amount + fee,\n    \"UToken: The loan amount plus fee is greater than credit limit\"\n);\n\n// @audit accrual only happens here\nrequire(accrueInterest(), \"UToken: accrue interest failed\");\n```\n\nThus the borrowed balance of the user does not include the latest interest as it uses the old global `borrowIndex` but the new `borrowIndex` is only set in `accrueInterest`.\n\n#### Impact\nIn low-activity markets, it could be that the `borrowIndex` accruals (`accrueInterest` calls) happen infrequently and a long time is between them.\nA borrower could borrow tokens, and borrow more tokens later at a different time without first having their latest debt accrued.\nThis will lead to borrowers being able to borrow more than `maxBorrow` and **more than their credit limit** as these checks are performed before updating accruing interest.\n\n#### Recommended Mitigation Steps\nThe `require(accrueInterest(), \"UToken: accrue interest failed\");` call should happen at the beginning of the function.\n\n**[GeraldHost (Union Finance) confirmed](https://github.com/code-423n4/2021-10-union-findings/issues/66)**\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2021-10-union-findings/issues/66#issuecomment-965931329):**\n > Agree with the finding, this fundamentally breaks the accounting of the protocol\n>\n> In protocols that calculate interest, and that have to recalculate state after something changed, it is vital that you accrue all changes up to this point before proceeding with any other state-changing logic\n\n\n## [[H-02] Wrong implementation of `CreditLimitByMedian.sol#getLockedAmount()` makes it unable to unlock `lockedAmount` in `CreditLimitByMedian` model](https://github.com/code-423n4/2021-10-union-findings/issues/80)\n_Submitted by WatchPug_\n\n[`CreditLimitByMedian.sol` L27-L78](https://github.com/code-423n4/2021-10-union/blob/4176c366986e6d1a6b3f6ec0079ba547b040ac0f/contracts/user/CreditLimitByMedian.sol#L27-L78)\n\n```solidity\nfunction getLockedAmount(\n    LockedInfo[] memory array,\n    address account,\n    uint256 amount,\n    bool isIncrease\n) public pure override returns (uint256) {\n    if (array.length == 0) return 0;\n\n    uint256 newLockedAmount;\n    if (isIncrease) {\n        ...\n    } else {\n        for (uint256 i = 0; i < array.length; i++) {\n            if (array[i].lockedAmount > amount) {\n                newLockedAmount = array[i].lockedAmount - 1;\n            } else {\n                newLockedAmount = 0;\n            }\n\n            if (account == array[i].staker) {\n                return newLockedAmount;\n            }\n        }\n    }\n\n    return 0;\n}\n```\n\n`getLockedAmount()` is used by `UserManager.sol#updateLockedData()` to update locked amounts.\n\nBased on the context, at L66, `newLockedAmount = array[i].lockedAmount - 1;` should be `newLockedAmount = array[i].lockedAmount - amount;`.\n\nThe current implementation is wrong and makes it impossible to unlock `lockedAmount` in `CreditLimitByMedian` model.\n\n##### Recommendation\nChange to:\n\n`newLockedAmount = array[i].lockedAmount - amount;`\n\n**[kingjacob (Union) acknowledged](https://github.com/code-423n4/2021-10-union-findings/issues/80)**\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2021-10-union-findings/issues/80#issuecomment-966740802):**\n > The warden identified a mistake in the accounting that would make it impossible to unlock funds, mitigation seems to be straightfoward\n\n\n# Medium Risk Findings (11)\n\n## [[M-01] Wrong implementation of `CreditLimitByMedian.sol#getLockedAmount()` will lock a much bigger total amount of staked tokens than expected](https://github.com/code-423n4/2021-10-union-findings/issues/81)\n_Submitted by WatchPug, also found by itsmeSTYJ_\n\n\n[`CreditLimitByMedian.sol` L27-L63](https://github.com/code-423n4/2021-10-union/blob/4176c366986e6d1a6b3f6ec0079ba547b040ac0f/contracts/user/CreditLimitByMedian.sol#L27-L63)\n\n```solidity\nfunction getLockedAmount(\n    LockedInfo[] memory array,\n    address account,\n    uint256 amount,\n    bool isIncrease\n) public pure override returns (uint256) {\n    if (array.length == 0) return 0;\n\n    uint256 newLockedAmount;\n    if (isIncrease) {\n        for (uint256 i = 0; i < array.length; i++) {\n            uint256 remainingVouchingAmount;\n            if (array[i].vouchingAmount > array[i].lockedAmount) {\n                remainingVouchingAmount = array[i].vouchingAmount - array[i].lockedAmount;\n            } else {\n                remainingVouchingAmount = 0;\n            }\n\n            if (remainingVouchingAmount > array[i].availableStakingAmount) {\n                if (array[i].availableStakingAmount > amount) {\n                    newLockedAmount = array[i].lockedAmount + amount;\n                } else {\n                    newLockedAmount = array[i].lockedAmount + array[i].availableStakingAmount;\n                }\n            } else {\n                if (remainingVouchingAmount > amount) {\n                    newLockedAmount = array[i].lockedAmount + amount;\n                } else {\n                    newLockedAmount = array[i].lockedAmount + remainingVouchingAmount;\n                }\n            }\n\n            if (account == array[i].staker) {\n                return newLockedAmount;\n            }\n        }\n    } else {\n    ...\n```\n\n`getLockedAmount()` is used by `UserManager.sol#updateLockedData()` to update locked amounts.\n\nThe current implementation is wrong and locks every staker for the amount of the borrowed amount or all the `vouchingAmount` if the `vouchingAmount` is smaller than the borrowed amount in `CreditLimitByMedian` model.\n\n##### PoC\n*   10 stakers each give `100` of `vouchingAmount` to Alice;\n*   Alice borrows `100`;\n\nThe protocol will now lock `100` of each of the 10 stakers, making the total locked amount being `1000`.\n\n\n**[kingjacob (Union) disputed](https://github.com/code-423n4/2021-10-union-findings/issues/81#issuecomment-953713681):**\n > This is as designed.\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2021-10-union-findings/issues/81#issuecomment-966742505):**\n > With the evidence shown and the comment of the sponsor, it seems to me like this is a bad idea, the protocol will lock funds at a rate of N * X, where X was the original amount borrowed and N is the number of stakers that are covering for it.\n>\n> This seems to be a surefire way for griefing, DOS attacks, and potentially to block other people funds in the protocol\n>\n> I would highly recommend the sponsor to consider the possibility that this behaviour can be used against the users of the protocol and can potentially kill the protocol in it's infancy\n\n**[kingjacob (Union) commented](https://github.com/code-423n4/2021-10-union-findings/issues/81#issuecomment-966985653):**\n > While creditlimitbymedian seems inefficient from a capital locked per loans outstanding view, it is a valid if agressive model. We’ve run agent simulation on both it and sumoftrust and theres tradeoffs with both.\n>\n>  For clarity of whats deployed, we’ll be deleting creditlimitbymedian from the repo but it is a valid implementation.\n\n**[kingjacob (Union) commented](https://github.com/code-423n4/2021-10-union-findings/issues/81#issuecomment-967218554):**\n > @GalloDaSballo this issue id argue is invalid as the implementation is correct and locks funds as instructed by creditlimitbymedian. Which is as designed.\n>\n> Locking > \\$M in underwriting per \\$M in borrowed funds is also not a “loss of funds” its common practice in credit markets, and might actually end up be required if default rates are high enough. And in the above model, the only one who can lock funds is the person the user chose to give the right to borrow (and lock the funds). Which I’d argue is distinct from an actual grief or DoS. (Unless you had something else in mind?)\n>\n> But all thats a bit offtopic, as this issue is reporting a wrong implementation, not an inefficient underwriting  model.\n>\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2021-10-union-findings/issues/81#issuecomment-968193970):**\n > @kingjacob (Union) For the sake of understarding, let's assume I convince 10 people to each put 1MLN so I can borrow 1 MLN.\n> If I then run away with the money and default, their 10 MLN would get locked.\n>\n> What would happen after?\n\n**[kingjacob (Union) commented](https://github.com/code-423n4/2021-10-union-findings/issues/81#issuecomment-968202955):**\n > @GalloDaSballo nothing. Stake stays locked earning interest which slowly fills the whole left by the default. Unless one of the stakers calls writeoffdebt.\n>\n> We dont solve the problem of what if someone trusts someone they shouldnt. Email me at jacob@union.finance, can hop on a call to explain in more detail.\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2021-10-union-findings/issues/81#issuecomment-969115108):**\n > Me and the sponsor have scheduled a clarification call, the conversation should help clarify our different opinions\n>\n> Before the call I'd like to record my current opinion:\n>\n> - The system does what the sponsor designed (locks funds on default)\n> - To my understanding the system will lock N times the tokens necessary (again by design)\n> - By my experience in DeFi this means that potentially a lot of people can get locked\n> - There is a technicality with the findings that says \"Wrong Implementation\", the implementation is as the sponsor specified, however, for a myriad of reasons, `wrong` is a synonym with \"fallacious\" / \"errouneous\", hence my interpretation of the finding at this time is that it's not a warning for the code not being to spec, but rather the code allowing for a risky situation (tons of people with funds locked)\n>\n> Ref: Google's synonims for `wrong`\n> <img width=\"700\" alt=\"Screenshot 2021-11-15 at 17 58 27\" src=\"https://user-images.githubusercontent.com/13383782/141822630-ca321ff5-52b6-4c3b-bd48-2a89f9c52ecc.png\">\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2021-10-union-findings/issues/81#issuecomment-969116616):**\n > Given the specifics of this risk I am conflicted between a High (can lock arbitrary funds for an arbitrary amount of people) and Medium (they agreed to the dynamic, the time being locked is proportional to yield, higher yield = less time) severity finding, however believe it is correct for me to talk with the sponsor to hear their side of the story\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2021-10-union-findings/issues/81#issuecomment-970423305):**\n > After the conversation and the clarifications from the sponsor we both agree that the finding is of medium severity.\n> Allowing someone to borrow is a situation closer to giving your allowance, more of a feature than a risk.\n> However, locking a disproportional amount of people on default can be problematic and I think there should be a cap on that.\n>\n> The sponsor will mitigate by removing `CrediLimitByMedian` from the codebase\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2021-10-union-findings/issues/81#issuecomment-970436329):**\n > For the sake of transparency, we have recorded the call here\n> https://us02web.zoom.us/rec/share/kx789PdETc3NqJ7J9gy1tNHazJAmYufFfwKD-ob_Ct6akpnC-sZPp84cLozLOlpm.khrAW4nfFCPxJZCx Passcode: 2A07bsS@\n>\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2021-10-union-findings/issues/81#issuecomment-970437434):**\n > I've re-rated the severity of the issue given the specifics of the risk, as per CodeArena docs:\n> 2 — Med: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.\n\n## [[M-02] Rebalance will fail due to low precision of percentages](https://github.com/code-423n4/2021-10-union-findings/issues/64)\n_Submitted by cmichel, also found by hyh_\n\nThe `AssetManager.rebalance` function has a check at the end to ensure that all tokens are deposited again:\n\n```solidity\nrequire(token.balanceOf(address(this)) == 0, \"AssetManager: there are remaining funds in the fund pool\");\n```\n\nThe idea is that the last market deposits all `remainingTokens` but the last market does not have to support the token in which case the transaction will fail, or the `percentages` parameter needs to be chosen to distribute all tokens before the last one (they need to add up to `1e4`). However, these percentages have a low precision as they are in base points, i.e, the lowest unit is `1 = 0.01%`.\nThis will leave dust in the contract in most cases as the tokens have much higher precision.\n\n#### POC\nAssume the last market does not support the token and thus `percentages` are chosen as `[5000, 5000]` to rebalance the first two markets.\nWithdrawing all tokens form the markets leads to a `tokenSupply = token.balanceOf(address(this)) = 10,001`:\n\nThen the deposited amount is `amountToDeposit = (tokenSupply * percentages[i]) / 10000 = 10,001 * 5,000 / 10,000 = 5,000`.\nThe two deposits will leave dust of `10,001 - 2 * 5,000 = 1` in the contract and the `token.balanceOf(address(this)) == 0` balance check will revert.\n\n#### Impact\nRebalancing will fail in most cases if the last market does not support the token due to precision errors.\n\n#### Recommended Mitigation Steps\nRemove the final zero balance check, or make sure that the last market that is actually deposited to receives all remaining tokens.\n\n**[kingjacob (Union) confirmed](https://github.com/code-423n4/2021-10-union-findings/issues/64)**\n\n## [[M-03] `UnionToken` should check whitelist on `from`?](https://github.com/code-423n4/2021-10-union-findings/issues/69)\n_Submitted by cmichel_\n\nThe `UnionToken` can check for a whitelist on each transfer in `_beforeTokenTransfer`:\n\n```solidity\nif (whitelistEnabled) {\n    require(isWhitelisted(msg.sender) || to == address(0), \"Whitelistable: address not whitelisted\");\n}\n```\n\nThis whitelist is checked on `msg.sender` not on `from`, the token owner.\n\n#### Impact\nA single whitelisted account can act as an operator (everyone calls `unionToken.allow(operator, max)` where the operator is a whitelisted trusted smart contract) for all other accounts. This essentially bypasses the whitelist.\n\n#### Recommended Mitigation Steps\nThink about if the whitelist on `msg.sender` is correct or if it should be on `from`.\n\n**[GeraldHost (Union Finance) confirmed](https://github.com/code-423n4/2021-10-union-findings/issues/69)**\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2021-10-union-findings/issues/69#issuecomment-966418580):**\n > Agree with the warden findings, since `_beforeTokenTransfer` is called on all transfers (transfer and transferFrom)[https://github.com/OpenZeppelin/openzeppelin-contracts/blob/e63b09c9ad3a45484b6dc304e0e99640a9dc3036/contracts/token/ERC20/ERC20.sol#L229]\n>\n> In order to enforce the whitelist you need to check against from and not msg.sender\n>\n> msg.sender could be a relayer or another contract, while `from` will be the account the tokens are being moved from\n>\n> Given the context and info I have this is a way to sidestep the guestList, hence a medium severity attack\n\n\n## [[M-04] Change in interest rate can disable repay of loan](https://github.com/code-423n4/2021-10-union-findings/issues/21)\n_Submitted by pmerkleplant_\n\n#### Impact\nThe ability of a borrower to repay a loan is disabled if the interest rate is\nset too high by the `InterestRateModel`.\n\nHowever, there is neither a check when setting the interest rate nor an\nindication in the `IInterestRateModel`'s specs of this behavior.\n\nBut this issue could also be used in an adversarial fashion by the\n`FixedInterestRateModel`-owner if he/she would disable the repay functionality\nfor some time and enables it at a later point again with the demand of a\nhigher interest to be paid by the borrower.\n\n#### Proof of Concept\nIf an account wants to repay a loan, the function\n`UToken::_repayBorrowFresh()` is used. This function calls\n`UToken::accrueInterest()` ([line](https://github.com/code-423n4/2021-10-union/blob/main/contracts/market/UToken.sol#L465) 465)\nwhich fetches the current borrow rate of the interest rate model\n([line](https://github.com/code-423n4/2021-10-union/blob/main/contracts/market/UToken.sol#L546) 546\nand [line](https://github.com/code-423n4/2021-10-union/blob/main/contracts/market/UToken.sol#L330) 330).\n\nThe function `UToken::borrowRatePerBlock()` requires an not \"absurdly high\"\nrate, or fails otherwise ([line](https://github.com/code-423n4/2021-10-union/blob/main/contracts/market/UToken.sol#L331) 331).\n\nHowever, there is no check or indicator in `FixedInterestRateModel.sol` to\nprevent the owner to set such a high rate that effectively disables repay\nof borrowed funds ([line](https://github.com/code-423n4/2021-10-union/blob/main/contracts/market/FixedInterestRateModel.sol#L36) 36).\n\n#### Recommended Mitigation Steps\nDisallow setting the interest rate too high with a check in\n`FixedInterestRateModel::setInterestRate()`.\n\n**[kingjacob (Union) confirmed](https://github.com/code-423n4/2021-10-union-findings/issues/21)**\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2021-10-union-findings/issues/21#issuecomment-966425305):**\n > Agree with the need for a check on the `setInterestRate` function\n> Since the warden showed a specific way to negate certain protocol functionality, under specific assumptions, the finding is of medium severity\n\n## [[M-05] Comptroller rewards can be artificially inflated and drained by manipulating [totalStaked - totalFrozen] (or: wrong rewards calculation)](https://github.com/code-423n4/2021-10-union-findings/issues/78)\n_Submitted by kenzo_\n\nBy adding a small of amount of staking to a normal user scenario, and not approving this small amount as a loan for anybody, a staker can gain disproportionate amounts of comptroller rewards, even to the point of draining the contract.\nFor example:\nStakers A,B,C stake 100, 65, 20, approve it for borrower Z, then staker B stakes an additional 0.07 DAI, and borrower Z borrows 185. This will result in disproportionate amount of rewards.\n\nAs far as I see, this is the main line that causes the inflated amount (*deep breath*):\nIn `calculateRewardsByBlocks`, you set:\n\n```solidity\nuserManagerData.totalStaked = userManagerContract.totalStaked() - userManagerData.totalFrozen;\n```\n\n[`Comptroller.sol` L140](https://github.com/code-423n4/2021-10-union/blob/main/contracts/token/Comptroller.sol#L140)\n\nNote that a staker can make this amount very small (depending of course on the current numbers of the protocol).\n(A more advanced attacker might diminish the effect of the current numbers of the protocol by initiating fake loans to himself and not paying them.)\nThis field is then passed to `calculateRewards`, and passed further to `getInflationIndexNew`, and further to `getInflationIndex`.\npassed to `calculateRewards` : [`Comptroller.sol` L167](https://github.com/code-423n4/2021-10-union/blob/main/contracts/token/Comptroller.sol#L167)\n\npassed to `getInflationIndexNew` : [`Comptroller.sol` L259](https://github.com/code-423n4/2021-10-union/blob/main/contracts/token/Comptroller.sol#L259)\n\npassed to `getInflationIndex` :  [`Comptroller.sol` L238](https://github.com/code-423n4/2021-10-union/blob/main/contracts/token/Comptroller.sol#L238)\n\nNow we actually use it in the following line (as `effectiveAmount`):\n```solidity\nreturn blockDelta * inflationPerBlock(effectiveAmount).wadDiv(effectiveAmount) + inflationIndex;\n```\n\n[`Comptroller.sol` L315](https://github.com/code-423n4/2021-10-union/blob/main/contracts/token/Comptroller.sol#L315)\n\nSo 2 things are happening here:\n\n1.  mul by `inflationPerBlock(effectiveAmount)` - uses the lookup table in Comptroller. This value gets bigger as effectiveAmount gets smaller, and if effectiveAmount is in the area of 10\\*\\*18, we will get the maximum amount of the lookup.\n2.  div by `effectiveAmount` - as we saw, this can be made small, thereby enlarging the result.\n\nAll together, this calculation will be set to `curInflationIndex` and then used in the following line:\n\n    return (curInflationIndex - startInflationIndex).wadMul(effectiveStakeAmount).wadMul(inflationIndex);\n\n[`Comptroller.sol` L263](https://github.com/code-423n4/2021-10-union/blob/main/contracts/token/Comptroller.sol#L263)\n\nNote the `curInflationIndex - startInflationIndex`: per my POC (see below), this can result in a curInflationIndex which is orders of magnitude larger (200x) than startInflationIndex. This creates a huge inflation of rewards.\n\n#### Impact\nComptroller rewards can be drained.\n\n#### Proof of Concept\nSee the following script for a POC of reward drainage. It is based on the scenario in test/integration/`testUserManager`:\n\nStakers A,B,C stake 100, 65, 20, and borrower Z borrows 185. But the difference in my script is that just before borrower Z borrows 185, staker B stakes an additional 0.07 DAI. (This will be the small amount that is `totalStaked - totalFrozen`).\n\nThen, we wait 11 blocks to make the loan overdue, call `updateOverdueInfo` so `totalFrozen` would be updated, and then staker B calls `withdrawRewards`.\nHe ends up with 873 unionTokens out of the 1000 the Comptroller has been seeded with. And this number can be enlarged by changing the small additional amount that staker B staked.\n\nIn this scenario, when calling `withdrawRewards`, the calculated `curInflationIndex` will be 215 WAD, while `startInflationIndex` is 1 WAD, and this is the main issue as I understand it.\n\nFile password: \"union\".\nhttps://pastebin.com/3bJF8mTe\n\n#### Tools Used\nManual analysis, hardhat\n\n#### Recommended Mitigation Steps\nAre you sure that this line should deduct the `totalFrozen`?\n```solidity\nuserManagerData.totalStaked = userManagerContract.totalStaked() - userManagerData.totalFrozen;\n```\n\n[`Comptroller.sol` L140](https://github.com/code-423n4/2021-10-union/blob/main/contracts/token/Comptroller.sol#L140)\n\nPer my tests, if we change it to just\n```solidity\nuserManagerData.totalStaked = userManagerContract.totalStaked();\n```\n\nThen we are getting normal results again and no drainage. And the var *is* called just `totalStaked`...\nSo maybe this is the change that needs to be made? But maybe you have a reason to deduct the `totalFrozen`.\nIf so, then a mitigation will perhaps be to limit curInflationIndex somehow, maybe by changing the lookup table, or limiting it to a percentage from startInflationIndex ; but even then, there is also the issue of dividing by `userManagerData.totalStaked` which can be made quite small as the user has control over that.\n\n**[kingjacob (Union) confirmed](https://github.com/code-423n4/2021-10-union-findings/issues/78)**\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2021-10-union-findings/issues/78#issuecomment-966593455):**\n > Agree with the finding, the warden has found a specific attack that can leak value, while the leak value marks it as Medium Severity, will think over if the economic exploit is big enough to warrant a high severity\n\n## [[M-06] debtWriteOff updates `totalFrozen` immaturely, thereby losing staker rewards](https://github.com/code-423n4/2021-10-union-findings/issues/28)\n_Submitted by kenzo, also found by itsmeSTYJ_\n\n`debtWriteOff` updates `totalFrozen` before withdrawing `unionToken` rewards.\nAs the borrower is overdue, this means the staker calling debtWriteOff will lose his rewards if for example `totalStaked` == `totalFrozen`.\n(Note: If the borrower would to first call `withdrawRewards`/stake/unstake before calling debtWriteOff, he would get the rewards.)\n\n#### Impact\nStaker loses rewards.\n(Or at the very least, inconsistency at rewards calculation between debtWriteOff and stake/unstake/`withdrawRewards`.)\n\n#### Proof of Concept\n`debtWriteOff` first calls `updateTotalFrozen`, and then `comptroller.withdrawRewards`: [`L710:` L712](https://github.com/code-423n4/2021-10-union/blob/main/contracts/user/UserManager.sol#L710:#L712)\n\n`updateTotalFrozen` can update `totalFrozen` to be same as `totalStaked`.\n`comptroller.withdrawRewards` calls `calculateRewardsByBlocks`: [`Comptroller.sol` L98](https://github.com/code-423n4/2021-10-union/blob/main/contracts/token/Comptroller.sol#L98)\n\n`calculateRewardsByBlocks` is calculating `userManagerContract.totalStaked() - userManagerData.totalFrozen`, which can be 0 in certain cases,\n[`Comptroller.sol` L140](https://github.com/code-423n4/2021-10-union/blob/main/contracts/token/Comptroller.sol#L140)\n\nand passing it as the third parameter to `calculateRewards`: [`Comptroller.sol` L167](https://github.com/code-423n4/2021-10-union/blob/main/contracts/token/Comptroller.sol#L167)\n\nIn `calculateRewards`, if the third parameter is 0, the user won't get any rewards.\n\n[`Comptroller.sol` L253](https://github.com/code-423n4/2021-10-union/blob/main/contracts/token/Comptroller.sol#L253)\n\nSo in this scenario the user won't get any rewards after calling `debtWriteOff`.\n\nIf we were to call `updateTotalFrozen` *after* the withdrawing of the rewards, or if the staker would call `withdrawRewards` before calling `debtWriteOff`, the `totalFrozen` would not have been updated, and the user would get his rewards by calling `debtWriteOff`.\nAs I mentioned earlier, if there's a reason I'm not seeing as to why `updateTotalFrozen` is updated in `debtWriteOff` before `withdrawRewards` is called, then it is not consistent with stake/unstake/`withdrawRewards` functions.\n\nI have a created an (admittedly hacky) script to show the bug.\nIt will run two scenarios which are almost the same (based on integration/`testUserManager`.js).\nIn the first the staker will call `debtWriteOff` at some point,\nand at the second the staker will call `withdrawRewards` at the same point,\nand the test will print the difference in unionToken balance after each call.\nFile password: \"union\".\n<https://pastebin.com/xkS0PXtq>\n\n#### Tools Used\nManual analysis, hardhat.\n\n#### Recommended Mitigation Steps\nIf I am not missing anything, in `debtWriteOff` I would move the `withdrawRewards` to before `updateTotalFrozen`.\n\n[`UserManager.sol` L710:L712](https://github.com/code-423n4/2021-10-union/blob/main/contracts/user/UserManager.sol#L710:#L712)\n\n**[kingjacob (Union) acknowledged](https://github.com/code-423n4/2021-10-union-findings/issues/28)**\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2021-10-union-findings/issues/28#issuecomment-966598345):**\n > As described by the warden, the `debtWriteOff` function causes users to loose rewards, since this is a loss of yield will maintain a Med Risk severity\n\n## [[M-07] `UserManager`: `totalStaked` ≥ totalFrozen should be checked before and after totalFrozen is updated](https://github.com/code-423n4/2021-10-union-findings/issues/47)\n_Submitted by itsmeSTYJ_\n\nThe require statement in `updateTotalFrozen` and `batchUpdateTotalFrozen` to check that `totalStaked` ≥ `totalFrozen` should be done both before and after `_updateTotalFrozen` is called to ensure that totalStake is still ≥ `totalFrozen`. This will serve as a sanity check to ensure that the integrity of the system is not compromised.\n\n**[kingjacob (Union) confirmed](https://github.com/code-423n4/2021-10-union-findings/issues/47)**\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2021-10-union-findings/issues/47#issuecomment-966599422):**\n > Agree with the finding and the recommendation of adding an additional require to ensure protocol invariants aren't broken\n\n\n## [[M-08] `MAX_TRUST_LIMIT` might be too high](https://github.com/code-423n4/2021-10-union-findings/issues/5)\n_Submitted by gpersoon_\n\nBoth `SumOfTrust.sol` and `CreditLimitByMedian.sol` contain an expensive sort function. This is used by `UserManager.sol` via the functions `getLockedAmount` and `getCreditLimit`.\n\nIf the list of stakers would be very long then the sort would take up all the gas and revert.\nAttackers could make the list of stakers longer by voting in themselves (as soon as they have 3 accounts voted in), this would result in a griefing attack.\n\nLuckily the number of stakers and borrowers is limited in the function updateTrust by applying a limit of `MAX_TRUST_LIMIT`.\n\nHowever this limit is quite high (100), if that amount of stakers would be present then an out of gas error would probably occur with the sort.\nNote: there are also other for loops in the code that could have a similar problem, however sort is the most expensive.\n\n#### Proof of Concept\n- <https://github.com/code-423n4/2021-10-union/blob/4176c366986e6d1a6b3f6ec0079ba547b040ac0f/contracts/user/SumOfTrust.sol#L98-L121>\n- <https://github.com/code-423n4/2021-10-union/blob/4176c366986e6d1a6b3f6ec0079ba547b040ac0f/contracts/user/CreditLimitByMedian.sol#L107-L122>\n- <https://github.com/code-423n4/2021-10-union/blob/4176c366986e6d1a6b3f6ec0079ba547b040ac0f/contracts/user/UserManager.sol#L594>\n- <https://github.com/code-423n4/2021-10-union/blob/4176c366986e6d1a6b3f6ec0079ba547b040ac0f/contracts/user/UserManager.sol#L368>\n- <https://github.com/code-423n4/2021-10-union/blob/4176c366986e6d1a6b3f6ec0079ba547b040ac0f/contracts/user/UserManager.sol#L50>\n- <https://github.com/code-423n4/2021-10-union/blob/4176c366986e6d1a6b3f6ec0079ba547b040ac0f/contracts/user/UserManager.sol#L423-L427>\n\n#### Recommended Mitigation Steps\nDo a test with a `MAX_TRUST_LIMIT` number of stakers and borrowers and check if the code still works.\n\nSet the `MAX_TRUST_LIMIT` so that everything still works, probably include a margin for future changes in gas costs.\n\n**[GeraldHost (Union Finance) acknowledged](https://github.com/code-423n4/2021-10-union-findings/issues/5#issuecomment-949844802):**\n > yes we have tested for this and landed on the 100 limit. We have plans to improve gas efficiency considerably in future.\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2021-10-union-findings/issues/5#issuecomment-966600028):**\n > The warden has indentify a griefing exploit that can be applied only under specific circumstances, I agree with the severity\n\n## [[M-09] Duplicate `utoken` and `usermanager` can be added which cannot be deleted](https://github.com/code-423n4/2021-10-union-findings/issues/8)\n_Submitted by csanuragjain_\n\nIf Admin decides to delete the market, only the first instance of `utoken` and `usermanager` gets deleted. This means duplicate instance remains and Admin has actually not deleted the market\n\n#### Proof of Concept\n1.  Navigate to <https://github.com/code-423n4/2021-10-union/blob/main/contracts/market/MarketRegistry.sol>\n2.  Check the `addUToken` function\n\n```solidity\nfunction addUToken(address token, address uToken) public newToken(token) onlyAdmin {\n    uTokenList.push(uToken);\n    tokens[token].uToken = uToken;\n    emit LogAddUToken(token, uToken);\n}\n```\n\n3.  As we can see there is no check to see if the utoken already existed in uTokenList which means now uTokenList can have now duplicate entries\n\n4.  Same case goes for userManagerList\n\n#### Recommended Mitigation Steps\nModify `addUToken` and `addUserManager` function to check if the usermanager/utoken already existed\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2021-10-union-findings/issues/8#issuecomment-966606301):**\n > Agree with the finding, since the warden showed a specific attack with stated conditions, this a medium severity finding\n\n## [[M-10] User Fund loss in case of Unsupported Market token deposit](https://github.com/code-423n4/2021-10-union-findings/issues/9)\n_Submitted by csanuragjain_\n\n#### Impact\nUser funds can be lost as current logic cannot withdraw unsupported market token even though deposit can be done for same\n\n#### Proof of Concept\n\n1.  Navigate to <https://github.com/code-423n4/2021-10-union/blob/main/contracts/asset/AssetManager.sol>\n\n2.  Check the function deposit\n\n```solidity\nfunction deposit(address token, uint256 amount)\n    external\n    override\n    whenNotPaused\n    onlyAuth(token)\n    nonReentrant\n    returns (bool)\n{\n    ...\n\n    bool remaining = true;\n    if (isMarketSupported(token)) {\n        ...\n    }\n\n    if (remaining) {\n        poolToken.safeTransferFrom(msg.sender, address(this), amount);\n    }\n\n    ...\n}\n```\n\n3.  If this function was called with unsupported market token then `isMarketSupported(token)` will result in false. Although remaining remains true. This means `poolToken.safeTransferFrom(msg.sender, address(this), amount);` will get executed and user money will be debited\n\n```solidity\nif (remaining) {\n    poolToken.safeTransferFrom(msg.sender, address(this), amount);\n}\n```\n4.  Lets say user decides to withdraw using withdraw function\n\n```solidity\nfunction withdraw(\n    address token,\n    address account,\n    uint256 amount\n) external override whenNotPaused nonReentrant onlyAuth(token) returns (bool) {\n    ...\n\n    if (isMarketSupported(token)) {\n        ...\n    }\n\n    if (!_isUToken(msg.sender, token)) {\n        balances[msg.sender][token] = balances[msg.sender][token] - amount + remaining;\n        totalPrincipal[token] = totalPrincipal[token] - amount + remaining;\n    }\n\n    emit LogWithdraw(token, account, amount, remaining);\n\n    return true;\n}\n```\n5.  As User is trying to withdraw unsupported market token so `isMarketSupported` function will return false. This means user wont be able to withdraw the funds\n\n#### Recommended Mitigation Steps\n`Deposit` function should revert in case of non supported market tokens\n\n**[kingjacob (Union) acknowledged and disagreed with severity](https://github.com/code-423n4/2021-10-union-findings/issues/9)**\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2021-10-union-findings/issues/9#issuecomment-966713507):**\n > Agree with the adjusted severity of Medium, this is a loss of funds that can happen under specific conditions\n>\n> That said, the finding is valid, a simple mitigation would be to return / stop the execution if the token is not supported (or revert if you prefer that)\n\n## [[M-11] Rebalance will fail if a market has high utilization](https://github.com/code-423n4/2021-10-union-findings/issues/63)\n_Submitted by cmichel_\n\nThe `AssetManager.rebalance` function iterates through the markets and withdraws **all** tokens in the `moneyMarkets[i].withdrawAll` call.\n\nNote that in peer-to-peer lending protocols like Compound/Aave the borrower takes the tokens from the supplier and it might not be possible for the supplier to withdraw all tokens if the utilisation ratio of the market is high.\n\nSee this check for example in [Compound's cToken](https://github.com/compound-finance/compound-protocol/blob/master/contracts/CToken.sol#L680).\n\n#### Impact\nRebalancing will fail if a single market has a liquidity crunch.\n\n#### Recommended Mitigation Steps\nWithdraw only what's available and rebalance on that instead of trying to pull all tokens from each market first.\nAdmittedly, this might be hard to compute for some protocols.\n\n**[kingjacob (Union) acknowledged](https://github.com/code-423n4/2021-10-union-findings/issues/63)**\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2021-10-union-findings/issues/63#issuecomment-966611620):**\n > Agree with the finding, at this time this potential vulnerability is a feature of the protocol\n>\n> I recommend in the long term, that the sponsor rewrites the `rebalance` function to account for liquidity crunches\n\n\n# Low Risk Findings (12)\n\n- [[L-01] Zero-address checks are missing](https://github.com/code-423n4/2021-10-union-findings/issues/3) _Submitted by defsec, also found by pants and pauliax_\n- [[L-02] Lack of precision in `wadDiv` ](https://github.com/code-423n4/2021-10-union-findings/issues/109) _Submitted by pants_\n- [[L-03] `setHalfDecayPoint` check allowed values](https://github.com/code-423n4/2021-10-union-findings/issues/6) _Submitted by gpersoon_\n- [[L-04] `withdrawRewards` should send remaining balance](https://github.com/code-423n4/2021-10-union-findings/issues/68) _Submitted by cmichel_\n- [[L-05] `repayBorrowWithPermit` is missing `nonReentrant`](https://github.com/code-423n4/2021-10-union-findings/issues/67) _Submitted by cmichel_\n- [[L-06] Unbounded iteration in `deleteMarket`](https://github.com/code-423n4/2021-10-union-findings/issues/65) _Submitted by cmichel, also found by pauliax_\n- [[L-07] `withdrawSeq` might not be set](https://github.com/code-423n4/2021-10-union-findings/issues/62) _Submitted by cmichel_\n- [[L-08] UToken.__UToken_init can be frontrun](https://github.com/code-423n4/2021-10-union-findings/issues/97) _Submitted by pants_\n- [[L-09] `UToken.sol` should inherits and complies with `IUToken.sol`](https://github.com/code-423n4/2021-10-union-findings/issues/77) _Submitted by WatchPug_\n- [[L-10] Improper Upper Bound Definition on the New Member Fee ](https://github.com/code-423n4/2021-10-union-findings/issues/13) _Submitted by defsec_\n- [[L-11] Governor contract is not matching Contract source](https://github.com/code-423n4/2021-10-union-findings/issues/2) _Submitted by csanuragjain_\n- [[L-12] Two-step change of a critical parameter](https://github.com/code-423n4/2021-10-union-findings/issues/84) _Submitted by pauliax, also found by pants_\n\n# Non-Critical Findings (13)\n- [[N-01] Unneeded Named Returns (UToken.sol)](https://github.com/code-423n4/2021-10-union-findings/issues/18) _Submitted by ye0lde_\n- [[N-02] list of _admins](https://github.com/code-423n4/2021-10-union-findings/issues/89) _Submitted by pauliax_\n- [[N-03] WadRayMath state variables](https://github.com/code-423n4/2021-10-union-findings/issues/110) _Submitted by pants_\n- [[N-04] UserManager: _getFrozenCoinAge is not used](https://github.com/code-423n4/2021-10-union-findings/issues/46) _Submitted by itsmeSTYJ_\n- [[N-05] AssetManager: getLoanableAmount() can be made more readable](https://github.com/code-423n4/2021-10-union-findings/issues/45) _Submitted by itsmeSTYJ_\n- [[N-06] Code Style: constants should be named in all caps](https://github.com/code-423n4/2021-10-union-findings/issues/61) _Submitted by WatchPug_\n- [[N-07] Unused imports](https://github.com/code-423n4/2021-10-union-findings/issues/55) _Submitted by WatchPug_\n- [[N-08] Code Style: consistency](https://github.com/code-423n4/2021-10-union-findings/issues/52) _Submitted by WatchPug_\n- [[N-09] deposit onlyAssetManager](https://github.com/code-423n4/2021-10-union-findings/issues/83) _Submitted by pauliax_\n- [[N-10] Open TODOs in `Treasury.sol`](https://github.com/code-423n4/2021-10-union-findings/issues/94) _Submitted by pants_\n- [[N-11] Missing events for owner only functions that change critical parameters](https://github.com/code-423n4/2021-10-union-findings/issues/14) _Submitted by defsec_\n- [[N-12] Inconsistent use of `UToken::getBorrowed()`](https://github.com/code-423n4/2021-10-union-findings/issues/19) _Submitted by pmerkleplant_\n- [[N-13] Inconsistent use of `UToken::getLastRepay()`](https://github.com/code-423n4/2021-10-union-findings/issues/20) _Submitted by pmerkleplant_\n\n# Gas Optimizations (43)\n- [[G-01] For Loops Need Break Statements (UserManager.sol)](https://github.com/code-423n4/2021-10-union-findings/issues/27) _Submitted by ye0lde_\n- [[G-02] Function getFrozenCoinAge Can Be Made More Efficient (UserManager.sol)](https://github.com/code-423n4/2021-10-union-findings/issues/26) _Submitted by ye0lde_\n- [[G-03] Function checkIsOverDue Can Be Made More Efficient (UToken.sol)](https://github.com/code-423n4/2021-10-union-findings/issues/23) _Submitted by ye0lde_\n- [[G-04] Functions TotalSupplyView/TotalSupply Can Be Made More Efficient (AssetManager.sol)](https://github.com/code-423n4/2021-10-union-findings/issues/22) _Submitted by ye0lde_\n- [[G-05] Long Revert Strings](https://github.com/code-423n4/2021-10-union-findings/issues/17) _Submitted by ye0lde_\n- [[G-06] Unchecked math operations](https://github.com/code-423n4/2021-10-union-findings/issues/93) _Submitted by pauliax_\n- [[G-07] .length in a loop](https://github.com/code-423n4/2021-10-union-findings/issues/92) _Submitted by pauliax, also found by pants_\n- [[G-08] Zero transfers](https://github.com/code-423n4/2021-10-union-findings/issues/91) _Submitted by pauliax_\n- [[G-09] Pre-calculate known values](https://github.com/code-423n4/2021-10-union-findings/issues/90) _Submitted by pauliax_\n- [[G-10] Struct with only 1 element](https://github.com/code-423n4/2021-10-union-findings/issues/88) _Submitted by pauliax_\n- [[G-11] Immutable variables](https://github.com/code-423n4/2021-10-union-findings/issues/87) _Submitted by pauliax_\n- [[G-12] getSupply and getSupplyView are identical](https://github.com/code-423n4/2021-10-union-findings/issues/86) _Submitted by pauliax_\n- [[G-13] UToken.uErc20 field could be immutable ](https://github.com/code-423n4/2021-10-union-findings/issues/98) _Submitted by pants_\n- [[G-14] UToken.sol _redeemFresh could be set private instead internal](https://github.com/code-423n4/2021-10-union-findings/issues/95) _Submitted by pants_\n- [[G-15] caching multiple used variables](https://github.com/code-423n4/2021-10-union-findings/issues/106) _Submitted by pants_\n- [[G-16] double reading from memory inside a for loop.](https://github.com/code-423n4/2021-10-union-findings/issues/103) _Submitted by pants_\n- [[G-17] --j is more gas efficient than j--.](https://github.com/code-423n4/2021-10-union-findings/issues/102) _Submitted by pants_\n- [[G-18] More efficient loops](https://github.com/code-423n4/2021-10-union-findings/issues/100) _Submitted by pants_\n- [[G-19] stake function in `UserManager` checks for allowance, which is also done in ERC20 transferFrom](https://github.com/code-423n4/2021-10-union-findings/issues/24) _Submitted by loop_\n- [[G-20] Tautologies in require statements](https://github.com/code-423n4/2021-10-union-findings/issues/16) _Submitted by loop_\n- [[G-21] `UserManager`: debtWriteOff() doesn't need if borrower has sufficient assets frozen before subtracting](https://github.com/code-423n4/2021-10-union-findings/issues/44) _Submitted by itsmeSTYJ_\n- [[G-22] `UserManager`: registerMember() can be optimized further](https://github.com/code-423n4/2021-10-union-findings/issues/41) _Submitted by itsmeSTYJ_\n- [[G-23] `UserManager`: cancelVouch() should break from loop when address is found.](https://github.com/code-423n4/2021-10-union-findings/issues/40) _Submitted by itsmeSTYJ_\n- [[G-24] `UserManager`: use mapping to avoid iteration](https://github.com/code-423n4/2021-10-union-findings/issues/39) _Submitted by itsmeSTYJ_\n- [[G-25] `UserManager`: addMember() contains redundant require check](https://github.com/code-423n4/2021-10-union-findings/issues/38) _Submitted by itsmeSTYJ_\n- [[G-26] `UserManager`: getCreditLimit() can be optimized further](https://github.com/code-423n4/2021-10-union-findings/issues/37) _Submitted by itsmeSTYJ_\n- [[G-27] `UserManager`: getTotalLockedStake() redundant assignment](https://github.com/code-423n4/2021-10-union-findings/issues/36) _Submitted by itsmeSTYJ_\n- [[G-28] CreditLimitByMedian: getLockedAmount() can be optimized further.](https://github.com/code-423n4/2021-10-union-findings/issues/34) _Submitted by itsmeSTYJ_\n- [[G-29] UToken: revert on over/underflow checks in addReserve() and removeReserve() are unnecessary](https://github.com/code-423n4/2021-10-union-findings/issues/33) _Submitted by itsmeSTYJ_\n- [[G-30] UToken: _repayBorrowFresh() function can be optimized further](https://github.com/code-423n4/2021-10-union-findings/issues/31) _Submitted by itsmeSTYJ_\n- [[G-31] AssetManager: Deposit() function has redundant continue statement.](https://github.com/code-423n4/2021-10-union-findings/issues/29) _Submitted by itsmeSTYJ, also found by cmichel_\n- [[G-32] Gas efficiency suggestions](https://github.com/code-423n4/2021-10-union-findings/issues/105) _Submitted by hyh, also found by csanuragjain_\n- [[G-33] Overusage of gas due to non needed loop](https://github.com/code-423n4/2021-10-union-findings/issues/7) _Submitted by csanuragjain, also found by WatchPug_\n- [[G-34] Gas: Explicit overflow checks even though solidity 0.8 is used (2)](https://github.com/code-423n4/2021-10-union-findings/issues/75) _Submitted by cmichel_\n- [[G-35] Gas: Explicit overflow checks even though solidity 0.8 is used (1)](https://github.com/code-423n4/2021-10-union-findings/issues/74) _Submitted by cmichel_\n- [[G-36] Gas: `AssetManager.getMoneyMarket` use assignment](https://github.com/code-423n4/2021-10-union-findings/issues/72) _Submitted by cmichel_\n- [[G-37] Gas: `AssetManager.rebalance` cache last market](https://github.com/code-423n4/2021-10-union-findings/issues/71) _Submitted by cmichel_\n- [[G-38] Cache array length in for loops can save gas](https://github.com/code-423n4/2021-10-union-findings/issues/60) _Submitted by WatchPug_\n- [[G-39] Cache and read storage variables from the stack can save gas](https://github.com/code-423n4/2021-10-union-findings/issues/57) _Submitted by WatchPug_\n- [[G-40] Adding unchecked directive can save gas](https://github.com/code-423n4/2021-10-union-findings/issues/58) _Submitted by WatchPug_\n- [[G-41] Avoid unnecessary code execution can save some gas in edge cases](https://github.com/code-423n4/2021-10-union-findings/issues/56) _Submitted by WatchPug_\n- [[G-42] Use short circuiting can save gas](https://github.com/code-423n4/2021-10-union-findings/issues/51) _Submitted by WatchPug_\n- [[G-43] `UserManager`: _updateTotalFrozen can be optimized further](https://github.com/code-423n4/2021-10-union-findings/issues/43) _Submitted by itsmeSTYJ_\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}