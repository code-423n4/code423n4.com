{
  "circa": {
    "title": "Connext Amarok contest",
    "sponsor": "Connext",
    "slug": "2022-06-connext",
    "date": "2022-10-17",
    "findings": "https://github.com/code-423n4/2022-06-connext-findings/issues",
    "contest": 132
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Connext Amarok smart contract system written in Solidity. The audit contest took place between June 8—June 19 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>81 Wardens contributed reports to the Connext Amarok contest:</p>\n<ol>\n<li>xiaoming90</li>\n<li>unforgiven</li>\n<li><a href=\"https://twitter.com/WatchPug_\">WatchPug</a> (<a href=\"https://github.com/jack-the-pug\">jtp</a> and <a href=\"https://github.com/mingwatch\">ming</a>)</li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li>0x1f8b</li>\n<li><a href=\"https://chom.dev\">Chom</a></li>\n<li><a href=\"https://twitter.com/0xhyh\">hyh</a></li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li>0xmint</li>\n<li>cloudjunky</li>\n<li><a href=\"https://twitter.com/shenwilly_\">shenwilly</a></li>\n<li>codexploder</li>\n<li>BowTiedWardens (BowTiedHeron, BowTiedPickle, m4rio_eth, <a href=\"https://twitter.com/BowTiedDravee\">Dravee</a>, and BowTiedFirefox)</li>\n<li><a href=\"https://twitter.com/_Czar102\">Czar102</a></li>\n<li>0x52</li>\n<li>IllIllI</li>\n<li><a href=\"https://twitter.com/hansfriese\">hansfriese</a></li>\n<li>SmartSek (0xDjango and hake)</li>\n<li>cccz</li>\n<li>slywaters</li>\n<li><a href=\"https://github.com/0xKitsune\">0xKitsune</a></li>\n<li>0xNineDec</li>\n<li>Lambda</li>\n<li>0xkatana</li>\n<li><a href=\"https://twitter.com/JoeStakey\">joestakey</a></li>\n<li><a href=\"https://twitter.com/defsec_\">defsec</a></li>\n<li><a href=\"https://milotruck.github.io/\">MiloTruck</a></li>\n<li>cryptphi</li>\n<li>0xf15ers (remora and twojoy)</li>\n<li><a href=\"https://twitter.com/andyfeili\">oyc_109</a></li>\n<li>0x29A (0x4non and rotcivegaf)</li>\n<li><a href=\"https://www.linkedin.com/in/minhquanym/\">minhquanym</a></li>\n<li>GimelSec (<a href=\"https://twitter.com/rayn731\">rayn</a> and sces60107)</li>\n<li>simon135</li>\n<li>robee</li>\n<li>Waze</li>\n<li><a href=\"https://mobile.twitter.com/tomj_bb\">TomJ</a></li>\n<li><a href=\"https://twitter.com/catchup22\">catchup</a></li>\n<li>_Adam</li>\n<li><a href=\"https://twitter.com/c3ph_\">c3phas</a></li>\n<li>ElKu</li>\n<li>Kaiziron</li>\n<li><a href=\"https://twitter.com/0xNazgul\">0xNazgul</a></li>\n<li>asutorufos</li>\n<li><a href=\"https://twitter.com/kylriley\">k</a></li>\n<li><a href=\"https://twitter.com/father0fBl0cks\">fatherOfBlocks</a></li>\n<li>sach1r0</li>\n<li><a href=\"https://instagram.com/vanensurya\">Funen</a></li>\n<li>bardamu</li>\n<li><a href=\"https://twitter.com/cmichelio\">cmichel</a></li>\n<li><a href=\"https://twitter.com/MukeshJ_eth\">JMukesh</a></li>\n<li>sorrynotsorry</li>\n<li>Jujic</li>\n<li>kenta</li>\n<li>TerrierLover</li>\n<li><a href=\"https://twitter.com/ch13fd357r0y3r\">ch13fd357r0y3r</a></li>\n<li>SooYa</li>\n<li>tintin</li>\n<li>auditor0517</li>\n<li>jayjonah8</li>\n<li>obtarian</li>\n<li>zzzitron</li>\n<li>Metatron</li>\n<li><a href=\"https://twitter.com/meidhiwirara\">Tomio</a></li>\n<li>UnusualTurtle</li>\n<li>apostle0x01</li>\n<li><a href=\"https://twitter.com/0xKaden\">kaden</a></li>\n<li><a href=\"https://www.instagram.com/riyan_rfa/\">rfa</a></li>\n<li><a href=\"https://twitter.com/fitraldys\">Fitraldys</a></li>\n<li><a href=\"https://twitter.com/0xheynacho\">ignacio</a></li>\n<li>nahnah</li>\n<li><a href=\"https://twitter.com/randyyramadhan\">Randyyy</a></li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/0xleastwood\">0xleastwood</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 26 unique vulnerabilities. Of these vulnerabilities, 6 received a risk rating in the category of HIGH severity and 20 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 57 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 44 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-06-connext\">C4 Connext Amarok contest repository</a>, and is composed of 24 smart contracts (and 10 libraries) written in the Solidity programming language and includes 3765 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-6\" style=\"position:relative;\"><a href=\"#high-risk-findings-6\" aria-label=\"high risk findings 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (6)</h1>\n<h2 id=\"h-01-portcalfacetrepayaaveportal-can-trigger-an-underflow-of-routerbalances\" style=\"position:relative;\"><a href=\"#h-01-portcalfacetrepayaaveportal-can-trigger-an-underflow-of-routerbalances\" aria-label=\"h 01 portcalfacetrepayaaveportal can trigger an underflow of routerbalances permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/68\">[H-01] <code>PortcalFacet.repayAavePortal()</code> can trigger an underflow of <code>routerBalances</code></a></h2>\n<p><em>Submitted by Ruhum, also found by 0x1f8b and WatchPug</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/main/contracts/contracts/core/connext/facets/PortalFacet.sol#L80-L113\">PortalFacet.sol#L80-L113</a><br></p>\n<p>The caller of <code>repayAavePortal()</code> can trigger an underflow to arbitrarily increase the caller’s balance through an underflow.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"sol\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Relevant code sections:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// PortalFacet.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">repayAavePortal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_local</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_backingAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_feeAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxIn</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_transferId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_backingAmount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_feeAmount</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// in adopted</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">routerBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerBalances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_local</span><span class=\"mtk1\">]; </span><span class=\"mtk3\">// in local</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Sanity check: has that much to spend</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">routerBalance</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_maxIn</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">PortalFacet__repayAavePortal_insufficientFunds</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Need to swap into adopted asset or asset that was backing the loan</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// The router will always be holding collateral in the local asset while the loaned asset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// is the adopted asset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Swap for exact `totalRepayAmount` of adopted asset to repay aave</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">adopted</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">AssetLogic</span><span class=\"mtk1\">.</span><span class=\"mtk11\">swapFromLocalAssetIfNeededForExactOut</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_local</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">totalAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_maxIn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">success</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">PortalFacet__repayAavePortal_swapFailed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// decrement router balances</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerBalances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_local</span><span class=\"mtk1\">] -= </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// back loan</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_backLoan</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_local</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_backingAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_feeAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_transferId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// AssetLogic.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">swapFromLocalAssetIfNeededForExactOut</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxIn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">AppStorage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">s</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">LibConnextStorage</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connextStorage</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Get the token id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (, </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenRegistry</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getTokenId</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// If the adopted asset is the local asset, no need to swap</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">adopted</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">canonicalToAdopted</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">adopted</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_swapAssetOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">id</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">, </span><span class=\"mtk12\">adopted</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_maxIn</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>First, call <code>repayAavePortal()</code> where <code>_backingAmount + _feeAmount > s.routerBalances[msg.sender][_local] &#x26;&#x26; _maxIn > s.routerBalances[msg.sender][_local]</code>. That will trigger the call to the AssetLogic contract:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"sol\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">adopted</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">AssetLogic</span><span class=\"mtk1\">.</span><span class=\"mtk11\">swapFromLocalAssetIfNeededForExactOut</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_local</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">totalAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_maxIn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span></code></pre>\n<p>By setting <code>_local</code> to the same value as the adopted asset, you trigger the following edge case:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"sol\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">adopted</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">canonicalToAdopted</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">adopted</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>So the <code>amountIn</code> value returned by <code>swapFromLocalAssetIfNeededForExactOut()</code> is the <code>totalAmount</code> value that was passed to it. And <code>totalAmount == _backingAmount + _feeAmount</code>.</p>\n<p>Meaning the <code>amountIn</code> value is user-specified for this edge case. Finally, we reach the following line:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"sol\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerBalances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_local</span><span class=\"mtk1\">] -= </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><code>amountIn</code> (user-specified) is subtracted from the <code>routerBalances</code> in an <code>unchecked</code> block. Thus, the attacker is able to trigger an underflow and increase their balance arbitrarily high. The <code>repayAavePortal()</code> function only verifies that <code>routerBalance &#x3C; _maxIn</code>.</p>\n<p>Here’s a test as PoC:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"sol\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// PortalFacet.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">test_PortalFacet_underflow</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerPermissionInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">approvedForPortalRouters</span><span class=\"mtk1\">[</span><span class=\"mtk12\">router</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">backing</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">init</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerBalances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">router</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_local</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">init</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">portalDebt</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">backing</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">portalFeeDebt</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mockCall</span><span class=\"mtk1\">(</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">aavePool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSelector</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IAavePool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">backUnbacked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">), </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk4\">true</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">router</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">this</span><span class=\"mtk1\">.</span><span class=\"mtk11\">repayAavePortal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_local</span><span class=\"mtk1\">, </span><span class=\"mtk12\">backing</span><span class=\"mtk1\">, </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">, </span><span class=\"mtk12\">init</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">0.5</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_id</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// balance &gt; init =&gt; underflow</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerBalances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">router</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_local</span><span class=\"mtk1\">] &gt; </span><span class=\"mtk12\">init</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>After the call to <code>swapFromLocalAssetIfNeededForExactOut()</code> you should add the following check:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"sol\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_local</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">adopted</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">routerBalance</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/68#issuecomment-1167501711\">LayneHaber (Connext) confirmed and resolved</a>:</strong></p>\n<blockquote>\n<p><a href=\"https://github.com/connext/nxtp/pull/1450/commits/ac95c1b987c34862e106fc7d643fb8bb7ebb053e\">connext/nxtp@ac95c1b</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/68#issuecomment-1202020574\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This is entirely valid and a really severe issue. If the local asset is the adopted asset, <code>AssetLogic.swapFromLocalAssetIfNeededForExactOut()</code> will return <code>amountIn == totalAmount</code>. So in order to overflow <code>routerBalances</code>, the router just needs to provide <code>_backingAmount + _feeAmount</code> inputs that sum to exceed the router’s current balance.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-02-wrong-implementation-of-withdrawadminfees-can-cause-the-adminfees-to-be-charged-multiple-times-and-therefore-cause-users-fund-loss\" style=\"position:relative;\"><a href=\"#h-02-wrong-implementation-of-withdrawadminfees-can-cause-the-adminfees-to-be-charged-multiple-times-and-therefore-cause-users-fund-loss\" aria-label=\"h 02 wrong implementation of withdrawadminfees can cause the adminfees to be charged multiple times and therefore cause users fund loss permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/202\">[H-02] Wrong implementation of <code>withdrawAdminFees()</code> can cause the <code>adminFees</code> to be charged multiple times and therefore cause users’ fund loss</a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/libraries/SwapUtils.sol#L1053-L1062\">SwapUtils.sol#L1053-L1062</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdrawAdminFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Swap</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">self</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pooledTokens</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">self</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pooledTokens</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">pooledTokens</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pooledTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">self</span><span class=\"mtk1\">.</span><span class=\"mtk12\">adminFees</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">balance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><code>self.adminFees[i]</code> should be reset to 0 every time it’s withdrawn. Otherwise, the <code>adminFees</code> can be withdrawn multiple times.</p>\n<p>The admin may just be unaware of this issue and casualty <code>withdrawAdminFees()</code> from time to time, and rug all the users slowly.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdrawAdminFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Swap</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">self</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pooledTokens</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">self</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pooledTokens</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">pooledTokens</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pooledTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">self</span><span class=\"mtk1\">.</span><span class=\"mtk12\">adminFees</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">self</span><span class=\"mtk1\">.</span><span class=\"mtk12\">adminFees</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">balance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/202#issuecomment-1167495532\">LayneHaber (Connext) confirmed and resolved</a>:</strong></p>\n<blockquote>\n<p><a href=\"https://github.com/connext/nxtp/pull/1450/commits/8eef974724bf2b9cdd506a1a63d8cc869303c3e5\">connext/nxtp@8eef974</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/202#issuecomment-1206907050\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Completely agree with the validity of this finding. Even if the admin was <em>not</em> malicious, the bug will still continue to withdraw additional fees which were not included as part of the swap calculations. LPs would lose considerable value as a result.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-03-router-owner-could-steal-all-the-funds-within-sponsorvault\" style=\"position:relative;\"><a href=\"#h-03-router-owner-could-steal-all-the-funds-within-sponsorvault\" aria-label=\"h 03 router owner could steal all the funds within sponsorvault permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/145\">[H-03] Router Owner Could Steal All The Funds Within <code>SponsorVault</code></a></h2>\n<p><em>Submitted by xiaoming90</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/BridgeFacet.sol#L541\">BridgeFacet.sol#L541</a><br>\n<a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/helpers/SponsorVault.sol#L196\">SponsorVault.sol#L196</a><br></p>\n<p>Assume the following:</p>\n<ul>\n<li>For simplicity sake, only two (2) routers exist within Connext. Gas, relayer, callback fees and slippage are ignored.</li>\n<li>An attacker owns Router A. Router A has <code>1,000,000</code> oUSDC on Optimism Domain/Chain</li>\n<li>Router B has only <code>100</code> oUSDC on Optimism Domain/Chain</li>\n<li>The liquidity fee is 5% for fast transfer service</li>\n<li>SponserVault will reimbursed 50% of the liquidity fee incurred by the users</li>\n</ul>\n<p>At this point, attacker balances are as follows (2,000,000 USDC in total)</p>\n<blockquote>\n<p>Attacker’s wallet in Ethereum = <code>1,000,000</code> USDC</p>\n<p>Attacker’s wallet in Optimism = <code>0</code> oUSDC</p>\n<p>Attacker’s router in Optimism = <code>1,000,000</code> oUSDC</p>\n</blockquote>\n<p>First, the attacker attempts to transfer an extremely large amount - <code>1,000,000</code> USDC from attacker’s address in Ethereum to attacker’s address in Optimism Chain. The transfer amount should be much larger than the rest of the router’s liquidity so that only attacker’s router is capable of providing the liqudity.</p>\n<p>In our example, since Router B does not have sufficient liquidity to faciliate the fast transfer, Router B will not be selected by the Sequencer. Since only Router A has sufficient liquidity, Router A, which is owned by the attacker, will faciliate the fast transfer and selected by the Sequencer.</p>\n<p>Since the liquidity fee is 5%, Router A only need to supply <code>950,000</code> oUSDC on <code>execute</code>. The Sponsor will then reimburse 50% of the liquidity fee, which is<code>25,000</code> oUSDC in total. The final amount of oUSDC send to the attacker’s wallet address in Optimism will be <code>975,000</code> oUSDC.</p>\n<p>At this point, attacker balances are as follows (1,025,000 USDC in total)</p>\n<blockquote>\n<p>Attacker’s wallet in Ethereum = <code>0</code> USDC</p>\n<p>Attacker’s wallet in Optimism = <code>975,000</code> oUSDC</p>\n<p>Attacker’s router in Optimism = <code>50,000</code> oUSDC</p>\n</blockquote>\n<p>When the nomad message arrives, the attacker will be reimbursed <code>1,000,000</code> oUSDC when <a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/BridgeFacet.sol#L541\"><code>BridgeFacet._reconcile</code></a> is triggered.</p>\n<p>At this point, attacker balances are as follows (2,025,000 USDC in total)</p>\n<blockquote>\n<p>Attacker’s wallet in Ethereum = <code>0</code> USDC</p>\n<p>Attacker’s wallet in Optimism = <code>975,000</code> oUSDC</p>\n<p>Attacker’s router in Optimism = <code>50,000</code> + <code>1,000,000</code> oUSDC</p>\n</blockquote>\n<p>Attacker earned <code>25,000</code> USDC, and SponsorVault lost <code>25,000</code> USDC.</p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Router owner can intentionally perform many large transfer between their own wallets in two different domain to siphon all the funds from the SponsorVault, and then proceed to withdraw all liquidity from his router.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Although having a sponsor to subside the liqudity fee to encourage users to use sponsor’s chain, this subsidy can be gamed by malicious actors for their own benefits. It is recommended to reconsider the need of having a sponsor in Connext as extreme care have to be taken in its design to ensure that it will not be exploited.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/145#issuecomment-1166343703\">LayneHaber (Connext) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>The <code>SponsorVault</code> is not mandatory for the bridge flow, and the entire point of the vault option is to allow domains to subsidize fees for users transferring funds there. This is incredibly useful for new domains, that have no default bridge and want to remove any friction for users to get to their chain. Sponsor vault funders should be informed there is no way to enforce only legitimate users get the funds and it is inherently vulnerable to sybil attacks. In our conversations with potential sponsors, they are aware of these issues and are still willing to fund sponsor vaults to a limited capacity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/145#issuecomment-1214222883\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>It seems that it would be easy for routers to sybil attack the protocol and continuously drain the sponsor vault of all its funds. While I understand this might not be an issue when the set of routers is trusted, however, as the protocol continues to become more decentralized, this would be a likely path of attack. I also agree with the current risk even though users’ funds aren’t at direct risk, the functionality of the sponsor vault is rendered useless and the router profits from this attack.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-04-in-execute-the-amount-routers-pay-is-what-user-signed-but-in-_reconcile-the-amount-routers-get-is-what-nomad-sends-and-these-two-amounts-are-not-necessary-equal-because-of-slippage-in-original-domain\" style=\"position:relative;\"><a href=\"#h-04-in-execute-the-amount-routers-pay-is-what-user-signed-but-in-_reconcile-the-amount-routers-get-is-what-nomad-sends-and-these-two-amounts-are-not-necessary-equal-because-of-slippage-in-original-domain\" aria-label=\"h 04 in execute the amount routers pay is what user signed but in _reconcile the amount routers get is what nomad sends and these two amounts are not necessary equal because of slippage in original domain permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/222\">[H-04] In <code>execute()</code> the amount routers pay is what user signed, but in <code>_reconcile()</code> the amount routers get is what nomad sends and these two amounts are not necessary equal because of slippage in original domain</a></h2>\n<p><em>Submitted by unforgiven</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/facets/BridgeFacet.sol#L526-L616\">BridgeFacet.sol#L526-L616</a><br>\n<a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/facets/BridgeFacet.sol#L753-L803\">BridgeFacet.sol#L753-L803</a><br>\n<a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/facets/BridgeFacet.sol#L398-L428\">BridgeFacet.sol#L398-L428</a><br>\n<a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/facets/BridgeFacet.sol#L345-L351\">BridgeFacet.sol#L345-L351</a><br></p>\n<p>Routers pay for transaction in destination domain then nomad messages come and routers get paid again. but the amount routers pay in <code>execute()</code> are what transaction sender signed and the amount routers receive is what nomad sends and handles in <code>_reconcile()</code> but this two amount can be different because of slippage and swap that happens in <code>xcall()</code> because the amount sent in nomad message is the result of <code>swapToLocalAssetIfNeeded()</code>.<br>\nSo it’s possible for routers to lose funds if some slippage happens in that swap.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is <code>xcall()</code> code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function xcall(XCallArgs calldata _args) external payable whenNotPaused nonReentrant returns (bytes32) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Sanity checks.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Correct origin domain.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      if (_args.params.originDomain != s.domain) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        revert BridgeFacet__xcall_wrongDomain();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Recipient is defined.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      if (_args.params.to == address(0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        revert BridgeFacet__xcall_emptyTo();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // If callback address is not set, callback fee should be 0.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      if (_args.params.callback == address(0) &amp;&amp; _args.params.callbackFee &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        revert BridgeFacet__xcall_nonZeroCallbackFeeForCallback();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Callback is contract if supplied.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      if (_args.params.callback != address(0) &amp;&amp; !Address.isContract(_args.params.callback)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        revert BridgeFacet__xcall_callbackNotAContract();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes32 transferId;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes memory message;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    XCalledEventArgs memory eventArgs;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Get the remote BridgeRouter address; revert if not found.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      bytes32 remote = _mustHaveRemote(_args.params.destinationDomain);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Get the true transacting asset ID (using wrapper instead of native, if applicable).</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      address transactingAssetId = _args.transactingAssetId == address(0)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ? address(s.wrapper)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        : _args.transactingAssetId;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Check that the asset is supported -- can be either adopted or local.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      ConnextMessage.TokenId memory canonical = s.adoptedToCanonical[transactingAssetId];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      if (canonical.id == bytes32(0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Here, the asset is *not* the adopted asset. The only other valid option</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // is for this asset to be the local asset (i.e. transferring madEth on optimism)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // NOTE: it *cannot* be the canonical asset. the canonical asset is only used on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // the canonical domain, where it is *also* the adopted asset.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (s.tokenRegistry.isLocalOrigin(transactingAssetId)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          // revert, using a token of local origin that is not registered as adopted</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          revert BridgeFacet__xcall_notSupportedAsset();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (uint32 canonicalDomain, bytes32 canonicalId) = s.tokenRegistry.getTokenId(transactingAssetId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        canonical = ConnextMessage.TokenId(canonicalDomain, canonicalId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      transferId = _getTransferId(_args, canonical);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      s.nonce += 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Store the relayer fee</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      s.relayerFees[transferId] = _args.params.relayerFee;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Transfer funds of transacting asset to the contract from the user.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // NOTE: Will wrap any native asset transferred to wrapped-native automatically.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      (, uint256 amount) = AssetLogic.handleIncomingAsset(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _args.transactingAssetId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _args.amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _args.params.relayerFee + _args.params.callbackFee</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Swap to the local asset from adopted if applicable.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      (uint256 bridgedAmt, address bridged) = AssetLogic.swapToLocalAssetIfNeeded(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        canonical,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        transactingAssetId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _args.params.slippageTol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Transfer callback fee to PromiseRouter if set</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      if (_args.params.callbackFee != 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        s.promiseRouter.initCallbackFee{value: _args.params.callbackFee}(transferId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      message = _formatMessage(_args, bridged, transferId, bridgedAmt);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      s.xAppConnectionManager.home().dispatch(_args.params.destinationDomain, remote, message);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Format arguments for XCalled event that will be emitted below.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      eventArgs = XCalledEventArgs({</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        transactingAssetId: transactingAssetId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        amount: amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bridgedAmt: bridgedAmt,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bridged: bridged</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      });</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // emit event</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    emit XCalled(transferId, _args, eventArgs, s.nonce - 1, message, msg.sender);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return transferId;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>As you can see it swaps what user sent to <code>LoccalAsset</code> which the amount is <code>bridgedAmt</code> and then send value of <code>bridgedAmt</code> to nomad bridge <code>message = _formatMessage(_args, bridged, transferId, bridgedAmt)</code>.<br>\nBut the amount user signed in <code>_args.amount</code> is different and that what user sends to contract.<br>\nThe reasons that <code>bridgedAmt</code> could be different than <code>_args.amount</code> is:<br>\n1- deflationary tokens in transferring from user.<br>\n2- slippage in swap to local token.<br>\nThis is <code>_reconcile()</code> code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function _reconcile(uint32 _origin, bytes memory _message) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Parse tokenId and action from the message.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes29 msg_ = _message.ref(0).mustBeMessage();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes29 tokenId = msg_.tokenId();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes29 action = msg_.action();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Assert that the action is valid.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (!action.isTransfer()) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      revert BridgeFacet__reconcile_invalidAction();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Load the transferId.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes32 transferId = action.transferId();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Ensure the transaction has not already been handled (i.e. previously reconciled).</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (s.reconciledTransfers[transferId]) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      revert BridgeFacet__reconcile_alreadyReconciled();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // NOTE: `tokenId` and `amount` must be in plaintext in the message so funds can *only* be minted by</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // `handle`. They are both used in the generation of the `transferId` so routers must provide them</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // correctly to be reimbursed.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Get the appropriate local token contract for the given tokenId on this chain.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // NOTE: If the token is of remote origin and there is no existing representation token contract,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // the TokenRegistry will deploy a new one.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address token = s.tokenRegistry.ensureLocalToken(tokenId.domain(), tokenId.id());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Load amount once.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 amount = action.amnt();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Mint tokens if the asset is of remote origin (i.e. is representational).</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // NOTE: If the asset IS of local origin (meaning it&#39;s canonical), then the tokens will already be held</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // in escrow in this contract (from previous `xcall`s).</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (!s.tokenRegistry.isLocalOrigin(token)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      IBridgeToken(token).mint(address(this), amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Update the recorded `detailsHash` for the token (name, symbol, decimals).</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // TODO: do we need to keep this</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      bytes32 details = action.detailsHash();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      IBridgeToken(token).setDetailsHash(details);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Mark the transfer as reconciled.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    s.reconciledTransfers[transferId] = true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // If the transfer was executed using fast-liquidity provided by routers, then this value would be set</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // to the participating routers.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // NOTE: If the transfer was not executed using fast-liquidity, then the funds will be reserved for</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // execution (i.e. funds will be delivered to the transfer&#39;s recipient in a subsequent `execute` call).</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address[] memory routers = s.routedTransfers[transferId];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // If fast transfer was made using portal liquidity, we need to repay</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // FIXME: routers can repay any-amount out-of-band using the `repayAavePortal` method</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // or by interacting with the aave contracts directly</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 portalTransferAmount = s.portalDebt[transferId] + s.portalFeeDebt[transferId];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 toDistribute = amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 pathLen = routers.length;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (portalTransferAmount != 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // ensure a router took on credit risk</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      if (pathLen != 1) revert BridgeFacet__reconcile_noPortalRouter();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      toDistribute = _reconcileProcessPortal(amount, token, routers[0], transferId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (pathLen != 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // fast liquidity path</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Credit each router that provided liquidity their due &#39;share&#39; of the asset.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      uint256 routerAmt = toDistribute / pathLen;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      for (uint256 i; i &lt; pathLen; ) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        s.routerBalances[routers[i]][token] += routerAmt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        unchecked {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          i++;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    emit Reconciled(transferId, _origin, routers, token, amount, msg.sender);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>As you can see it uses amount in message to calculate what router should receive.<br>\nThis is <code>_handleExecuteLiquidity()</code> code which is used in <code>execute()</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function _handleExecuteLiquidity(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes32 _transferId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bool _isFast,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ExecuteArgs calldata _args</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) private returns (uint256, address) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 toSwap = _args.amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // If this is a fast liquidity path, we should handle deducting from applicable routers&#39; liquidity.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // If this is a slow liquidity path, the transfer must have been reconciled (if we&#39;ve reached this point),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // and the funds would have been custodied in this contract. The exact custodied amount is untracked in state</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // (since the amount is hashed in the transfer ID itself) - thus, no updates are required.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_isFast) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      uint256 pathLen = _args.routers.length;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Calculate amount that routers will provide with the fast-liquidity fee deducted.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      toSwap = _getFastTransferAmount(_args.amount, s.LIQUIDITY_FEE_NUMERATOR, s.LIQUIDITY_FEE_DENOMINATOR);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Save the addressess of all routers providing liquidity for this transfer.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      s.routedTransfers[_transferId] = _args.routers;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // If router does not have enough liquidity, try to use Aave Portals.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // only one router should be responsible for taking on this credit risk, and it should only</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // deal with transfers expecting adopted assets (to avoid introducing runtime slippage)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      if (</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        !_args.params.receiveLocal &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pathLen == 1 &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        s.routerBalances[_args.routers[0]][_args.local] &lt; toSwap &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        s.aavePool != address(0)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      ) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (!s.routerPermissionInfo.approvedForPortalRouters[_args.routers[0]])</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          revert BridgeFacet__execute_notApprovedForPortals();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Portal provides the adopted asset so we early return here</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return _executePortalTransfer(_transferId, toSwap, _args.local, _args.routers[0]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // for each router, assert they are approved, and deduct liquidity</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 routerAmount = toSwap / pathLen;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        for (uint256 i; i &lt; pathLen; ) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          // decrement routers liquidity</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          s.routerBalances[_args.routers[i]][_args.local] -= routerAmount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          unchecked {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            i++;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see it uses the amount defined in <code>ExecuteArgs</code> to see how much routers should pay.</p>\n<p>Because of these two issues (deflationary tokens and swap slippage) attacker could fool protocol to spend more than what he transferred to protocol. This could be seen as two bugs.</p>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VIM</p>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Update spending amount based on  (deflationary tokens and swap slippage).</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/222#issuecomment-1166334184\">LayneHaber (Connext) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>I think there is a misunderstanding here — the user takes on the slippage risk both into and out of the local assets, and the router has consistent returns on what was bridged.</p>\n<p>On <code>xcall</code>, the user swaps the amount put in for the local asset. This incurs some slippage, and only the amount of the local asset is bridged directly. It is the bridged amount that the router should supply liquidity for, and take fees on. Once the router supplies liquidity in <code>execute</code> (bridged amount minus the fees), then it is swapped for the local asset and sent to the user. The user may get some different amount here, but it is the user who is impacted by this slippage. On handle, the router is credited the bridged amount.</p>\n<p>However, there was a separate bug where the <code>transferId</code> was generated with the wrong <code>amount</code> on execute, so that could be where the confusion is coming from.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/222#issuecomment-1214224150\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I actually agree with the warden here, it seems that they’re right about the issue but they just failed to mention the main reason why its an issue is because <code>transferId</code> is calculated using <code>_args.amount</code> which does not necessarily equal <code>bridgedAmt</code> due to slippage. Therefore, routers may end up fronting too much liquidity and receive considerably less when the bridge transfer is eventually reconciled. This seems rather severe as the user will receive the full transfer amount without slippage. This could be abused to drain routers on low liquidity tokens.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/222#issuecomment-1218136485\">LayneHaber (Connext) commented</a>:</strong></p>\n<blockquote>\n<p>Right — I agree that the problems outlined here would be the true consequences for a mismatched <code>transferId</code>. If the question is to take the action outlined <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/227#issuecomment-1214224706\">here</a> — specifically to keep this open and downgrade #227 as a QA — that would work with me.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/222\">LayneHaber (Connext) resolved</a>:</strong></p>\n<blockquote>\n<p><a href=\"https://github.com/connext/nxtp/commit/f41a156b55a01837c8f57a77e52781f74406e1cd\">connext/nxtp@f41a156</a></p>\n</blockquote>\n<hr>\n<h2 id=\"h-05-routers-are-not-enforced-to-repay-aave-portal-loan\" style=\"position:relative;\"><a href=\"#h-05-routers-are-not-enforced-to-repay-aave-portal-loan\" aria-label=\"h 05 routers are not enforced to repay aave portal loan permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/143\">[H-05] Routers are not Enforced to Repay AAVE Portal Loan</a></h2>\n<p><em>Submitted by xiaoming90</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/facets/BridgeFacet.sol#L984\">BridgeFacet.sol#L984</a><br></p>\n<h3 id=\"background\" style=\"position:relative;\"><a href=\"#background\" aria-label=\"background permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Background</h3>\n<h4 id=\"aave-portal\" style=\"position:relative;\"><a href=\"#aave-portal\" aria-label=\"aave portal permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>AAVE Portal</h4>\n<p>AAVE portal provides a trusted credit line that allows bridges to take on an unbacked position, and Connext intents to use this credit line to provide fast-liquidity for its users in the event the routers do not have sufficient liquidity.</p>\n<p>Connext will assign one (1) router to be responsible for taking on credit risk of borrowing an unbacked position from AAVE portal as per <a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/facets/BridgeFacet.sol#L777\">Source Code</a>.</p>\n<p>Under normal circumstance, the <code>BridgeFacet._reconcile</code> function will automatically repay back the loan to AAVE portal when the nomad message arrives. However, if the repayment fails for certain reason, Connext expects that the router will use the <a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/PortalFacet.sol#L80\"><code>repayAavePortal</code></a> function out-of-band to help Connext to repay the loan.</p>\n<p>Ultimately, it is Connext that take on the credit risk because AAVE portal only provides a trusted credit line to Connext, but not to the individual routers.</p>\n<h4 id=\"nomad-message\" style=\"position:relative;\"><a href=\"#nomad-message\" aria-label=\"nomad message permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Nomad Message</h4>\n<p>When nomad message arrives, it will call <code>BridgeFacet.handle</code> function, which will in turn trigger the internal <code>_reconcile</code> function. Note that the <code>handle</code> or <code>_reconcile</code> function cannot be reverted under any circumstances because nomad message cannot be reprocessed on the nomad side.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof-of-Concept</h3>\n<ol>\n<li>Alice transfers <code>1,000,000</code> DAI from Ethereum domain to Polygon domain</li>\n<li>None of the existing routers have sufficient liquidity, thus the sequencer decided that AAVE Portal should be used</li>\n<li>Bob’s router has been selected to take on the credit risk for the unbacked position, and Connext proceeds to borrow <code>1,000,000</code> DAI from AAVE Portal and send the <code>1,000,000</code> DAI to Alice’s wallet on Polygon domain</li>\n<li>When slow nomad message arrives, <code>BridgeFacet._reconcile</code> function is triggered to attempt to repay back the loan to AAVE portal. This function will in turn trigger the <a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/facets/BridgeFacet.sol#L984\"><code>BridgeFacet._reconcileProcessPortal</code></a> function where the portal repayment logic resides.</li>\n<li>Within the <code>BridgeFacet._reconcileProcessPortal</code>, notice that if the <code>AssetLogic.swapFromLocalAssetIfNeededForExactOut</code> swap fails, it will return <a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/facets/BridgeFacet.sol#L1022\"><code>_amount</code></a>.</li>\n<li>Within the <code>BridgeFacet._reconcileProcessPortal</code>, notice that if the ``AavaPool.backUnbacked<code>external repayment call fails, it will set</code>amountIn = 0<code>, and then return [</code>return (_amount - amountIn)<code>](https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/facets/BridgeFacet.sol#L1061) , which is basically the same as</code>_amount`.</li>\n<li>When the <code>_reconcileProcessPortal</code> function call returned at <a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/facets/BridgeFacet.sol#L603\">Line 603</a>, it will set the <code>toDistribute</code> to the <code>amount</code>. <code>amount</code> in this example is <code>1,000,000</code> DAI.</li>\n<li>Next, at <a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/facets/BridgeFacet.sol#L611\">Line 611</a>, the contract will increase Bob’s router balance by <code>1,000,000</code> DAI</li>\n<li>Bob notices that his router balance has increased by <code>1,000,000</code> DAI, and he could not resist the tempation of <code>1,000,000</code> DAI. Therefore, instead of helping Connext to repay the loan via <code>repayAavePortal</code> function out-of-band, he decided to quickly withdraws all his liquidty from his router.</li>\n<li>Bob gained <code>1,000,000</code> DAI, while Connext still owns AAVE portal <code>1,000,000</code> DAI</li>\n</ol>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>If routers decided not to repay the loan, Connext will incur large amount of debt from AAVE portal.</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Understood that there is a whitelist for routers that can use portals to ensure that only trusted routers could use this feature. In this case, the trust entirely depends on the integrity of the router owner and the assumption that the owner will not act against Connext and its community. However, as seen in many of the past security incidents, trusted actor or even own protocol team member might turn rogue when dealing with significant gain. In the above example, <code>1,000,000</code> DAI. It is common to see even larger amount of funds transferring across the bridge.</p>\n<p>Therefore, to overcome the above-mentioned risk, some protocol would implement <code>m-of-n</code> multisig or validation, which help to mitigate the risk of a single trusted actor from turning rogue and perform malicious action.</p>\n<p>Therefore, it is recommended to reconsider such design and explore other alternatives. One such alternative would be as follows:</p>\n<blockquote>\n<p>Assuming that the AAVE portal interest rate is fixed, therefore, the amount of repayment is deterministic, and Connext can compute the amount of repayment that needs to be repaid at any point of time.</p>\n<p>When the <code>BridgeFacet._reconcileProcessPortal</code> swap or <code>AavaPool.backUnbacked</code> fails, do not immediately credit the Bob’s router balance. Instead, escrow the amount  (<code>1,000,000</code> DAI) received from nomad in an <code>Escrow</code> contract. Implement a function called <code>settleAAVEPortalLoan</code> within the <code>Escrow</code> contract, which contains the logic to perform the necessary actions to repay AAVE portal loan. In this case, Bob is responsible for triggering the <code>Escrow.settleAAVEPortalLoan</code> to kick start the out-of-band repayment process. If the repayment is sucessful, Bob’s router will be credited with the earning for taking on credit risk.</p>\n<p>One positive side effect of this approach is that Bob will be incentivize to make the repayment as fast as possible because the longer he delays, the higher the interest rate, and thus less earning for him.</p>\n<p>This approach is quite similar to the withdrawal pattern.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/143#issuecomment-1167461057\">LayneHaber (Connext) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>This is correct, and using an escrow contract would be helpful, but in general the router has no incentive ever to repay aave loans (even with this fix). This eliminates the possibility of a router profiting from the mishandling of <code>reconcile</code>, but doesn’t address the root of the trustedness, which is embedded at the aave layer (by being able to take out unbacked loans).</p>\n</blockquote>\n<hr>\n<h2 id=\"h-06-malicious-relayer-can-replay-execute-calldata-on-different-chains-causing-double-spend-issue\" style=\"position:relative;\"><a href=\"#h-06-malicious-relayer-can-replay-execute-calldata-on-different-chains-causing-double-spend-issue\" aria-label=\"h 06 malicious relayer can replay execute calldata on different chains causing double spend issue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/144\">[H-06] Malicious Relayer can Replay Execute Calldata on Different Chains Causing Double-Spend Issue</a></h2>\n<p><em>Submitted by xiaoming90</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/BridgeFacet.sol#L411\">BridgeFacet.sol#L411</a><br></p>\n<blockquote>\n<p>This issue is only applicable for fast-transfer. Slow transfer would not have this issue because of the built-in fraud-proof mechanism in Nomad.</p>\n</blockquote>\n<p>First, the attacker will attempt to use Connext to send <code>1000 USDC</code> from Ethereum domain to Optimism domain.</p>\n<p>Assume that the attacker happens to be a relayer on the relayer network utilised by Connext, and the attacker’s relayer happens to be tasked to relay the above execute calldata to the Optimism’s Connext <a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/BridgeFacet.sol#L411\"><code>BridgeFacet.execute</code></a> function.</p>\n<p>Optimism’s Connext <code>BridgeFacet.execute</code> received the execute calldata and observed within the calldata that it is a fast-transfer and Router A is responsible for providing the liquidity. It will then check that the router signature is valid, and proceed to transfer <code>1000 oUSDC</code> to attacker wallet (0x123456) in Optimism.</p>\n<p>Next, attacker will update the <code>ExecuteArgs.local</code> within the execute calldata to a valid local representation of canonical token (USDC) used within Polygon. Attacker will then send the modified execute calldata to Polygon’s Connext <code>BridgeFacet.execute</code> function. Assume that the same Router A is also providing liquidity in Polygon. The <code>BridgeFacet.execute</code> function checks that the router signature is valid, and proceed to transfer <code>1000 POS-USDC</code> to atttack wallet (0x123456) in Polygon.</p>\n<p>At this point, the attacker has <code>1000 oUSDC</code> and <code>1000 POS-USDC</code> in his wallets. When the nomad message arrives at Optimism, Router A can claim the <code>1000 oUSDC</code> back from Connext. However, Router A is not able to claim back any fund in Polygon.</p>\n<p>Note that same wallet address exists on different chains. For instance, the wallet address on Etherum and Polygon is the same.</p>\n<h4 id=\"why-changing-the-executeargslocal-does-not-affect-the-router-signature-verification\" style=\"position:relative;\"><a href=\"#why-changing-the-executeargslocal-does-not-affect-the-router-signature-verification\" aria-label=\"why changing the executeargslocal does not affect the router signature verification permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Why changing the <code>ExecuteArgs.local</code> does not affect the router signature verification?</h4>\n<p>This is because the router signature is generated from the <code>transferId</code> + <code>pathLength</code> only, and these data are stored within the <code>CallParams params</code> within the <code>ExecuteArgs</code> struct.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/libraries/LibConnextStorage.sol#L77\">LibConnextStorage.sol#L77</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">struct</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ExecuteArgs</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">CallParams</span><span class=\"mtk1\"> </span><span class=\"mtk12\">params</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">local</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// local representation of canonical token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">routers</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">routerSignatures</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nonce</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">originSender</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Within the <a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/BridgeFacet.sol#L411\"><code>BridgeFacet._executeSanityChecks</code></a> function, it will attempt to rebuild to <code>transferId</code> by calling the following code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Derive transfer ID based on given arguments.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">transferId</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getTransferId</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_args</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Within the <a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/BridgeFacet.sol#L719\"><code>BridgeFacet._getTransferId</code></a> function, we can see that the <code>s.tokenRegistry.getTokenId(_args.local)</code> will always return the canonical <code>tokenDomain</code> and <code>tokenId</code>. In our example, it will be <code>Ethereum</code> and  <code>USDC</code>. Therefore, as long as the attacker specify a valid local representation of canonical token on a chain, the <code>transferId</code> returned by <code>s.tokenRegistry.getTokenId(_args.local)</code> will always be the same across all domains. Thus, this allows the attacker to modify the <code>ExecuteArgs.local</code> and yet he could pass the router signature check.</p>\n<p>  <a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/BridgeFacet.sol#L719\">BridgeFacet.sol#L719</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_getTransferId</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ExecuteArgs</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_args</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenDomain</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenRegistry</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getTokenId</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">local</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_calculateTransferId</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">params</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nonce</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenDomain</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">originSender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Router liquidity would be drained by attacker, and affected router owner could not claim back their liquidity.</p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The security of the current Connext design depends on how secure or reliable the relayer is. If the relayer turns rouge or acts against Connext, many serious consequences can happen.</p>\n<p>The root cause is that the current design places enormous trust on the relayers to accurately and reliably to deliver calldata to the bridge in various domains. For instance, delivering of execute call data to <code>execute</code> function. There is an attempt to prevent message replay on a single domain, however, it does not prevent message replay across multiple domains. Most importantly, the Connext’s bridge appears to have full trust on the calldata delivered by the relayer. However, the fact is that the calldata can always be altered by the relayer.</p>\n<p>Consider a classic 0x off-chain ordering book protocol. A user will sign his order with his private key, and attach the signature to the order, and send the order (with signature) to the relayer network. If the relayer attempts to tamper the order message or signature, the decoded address will be different from the signer’s address and this will be detected by 0x’s Smart contract on-chain when processing the order. This ensures that the integrity of the message and signer can be enforced.</p>\n<p>Per good security practice, relayer network should always be considered as a hostile environment/network. Therefore, it is recommended that similar approach could be taken with regards to passing execute calldata across domains/chains.</p>\n<p>For instance, at a high level, the sequencer should sign the execute calldata with its private key, and attach the signature to the execute calldata. Then, submit the execute calldata (with signature) to the relayer network. When the bridge receives the execute calldata (with signature), it can verify if the decoded address matches the sequencer address to ensure that the calldata has not been altered. This will ensure the intergrity of the execute calldata and prevent any issue that arise due to unauthorised modification of calldata.</p>\n<p>Additionally, the execute calldata should also have a field that correspond to the destination domain. The bridge that receives the execute calldata must verify that the execute calldata is intended for its domain, otherwise reject the calldata if it belongs to other domains. This also helps to prevent the attack mentioned earlier where same execute calldata can be accepted in different domains.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/144#issuecomment-1166344934\">LayneHaber (Connext) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Agree that this is an issue, but disagree with the framing and mitigation.</p>\n<p>The <code>calldata</code> is included in the generation of the <code>transferId</code> via the <code>CallParams</code>, so it cannot be easily manipulated by the relayer network once signed by routers. However, because you are not validating the <code>s.domain</code> against the <code>CallParams.destinationDomain</code> you can use the same transfer data across multiple chains, which is a big problem.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/144#issuecomment-1167499043\">LayneHaber (Connext) resolved</a>:</strong></p>\n<blockquote>\n<p><a href=\"https://github.com/connext/nxtp/pull/1450/commits/bc241f8d9ca5ca7d9598c7b40affa9a416580cc6\">connext/nxtp@bc241f8</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/144#issuecomment-1214813364\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This seems like the most severe finding of the entire contest. Kudos to the warden on a great find!</p>\n<p>Because transfer data is replicated across multiple chains, relayers are also able to execute data on each chain. If <code>_executeSanityChecks</code> does not check that the message’s destination chain matches <code>s.domain</code>, then transfers could be spent on all available chains.</p>\n<p>Interestingly, because the remote router is included in the message, only the correct destination chain will be able to reconcile the transfer and reimburse routers for providing liquidity. Hence, the issue is only prevalent on other chains if routers readily bid on incoming transfers, which seems possible because signatures can be replayed on other chains. So if the same set of routers have sufficient liquidity on another chain, the relayer can execute this message again to create a double spend issue.</p>\n<p>Another point to add, this issue would only be prevalent on chains which have its local asset pointing to the same address as this is what the bridge will attempt to transfer to the recipient. Additionally, in order for the relayer to replay a router’s signature, the <code>transferId</code> must exactly match the <code>transferId</code> on the intended destination chain. This is only possible if <code>TokenRegistry.getTokenId</code> returns the same canonical domain and ID values.</p>\n<p>It would be good to confirm this. Is it possible for a local asset to be registered to the same canonical domain and ID on multiple chains?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/144#issuecomment-1218305324\">LayneHaber (Connext) commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p>Is it possible for a local asset to be registered to the same canonical domain and ID on multiple chains?</p>\n</blockquote>\n<p>Yes, that is actually the purpose of the <code>canonicalId</code> and <code>canonicalDomain</code> — there should only be one canonical (locked) token that maps to any number of local (minted) instances.</p>\n<p>This issue is valid, and enforcing in <code>_executeSanityChecks</code> it is only executed on the destination domain should prevent this attack, correct?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/144#issuecomment-1218349487\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Okay great! Because local assets map to the same canonical domain and ID on each chain, I think this issue is most definitely valid. <code>_args.local</code> is not used to calculate <code>transferId</code>, hence the representation for each asset may differ on each chain but the <code>TokenRegistry.getTokenId</code> should return the correct information.</p>\n<p>I can confirm that the enforcing check in <code>_executeSanityChecks</code> should ensure that transfer data is only executed on the intended destination domain.</p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-20\" style=\"position:relative;\"><a href=\"#medium-risk-findings-20\" aria-label=\"medium risk findings 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (20)</h1>\n<h2 id=\"m-01-relayer-will-not-receive-any-fee-if-execute-reverts\" style=\"position:relative;\"><a href=\"#m-01-relayer-will-not-receive-any-fee-if-execute-reverts\" aria-label=\"m 01 relayer will not receive any fee if execute reverts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/220\">[M-01] Relayer Will Not Receive Any Fee If <code>execute</code> Reverts</a></h2>\n<p><em>Submitted by xiaoming90</em></p>\n<p>Connext relies on the relayer to trigger the <code>BridgeFacet.execute</code> function on the destination domain to initiate the token transfer and calldata execution processes. Relayers pay for the gas cost to trigger the <code>execute</code> function, and in return for their effort, they are reimbused with the relayer fee.</p>\n<p>However, it is possible that the <code>BridgeFacet.execute</code> function will revert under certain circumstances when triggered by the relayers. For instance, when the  <a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/BridgeFacet.sol#L411\"><code>BridgeFacet.execute</code></a> function is triggered, it will call the <a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/BridgeFacet.sol#L757\"><code>BridgeFacet._handleExecuteLiquidity</code></a> function. Within the <a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/BridgeFacet.sol#L757\"><code>BridgeFacet._handleExecuteLiquidity</code></a> function, it will attempt to perform token swap using a StablePool. If the slippage during the swap exceeded the user-defined value, the swap will revert and subseqently the <code>execute</code> will revert too.</p>\n<p>When the <code>BridgeFacet.execute</code> reverts, the relayers will not receive any relayer fee.</p>\n<p>The following code shows that the relayer who can claim the relayer fee is set within the <code>BridgeFacet.execute</code> function at Line 415. Therefore, if this function reverts, relayer will not be able to claim the fee.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/BridgeFacet.sol#L415\">BridgeFacet.sol#L415</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">execute</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ExecuteArgs</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_args</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">whenNotPaused</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">transferId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reconciled</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">_executeSanityChecks</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_args</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Set the relayer for this transaction to allow for future claim</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">transferRelayer</span><span class=\"mtk1\">[</span><span class=\"mtk12\">transferId</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// execute router liquidity when this is a fast transfer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// asset will be adopted unless specified to be local in params</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">_handleExecuteLiquidity</span><span class=\"mtk1\">(</span><span class=\"mtk12\">transferId</span><span class=\"mtk1\">, !</span><span class=\"mtk12\">reconciled</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_args</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// execute the transaction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountWithSponsors</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_handleExecuteTransaction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_args</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">, </span><span class=\"mtk12\">transferId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">reconciled</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// emit event</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Executed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">transferId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_args</span><span class=\"mtk1\">, </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amountWithSponsors</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">transferId</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Loss of fund for the relayers as they pay for the gas cost to trigger the functions, but did not receive any relayer fee in return.</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Update the implementation of the <code>BridgeFacet.execute</code> so that it will fail gracefully and not revert when the swap fails or other functions fails. Relayers should be entitled to relayer fee regardless of the outcome of the <code>BridgeFacet.execute</code> call for their effort.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/220#issuecomment-1166664648\">jakekidd (Connext) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>It’s quite possible that the slippage changes while the relayer’s tx is in the mempool - which I think is the valid concern here. A relayer can’t know for a fact that another existing tx won’t change the current slippage (assuming there are multiple approved relayers).</p>\n<blockquote>\n<p>Relayers should be entitled to relayer fee regardless of the outcome of the BridgeFacet.execute call for their effort.</p>\n</blockquote>\n<p>Worth noting that the mitigation step here ^ is tricky — it can incentivize relayers to submit transactions that fail quickly to maximize profit. For example, if we pay relayers even in the event of failure when slippage is too high, they are incentivized to submit txs <em>when</em> the slippage is too high (because they will fail more cheaply, as opposed to fully executing). Relayers could potentially profit by pushing the slippage over a large user transfer’s limit via the stableswap themselves.</p>\n<p>I’m uncertain of whether I should acknowledge or dispute this issue because, while it is valid that relayers will lose funds in the case that the slippage changes while their tx is in the mempool, this may just be considered a core design property and a risk that relayers must factor into their executions.</p>\n<p>(Leaving as acknowledged for now.)</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/220#issuecomment-1171126890\">LayneHaber (Connext) commented</a>:</strong></p>\n<blockquote>\n<p>While not paying out for every relayed transaction (i.e. forcing relayers to incur/budget for some loss if the transaction fails) is a valid concern, and makes the system less appealing to relay for, I think it is the nature of relay networks to deal with these kinds of problems.</p>\n<p>For example, even without the slippage, imagine there are two networks competing to relay for the same transaction. In this case, execution would fail for the second relayer, and there would be no fees remaining to pay them for their efforts. If you want to continue adding fees for the same transaction, you would be passing this failure cost onto the user (with a more stringent liveness condition).</p>\n<p>This is a valid issue, but the fixes would introduce more complexity and edge cases than make sense to handle at this level.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/220#issuecomment-1214760944\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I’d say this is part of the risk of being a relayer but definitely worth noting so keeping it as is.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-diamond-upgrade-proposition-can-be-falsified\" style=\"position:relative;\"><a href=\"#m-02-diamond-upgrade-proposition-can-be-falsified\" aria-label=\"m 02 diamond upgrade proposition can be falsified permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/241\">[M-02] Diamond upgrade proposition can be falsified</a></h2>\n<p><em>Submitted by Czar102, also found by shenwilly</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/main/contracts/contracts/core/connext/facets/DiamondCutFacet.sol#L16-L29\">DiamondCutFacet.sol#L16-L29</a><br>\n<a href=\"https://github.com/code-423n4/2022-06-connext/blob/main/contracts/contracts/core/connext/libraries/LibDiamond.sol#L94-L118\">LibDiamond.sol#L94-L118</a><br>\n<a href=\"https://github.com/code-423n4/2022-06-connext/blob/main/contracts/contracts/core/connext/libraries/LibDiamond.sol#L222-L240\">LibDiamond.sol#L222-L240</a><br></p>\n<p>Diamond is to be upgraded after a certain delay to give time to the community to verify changes made by the developers. If the proposition can be falsified, the contract admins can exploit the contract in any way of their choice.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>To determine the id of the proposal, only its facet changes are hashed, skipping two critical pieces of data - the <code>_init</code> and <code>_calldata</code>. During a diamond upgrade, devs can choose what code will be executed <strong>by the contract using a delegatecall</strong>. Thus, they can make the contract perform <strong>any</strong> actions of their choice.</p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add <code>_init</code> and <code>_calldata</code> to the proposition hash.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/241#issuecomment-1166758437\">jakekidd (Connext) confirmed and resolved</a>:</strong></p>\n<blockquote>\n<p>Resolved by <a href=\"https://github.com/connext/nxtp/commit/63badc862f1aea54082c797cee08949a7bb95d9f\">connext/nxtp@63badc8</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/241#issuecomment-1202000786\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I consider this to be severe, however, it does require a malicious or compromised governance. Because of this, I would prefer to have this downgraded to <code>medium</code> severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-malicious-relayer-could-exploit-sponsor-vaults\" style=\"position:relative;\"><a href=\"#m-03-malicious-relayer-could-exploit-sponsor-vaults\" aria-label=\"m 03 malicious relayer could exploit sponsor vaults permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/234\">[M-03] Malicious relayer could exploit sponsor vaults</a></h2>\n<p><em>Submitted by 0x52, also found by csanuragjain</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/helpers/SponsorVault.sol#L234-L263\">SponsorVault.sol#L234-L263</a><br></p>\n<p>Sponsor vaults drained.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>reimburseRelayerFees</code> uses SponsorVault funds to repay users the fees they pay to relayers. A malicious relayer could create a large number of transactions with the max reimbursed relay fee specified in SponsorVault between chains for which they relay all of them. They would receive back the relay fee from the SponsorVault and they would also get the relay fee they paid themselves.</p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>I don’t see any way to mitigate this without substantial changes to the functionality of SponsorVault. Teams deploying SponsorVaults should be informed of potential misuse and set reimburse limits accordingly.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/234#issuecomment-1165737269\">LayneHaber (Connext) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>I’m not sure I agree with this as an issue — the relayers are whitelisted (to prevent generalized front-running, and limiting relayers to reliable relay networks).</p>\n<p>Usually any dusting systems like the <code>reimburseRelayerFees</code> do not have sybil resistance (unless you connect your socials or something similar), and this is something we will have to advertise to the people who create and fund the vault.</p>\n<p>NOTE: inspiration for this feature was taken from existing nomad dusting, which has the same potential shortcomings, see <a href=\"https://github.com/nomad-xyz/monorepo/blob/efc3f4ccf31dbcb4aa50cad197d469d511fafe86/packages/contracts-bridge/contracts/BridgeRouter.sol#L312-L326\">here</a>. Generally, chains have been willing to fund these vaults even with these drawbacks. That being said, balance checks could be added to add some slight guardrails!</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/234#issuecomment-1167489342\">LayneHaber (Connext) resolved</a>:</strong></p>\n<blockquote>\n<p><a href=\"https://github.com/connext/nxtp/pull/1450/commits/be9671c327166047e611c771c8c81c71fe19ccaf\">connext/nxtp@be9671c</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/234#issuecomment-1202008683\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I actually agree with the warden here. This type of attack would not be recognisable and could be disguised as general protocol activity. However, users’ funds are not at direct risk, but sponsors’ funds who intentionally give up these funds would be at risk of leaking value. Downgrading to <code>medium</code> risk.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-libdiamonddiamondcut-should-check-diamondstorageacceptancetimeskeccak256abiencode_diamondcut--0\" style=\"position:relative;\"><a href=\"#m-04-libdiamonddiamondcut-should-check-diamondstorageacceptancetimeskeccak256abiencode_diamondcut--0\" aria-label=\"m 04 libdiamonddiamondcut should check diamondstorageacceptancetimeskeccak256abiencode_diamondcut  0 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/215\">[M-04] <code>LibDiamond.diamondCut()</code> should check <code>diamondStorage().acceptanceTimes[keccak256(abi.encode(_diamondCut))] != 0</code></a></h2>\n<p><em>Submitted by GimelSec, also found by csanuragjain, Czar102, Lambda, minhquanym, and shenwilly</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/main/contracts/contracts/core/connext/libraries/LibDiamond.sol#L100-L103\">LibDiamond.sol#L100-L103</a><br>\n<a href=\"https://github.com/code-423n4/2022-06-connext/blob/main/contracts/contracts/core/connext/libraries/LibDiamond.sol#L71-L79\">LibDiamond.sol#L71-L79</a><br>\n<a href=\"https://github.com/code-423n4/2022-06-connext/blob/main/contracts/contracts/core/connext/libraries/LibDiamond.sol#L83-L90\">LibDiamond.sol#L83-L90</a><br></p>\n<p>Normally, <code>diamondStorage().acceptanceTimes[keccak256(abi.encode(_diamondCut))]</code> will be set in <code>LibDiamond.proposeDiamondCut()</code>. Then in <code>LibDiamond.diamondCut()</code>, it checks that <code>diamondStorage().acceptanceTimes[keccak256(abi.encode(_diamondCut))] &#x3C; block.timestamp</code>.</p>\n<p>However, <code>LibDiamond.rescindDiamondCut()</code> will set <code>diamondStorage().acceptanceTimes[keccak256(abi.encode(_diamondCut))]</code> to 0. Which can easily pass the check in <code>diamondCut()</code>. But <code>rescindDiamondCut</code> should rescind <code>_diamondCut</code>. In conclusion, using <code>rescindDiamondCut()</code> can easily bypass the delay time.</p>\n<p>Moreover, if <code>proposeDiamondCut()</code> has never been called, the check for delay time is always passed.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>diamondStorage().acceptanceTimes[keccak256(abi.encode(_diamondCut))]</code> will be set in <code>LibDiamond.proposeDiamondCut()</code><br>\n<a href=\"https://github.com/code-423n4/2022-06-connext/blob/main/contracts/contracts/core/connext/libraries/LibDiamond.sol#L71-L79\">LibDiamond.sol#L71-L79</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function proposeDiamondCut(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IDiamondCut.FacetCut[] memory _diamondCut,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _init,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes memory _calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 acceptance = block.timestamp + _delay;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    diamondStorage().acceptanceTimes[keccak256(abi.encode(_diamondCut))] = acceptance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    emit DiamondCutProposed(_diamondCut, _init, _calldata, acceptance);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>Then in <code>LibDiamond.diamondCut()</code>, it checks that <code>diamondStorage().acceptanceTimes[keccak256(abi.encode(_diamondCut))] &#x3C; block.timestamp</code><br>\n<a href=\"https://github.com/code-423n4/2022-06-connext/blob/main/contracts/contracts/core/connext/libraries/LibDiamond.sol#L100-L103\">LibDiamond.sol#L100-L103</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function diamondCut(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IDiamondCut.FacetCut[] memory _diamondCut,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _init,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes memory _calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      diamondStorage().acceptanceTimes[keccak256(abi.encode(_diamondCut))] &lt; block.timestamp,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      &quot;LibDiamond: delay not elapsed&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    …</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>However, <code>LibDiamond.rescindDiamondCut()</code> will set <code>diamondStorage().acceptanceTimes[keccak256(abi.encode(_diamondCut))]</code> to 0. Which can easily pass the check in <code>diamondCut()</code><br>\n<a href=\"https://github.com/code-423n4/2022-06-connext/blob/main/contracts/contracts/core/connext/libraries/LibDiamond.sol#L83-L90%3E\">LibDiamond.sol#L83-L90</a><br>\nfunction rescindDiamondCut(\nIDiamondCut.FacetCut[] memory <em>diamondCut,\naddress _init,\nbytes memory _calldata\n) internal {\ndiamondStorage().acceptanceTimes[keccak256(abi.encode(</em>diamondCut))] = 0;\nemit DiamondCutRescinded(_diamondCut, _init, _calldata);\n}</p>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">diamondStorage().acceptanceTimes[keccak256(abi.encode(_diamondCut))] = 0 &lt; block.timestamp</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add another check in <code>diamondCut</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function diamondCut(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IDiamondCut.FacetCut[] memory _diamondCut,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _init,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes memory _calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      diamondStorage().acceptanceTimes[keccak256(abi.encode(_diamondCut))] &lt; block.timestamp &amp;&amp; diamondStorage().acceptanceTimes[keccak256(abi.encode(_diamondCut))] != 0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      &quot;LibDiamond: delay not elapsed&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    …</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/215\">LayneHaber (Connext) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/215#issuecomment-1166765584\">jakekidd (Connext) resolved</a>:</strong></p>\n<blockquote>\n<p>Resolved by <a href=\"https://github.com/connext/nxtp/commit/cde1353c27e8c4deebc1c808a37a8b57884e3c43\">connext/nxtp@cde1353</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/215#issuecomment-1202010734\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I believe this issue to be valid but of <code>medium</code> severity as it requires a malicious or compromised governance. This issue would allow the protocol’s admin to propose and execute any arbitrary data within the same transaction.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-did-not-approve-to-zero-first-causing-certain-token-transfer-to-fail\" style=\"position:relative;\"><a href=\"#m-05-did-not-approve-to-zero-first-causing-certain-token-transfer-to-fail\" aria-label=\"m 05 did not approve to zero first causing certain token transfer to fail permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/154\">[M-05] Did Not Approve To Zero First Causing Certain Token Transfer To Fail</a></h2>\n<p><em>Submitted by xiaoming90, also found by 0xNineDec, hyh, Ruhum, and slywaters</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/BridgeFacet.sol#L984\">BridgeFacet.sol#L984</a><br>\n<a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/libraries/AssetLogic.sol#L347\">AssetLogic.sol#L347</a><br></p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof-of-Concept</h3>\n<p>Some tokens (like USDT) do not work when changing the allowance from an existing non-zero allowance value. For example Tether (USDT)‘s <code>approve()</code> function will revert if the current approval is not zero, to protect against front-running changes of approvals.</p>\n<h4 id=\"instance-1---bridgefacet_reconcileprocessportal\" style=\"position:relative;\"><a href=\"#instance-1---bridgefacet_reconcileprocessportal\" aria-label=\"instance 1   bridgefacet_reconcileprocessportal permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Instance 1 - <code>BridgeFacet._reconcileProcessPortal</code></h4>\n<p>The following function must be approved by zero first, and then the <code>SafeERC20.safeIncreaseAllowance</code> function can be called. Otherwise, the <code>_reconcileProcessPortal</code> function will revert everytime it handles such kind of tokens. Understood from the <a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/BridgeFacet.sol#L1025\">comment</a> that after the backUnbacked call there could be a remaining allowance.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/BridgeFacet.sol#L984\">BridgeFacet.sol#L984</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_reconcileProcessPortal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_local</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_router</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_transferId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  \t..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">SafeERC20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeIncreaseAllowance</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">adopted</span><span class=\"mtk1\">), </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">aavePool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">totalRepayAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">aavePool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">call</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSelector</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IAavePool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">backUnbacked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">, </span><span class=\"mtk12\">adopted</span><span class=\"mtk1\">, </span><span class=\"mtk12\">backUnbackedAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">portalFee</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  \t..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h4 id=\"instance-2---bridgefacet_swapassetout\" style=\"position:relative;\"><a href=\"#instance-2---bridgefacet_swapassetout\" aria-label=\"instance 2   bridgefacet_swapassetout permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Instance 2 - <code>BridgeFacet_swapAssetOut</code></h4>\n<p>The following fucntion must first be approved by zero, follow by the actual allowance to be approved. Otherwise, the <code>_swapAssetOut</code> function will revert everytime it handles such kind of tokens.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/libraries/AssetLogic.sol#L347\">AssetLogic.sol#L347</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_swapAssetOut</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_canonicalId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_assetIn</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_assetOut</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxIn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">AppStorage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">s</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">LibConnextStorage</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connextStorage</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Swap the asset to the proper local asset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">stableSwapPoolExist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_canonicalId</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// get internal swap pool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">SwapUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Swap</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ipool</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">swapStorages</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_canonicalId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// if internal swap pool exists</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenIndexIn</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getTokenIndexFromStableSwapPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_canonicalId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_assetIn</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenIndexOut</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getTokenIndexFromStableSwapPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_canonicalId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_assetOut</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// calculate slippage before performing swap</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// NOTE: this is less efficient then relying on the `swapInternalOut` revert, but makes it easier</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// to handle slippage failures (this can be called during reconcile, so must not fail)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_maxIn</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">ipool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">calculateSwapInv</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenIndexIn</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenIndexOut</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">success</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ipool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">swapInternalOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenIndexIn</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenIndexOut</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_maxIn</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// slippage is too high to perform swap: success = false, amountIn = 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Otherwise, swap via stable swap pool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">IStableSwap</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pool</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">adoptedToLocalPools</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_canonicalId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amountIn</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">calculateSwapOutFromAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_assetIn</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_assetOut</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_amountIn</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">_maxIn</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// set the success</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">success</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// perform the swap</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">SafeERC20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_assetIn</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_amountIn</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">swapExactOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_assetIn</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_assetOut</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_maxIn</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// slippage is too high to perform swap: success = false, amountIn = 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_assetOut</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h3 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Both the<code>_reconcileProcessPortal</code> and <code>_swapAssetOut</code> functions are called during repayment to Aave Portal if the fast-transfer was executed using portal liquidity. Thus, it is core part of the token transfer process within Connext, and failure of any of these functions would disrupt the AAVE repayment process.</p>\n<p>Since both functions affect the AAVE repayment process, I’m grouping them as one issue.</p>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>As Connext bridges/routers deal with all sort of tokens existed in various domains/chains, the protocol should try to implement measure to ensure that it is compatible with as much tokens as possible for future growth and availability of the protocol.</p>\n<h4 id=\"instance-1---bridgefacet_reconcileprocessportal-1\" style=\"position:relative;\"><a href=\"#instance-1---bridgefacet_reconcileprocessportal-1\" aria-label=\"instance 1   bridgefacet_reconcileprocessportal 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Instance 1 - <code>BridgeFacet._reconcileProcessPortal</code></h4>\n<p>It is recommended to set the allowance to zero before increasing the allowance</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">SafeERC20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_assetIn</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">SafeERC20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeIncreaseAllowance</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">adopted</span><span class=\"mtk1\">), </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">aavePool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">totalRepayAmount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h4 id=\"instance-2---bridgefacet_swapassetout-1\" style=\"position:relative;\"><a href=\"#instance-2---bridgefacet_swapassetout-1\" aria-label=\"instance 2   bridgefacet_swapassetout 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Instance 2 - <code>BridgeFacet_swapAssetOut</code></h4>\n<p>It is recommended to set the allowance to zero before each approve call.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">SafeERC20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_assetIn</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">SafeERC20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_assetIn</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_amountIn</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/154#issuecomment-1160594235\">ecmendenhall (Connext) commented</a>:</strong></p>\n<blockquote>\n<p>I gave this one a <img class=\"emoji-icon\" alt=\"emoji-heart\" data-icon=\"emoji-heart\" style=\"display: inline; margin: 0; margin-top: 1px; position: relative; top: 5px; width: 25px\" src=\"data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAMjUlEQVR4Ae2ZBZAkN7KGv5SqcebsBcOC2V4wO+yFY2Zm5jMeMzMzMzMzMzPD8pqZF4a6ukuVT4qp916Fojw100tHX8QfQxEj5Z+pTFU1/+W//Jf/aIQheBLs14I1AqcCywQWALmDK4B1OfwKWM9u4i+QrILT1As4zsAiAIXrFTYr/NnA74EJ5og8c25uLVI4w8JDRWSlAEGoAoAICuSqYzn8Efh4Bp8DphgCCyMKD7PwKAOrBJpxxvT/1wzGf3wKPgxcxyyRJzA7uvBYC680IotFFSmVkAEAHGXAieBU/5zDc4AfMjfuYeDVicgJRrVcrlgAII/WzEVQ1YscPA/4DPUgz2JmetDqwLusyONsEXgDOHDJEg4+7TQWLF9Od9EiNMsYu+wytp13Hlf95S9cf+WV9AEBHPS9XvI6eB2gzMCtIVkLLzLwggSsAM1GgwOXLWPx2rXMO/poRvzaNkkYv+IKtm3axOW//jVXb9lCXxUtjM9V3/E7eDqQMQNya26YA6F5FHysIfLgELwBDl25kpPPOYfD73IXun4j0mxSgABZv8+kN+KSH/+YdR/+MBf/4Q9kRXYGqh88D84GHBUsgtYofDTx6xlVWtZyxB3uwPGPexyH3OQmtBcswIigeQ6qSKOBsZap66/n4h/+kD+/5S3xeh9+HZwO6FBN8Lnw1obIU2zYjDGsOvNMTn3Oc+gcfDCD8XEG27ej/mve601vylpMq0Wy//40Fi4km5xk88c/zu9e9Sp2jI2hIiFLH9oCZ1WY0FxRmC2qzF+8mLUvfSnL7n1vTJqSXnUVgx07oN8H59CwljffdrskBx5Ie+lSnF/vj298I7/36mUZToRM9ZXAi6AaeR7VOLhvS+RLDVXa1nLzF7+Yk572NLKJCXqXXkp+9dU4Hzz/mw2vXASCwub8xho+iO4RR3DVb3/Lj33VXH3xxTC9qfcBZ1OwHuzx8LFE5GFGlYN9ld363e9moS/3CV/azmdYncNEWdNCGIOZN4/OkUfSPuww1r3//fz0mc9kajAgA+d1V+D7VCDPBWJSWNCFP7ZEjgwG3OSpT+VUn43Un+t082acz7wBRASKDQAIECpBAaeKimB9NYwefzw7fCA/eNSj2HbNNeTTzfF5wGsBcnhVU+T5JmTeH6vb+qOzn8/qhD/fmmVYEcQYBAjSkhFarOm8SBKa3vD9TjqJP73pTfzqFa9gkOcMYGMPVgMTsxqDLXh6Q+RNIfhlN785t/v0pwlZmPz735FeD7EWEZkWBXFWVMlVpw3pdLiR39QVP/85P/dmplmGwsDBmhxGE/iZBdNMEm7uN37wqlVM+uANYKJ1qtcDVUWdwwFtXzntFSv44aMfzZYf/IAM6MMZwAeJkOcDZbZCcyX8sQ0njrRa3OkTn+CA445j/He/I5+aIkkSDCAAcUlWbCwHwsaCCZ2jjmLTe97D+s99DgM4+KNA08BJCqzw5/24s86id8kliHOISLFW/Xo5xXqFCaN+Qm3zfeN7D3wgY2lKH37zC7glkM04BW4Gq1rw2wbY5be9Lbd4+9sZ//OfcddeWw5+xozEX4uLCoyMIN7Uda95DVds2EB5nocxd+Jzn4vkOUxNRevUrBcZ7pyDbpfR1av5tf+fm77/ffrQ81oL/J0SyU2BMgZWWbBNEQ659a1JL7+czMsYU5zv6g1A/e/z0DtGR1nhx5rxjeo63xcEWOAr4+jTT0cGA/KxMYxI/D/q1yuJPCcc2dQ360U3uxnn+2Ogqu1w5IgNsEAZC8d50fGZGlm0iPSCC9B+H7W2WGBuaGxCv0/SbrPSB7x9/XpQZT/fJG2jQX7ddQjVaO06kZwj9VNnZP58Oo0G4X5iYSVAnQGLvOj6sWIGA1LvpPVf1TkUyKNynMuGBVDAhUaaJMz3vQUgT1PCSBWR6qNUs45WVQGQhYrzZrd81U2EOGBxrQFASwBrDKFkNWzWOaSmJGWG4LWqgfX7hIsLFWZqIaGg8ufqxhs339yrYQwGEOgQkcTOCgwMIHlONjY2nf08J482KnMs0epN15hUv0Z14OWJMBgQYhEISmsNMDAhgGYZIUOS5xBUYOoroJo4i0Oe9ap1NVJOoVABRSwGgsaJSAzEXEZxTsO11zQakGUASKkHSE22ZI5VILUVUk0O1aOwuCH2fRwuTQFQuJyIpGIjWwAGPvs9P/utv5JqmiKAAwSiGT1ctmN0+L9Vlz+ACD1/9Q4TAEBgU+0RUNgIuCzP7fhFFxHGSB4aFmAKaUWge5K6u0ZV+QPkjQbjF16IU0UhpcoAIvqwvgmXAofvPPdc5vuHi4a1uCyjjJSkgNQ3tuGCHiJ4B2izSd/fK3aedx7F385LYTMRSQox48AvVeTwqfFxtq1bx4EnnIA6h3gBKMzqqio1Acnsg62/apdNsJaw3+v/9jdCD1ARVPVnIzBJRDICxGTw9Rwehgg7vIOJCPOPOQZUyUNHzXN0yGCGGnOzrQBj0CRBs4xtGzey0x9hRCiq4mtUkLjqf/6DTPWyXGRprsrOrVtR30xGjzySzrx5YAw4R57nSFB0Q6TiuX3oUVdz4cGYaVlLHm6uvuzHzj+fsR07yIFMBKe61cIvqUDeQDUW3twReVoX6KiSAA2g0+nQXriQln/RkfjvbbOJFO/ppFBF0NW/GybjxhAk4asqrt8nm5oi9QGHqdXr9egDGTAlwiTQU30p8DIqkLdQjYOVbfhTV6TbAVpAszDCFgrNsTEygh0dpeEl7TY2SaY3qAoAwZTi65wQQb0wBgAVIZgbmrH6IMM7Sec1mJhg4BwZkAODIBF6wFSQ6o4enAxcRAXyRm6YBD7cFXlMB2gDzUL/Z4IqAphCFggmNLpdjP8qrRYSKsQYTDCm9AFKJaoAiAi5c2hQv4+mKXm40AT5bDtV8lLjcyI4IAP6hXrAZJDq24CnQjWJ5YZJ4Q1N1QdlIl0HpUULRCgbgCqEG6SXAApYEYo3uEiSEESRWREBQFWheLmqWUZQuHuIc4RgJXrKMyIwwxU4AwZAprrNQVTklU2wGgsbB/DOBJ7dAJLSnDWFiA2JP8FRRYqgKrp+bb+wRReXmjHoCmUlDeCNSVz6EUnCzDh43UD1AZnIkRlgAVNyu2yCqQgAEYRqTP34q5woOUD84FMyocj+hu3wdmpItlPL9fPgWX34ogWS6ChEJlRejKRmEtS9S5CqzEeBR6XvMnjKAhinhmQBs+JLfdXwwcWjEooqKH3Vkqi9Hc4eBST6GisvZ7342oe3Gfgh1JMYZkceqkD1ponIMgsEZYCpqIIyMsfApTrzldl3hcoTIFX9y7XwEmZJci2z5poD4PRU9ftWpFVkH1dtwh67CMWBu3LmVScG8Li49Ic/AhE5/DyDZw/gbRYohJRMkKhsZfYmVFZPPOI0qCr4aT3Rwl+YA4llbuTw9lT1FCPymLIBDpBIuptelMTnPQPii89A9R0N+ChzJGkwdwbw5FT1GCtyi3IFlL8WIgfKJsssq0AAR/WzfhZlPlX97uXwbIYguZyhGF8MD++p/siIHFO+DZaN0Nm+4q7PfJz9cvDrJuDR86DHECTzGI4puHgEHpyqfs+KLCwHXzH7qy9J1L/ZdSVVZP6KHjywAVcxJEmD4enDnxQeIapfFpF2ZEB1c6z5mBsgjxQHHjSlOjaABzVhIwxP0mSX+U4KZxrVj4qIESAWda/RayogLn0f/KAPjwJ+wS6SKLuFT/TgIANvjIOPMYBA9QNOHHRJfaAHpNN6osBX2A0kwm7jTT4zB4nIsyv7wAyvzCofbCrKPp3O/osE3g/wz2YAp8NzP6y6v4icVd3owAJa9WFo1RNdKfBekOqbBV7JbkQ+xO7lEkgOg092RR7UBoKSkmxQlQFx6Zcb3nTwHwJOZzeTGHYvh0O2DR4jqqOI3A2gWdHgTGRAdccvzr3q5/twDnuApM/uZwSmtsPDUf0qIrfSKNMWMFXnP57z05n/zjXwWGDAHkDewJ5jHhxs4RtdkdXxC1VLiaj8Sw3vFz24F7CNPYS8mz2LgyUj8O22yMktoFGqgCCizt8v1FP93STcDbiOPYi8k73C4V34Vkvk+CaQVPQAVygF+qp/moK7A1eyh5F3sXewsKwB32yKLE+AIAGI577qP6bgbsAlAP82BgAksNLCdxORwy1gYgNUt/TgjvGnOP/aRyDCwgkNCE+QS6R8BFTPd9PBn8deRN7H3kdhlcDXrchigFz1ohzuCmxgLyPvZd+QwU0MfAdIgTsAf2cfIO9m39GHOxnoAT9jHyFv5z8bw384/zWA/3D+B/WylZ+wja1PAAAAAElFTkSuQmCC\" title=\"emoji-heart\" /> for noting the special case of USDT. Since USDT’s <code>approve</code> reverts if current allowance is nonzero, even calls to <code>safeIncreaseAllowance</code> must be zeroed first. Many related findings identify the same issue but recommend using <code>safeIncreaseAllowance</code> only, which would still fail in the case of USDT. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/154\">jakekidd (Connext) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/154#issuecomment-1166390227\">LayneHaber (Connext) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>This should be higher severity as the funds could get stuck.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/154#issuecomment-1166742753\">jakekidd (Connext) resolved</a>:</strong></p>\n<blockquote>\n<p>Fixed by <a href=\"https://github.com/connext/nxtp/commit/f9819759c3915a1470a941c1b38a7d415c0dc2aa\">https://github.com/connext/nxtp/commit/f9819759c3915a1470a941c1b38a7d415c0dc2aa</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/154#issuecomment-1213464481\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I’m actually going to disagree with the request to raise the severity of this issue because of a few main reasons:</p>\n<ul>\n<li>In instance 1, the implementation for <code>executeBackUnbacked</code> transfers exactly <code>backUnbackedAmount + portalFee</code> which is equal to <code>totalRepayAmount</code>. Hence, the approval is always fully utilised unless the Aave pool contract fails to execute as intended.</li>\n<li>In instance 2, <code>_swapAssetOut</code> explicitly approves <code>_amountIn</code> which is determined by <code>_calculateSwapInv</code>. This same function is also used to actually perform the swap, hence, this value will remain the same unless the user is able to make state changes in between these calls. It does not look like this is possible unless <code>safeApprove</code> gives the user control over contract execution.</li>\n</ul>\n<p>I think based on this, it is safe to say that certain assumptions about the behaviour of these contracts must be broken in order for funds to be at risk. Due to this, I think <code>medium</code> severity makes more sense.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-_handleexecutetransaction-may-not-working-correctly-on-fee-on-transfer-tokens-moreover-if-it-is-failed-fund-may-be-locked-forever\" style=\"position:relative;\"><a href=\"#m-06-_handleexecutetransaction-may-not-working-correctly-on-fee-on-transfer-tokens-moreover-if-it-is-failed-fund-may-be-locked-forever\" aria-label=\"m 06 _handleexecutetransaction may not working correctly on fee on transfer tokens moreover if it is failed fund may be locked forever permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/196\">[M-06] _<code>handleExecuteTransaction</code> may not working correctly on fee-on-transfer tokens. Moreover, if it is failed, fund may be locked forever.</a></h2>\n<p><em>Submitted by Chom, also found by csanuragjain</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/BridgeFacet.sol#L856-L877\">BridgeFacet.sol#L856-L877</a><br>\n<a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/helpers/Executor.sol#L142-L144\">Executor.sol#L142-L144</a><br>\n<a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/helpers/Executor.sol#L160-L166\">Executor.sol#L160-L166</a><br>\n<a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/helpers/Executor.sol#L194-L213\">Executor.sol#L194-L213</a><br></p>\n<p><code>_handleExecuteTransaction</code> may not working correctly on fee-on-transfer tokens. As duplicated fee is applied to fee on transfer token when executing a arbitrary call message passing request. Moreover, the Executor contract increase allowance on that token for that target contract in <strong>full amount without any fee</strong>, this may open a vulnerability to steal dust fund in the contract</p>\n<p>Moreover, failure is trying to send <strong>full amount without any fee</strong> which is not possible because fee is already applied one time for example 100 Safemoon -> 90 Safemoon but trying to transfer 100 safemoon to <code>_recovery address</code>. Obviously not possible since we only have 90 Safemoon. This will revert and always revert causing loss of fund in all case of fee-on-transfer tokens.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>A message to transfer 100 Safemoon with some contract call payload has been submitted by a relayer to <code>_handleExecuteTransaction</code> function on BridgeFacet these lines hit.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">      // execute calldata w/funds</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      AssetLogic.transferAssetFromContract(_asset, address(s.executor), _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      (bool success, bytes memory returnData) = s.executor.execute(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IExecutor.ExecutorArgs(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          _transferId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          _amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          _args.params.to,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          _args.params.recovery,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          _asset,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          _reconciled</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            ? LibCrossDomainProperty.formatDomainAndSenderBytes(_args.params.originDomain, _args.originSender)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            : LibCrossDomainProperty.EMPTY_BYTES,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          _args.params.callData</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      );</span></span></code></pre>\n<p>Noticed that 100 Safemoon is transferred to executor before contract execution. Now executor has 90 Safemoon due to 10% fee on transfer.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (!isNative) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      SafeERC20Upgradeable.safeIncreaseAllowance(IERC20Upgradeable(_args.assetId), _args.to, _args.amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>Next, we increase allowance of target contract to transfer 100 more Safemoon.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Try to execute the callData</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // the low level call will return `false` if its execution reverts</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (success, returnData) = ExcessivelySafeCall.excessivelySafeCall(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _args.to,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      gas,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      isNative ? _args.amount : 0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      MAX_COPY,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _args.callData</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span></code></pre>\n<p>After that, it call target contract</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Try to execute the callData</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // the low level call will return `false` if its execution reverts</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (success, returnData) = ExcessivelySafeCall.excessivelySafeCall(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _args.to,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      gas,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      isNative ? _args.amount : 0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      MAX_COPY,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _args.callData</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span></code></pre>\n<p>Target contract tried to pull 100 Safemoon from Executor but now Executor only has 90 Safemoon, so contract call failed. Moving on to the failure handle.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function _handleFailure(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bool isNative,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bool hasIncreased,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _assetId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address payable _to,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address payable _recovery,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) private {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (!isNative) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Decrease allowance</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      if (hasIncreased) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        SafeERC20Upgradeable.safeDecreaseAllowance(IERC20Upgradeable(_assetId), _to, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Transfer funds</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      SafeERC20Upgradeable.safeTransfer(IERC20Upgradeable(_assetId), _recovery, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Transfer funds</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      AddressUpgradeable.sendValue(_recovery, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>isNative = false because of Safemoon</p>\n<p>Trying to transfer 100 Safemoon to _recovery while only having 90 Safemoon in the contract. Thus failure handle is reverted.</p>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>You should approve one step only. Avoid an extra token transfer.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/196#issuecomment-1166340894\">LayneHaber (Connext) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Not sure I agree with the mitigation (perhaps a better alternative would be to transfer the balance of the executor), but understand the problems!</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/196#issuecomment-1166624673\">LayneHaber (Connext) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Upon further reflection, choosing to remove support for fee on transfer tokens. The problems are much deeper than just issues on <code>execute</code> — the minted token will <em>not</em> have fees on transfers (uses vanilla ERC20 implementation), and i doubt the <code>StableSwap</code> implementations are taking these into account as well. Changing label to “acknowledged”!</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/196#issuecomment-1167496442\">LayneHaber (Connext) resolved</a>:</strong></p>\n<blockquote>\n<p>error on fee: <a href=\"https://github.com/connext/nxtp/pull/1450/commits/14df4c66f6be3b22133f7c70add28b94f9865537\">connext/nxtp@14df4c6</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/196#issuecomment-1213567388\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The destination chain will indeed be unable to handle bridge transfers involving fee-on-transfer tokens. Although, its worth adding that this is only made possible because <code>handleIncomingAsset</code> and <code>swapToLocalAssetIfNeeded</code> in <code>xcall</code> do not fail when the provided asset has some fee-on-transfer behaviour.</p>\n<p>Because <code>_args.amount</code> is not overridden with the actual <code>amount</code> transferred in from <code>handleIncomingAsset</code>, routers on the destination chain will attempt to provide liquidity for the amount transferred by the user + the fee. Furthermore, when the transfer has been fully bridged, routers who fronted the liquidity will receive less funds than expected. However, I don’t actually think this issue warrants <code>high</code> severity, mainly because the bridge transfer should actually execute successfully.</p>\n<p>The only issue is that if routers front liquidity, they are exposing themselves to receiving slightly less funds due to the fee upon reconciliation. Hence, only value is being leaked and I think <code>medium</code> severity makes more sense.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-current-implementation-of-arbitrary-call-execute-failure-handler-may-break-some-use-case-for-example-nft-bridge\" style=\"position:relative;\"><a href=\"#m-07-current-implementation-of-arbitrary-call-execute-failure-handler-may-break-some-use-case-for-example-nft-bridge\" aria-label=\"m 07 current implementation of arbitrary call execute failure handler may break some use case for example nft bridge permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/223\">[M-07] Current implementation of arbitrary call execute failure handler may break some use case for example NFT bridge.</a></h2>\n<p><em>Submitted by Chom</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/helpers/Executor.sol#L113-L192\">Executor.sol#L113-L192</a><br>\n<a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/helpers/Executor.sol#L194-L213\">Executor.sol#L194-L213</a><br></p>\n<p>Current implementation of arbitrary call execute failure handler may break some use case for example NFT Bridge.</p>\n<p>In the case of NFT Bridge, NFT may be lost forever.</p>\n<p>This is likely to be happened in the case of out of gas.</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Relayer receive the message to unlock BAYC on ETH chain. Relayer call execute on BridgeFacet which then call execute in Executor internally. Continue to these lines:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Ensure there is enough gas to handle failures</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 gas = gasleft() - FAILURE_GAS;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Try to execute the callData</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // the low level call will return `false` if its execution reverts</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (success, returnData) = ExcessivelySafeCall.excessivelySafeCall(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _args.to,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      gas,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      isNative ? _args.amount : 0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      MAX_COPY,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _args.callData</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Unset properties</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    properties = LibCrossDomainProperty.EMPTY_BYTES;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Unset amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    amnt = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Handle failure cases</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (!success) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _handleFailure(isNative, true, _args.assetId, payable(_args.to), payable(_args.recovery), _args.amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>Unfortunately, an enormous NFT project has just started minting their NFT when the relayer perform the execution. Causing gas price to increase by 20x.</p>\n<p>As a result, gasLimit is 20x lesser than what we have calculated causing ExcessivelySafeCall.excessivelySafeCall to fail because of out of gas. We fall into _handleFailure function. <strong>Notice that NFT is not unlocked yet because target contract has failed to being executed.</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function _handleFailure(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bool isNative,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bool hasIncreased,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _assetId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address payable _to,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address payable _recovery,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) private {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (!isNative) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Decrease allowance</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      if (hasIncreased) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        SafeERC20Upgradeable.safeDecreaseAllowance(IERC20Upgradeable(_assetId), _to, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Transfer funds</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      SafeERC20Upgradeable.safeTransfer(IERC20Upgradeable(_assetId), _recovery, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Transfer funds</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      AddressUpgradeable.sendValue(_recovery, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p><code>_handleFailure</code> just sent dummy fund in the NFT bridge process to the useless fallback address (Useless in NFT bridge case as it doesn’t involve any cross chain swapping / token transferring).</p>\n<p>Finally, transferId will be marked as used (or reconciled). This transferId cannot be used anymore.</p>\n<p><strong>Recall that BAYC hasn’t been unlocked yet as target contract has failed to being executed.</strong></p>\n<p><strong>And we cannot reuse this transferId to retry anymore in the future as it is marked as used</strong></p>\n<p><strong>As a result, BAYC is locked forever as target contract call never success anymore since transferId has been marked as used</strong></p>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>You should mix axelar style and connext style of error handling together.</p>\n<p>Fund shouldn’t be sent to fallback address immediately. Instead, leave an option for user to choose whether they want to recall the failed transaction manually or they want to transfer the fund to the fallback address.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/223#issuecomment-1167462428\">LayneHaber (Connext) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Acknowledge that this should be an issue, but think that the UX of having to submit multiple destination chain transactions is not great (and causes problems with fees / assuming the user has gas on the destination domain). I think this type of thing needs to be handled by the integrator themselves</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/223#issuecomment-1211520594\">Chom (warden) commented</a>:</strong></p>\n<blockquote>\n<p>I have reviewed this once again and found another case that current implementation of arbitrary call execute failure handler may break some use case for example NFT bridge.</p>\n<p>The idea for this to happen is simply do anything to set <code>success</code> to false. If NFT is failed to mint on the destination chain and  revert (Likely due to bug in the contract), it cause the same consequence.</p>\n<p>It would be better to revert and allow it to be executed again in the future by <strong>simply revert in case of arbitrary call failed</strong>. If the destination contract is upgradable, it can be fixed but if not it is out of luck. But current implementation is out of luck in all case.</p>\n<p>Anyway, the sudden gas price increase problem can’t be handled accurately as its may happened very fast. (5 gwei 2 minutes ago, 50 gwei when the NFT unlock as a big NFT project is minting). No one will spare that much gas while locking NFT in the source chain 2 minutes ago.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/223#issuecomment-1213575364\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Gas limit does not change deterministically. If you make a call which provides X amount of gas at Y price, if gas price changes, it will not affect any pending calls. The issue only arises if the relayer intentionally provides insufficient gas at any price.</p>\n<p>The recovery address is configured when the bridge transfer is initiated, if this or the executed calldata fails to be used correctly, I think the onus is on the sender. However, there are some legitimate concerns of a bridge relayer intentionally making the callback fail. Because funds aren’t at direct risk, <code>medium</code> severity would make more sense.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/223#issuecomment-1217478867\">Chom (warden) commented</a>:</strong></p>\n<blockquote>\n<p>The recovery address only recover ERC20 tokens managed by the Connext bridge system. Other custom made bridging solution that utilize the arbitrary message passing never utilize that recovery address passed.</p>\n<h3 id=\"example\" style=\"position:relative;\"><a href=\"#example\" aria-label=\"example permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example</h3>\n<p>For example, if A lock “multiple BAYC NFT” on the Ethereum chain along with 1 WETH sent into Connext Amarok. On the destination chain, if executed calldata fails or gas limit is miscalculated (both intentionally and non-intentionally in case ether.js returns too low gas limit, it has happened many times on the complex contracts in 2021 not sure it is fixed or not), only 1 WETH is sent to the recovery address and not “multiple BAYC NFT”. “Multiple BAYC NFT” will be locked on the Ethereum chain indefinitely without any chance to unlock or recovery it in the source chain. So, funds which are “multiple BAYC NFT” are at direct risk. BAYC floor price is currently more than 70 ETH. If 3 BAYC lost due to a single error, total 200+ ETH will be lost.</p>\n<p>Here is an example case that might become common if NFT is not out of hyped but sadly the hype in NFT is currently down. It is “NFT buying frontrunning” problem.</p>\n<p><img src=\"https://user-images.githubusercontent.com/4103490/185040980-5564fa35-00ac-4d00-8d0a-19532f81d658.png\" alt=\"NFT buying frontrunning case\"></p>\n<p>Since Connext bridge requires 2-3 minutes between that times somebody may frontrun buying NFT without using bridge. Then the execution will be fail since NFT has been sold to buyer B. It only refund 10 ETH but not 3 NFT sent.</p>\n<h3 id=\"mitigation\" style=\"position:relative;\"><a href=\"#mitigation\" aria-label=\"mitigation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation</h3>\n<ol>\n<li>Simply revert in case of arbitrary call failed.</li>\n<li>Provide a way for user to cancel the execution, get ERC20 refund into the recovery address and acknowledge contract in the source chain that the bridge is failed to claim back NFT.</li>\n<li>Force all developers that are using your product to use Upgradeable contract on both source and destination chain to handle cases manually in case something went wrong (Not possible to force everyone).</li>\n</ol>\n<p>Perfect mitigation is not found yet. There is an ongoing debate about this one at <a href=\"https://github.com/code-423n4/2022-07-axelar-findings/issues/97\">code-423n4/2022-07-axelar-findings#97</a>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/223#issuecomment-1217788548\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Fully agree with your take on this. But I still stand by my decision on keeping this as a <code>medium</code> risk issue. Mainly because funds are not at direct risk and when they are at risk, certain assumptions must be made for this to hold true. Again, the onus seems to be on the implementer’s end.</p>\n<p>The important thing is to not integrate with Connext with the guarantee that calldata will be successfully executed on the destination contract. This should be clearly documented and I think allowing the bridge user to re-execute calldata upon failure is a potentially useful suggestion, but this doesn’t come with its pitfalls too. Added complexity could expand Connext’s attack surface. </p>\n<p>In response to your proposed mitigation(s):</p>\n<ol>\n<li>This would impact the liveness of bridge transfers. We do not want to allow funds to get stuck due to a reliance on external requirements.</li>\n<li>While this is a potential solution, I don’t think Connext needs to make changes to accommodate this behaviour. The destination contract can check if the calldata was successfully executed and handle this on their end. Seaport already allows for custom behaviour.</li>\n<li>Again, this would not require Connext to make any changes.</li>\n</ol>\n</blockquote>\n<hr>\n<h2 id=\"m-08-malicious-relayer-could-cause-a-router-to-provide-more-liquidity-than-it-should\" style=\"position:relative;\"><a href=\"#m-08-malicious-relayer-could-cause-a-router-to-provide-more-liquidity-than-it-should\" aria-label=\"m 08 malicious relayer could cause a router to provide more liquidity than it should permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/149\">[M-08] Malicious Relayer Could Cause A Router To Provide More Liquidity Than It Should</a></h2>\n<p><em>Submitted by xiaoming90</em></p>\n<p>Assume this is a fast-transfer path and the sequencer has a good reason (e.g. some sophisticated liquidity load balancing algorithm) to assign 3 routers to provide liquidity for a transfer of <code>90 DAI</code></p>\n<p>Therefore, each of them will provide <code>30 DAI</code> equally.</p>\n<blockquote>\n<p>_args.routers[] array = [Router A, Router B, Router C]</p>\n</blockquote>\n<p>However, a malicious relayer could rearrange the <code>_args.routers[] array</code> to any of the following and still pass the sanity checks within <a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/BridgeFacet.sol#L636\"><code>BridgeFacet._executeSanityChecks</code></a></p>\n<blockquote>\n<p>_args.routers[] array = [Router A, Router A, Router A]</p>\n<p>_args.routers[] array = [Router A, Router A, Router B]</p>\n<p>_args.routers[] array = [Router A, Router A, Router C]</p>\n<p>_args.routers[] array = [Router C, Router A, Router C]</p>\n</blockquote>\n<p>The point is that as long as the attacker ensures that the <code>pathLength</code> is correct, he will be able to pass the router check within <a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/BridgeFacet.sol#L636\"><code>BridgeFacet._executeSanityChecks</code></a>.</p>\n<p>Assume that malicious relayer decided to rearrange the <code>_args.routers[] array</code> to as follows, this will cause Router A to provide more liquidity than it should be and overwrite the sequencer decision. In this case, Router A will be forced to provide <code>90 DAI</code>.</p>\n<blockquote>\n<p>_args.routers[] array = [Router A, Router A, Router A]</p>\n</blockquote>\n<p>This is possible because the <code>routerHash</code> used to generate the router signature only consists of two items (<code>transferId</code> and <code>pathLength</code>)</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/BridgeFacet.sol#L636\">BridgeFacet.sol#L636</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_executeSanityChecks</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ExecuteArgs</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_args</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Derive transfer ID based on given arguments.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">transferId</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getTransferId</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_args</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Retrieve the reconciled record. If the transfer is `forceSlow` then it must be reconciled first</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// before it&#39;s executed.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reconciled</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">reconciledTransfers</span><span class=\"mtk1\">[</span><span class=\"mtk12\">transferId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">forceSlow</span><span class=\"mtk1\"> &amp;&amp; !</span><span class=\"mtk12\">reconciled</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BridgeFacet__execute_notReconciled</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Hash the payload for which each router should have produced a signature.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Each router should have signed the `transferId` (which implicitly signs call params,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// amount, and tokenId) as well as the `pathLength`, or the number of routers with which</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// they are splitting liquidity provision.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">routerHash</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">transferId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pathLength</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// check the reconciled status is correct</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// (i.e. if there are routers provided, the transfer must *not* be reconciled)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">pathLength</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk3\">// make sure routers are all approved if needed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">reconciled</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BridgeFacet__execute_alreadyReconciled</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">pathLength</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Make sure the router is approved, if applicable.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// If router ownership is renounced (_RouterOwnershipRenounced() is true), then the router whitelist</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// no longer applies and we can skip this approval step.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk11\">_isRouterOwnershipRenounced</span><span class=\"mtk1\">() &amp;&amp; !</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerPermissionInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">approvedRouters</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routers</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BridgeFacet__execute_notSupportedRouter</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Validate the signature. We&#39;ll recover the signer&#39;s address using the expected payload and basic ECDSA</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// signature scheme recovery. The address for each signature must match the router&#39;s address.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routers</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] != </span><span class=\"mtk11\">_recoverSignature</span><span class=\"mtk1\">(</span><span class=\"mtk12\">routerHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerSignatures</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">])) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BridgeFacet__execute_invalidRouterSignature</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h3 id=\"impact-5\" style=\"position:relative;\"><a href=\"#impact-5\" aria-label=\"impact 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Malicious relayer could overwrite sequencer decision, or cause a certain router to drain more liquidity than it should be.</p>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Generate the <code>routerHash</code> with the following items should help to prevent this attack:</p>\n<ul>\n<li>transferId</li>\n<li>pathLength</li>\n<li>_args.routers[] array</li>\n</ul>\n<p>In this case, if the attacker attempts to re-arrange the  <code>_args.routers[] array</code>, the <code>routerHash</code> generate on the bridge will be different. Thus, it will fail the router signature verification within <code>_executeSanityChecks</code> function and it will revert.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/149\">jakekidd (Connext) disagreed with severity</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/149#issuecomment-1166153128\">jakekidd (Connext) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>The relayer doing this would actually not be an attack on the router providing liquidity; it would actually benefit that router, giving it the full bulk of the transfer - assuming the router can afford it - as that router will claims fees for the whole thing. However, it would grief other routers from getting access to this transfer in the process. This isn’t great, but keep in mind relayers are currently a permissioned role (whitelisted) because the trust vectors there have not been abstracted entirely (among other reasons). <del>As such, I am suggesting we de-escalate this issue to QA/Low Risk.</del></p>\n<p>Additionally, the suggested mitigation step is invalid within current design - <code>routerHash</code> for the router’s signature is generated prior to knowing which routers will be selected by sequencer. The only way to prevent this would be to check to make sure there are no duplicates in the routers array manually (which would incur not-so-great gas costs). Acknowledging the issue as we may want to implement that fix in the future.</p>\n<p>EDIT: Removed disagree with severity tag. Seems appropriate in hindsight as it would be subverting the functionality of the protocol.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/149#issuecomment-1214244176\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I agree with the validity of this finding. Keeping it as is.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-09-malicious-relayers-could-favor-their-routers\" style=\"position:relative;\"><a href=\"#m-09-malicious-relayers-could-favor-their-routers\" aria-label=\"m 09 malicious relayers could favor their routers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/147\">[M-09] Malicious Relayers Could Favor Their Routers</a></h2>\n<p><em>Submitted by xiaoming90, also found by csanuragjain</em></p>\n<p>Assume that a malicious relayer operates a router in Connext providing fast-liquidity service. A malicious relayer could always swap the router(s) within the execute calldata with the router(s) owned by malicious relayer, and submit it to the chain for execution.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof-of-Concept</h3>\n<p>This example assumes a fast-liquidity path. When the relayer posts a execute calldata to destination domain’s <code>BridgeFacet.execute</code> function, this function will trigger the <code>BridgeFacet._executeSanityChecks</code> function to perform a sanity check.</p>\n<p>Assume that the execute calldata only have 1 router selected. A malicious relayer could perform the following actions:</p>\n<ol>\n<li>Attacker removes original router from <code>_args.routers[]</code> array, and remove original router’s signature from <code>_args.routerSignatures[]</code> array from the execute calldata.</li>\n<li>Attacker re-calculates the routerHash (<code>routerHash = keccak256(abi.encode(transferId, pathLength))</code>). pathLength = 1 in this example</li>\n<li>Attacker signs the routerHash with his own router’s private key to obtain the router signature</li>\n<li>Attacker inserts his router to the <code>_args.routers[]</code> array, and insert the router signature obtained fromthe previous step to <code>_args.routerSignatures[]</code> array</li>\n<li>Submit the modified execute calldata to destination domain’s <code>BridgeFacet.execute</code> function, and it will pass the <code>BridgeFacet._executeSanityChecks</code> function since router signature is valid.</li>\n</ol>\n<p>The <code>BridgeFacet._executeSanityChecks</code> function is not aware of the fact that the router within the execute calldata has been changed because it will only check if the router specified within the  <code>_args.routers[]</code> array matches with the router signature provided. Once the sanity check passes, it will store the attacker’s router within <code>s.routedTransfers[_transferId]</code> and proceed with providing fast-liquidity service for the users.</p>\n<p>The existing mechanism is useful in preventing malicious relayer from specifying routers belonging to someone else because the malicious relayer would not be capable of generating a valid router signature on behalf of other routers because he does not own their private key. However, this mechanism does not guard against a malicious relayer from specifying their own router because in this case they would be able to generate a valid router signature as they own the private key.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/BridgeFacet.sol#L636\">BridgeFacet.sol#L636</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">   * </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> Performs some sanity checks for </span><span class=\"mtk8\">`execute`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">   * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\"> Need this to prevent stack too deep</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">   */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_executeSanityChecks</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ExecuteArgs</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_args</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// If the sender is not approved relayer, revert</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">approvedRelayers</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] &amp;&amp; </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">_args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">agent</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BridgeFacet__execute_unapprovedSender</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Path length refers to the number of facilitating routers. A transfer is considered &#39;multipath&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// if multiple routers provide liquidity (in even &#39;shares&#39;) for it.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pathLength</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Make sure number of routers is below the configured maximum.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">pathLength</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maxRoutersPerTransfer</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BridgeFacet__execute_maxRoutersExceeded</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Derive transfer ID based on given arguments.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">transferId</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getTransferId</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_args</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Retrieve the reconciled record. If the transfer is `forceSlow` then it must be reconciled first</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// before it&#39;s executed.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reconciled</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">reconciledTransfers</span><span class=\"mtk1\">[</span><span class=\"mtk12\">transferId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">forceSlow</span><span class=\"mtk1\"> &amp;&amp; !</span><span class=\"mtk12\">reconciled</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BridgeFacet__execute_notReconciled</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Hash the payload for which each router should have produced a signature.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Each router should have signed the `transferId` (which implicitly signs call params,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// amount, and tokenId) as well as the `pathLength`, or the number of routers with which</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// they are splitting liquidity provision.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">routerHash</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">transferId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pathLength</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// check the reconciled status is correct</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// (i.e. if there are routers provided, the transfer must *not* be reconciled)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">pathLength</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk3\">// make sure routers are all approved if needed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">reconciled</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BridgeFacet__execute_alreadyReconciled</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">pathLength</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Make sure the router is approved, if applicable.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// If router ownership is renounced (_RouterOwnershipRenounced() is true), then the router whitelist</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// no longer applies and we can skip this approval step.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk11\">_isRouterOwnershipRenounced</span><span class=\"mtk1\">() &amp;&amp; !</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerPermissionInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">approvedRouters</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routers</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BridgeFacet__execute_notSupportedRouter</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Validate the signature. We&#39;ll recover the signer&#39;s address using the expected payload and basic ECDSA</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// signature scheme recovery. The address for each signature must match the router&#39;s address.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routers</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] != </span><span class=\"mtk11\">_recoverSignature</span><span class=\"mtk1\">(</span><span class=\"mtk12\">routerHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerSignatures</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">])) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BridgeFacet__execute_invalidRouterSignature</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>When the nomad message eventually reaches the destination domain and triggered to the <code>BridgeFacet._reconcile</code>, the attacker’s router will be able to claim back the asset provided in the execution step as per normal.</p>\n<h3 id=\"impact-6\" style=\"position:relative;\"><a href=\"#impact-6\" aria-label=\"impact 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Malicious relayer could force Connext to use those routers owned by them to earn the liquidity fee, and at the same time causes the original router chosen by the sequencer to lost the opportunity to earn the liquidity fee. This disrupts the balance and fairness of the protocol causing normal routers to lost the opportunity to earn liquidity fee.</p>\n<p>In bridge or cross-chain communication design, it is a good security practice to minimize the trust that Connext places on other external protocol (e.g. relayer network) wherever possible so that if the external protocol is compromised or acting against maliciously against Connext, the impact or damage would be reduced.</p>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>It is recommended to devise a way for the Connext’s destination bridge to verify that the execute calldata received from the relayer is valid and has not been altered. Ideally, the hash of the original execute calldata sent by seqencer should be compared with the hash of the execute calldata received from relayer so that a mismatch would indicate that the calldata has been modified along the way, and some action should be taken.</p>\n<p>For instance, consider a classic 0x off-chain ordering book protocol. A user will sign his order with his private key, and attach the signature to the order, and send the order (with signature) to the relayer network. If the relayer attempts to tamper the order message or signature, the decoded address will be different from the signer’s address and this will be detected by 0x’s Smart contract on-chain when processing the order. This ensures that the integrity of the message and signer can be enforced.</p>\n<p>Per good security practice, relayer network should always be considered as a hostile environment/network. Therefore, it is recommended that similar approach could be taken with regards to passing execute calldata across domains/chains.</p>\n<p>For instance, at a high level, the sequencer should sign the execute calldata with its private key, and attach the signature to the execute calldata. Then, submit the execute calldata (with signature) to the relayer network. When the bridge receives the execute calldata (with signature), it can verify if the decoded address matches the sequencer address to ensure that the calldata has not been altered. This will ensure the intergrity of the execute calldata and prevent any issue that arise due to unauthorised modification of calldata.</p>\n<h4 id=\"alternative-solution\" style=\"position:relative;\"><a href=\"#alternative-solution\" aria-label=\"alternative solution permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Alternative Solution</h4>\n<p>Alternatively, following method could also be adopted to prevent this issue:</p>\n<ol>\n<li>Assume that it is possible to embed the selected router(s) within the slow nomad message. Append the selected router(s) within the slow nomad message</li>\n<li>Within the <code>BridgeFacet.execute</code> function, instead of using only the transfer ID as the array index  (<code>s.routedTransfers[_transferId] = _args.routers;</code> ), use both transfer ID + selected router as the array index (<code>s.routedTransfers[hash(_transferId+routers)] = _args.routers;</code>)</li>\n<li>When the slow nomad message arrives and triggers to the <code>BridgeFacet._reconcile</code>,  this function will find the routers that provide the fast-liquidity based on the information within the nomad message only. It will attempt to call <code>s.routedTransfers[hash(_transferId+routers)]</code> and it should return nothing as there is a mismatch between attacker’s router and router within the nomad message.</li>\n<li>In this case, the attacker will not be able to claim back any of the funds he provided earlier. This will deter anyone from attempting to swap the router within the execute calldata sent to destination domain’s <code>BridgeFacet.execute</code> function because they will not be able to claim back the funds</li>\n</ol>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/147#issuecomment-1166163991\">jakekidd (Connext) commented</a>:</strong></p>\n<blockquote>\n<p>Duplicate of <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/149\">M-08 (Issue #149)</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/147#issuecomment-1214244444\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I believe this finding is distinct from M-08 because this outlines how relayers could collude with routers to earn most of the fees for providing liquidity to bridge users. M-08 describes how a relayer may force any arbitrary router to supply more liquidity than they originally intended. The later is bad UX for routers providing liquidity even if they do earn more in fees.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-10-router-owner-could-be-rugged-by-admin\" style=\"position:relative;\"><a href=\"#m-10-router-owner-could-be-rugged-by-admin\" aria-label=\"m 10 router owner could be rugged by admin permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/150\">[M-10] Router Owner Could Be Rugged By Admin</a></h2>\n<p><em>Submitted by xiaoming90, also found by unforgiven</em></p>\n<p>Assume that Alice’s router has large amount of liquidity inside.</p>\n<p>Assume that the Connext Admin decided to remove a router owned by Alice. The Connext Admin will call the <code>RoutersFacet.removeRouter</code> function, and all information related to Alice’s router will be erased (set to 0x0) from the <code>s.routerPermissionInfo</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/RoutersFacet.sol#L293\">RoutersFacet.sol#L293</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">removeRouter</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">router</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Sanity check: not empty</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">router</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RoutersFacet__removeRouter_routerEmpty</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Sanity check: needs removal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerPermissionInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">approvedRouters</span><span class=\"mtk1\">[</span><span class=\"mtk12\">router</span><span class=\"mtk1\">]) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RoutersFacet__removeRouter_notAdded</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Update mapping</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerPermissionInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">approvedRouters</span><span class=\"mtk1\">[</span><span class=\"mtk12\">router</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Emit event</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RouterRemoved</span><span class=\"mtk1\">(</span><span class=\"mtk12\">router</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Remove router owner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerPermissionInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerOwners</span><span class=\"mtk1\">[</span><span class=\"mtk12\">router</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_owner</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RouterOwnerAccepted</span><span class=\"mtk1\">(</span><span class=\"mtk12\">router</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// delete routerOwners[router];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerPermissionInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerOwners</span><span class=\"mtk1\">[</span><span class=\"mtk12\">router</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Remove router recipient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerPermissionInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerRecipients</span><span class=\"mtk1\">[</span><span class=\"mtk12\">router</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RouterRecipientSet</span><span class=\"mtk1\">(</span><span class=\"mtk12\">router</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// delete routerRecipients[router];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerPermissionInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerRecipients</span><span class=\"mtk1\">[</span><span class=\"mtk12\">router</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Clear any proposed ownership changes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerPermissionInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">proposedRouterOwners</span><span class=\"mtk1\">[</span><span class=\"mtk12\">router</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerPermissionInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">proposedRouterTimestamp</span><span class=\"mtk1\">[</span><span class=\"mtk12\">router</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>Alice is aware that her router has been removed by Connext Admin, so she decided to withdraw the liquidity from her previous router by calling <code>RoutersFacet.removeRouterLiquidityFor</code>.</p>\n<p>However, when Alice called the <code>RoutersFacet.removeRouterLiquidityFor</code> function, it will revert every single time. This is because the condition <code>msg.sender != getRouterOwner(_router)</code> will always fail.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/RoutersFacet.sol#L490\">RoutersFacet.sol#L490</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">   * </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> This is used by any router owner to decrease their available liquidity for a given asset.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">   * </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk3\"> - The amount of liquidity to remove for the router</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">   * </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">_local</span><span class=\"mtk3\"> - The address of the asset you&#39;re removing liquidity from. If removing liquidity of the</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">   * native asset, routers may use </span><span class=\"mtk8\">`address(0)`</span><span class=\"mtk3\"> or the wrapped asset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">   * </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">_to</span><span class=\"mtk3\"> The address that will receive the liquidity being removed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">   * </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">_router</span><span class=\"mtk3\"> The address of the router</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">   */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">removeRouterLiquidityFor</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_local</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_router</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> </span><span class=\"mtk11\">whenNotPaused</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Caller must be the router owner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">getRouterOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_router</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RoutersFacet__removeRouterLiquidityFor_notOwner</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Remove liquidity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_removeLiquidityForRouter</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_local</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_router</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>Since the <code>RoutersFacet.removeRouter</code> function has earlier erased all information related to Alice’s router within <code>s.routerPermissionInfo</code>, the <code>getRouterOwner</code> function will always return the router address.</p>\n<p>In this case, the router address will not match against <code>msg.sender</code> address/Alice address, thus Alice attempts to call <code>removeRouterLiquidityFor</code> will always revert.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/RoutersFacet.sol#L212\">RoutersFacet.sol#L212</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getRouterOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_router</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerPermissionInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerOwners</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_router</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) ? </span><span class=\"mtk12\">_router</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h3 id=\"impact-7\" style=\"position:relative;\"><a href=\"#impact-7\" aria-label=\"impact 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Router owner who provides liquidity could be rugged by Connext admin. When this happen, the router owner funds will be struck  within the <code>RoutersFacet</code> contract, and there is no way for the router owner to retrieve their liquidity.</p>\n<p>In the worst case scenario, a compromised Connext admin could remove all routers, and cause all liquidity to be struck within <code>RoutersFacet</code> and no router owner could withdraw their liquidity from the contract. Next, the <code>RouterFacet</code> contract could be upgraded to include additional function to withdraw all liquidity from the contract to an arbitrary wallet address.</p>\n<h3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The router owner is still entitled to their own liquidity even though their router has been removed by Connext Admin. Thus, they should be given the right to take back their liquidity when such an event happens. The contract should update its implementation to support this. This will give more assurance to the router owner.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/150#issuecomment-1166615569\">jakekidd (Connext) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>The language here is slightly exaggerated - router funds could not be stolen by the Owner; the Owner can only prevent the router from accessing them by revoking their approval.</p>\n<p>However, it’s still a valid concern, and one that will ultimately be addressed once router permissioning/whitelisting is removed permanently <em>or</em> the Owner role will be delegated to governance.</p>\n<p>The problem with the mitigation step proposed here is that the owner might not be set in some cases, so it’s not a complete solution. So even if router approval is revoked, but we leave the assignment in the ownership mapping, in cases where the router did not assign an owner they won’t be able to withdraw.</p>\n<p>There might be a better solution here by leaving the recipient in the corresponding mapping instead. In the <code>removeLiquidityFor</code> function, we can handle the case where the router’s approval/ownership has been revoked by sending the funds to the recipient regardless of the caller. Unlike the owner, the recipient is always set on router registration.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/150#issuecomment-1166615780\">jakekidd (Connext) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Changing this to be confirmed - would like to resolve this issue by carrying out the solution described in above comment ^</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/150#issuecomment-1214244936\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I think this is only a valid <code>medium</code> because the admin is an EOA and not delegated to a governance contract. Keeping it as is.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-11-tokens-with-decimals-larger-than-18-are-not-supported\" style=\"position:relative;\"><a href=\"#m-11-tokens-with-decimals-larger-than-18-are-not-supported\" aria-label=\"m 11 tokens with decimals larger than 18 are not supported permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/204\">[M-11] Tokens with <code>decimals</code> larger than <code>18</code> are not supported</a></h2>\n<p><em>Submitted by WatchPug, also found by 0x1f8b</em></p>\n<p>For tokens with decimals larger than 18, many functions across the codebase will revert due to underflow.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/helpers/ConnextPriceOracle.sol#L99-L115\">ConnextPriceOracle.sol#L99-L115</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getPriceFromDex</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenAddress</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">PriceInfo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">priceInfo</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">priceRecords</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenAddress</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">priceInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">active</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rawTokenAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20Extended</span><span class=\"mtk1\">(</span><span class=\"mtk12\">priceInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">priceInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpToken</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenDecimalDelta</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">18</span><span class=\"mtk1\"> - </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20Extended</span><span class=\"mtk1\">(</span><span class=\"mtk12\">priceInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">rawTokenAmount</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk12\">tokenDecimalDelta</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rawBaseTokenAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20Extended</span><span class=\"mtk1\">(</span><span class=\"mtk12\">priceInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">priceInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lpToken</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baseTokenDecimalDelta</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">18</span><span class=\"mtk1\"> - </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20Extended</span><span class=\"mtk1\">(</span><span class=\"mtk12\">priceInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baseTokenAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">rawBaseTokenAmount</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk12\">baseTokenDecimalDelta</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baseTokenPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getTokenPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">priceInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseToken</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">baseTokenPrice</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">baseTokenAmount</span><span class=\"mtk1\">).</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenPrice</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/facets/StableSwapFacet.sol#L426\">StableSwapFacet.sol#L426</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">precisionMultipliers</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">SwapUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">POOL_PRECISION_DECIMALS</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]);</span></span></span></code></pre>\n<p>Chainlink feeds’ with decimals > 18 are not supported neither:</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/helpers/ConnextPriceOracle.sol#L122-L140\">ConnextPriceOracle.sol#L122-L140</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getPriceFromChainlink</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenAddress</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">AggregatorV3Interface</span><span class=\"mtk1\"> </span><span class=\"mtk12\">aggregator</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">aggregators</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenAddress</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">aggregator</span><span class=\"mtk1\">) != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      (, </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">answer</span><span class=\"mtk1\">, , , ) = </span><span class=\"mtk12\">aggregator</span><span class=\"mtk1\">.</span><span class=\"mtk11\">latestRoundData</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// It&#39;s fine for price to be 0. We have two price feeds.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">answer</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Extend the decimals to 1e18.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">retVal</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">answer</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">retVal</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk7\">10</span><span class=\"mtk1\">**(</span><span class=\"mtk7\">18</span><span class=\"mtk1\"> - </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">aggregator</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">())));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider checking if decimals > 18 and normalize the value by div the decimals difference.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/204#issuecomment-1160572904\">ecmendenhall (Connext) commented</a>:</strong></p>\n<blockquote>\n<p>I gave this a <img class=\"emoji-icon\" alt=\"emoji-heart\" data-icon=\"emoji-heart\" style=\"display: inline; margin: 0; margin-top: 1px; position: relative; top: 5px; width: 25px\" src=\"data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAMjUlEQVR4Ae2ZBZAkN7KGv5SqcebsBcOC2V4wO+yFY2Zm5jMeMzMzMzMzMzPD8pqZF4a6ukuVT4qp916Fojw100tHX8QfQxEj5Z+pTFU1/+W//Jf/aIQheBLs14I1AqcCywQWALmDK4B1OfwKWM9u4i+QrILT1As4zsAiAIXrFTYr/NnA74EJ5og8c25uLVI4w8JDRWSlAEGoAoAICuSqYzn8Efh4Bp8DphgCCyMKD7PwKAOrBJpxxvT/1wzGf3wKPgxcxyyRJzA7uvBYC680IotFFSmVkAEAHGXAieBU/5zDc4AfMjfuYeDVicgJRrVcrlgAII/WzEVQ1YscPA/4DPUgz2JmetDqwLusyONsEXgDOHDJEg4+7TQWLF9Od9EiNMsYu+wytp13Hlf95S9cf+WV9AEBHPS9XvI6eB2gzMCtIVkLLzLwggSsAM1GgwOXLWPx2rXMO/poRvzaNkkYv+IKtm3axOW//jVXb9lCXxUtjM9V3/E7eDqQMQNya26YA6F5FHysIfLgELwBDl25kpPPOYfD73IXun4j0mxSgABZv8+kN+KSH/+YdR/+MBf/4Q9kRXYGqh88D84GHBUsgtYofDTx6xlVWtZyxB3uwPGPexyH3OQmtBcswIigeQ6qSKOBsZap66/n4h/+kD+/5S3xeh9+HZwO6FBN8Lnw1obIU2zYjDGsOvNMTn3Oc+gcfDCD8XEG27ej/mve601vylpMq0Wy//40Fi4km5xk88c/zu9e9Sp2jI2hIiFLH9oCZ1WY0FxRmC2qzF+8mLUvfSnL7n1vTJqSXnUVgx07oN8H59CwljffdrskBx5Ie+lSnF/vj298I7/36mUZToRM9ZXAi6AaeR7VOLhvS+RLDVXa1nLzF7+Yk572NLKJCXqXXkp+9dU4Hzz/mw2vXASCwub8xho+iO4RR3DVb3/Lj33VXH3xxTC9qfcBZ1OwHuzx8LFE5GFGlYN9ld363e9moS/3CV/azmdYncNEWdNCGIOZN4/OkUfSPuww1r3//fz0mc9kajAgA+d1V+D7VCDPBWJSWNCFP7ZEjgwG3OSpT+VUn43Un+t082acz7wBRASKDQAIECpBAaeKimB9NYwefzw7fCA/eNSj2HbNNeTTzfF5wGsBcnhVU+T5JmTeH6vb+qOzn8/qhD/fmmVYEcQYBAjSkhFarOm8SBKa3vD9TjqJP73pTfzqFa9gkOcMYGMPVgMTsxqDLXh6Q+RNIfhlN785t/v0pwlZmPz735FeD7EWEZkWBXFWVMlVpw3pdLiR39QVP/85P/dmplmGwsDBmhxGE/iZBdNMEm7uN37wqlVM+uANYKJ1qtcDVUWdwwFtXzntFSv44aMfzZYf/IAM6MMZwAeJkOcDZbZCcyX8sQ0njrRa3OkTn+CA445j/He/I5+aIkkSDCAAcUlWbCwHwsaCCZ2jjmLTe97D+s99DgM4+KNA08BJCqzw5/24s86id8kliHOISLFW/Xo5xXqFCaN+Qm3zfeN7D3wgY2lKH37zC7glkM04BW4Gq1rw2wbY5be9Lbd4+9sZ//OfcddeWw5+xozEX4uLCoyMIN7Uda95DVds2EB5nocxd+Jzn4vkOUxNRevUrBcZ7pyDbpfR1av5tf+fm77/ffrQ81oL/J0SyU2BMgZWWbBNEQ659a1JL7+czMsYU5zv6g1A/e/z0DtGR1nhx5rxjeo63xcEWOAr4+jTT0cGA/KxMYxI/D/q1yuJPCcc2dQ360U3uxnn+2Ogqu1w5IgNsEAZC8d50fGZGlm0iPSCC9B+H7W2WGBuaGxCv0/SbrPSB7x9/XpQZT/fJG2jQX7ddQjVaO06kZwj9VNnZP58Oo0G4X5iYSVAnQGLvOj6sWIGA1LvpPVf1TkUyKNynMuGBVDAhUaaJMz3vQUgT1PCSBWR6qNUs45WVQGQhYrzZrd81U2EOGBxrQFASwBrDKFkNWzWOaSmJGWG4LWqgfX7hIsLFWZqIaGg8ufqxhs339yrYQwGEOgQkcTOCgwMIHlONjY2nf08J482KnMs0epN15hUv0Z14OWJMBgQYhEISmsNMDAhgGYZIUOS5xBUYOoroJo4i0Oe9ap1NVJOoVABRSwGgsaJSAzEXEZxTsO11zQakGUASKkHSE22ZI5VILUVUk0O1aOwuCH2fRwuTQFQuJyIpGIjWwAGPvs9P/utv5JqmiKAAwSiGT1ctmN0+L9Vlz+ACD1/9Q4TAEBgU+0RUNgIuCzP7fhFFxHGSB4aFmAKaUWge5K6u0ZV+QPkjQbjF16IU0UhpcoAIvqwvgmXAofvPPdc5vuHi4a1uCyjjJSkgNQ3tuGCHiJ4B2izSd/fK3aedx7F385LYTMRSQox48AvVeTwqfFxtq1bx4EnnIA6h3gBKMzqqio1Acnsg62/apdNsJaw3+v/9jdCD1ARVPVnIzBJRDICxGTw9Rwehgg7vIOJCPOPOQZUyUNHzXN0yGCGGnOzrQBj0CRBs4xtGzey0x9hRCiq4mtUkLjqf/6DTPWyXGRprsrOrVtR30xGjzySzrx5YAw4R57nSFB0Q6TiuX3oUVdz4cGYaVlLHm6uvuzHzj+fsR07yIFMBKe61cIvqUDeQDUW3twReVoX6KiSAA2g0+nQXriQln/RkfjvbbOJFO/ppFBF0NW/GybjxhAk4asqrt8nm5oi9QGHqdXr9egDGTAlwiTQU30p8DIqkLdQjYOVbfhTV6TbAVpAszDCFgrNsTEygh0dpeEl7TY2SaY3qAoAwZTi65wQQb0wBgAVIZgbmrH6IMM7Sec1mJhg4BwZkAODIBF6wFSQ6o4enAxcRAXyRm6YBD7cFXlMB2gDzUL/Z4IqAphCFggmNLpdjP8qrRYSKsQYTDCm9AFKJaoAiAi5c2hQv4+mKXm40AT5bDtV8lLjcyI4IAP6hXrAZJDq24CnQjWJ5YZJ4Q1N1QdlIl0HpUULRCgbgCqEG6SXAApYEYo3uEiSEESRWREBQFWheLmqWUZQuHuIc4RgJXrKMyIwwxU4AwZAprrNQVTklU2wGgsbB/DOBJ7dAJLSnDWFiA2JP8FRRYqgKrp+bb+wRReXmjHoCmUlDeCNSVz6EUnCzDh43UD1AZnIkRlgAVNyu2yCqQgAEYRqTP34q5woOUD84FMyocj+hu3wdmpItlPL9fPgWX34ogWS6ChEJlRejKRmEtS9S5CqzEeBR6XvMnjKAhinhmQBs+JLfdXwwcWjEooqKH3Vkqi9Hc4eBST6GisvZ7342oe3Gfgh1JMYZkceqkD1ponIMgsEZYCpqIIyMsfApTrzldl3hcoTIFX9y7XwEmZJci2z5poD4PRU9ftWpFVkH1dtwh67CMWBu3LmVScG8Li49Ic/AhE5/DyDZw/gbRYohJRMkKhsZfYmVFZPPOI0qCr4aT3Rwl+YA4llbuTw9lT1FCPymLIBDpBIuptelMTnPQPii89A9R0N+ChzJGkwdwbw5FT1GCtyi3IFlL8WIgfKJsssq0AAR/WzfhZlPlX97uXwbIYguZyhGF8MD++p/siIHFO+DZaN0Nm+4q7PfJz9cvDrJuDR86DHECTzGI4puHgEHpyqfs+KLCwHXzH7qy9J1L/ZdSVVZP6KHjywAVcxJEmD4enDnxQeIapfFpF2ZEB1c6z5mBsgjxQHHjSlOjaABzVhIwxP0mSX+U4KZxrVj4qIESAWda/RayogLn0f/KAPjwJ+wS6SKLuFT/TgIANvjIOPMYBA9QNOHHRJfaAHpNN6osBX2A0kwm7jTT4zB4nIsyv7wAyvzCofbCrKPp3O/osE3g/wz2YAp8NzP6y6v4icVd3owAJa9WFo1RNdKfBekOqbBV7JbkQ+xO7lEkgOg092RR7UBoKSkmxQlQFx6Zcb3nTwHwJOZzeTGHYvh0O2DR4jqqOI3A2gWdHgTGRAdccvzr3q5/twDnuApM/uZwSmtsPDUf0qIrfSKNMWMFXnP57z05n/zjXwWGDAHkDewJ5jHhxs4RtdkdXxC1VLiaj8Sw3vFz24F7CNPYS8mz2LgyUj8O22yMktoFGqgCCizt8v1FP93STcDbiOPYi8k73C4V34Vkvk+CaQVPQAVygF+qp/moK7A1eyh5F3sXewsKwB32yKLE+AIAGI577qP6bgbsAlAP82BgAksNLCdxORwy1gYgNUt/TgjvGnOP/aRyDCwgkNCE+QS6R8BFTPd9PBn8deRN7H3kdhlcDXrchigFz1ohzuCmxgLyPvZd+QwU0MfAdIgTsAf2cfIO9m39GHOxnoAT9jHyFv5z8bw384/zWA/3D+B/WylZ+wja1PAAAAAElFTkSuQmCC\" title=\"emoji-heart\" /> along with issue #<a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/61\">61</a> because these findings both identified an additional location in the <code>StableSwap</code> contract where the 18 decimal assumption is hardcoded.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/204#issuecomment-1165955099\">jakekidd (Connext) confirmed and commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p>I gave this a ❤️ along with #61 because these findings both identified an additional location in the <code>StableSwap</code> contract where the 18 decimal assumption is hardcoded.</p>\n</blockquote>\n<p>Marking as confirmed (and leaving issue open) for this reason. Would be great to merge both findings into 1 issue in the finalized audit.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/204#issuecomment-1166801705\">jakekidd (Connext) commented</a>:</strong></p>\n<blockquote>\n<p>Assortment of findings across these three issues:<br>\n<a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/39\">https://github.com/code-423n4/2022-06-connext-findings/issues/39</a><br>\n<a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/61\">https://github.com/code-423n4/2022-06-connext-findings/issues/61</a><br>\n<a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/204\">https://github.com/code-423n4/2022-06-connext-findings/issues/204</a><br></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/204#issuecomment-1170453579\">jakekidd (Connext) resolved</a>:</strong></p>\n<blockquote>\n<p>Fixed by <a href=\"https://github.com/connext/nxtp/commit/f2e5b66da49877f6b63ac0ec5a5db93c9088526a\">connext/nxtp@f2e5b66</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/204#issuecomment-1214246438\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Marking this as the primary issue because it highlights an active part of the codebase while other issues do not. <code>initializeSwap</code> will not be compatible with any token with <code>decimals</code> greater than <code>18</code>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-12-incorrect-adopted-mapping-on-updating-wrapper-token\" style=\"position:relative;\"><a href=\"#m-12-incorrect-adopted-mapping-on-updating-wrapper-token\" aria-label=\"m 12 incorrect adopted mapping on updating wrapper token permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/86\">[M-12] Incorrect Adopted mapping on updating wrapper token</a></h2>\n<p><em>Submitted by codexploder</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/main/contracts/contracts/core/connext/facets/AssetFacet.sol#L100\">AssetFacet.sol#L100</a><br></p>\n<ol>\n<li>Admin can call setWrapper function to setup a new wrapper Y instead of old wrapper X</li>\n<li>This becomes a problem for any old asset which was setup during setupAsset call where <code>s.canonicalToAdopted[_canonical.id]</code>  will still point to old wrapper X instead of Y</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>If wrapper is changed then all variables storing this wrapper should also update.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/86#issuecomment-1166617403\">jakekidd (Connext) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Good spot. This line in <code>setupAsset</code> suggests that we should be setting the wrapper for <code>canonicalToAdopted</code>, so this is correct:</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/facets/AssetFacet.sol#L143\">AssetFacet.sol#L143</a><br></p>\n<p>Fixing this won’t be super straightforward - we’ll have to add another property to tell us the canonical ID(s?) that are currently pointing to the wrapper contract as the adopted asset.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/86#issuecomment-1214478669\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree that this would cause compatibility issues. The admin will be unable to call <code>setupAsset</code> and update the adopted mapping correctly.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-13-missing-whennotpaused-modifier\" style=\"position:relative;\"><a href=\"#m-13-missing-whennotpaused-modifier\" aria-label=\"m 13 missing whennotpaused modifier permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/175\">[M-13] Missing <code>whenNotPaused</code> modifier</a></h2>\n<p><em>Submitted by SmartSek, also found by csanuragjain and hansfriese</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/facets/StableSwapFacet.sol#L279-L286\">StableSwapFacet.sol#L279-L286</a><br></p>\n<p>In <code>StableSwapFacet.sol</code>, two swapping functions contain the <code>whenNotPaused</code> modifier while <code>swapExactOut()</code> and <code>addSwapLiquidity()</code> do not. All functions to swap and add liquidity should contain the same modifiers to stop transactions while paused.</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><strong><em>Example with modifier</em></strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function swapExact(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes32 canonicalId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 amountIn,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address assetIn,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address assetOut,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 minAmountOut,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 deadline</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) external payable nonReentrant deadlineCheck(deadline) whenNotPaused returns (uint256) {</span></span></code></pre>\n<p><strong><em>Examples without modifier</em></strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function swapExactOut(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes32 canonicalId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 amountOut,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address assetIn,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address assetOut,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 maxAmountIn,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 deadline</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) external payable nonReentrant deadlineCheck(deadline) returns (uint256) {</span></span></code></pre>\n<p>and</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function addSwapLiquidity(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes32 canonicalId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256[] calldata amounts,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 minToMint,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 deadline</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) external nonReentrant deadlineCheck(deadline) returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return s.swapStorages[canonicalId].addLiquidity(amounts, minToMint);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add the <code>whenNotPaused</code> modifier to all functions that perform swaps or liquidity additions.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/175#issuecomment-1166751643\">jakekidd (Connext) confirmed and resolved</a>:</strong></p>\n<blockquote>\n<p>Resolved by: <a href=\"https://github.com/connext/nxtp/commit/1dd55597359bdda56fc7b62d9e5a31c6b0faf9bc\">connext/nxtp@1dd5559</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/175#issuecomment-1214716966\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I think this makes sense to add!</p>\n</blockquote>\n<hr>\n<h2 id=\"m-14-single-error-within-sponsorvault-contract-could-cause-entire-cross-chain-communication-to-break-down\" style=\"position:relative;\"><a href=\"#m-14-single-error-within-sponsorvault-contract-could-cause-entire-cross-chain-communication-to-break-down\" aria-label=\"m 14 single error within sponsorvault contract could cause entire cross chain communication to break down permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/146\">[M-14] Single Error Within <code>SponsorVault</code> Contract Could Cause Entire Cross-Chain Communication To Break Down</a></h2>\n<p><em>Submitted by xiaoming90, also found by shenwilly</em></p>\n<p>A third party sponsor would need to implement a <code>SponsorVault</code> contract that is aligned with the <code>ISponsorVault</code> interface.</p>\n<p>Assume that a <code>SponsorVault</code> contract has been defined on Optimism chain. All cross-chain communications are required to call the <code>BridgeFacet.execute</code>, which in turn will trigger the <code>BridgeFacet._handleExecuteTransaction</code> internal function.</p>\n<p>However, if there is an error within <code>SponsorVault</code> contract in Optimism causing a revert when <code>s.sponsorVault.reimburseLiquidityFees</code> or <code>s.sponsorVault.reimburseRelayerFees</code> is called, the entire <code>execute</code> transaction will revert. Since <code>execute</code> transaction always revert, any cross-chain communication between Optimism and other domains will fail.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/BridgeFacet.sol#L819\">BridgeFacet.sol#L819</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">   * </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> Process the transfer, and calldata if needed, when calling </span><span class=\"mtk8\">`execute`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">   * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\"> Need this to prevent stack too deep</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">   */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_handleExecuteTransaction</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ExecuteArgs</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_args</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// adopted (or local if specified)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_transferId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_reconciled</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// If the domain if sponsored</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sponsorVault</span><span class=\"mtk1\">) != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// fast liquidity path</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">_reconciled</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Vault will return the amount of the fee they sponsored in the native fee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// NOTE: some considerations here around fee on transfer tokens and ensuring</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// there are no malicious `Vaults` that do not transfer the correct amount. Should likely do a</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// balance read about it</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">starting</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sponsored</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sponsorVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">reimburseLiquidityFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">to</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Validate correct amounts are transferred</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) != </span><span class=\"mtk12\">starting</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">sponsored</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BridgeFacet__handleExecuteTransaction_invalidSponsoredAmount</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">sponsored</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Should dust the recipient with the lesser of a vault-defined cap or the converted relayer fee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// If there is no conversion available (i.e. no oracles for origin domain asset &lt;&gt; dest asset pair),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// then the vault should just pay out the configured constant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sponsorVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">reimburseRelayerFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">originDomain</span><span class=\"mtk1\">, </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">to</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">relayerFee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span></code></pre>\n<h3 id=\"impact-8\" style=\"position:relative;\"><a href=\"#impact-8\" aria-label=\"impact 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>It will result in denial of service. The <code>SponsorVault</code> contract, which belongs to a third-party, is a single point of failure for a domain.</p>\n<h3 id=\"recommended-mitigation-steps-19\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-19\" aria-label=\"recommended mitigation steps 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>This is a problem commonly encountered whenever a method of a smart contract calls another contract – we cannot rely on the other contract to work 100% of the time, and it is dangerous to assume that the external call will always be successful. Additionally, external smart contract might be vulnerable and compromised by an attacker. Even if the team has audited or review the SponsorVault before whitelisting them, some risk might still exist.</p>\n<p>Therefore, it is recommended to implement a fail-safe design where failure of an external call to SponsorVault will not disrupt the cross-chain communication. Consider implementing a try-catch block as shown below. If there is any issue with the external <code>SponsorVault</code> contract, no funds are reimbursed to the users in the worst case scenario, but the issue will not cause any impact to the cross-chain communication.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">function _handleExecuteTransaction(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\tExecuteArgs calldata _args,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\tuint256 _amount,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\taddress _asset, // adopted (or local if specified)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\tbytes32 _transferId,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\tbool _reconciled</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) private returns (uint256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t// If the domain if sponsored</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\tif (address(s.sponsorVault) != address(0)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t  // fast liquidity path</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t  if (!_reconciled) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t// Vault will return the amount of the fee they sponsored in the native fee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t// NOTE: some considerations here around fee on transfer tokens and ensuring</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t// there are no malicious `Vaults` that do not transfer the correct amount. Should likely do a</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t// balance read about it</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tuint256 starting = IERC20(_asset).balanceOf(address(this));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\ttry s.sponsorVault.reimburseLiquidityFees(_asset, _args.amount, _args.params.to) returns (uint256 sponsored) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t// Validate correct amounts are transferred</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\tif (IERC20(_asset).balanceOf(address(this)) != starting + sponsored) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t  revert BridgeFacet__handleExecuteTransaction_invalidSponsoredAmount();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t_amount = _amount + sponsored;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t} catch {}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t  // Should dust the recipient with the lesser of a vault-defined cap or the converted relayer fee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t  // If there is no conversion available (i.e. no oracles for origin domain asset &lt;&gt; dest asset pair),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t  // then the vault should just pay out the configured constant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t  try s.sponsorVault.reimburseRelayerFees(_args.params.originDomain, payable(_args.params.to), _args.params.relayerFee) {} catch {}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t..SNIP..</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/146#issuecomment-1167497882\">LayneHaber (Connext) confirmed and resolved</a>:</strong></p>\n<blockquote>\n<p>Resolved by: <a href=\"https://github.com/connext/nxtp/pull/1450/commits/f577ed66d2f22cebe7af24822dc27c0819405719\">connext/nxtp@f577ed6</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/146#issuecomment-1214787597\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I believe this to only be a temporary DoS as the broken state can be recovered by calling <code>setSponsorVault</code>. Downgrading to <code>medium</code> risk.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-15-bridgefacets-_executeportaltransfer-ignores-underlying-token-amount-withdrawn-from-aave-pool\" style=\"position:relative;\"><a href=\"#m-15-bridgefacets-_executeportaltransfer-ignores-underlying-token-amount-withdrawn-from-aave-pool\" aria-label=\"m 15 bridgefacets _executeportaltransfer ignores underlying token amount withdrawn from aave pool permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/181\">[M-15] BridgeFacet’s <code>_executePortalTransfer</code> ignores underlying token amount withdrawn from Aave pool</a></h2>\n<p><em>Submitted by hyh</em></p>\n<p><code>_executePortalTransfer</code> can introduce underlying token deficit by accounting for full underlying amount received from Aave unconditionally on what was actually withdrawn from Aave pool. Actual amount withdrawn is returned by <code>IAavePool(s.aavePool).withdraw()</code>, but currently is not used.</p>\n<p>Setting the severity to medium as this can end up with a situation of partial insolvency, when where are a surplus of atokens, but deficit of underlying tokens in the bridge, so bridge functionality can become unavailable as there will be not enough underlying tokens, which were used up in the previous operations when atokens wasn’t converted to underlying fully and underlying tokens from other operations were used up instead without accounting. I.e. the system in this situation supposes that all atokens are in the form of underlying tokens while there will be some atokens left unconverted due to withdrawal being only partial.</p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Call sequence here is execute() -> _handleExecuteLiquidity() -> _executePortalTransfer().</p>\n<p>BridgeFacet._executePortalTransfer() mints the atokens needed, then withdraws them from Aave pool, always accounting for the full withdrawal:</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/facets/BridgeFacet.sol#L882-L900\">BridgeFacet.sol#L882-L900</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">   * </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> Uses Aave Portals to provide fast liquidity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">   */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_executePortalTransfer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_transferId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fastTransferAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_local</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_router</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Calculate local to adopted swap output if needed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">adopted</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">AssetLogic</span><span class=\"mtk1\">.</span><span class=\"mtk11\">calculateSwapFromLocalAssetIfNeeded</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_local</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_fastTransferAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IAavePool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">aavePool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mintUnbacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">adopted</span><span class=\"mtk1\">, </span><span class=\"mtk12\">userAmount</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">AAVE_REFERRAL_CODE</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Improvement: Instead of withdrawing to address(this), withdraw directly to the user or executor to save 1 transfer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IAavePool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">aavePool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">adopted</span><span class=\"mtk1\">, </span><span class=\"mtk12\">userAmount</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Store principle debt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">portalDebt</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_transferId</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">userAmount</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Aave pool’s withdraw() returns the amount of underlying asset that was actually withdrawn:</p>\n<p><a href=\"https://github.com/aave/aave-v3-core/blob/master/contracts/protocol/pool/Pool.sol#L196-L217\">https://github.com/aave/aave-v3-core/blob/master/contracts/protocol/pool/Pool.sol#L196-L217</a></p>\n<p><a href=\"https://github.com/aave/aave-v3-core/blob/master/contracts/protocol/libraries/logic/SupplyLogic.sol#L93-L111\">https://github.com/aave/aave-v3-core/blob/master/contracts/protocol/libraries/logic/SupplyLogic.sol#L93-L111</a></p>\n<p>If a particular lending pool has liquidity shortage at the moment, say all underlying is lent out, full withdrawal of the requested underlying token amount will not be possible.</p>\n<h3 id=\"recommended-mitigation-steps-20\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-20\" aria-label=\"recommended mitigation steps 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider adjusting for the amount actually withdrawn. Also the buffer that stores minted but not yet used atoken amount, say aAmountStored, can be introduced.</p>\n<p>For example:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">+   uint256 amountNeeded = userAmount &lt; aAmountStored ? 0 : userAmount - aAmountStored;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-   IAavePool(s.aavePool).mintUnbacked(adopted, userAmount, address(this), AAVE_REFERRAL_CODE);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+   if (amountNeeded &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+       IAavePool(s.aavePool).mintUnbacked(adopted, amountNeeded, address(this), AAVE_REFERRAL_CODE);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+   }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Improvement: Instead of withdrawing to address(this), withdraw directly to the user or executor to save 1 transfer</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-   IAavePool(s.aavePool).withdraw(adopted, userAmount, address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+   uint256 amountWithdrawn = IAavePool(s.aavePool).withdraw(adopted, userAmount, address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Store principle debt</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-   s.portalDebt[_transferId] = userAmount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+   s.portalDebt[_transferId] = amountWithdrawn; // can&#39;t exceed userAmount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+   aAmountStored = (userAmount &lt; aAmountStored ? aAmountStored : userAmount) - amountWithdrawn; // we used amountWithdrawn</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/181#issuecomment-1166067681\">jakekidd (Connext) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>To clarify for this: We should check to make sure the full amount is withdrawn. If the full amount is not withdrawn (bc not available), revert. This way, the <code>execute</code> call can be treated in our off-chain network the same way an <code>execute</code> call using a router with insufficient funds would be treated.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/181#issuecomment-1166777674\">jakekidd (Connext) resolved</a>:</strong></p>\n<blockquote>\n<p>Fixed by <a href=\"https://github.com/connext/nxtp/commit/b99f9cf54b5d03029c6665776dc434d744758339\">connext/nxtp@b99f9cf</a></p>\n<p>(Using the solution described in the above comment, not the exact code from the mitigation step above.)</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/181#issuecomment-1214737314\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I agree that this improvement would provide better guarantees against insufficient unbacked funds from Aave’s pools.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-16-division-rounding-error-in-_handleexecuteliquidity-and-_reconcile-make-routerbalances-and-contract-fund-balance-to-get-out-of-sync-and-cause-fund-lose\" style=\"position:relative;\"><a href=\"#m-16-division-rounding-error-in-_handleexecuteliquidity-and-_reconcile-make-routerbalances-and-contract-fund-balance-to-get-out-of-sync-and-cause-fund-lose\" aria-label=\"m 16 division rounding error in _handleexecuteliquidity and _reconcile make routerbalances and contract fund balance to get out of sync and cause fund lose permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/213\">[M-16] division rounding error in <code>_handleExecuteLiquidity()</code> and <code>_reconcile()</code> make <code>routerBalances</code> and contract fund balance to get out of sync and cause fund lose</a></h2>\n<p><em>Submitted by unforgiven, also found by xiaoming90</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/facets/BridgeFacet.sol#L753-L803\">BridgeFacet.sol#L753-L803</a><br>\n<a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/facets/BridgeFacet.sol#L526-L616\">BridgeFacet.sol#L526-L616</a><br></p>\n<p>Variable <code>routerBalances</code> suppose to keep track of routers balance in contract and <code>routers</code> can withdraw their balance from contract. but because of division rounding error in <code>_handleExecuteLiquidity()</code> and <code>_reconcile()</code> contract uses more of its tokens than it subtract from router’s balance. this can lead to fund lose.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is <code>_handleExecuteLiquidity()</code> code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  /**</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   * @notice Execute liquidity process used when calling `execute`</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   * @dev Need this to prevent stack too deep</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function _handleExecuteLiquidity(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes32 _transferId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bool _isFast,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ExecuteArgs calldata _args</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) private returns (uint256, address) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 toSwap = _args.amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // If this is a fast liquidity path, we should handle deducting from applicable routers&#39; liquidity.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // If this is a slow liquidity path, the transfer must have been reconciled (if we&#39;ve reached this point),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // and the funds would have been custodied in this contract. The exact custodied amount is untracked in state</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // (since the amount is hashed in the transfer ID itself) - thus, no updates are required.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_isFast) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      uint256 pathLen = _args.routers.length;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Calculate amount that routers will provide with the fast-liquidity fee deducted.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      toSwap = _getFastTransferAmount(_args.amount, s.LIQUIDITY_FEE_NUMERATOR, s.LIQUIDITY_FEE_DENOMINATOR);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Save the addressess of all routers providing liquidity for this transfer.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      s.routedTransfers[_transferId] = _args.routers;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // If router does not have enough liquidity, try to use Aave Portals.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // only one router should be responsible for taking on this credit risk, and it should only</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // deal with transfers expecting adopted assets (to avoid introducing runtime slippage)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      if (</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        !_args.params.receiveLocal &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pathLen == 1 &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        s.routerBalances[_args.routers[0]][_args.local] &lt; toSwap &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        s.aavePool != address(0)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      ) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (!s.routerPermissionInfo.approvedForPortalRouters[_args.routers[0]])</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          revert BridgeFacet__execute_notApprovedForPortals();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Portal provides the adopted asset so we early return here</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return _executePortalTransfer(_transferId, toSwap, _args.local, _args.routers[0]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // for each router, assert they are approved, and deduct liquidity</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 routerAmount = toSwap / pathLen;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        for (uint256 i; i &lt; pathLen; ) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          // decrement routers liquidity</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          s.routerBalances[_args.routers[i]][_args.local] -= routerAmount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          unchecked {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            i++;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see in last part it uses <code>uint256 routerAmount = toSwap / pathLen</code>  to calculate amount to decrease from router’s balance but because of division rounding error contract using <code>toSwap</code> amount of token buy total value it decrease from router’s balances are lower than <code>toSwap</code>.</p>\n<p>Of course in <code>_reconcile()</code> contract add some amount to router’s balances again with division rounding error, but because the amounts are different in this two functions (in <code>_handleExecuteLiquidity()</code> we subtract fee and in <code>_reconcile()</code> we don’t subtract fee) so the division rounding error would be different for them and in the end sum of total balances of routers would not be equal to contract balance. this bug could be more serious for tokens with low precision and higher price.</p>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VIM</p>\n<h3 id=\"recommended-mitigation-steps-21\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-21\" aria-label=\"recommended mitigation steps 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Perform better calculations.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/213#issuecomment-1166339087\">LayneHaber (Connext) acknowledged, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>The maximum fund loss in this case is capped by the maximum number of routers allowed in a transfer (this will generally be below 10, meaning maximum loss from one of these errors is 18 wei units of the token — assuming it hit max on both execute and reconcile).</p>\n<p>I understand the rounding error exists, but even with tokens at a precision of 6 with a high price the maximum rounding error is small (i.e. 100K coin, 6 decimals, this amounts to $1.8). At this level of impact, this should amount to a value leak.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/213#issuecomment-1214491119\">0xleastwood (judge) decreased severity to QA and commented</a>:</strong></p>\n<blockquote>\n<p>I’m gonna downgrade this to <code>QA</code> (low risk / non-critical) because the value leak is mostly negligible and extremely hard to avoid. You could sweep the remaining balance and delegate that to the last router, but this is unfair to other routers.</p>\n<p>I think a good solution would be to make the last router pay the swept balance and then be reconciled this amount once the bridge transfer is complete.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/213#issuecomment-1214748995\">0xleastwood (judge) increased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Actually, upon thinking about this more, I think there is potential for the system to not work as intended under certain parts of the transfer flow.</p>\n<p>If the bridge transfer amount is <code>10 DAI</code> and the liquidity must be provided <em>three</em> routers, each router provides <code>3 DAI</code> respectively. If the user opted to receive the local asset than <code>10 DAI</code> will be directly sent out to them. Therefore, until the transfer has been reconciled, the protocol will essentially take on temporary bad debt which won’t be resolved until the bridge transfer has been reconciled. This may limit withdrawals for other routers during this period. For these reasons, I think <code>medium</code> severity makes more sense:) </p>\n</blockquote>\n<hr>\n<h2 id=\"m-17-swaps-done-internally-will-be-not-be-possible\" style=\"position:relative;\"><a href=\"#m-17-swaps-done-internally-will-be-not-be-possible\" aria-label=\"m 17 swaps done internally will be not be possible permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/249\">[M-17] Swaps done internally will be not be possible</a></h2>\n<p><em>Submitted by 0xmint</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/facets/BridgeFacet.sol#L346\">BridgeFacet.sol#L346</a><br>\n<a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/facets/BridgeFacet.sol#L812\">BridgeFacet.sol#L812</a><br></p>\n<h3 id=\"vulnerability-details\" style=\"position:relative;\"><a href=\"#vulnerability-details\" aria-label=\"vulnerability details permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerability details</h3>\n<p>Affected  functions(that rely on swapAsset()) are:</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/libraries/AssetLogic.sol#L193\">AssetLogic.sol#L193</a><br></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/libraries/AssetLogic.sol#L159\">AssetLogic.sol#L159</a><br></p>\n<p>swapAsset() facilitates two swaps, either using the internal or external pool. But if an internal pool exists, a swap will be unsuccessful because the call to</p>\n<p><code>s.swapStorages[_canonicalId].swapInternal()</code> takes two incorrect arguments (due to an incorrect ordering, this seemed to be an oversight, acknowledged by #Layne) :</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/main/contracts/contracts/core/connext/libraries/AssetLogic.sol#L278-L279\">AssetLogic.sol#L278-L279</a><br></p>\n<p>Based on the above mentioned code , the arguments would be incorrectly changed to :</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/main/contracts/contracts/core/connext/libraries/SwapUtils.sol#L744-L745\">SwapUtils.sol#L744-L745</a><br></p>\n<p>The condition checked here:</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/libraries/SwapUtils.sol#L750\">SwapUtils.sol#L750</a><br></p>\n<p>will never be true as the msg.sender would never own the quantity of tokens being swapped from since it’s the wrong token.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/249#issuecomment-1166671274\">jakekidd (Connext) confirmed and resolved</a>:</strong></p>\n<blockquote>\n<p>Resolved by <a href=\"https://github.com/connext/nxtp/commit/a66844ec9babaca298fe604bbcef24405bc7bd26\">connext/nxtp@a66844e</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/249#issuecomment-1214774632\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Great find!</p>\n</blockquote>\n<hr>\n<h2 id=\"m-18-repaying-aave-loan-in-_local-rather-than-adopted-asset\" style=\"position:relative;\"><a href=\"#m-18-repaying-aave-loan-in-_local-rather-than-adopted-asset\" aria-label=\"m 18 repaying aave loan in _local rather than adopted asset permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/103\">[M-18] Repaying AAVE Loan in <code>_local</code> rather than <code>adopted</code> asset</a></h2>\n<p><em>Submitted by cloudjunky</em></p>\n<p>When repaying the AAVE Portal in <a href=\"https://github.com/code-423n4/2022-06-connext/blob/main/contracts/contracts/core/connext/facets/PortalFacet.sol#L80\"><code>repayAavePortal()</code></a> the <code>_local</code> asset is used to repay the loan in <code>_backLoan()</code> rather than the <code>adopted</code> asset. This is likely to cause issues in production when actually repaying loans if the asset/token being repayed to AAVE is not the same as the asset/token that was borrowed.</p>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The comment on <a href=\"https://github.com/code-423n4/2022-06-connext/blob/main/contracts/contracts/core/connext/facets/PortalFacet.sol#L93\"><code>L93</code></a> of <a href=\"https://github.com/code-423n4/2022-06-connext/blob/main/contracts/contracts/core/connext/facets/PortalFacet.sol\"><code>PortalFacet.sol</code></a> states;</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// Need to swap into adopted asset or asset that was backing the loan</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// The router will always be holding collateral in the local asset while the loaned asset</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// is the adopted asset</span></span></code></pre>\n<p>The swap is executed on <a href=\"https://github.com/code-423n4/2022-06-connext/blob/main/contracts/contracts/core/connext/facets/PortalFacet.sol#L98\"><code>L98</code></a> in the call to <code>AssetLogic.swapFromLocalAssetIfNeededForExactOut()</code> however the return value <code>adopted</code> is never used (it’s an unused local variable). The full function is shown below;</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// Swap for exact `totalRepayAmount` of adopted asset to repay aave</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(bool success, uint256 amountIn, address adopted) = AssetLogic.swapFromLocalAssetIfNeededForExactOut(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  _local,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  totalAmount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  _maxIn</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if (!success) revert PortalFacet__repayAavePortal_swapFailed();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// decrement router balances</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">unchecked {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  s.routerBalances[msg.sender][_local] -= amountIn;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// back loan</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">_backLoan(_local, _backingAmount, _feeAmount, _transferId);</span></span></code></pre>\n<p>The balance of the <code>_local</code> token is reduced but instead of the <code>adopted</code> token being passed to <a href=\"https://github.com/code-423n4/2022-06-connext/blob/main/contracts/contracts/core/connext/facets/PortalFacet.sol#L112\"><code>_backLoan()</code></a> in L112 the <code>_local</code> token is used.</p>\n<h3 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Vim</p>\n<h3 id=\"recommended-mitigation-steps-22\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-22\" aria-label=\"recommended mitigation steps 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>To be consistent with the comments in the <a href=\"https://github.com/code-423n4/2022-06-connext/blob/main/contracts/contracts/core/connext/facets/PortalFacet.sol#L80\"><code>repayAavePortal()</code></a> function <code>adopted</code> should be passed to <code>_backLoan</code> so that the loan is repayed in the appropriate token.</p>\n<p>Remove the reference to <code>_local</code> in the <a href=\"https://github.com/code-423n4/2022-06-connext/blob/main/contracts/contracts/core/connext/facets/PortalFacet.sol#L112\"><code>_backLoan()</code></a> function and replace it with <code>adopted</code> so it reads;</p>\n<p><code>_backLoan(adopted, _backingAmount, _feeAmount, _transferId);</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/103\">jakekidd (Connext) confirmed and resolved</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/103#issuecomment-1214780723\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>If routers are able to repay Aave debt using a token of higher denomination (i.e. pay <code>USDC</code> debt using <code>ETH</code> or <code>DAI</code>), then the liquidity portal functionality will be broken until Connext applies the necessary protocol upgrade to become solvent again.</p>\n<p>Considering the fact that only whitelisted routers have access to this feature and the bridge transfers are not broken but instead limited, I think <code>medium</code> severity makes sense.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-19-attacker-can-perform-griefing-for-process-in-promiserouter-by-reverting-calls-to-callback-in-callbackaddress\" style=\"position:relative;\"><a href=\"#m-19-attacker-can-perform-griefing-for-process-in-promiserouter-by-reverting-calls-to-callback-in-callbackaddress\" aria-label=\"m 19 attacker can perform griefing for process in promiserouter by reverting calls to callback in callbackaddress permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/225\">[M-19] Attacker can perform griefing for <code>process()</code> in <code>PromiseRouter</code> by reverting calls to <code>callback()</code> in <code>callbackAddress</code></a></h2>\n<p><em>Submitted by unforgiven</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/promise/PromiseRouter.sol#L226-L262\">PromiseRouter.sol#L226-L262</a><br></p>\n<p><code>process()</code> in <code>PromiseRouter</code> is used for process stored callback function and anyone calls it gets <code>callbackFee</code> and it calls <code>callback()</code> function of <code>callbackAddress</code>. but attacker set a <code>callbackAddress</code> that reverts on <code>callback()</code> and cause <code>process()</code>  caller griefing. attacker can perform this buy front running or complex logic.</p>\n<h3 id=\"proof-of-concept-14\" style=\"position:relative;\"><a href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is <code>process()</code> code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  /**</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   * @notice Process stored callback function</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   * @param transferId The transferId to process</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function process(bytes32 transferId, bytes calldata _message) public nonReentrant {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // parse out the return data and callback address from message</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes32 messageHash = messageHashes[transferId];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (messageHash == bytes32(0)) revert PromiseRouter__process_invalidTransferId();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes29 _msg = _message.ref(0).mustBePromiseCallback();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (messageHash != _msg.keccak()) revert PromiseRouter__process_invalidMessage();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // enforce relayer is whitelisted by calling local connext contract</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (!connext.approvedRelayers(msg.sender)) revert PromiseRouter__process_notApprovedRelayer();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address callbackAddress = _msg.callbackAddress();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (!AddressUpgradeable.isContract(callbackAddress)) revert PromiseRouter__process_notContractCallback();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 callbackFee = callbackFees[transferId];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // remove message</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    delete messageHashes[transferId];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // remove callback fees</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    callbackFees[transferId] = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // execute callback</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ICallback(callbackAddress).callback(transferId, _msg.returnSuccess(), _msg.returnData());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    emit CallbackExecuted(transferId, msg.sender);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Should transfer the stored relayer fee to the msg.sender</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (callbackFee &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      AddressUpgradeable.sendValue(payable(msg.sender), callbackFee);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>As you can see it calls <code>ICallback(callbackAddress).callback(transferId, _msg.returnSuccess(), _msg.returnData());</code> and if that call reverts then whole transaction would revert. so attacker can setup <code>callbackAddress</code> that revert and the caller of <code>process()</code> wouldn’t get any fee and lose gas.</p>\n<h3 id=\"tools-used-3\" style=\"position:relative;\"><a href=\"#tools-used-3\" aria-label=\"tools used 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VIM</p>\n<h3 id=\"recommended-mitigation-steps-23\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-23\" aria-label=\"recommended mitigation steps 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change the code so it won’t revert if call to <code>callbackAddress</code> reverts.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/225\">jakekidd (Connext) confirmed, but disagreed with severity</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/225#issuecomment-1166174583\">jakekidd (Connext) commented</a>:</strong></p>\n<blockquote>\n<p>If the callback would revert, <em>normally</em> it won’t be called.</p>\n<p>However, the attacker (griefer) could potentially frontrun the relayer’s callback transaction (which is already submitted / in the mempool) and update the state of their callback contract in such a way to cause this subsequent callback to fail. Why would they do that? Nothing is gained, only losses are incurred on both sides.</p>\n<p>This seems like it should be invalid, but it also seems like we should be doing a try/catch on principle though. Perhaps the issue is misrepresented here - it’s not so much an attack vector as it’s ‘best practice’ / QA issue.</p>\n<p><del>Let’s de-escalate to QA issue.</del> Confirming, but would be great to get a second look from @LayneHaber on this.</p>\n<p>EDIT: Changed my mind, think the risk level is appropriate.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/225#issuecomment-1171115193\">LayneHaber (Connext) changed to acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>If you change the message, the following check(s) would fail (since the hash is put onchain when the message is propagated by nomad):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"ts\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">messageHash</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">messageHashes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">transferId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">messageHash</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">PromiseRouter__process_invalidTransferId</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">bytes29</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_msg</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_message</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ref</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mustBePromiseCallback</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">messageHash</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">_msg</span><span class=\"mtk1\">.</span><span class=\"mtk11\">keccak</span><span class=\"mtk1\">()) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">PromiseRouter__process_invalidMessage</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p>An attacker cannot falsify this message because sending messages on the router is restricted via the <code>onlyConnext</code> modifier, so I don’t think changing the <code>callbackAddress</code> is a valid attack strategy. </p>\n<p>If we extend this concern to any failing <code>callback</code>, then any revert would not be executed. In most cases, this would be caught in offchain simulations meaning the relayer would not submit the transaction (and then nobody could process the callback). This means that integrators <em>must</em> handle failures within their code. This is a common practice when writing crosschain handlers (i.e. nomad <code>handle</code> should not revert as the message cannot be reprocessed, functions called via <code>execute</code> should handle errors unless sending funds to a recovery address is okay, etc.).</p>\n<p>Don’t think this qualifies as a value leak, but because it is potentially unprocessable will leave the severity at 2 and move the label to “acknowledged”.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/225#issuecomment-1214769299\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I guess this issue has the same concerns as <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/220\">M-01 (Issue #220)</a>. Even if the onus is on the caller of <code>process</code> to simulate the call beforehand, it seems likely that the transaction could be front-run and prove to be poor user experience for relayers. </p>\n<p>I don’t think its realistic that relayers would call this function without first simulating the transaction to see if the callback fails, but I guess the bridge user could set the callback address up as a honey pot such that simulated transactions are successful.</p>\n<p>It probably makes sense to remove the main culprit of the issue by using a try/catch statement for the <code>ICallback(callbackAddress).callback(transferId, _msg.returnSuccess(), _msg.returnData());</code> call.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-20-in-reimburseliquidityfees-of-sponservault-contract-swaps-tokens-without-slippage-limit-so-its-possible-to-perform-sandwich-attack-and-it-create-mev\" style=\"position:relative;\"><a href=\"#m-20-in-reimburseliquidityfees-of-sponservault-contract-swaps-tokens-without-slippage-limit-so-its-possible-to-perform-sandwich-attack-and-it-create-mev\" aria-label=\"m 20 in reimburseliquidityfees of sponservault contract swaps tokens without slippage limit so its possible to perform sandwich attack and it create mev permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/237\">[M-20] In <code>reimburseLiquidityFees()</code> of <code>SponserVault</code> contract swaps tokens without slippage limit so its possible to perform sandwich attack and it create MEV</a></h2>\n<p><em>Submitted by unforgiven</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/helpers/SponsorVault.sol#L187-L220\">SponsorVault.sol#L187-L220</a><br></p>\n<p>When code swaps tokens it should specify slippage but in <code>reimburseLiquidityFees()</code> code contract calls <code>tokenExchange.swapExactIn()</code> without slippage and it’s possible to perform sandwich attack and make contract to swap on bad exchange rates and there is MEV.</p>\n<h3 id=\"proof-of-concept-15\" style=\"position:relative;\"><a href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is <code>reimburseLiquidityFees()</code> code in <code>SponserVault</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  /**</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   * @notice Performs liquidity fee reimbursement.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   * @dev Uses the token exchange or liquidity deposited in this contract.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   *      The `_receiver` address is only used for emitting in the event.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   * @param _token The address of the token</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   * @param _liquidityFee The liquidity fee amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   * @param _receiver The address of the receiver</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   * @return Sponsored liquidity fee amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function reimburseLiquidityFees(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _token,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _liquidityFee,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _receiver</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) external override onlyConnext returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 sponsoredFee;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (address(tokenExchanges[_token]) != address(0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      uint256 currentBalance = address(this).balance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      ITokenExchange tokenExchange = tokenExchanges[_token];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      uint256 amountIn = tokenExchange.getInGivenExpectedOut(_token, _liquidityFee);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      amountIn = currentBalance &gt;= amountIn ? amountIn : currentBalance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // sponsored fee may end being less than _liquidityFee due to slippage</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      sponsoredFee = tokenExchange.swapExactIn{value: amountIn}(_token, msg.sender);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      uint256 balance = IERC20(_token).balanceOf(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      sponsoredFee = balance &lt; _liquidityFee ? balance : _liquidityFee;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // some ERC20 do not allow to transfer 0 amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      if (sponsoredFee &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC20(_token).safeTransfer(msg.sender, sponsoredFee);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    emit ReimburseLiquidityFees(_token, sponsoredFee, _receiver);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return sponsoredFee;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>As you can see there is no slippage defined when calling <code>swapExactIn()</code> can that swap could happen in any exchange rate. it’s possible to perform sandwich attack and do large swap before and after the transaction and make users lose funds. and it’s also MEV opportunity.</p>\n<h3 id=\"tools-used-4\" style=\"position:relative;\"><a href=\"#tools-used-4\" aria-label=\"tools used 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VIM</p>\n<h3 id=\"recommended-mitigation-steps-24\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-24\" aria-label=\"recommended mitigation steps 24 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Specify slippage when calling swap tokens.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/237#issuecomment-1165947255\">jakekidd (Connext) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>This is absolutely correct, but unfortunately there is no apparent viable on-chain solution. If we revert because slippage is too high, behavior would be inconsistent and UX would be bad, to say the least. If we instead choose to <em>not sponsor</em> because the slippage is too high, then sponsorship could be griefed severely (i.e. ‘if we can’t get at least X, then give the user nothing’ is not a valid sponsorship policy).</p>\n<p>Some things that make a sandwich attack less feasible however:</p>\n<ul>\n<li>Using exchanges with deep liquidity provision (sandwich attacks require principle liquidity, and cannot leverage flashloans).</li>\n<li>The fact that the liquidity fee here is only .05% of the transfer means that it would take a very heavy-handed attack and at least 1 very large transfer to make it profitable (for a 1M transfer, max profit is 500 dollars).</li>\n</ul>\n<p>This is a good entrypoint for a future feature that gives sponsors better options, such as only sponsoring transfers for specific assets that they supply (i.e. so no swap is required).</p>\n<p>cc @LayneHaber for thoughts. Because this essentially boils down to a feature request on behalf of sponsors - not a bug.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/237#issuecomment-1214763448\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Seeing as I can’t verify if <code>tokenExchange.swapExactIn</code> is indeed vulnerable to slippage, I will just side with the sponsor/warden on this one.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 57 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/263\">report highlighted below</a> by <strong>BowTiedWardens</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/71\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/74\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/231\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/183\">cryptphi</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/155\">xiaoming90</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/203\">WatchPug</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/236\">0xf15ers</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/36\">bardamu</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/13\">cmichel</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/7\">oyc_109</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/186\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/238\">JMukesh</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/49\">joestakey</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/173\">Chom</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/136\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/176\">SmartSek</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/247\">sorrynotsorry</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/163\">catchup</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/11\">Jujic</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/178\">kenta</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/106\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/80\">0xNineDec</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/193\">simon135</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/277\">TerrierLover</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/194\">0x52</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/25\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/76\">asutorufos</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/5\">ch13fd357r0y3r</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/116\">k</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/44\">Lambda</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/120\">robee</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/156\">shenwilly</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/192\">SooYa</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/190\">tintin</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/184\">TomJ</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/161\">_Adam</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/29\">0xkatana</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/208\">auditor0517</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/82\">cloudjunky</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/101\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/212\">defsec</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/180\">ElKu</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/59\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/201\">Funen</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/214\">hyh</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/23\">jayjonah8</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/32\">sach1r0</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/110\">0x29A</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/270\">0xmint</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/229\">c3phas</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/276\">Kaiziron</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/198\">MiloTruck</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/271\">obtarian</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/125\">slywaters</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/167\">Waze</a>, and <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/232\">zzzitron</a>.</em></p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<ul>\n<li>\n<p>Low Risk Issues</p>\n<ul>\n<li>[L-01] <code>al</code>, <code>fee</code> and <code>adminFee</code> cannot be set the their maximum value</li>\n<li>[L-02] Add constructor initializers</li>\n<li>[L-03] Unsafe casting may overflow</li>\n<li>[L-04] Uninitialized Upgradeable contract</li>\n<li>[L-05] Deprecated safeApprove() function</li>\n<li>[L-06] Missing address(0) checks</li>\n<li>[L-07] Misleading comment</li>\n<li>[L-08] Add a timelock to critical functions</li>\n<li>[L-09] <code>abi.encodePacked()</code> should not be used with dynamic types when passing the result to a hash function such as <code>keccak256()</code></li>\n<li>[L-10] Upgradeable contract is missing a <code>__gap[50]</code> storage variable to allow for new storage variables in later versions</li>\n<li>[L-11] All <code>initialize()</code> functions are front-runnable in the solution</li>\n<li>[L-12] Use the same revert string for consistency when testing the same condition</li>\n<li>[L-13] Use a <code>constant</code> instead of duplicating the same string</li>\n<li>[L-14] Use a 2-step ownership transfer pattern</li>\n<li>[L-15] A magic number should be documented and explained. Use a <code>constant</code> instead</li>\n<li>[L-16] Lack of event emission for operation changing the state</li>\n</ul>\n</li>\n<li>\n<p>Non-Critical Issues</p>\n<ul>\n<li>[N-01] It’s better to emit after all processing is done</li>\n<li>[N-02] The <code>nonReentrant</code> <code>modifier</code> should occur before all other modifiers</li>\n<li>[N-03] Typos</li>\n<li>[N-04] Deprecated library used for Solidity <code>>= 0.8</code> : SafeMath</li>\n<li>[N-05] Open TODOS</li>\n<li>[N-06] Adding a <code>return</code> statement when the function defines a named return variable, is redundant</li>\n<li>[N-07] The pragmas used are not the same everywhere</li>\n<li>[N-08] Non-library/interface files should use fixed compiler versions, not floating ones</li>\n<li>[N-09] Missing NatSpec</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"l-01-al-fee-and-adminfee-cannot-be-set-the-their-maximum-value\" style=\"position:relative;\"><a href=\"#l-01-al-fee-and-adminfee-cannot-be-set-the-their-maximum-value\" aria-label=\"l 01 al fee and adminfee cannot be set the their maximum value permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] <code>al</code>, <code>fee</code> and <code>adminFee</code> cannot be set the their maximum value</h2>\n<p>Consider replacing <code>&#x3C;</code> with <code>&#x3C;=</code> <a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/helpers/StableSwap.sol#L96\">here</a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">StableSwap</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">96</span><span class=\"mtk1\">:     </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_a</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">AmplificationUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">MAX_A</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;_a exceeds maximum&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"l-02-add-constructor-initializers\" style=\"position:relative;\"><a href=\"#l-02-add-constructor-initializers\" aria-label=\"l 02 add constructor initializers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] Add constructor initializers</h2>\n<p>As per <a href=\"https://forum.openzeppelin.com/t/uupsupgradeable-vulnerability-post-mortem/15680/6\">OpenZeppelin’s (OZ) recommendation</a>, “The guidelines are now to make it impossible for <em>anyone</em> to run <code>initialize</code> on an implementation contract, by adding an empty constructor with the <code>initializer</code> modifier. So the implementation contract gets initialized automatically upon deployment.”</p>\n<p>Note that this behaviour is also incorporated the <a href=\"https://wizard.openzeppelin.com/\">OZ Wizard</a> since the UUPS vulnerability discovery: “Additionally, we modified the code generated by the <a href=\"https://wizard.openzeppelin.com/\">Wizard 19</a> to include a constructor that automatically initializes the implementation when deployed.”</p>\n<p>Furthermore, this thwarts any attempts to frontrun the initialization tx of these contracts:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BridgeToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">34</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initializer</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LPToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">21</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">name</span><span class=\"mtk1\">, </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">symbol</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initializer</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StableSwap</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">61</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/TokenRegistry.sol:</span><span class=\"mtk7\">73</span><span class=\"mtk1\">:  </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk10\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_tokenBeacon</span><span class=\"mtk1\">, </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_xAppConnectionManager</span><span class=\"mtk1\">) </span><span class=\"mtk10\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">initializer</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">core</span><span class=\"mtk1\">/</span><span class=\"mtk10\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk10\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk10\">IBridgeToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">5</span><span class=\"mtk1\">:  </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk10\">initialize</span><span class=\"mtk1\">() </span><span class=\"mtk10\">external</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">core</span><span class=\"mtk1\">/</span><span class=\"mtk10\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk10\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk10\">IStableSwap</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">99</span><span class=\"mtk1\">:  </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk10\">initialize</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">core</span><span class=\"mtk1\">/</span><span class=\"mtk10\">promise</span><span class=\"mtk1\">/</span><span class=\"mtk10\">PromiseRouter</span><span class=\"mtk1\">.</span><span class=\"mtk10\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">146</span><span class=\"mtk1\">:  </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk10\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_xAppConnectionManager</span><span class=\"mtk1\">) </span><span class=\"mtk10\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">initializer</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">core</span><span class=\"mtk1\">/</span><span class=\"mtk10\">relayer</span><span class=\"mtk1\">-</span><span class=\"mtk10\">fee</span><span class=\"mtk1\">/</span><span class=\"mtk10\">RelayerFeeRouter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">80</span><span class=\"mtk1\">:  </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk10\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_xAppConnectionManager</span><span class=\"mtk1\">) </span><span class=\"mtk10\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">initializer</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<h2 id=\"l-03-unsafe-casting-may-overflow\" style=\"position:relative;\"><a href=\"#l-03-unsafe-casting-may-overflow\" aria-label=\"l 03 unsafe casting may overflow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] Unsafe casting may overflow</h2>\n<p>SafeMath and Solidity 0.8.* handles overflows for basic math operations but not for casting.<br>\nConsider using OpenZeppelin’s SafeCast library to prevent unexpected overflows when casting from uint256 here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ConnextMessage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">49</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_view</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assertType</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint40</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_t</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ConnextMessage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">71</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">actionType</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_action</span><span class=\"mtk1\">) == </span><span class=\"mtk11\">uint8</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_type</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk11\">messageType</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_action</span><span class=\"mtk1\">) == </span><span class=\"mtk12\">_type</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ConnextMessage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">138</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Types</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Transfer</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amnt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_detailsHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_transferId</span><span class=\"mtk1\">).</span><span class=\"mtk11\">ref</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">).</span><span class=\"mtk11\">castTo</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint40</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Types</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Transfer</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ConnextMessage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">157</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_domain</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_id</span><span class=\"mtk1\">).</span><span class=\"mtk11\">ref</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">).</span><span class=\"mtk11\">castTo</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint40</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Types</span><span class=\"mtk1\">.</span><span class=\"mtk12\">TokenId</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ConnextMessage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">188</span><span class=\"mtk1\">:      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_message</span><span class=\"mtk1\">.</span><span class=\"mtk11\">castTo</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint40</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Types</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Message</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ConnextMessage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">201</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Types</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint8</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_view</span><span class=\"mtk1\">.</span><span class=\"mtk11\">typeOf</span><span class=\"mtk1\">()));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ConnextMessage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">210</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_message</span><span class=\"mtk1\">.</span><span class=\"mtk11\">slice</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">TOKEN_ID_LEN</span><span class=\"mtk1\">, </span><span class=\"mtk11\">uint40</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Types</span><span class=\"mtk1\">.</span><span class=\"mtk12\">TokenId</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ConnextMessage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">220</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_type</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint40</span><span class=\"mtk1\">(</span><span class=\"mtk11\">msgType</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_message</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ConnextMessage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">232</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">uint32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenId</span><span class=\"mtk1\">.</span><span class=\"mtk11\">indexUint</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">4</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ConnextMessage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">263</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">uint8</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_message</span><span class=\"mtk1\">.</span><span class=\"mtk11\">indexUint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TOKEN_ID_LEN</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ConnextMessage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">272</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">uint8</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_action</span><span class=\"mtk1\">.</span><span class=\"mtk11\">indexUint</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Encoding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">37</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_b</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint8</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_bytes</span><span class=\"mtk1\"> &gt;&gt; (</span><span class=\"mtk12\">i</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">8</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Encoding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">46</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_b</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint8</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_bytes</span><span class=\"mtk1\"> &gt;&gt; (</span><span class=\"mtk12\">i</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">8</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Encoding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">62</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_char</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint8</span><span class=\"mtk1\">(</span><span class=\"mtk12\">NIBBLE_LOOKUP</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_nibble</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibCrossDomainProperty</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">48</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_view</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assertType</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint40</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_t</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibCrossDomainProperty</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">71</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">propertyType</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_property</span><span class=\"mtk1\">) == </span><span class=\"mtk11\">uint8</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_type</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibCrossDomainProperty</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">89</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">uint8</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_property</span><span class=\"mtk1\">.</span><span class=\"mtk11\">indexUint</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibCrossDomainProperty</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">99</span><span class=\"mtk1\">:      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_view</span><span class=\"mtk1\">.</span><span class=\"mtk11\">castTo</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint40</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Types</span><span class=\"mtk1\">.</span><span class=\"mtk12\">DomainAndSender</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibCrossDomainProperty</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">130</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">uint32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_property</span><span class=\"mtk1\">.</span><span class=\"mtk11\">indexUint</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">4</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibCrossDomainProperty</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">140</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Types</span><span class=\"mtk1\">.</span><span class=\"mtk12\">DomainAndSender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_domain</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_sender</span><span class=\"mtk1\">).</span><span class=\"mtk11\">ref</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">).</span><span class=\"mtk11\">castTo</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint40</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Types</span><span class=\"mtk1\">.</span><span class=\"mtk12\">DomainAndSender</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">124</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">selectorPosition</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint96</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ds</span><span class=\"mtk1\">.</span><span class=\"mtk12\">facetFunctionSelectors</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_facetAddress</span><span class=\"mtk1\">].</span><span class=\"mtk12\">functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">142</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">selectorPosition</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint96</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ds</span><span class=\"mtk1\">.</span><span class=\"mtk12\">facetFunctionSelectors</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_facetAddress</span><span class=\"mtk1\">].</span><span class=\"mtk12\">functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">201</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">ds</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selectorToFacetAndPosition</span><span class=\"mtk1\">[</span><span class=\"mtk12\">lastSelector</span><span class=\"mtk1\">].</span><span class=\"mtk12\">functionSelectorPosition</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint96</span><span class=\"mtk1\">(</span><span class=\"mtk12\">selectorPosition</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">promise</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PromiseMessage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">41</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_view</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assertType</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint40</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_t</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">promise</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PromiseMessage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">63</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">uint8</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Types</span><span class=\"mtk1\">.</span><span class=\"mtk12\">PromiseCallback</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">promise</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PromiseMessage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">66</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">uint8</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_returnSuccess</span><span class=\"mtk1\"> ? </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> : </span><span class=\"mtk7\">0</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">promise</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PromiseMessage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">152</span><span class=\"mtk1\">:      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_view</span><span class=\"mtk1\">.</span><span class=\"mtk11\">castTo</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint40</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Types</span><span class=\"mtk1\">.</span><span class=\"mtk12\">PromiseCallback</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">promise</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PromiseRouter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">313</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">uint64</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_origin</span><span class=\"mtk1\">) &lt;&lt; </span><span class=\"mtk7\">32</span><span class=\"mtk1\">) | </span><span class=\"mtk12\">_nonce</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">relayer</span><span class=\"mtk1\">-</span><span class=\"mtk12\">fee</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RelayerFeeMessage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">44</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_view</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assertType</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint40</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_t</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">relayer</span><span class=\"mtk1\">-</span><span class=\"mtk12\">fee</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RelayerFeeMessage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">57</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint8</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Types</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ClaimFees</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_transferIds</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_transferIds</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">relayer</span><span class=\"mtk1\">-</span><span class=\"mtk12\">fee</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RelayerFeeMessage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">109</span><span class=\"mtk1\">:      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_view</span><span class=\"mtk1\">.</span><span class=\"mtk11\">castTo</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint40</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Types</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ClaimFees</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">relayer</span><span class=\"mtk1\">-</span><span class=\"mtk12\">fee</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RelayerFeeRouter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">166</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">uint64</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_origin</span><span class=\"mtk1\">) &lt;&lt; </span><span class=\"mtk7\">32</span><span class=\"mtk1\">) | </span><span class=\"mtk12\">_nonce</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"l-04-uninitialized-upgradeable-contract\" style=\"position:relative;\"><a href=\"#l-04-uninitialized-upgradeable-contract\" aria-label=\"l 04 uninitialized upgradeable contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04] Uninitialized Upgradeable contract</h2>\n<p><em>Similar issue in the past: <a href=\"https://github.com/code-423n4/2022-03-prepo-findings/issues/106\">here</a></em></p>\n<p>Upgradeable dependencies should be initialized.<br>\nWhile not causing any harm at the moment, suppose OZ someday decide to upgrade this contract and the sponsor uses the new version: it is possible that the contract will not work anymore.<br>\nConsider calling the <code>init()</code> <a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/promise/PromiseRouter.sol#L146-L148\">here</a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: PromiseRouter.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">23: contract PromiseRouter is Version, Router, ReentrancyGuardUpgradeable {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">146:   function initialize(address _xAppConnectionManager) public initializer {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">147:     __XAppConnectionClient_initialize(_xAppConnectionManager);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 147:     __ReentrancyGuard_init(); //@audit ReentrancyGuardUpgradeable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">148:   }</span></span></span></code></pre>\n<p>This is already applied L72 in <code>StableSwap.sol</code> (but was forgotten in <code>PromiseRouter.sol</code>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">StableSwap</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">61</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">70:   ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initializer</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">71</span><span class=\"mtk1\">:     </span><span class=\"mtk11\">__OwnerPausable_init</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">72</span><span class=\"mtk1\">:     </span><span class=\"mtk11\">__ReentrancyGuard_init</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<h2 id=\"l-05-deprecated-safeapprove-function\" style=\"position:relative;\"><a href=\"#l-05-deprecated-safeapprove-function\" aria-label=\"l 05 deprecated safeapprove function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-05] Deprecated safeApprove() function</h2>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/bfff03c0d2a59bcd8e2ead1da9aed9edf0080d05/contracts/token/ERC20/utils/SafeERC20.sol#L38-L45\">Deprecated</a></p>\n<p>Using this deprecated function can lead to unintended reverts and potentially the locking of funds. A deeper discussion on the deprecation of this function is in OZ issue #2219 (OpenZeppelin/openzeppelin-contracts#2219). The OpenZeppelin ERC20 <code>safeApprove()</code> function has been deprecated, as seen in the comments of the OpenZeppelin code.</p>\n<p>As recommended by the OpenZeppelin comment, consider replacing <code>safeApprove()</code> with <code>safeIncreaseAllowance()</code> or <code>safeDecreaseAllowance()</code> instead:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AssetLogic</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">347</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">SafeERC20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_assetIn</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_amountIn</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"l-06-missing-address0-checks\" style=\"position:relative;\"><a href=\"#l-06-missing-address0-checks\" aria-label=\"l 06 missing address0 checks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-06] Missing address(0) checks</h2>\n<p>Consider adding an <code>address(0)</code> check for immutable variables:</p>\n<ul>\n<li>File: Executor.sol</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">29:  address private immutable connext;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">47:   constructor(address _connext) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 48:     require(_connext != address(0));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">48:     connext = _connext;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">49:   }</span></span></span></code></pre>\n<h2 id=\"l-07-misleading-comment\" style=\"position:relative;\"><a href=\"#l-07-misleading-comment\" aria-label=\"l 07 misleading comment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-07] Misleading comment</h2>\n<p><em>Issue with comment</em></p>\n<p>I suspect a copy-paste error <a href=\"https://github.com/code-423n4/2022-06-connext/blob/b4532655071566b33c41eac46e75be29b4a381ed/contracts/contracts/core/connext/libraries/SwapUtils.sol#L790\">here</a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- core/connext/libraries/SwapUtils.sol:790:    require(dx &lt;= maxDx, &quot;Swap didn&#39;t result in min tokens&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ core/connext/libraries/SwapUtils.sol:790:    require(dx &lt;= maxDx, &quot;Swap needs more than max tokens&quot;);</span></span></span></code></pre>\n<h2 id=\"l-08-add-a-timelock-to-critical-functions\" style=\"position:relative;\"><a href=\"#l-08-add-a-timelock-to-critical-functions\" aria-label=\"l 08 add a timelock to critical functions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-08] Add a timelock to critical functions</h2>\n<p>It is a good practice to give time for users to react and adjust to critical changes. A timelock provides more guarantees and reduces the level of trust required, thus decreasing risk for users. It also indicates that the project is legitimate (less risk of a malicious owner making a sandwich attack on a user).</p>\n<p>Consider adding a timelock to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StableSwapFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">469</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setSwapAdminFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">canonicalId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newAdminFee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StableSwapFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">478</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setSwapFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">canonicalId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newSwapFee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StableSwap</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">448</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setAdminFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newAdminFee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StableSwap</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">456</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setSwapFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newSwapFee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<h2 id=\"l-09-abiencodepacked-should-not-be-used-with-dynamic-types-when-passing-the-result-to-a-hash-function-such-as-keccak256\" style=\"position:relative;\"><a href=\"#l-09-abiencodepacked-should-not-be-used-with-dynamic-types-when-passing-the-result-to-a-hash-function-such-as-keccak256\" aria-label=\"l 09 abiencodepacked should not be used with dynamic types when passing the result to a hash function such as keccak256 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-09] <code>abi.encodePacked()</code> should not be used with dynamic types when passing the result to a hash function such as <code>keccak256()</code></h2>\n<p><em>Similar issue in the past: <a href=\"https://github.com/code-423n4/2021-09-wildcredit-findings/issues/4\">here</a></em></p>\n<p>Use <code>abi.encode()</code> instead which will pad items to 32 bytes, which will prevent hash collisions (e.g. <code>abi.encodePacked(0x123,0x456)</code> => <code>0x123456</code> => <code>abi.encodePacked(0x1,0x23456)</code>, but <code>abi.encode(0x123,0x456)</code> => <code>0x0...1230...456</code>). If there is only one argument to <code>abi.encodePacked()</code> it can often be cast to <code>bytes()</code> or <code>bytes32()</code> instead.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BridgeToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">134</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_digest</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_EIP712_PREFIX_AND_VERSION</span><span class=\"mtk1\">, </span><span class=\"mtk11\">domainSeparator</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">_hashStruct</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ConnextMessage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">178</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk11\">bytes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_name</span><span class=\"mtk1\">).</span><span class=\"mtk12\">length</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_name</span><span class=\"mtk1\">, </span><span class=\"mtk11\">bytes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_symbol</span><span class=\"mtk1\">).</span><span class=\"mtk12\">length</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_symbol</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_decimals</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<h2 id=\"l-10-upgradeable-contract-is-missing-a-__gap50-storage-variable-to-allow-for-new-storage-variables-in-later-versions\" style=\"position:relative;\"><a href=\"#l-10-upgradeable-contract-is-missing-a-__gap50-storage-variable-to-allow-for-new-storage-variables-in-later-versions\" aria-label=\"l 10 upgradeable contract is missing a __gap50 storage variable to allow for new storage variables in later versions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-10] Upgradeable contract is missing a <code>__gap[50]</code> storage variable to allow for new storage variables in later versions</h2>\n<p>See <a href=\"https://docs.openzeppelin.com/contracts/4.x/upgradeable#storage_gaps\">this</a> link for a description of this storage variable. While some contracts may not currently be sub-classed, adding the variable now protects against forgetting to add it in the future:</p>\n<ul>\n<li>LPToken.sol</li>\n<li>OwnerPausableUpgradeable.sol</li>\n</ul>\n<p>Those contracts do apply the recommendation though:</p>\n<ul>\n<li>ProposedOwnableUpgradeable.sol</li>\n<li>BridgeToken.sol</li>\n<li>ProposedOwnable.sol</li>\n<li>Router.sol</li>\n<li>XAppConnectionClient.sol</li>\n</ul>\n<h2 id=\"l-11-all-initialize-functions-are-front-runnable-in-the-solution\" style=\"position:relative;\"><a href=\"#l-11-all-initialize-functions-are-front-runnable-in-the-solution\" aria-label=\"l 11 all initialize functions are front runnable in the solution permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-11] All <code>initialize()</code> functions are front-runnable in the solution</h2>\n<p>Consider adding some access control to them or deploying atomically or using constructor <code>initializer</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BridgeToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">34</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initializer</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LPToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">21</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">name</span><span class=\"mtk1\">, </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">symbol</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initializer</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StableSwap</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">61</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/TokenRegistry.sol:</span><span class=\"mtk7\">73</span><span class=\"mtk1\">:  </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk10\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_tokenBeacon</span><span class=\"mtk1\">, </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_xAppConnectionManager</span><span class=\"mtk1\">) </span><span class=\"mtk10\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">initializer</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">core</span><span class=\"mtk1\">/</span><span class=\"mtk10\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk10\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk10\">IBridgeToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">5</span><span class=\"mtk1\">:  </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk10\">initialize</span><span class=\"mtk1\">() </span><span class=\"mtk10\">external</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">core</span><span class=\"mtk1\">/</span><span class=\"mtk10\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk10\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk10\">IStableSwap</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">99</span><span class=\"mtk1\">:  </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk10\">initialize</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">core</span><span class=\"mtk1\">/</span><span class=\"mtk10\">promise</span><span class=\"mtk1\">/</span><span class=\"mtk10\">PromiseRouter</span><span class=\"mtk1\">.</span><span class=\"mtk10\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">146</span><span class=\"mtk1\">:  </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk10\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_xAppConnectionManager</span><span class=\"mtk1\">) </span><span class=\"mtk10\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">initializer</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">core</span><span class=\"mtk1\">/</span><span class=\"mtk10\">relayer</span><span class=\"mtk1\">-</span><span class=\"mtk10\">fee</span><span class=\"mtk1\">/</span><span class=\"mtk10\">RelayerFeeRouter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">80</span><span class=\"mtk1\">:  </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk10\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_xAppConnectionManager</span><span class=\"mtk1\">) </span><span class=\"mtk10\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">initializer</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<h2 id=\"l-12-use-the-same-revert-string-for-consistency-when-testing-the-same-condition\" style=\"position:relative;\"><a href=\"#l-12-use-the-same-revert-string-for-consistency-when-testing-the-same-condition\" aria-label=\"l 12 use the same revert string for consistency when testing the same condition permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-12] Use the same revert string for consistency when testing the same condition</h2>\n<p><em>Issue with comment</em></p>\n<p>Consider only using the shorter string:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StableSwap</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">155</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">index</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">swapStorage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pooledTokens</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Out of range&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StableSwap</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">177</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">index</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">swapStorage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pooledTokens</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Index out of range&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"l-13-use-a-constant-instead-of-duplicating-the-same-string\" style=\"position:relative;\"><a href=\"#l-13-use-a-constant-instead-of-duplicating-the-same-string\" aria-label=\"l 13 use a constant instead of duplicating the same string permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-13] Use a <code>constant</code> instead of duplicating the same string</h2>\n<p><em>Issue with comment</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">123</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_facetAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;LibDiamondCut: Add facet can&#39;t be address(0)&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">141</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_facetAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;LibDiamondCut: Add facet can&#39;t be address(0)&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"64\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">121</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LibDiamondCut: No selectors in facet to cut&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">139</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LibDiamondCut: No selectors in facet to cut&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">158</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LibDiamondCut: No selectors in facet to cut&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"65\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">SwapUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">493</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenIndexFrom</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">xp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">tokenIndexTo</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">xp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Token index out of range&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">SwapUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">524</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenIndexFrom</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">xp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">tokenIndexTo</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">xp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Token index out of range&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"66\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">SwapUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">662</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">dy</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">minDy</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Swap didn&#39;t result in min tokens&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">SwapUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">756</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">dy</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">minDy</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Swap didn&#39;t result in min tokens&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"67\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">SwapUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">703</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">dx</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">maxDx</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Swap needs more than max tokens&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">SwapUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">790</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">dx</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">maxDx</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Swap didn&#39;t result in min tokens&quot;</span><span class=\"mtk1\">); </span><span class=\"mtk3\">//@audit this one is a copy-paste error</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"68\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">SwapUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">697</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">dy</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">self</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">tokenIndexTo</span><span class=\"mtk1\">], </span><span class=\"mtk8\">&quot;Cannot get more than pool balance&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">SwapUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">784</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">dy</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">self</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">tokenIndexTo</span><span class=\"mtk1\">], </span><span class=\"mtk8\">&quot;Cannot get more than pool balance&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"69\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">SwapUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">717</span><span class=\"mtk1\">:      </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">dx</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">tokenFrom</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Cannot swap more than you own&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">SwapUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">649</span><span class=\"mtk1\">:      </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">dx</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">tokenFrom</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Cannot swap more than you own&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">SwapUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">750</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">dx</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">tokenFrom</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Cannot swap more than you own&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"70\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">SwapUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">1071</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newAdminFee</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">MAX_ADMIN_FEE</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Fee is too high&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">SwapUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">1084</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newSwapFee</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">MAX_SWAP_FEE</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Fee is too high&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"l-14-use-a-2-step-ownership-transfer-pattern\" style=\"position:relative;\"><a href=\"#l-14-use-a-2-step-ownership-transfer-pattern\" aria-label=\"l 14 use a 2 step ownership transfer pattern permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-14] Use a 2-step ownership transfer pattern</h2>\n<p>Contracts inheriting from OpenZeppelin’s libraries have the default <code>transferOwnership()</code> function (a one-step process). It’s possible that the <code>onlyOwner</code> role mistakenly transfers ownership to a wrong address, resulting in a loss of the <code>onlyOwner</code> role.\nConsider overriding the default <code>transferOwnership()</code> function to first nominate an address as the <code>pendingOwner</code> and implementing an <code>acceptOwnership()</code> function which is called by the <code>pendingOwner</code> to confirm the transfer.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"71\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BridgeToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">202</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">transferOwnership</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newOwner</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IBridgeToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">OwnableUpgradeable</span><span class=\"mtk1\">) </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BridgeToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">203</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">OwnableUpgradeable</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferOwnership</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_newOwner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TokenRegistry</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">302</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">IBridgeToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transferOwnership</span><span class=\"mtk1\">(</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">IBridgeToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">29</span><span class=\"mtk1\">:  </span><span class=\"mtk3\">// inherited from ownable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">IBridgeToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">30</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">transferOwnership</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newOwner</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"l-15-a-magic-number-should-be-documented-and-explained-use-a-constant-instead\" style=\"position:relative;\"><a href=\"#l-15-a-magic-number-should-be-documented-and-explained-use-a-constant-instead\" aria-label=\"l 15 a magic number should be documented and explained use a constant instead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-15] A magic number should be documented and explained. Use a <code>constant</code> instead</h2>\n<p><em>Similar issue in the past: <a href=\"https://github.com/code-423n4/2021-04-marginswap-findings/issues/71\">here</a></em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"72\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">upgrade</span><span class=\"mtk1\">-</span><span class=\"mtk12\">initializers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DiamondInit</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">70</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nonce</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">upgrade</span><span class=\"mtk1\">-</span><span class=\"mtk12\">initializers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DiamondInit</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">76</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">LIQUIDITY_FEE_NUMERATOR</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">9995</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">upgrade</span><span class=\"mtk1\">-</span><span class=\"mtk12\">initializers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DiamondInit</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">77</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">LIQUIDITY_FEE_DENOMINATOR</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">upgrade</span><span class=\"mtk1\">-</span><span class=\"mtk12\">initializers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DiamondInit</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">78</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maxRoutersPerTransfer</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">5</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TokenRegistry</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">300</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">IBridgeToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">setDetails</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_name</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_symbol</span><span class=\"mtk1\">, </span><span class=\"mtk7\">18</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Consider using <code>constant</code> variables as this would make the code more maintainable and readable while costing nothing gas-wise (constants are replaced by their value at compile-time).</p>\n<h2 id=\"l-16-lack-of-event-emission-for-operation-changing-the-state\" style=\"position:relative;\"><a href=\"#l-16-lack-of-event-emission-for-operation-changing-the-state\" aria-label=\"l 16 lack of event emission for operation changing the state permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-16] Lack of event emission for operation changing the state</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"73\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">AssetFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">171</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">removeAssetId</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_canonicalId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_adoptedAssetId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">179</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">delete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">adoptedToLocalPools</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_canonicalId</span><span class=\"mtk1\">]; </span><span class=\"mtk3\">// @audit-info INFO no event emitted for StableSwap removal</span></span></span></code></pre>\n<h2 id=\"n-01-its-better-to-emit-after-all-processing-is-done\" style=\"position:relative;\"><a href=\"#n-01-its-better-to-emit-after-all-processing-is-done\" aria-label=\"n 01 its better to emit after all processing is done permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] It’s better to emit after all processing is done</h2>\n<ul>\n<li>contracts/contracts/core/connext/facets/AssetFacet.sol:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"74\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">152</span><span class=\"mtk1\">:     </span><span class=\"mtk3\">// Emit event</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">153</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AssetAdded</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_canonical</span><span class=\"mtk1\">.</span><span class=\"mtk12\">id</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_canonical</span><span class=\"mtk1\">.</span><span class=\"mtk12\">domain</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_adoptedAssetId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">supported</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">154</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">155</span><span class=\"mtk1\">      </span><span class=\"mtk3\">// Add the swap pool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">156</span><span class=\"mtk1\">      </span><span class=\"mtk11\">_addStableSwapPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_canonical</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_stableSwapPool</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">157</span><span class=\"mtk1\">    }</span></span></span></code></pre>\n<ul>\n<li>contracts/contracts/core/connext/facets/RoutersFacet.sol:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"75\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">303</span><span class=\"mtk1\">:     </span><span class=\"mtk3\">// Emit event</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">304</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RouterRemoved</span><span class=\"mtk1\">(</span><span class=\"mtk12\">router</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">305</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">306</span><span class=\"mtk1\">      </span><span class=\"mtk3\">// Remove router owner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">307</span><span class=\"mtk1\">      </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerPermissionInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerOwners</span><span class=\"mtk1\">[</span><span class=\"mtk12\">router</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">308</span><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_owner</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">309</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RouterOwnerAccepted</span><span class=\"mtk1\">(</span><span class=\"mtk12\">router</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">310</span><span class=\"mtk1\">        </span><span class=\"mtk3\">// delete routerOwners[router];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">311</span><span class=\"mtk1\">        </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerPermissionInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerOwners</span><span class=\"mtk1\">[</span><span class=\"mtk12\">router</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">312</span><span class=\"mtk1\">      }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"76\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">316</span><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">317</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RouterRecipientSet</span><span class=\"mtk1\">(</span><span class=\"mtk12\">router</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">318</span><span class=\"mtk1\">        </span><span class=\"mtk3\">// delete routerRecipients[router];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">319</span><span class=\"mtk1\">        </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerPermissionInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">routerRecipients</span><span class=\"mtk1\">[</span><span class=\"mtk12\">router</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">320</span><span class=\"mtk1\">      }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"77\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">335</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MaxRoutersPerTransferUpdated</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_newMaxRouters</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">336</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">337</span><span class=\"mtk1\">      </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maxRoutersPerTransfer</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_newMaxRouters</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">338</span><span class=\"mtk1\">    }</span></span></span></code></pre>\n<ul>\n<li>contracts/contracts/core/connext/helpers/ConnextPriceOracle.sol:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"78\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">158</span><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setDirectPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_price</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyAdmin</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">159</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">DirectPriceUpdated</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">assetPrices</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">], </span><span class=\"mtk12\">_price</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">160</span><span class=\"mtk1\">      </span><span class=\"mtk12\">assetPrices</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_price</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">161</span><span class=\"mtk1\">    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"79\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">163</span><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setV1PriceOracle</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_v1PriceOracle</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyAdmin</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">164</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">V1PriceOracleUpdated</span><span class=\"mtk1\">(</span><span class=\"mtk12\">v1PriceOracle</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_v1PriceOracle</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">165</span><span class=\"mtk1\">      </span><span class=\"mtk12\">v1PriceOracle</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_v1PriceOracle</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">166</span><span class=\"mtk1\">    }</span></span></span></code></pre>\n<ul>\n<li>contracts/contracts/core/connext/helpers/SponsorVault.sol:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"80\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">150</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RateUpdated</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_originDomain</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_originDomain</span><span class=\"mtk1\">], </span><span class=\"mtk12\">_rate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">151</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">152</span><span class=\"mtk1\">      </span><span class=\"mtk12\">rates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_originDomain</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_rate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">153</span><span class=\"mtk1\">    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"81\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">159</span><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setRelayerFeeCap</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_relayerFeeCap</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">160</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RelayerFeeCapUpdated</span><span class=\"mtk1\">(</span><span class=\"mtk12\">relayerFeeCap</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_relayerFeeCap</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">161</span><span class=\"mtk1\">      </span><span class=\"mtk12\">relayerFeeCap</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_relayerFeeCap</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">162</span><span class=\"mtk1\">    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"82\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">168</span><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setGasTokenOracle</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_gasTokenOracle</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">169</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">GasTokenOracleUpdated</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gasTokenOracle</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_gasTokenOracle</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">170</span><span class=\"mtk1\">      </span><span class=\"mtk12\">gasTokenOracle</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IGasTokenOracle</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_gasTokenOracle</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">171</span><span class=\"mtk1\">    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"83\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">181</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TokenExchangeUpdated</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenExchanges</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">]), </span><span class=\"mtk12\">_tokenExchange</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">182</span><span class=\"mtk1\">      </span><span class=\"mtk12\">tokenExchanges</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">ITokenExchange</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenExchange</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">183</span><span class=\"mtk1\">    }</span></span></span></code></pre>\n<ul>\n<li>contracts/contracts/core/connext/libraries/LibDiamond.sol:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"84\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">116</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">DiamondCut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_diamondCut</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_init</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_calldata</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">117</span><span class=\"mtk1\">      </span><span class=\"mtk11\">initializeDiamondCut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_init</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_calldata</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">118</span><span class=\"mtk1\">    }</span></span></span></code></pre>\n<ul>\n<li>contracts/contracts/core/promise/PromiseRouter.sol:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"85\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">256</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">CallbackExecuted</span><span class=\"mtk1\">(</span><span class=\"mtk12\">transferId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">257</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">258</span><span class=\"mtk1\">      </span><span class=\"mtk3\">// Should transfer the stored relayer fee to the msg.sender</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">259</span><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">callbackFee</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">260</span><span class=\"mtk1\">        </span><span class=\"mtk12\">AddressUpgradeable</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sendValue</span><span class=\"mtk1\">(</span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">), </span><span class=\"mtk12\">callbackFee</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"n-02-the-nonreentrant-modifier-should-occur-before-all-other-modifiers\" style=\"position:relative;\"><a href=\"#n-02-the-nonreentrant-modifier-should-occur-before-all-other-modifiers\" aria-label=\"n 02 the nonreentrant modifier should occur before all other modifiers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-02] The <code>nonReentrant</code> <code>modifier</code> should occur before all other modifiers</h2>\n<p>This is a best-practice to protect against re-entrancy in other modifiers</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"86\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BridgeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">279</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">xcall</span><span class=\"mtk1\">(</span><span class=\"mtk12\">XCallArgs</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_args</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk11\">whenNotPaused</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BridgeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">411</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">execute</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ExecuteArgs</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_args</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">whenNotPaused</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<h2 id=\"n-03-typos\" style=\"position:relative;\"><a href=\"#n-03-typos\" aria-label=\"n 03 typos permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-03] Typos</h2>\n<ul>\n<li>funciton</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"87\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">upgrade</span><span class=\"mtk1\">-</span><span class=\"mtk12\">initializers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DiamondInit</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">31</span><span class=\"mtk1\">:</span><span class=\"mtk3\">// of your diamond. Add parameters to the init funciton if you need to.</span></span></span></code></pre>\n<ul>\n<li>_potentialReplcia</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"88\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BaseConnextFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">137</span><span class=\"mtk1\">:   * @</span><span class=\"mtk12\">notice</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Determine</span><span class=\"mtk1\"> </span><span class=\"mtk12\">whether</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_potentialReplcia</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">an</span><span class=\"mtk1\"> </span><span class=\"mtk12\">enrolled</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Replica</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\"> </span><span class=\"mtk12\">the</span><span class=\"mtk1\"> </span><span class=\"mtk12\">xAppConnectionManager</span></span></span></code></pre>\n<ul>\n<li>bridgable</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"89\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BridgeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">265</span><span class=\"mtk1\">:   * </span><span class=\"mtk12\">assets</span><span class=\"mtk1\"> </span><span class=\"mtk12\">will</span><span class=\"mtk1\"> </span><span class=\"mtk12\">be</span><span class=\"mtk1\"> </span><span class=\"mtk12\">swapped</span><span class=\"mtk1\"> </span><span class=\"mtk12\">for</span><span class=\"mtk1\"> </span><span class=\"mtk12\">their</span><span class=\"mtk1\"> </span><span class=\"mtk12\">local</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nomad</span><span class=\"mtk1\"> </span><span class=\"mtk12\">asset</span><span class=\"mtk1\"> </span><span class=\"mtk11\">counterparts</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">i</span><span class=\"mtk1\">.</span><span class=\"mtk12\">e</span><span class=\"mtk1\">. </span><span class=\"mtk12\">bridgable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">) </span><span class=\"mtk12\">via</span><span class=\"mtk1\"> </span><span class=\"mtk12\">the</span><span class=\"mtk1\"> </span><span class=\"mtk12\">configured</span><span class=\"mtk1\"> </span><span class=\"mtk12\">AMM</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span></span></span></code></pre>\n<ul>\n<li>addressess</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"90\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BridgeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">774</span><span class=\"mtk1\">:      </span><span class=\"mtk3\">// Save the addressess of all routers providing liquidity for this transfer.</span></span></span></code></pre>\n<ul>\n<li>a sthe</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"91\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BridgeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">1059</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">// Because we are using the `_amount` a sthe maximum amount in, the `amountIn` should always be</span></span></span></code></pre>\n<ul>\n<li>sournce</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"92\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ProposedOwnableFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">143</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">// Contract as sournce of truth</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ProposedOwnableFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">163</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">// Contract as sournce of truth</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ProposedOwnableFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">176</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">// Contract as sournce of truth</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ProposedOwnableUpgradeable</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">170</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">// Contract as sournce of truth</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ProposedOwnableUpgradeable</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">198</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">// Contract as sournce of truth</span></span></span></code></pre>\n<ul>\n<li>rlayer</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"93\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RelayerFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">35</span><span class=\"mtk1\">:   * @</span><span class=\"mtk12\">notice</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Emitted</span><span class=\"mtk1\"> </span><span class=\"mtk12\">when</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rlayer</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">added</span><span class=\"mtk1\"> </span><span class=\"mtk12\">or</span><span class=\"mtk1\"> </span><span class=\"mtk12\">removed</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\"> </span><span class=\"mtk12\">whitelists</span></span></span></code></pre>\n<ul>\n<li>specicfied</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"94\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RoutersFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">575</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">// transfer to specicfied recipient IF recipient not set</span></span></span></code></pre>\n<ul>\n<li>callabale</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"95\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Executor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">17</span><span class=\"mtk1\">: * @</span><span class=\"mtk12\">notice</span><span class=\"mtk1\"> </span><span class=\"mtk12\">This</span><span class=\"mtk1\"> </span><span class=\"mtk12\">library</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contains</span><span class=\"mtk1\"> </span><span class=\"mtk12\">an</span><span class=\"mtk1\"> </span><span class=\"mtk8\">`execute`</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">that</span><span class=\"mtk1\"> </span><span class=\"mtk11\">is</span><span class=\"mtk1\"> </span><span class=\"mtk11\">callabale</span><span class=\"mtk1\"> </span><span class=\"mtk11\">by</span></span></span></code></pre>\n<ul>\n<li>everytime</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"96\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LPToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">41</span><span class=\"mtk1\">:   * </span><span class=\"mtk12\">minting</span><span class=\"mtk1\"> </span><span class=\"mtk12\">and</span><span class=\"mtk1\"> </span><span class=\"mtk12\">burning</span><span class=\"mtk1\">. </span><span class=\"mtk12\">This</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ensures</span><span class=\"mtk1\"> </span><span class=\"mtk12\">that</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Swap</span><span class=\"mtk1\">.</span><span class=\"mtk12\">updateUserWithdrawFees</span><span class=\"mtk1\"> </span><span class=\"mtk12\">are</span><span class=\"mtk1\"> </span><span class=\"mtk12\">called</span><span class=\"mtk1\"> </span><span class=\"mtk12\">everytime</span><span class=\"mtk1\">.</span></span></span></code></pre>\n<ul>\n<li>stabelswap</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"97\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AssetLogic</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">30</span><span class=\"mtk1\">:   * @</span><span class=\"mtk12\">notice</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Check</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> </span><span class=\"mtk12\">the</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stabelswap</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">exists</span><span class=\"mtk1\"> </span><span class=\"mtk12\">or</span><span class=\"mtk1\"> </span><span class=\"mtk12\">not</span></span></span></code></pre>\n<ul>\n<li>briding</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"98\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibConnextStorage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">278</span><span class=\"mtk1\">:   * @</span><span class=\"mtk12\">notice</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Stores</span><span class=\"mtk1\"> </span><span class=\"mtk12\">whether</span><span class=\"mtk1\"> </span><span class=\"mtk12\">or</span><span class=\"mtk1\"> </span><span class=\"mtk12\">not</span><span class=\"mtk1\"> </span><span class=\"mtk12\">briding</span><span class=\"mtk1\">, </span><span class=\"mtk12\">AMMs</span><span class=\"mtk1\">, </span><span class=\"mtk12\">have</span><span class=\"mtk1\"> </span><span class=\"mtk12\">been</span><span class=\"mtk1\"> </span><span class=\"mtk12\">paused</span></span></span></code></pre>\n<ul>\n<li>identifer</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"99\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibCrossDomainProperty</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">35</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PROPERTY_LEN</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">25</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// 1 byte identifer + 4 bytes domain + 20 bytes address</span></span></span></code></pre>\n<ul>\n<li>incomming</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"100\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">promise</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PromiseRouter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">50</span><span class=\"mtk1\">:   * @</span><span class=\"mtk12\">dev</span><span class=\"mtk1\"> </span><span class=\"mtk12\">While</span><span class=\"mtk1\"> </span><span class=\"mtk12\">handling</span><span class=\"mtk1\"> </span><span class=\"mtk12\">the</span><span class=\"mtk1\"> </span><span class=\"mtk12\">message</span><span class=\"mtk1\">, </span><span class=\"mtk12\">it</span><span class=\"mtk1\"> </span><span class=\"mtk12\">will</span><span class=\"mtk1\"> </span><span class=\"mtk12\">parse</span><span class=\"mtk1\"> </span><span class=\"mtk12\">transferId</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\"> </span><span class=\"mtk12\">incomming</span><span class=\"mtk1\"> </span><span class=\"mtk12\">message</span><span class=\"mtk1\"> </span><span class=\"mtk12\">and</span><span class=\"mtk1\"> </span><span class=\"mtk12\">store</span><span class=\"mtk1\"> </span><span class=\"mtk12\">the</span><span class=\"mtk1\"> </span><span class=\"mtk12\">message</span><span class=\"mtk1\"> </span><span class=\"mtk4\">in</span><span class=\"mtk1\"> </span><span class=\"mtk12\">the</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mapping</span></span></span></code></pre>\n<h2 id=\"n-04-deprecated-library-used-for-solidity--08--safemath\" style=\"position:relative;\"><a href=\"#n-04-deprecated-library-used-for-solidity--08--safemath\" aria-label=\"n 04 deprecated library used for solidity  08  safemath permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-04] Deprecated library used for Solidity <code>>= 0.8</code> : SafeMath</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"101\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ConnextPriceOracle</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">14</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ConnextPriceOracle</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">4</span><span class=\"mtk1\">:</span><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">SafeMath</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;@openzeppelin/contracts/utils/math/SafeMath.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ConnextPriceOracle</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">45</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">using</span><span class=\"mtk1\"> </span><span class=\"mtk12\">SafeMath</span><span class=\"mtk1\"> </span><span class=\"mtk12\">for</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OZERC20</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">14</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OZERC20</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">10</span><span class=\"mtk1\">:</span><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;@openzeppelin/contracts/utils/math/SafeMath.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OZERC20</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">37</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">using</span><span class=\"mtk1\"> </span><span class=\"mtk12\">SafeMath</span><span class=\"mtk1\"> </span><span class=\"mtk12\">for</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AmplificationUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">14</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AmplificationUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">5</span><span class=\"mtk1\">:</span><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">SafeMath</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;@openzeppelin/contracts/utils/math/SafeMath.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AmplificationUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">15</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">using</span><span class=\"mtk1\"> </span><span class=\"mtk12\">SafeMath</span><span class=\"mtk1\"> </span><span class=\"mtk12\">for</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">SwapUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">14</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">SwapUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">4</span><span class=\"mtk1\">:</span><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">SafeMath</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;@openzeppelin/contracts/utils/math/SafeMath.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">SwapUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">20</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">using</span><span class=\"mtk1\"> </span><span class=\"mtk12\">SafeMath</span><span class=\"mtk1\"> </span><span class=\"mtk12\">for</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"n-05-open-todos\" style=\"position:relative;\"><a href=\"#n-05-open-todos\" aria-label=\"n 05 open todos permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-05] Open TODOS</h2>\n<p>Consider resolving the TODOs before deploying.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"102\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AssetFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">66</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">canonicalToAdopted</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_canonicalId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AssetFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">67</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">canonicalToAdopted</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_canonicalId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AssetFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">150</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">canonicalToAdopted</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_canonical</span><span class=\"mtk1\">.</span><span class=\"mtk12\">id</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">supported</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AssetFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">185</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">delete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">canonicalToAdopted</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_canonicalId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BridgeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">492</span><span class=\"mtk1\">:      </span><span class=\"mtk3\">// TODO: do we want to store a mapping of custodied token balances here?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BridgeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">579</span><span class=\"mtk1\">:      </span><span class=\"mtk3\">// TODO: do we need to keep this</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BridgeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">1027</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">// TODO: Should we call approve(0) and approve(totalRepayAmount) instead? or with a try catch to not affect gas on all cases?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Executor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">7</span><span class=\"mtk1\">:</span><span class=\"mtk3\">// TODO: see note in below file re: npm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">IConnextHandler</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">22</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">canonicalToAdopted</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_canonicalId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AssetLogic</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">204</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">adopted</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">canonicalToAdopted</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AssetLogic</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">244</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">adopted</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">canonicalToAdopted</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AssetLogic</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">376</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">adopted</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">canonicalToAdopted</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibConnextStorage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">178</span><span class=\"mtk1\">:  </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">address</span><span class=\"mtk1\">) </span><span class=\"mtk12\">canonicalToAdopted</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibConnextStorage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">303</span><span class=\"mtk1\">:  </span><span class=\"mtk3\">// BridgeFacet (cont.) TODO: can we move this</span></span></span></code></pre>\n<h2 id=\"n-06-adding-a-return-statement-when-the-function-defines-a-named-return-variable-is-redundant\" style=\"position:relative;\"><a href=\"#n-06-adding-a-return-statement-when-the-function-defines-a-named-return-variable-is-redundant\" aria-label=\"n 06 adding a return statement when the function defines a named return variable is redundant permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-06] Adding a <code>return</code> statement when the function defines a named return variable, is redundant</h2>\n<p>While not consuming more gas with the Optimizer enabled: using both named returns and a return statement isn’t necessary. Removing one of those can improve code clarity.</p>\n<p>Affected code:</p>\n<ul>\n<li>contracts/contracts/core/connext/facets/StableSwapFacet.sol:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"103\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">212</span><span class=\"mtk1\">:   ) </span><span class=\"mtk12\">external</span><span class=\"mtk1\"> </span><span class=\"mtk12\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">availableTokenAmount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">213</span><span class=\"mtk1\">:     </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">swapStorages</span><span class=\"mtk1\">[</span><span class=\"mtk12\">canonicalId</span><span class=\"mtk1\">].</span><span class=\"mtk11\">calculateWithdrawOneToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenIndex</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<ul>\n<li>contracts/contracts/core/connext/helpers/StableSwap.sol:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"104\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">295</span><span class=\"mtk1\">:     </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">availableTokenAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">297</span><span class=\"mtk1\">:     </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">swapStorage</span><span class=\"mtk1\">.</span><span class=\"mtk11\">calculateWithdrawOneToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenIndex</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"n-07-the-pragmas-used-are-not-the-same-everywhere\" style=\"position:relative;\"><a href=\"#n-07-the-pragmas-used-are-not-the-same-everywhere\" aria-label=\"n 07 the pragmas used are not the same everywhere permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-07] The pragmas used are not the same everywhere</h2>\n<p>Consider using only 1 version. Here’s an example of the different pragmas:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"105\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">upgrade</span><span class=\"mtk1\">-</span><span class=\"mtk12\">initializers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DiamondInit</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> ^</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AssetFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">14</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">IAavePool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> ^</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">11</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">shared</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Router</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.6</span><span class=\"mtk1\">.</span><span class=\"mtk7\">11</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"n-08-non-libraryinterface-files-should-use-fixed-compiler-versions-not-floating-ones\" style=\"position:relative;\"><a href=\"#n-08-non-libraryinterface-files-should-use-fixed-compiler-versions-not-floating-ones\" aria-label=\"n 08 non libraryinterface files should use fixed compiler versions not floating ones permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-08] Non-library/interface files should use fixed compiler versions, not floating ones</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"106\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">upgrade</span><span class=\"mtk1\">-</span><span class=\"mtk12\">initializers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DiamondInit</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> ^</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">shared</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Router</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.6</span><span class=\"mtk1\">.</span><span class=\"mtk7\">11</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">shared</span><span class=\"mtk1\">/</span><span class=\"mtk12\">XAppConnectionClient</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.6</span><span class=\"mtk1\">.</span><span class=\"mtk7\">11</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"n-09-missing-natspec\" style=\"position:relative;\"><a href=\"#n-09-missing-natspec\" aria-label=\"n 09 missing natspec permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-09] Missing NatSpec</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"107\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">AssetFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">121</span><span class=\"mtk1\">:   </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">122:    * </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> Used to add supported assets. This is an admin only function</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">123:    * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\"> When whitelisting the canonical asset, all representational assets would be</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">124:    * whitelisted as well. In the event you have a different adopted asset (i.e. PoS USDC</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">125:    * on polygon), you should *not* whitelist the adopted asset. The stable swap pool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">126:    * address used should allow you to swap between the local &lt;&gt; adopted asset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">127:    * </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">_canonical</span><span class=\"mtk3\"> - The canonical asset to add by id and domain. All representations</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">128:    * will be whitelisted as well</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">129:    * </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">_adoptedAssetId</span><span class=\"mtk3\"> - The used asset id for this domain (i.e. PoS USDC for</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">130:    * polygon)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">131:    */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">132</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setupAsset</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">133:     </span><span class=\"mtk10\">ConnextMessage</span><span class=\"mtk1\">.</span><span class=\"mtk10\">TokenId</span><span class=\"mtk1\"> </span><span class=\"mtk10\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_canonical</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">134:     </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_adoptedAssetId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">135:     </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_stableSwapPool</span><span class=\"mtk1\"> </span><span class=\"mtk3\">// @audit-info [INFO] NatSpec missing for _stableSwapPool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">136</span><span class=\"mtk1\">:   ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/263#issuecomment-1172807096\">jakekidd (Connext) commented</a>:</strong></p>\n<blockquote>\n<p>Great linking, great format!</p>\n<p>All of these seem non-critical except for L-14, which is acknowledged and L-02/L-11, which are valid.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/263#issuecomment-1235169506\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I would tend to agree that all of these are valid.</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 44 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/185\">report highlighted below</a> by <strong>IllIllI</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/140\">0xKitsune</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/30\">0xkatana</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/261\">BowTiedWardens</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/226\">defsec</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/52\">joestakey</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/197\">MiloTruck</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/109\">0x29A</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/210\">Metatron</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/128\">Tomio</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/119\">robee</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/195\">simon135</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/230\">UnusualTurtle</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/168\">Waze</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/141\">_Adam</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/265\">0xf15ers</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/233\">c3phas</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/137\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/6\">oyc_109</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/126\">slywaters</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/169\">TomJ</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/55\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/127\">apostle0x01</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/164\">catchup</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/179\">ElKu</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/34\">kaden</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/274\">Kaiziron</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/258\">rfa</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/24\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/58\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/264\">Fitraldys</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/42\">Lambda</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/31\">sach1r0</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/177\">SmartSek</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/77\">asutorufos</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/209\">Funen</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/200\">hyh</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/138\">ignacio</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/188\">nahnah</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/166\">Randyyy</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/107\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/272\">0xmint</a>, <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/117\">k</a>, and <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/94\">csanuragjain</a>.</em></p>\n<h2 id=\"summary-1\" style=\"position:relative;\"><a href=\"#summary-1\" aria-label=\"summary 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"left\">Issue</th>\n<th align=\"center\">Instances</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>G‑01</td>\n<td align=\"left\">Multiple <code>address</code> mappings can be combined into a single <code>mapping</code> of an <code>address</code> to a <code>struct</code>, where appropriate</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>G‑02</td>\n<td align=\"left\">State variables only set in the constructor should be declared <code>immutable</code></td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>G-03</td>\n<td align=\"left\">Structs can be packed into fewer storage slots</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>G-04</td>\n<td align=\"left\">Using <code>calldata</code> instead of <code>memory</code> for read-only arguments in <code>external</code> functions saves gas</td>\n<td align=\"center\">10</td>\n</tr>\n<tr>\n<td>G-05</td>\n<td align=\"left\">Using <code>storage</code> instead of <code>memory</code> for structs/arrays saves gas</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>G-06</td>\n<td align=\"left\">State variables should be cached in stack variables rather than re-reading them from storage</td>\n<td align=\"center\">13</td>\n</tr>\n<tr>\n<td>G-07</td>\n<td align=\"left\">Multiple accesses of a mapping/array should use a local variable cache</td>\n<td align=\"center\">13</td>\n</tr>\n<tr>\n<td>G-08</td>\n<td align=\"left\"><code>internal</code> functions only called once can be inlined to save gas</td>\n<td align=\"center\">9</td>\n</tr>\n<tr>\n<td>G-09</td>\n<td align=\"left\">Add <code>unchecked {}</code> for subtractions where the operands cannot underflow because of a previous <code>require()</code> or <code>if</code>-statement</td>\n<td align=\"center\">4</td>\n</tr>\n<tr>\n<td>G-10</td>\n<td align=\"left\"><code>&#x3C;array>.length</code> should not be looked up in every loop of a <code>for</code>-loop</td>\n<td align=\"center\">19</td>\n</tr>\n<tr>\n<td>G-11</td>\n<td align=\"left\"><code>++i</code>/<code>i++</code> should be <code>unchecked{++i}</code>/<code>unchecked{i++}</code> when it is not possible for them to overflow, as is the case when used in <code>for</code>- and <code>while</code>-loops</td>\n<td align=\"center\">26</td>\n</tr>\n<tr>\n<td>G-12</td>\n<td align=\"left\"><code>require()</code>/<code>revert()</code> strings longer than 32 bytes cost extra gas</td>\n<td align=\"center\">17</td>\n</tr>\n<tr>\n<td>G-13</td>\n<td align=\"left\">Optimize names to save gas</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td>G-14</td>\n<td align=\"left\">Using <code>bool</code>s for storage incurs overhead</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td>G-15</td>\n<td align=\"left\">Use a more recent version of solidity</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>G-16</td>\n<td align=\"left\">Using <code>> 0</code> costs more gas than <code>!= 0</code> when used on a <code>uint</code> in a <code>require()</code> statement</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>G-17</td>\n<td align=\"left\"><code>>=</code> costs less gas than <code>></code></td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>G-18</td>\n<td align=\"left\">It costs more gas to initialize non-<code>constant</code>/non-<code>immutable</code> variables to zero than to let the default of zero be applied</td>\n<td align=\"center\">22</td>\n</tr>\n<tr>\n<td>G-19</td>\n<td align=\"left\"><code>internal</code> functions not called by the contract should be removed to save deployment gas</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>G-20</td>\n<td align=\"left\"><code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</td>\n<td align=\"center\">26</td>\n</tr>\n<tr>\n<td>G-21</td>\n<td align=\"left\">Splitting <code>require()</code> statements that use <code>&#x26;&#x26;</code> saves gas</td>\n<td align=\"center\">6</td>\n</tr>\n<tr>\n<td>G-22</td>\n<td align=\"left\">Usage of <code>uints</code>/<code>ints</code> smaller than 32 bytes (256 bits) incurs overhead</td>\n<td align=\"center\">142</td>\n</tr>\n<tr>\n<td>G-23</td>\n<td align=\"left\">Using <code>private</code> rather than <code>public</code> for constants, saves gas</td>\n<td align=\"center\">6</td>\n</tr>\n<tr>\n<td>G-24</td>\n<td align=\"left\">Don’t use <code>SafeMath</code> once the solidity version is 0.8.0 or greater</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td>G-25</td>\n<td align=\"left\">Duplicated <code>require()</code>/<code>revert()</code> checks should be refactored to a modifier or function</td>\n<td align=\"center\">7</td>\n</tr>\n<tr>\n<td>G-26</td>\n<td align=\"left\">Multiple <code>if</code>-statements with mutually-exclusive conditions should be changed to <code>if</code>-<code>else</code> statements</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>G-27</td>\n<td align=\"left\"><code>require()</code> or <code>revert()</code> statements that check input arguments should be at the top of the function</td>\n<td align=\"center\">6</td>\n</tr>\n<tr>\n<td>G-28</td>\n<td align=\"left\">Empty blocks should be removed or emit something</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>G-29</td>\n<td align=\"left\">Superfluous event fields</td>\n<td align=\"center\">4</td>\n</tr>\n<tr>\n<td>G‑30</td>\n<td align=\"left\">Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</td>\n<td align=\"center\">79</td>\n</tr>\n<tr>\n<td>G‑31</td>\n<td align=\"left\">Functions guaranteed to revert when called by normal users can be marked <code>payable</code></td>\n<td align=\"center\">85</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 518 instances over 31 issues</p>\n<h2 id=\"g-01-multiple-address-mappings-can-be-combined-into-a-single-mapping-of-an-address-to-a-struct-where-appropriate\" style=\"position:relative;\"><a href=\"#g-01-multiple-address-mappings-can-be-combined-into-a-single-mapping-of-an-address-to-a-struct-where-appropriate\" aria-label=\"g 01 multiple address mappings can be combined into a single mapping of an address to a struct where appropriate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Multiple <code>address</code> mappings can be combined into a single <code>mapping</code> of an <code>address</code> to a <code>struct</code>, where appropriate</h2>\n<p>Saves a storage slot for the mapping. Depending on the circumstances and sizes of types, can avoid a Gsset (<strong>20000 gas</strong>) per mapping combined. Reads and subsequent writes can also be cheaper when a function requires both values and they both fit in the same storage slot. Finally, if both fields are accessed in the same function, can save <strong>~42 gas per access</strong> due to <a href=\"https://gist.github.com/IllIllI000/ec23a57daa30a8f8ca8b9681c8ccefb0\">not having to recalculate the key’s keccak256 hash</a> (Gkeccak256 - <strong>30 gas</strong>) and that calculation’s associated stack operations.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"108\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ConnextPriceOracle</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">62</span><span class=\"mtk1\">      </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PriceInfo</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">priceRecords</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">63</span><span class=\"mtk1\">:     </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assetPrices</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/helpers/ConnextPriceOracle.sol#L62-L63\">https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/helpers/ConnextPriceOracle.sol#L62-L63</a></p>\n<h2 id=\"g-02-state-variables-only-set-in-the-constructor-should-be-declared-immutable\" style=\"position:relative;\"><a href=\"#g-02-state-variables-only-set-in-the-constructor-should-be-declared-immutable\" aria-label=\"g 02 state variables only set in the constructor should be declared immutable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] State variables only set in the constructor should be declared <code>immutable</code></h2>\n<p>Avoids a Gsset (<strong>20000 gas</strong>) in the constructor, and replaces each Gwarmacces (<strong>100 gas</strong>) with a <code>PUSH32</code> (<strong>3 gas</strong>).</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"109\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ConnextPriceOracle</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">49</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wrapped</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/helpers/ConnextPriceOracle.sol#L49\">https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/helpers/ConnextPriceOracle.sol#L49</a></p>\n<h2 id=\"g-03-structs-can-be-packed-into-fewer-storage-slots\" style=\"position:relative;\"><a href=\"#g-03-structs-can-be-packed-into-fewer-storage-slots\" aria-label=\"g 03 structs can be packed into fewer storage slots permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] Structs can be packed into fewer storage slots</h2>\n<p>Each slot saved can avoid an extra Gsset (<strong>20000 gas</strong>) for the first setting of the struct. Subsequent reads as well as writes have smaller gas savings</p>\n<p><em>There are 2 instances of this issue. (For in-depth details on this and all further gas optimizations with multiple instances, please see the warden’s <a href=\"https://github.com/code-423n4/2022-06-connext-findings/issues/185\">full report</a>.)</em></p>\n<h2 id=\"g-04-using-calldata-instead-of-memory-for-read-only-arguments-in-external-functions-saves-gas\" style=\"position:relative;\"><a href=\"#g-04-using-calldata-instead-of-memory-for-read-only-arguments-in-external-functions-saves-gas\" aria-label=\"g 04 using calldata instead of memory for read only arguments in external functions saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] Using <code>calldata</code> instead of <code>memory</code> for read-only arguments in <code>external</code> functions saves gas</h2>\n<p>When a function with a <code>memory</code> array is called externally, the <code>abi.decode()</code> step has to use a for-loop to copy each index of the <code>calldata</code> to the <code>memory</code> index. <strong>Each iteration of this for-loop costs at least 60 gas</strong> (i.e. <code>60 * &#x3C;mem_array>.length</code>). Using <code>calldata</code> directly, obliviates the need for such a loop in the contract code and runtime execution.</p>\n<p>If the array is passed to an <code>internal</code> function which passes the array to another internal function where the array is modified and therefore <code>memory</code> is used in the <code>external</code> call, it’s still more gass-efficient to use <code>calldata</code> when the <code>external</code> function uses modifiers, since the modifiers may prevent the internal functions from being called. Structs have the same overhead as an array of length one</p>\n<p><em>There are 10 instances of this issue.</em></p>\n<h2 id=\"g-05-using-storage-instead-of-memory-for-structsarrays-saves-gas\" style=\"position:relative;\"><a href=\"#g-05-using-storage-instead-of-memory-for-structsarrays-saves-gas\" aria-label=\"g 05 using storage instead of memory for structsarrays saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] Using <code>storage</code> instead of <code>memory</code> for structs/arrays saves gas</h2>\n<p>When fetching data from a storage location, assigning the data to a <code>memory</code> variable causes all fields of the struct/array to be read from storage, which incurs a Gcoldsload (<strong>2100 gas</strong>) for <em>each</em> field of the struct/array. If the fields are read from the new memory variable, they incur an additional <code>MLOAD</code> rather than a cheap stack read. Instead of declearing the variable with the <code>memory</code> keyword, declaring the variable with the <code>storage</code> keyword and caching any fields that need to be re-read in stack variables, will be much cheaper, only incuring the Gcoldsload for the fields actually read. The only time it makes sense to read the whole struct/array into a <code>memory</code> variable, is if the full struct/array is being returned by the function, is being passed to a function that requires <code>memory</code>, or if the array/struct is being read from another <code>memory</code> array/struct</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"g-06-state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\" style=\"position:relative;\"><a href=\"#g-06-state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\" aria-label=\"g 06 state variables should be cached in stack variables rather than re reading them from storage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] State variables should be cached in stack variables rather than re-reading them from storage</h2>\n<p>The instances below point to the second+ access of a state variable within a function. Caching of a state variable replace each Gwarmaccess (<strong>100 gas</strong>) with a much cheaper stack read. Other less obvious fixes/optimizations include having local memory caches of state variable structs, or having local caches of state variable contracts/addresses.</p>\n<p><em>There are 13 instances of this issue.</em></p>\n<h2 id=\"g-07-multiple-accesses-of-a-mappingarray-should-use-a-local-variable-cache\" style=\"position:relative;\"><a href=\"#g-07-multiple-accesses-of-a-mappingarray-should-use-a-local-variable-cache\" aria-label=\"g 07 multiple accesses of a mappingarray should use a local variable cache permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-07] Multiple accesses of a mapping/array should use a local variable cache</h2>\n<p>The instances below point to the second+ access of a value inside a mapping/array, within a function. Caching a mapping’s value in a local <code>storage</code> or <code>calldata</code> variable when the value is accessed <a href=\"https://gist.github.com/IllIllI000/ec23a57daa30a8f8ca8b9681c8ccefb0\">multiple times</a>, saves <strong>~42 gas per access</strong> due to not having to recalculate the key’s keccak256 hash (Gkeccak256 - <strong>30 gas</strong>) and that calculation’s associated stack operations. Caching an array’s struct avoids recalculating the array offsets into memory/calldata</p>\n<p><em>There are 13 instances of this issue.</em></p>\n<h2 id=\"g-08-internal-functions-only-called-once-can-be-inlined-to-save-gas\" style=\"position:relative;\"><a href=\"#g-08-internal-functions-only-called-once-can-be-inlined-to-save-gas\" aria-label=\"g 08 internal functions only called once can be inlined to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-08] <code>internal</code> functions only called once can be inlined to save gas</h2>\n<p>Not inlining costs <strong>20 to 40 gas</strong> because of two extra <code>JUMP</code> instructions and additional stack operations needed for function calls.</p>\n<p><em>There are 9 instances of this issue.</em></p>\n<h2 id=\"g-09-add-unchecked--for-subtractions-where-the-operands-cannot-underflow-because-of-a-previous-require-or-if-statement\" style=\"position:relative;\"><a href=\"#g-09-add-unchecked--for-subtractions-where-the-operands-cannot-underflow-because-of-a-previous-require-or-if-statement\" aria-label=\"g 09 add unchecked  for subtractions where the operands cannot underflow because of a previous require or if statement permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-09] Add <code>unchecked {}</code> for subtractions where the operands cannot underflow because of a previous <code>require()</code> or <code>if</code>-statement</h2>\n<p><code>require(a &#x3C;= b); x = b - a</code> => <code>require(a &#x3C;= b); unchecked { x = b - a }</code></p>\n<p><em>There are 4 instances of this issue.</em></p>\n<h2 id=\"g-10-arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\" style=\"position:relative;\"><a href=\"#g-10-arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\" aria-label=\"g 10 arraylength should not be looked up in every loop of a for loop permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-10] <code>&#x3C;array>.length</code> should not be looked up in every loop of a <code>for</code>-loop</h2>\n<p>The overheads outlined below are <em>PER LOOP</em>, excluding the first loop</p>\n<ul>\n<li>storage arrays incur a Gwarmaccess (<strong>100 gas</strong>)</li>\n<li>memory arrays use <code>MLOAD</code> (<strong>3 gas</strong>)</li>\n<li>calldata arrays use <code>CALLDATALOAD</code> (<strong>3 gas</strong>)</li>\n</ul>\n<p>Caching the length changes each of these to a <code>DUP&#x3C;N></code> (<strong>3 gas</strong>), and gets rid of the extra <code>DUP&#x3C;N></code> needed to store the stack offset</p>\n<p><em>There are 19 instances of this issue.</em></p>\n<h2 id=\"g-11-ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for--and-while-loops\" style=\"position:relative;\"><a href=\"#g-11-ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for--and-while-loops\" aria-label=\"g 11 ii should be uncheckediuncheckedi when it is not possible for them to overflow as is the case when used in for  and while loops permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-11] <code>++i</code>/<code>i++</code> should be <code>unchecked{++i}</code>/<code>unchecked{i++}</code> when it is not possible for them to overflow, as is the case when used in <code>for</code>- and <code>while</code>-loops</h2>\n<p>The <code>unchecked</code> keyword is new in solidity version 0.8.0, so this only applies to that version or higher, which these instances are. This saves <strong>30-40 gas <a href=\"https://gist.github.com/hrkrshnn/ee8fabd532058307229d65dcd5836ddc#the-increment-in-for-loop-post-condition-can-be-made-unchecked\">per loop</a></strong></p>\n<p><em>There are 26 instances of this issue.</em></p>\n<h2 id=\"g-12-requirerevert-strings-longer-than-32-bytes-cost-extra-gas\" style=\"position:relative;\"><a href=\"#g-12-requirerevert-strings-longer-than-32-bytes-cost-extra-gas\" aria-label=\"g 12 requirerevert strings longer than 32 bytes cost extra gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-12] <code>require()</code>/<code>revert()</code> strings longer than 32 bytes cost extra gas</h2>\n<p>Each extra memory word of bytes past the original 32 <a href=\"https://gist.github.com/hrkrshnn/ee8fabd532058307229d65dcd5836ddc#consider-having-short-revert-strings\">incurs an MSTORE</a> which costs <strong>3 gas</strong></p>\n<p><em>There are 17 instances of this issue.</em></p>\n<h2 id=\"g-13-optimize-names-to-save-gas\" style=\"position:relative;\"><a href=\"#g-13-optimize-names-to-save-gas\" aria-label=\"g 13 optimize names to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-13] Optimize names to save gas</h2>\n<p><code>public</code>/<code>external</code> function names and <code>public</code> member variable names can be optimized to save gas. See <a href=\"https://gist.github.com/IllIllI000/a5d8b486a8259f9f77891a919febd1a9\">this</a> link for an example of how it works. Below are the interfaces/abstract contracts that can be optimized so that the most frequently-called functions use the least amount of gas possible during method lookup. Method IDs that have two leading zero bytes can save <strong>128 gas</strong> each during deployment, and renaming functions to have lower method IDs will save <strong>22 gas</strong> per call, <a href=\"https://medium.com/joyso/solidity-how-does-function-name-affect-gas-consumption-in-smart-contract-47d270d8ac92\">per sorted position shifted</a></p>\n<p><em>There are 3 instances of this issue.</em></p>\n<h2 id=\"g-14-using-bools-for-storage-incurs-overhead\" style=\"position:relative;\"><a href=\"#g-14-using-bools-for-storage-incurs-overhead\" aria-label=\"g 14 using bools for storage incurs overhead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-14] Using <code>bool</code>s for storage incurs overhead</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"110\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Booleans are more expensive than uint256 or any type that takes up a full</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// word because each write operation emits an extra SLOAD to first read the</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// slot&#39;s contents, replace the bits taken up by the boolean, and then write</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// back. This is the compiler&#39;s defense against contract upgrades and</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// pointer aliasing, and it cannot be disabled.</span></span></span></code></pre>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27\">https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27</a>\nUse <code>uint256(1)</code> and <code>uint256(2)</code> for true/false to avoid a Gwarmaccess (<strong><a href=\"https://gist.github.com/IllIllI000/1b70014db712f8572a72378321250058\">100 gas</a></strong>) for the extra SLOAD, and to avoid Gsset (<strong>20000 gas</strong>) when changing from ‘false’ to ‘true’, after having been ‘true’ in the past</p>\n<p><em>There are 3 instances of this issue.</em></p>\n<h2 id=\"g-15-use-a-more-recent-version-of-solidity\" style=\"position:relative;\"><a href=\"#g-15-use-a-more-recent-version-of-solidity\" aria-label=\"g 15 use a more recent version of solidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-15] Use a more recent version of solidity</h2>\n<p>Use a solidity version of at least 0.8.2 to get simple compiler automatic inlining\nUse a solidity version of at least 0.8.3 to get better struct packing and cheaper multiple storage reads\nUse a solidity version of at least 0.8.4 to get custom errors, which are cheaper at deployment than <code>revert()/require()</code> strings\nUse a solidity version of at least 0.8.10 to have external calls skip contract existence checks if the external call has a return value</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"111\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">upgrade</span><span class=\"mtk1\">-</span><span class=\"mtk12\">initializers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DiamondInit</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">2</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> ^</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/upgrade-initializers/DiamondInit.sol#L2\">https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/facets/upgrade-initializers/DiamondInit.sol#L2</a></p>\n<h2 id=\"g-16-using--0-costs-more-gas-than--0-when-used-on-a-uint-in-a-require-statement\" style=\"position:relative;\"><a href=\"#g-16-using--0-costs-more-gas-than--0-when-used-on-a-uint-in-a-require-statement\" aria-label=\"g 16 using  0 costs more gas than  0 when used on a uint in a require statement permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-16] Using <code>> 0</code> costs more gas than <code>!= 0</code> when used on a <code>uint</code> in a <code>require()</code> statement</h2>\n<p>This change saves <strong><a href=\"https://aws1.discourse-cdn.com/business6/uploads/zeppelin/original/2X/3/363a367d6d68851f27d2679d10706cd16d788b96.png\">6 gas</a></strong> per instance. The optimization works until solidity version <a href=\"https://gist.github.com/IllIllI000/bf2c3120f24a69e489f12b3213c06c94\">0.8.13</a> where there is a regression in gas costs.</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"g-17--costs-less-gas-than-\" style=\"position:relative;\"><a href=\"#g-17--costs-less-gas-than-\" aria-label=\"g 17  costs less gas than  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-17] <code>>=</code> costs less gas than <code>></code></h2>\n<p>The compiler uses opcodes <code>GT</code> and <code>ISZERO</code> for solidity code that uses <code>></code>, but only requires <code>LT</code> for <code>>=</code>, <a href=\"https://gist.github.com/IllIllI000/3dc79d25acccfa16dee4e83ffdc6ffde\">which saves <strong>3 gas</strong></a></p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"g-18-it-costs-more-gas-to-initialize-non-constantnon-immutable-variables-to-zero-than-to-let-the-default-of-zero-be-applied\" style=\"position:relative;\"><a href=\"#g-18-it-costs-more-gas-to-initialize-non-constantnon-immutable-variables-to-zero-than-to-let-the-default-of-zero-be-applied\" aria-label=\"g 18 it costs more gas to initialize non constantnon immutable variables to zero than to let the default of zero be applied permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-18] It costs more gas to initialize non-<code>constant</code>/non-<code>immutable</code> variables to zero than to let the default of zero be applied</h2>\n<p>Not overwriting the default for <a href=\"https://gist.github.com/IllIllI000/e075d189c1b23dce256cd166e28f3397\">stack variables</a> saves <strong>8 gas</strong>. Storage and memory variables have larger savings</p>\n<p><em>There are 22 instances of this issue.</em></p>\n<h2 id=\"g-19-internal-functions-not-called-by-the-contract-should-be-removed-to-save-deployment-gas\" style=\"position:relative;\"><a href=\"#g-19-internal-functions-not-called-by-the-contract-should-be-removed-to-save-deployment-gas\" aria-label=\"g 19 internal functions not called by the contract should be removed to save deployment gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-19] <code>internal</code> functions not called by the contract should be removed to save deployment gas</h2>\n<p>If the functions are required by an interface, the contract should inherit from that interface and use the <code>override</code> keyword</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"g-20-i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\" style=\"position:relative;\"><a href=\"#g-20-i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\" aria-label=\"g 20 i costs less gas than i especially when its used in for loops   ii   too permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-20] <code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</h2>\n<p>Saves <strong>6 gas per loop</strong></p>\n<p><em>There are 26 instances of this issue.</em></p>\n<h2 id=\"g-21-splitting-require-statements-that-use--saves-gas\" style=\"position:relative;\"><a href=\"#g-21-splitting-require-statements-that-use--saves-gas\" aria-label=\"g 21 splitting require statements that use  saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-21] Splitting <code>require()</code> statements that use <code>&#x26;&#x26;</code> saves gas</h2>\n<p>See <a href=\"https://github.com/code-423n4/2022-01-xdefi-findings/issues/128\">this issue</a> which describes the fact that there is a larger deployment gas cost, but with enough runtime calls, the change ends up being cheaper</p>\n<p><em>There are 6 instances of this issue.</em></p>\n<h2 id=\"g-22-usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\" style=\"position:relative;\"><a href=\"#g-22-usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\" aria-label=\"g 22 usage of uintsints smaller than 32 bytes 256 bits incurs overhead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-22] Usage of <code>uints</code>/<code>ints</code> smaller than 32 bytes (256 bits) incurs overhead</h2>\n<blockquote>\n<p>When using elements that are smaller than 32 bytes, your contract’s gas usage may be higher. This is because the EVM operates on 32 bytes at a time. Therefore, if the element is smaller than that, the EVM must use more operations in order to reduce the size of the element from 32 bytes to the desired size.</p>\n</blockquote>\n<p><a href=\"https://docs.soliditylang.org/en/v0.8.11/internals/layout_in_storage.html\">https://docs.soliditylang.org/en/v0.8.11/internals/layout_in_storage.html</a>\nUse a larger size then downcast where needed</p>\n<p><em>There are 142 instances of this issue.</em></p>\n<h2 id=\"g-23-using-private-rather-than-public-for-constants-saves-gas\" style=\"position:relative;\"><a href=\"#g-23-using-private-rather-than-public-for-constants-saves-gas\" aria-label=\"g 23 using private rather than public for constants saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-23] Using <code>private</code> rather than <code>public</code> for constants, saves gas</h2>\n<p>If needed, the value can be read from the verified contract source code. Saves <strong>3406-3606 gas</strong> in deployment gas due to the compiler not having to create non-payable getter functions for deployment calldata, not having to store the bytes of the value outside of where it’s used, and not adding another entry to the method ID table</p>\n<p><em>There are 6 instances of this issue.</em></p>\n<h2 id=\"g-24-dont-use-safemath-once-the-solidity-version-is-080-or-greater\" style=\"position:relative;\"><a href=\"#g-24-dont-use-safemath-once-the-solidity-version-is-080-or-greater\" aria-label=\"g 24 dont use safemath once the solidity version is 080 or greater permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-24] Don’t use <code>SafeMath</code> once the solidity version is 0.8.0 or greater</h2>\n<p>Version 0.8.0 introduces internal overflow checks, so using <code>SafeMath</code> is redundant and adds overhead</p>\n<p><em>There are 3 instances of this issue.</em></p>\n<h2 id=\"g-25-duplicated-requirerevert-checks-should-be-refactored-to-a-modifier-or-function\" style=\"position:relative;\"><a href=\"#g-25-duplicated-requirerevert-checks-should-be-refactored-to-a-modifier-or-function\" aria-label=\"g 25 duplicated requirerevert checks should be refactored to a modifier or function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-25] Duplicated <code>require()</code>/<code>revert()</code> checks should be refactored to a modifier or function</h2>\n<p>Saves deployment costs</p>\n<p><em>There are 7 instances of this issue.</em></p>\n<h2 id=\"g-26-multiple-if-statements-with-mutually-exclusive-conditions-should-be-changed-to-if-else-statements\" style=\"position:relative;\"><a href=\"#g-26-multiple-if-statements-with-mutually-exclusive-conditions-should-be-changed-to-if-else-statements\" aria-label=\"g 26 multiple if statements with mutually exclusive conditions should be changed to if else statements permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-26] Multiple <code>if</code>-statements with mutually-exclusive conditions should be changed to <code>if</code>-<code>else</code> statements</h2>\n<p>If two conditions are the same, their blocks should be combined</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"112\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">connext</span><span class=\"mtk1\">/</span><span class=\"mtk12\">helpers</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ConnextPriceOracle</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">87</span><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">tokenPrice</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">88</span><span class=\"mtk1\">          </span><span class=\"mtk12\">tokenPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getPriceFromOracle</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">89</span><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">90</span><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">tokenPrice</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">91</span><span class=\"mtk1\">          </span><span class=\"mtk12\">tokenPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getPriceFromDex</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">92</span><span class=\"mtk1\">:       }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/helpers/ConnextPriceOracle.sol#L87-L92\">https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/connext/helpers/ConnextPriceOracle.sol#L87-L92</a></p>\n<h2 id=\"g-27-require-or-revert-statements-that-check-input-arguments-should-be-at-the-top-of-the-function\" style=\"position:relative;\"><a href=\"#g-27-require-or-revert-statements-that-check-input-arguments-should-be-at-the-top-of-the-function\" aria-label=\"g 27 require or revert statements that check input arguments should be at the top of the function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-27] <code>require()</code> or <code>revert()</code> statements that check input arguments should be at the top of the function</h2>\n<p>Checks that involve constants should come before checks that involve state variables</p>\n<p><em>There are 6 instances of this issue.</em></p>\n<h2 id=\"g-28-empty-blocks-should-be-removed-or-emit-something\" style=\"position:relative;\"><a href=\"#g-28-empty-blocks-should-be-removed-or-emit-something\" aria-label=\"g 28 empty blocks should be removed or emit something permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-28] Empty blocks should be removed or emit something</h2>\n<p>The code should be refactored such that they no longer exist, or the block should do something useful, such as emitting an event or reverting. If the contract is meant to be extended, the contract should be <code>abstract</code> and the function signatures be added without any default implementation. If the block is an empty <code>if</code>-statement block to avoid doing subsequent checks in the else-if/else conditions, the else-if/else conditions should be nested under the negation of the if-statement, because they involve different classes of checks, which may lead to the introduction of errors when the code is later modified (<code>if(x){}else if(y){...}else{...}</code> => <code>if(!x){if(y){...}else{...}}</code>)</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"113\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">promise</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PromiseRouter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">132</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">receive</span><span class=\"mtk1\">() </span><span class=\"mtk12\">external</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payable</span><span class=\"mtk1\"> {}</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/promise/PromiseRouter.sol#L132\">https://github.com/code-423n4/2022-06-connext/blob/4dd6149748b635f95460d4c3924c7e3fb6716967/contracts/contracts/core/promise/PromiseRouter.sol#L132</a></p>\n<h2 id=\"g-29-superfluous-event-fields\" style=\"position:relative;\"><a href=\"#g-29-superfluous-event-fields\" aria-label=\"g 29 superfluous event fields permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-29] Superfluous event fields</h2>\n<p><code>block.timestamp</code> and <code>block.number</code> are added to event information by default so adding them manually wastes gas</p>\n<p><em>There are 4 instances of this issue.</em></p>\n<h2 id=\"g-30-use-custom-errors-rather-than-revertrequire-strings-to-save-gas\" style=\"position:relative;\"><a href=\"#g-30-use-custom-errors-rather-than-revertrequire-strings-to-save-gas\" aria-label=\"g 30 use custom errors rather than revertrequire strings to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-30] Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</h2>\n<p>Custom errors are available from solidity version 0.8.4. Custom errors save <a href=\"https://gist.github.com/IllIllI000/ad1bd0d29a0101b25e57c293b4b0c746\"><strong>~50 gas</strong></a> each time they’re hitby <a href=\"https://blog.soliditylang.org/2021/04/21/custom-errors/#errors-in-depth\">avoiding having to allocate and store the revert string</a>. Not defining the strings also save deployment gas</p>\n<p><em>There are 79 instances of this issue.</em></p>\n<h2 id=\"g-31-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" style=\"position:relative;\"><a href=\"#g-31-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" aria-label=\"g 31 functions guaranteed to revert when called by normal users can be marked payable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-31] Functions guaranteed to revert when called by normal users can be marked <code>payable</code></h2>\n<p>If a function modifier such as <code>onlyOwner</code> is used, the function will revert if a normal user tries to pay the function. Marking the function as <code>payable</code> will lower the gas cost for legitimate callers because the compiler will not include checks for whether a payment was provided. The extra opcodes avoided are\n<code>CALLVALUE</code>(2),<code>DUP1</code>(3),<code>ISZERO</code>(3),<code>PUSH2</code>(3),<code>JUMPI</code>(10),<code>PUSH1</code>(3),<code>DUP1</code>(3),<code>REVERT</code>(0),<code>JUMPDEST</code>(1),<code>POP</code>(2), which costs an average of about <strong>21 gas per call</strong> to the function, in addition to the extra deployment cost</p>\n<p><em>There are 85 instances of this issue.</em></p>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-6\">High Risk Findings (6)</a></p>\n<ul>\n<li><a href=\"#h-01-portcalfacetrepayaaveportal-can-trigger-an-underflow-of-routerbalances\">[H-01] <code>PortcalFacet.repayAavePortal()</code> can trigger an underflow of <code>routerBalances</code></a></li>\n<li><a href=\"#h-02-wrong-implementation-of-withdrawadminfees-can-cause-the-adminfees-to-be-charged-multiple-times-and-therefore-cause-users-fund-loss\">[H-02] Wrong implementation of <code>withdrawAdminFees()</code> can cause the <code>adminFees</code> to be charged multiple times and therefore cause users’ fund loss</a></li>\n<li><a href=\"#h-03-router-owner-could-steal-all-the-funds-within-sponsorvault\">[H-03] Router Owner Could Steal All The Funds Within <code>SponsorVault</code></a></li>\n<li><a href=\"#h-04-in-execute-the-amount-routers-pay-is-what-user-signed-but-in-_reconcile-the-amount-routers-get-is-what-nomad-sends-and-these-two-amounts-are-not-necessary-equal-because-of-slippage-in-original-domain\">[H-04] In <code>execute()</code> the amount routers pay is what user signed, but in <code>_reconcile()</code> the amount routers get is what nomad sends and these two amounts are not necessary equal because of slippage in original domain</a></li>\n<li><a href=\"#h-05-routers-are-not-enforced-to-repay-aave-portal-loan\">[H-05] Routers are not Enforced to Repay AAVE Portal Loan</a></li>\n<li><a href=\"#h-06-malicious-relayer-can-replay-execute-calldata-on-different-chains-causing-double-spend-issue\">[H-06] Malicious Relayer can Replay Execute Calldata on Different Chains Causing Double-Spend Issue</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-20\">Medium Risk Findings (20)</a></p>\n<ul>\n<li><a href=\"#m-01-relayer-will-not-receive-any-fee-if-execute-reverts\">[M-01] Relayer Will Not Receive Any Fee If <code>execute</code> Reverts</a></li>\n<li><a href=\"#m-02-diamond-upgrade-proposition-can-be-falsified\">[M-02] Diamond upgrade proposition can be falsified</a></li>\n<li><a href=\"#m-03-malicious-relayer-could-exploit-sponsor-vaults\">[M-03] Malicious relayer could exploit sponsor vaults</a></li>\n<li><a href=\"#m-04-libdiamonddiamondcut-should-check-diamondstorageacceptancetimeskeccak256abiencode_diamondcut--0\">[M-04] <code>LibDiamond.diamondCut()</code> should check <code>diamondStorage().acceptanceTimes[keccak256(abi.encode(_diamondCut))] != 0</code></a></li>\n<li><a href=\"#m-05-did-not-approve-to-zero-first-causing-certain-token-transfer-to-fail\">[M-05] Did Not Approve To Zero First Causing Certain Token Transfer To Fail</a></li>\n<li><a href=\"#m-06-_handleexecutetransaction-may-not-working-correctly-on-fee-on-transfer-tokens-moreover-if-it-is-failed-fund-may-be-locked-forever\">[M-06] _<code>handleExecuteTransaction</code> may not working correctly on fee-on-transfer tokens. Moreover, if it is failed, fund may be locked forever.</a></li>\n<li><a href=\"#m-07-current-implementation-of-arbitrary-call-execute-failure-handler-may-break-some-use-case-for-example-nft-bridge\">[M-07] Current implementation of arbitrary call execute failure handler may break some use case for example NFT bridge.</a></li>\n<li><a href=\"#m-08-malicious-relayer-could-cause-a-router-to-provide-more-liquidity-than-it-should\">[M-08] Malicious Relayer Could Cause A Router To Provide More Liquidity Than It Should</a></li>\n<li><a href=\"#m-09-malicious-relayers-could-favor-their-routers\">[M-09] Malicious Relayers Could Favor Their Routers</a></li>\n<li><a href=\"#m-10-router-owner-could-be-rugged-by-admin\">[M-10] Router Owner Could Be Rugged By Admin</a></li>\n<li><a href=\"#m-11-tokens-with-decimals-larger-than-18-are-not-supported\">[M-11] Tokens with <code>decimals</code> larger than <code>18</code> are not supported</a></li>\n<li><a href=\"#m-12-incorrect-adopted-mapping-on-updating-wrapper-token\">[M-12] Incorrect Adopted mapping on updating wrapper token</a></li>\n<li><a href=\"#m-13-missing-whennotpaused-modifier\">[M-13] Missing <code>whenNotPaused</code> modifier</a></li>\n<li><a href=\"#m-14-single-error-within-sponsorvault-contract-could-cause-entire-cross-chain-communication-to-break-down\">[M-14] Single Error Within <code>SponsorVault</code> Contract Could Cause Entire Cross-Chain Communication To Break Down</a></li>\n<li><a href=\"#m-15-bridgefacets-_executeportaltransfer-ignores-underlying-token-amount-withdrawn-from-aave-pool\">[M-15] BridgeFacet’s <code>_executePortalTransfer</code> ignores underlying token amount withdrawn from Aave pool</a></li>\n<li><a href=\"#m-16-division-rounding-error-in-_handleexecuteliquidity-and-_reconcile-make-routerbalances-and-contract-fund-balance-to-get-out-of-sync-and-cause-fund-lose\">[M-16] division rounding error in <code>_handleExecuteLiquidity()</code> and <code>_reconcile()</code> make <code>routerBalances</code> and contract fund balance to get out of sync and cause fund lose</a></li>\n<li><a href=\"#m-17-swaps-done-internally-will-be-not-be-possible\">[M-17] Swaps done internally will be not be possible</a></li>\n<li><a href=\"#m-18-repaying-aave-loan-in-_local-rather-than-adopted-asset\">[M-18] Repaying AAVE Loan in <code>_local</code> rather than <code>adopted</code> asset</a></li>\n<li><a href=\"#m-19-attacker-can-perform-griefing-for-process-in-promiserouter-by-reverting-calls-to-callback-in-callbackaddress\">[M-19] Attacker can perform griefing for <code>process()</code> in <code>PromiseRouter</code> by reverting calls to <code>callback()</code> in <code>callbackAddress</code></a></li>\n<li><a href=\"#m-20-in-reimburseliquidityfees-of-sponservault-contract-swaps-tokens-without-slippage-limit-so-its-possible-to-perform-sandwich-attack-and-it-create-mev\">[M-20] In <code>reimburseLiquidityFees()</code> of <code>SponserVault</code> contract swaps tokens without slippage limit so its possible to perform sandwich attack and it create MEV</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#table-of-contents\">Table of Contents</a></li>\n<li><a href=\"#l-01-al-fee-and-adminfee-cannot-be-set-the-their-maximum-value\">L-01 <code>al</code>, <code>fee</code> and <code>adminFee</code> cannot be set the their maximum value</a></li>\n<li><a href=\"#l-02-add-constructor-initializers\">L-02 Add constructor initializers</a></li>\n<li><a href=\"#l-03-unsafe-casting-may-overflow\">L-03 Unsafe casting may overflow</a></li>\n<li><a href=\"#l-04-uninitialized-upgradeable-contract\">L-04 Uninitialized Upgradeable contract</a></li>\n<li><a href=\"#l-05-deprecated-safeapprove-function\">L-05 Deprecated safeApprove() function</a></li>\n<li><a href=\"#l-06-missing-address0-checks\">L-06 Missing address(0) checks</a></li>\n<li><a href=\"#l-07-misleading-comment\">L-07 Misleading comment</a></li>\n<li><a href=\"#l-08-add-a-timelock-to-critical-functions\">L-08 Add a timelock to critical functions</a></li>\n<li><a href=\"#l-09-abiencodepacked-should-not-be-used-with-dynamic-types-when-passing-the-result-to-a-hash-function-such-as-keccak256\">L-09 <code>abi.encodePacked()</code> should not be used with dynamic types when passing the result to a hash function such as <code>keccak256()</code></a></li>\n<li><a href=\"#l-10-upgradeable-contract-is-missing-a-__gap50-storage-variable-to-allow-for-new-storage-variables-in-later-versions\">L-10 Upgradeable contract is missing a <code>__gap[50]</code> storage variable to allow for new storage variables in later versions</a></li>\n<li><a href=\"#l-11-all-initialize-functions-are-front-runnable-in-the-solution\">L-11 All <code>initialize()</code> functions are front-runnable in the solution</a></li>\n<li><a href=\"#l-12-use-the-same-revert-string-for-consistency-when-testing-the-same-condition\">L-12 Use the same revert string for consistency when testing the same condition</a></li>\n<li><a href=\"#l-13-use-a-constant-instead-of-duplicating-the-same-string\">L-13 Use a <code>constant</code> instead of duplicating the same string</a></li>\n<li><a href=\"#l-14-use-a-2-step-ownership-transfer-pattern\">L-14 Use a 2-step ownership transfer pattern</a></li>\n<li><a href=\"#l-15-a-magic-number-should-be-documented-and-explained-use-a-constant-instead\">L-15 A magic number should be documented and explained. Use a <code>constant</code> instead</a></li>\n<li><a href=\"#l-16-lack-of-event-emission-for-operation-changing-the-state\">L-16 Lack of event emission for operation changing the state</a></li>\n<li><a href=\"#n-01-its-better-to-emit-after-all-processing-is-done\">N-01 It’s better to emit after all processing is done</a></li>\n<li><a href=\"#n-02-the-nonreentrant-modifier-should-occur-before-all-other-modifiers\">N-02 The <code>nonReentrant</code> <code>modifier</code> should occur before all other modifiers</a></li>\n<li><a href=\"#n-03-typos\">N-03 Typos</a></li>\n<li><a href=\"#n-04-deprecated-library-used-for-solidity--08--safemath\">N-04 Deprecated library used for Solidity <code>>= 0.8</code> : SafeMath</a></li>\n<li><a href=\"#n-05-open-todos\">N-05 Open TODOS</a></li>\n<li><a href=\"#n-06-adding-a-return-statement-when-the-function-defines-a-named-return-variable-is-redundant\">N-06 Adding a <code>return</code> statement when the function defines a named return variable, is redundant</a></li>\n<li><a href=\"#n-07-the-pragmas-used-are-not-the-same-everywhere\">N-07 The pragmas used are not the same everywhere</a></li>\n<li><a href=\"#n-08-non-libraryinterface-files-should-use-fixed-compiler-versions-not-floating-ones\">N-08 Non-library/interface files should use fixed compiler versions, not floating ones</a></li>\n<li><a href=\"#n-09-missing-natspec\">N-09 Missing NatSpec</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#summary-1\">Summary</a></li>\n<li><a href=\"#g-01-multiple-address-mappings-can-be-combined-into-a-single-mapping-of-an-address-to-a-struct-where-appropriate\">G-01 Multiple <code>address</code> mappings can be combined into a single <code>mapping</code> of an <code>address</code> to a <code>struct</code>, where appropriate</a></li>\n<li><a href=\"#g-02-state-variables-only-set-in-the-constructor-should-be-declared-immutable\">G-02 State variables only set in the constructor should be declared <code>immutable</code></a></li>\n<li><a href=\"#g-03-structs-can-be-packed-into-fewer-storage-slots\">G-03 Structs can be packed into fewer storage slots</a></li>\n<li><a href=\"#g-04-using-calldata-instead-of-memory-for-read-only-arguments-in-external-functions-saves-gas\">G-04 Using <code>calldata</code> instead of <code>memory</code> for read-only arguments in <code>external</code> functions saves gas</a></li>\n<li><a href=\"#g-05-using-storage-instead-of-memory-for-structsarrays-saves-gas\">G-05 Using <code>storage</code> instead of <code>memory</code> for structs/arrays saves gas</a></li>\n<li><a href=\"#g-06-state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\">G-06 State variables should be cached in stack variables rather than re-reading them from storage</a></li>\n<li><a href=\"#g-07-multiple-accesses-of-a-mappingarray-should-use-a-local-variable-cache\">G-07 Multiple accesses of a mapping/array should use a local variable cache</a></li>\n<li><a href=\"#g-08-internal-functions-only-called-once-can-be-inlined-to-save-gas\">G-08 <code>internal</code> functions only called once can be inlined to save gas</a></li>\n<li><a href=\"#g-09-add-unchecked--for-subtractions-where-the-operands-cannot-underflow-because-of-a-previous-require-or-if-statement\">G-09 Add <code>unchecked {}</code> for subtractions where the operands cannot underflow because of a previous <code>require()</code> or <code>if</code>-statement</a></li>\n<li><a href=\"#g-10-arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\">G-10 <code>&#x3C;array>.length</code> should not be looked up in every loop of a <code>for</code>-loop</a></li>\n<li><a href=\"#g-11-ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for--and-while-loops\">G-11 <code>++i</code>/<code>i++</code> should be <code>unchecked{++i}</code>/<code>unchecked{i++}</code> when it is not possible for them to overflow, as is the case when used in <code>for</code>- and <code>while</code>-loops</a></li>\n<li><a href=\"#g-12-requirerevert-strings-longer-than-32-bytes-cost-extra-gas\">G-12 <code>require()</code>/<code>revert()</code> strings longer than 32 bytes cost extra gas</a></li>\n<li><a href=\"#g-13-optimize-names-to-save-gas\">G-13 Optimize names to save gas</a></li>\n<li><a href=\"#g-14-using-bools-for-storage-incurs-overhead\">G-14 Using <code>bool</code>s for storage incurs overhead</a></li>\n<li><a href=\"#g-15-use-a-more-recent-version-of-solidity\">G-15 Use a more recent version of solidity</a></li>\n<li><a href=\"#g-16-using--0-costs-more-gas-than--0-when-used-on-a-uint-in-a-require-statement\">G-16 Using <code>> 0</code> costs more gas than <code>!= 0</code> when used on a <code>uint</code> in a <code>require()</code> statement</a></li>\n<li><a href=\"#g-17--costs-less-gas-than-\">G-17 <code>>=</code> costs less gas than <code>></code></a></li>\n<li><a href=\"#g-18-it-costs-more-gas-to-initialize-non-constantnon-immutable-variables-to-zero-than-to-let-the-default-of-zero-be-applied\">G-18 It costs more gas to initialize non-<code>constant</code>/non-<code>immutable</code> variables to zero than to let the default of zero be applied</a></li>\n<li><a href=\"#g-19-internal-functions-not-called-by-the-contract-should-be-removed-to-save-deployment-gas\">G-19 <code>internal</code> functions not called by the contract should be removed to save deployment gas</a></li>\n<li><a href=\"#g-20-i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\">G-20 <code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</a></li>\n<li><a href=\"#g-21-splitting-require-statements-that-use--saves-gas\">G-21 Splitting <code>require()</code> statements that use <code>&#x26;&#x26;</code> saves gas</a></li>\n<li><a href=\"#g-22-usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\">G-22 Usage of <code>uints</code>/<code>ints</code> smaller than 32 bytes (256 bits) incurs overhead</a></li>\n<li><a href=\"#g-23-using-private-rather-than-public-for-constants-saves-gas\">G-23 Using <code>private</code> rather than <code>public</code> for constants, saves gas</a></li>\n<li><a href=\"#g-24-dont-use-safemath-once-the-solidity-version-is-080-or-greater\">G-24 Don’t use <code>SafeMath</code> once the solidity version is 0.8.0 or greater</a></li>\n<li><a href=\"#g-25-duplicated-requirerevert-checks-should-be-refactored-to-a-modifier-or-function\">G-25 Duplicated <code>require()</code>/<code>revert()</code> checks should be refactored to a modifier or function</a></li>\n<li><a href=\"#g-26-multiple-if-statements-with-mutually-exclusive-conditions-should-be-changed-to-if-else-statements\">G-26 Multiple <code>if</code>-statements with mutually-exclusive conditions should be changed to <code>if</code>-<code>else</code> statements</a></li>\n<li><a href=\"#g-27-require-or-revert-statements-that-check-input-arguments-should-be-at-the-top-of-the-function\">G-27 <code>require()</code> or <code>revert()</code> statements that check input arguments should be at the top of the function</a></li>\n<li><a href=\"#g-28-empty-blocks-should-be-removed-or-emit-something\">G-28 Empty blocks should be removed or emit something</a></li>\n<li><a href=\"#g-29-superfluous-event-fields\">G-29 Superfluous event fields</a></li>\n<li><a href=\"#g-30-use-custom-errors-rather-than-revertrequire-strings-to-save-gas\">G-30 Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</a></li>\n<li><a href=\"#g-31-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\">G-31 Functions guaranteed to revert when called by normal users can be marked <code>payable</code></a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}