{
  "circa": {
    "title": "LI.FI contest",
    "sponsor": "LI.FI",
    "slug": "2022-03-lifinance",
    "date": "2022-05-05",
    "findings": "https://github.com/code-423n4/2022-03-lifinance-findings/issues",
    "contest": 103
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the LI.FI smart contract system written in Solidity. The audit contest took place between March 24—March 30 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>68 Wardens contributed reports to the LI.FI contest:</p>\n<ol>\n<li>0xDjango</li>\n<li><a href=\"https://twitter.com/kirkthebaird\">kirk-baird</a></li>\n<li>GeekyLumberjack</li>\n<li><a href=\"https://twitter.com/merkleplant_eth\">pmerkleplant</a></li>\n<li><a href=\"https://twitter.com/rayn731\">rayn</a></li>\n<li>hyh</li>\n<li><a href=\"https://twitter.com/HickupH\">hickuphh3</a></li>\n<li>CertoraInc (<a href=\"https://twitter.com/danbinnun\">danb</a>, egjlmn1, <a href=\"https://twitter.com/ori_dabush\">OriDabush</a>, ItayG, and shakedwinder)</li>\n<li>hake</li>\n<li>WatchPug (<a href=\"https://github.com/jack-the-pug\">jtp</a> and <a href=\"https://github.com/mingwatch\">ming</a>)</li>\n<li><a href=\"https://github.com/x9453\">shw</a></li>\n<li><a href=\"https://twitter.com/catchup22\">catchup</a></li>\n<li>cccz</li>\n<li><a href=\"https://twitter.com/defsec_\">defsec</a></li>\n<li><a href=\"https://twitter.com/wuwe19\">wuwe1</a></li>\n<li>VAD37</li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li><a href=\"https://twitter.com/danbinnun\">danb</a></li>\n<li><a href=\"https://twitter.com/MukeshJ_eth\">JMukesh</a></li>\n<li><a href=\"https://twitter.com/JustDravee\">Dravee</a></li>\n<li>ACai</li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li>Picodes</li>\n<li>Jujic</li>\n<li>dirk_y</li>\n<li>sorrynotsorry</li>\n<li><a href=\"https://www.linkedin.com/in/yahia-chaabane/\">ych18</a></li>\n<li>peritoflores</li>\n<li>saian</li>\n<li><a href=\"https://github.com/TomAFrench\">TomFrenchBlockchain</a></li>\n<li>robee</li>\n<li><a href=\"https://twitter.com/_0v3rf10w\">0v3rf10w</a></li>\n<li><a href=\"https://twitter.com/shenwilly_\">shenwilly</a></li>\n<li>SolidityScan (<a href=\"https://twitter.com/cyberboyIndia\">cyberboy</a> and <a href=\"https://blog.dixitaditya.com/\">zombie</a>)</li>\n<li><a href=\"https://twitter.com/zachobront\">obront</a></li>\n<li><a href=\"https://twitter.com/nonfungiblenero\">Kenshin</a></li>\n<li>kenta</li>\n<li>IllIllI</li>\n<li>PPrieditis</li>\n<li><a href=\"https://twitter.com/ndeanoden\">nedodn</a></li>\n<li><a href=\"https://twitter.com/real_Dimitri\">dimitri</a></li>\n<li>Hawkeye (0xwags and 0xmint)</li>\n<li>0xkatana</li>\n<li><a href=\"https://twitter.com/teryanarmenn\">teryanarmen</a></li>\n<li>samruna</li>\n<li>tchkvsky</li>\n<li><a href=\"https://twitter.com/BouSalman\">BouSalman</a></li>\n<li><a href=\"https://www.instagram.com/riyan_rfa/\">rfa</a></li>\n<li>PranavG</li>\n<li>aga7hokakological</li>\n<li>cthulhu_cult (<a href=\"https://twitter.com/b4db1rd\">badbird</a> and <a href=\"https://twitter.com/SeanEmile\">seanamani</a>)</li>\n<li>hubble (ksk2345 and shri4net)</li>\n<li>FSchmoede</li>\n<li>tintin</li>\n<li>TerrierLover</li>\n<li><a href=\"https://instagram.com/vanensurya\">Funen</a></li>\n<li><a href=\"https://twitter.com/meidhiwirara\">Tomio</a></li>\n<li><a href=\"https://twitter.com/0xNazgul\">0xNazgul</a></li>\n<li>minhquanym</li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/gzeon\">gzeon</a>. The judge also competed in the contest as a warden, but forfeited their winnings.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 15 unique vulnerabilities. Of these vulnerabilities, 2 received a risk rating in the category of HIGH severity and 13 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 42 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 37 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-03-lifinance\">C4 LI.FI contest repository</a>, and is composed of 17 smart contracts written in the Solidity programming language and includes 994 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code423n4.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-2\" style=\"position:relative;\"><a href=\"#high-risk-findings-2\" aria-label=\"high risk findings 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (2)</h1>\n<h2 id=\"h-01-reliance-on-lifidatareceivingassetid-can-cause-loss-of-funds\" style=\"position:relative;\"><a href=\"#h-01-reliance-on-lifidatareceivingassetid-can-cause-loss-of-funds\" aria-label=\"h 01 reliance on lifidatareceivingassetid can cause loss of funds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/75\">[H-01] Reliance on <code>lifiData.receivingAssetId</code> can cause loss of funds</a></h2>\n<p><em>Submitted by 0xDjango, also found by hake, kirk-baird, rayn, and shenwilly</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/699c2305fcfb6fe8862b75b26d1d8a2f46a551e6/src/Facets/GenericSwapFacet.sol#L23-L30\">GenericSwapFacet.sol#L23-L30</a><br></p>\n<p>In the <code>swapTokensGeneric()</code> function, an arbitrary number of swaps can be performed from and to various tokens. However, the final balance that is sent to the user relies on <code>_lifiData.receivingAssetId</code> which has no use in the swapping functionality. LifiData is claimed to be used purely for analytical reasons per the comments to this function. If this value is input incorrectly, the swapped tokens will simply sit in the contract and be lost to the user.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Imagine a call to <code>swapTokensGeneric()</code> with the following parameters (excluding unnecessary parameters for this example):</p>\n<ul>\n<li>LifiData.receivingAssetId = ‘0xUSDC_ADDRESS’</li>\n</ul>\n<p>Single SwapData array:</p>\n<ul>\n<li>LibSwap.SwapData.sendingAssetId = ‘0xWETH_ADDRESS’</li>\n<li>LibSwap.SwapData.receivingAssetId = ‘0xDAI_ADDRESS’</li>\n</ul>\n<p>Since the <code>receivingAssetId</code> from <code>SwapData</code> does not match the <code>receivingAssetId</code> from <code>LifiData</code>, the final funds will not be sent to the user after the swap is complete, based on the following lines of code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">uint256 receivingAssetIdBalance = LibAsset.getOwnBalance(_lifiData.receivingAssetId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> _executeSwaps(_lifiData, _swapData);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> uint256 postSwapBalance = LibAsset.getOwnBalance(_lifiData.receivingAssetId) - receivingAssetIdBalance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> LibAsset.transferAsset(_lifiData.receivingAssetId, payable(msg.sender), postSwapBalance);</span></span></code></pre>\n<p>Lines 1, 3, and 4 reference <code>LifiData.receivingAssetId</code> and handle the transfer of funds following the swaps. Line 2 performs the swap, referencing <code>SwapData.receivingAssetId</code> as can be seen in the <code>executeSwaps()</code> function definition:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _executeSwaps(LiFiData memory _lifiData, LibSwap.SwapData[] calldata _swapData) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Swap</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        for (uint8 i; i &lt; _swapData.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            require(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                ls.dexWhitelist[_swapData[i].approveTo] == true &amp;&amp; ls.dexWhitelist[_swapData[i].callTo] == true,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                &quot;Contract call not allowed!&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            LibSwap.swap(_lifiData.transactionId, _swapData[i]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>I recommend adding a check that <code>_lifiData.receivingAssetId</code> equals the <code>receivingAssetId</code> of the last index of the SwapData array, or simply use the <code>receivingAssetId</code> of the last index of the SwapData array for sending the final tokens to the user.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/75#issuecomment-1088830379\">H3xept (Li.Fi) commented</a>:</strong></p>\n<blockquote>\n<p>Fixed in lifinance/lifi-contracts@52aa2b8ea3bc51de3e60784c00201e29103fe250</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/75#issuecomment-1100703191\">gzeon (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Sponsor confirmed with fix.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-02-all-swapping-functions-lack-checks-for-returned-tokens\" style=\"position:relative;\"><a href=\"#h-02-all-swapping-functions-lack-checks-for-returned-tokens\" aria-label=\"h 02 all swapping functions lack checks for returned tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/76\">[H-02] All swapping functions lack checks for returned tokens</a></h2>\n<p><em>Submitted by 0xDjango, also found by GeekyLumberjack and pmerkleplant</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/699c2305fcfb6fe8862b75b26d1d8a2f46a551e6/src/Facets/GenericSwapFacet.sol#L23-L30\">GenericSwapFacet.sol#L23-L30</a><br>\n<a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/699c2305fcfb6fe8862b75b26d1d8a2f46a551e6/src/Libraries/LibSwap.sol#L48\">LibSwap.sol#L48</a><br></p>\n<p>Every function that stems from the <code>GenericSwapFacet</code> lacks checks to ensure that some tokens have been returned via the swaps. In <code>LibSwap.sol</code> in the <code>swap()</code> function, the swap call is sent to the target DEX. A return of success is required, otherwise the operation will revert.</p>\n<p>Each “inner” swap via <code>LibSwap.sol</code> lacks output checks and also the “outer” <code>swapTokensGeneric()</code> via <code>GenericSwapFacet.sol</code> lacks a final check as well.</p>\n<p>There is a possibility that the calldata is accidently populated with a function in the target router that is not actually performing any swapping functionality, <code>getAmountsOut()</code> for example. The function will return true, but no new returned tokens will be present in the contract. Meanwhile, the contract has already received the user’s <code>fromTokens</code> directly.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>This would be a potential use case of using function signature whitelists as opposed to contract address whitelists, as noted as a possibility by the LiFi team.</p>\n<p>Otherwise, the following <code>require</code> statement in <code>swapTokensGeneric()</code> would ensure that at least a single token was received:</p>\n<p><code>require(LibAsset.getOwnBalance(_swapData.receivingAssetId) - toAmount) > 0, \"No tokens received\")</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/76#issuecomment-1094953222\">H3xept (Li.Fi) resolved and commented</a>:</strong></p>\n<blockquote>\n<p>Fixed in lifinance/lifi-contracts@3a42484dda8bafcfd122c8aa3b61d3766d545bf9</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/76#issuecomment-1100703542\">gzeon (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Sponsor confirmed with fix.</p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-13\" style=\"position:relative;\"><a href=\"#medium-risk-findings-13\" aria-label=\"medium risk findings 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (13)</h1>\n<h2 id=\"m-01-anyswapfacet-can-be-exploited-to-approve-arbitrary-tokens\" style=\"position:relative;\"><a href=\"#m-01-anyswapfacet-can-be-exploited-to-approve-arbitrary-tokens\" aria-label=\"m 01 anyswapfacet can be exploited to approve arbitrary tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/117\">[M-01] <code>AnyswapFacet</code> can be exploited to approve arbitrary tokens.</a></h2>\n<p><em>Submitted by kirk-baird, also found by cccz, dirk_y, hickuphh3, and rayn</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/AnyswapFacet.sol#L35-L53\">AnyswapFacet.sol#L35-L53</a><br></p>\n<p>In <code>AnyswapFacet.sol</code> we parse arbitrary data in <code>_anyswapData</code> allowing an attacker to drain funds (ERC20 or native tokens) from the LiFi contract.</p>\n<p>Functions effected:</p>\n<ul>\n<li><code>AnyswapFacet.startBridgeTokensViaAnyswap()</code></li>\n<li><code>AnyswapFacet.swapAndStartBridgeTokensViaAnyswap()</code></li>\n</ul>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This attack works in <code>AnyswapFacet.startBridgeTokensViaAnyswap()</code> by having a malicious <code>_anyswapData.token</code> which may change the value return in <code>IAnyswapToken(_anyswapData.token).underlying();</code>.</p>\n<p>First we have the first call to <code>IAnyswapToken(_anyswapData.token).underlying();</code> return a malicious ERC20 contract in the attackers control. This allows for transferring these malicious ERC20 tokens to pass the required balance checks.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 _fromTokenBalance = LibAsset.getOwnBalance(underlyingToken);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            LibAsset.transferFromERC20(underlyingToken, msg.sender, address(this), _anyswapData.amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            require(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                LibAsset.getOwnBalance(underlyingToken) - _fromTokenBalance == _anyswapData.amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                &quot;ERR_INVALID_AMOUNT&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span></code></pre>\n<p>The function will then call <code>_startBridge()</code> which again does <code>address underlyingToken = IAnyswapToken(_anyswapData.token).underlying();</code> we have the malicious <code>_anyswapData.token</code> return a different address, one which the LiFi contract has balance for (a native token or ERC20).</p>\n<p>We will therefore execute the following which will either approve or transfer funds to <code>_anyswapData.router</code> for a different <code>underlyingtoken</code> to the one which supplied the funds to LiFi.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        address underlyingToken = IAnyswapToken(_anyswapData.token).underlying();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (underlyingToken == IAnyswapRouter(_anyswapData.router).wNATIVE()) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            IAnyswapRouter(_anyswapData.router).anySwapOutNative{ value: _anyswapData.amount }(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                _anyswapData.token,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                _anyswapData.recipient,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                _anyswapData.toChainId</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            return;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (_anyswapData.token != address(0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Has underlying token?</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (underlyingToken != address(0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                // Give Anyswap approval to bridge tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                LibAsset.approveERC20(IERC20(underlyingToken), _anyswapData.router, _anyswapData.amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                IAnyswapRouter(_anyswapData.router).anySwapOutUnderlying(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    _anyswapData.token,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    _anyswapData.recipient,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    _anyswapData.amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    _anyswapData.toChainId</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                // Give Anyswap approval to bridge tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                LibAsset.approveERC20(IERC20(_anyswapData.token), _anyswapData.router, _anyswapData.amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                IAnyswapRouter(_anyswapData.router).anySwapOut(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    _anyswapData.token,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    _anyswapData.recipient,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    _anyswapData.amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    _anyswapData.toChainId</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>Since <code>_anyswapData.router</code> is an address in the attackers control they either are transferred native tokens or they have an allowance of ERC20 tokens that they can spend arbitrarily.</p>\n<p>The attack is almost identical in <code>swapAndStartBridgeTokensViaAnyswap()</code></p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider whitelisting both Anyswap tokens and Anyswap routers (using two distinct whitelists) restricting the attackers ability to use malicious contracts for this attack.</p>\n<p>Consider also only calling <code>IAnyswapToken(_anyswapData.token).underlying()</code> once and passing this value to <code>_startBridge()</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/117#issuecomment-1096468398\">H3xept (Li.Fi) disagreed with High severity, but resolved and commented</a>:</strong></p>\n<blockquote>\n<p>We fixed the issue by not allowing underlying() to be called multiple times in one transaction (lifinance/lifi-contracts@a8d6336c2ded97bdbca65b64157596b33f18f70d)</p>\n<p>We disagree with the severity as no funds should ever be left in the contract by design.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/117#issuecomment-1100696054\">gzeon (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Keeping this as Med Risk. There can be fund leftover in the contract under normal operation, for example <a href=\"https://etherscan.io/tx/0xe78c36dd2c2f21cade00a4099701b9c9f82acc8da568e1048a4d7287ce2e45b0\">this tx</a>. In fact, ~$300 worth of token is left in the LI.Fi smart contract on ETH mainnet <a href=\"https://etherscan.io/address/0x5a9fd7c39a6c488e715437d7b1f3c823d5596ed1\">0x5a9fd7c39a6c488e715437d7b1f3c823d5596ed1</a> as of block 14597316. I don’t think this is High Risk because the max amount lost is no more than allowed slippage, which can be loss to MEV too.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-anyone-can-get-swaps-for-free-given-certain-conditions-in-swap\" style=\"position:relative;\"><a href=\"#m-02-anyone-can-get-swaps-for-free-given-certain-conditions-in-swap\" aria-label=\"m 02 anyone can get swaps for free given certain conditions in swap permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/66\">[M-02] Anyone can get swaps for free given certain conditions in <code>swap</code>.</a></h2>\n<p><em>Submitted by hake, also found by csanuragjain, hickuphh3, hyh, Kenshin, kirk-baird, obront, pmerkleplant, rayn, Ruhum, shw, tintin, VAD37, WatchPug, and wuwe1</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Libraries/LibSwap.sol#L29-L48\">LibSwap.swap</a><br>\n<a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/GenericSwapFacet.sol\">GenericSwapFacet.sol</a></p>\n<p>Remaining or unaccounted ERC20 balance could be freely taken through <code>swapTokensGenerics</code> and <code>swap</code>.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function swap(bytes32 transactionId, SwapData calldata _swapData) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 fromAmount = _swapData.fromAmount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 toAmount = LibAsset.getOwnBalance(_swapData.receivingAssetId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address fromAssetId = _swapData.sendingAssetId;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (!LibAsset.isNativeAsset(fromAssetId) &amp;&amp; LibAsset.getOwnBalance(fromAssetId) &lt; fromAmount) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            LibAsset.transferFromERC20(fromAssetId, msg.sender, address(this), fromAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (!LibAsset.isNativeAsset(fromAssetId)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            LibAsset.approveERC20(IERC20(fromAssetId), _swapData.approveTo, fromAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // solhint-disable-next-line avoid-low-level-calls</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (bool success, bytes memory res) = _swapData.callTo.call{ value: msg.value }(_swapData.callData);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (!success) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            string memory reason = LibUtil.getRevertMsg(res);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            revert(reason);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        toAmount = LibAsset.getOwnBalance(_swapData.receivingAssetId) - toAmount;</span></span></code></pre>\n<p>Given:</p>\n<ul>\n<li>There has been a deposit to LiFi of a non-native ERC20 that makes <code>LibAsset.getOwnBalance(fromAssetId)</code> a desirable amount.</li>\n<li>Attacker calls <code>swapTokensGeneric</code> with a <code>_swapData.fromAmount</code> value just below <code>LibAsset.getOwnBalance(fromAssetId)</code>.</li>\n<li>First <code>if</code> statement in <code>swap</code> is skipped (no funds are tranferred to LiFis contract).</li>\n</ul>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (!LibAsset.isNativeAsset(fromAssetId) &amp;&amp; LibAsset.getOwnBalance(fromAssetId) &lt; fromAmount) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            LibAsset.transferFromERC20(fromAssetId, msg.sender, address(this), fromAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<ul>\n<li>Swap happens and increases <code>LibAsset.getOwnBalance(_lifiData.receivingAssetId)</code></li>\n<li>Difference of LiFis balance of the receiving token before and after swap is calculated using <code>postSwapBalance</code> and transfered to attacker.</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Ensure funds are always subtracted from users account in <code>swap</code>, even if LiFi has enough balance to do the swap.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/66#issuecomment-1096366089\">H3xept (Li.Fi) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>We are aware that the contract allows users to use latent funds, although we disagree on it being an issue as <strong>no funds</strong> (ERC20 or native) should ever lay in the contract. To make sure that no value is ever kept by the diamond, we now provide refunds for outstanding user value (after bridges/swaps).</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/66#issuecomment-1100698703\">gzeon (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Keeping this as Med Risk. There can be fund leftover in the contract under normal operation, for example <a href=\"https://etherscan.io/tx/0xe78c36dd2c2f21cade00a4099701b9c9f82acc8da568e1048a4d7287ce2e45b0\">this tx</a>. In fact, ~$300 worth of token is left in the LI.Fi smart contract on ETH mainnet <a href=\"https://etherscan.io/address/0x5a9fd7c39a6c488e715437d7b1f3c823d5596ed1\">0x5a9fd7c39a6c488e715437d7b1f3c823d5596ed1</a> as of block 14597316. I don’t think this is High Risk because the max amount lost is no more than allowed slippage, which can be loss to MEV too.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/66#issuecomment-1115936416\">ezynda3 (Li.Fi) resolved and commented</a>:</strong></p>\n<blockquote>\n<p>This has been fixed in the most recent version of <code>src/Helpers/Swapper.sol</code> which sweeps any latent funds back to the user’s wallet.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-libswap-excess-funds-from-swaps-are-not-returned\" style=\"position:relative;\"><a href=\"#m-03-libswap-excess-funds-from-swaps-are-not-returned\" aria-label=\"m 03 libswap excess funds from swaps are not returned permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/33\">[M-03] LibSwap: Excess funds from swaps are not returned</a></h2>\n<p><em>Submitted by hickuphh3, also found by 0xDjango, cccz, JMukesh, and Ruhum</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Libraries/LibSwap.sol#L29-L58\">LibSwap.sol#L29-L58</a><br></p>\n<p>It is probable for <code>_swapData.fromAmount</code> to be greater than the actual amount used (eg. when swapping for an exact output, or when performing another swap after swapping with an exact input). However, these funds aren’t returned back to the user and are left in the lifi contract.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/test/facets/AnyswapFacet.test.ts#L153-L194\">AnyswapFacet.test.ts#L153-L194</a><br></p>\n<p>The test referenced above swaps for MATIC for 1000 USDT exactly. Logging the matic amounts before and after the swap and bridge call, one will find 18.01 MATIC is unused and left in the contract when it should be returned to the user.</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Store the contract’s from balance before and after the swap. Refund any excess back to the user.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">actualFromAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">LibAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getOwnBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fromAssetId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">res</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">_swapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">callTo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{ value: </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> }(</span><span class=\"mtk12\">_swapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">callData</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">success</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reason</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">LibUtil</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getRevertMsg</span><span class=\"mtk1\">(</span><span class=\"mtk12\">res</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reason</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">actualFromAmount</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">LibAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getOwnBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fromAssetId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fromAmount</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">actualFromAmount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&#39;actual amount used more than specified&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// transfer excess back to user</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">actualFromAmount</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">fromAmount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// transfer excess to user</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// difference calculation be unchecked since fromAmount &gt; actualFromAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>This comes with the requirement that the funds for every swap should be pulled from the user.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/33#issuecomment-1096482980\">H3xept (Li.Fi) resolved and commented</a>:</strong></p>\n<blockquote>\n<p>Fixed in lifinance/lifi-contracts@4d66e5ad5f9a897d9f8a66eb7a4e765e0b6ff97c</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/33#issuecomment-1098863344\">maxklenk (Li.Fi) disagreed with High severity and commented</a>:</strong></p>\n<blockquote>\n<p>We “disagree with severity” as this issue would not allow to access other users funds and only happens if the user passes these kind of swaps himself. The multi-swap feature is mainly used to allow swapping multiple different tokens into one, which is then fully swapped.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/33#issuecomment-1100699308\">gzeon (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Agree with sponsor and adjusting this to Medium Risk.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-msgvalue-is-sent-multipletimes-when-performing-a-swap\" style=\"position:relative;\"><a href=\"#m-04-msgvalue-is-sent-multipletimes-when-performing-a-swap\" aria-label=\"m 04 msgvalue is sent multipletimes when performing a swap permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/86\">[M-04] <code>msg.value</code> is Sent Multipletimes When Performing a Swap</a></h2>\n<p><em>Submitted by kirk-baird, also found by hyh, rayn, TomFrenchBlockchain, VAD37, WatchPug, and wuwe1</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Libraries/LibSwap.sol#L42\">LibSwap.sol#L42</a><br>\n<a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/Swapper.sol#L12-L23\">Swapper.sol#L12-L23</a><br></p>\n<p><code>msg.value</code> is attached multiple times to external swap calls in <code>LibSwap.swap()</code>.</p>\n<p>If <code>Swapper._executeSwaps()</code> is called with the native token as the <code>swapData.fromAssetId</code> more than once and <code>msg.value > 0</code> then more value will be transferred out of the contract than is received since <code>msg.value</code> will be transferred out <code>_swapData.length</code> times.</p>\n<p>The impact is that the contract can have all the native token balance drained by an attacker who has makes repeated swap calls from the native token into any other ERC20 token. Each time the original <code>msg.value</code> of the sender will be swapped out of the contract. This attack essentially gives the attacker <code>_swapData.length * msg.value</code> worth of native tokens (swapped into another ERC20) when they should only get <code>msg.value</code>.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>Swapper._executeSwaps()</code> iterates over a list of  <code>SwapData</code> calling <code>LibSwap.swap()</code> each time (note this is an internal call).</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_executeSwaps</span><span class=\"mtk1\">(</span><span class=\"mtk12\">LiFiData</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_lifiData</span><span class=\"mtk1\">, LibSwap.SwapData[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_swapData</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Swap</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_swapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">ls</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexWhitelist</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_swapData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">approveTo</span><span class=\"mtk1\">] == </span><span class=\"mtk4\">true</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">ls</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexWhitelist</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_swapData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">callTo</span><span class=\"mtk1\">] == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk8\">&quot;Contract call not allowed!&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">LibSwap</span><span class=\"mtk1\">.</span><span class=\"mtk11\">swap</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_lifiData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">transactionId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_swapData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Inside <code>LibSwap.swap()</code> we make an external call to <code>_swapData.callTo</code> with <code>value : msg.value</code>. Due to the loop in <code>Swapper._executeSwaps()</code> this repeatedly sends the original <code>msg.value</code> in the external call.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">res</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">_swapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">callTo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{ value: </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> }(</span><span class=\"mtk12\">_swapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">callData</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>This issue may be mitigated by only allowing <code>fromAssetId</code> to be the native token once in <code>_swapData</code> in <code>Swapper._executeSwaps()</code>. If it occurs more than once the transaction should revert.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/86#issuecomment-1096486215\">H3xept (Li.Fi) acknowledged, but disagreed with High severity and commented</a>:</strong></p>\n<blockquote>\n<p>We are aware that the contract allows users to use latent funds, although we disagree on it being an issue as no funds (ERC20 or native) should ever lay in the contract. To make sure that no value is ever kept by the diamond, we now provide refunds for outstanding user value (after bridges/swaps). </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/86#issuecomment-1100700006\">gzeon (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Adjusting this as Medium Risk. There can be fund leftover in the contract under normal operation, for example <a href=\"https://etherscan.io/tx/0xe78c36dd2c2f21cade00a4099701b9c9f82acc8da568e1048a4d7287ce2e45b0\">this tx</a>. In fact, ~$300 worth of token is left in the LI.Fi smart contract on ETH mainnet <a href=\"https://etherscan.io/address/0x5a9fd7c39a6c488e715437d7b1f3c823d5596ed1\">0x5a9fd7c39a6c488e715437d7b1f3c823d5596ed1</a> as of block 14597316. I don’t think this is High Risk because the max amount lost is no more than allowed slippage, which can be loss to MEV too. Not a duplicate of M-02 since <code>msg.value</code> is the vector here.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/86#issuecomment-1115936651\">ezynda3 (Li.Fi) resolved and commented</a>:</strong></p>\n<blockquote>\n<p>This has been fixed in the most recent version of <code>src/Helpers/Swapper.sol</code> which sweeps any latent funds back to the user’s wallet.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-cbridge-integration-fails-to-send-native-tokens\" style=\"position:relative;\"><a href=\"#m-05-cbridge-integration-fails-to-send-native-tokens\" aria-label=\"m 05 cbridge integration fails to send native tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/35\">[M-05] cBridge integration fails to send native tokens</a></h2>\n<p><em>Submitted by hickuphh3, also found by hyh, rayn, shw, WatchPug, and wuwe1</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/CBridgeFacet.sol#L150-L156\">CBridgeFacet.sol#L150-L156</a><br></p>\n<p>The external <code>sendNative()</code> call fails to include sending the native tokens together with it.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Add the following test case to the <a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/test/facets/CBridgeFacet.test.ts\"><code>CBridgeFacet</code> test file</a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// TODO: update bridge address to 0x5427FEFA711Eff984124bFBB1AB6fbf5E3DA1820</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">it</span><span class=\"mtk1\">.</span><span class=\"mtk11\">only</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;reverts because ETH not sent to bridge&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">CBridgeData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">constants</span><span class=\"mtk1\">.</span><span class=\"mtk12\">AddressZero</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">CBridgeData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">constants</span><span class=\"mtk1\">.</span><span class=\"mtk12\">One</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lifi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">).</span><span class=\"mtk11\">startBridgeTokensViaCBridge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lifiData</span><span class=\"mtk1\">, </span><span class=\"mtk12\">CBridgeData</span><span class=\"mtk1\">, {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">value:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constants</span><span class=\"mtk1\">.</span><span class=\"mtk12\">One</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">gasLimit:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">500000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk11\">revertedWith</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;Amount mismatch&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">})</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">ICBridge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bridge</span><span class=\"mtk1\">).</span><span class=\"mtk12\">sendNative</span><span class=\"mtk1\">{ value: </span><span class=\"mtk12\">_cBridgeData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> }(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">_cBridgeData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">_cBridgeData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">_cBridgeData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dstChainId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">_cBridgeData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nonce</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">_cBridgeData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maxSlippage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>In addition, add the <code>payable</code> keyword to the <a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Interfaces/ICBridge.sol#L14-L20\">CBridge interface</a>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/35#issuecomment-1094907923\">H3xept (Li.Fi) resolved and commented</a>:</strong></p>\n<blockquote>\n<p>Fixed in lifinance/lifi-contracts@b684627b57c4891bee13fcfcfcf2595965843cc6</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/35#issuecomment-1100700833\">gzeon (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Valid POC. Sponsor confirmed with fix.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-dexmanagerfacet-batchremovedex-removes-first-dex-only\" style=\"position:relative;\"><a href=\"#m-06-dexmanagerfacet-batchremovedex-removes-first-dex-only\" aria-label=\"m 06 dexmanagerfacet batchremovedex removes first dex only permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/34\">[M-06] DexManagerFacet: batchRemoveDex() removes first dex only</a></h2>\n<p><em>Submitted by hickuphh3, also found by 0xDjango, catchup, csanuragjain, hyh, shw, WatchPug, and ych18</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/DexManagerFacet.sol#L71-L73\">DexManagerFacet.sol#L71-L73</a><br></p>\n<p>The function intends to allow the removal of multiple dexes approved for swaps. However, the function will only remove the first DEX because <code>return</code> is used instead of <code>break</code> in the inner for loop.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">j</span><span class=\"mtk1\">] == </span><span class=\"mtk12\">_dexs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">_removeDex</span><span class=\"mtk1\">(</span><span class=\"mtk12\">j</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// should be replaced with break;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>This error is likely to have gone unnoticed because no event is emitted when a DEX is added or removed.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Add the following lines below <a href=\"https://github.com/code-423n4/2022-03-Li.finance/blob/main/test/facets/AnyswapFacet.test.ts#L44\">L44 of</a> <code>[AnyswapFacet.test.ts](https://github.com/code-423n4/2022-03-lifinance/blob/main/test/facets/AnyswapFacet.test.ts#L44)</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dexMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addDex</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ANYSWAP_ROUTER</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dexMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">batchRemoveDex</span><span class=\"mtk1\">([</span><span class=\"mtk12\">ANYSWAP_ROUTER</span><span class=\"mtk1\">, </span><span class=\"mtk12\">UNISWAP_ADDRESS</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// UNISWAP_ADDRESS remains as approved dex when it should have been removed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dexMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approvedDexs</span><span class=\"mtk1\">())</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Replace <code>return</code> with <code>break</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">j</span><span class=\"mtk1\">] == </span><span class=\"mtk12\">_dexs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">_removeDex</span><span class=\"mtk1\">(</span><span class=\"mtk12\">j</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">break</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>In addition, it is recommend to emit an event whenever a DEX is added or removed.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/34#issuecomment-1096504104\">H3xept (Li.Fi) resolved and commented</a>:</strong></p>\n<blockquote>\n<p>Fixed in lifinance/lifi-contracts@0a078bbbdf8ec92bd72efc4257900af416d537d4</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/34#issuecomment-1100702209\">gzeon (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Valid POC and sponsor confirmed with fix.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-erc20-bridging-functions-do-not-revert-on-non-zero-msgvalue\" style=\"position:relative;\"><a href=\"#m-07-erc20-bridging-functions-do-not-revert-on-non-zero-msgvalue\" aria-label=\"m 07 erc20 bridging functions do not revert on non zero msgvalue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/53\">[M-07] ERC20 bridging functions do not revert on non-zero msg.value</a></h2>\n<p><em>Submitted by hyh, also found by danb, kirk-baird, and pmerkleplant</em></p>\n<p>Any native funds mistakenly sent along with plain ERC20 bridging calls will be lost. AnyswapFacet, CBridgeFacet, HopFacet and NXTPFacet have this issue.</p>\n<p>For instance, swapping function might use native tokens, but the functions whose purpose is bridging solely have no use of native funds, so any mistakenly sent native funds to be frozen on the contract balance.</p>\n<p>Placing the severity to be medium as in combination with other issues there is a possibility for user funds to be frozen for an extended period of time (if WithdrawFacet’s issue plays out) or even lost (if LibSwap’s swap native tokens one also be triggered).</p>\n<p>In other words, the vulnerability is also a wider attack surface enabler as it can bring in the user funds to the contract balance.</p>\n<p>Medium despite the fund loss possibility as the native funds in question here are mistakenly sent only, so the probability is lower compared to direct leakage issues.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>startBridgeTokensViaAnyswap doesn’t check that <code>msg.value</code> is zero:</p>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/AnyswapFacet.sol#L38-L48\">AnyswapFacet.sol#L38-L48</a><br></p>\n<p>startBridgeTokensViaCBridge also have no such check:</p>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/CBridgeFacet.sol#L59-L66\">CBridgeFacet.sol#L59-L66</a><br></p>\n<p>startBridgeTokensViaHop the same:</p>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/HopFacet.sol#L66-L71\">HopFacet.sol#L66-L71</a><br></p>\n<p>In NXTPFacet completion function does the check, but startBridgeTokensViaNXTP doesn’t:</p>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/NXTPFacet.sol#L54-L59\">NXTPFacet.sol#L54-L59</a><br></p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider reverting when bridging functions with non-native target are called with non-zero native amount added.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/53#issuecomment-1095009690\">H3xept (Li.Fi) commented</a>:</strong></p>\n<blockquote>\n<p>Fixed in lifinance/lifi-contracts@a8d6336c2ded97bdbca65b64157596b33f18f70d</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/53#issuecomment-1100704372\">gzeon (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Sponsor confirmed with fix.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-swap-functions-are-reenterable\" style=\"position:relative;\"><a href=\"#m-08-swap-functions-are-reenterable\" aria-label=\"m 08 swap functions are reenterable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/109\">[M-08] Swap functions are Reenterable</a></h2>\n<p><em>Submitted by kirk-baird, also found by ACai, hake, and rayn</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/699c2305fcfb6fe8862b75b26d1d8a2f46a551e6/src/Facets/DiamondCutFacet.sol#L14-L22\">DiamondCutFacet.sol#L14-L22</a><br>\n<a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/699c2305fcfb6fe8862b75b26d1d8a2f46a551e6/src/Facets/CBridgeFacet.sol#L92-L121\">CBridgeFacet.sol#L92-L121</a><br>\n<a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/699c2305fcfb6fe8862b75b26d1d8a2f46a551e6/src/Facets/AnyswapFacet.sol#L74-L110\">AnyswapFacet.sol#L74-L110</a><br>\n<a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/699c2305fcfb6fe8862b75b26d1d8a2f46a551e6/src/Facets/NXTPFacet.sol#L85-L102\">NXTPFacet.sol#L85-L102</a><br>\n<a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/699c2305fcfb6fe8862b75b26d1d8a2f46a551e6/src/Facets/NXTPFacet.sol#L150-L171\">NXTPFacet.sol#L150-L171</a><br></p>\n<p>There is a reenterancy vulnerability in functions which call <code>Swapper._executeSwap()</code> which would allow the attacker to change their <code>postSwapBalance</code>.</p>\n<p>The functions following similar logic to that seen in <code>GenericSwapFacet.swapTokensGeneric()</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 receivingAssetIdBalance = LibAsset.getOwnBalance(_lifiData.receivingAssetId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Swap</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _executeSwaps(_lifiData, _swapData);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 postSwapBalance = LibAsset.getOwnBalance(_lifiData.receivingAssetId) - receivingAssetIdBalance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        LibAsset.transferAsset(_lifiData.receivingAssetId, payable(msg.sender), postSwapBalance);</span></span></code></pre>\n<p>This logic records the balance before and after the <code>_executeSwaps()</code> function. The difference is then transferred to the <code>msg.sender</code>.</p>\n<p>The issue occurs since it is possible for an attacker to reenter this function during <code>_executeSwaps()</code>, that is because execute swap makes numerous external calls, such as to the AMM, or to untrusted ERC20 token addresses.</p>\n<p>If a function is called such as <code>WithdrawFacet.withdraw()</code> this will impact the calculations of <code>postSwapBalance</code> which will account for the funds transferred out during withdrawal. Furthermore, any functions which transfers funds into the contract will also be counted in the <code>postSwapBalance</code> calculations.</p>\n<p>Vulnerable Functions:</p>\n<ul>\n<li><code>GenericSwapFacet.swapTokensGeneric()</code></li>\n<li><code>CBridgeFacet.swapAndStartBridgeTokensViaCBridge()</code></li>\n<li><code>AnyswapFacet.swapAndStartBridgeTokensViaAnyswap()</code></li>\n<li><code>HopFacet.swapAndStartBridgeTokensViaHop()</code></li>\n<li><code>NXTPFacet.swapAndStartBridgeTokensViaNXTP()</code></li>\n<li><code>NXTPFacet.swapAndCompleteBridgeTokensViaNXTP()</code></li>\n</ul>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>GenericSwapFacet.swapTokensGeneric()</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function swapTokensGeneric(LiFiData memory _lifiData, LibSwap.SwapData[] calldata _swapData) public payable {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 receivingAssetIdBalance = LibAsset.getOwnBalance(_lifiData.receivingAssetId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Swap</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _executeSwaps(_lifiData, _swapData);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 postSwapBalance = LibAsset.getOwnBalance(_lifiData.receivingAssetId) - receivingAssetIdBalance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        LibAsset.transferAsset(_lifiData.receivingAssetId, payable(msg.sender), postSwapBalance);</span></span></code></pre>\n<p><code>CBridgeFacet.swapAndStartBridgeTokensViaCBridge()</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function swapAndStartBridgeTokensViaCBridge(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        LiFiData memory _lifiData,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        LibSwap.SwapData[] calldata _swapData,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        CBridgeData memory _cBridgeData</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) public payable {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (_cBridgeData.token != address(0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 _fromTokenBalance = LibAsset.getOwnBalance(_cBridgeData.token);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Swap</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _executeSwaps(_lifiData, _swapData);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 _postSwapBalance = LibAsset.getOwnBalance(_cBridgeData.token) - _fromTokenBalance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            require(_postSwapBalance &gt; 0, &quot;ERR_INVALID_AMOUNT&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _cBridgeData.amount = _postSwapBalance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 _fromBalance = address(this).balance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Swap</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _executeSwaps(_lifiData, _swapData);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 _postSwapBalance = address(this).balance - _fromBalance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            require(_postSwapBalance &gt; 0, &quot;ERR_INVALID_AMOUNT&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _cBridgeData.amount = _postSwapBalance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _startBridge(_cBridgeData);</span></span></code></pre>\n<p><code>AnyswapFacet.swapAndStartBridgeTokensViaAnyswap()</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function swapAndStartBridgeTokensViaAnyswap(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        LiFiData memory _lifiData,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        LibSwap.SwapData[] calldata _swapData,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        AnyswapData memory _anyswapData</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) public payable {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address underlyingToken = IAnyswapToken(_anyswapData.token).underlying();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (_anyswapData.token != address(0) &amp;&amp; underlyingToken != IAnyswapRouter(_anyswapData.router).wNATIVE()) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (underlyingToken == address(0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                underlyingToken = _anyswapData.token;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 _fromTokenBalance = LibAsset.getOwnBalance(underlyingToken);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Swap</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _executeSwaps(_lifiData, _swapData);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 _postSwapBalance = LibAsset.getOwnBalance(underlyingToken) - _fromTokenBalance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            require(_postSwapBalance &gt; 0, &quot;ERR_INVALID_AMOUNT&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _anyswapData.amount = _postSwapBalance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 _fromBalance = address(this).balance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Swap</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _executeSwaps(_lifiData, _swapData);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            require(address(this).balance - _fromBalance &gt;= _anyswapData.amount, &quot;ERR_INVALID_AMOUNT&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 _postSwapBalance = address(this).balance - _fromBalance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            require(_postSwapBalance &gt; 0, &quot;ERR_INVALID_AMOUNT&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _anyswapData.amount = _postSwapBalance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _startBridge(_anyswapData);</span></span></code></pre>\n<p><code>HopFacet.swapAndStartBridgeTokensViaHop()</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function swapAndStartBridgeTokensViaHop(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        LiFiData memory _lifiData,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        LibSwap.SwapData[] calldata _swapData,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        HopData memory _hopData</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) public payable {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address sendingAssetId = _bridge(_hopData.asset).token;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _sendingAssetIdBalance = LibAsset.getOwnBalance(sendingAssetId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Swap</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _executeSwaps(_lifiData, _swapData);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _postSwapBalance = LibAsset.getOwnBalance(sendingAssetId) - _sendingAssetIdBalance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(_postSwapBalance &gt; 0, &quot;ERR_INVALID_AMOUNT&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _hopData.amount = _postSwapBalance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _startBridge(_hopData);</span></span></code></pre>\n<p><code>NXTPFacet.swapAndStartBridgeTokensViaNXTP()</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function swapAndStartBridgeTokensViaNXTP(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        LiFiData memory _lifiData,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        LibSwap.SwapData[] calldata _swapData,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ITransactionManager.PrepareArgs memory _nxtpData</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) public payable {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address sendingAssetId = _nxtpData.invariantData.sendingAssetId;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _sendingAssetIdBalance = LibAsset.getOwnBalance(sendingAssetId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Swap</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _executeSwaps(_lifiData, _swapData);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _postSwapBalance = LibAsset.getOwnBalance(sendingAssetId) - _sendingAssetIdBalance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(_postSwapBalance &gt; 0, &quot;ERR_INVALID_AMOUNT&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _nxtpData.amount = _postSwapBalance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _startBridge(_lifiData.transactionId, _nxtpData);</span></span></code></pre>\n<p><code>NXTPFacet.swapAndCompleteBridgeTokensViaNXTP()</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function swapAndCompleteBridgeTokensViaNXTP(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        LiFiData memory _lifiData,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        LibSwap.SwapData[] calldata _swapData,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address finalAssetId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address receiver</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) public payable {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 startingBalance = LibAsset.getOwnBalance(finalAssetId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Swap</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _executeSwaps(_lifiData, _swapData);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 postSwapBalance = LibAsset.getOwnBalance(finalAssetId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 finalBalance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (postSwapBalance &gt; startingBalance) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            finalBalance = postSwapBalance - startingBalance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            LibAsset.transferAsset(finalAssetId, payable(receiver), finalBalance);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit LiFiTransferCompleted(_lifiData.transactionId, finalAssetId, receiver, finalBalance, block.timestamp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider adding a reentrancy guard over <strong>every</strong> function which may send or receive tokens. It may be easiest too add this guard over the <code>fallback()</code> function however that could prevent view functions from being called (since it would perform storage operations).</p>\n<p>Ensure the same slot is used to store the reentrancy guard so all required functions are covered by a single guard.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/109#issuecomment-1087655469\">H3xept (Li.Fi) commented</a>:</strong></p>\n<blockquote>\n<p>Bridge functions are vulnerable as well.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/109#issuecomment-1094987757\">H3xept (Li.Fi) resolved and commented</a>:</strong></p>\n<blockquote>\n<p>Fixed in lifinance/lifi-contracts@703919f74d8b750e3bcf7a84bdcb4d742bc8d45a</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/109#issuecomment-1100705972\">gzeon (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Sponsor confirmed with fix. While the reentrancy is valid there is no exploit, keeping this as Medium Risk.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-09-should-prevent-users-from-sending-more-native-tokens-in-the-startbridgetokensviacbridge-function\" style=\"position:relative;\"><a href=\"#m-09-should-prevent-users-from-sending-more-native-tokens-in-the-startbridgetokensviacbridge-function\" aria-label=\"m 09 should prevent users from sending more native tokens in the startbridgetokensviacbridge function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/207\">[M-09] Should prevent users from sending more native tokens in the <code>startBridgeTokensViaCBridge</code> function</a></h2>\n<p><em>Submitted by shw, also found by hickuphh3, hyh, Picodes, and pmerkleplant</em></p>\n<p>When a user bridges a native token via the <code>startBridgeTokensViaCBridge</code> function of <code>CBridgeFacet</code>, the contract checks whether <code>msg.value >= _cBridgeData.amount</code> holds. In other words, if a user accidentally sends more native tokens than he has to, the contract accepts it but only bridges the <code>_cBridgeData.amount</code> amount of tokens. The rest of the tokens are left in the contract and can be recovered by anyone (see another submission for details).</p>\n<p>Notice that in the similar functions of other facets (e.g., <code>AnyswapFacet</code>, <code>HopFacet</code>), the provided native token is ensured to be the exact bridged amount, which effectively prevents the above scenario of loss of funds.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/CBridgeFacet.sol#L68\">CBridgeFacet.sol#L68</a></p>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider changing <code>>=</code> to <code>==</code> at line 68.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/207#issuecomment-1085690955\">H3xept (Li.Fi) commented</a>:</strong></p>\n<blockquote>\n<p>Fixed by lifinance/lifi-contracts@bb21af9a30ea73393101fc80efaa3a1f7cf25bd1</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/207#issuecomment-1100717383\">gzeon (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Sponsor confirmed with fix.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-10-infinite-approval-to-an-arbitrary-address-can-be-used-to-steal-all-the-funds-from-the-contract\" style=\"position:relative;\"><a href=\"#m-10-infinite-approval-to-an-arbitrary-address-can-be-used-to-steal-all-the-funds-from-the-contract\" aria-label=\"m 10 infinite approval to an arbitrary address can be used to steal all the funds from the contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/160\">[M-10] Infinite approval to an arbitrary address can be used to steal all the funds from the contract</a></h2>\n<p><em>Submitted by WatchPug, also found by catchup, csanuragjain, rayn, and VAD37</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/699c2305fcfb6fe8862b75b26d1d8a2f46a551e6/src/Facets/AnyswapFacet.sol#L131-L157\">AnyswapFacet.sol#L131-L157</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_startBridge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">AnyswapData</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_anyswapData</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Check chain id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">chainid</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">_anyswapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toChainId</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Cannot bridge to the same network.&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">underlyingToken</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IAnyswapToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_anyswapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">underlying</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">underlyingToken</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">IAnyswapRouter</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_anyswapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">router</span><span class=\"mtk1\">).</span><span class=\"mtk11\">wNATIVE</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IAnyswapRouter</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_anyswapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">router</span><span class=\"mtk1\">).</span><span class=\"mtk12\">anySwapOutNative</span><span class=\"mtk1\">{ value: </span><span class=\"mtk12\">_anyswapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> }(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_anyswapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_anyswapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_anyswapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toChainId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_anyswapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Has underlying token?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">underlyingToken</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Give Anyswap approval to bridge tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">LibAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approveERC20</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">underlyingToken</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_anyswapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">router</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_anyswapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">IAnyswapRouter</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_anyswapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">router</span><span class=\"mtk1\">).</span><span class=\"mtk11\">anySwapOutUnderlying</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_anyswapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_anyswapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_anyswapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_anyswapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toChainId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/699c2305fcfb6fe8862b75b26d1d8a2f46a551e6/src/Libraries/LibAsset.sol#L59-L70\">LibAsset.sol#L59-L70</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">approveERC20</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assetId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">spender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">isNativeAsset</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assetId</span><span class=\"mtk1\">))) </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">allowance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">assetId</span><span class=\"mtk1\">.</span><span class=\"mtk11\">allowance</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">spender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">allowance</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">allowance</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">SafeERC20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assetId</span><span class=\"mtk1\">), </span><span class=\"mtk12\">spender</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">SafeERC20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assetId</span><span class=\"mtk1\">), </span><span class=\"mtk12\">spender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_INT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>In the <code>AnyswapFacet.sol</code>, <code>_anyswapData.router</code> is from the caller’s calldata, which can really be any contract, including a fake Anyswap router contract, as long as it complies to the interfaces used.</p>\n<p>And in <code>_startBridge</code>, it will grant infinite approval for the <code>_anyswapData.token</code> to the <code>_anyswapData.router</code>.</p>\n<p>This makes it possible for a attacker to steal all the funds from the contract.</p>\n<p>Which we explained in <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/159\">#159</a>, the diamond contract may be holding some funds for various of reasons.</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Given:</p>\n<p>There are 100 USDC tokens in the contract.</p>\n<ol>\n<li>The attacker can submit a <code>startBridgeTokensViaAnyswap()</code> with a FAKE <code>_anyswapData.router</code>.</li>\n<li>Once the FAKE router contract deployed by the attacker got the infinite approval from the diamond contract, the attacker can call <code>transferFrom()</code> and take all the funds, including the 100 USDC in the contract anytime.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ol>\n<li>Whitelisting the <code>_anyswapData.router</code> rather than trusting user’s inputs;</li>\n<li>Or, only <code>approve()</code> for the amount that required for the current transaction instead of infinite approval.</li>\n</ol>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/160#issuecomment-1096471540\">H3xept (Li.Fi) acknowledged, but disagreed with High severity and commented</a>:</strong></p>\n<blockquote>\n<p>We are aware that the contract allows users to use latent funds, although we disagree on it being an issue as no funds (ERC20 or native) should ever lay in the contract. To make sure that no value is ever kept by the diamond, we now provide refunds for outstanding user value (after bridges/swaps).</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/160#issuecomment-1100709584\">gzeon (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Warden highlighted the vulnerability in <code>AnyswapFacet</code> which would allow attacker to grant approval to arbitrary contract. </p>\n<p>There can be fund leftover in the contract under normal operation, for example <a href=\"https://etherscan.io/tx/0xe78c36dd2c2f21cade00a4099701b9c9f82acc8da568e1048a4d7287ce2e45b0\">this tx</a>. In fact, ~$300 worth of token is left in the LI.Fi smart contract on ETH mainnet <a href=\"https://etherscan.io/address/0x5a9fd7c39a6c488e715437d7b1f3c823d5596ed1\">0x5a9fd7c39a6c488e715437d7b1f3c823d5596ed1</a> as of block 14597316. I don’t think this is High Risk because the max amount lost is no more than allowed slippage, which can be loss to MEV too.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-11-failed-transfer-with-low-level-call-wont-revert\" style=\"position:relative;\"><a href=\"#m-11-failed-transfer-with-low-level-call-wont-revert\" aria-label=\"m 11 failed transfer with low level call wont revert permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/101\">[M-11] Failed transfer with low level call won’t revert</a></h2>\n<p><em>Submitted by GeekyLumberjack, also found by CertoraInc</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Libraries/LibSwap.sol#L42-L46\">LibSwap.sol#L42-L46</a><br></p>\n<p><code>swap</code> is used throughout the code via <code>_executeSwaps</code> in Swapper.sol. According to <a href=\"https://docs.soliditylang.org/en/develop/control-structures.html#error-handling-assert-require-revert-and-exceptions\">Solidity Docs</a> the call may return true even if it was a failure. This may result in user funds lost because funds were transferred into this contract in preparation for the swap. The swap fails but doesn’t revert. There is a way this can happen through GenericSwapFacet.sol due to a missing require that is present in the other facets which is a separate issue but gives this issue more relevance.</p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Alice uses Generic swap with 100 DAI</li>\n<li>Alice’s 100 DAI are sent to the Swapper.sol contract</li>\n<li>The call on swap <code>_swapData.callTo.call{ value: msg.value }(_swapData.callData);</code> fails but returns success due to nonexisting contract</li>\n<li>postSwapBalance = 0</li>\n<li>Alice receives nothing in return</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Check for contract existence.</p>\n<p>A similar issue was awarded a medium <a href=\"https://github.com/code-423n4/2022-01-trader-joe-findings/issues/170\">here</a>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/101\">H3xept (Li.Fi) resolved</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/101#issuecomment-1100717836\">gzeon (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Sponsor confirmed with fix.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-12-reputation-risks-with-contractowner\" style=\"position:relative;\"><a href=\"#m-12-reputation-risks-with-contractowner\" aria-label=\"m 12 reputation risks with contractowner permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/65\">[M-12] Reputation Risks with <code>contractOwner</code></a></h2>\n<p><em>Submitted by hake, also found by catchup, danb, defsec, Jujic, kirk-baird, nedodn, shenwilly, sorrynotsorry, and WatchPug</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/DiamondCutFacet.sol\">DiamondCutFacet.sol</a><br>\n<a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/WithdrawFacet.sol\">WithdrawFacet.sol</a><br>\n<a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/DexManagerFacet.sol\">DexManagerFacet.sol</a></p>\n<p><code>contractOwner</code> has complete freedom to change any functionality and withdraw/rug all assets. Even if well intended the project could still be called out resulting in a damaged reputation <a href=\"https://twitter.com/RugDocIO/status/1411732108029181960\">like in this example</a>.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://twitter.com/RugDocIO/status/1411732108029181960\">https://twitter.com/RugDocIO/status/1411732108029181960</a></p>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Recommend implementing extra safeguards such as:</p>\n<ul>\n<li>Limiting the time period where sensitive functions can be used.</li>\n<li>Having a waiting period before pushed update is executed.</li>\n<li>Using a multisig to mitigate single point of failure in case <code>contractOwner</code> private key leaks.</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/65#issuecomment-1096436051\">H3xept (Li.Fi) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>The bridges/swaps ecosystem is continually changing. Our mission is to allow seamless UX and provide users with new bridging and swapping routes <strong>as fast as possible</strong>. This comes at the cost of having some degree of centralization. We choose the Diamond standard to be able to constantly add new bridges and update the existing ones as they progress as well.</p>\n<p>We agree with the increased safety of a DAO/Multisign mechanism and will provide them in the future. Timelocks are currently not planned, as we want to be able to react fast if we have to disable bridges for security reasons (e.g. if the underlying bridge is being exploited)</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/65#issuecomment-1100712834\">gzeon (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Valid submission as user will approve fund to the contract.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-13-withdrawfacets-withdraw-calls-native-payabletransfer-which-can-be-unusable-for-diamondstorage-owner-contract\" style=\"position:relative;\"><a href=\"#m-13-withdrawfacets-withdraw-calls-native-payabletransfer-which-can-be-unusable-for-diamondstorage-owner-contract\" aria-label=\"m 13 withdrawfacets withdraw calls native payabletransfer which can be unusable for diamondstorage owner contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/14\">[M-13] WithdrawFacet’s <code>withdraw</code> calls native <code>payable.transfer</code>, which can be unusable for DiamondStorage owner contract</a></h2>\n<p><em>Submitted by hyh, also found by Dravee, JMukesh, Jujic, peritoflores, shw, sorrynotsorry, and wuwe1</em></p>\n<p>When <code>withdraw</code> function is used with native token it is being handled with a <code>payable.transfer()</code> call.</p>\n<p>This is unsafe as <code>transfer</code> has hard coded gas budget and can fail when the user is a smart contract. This way any programmatical usage of WithdrawFacet is at risk. Whenever the user either fails to implement the payable fallback function or cumulative gas cost of the function sequence invoked on a native token transfer exceeds 2300 gas consumption limit the native tokens sent end up undelivered and the corresponding user funds return functionality will fail each time.</p>\n<p>WithdrawFacet is a core helper contracts that provides basic withdraw functionality to the system, and this way the impact includes principal funds freeze scenario if the described aspect be violated in the DiamondStorage.contractOwner code.</p>\n<p>Marking the issue as a medium severity as this is a fund freeze case, but limited to the incorrect contractOwner implementation.</p>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When WithdrawFacet’s <code>withdraw</code> is called with <code>_assetAddress</code> being equal to <code>NATIVE_ASSET</code>, the native transfer is handled with <code>payable.transfer()</code> mechanics:</p>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/WithdrawFacet.sol#L28-L31\">WithdrawFacet.sol#L28-L31</a><br></p>\n<p>WithdrawFacet is a part of EIP-2535 setup:</p>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance#diamond-helper-contracts\">Li.Fi Diamond Helper Contracts</a><br></p>\n<h3 id=\"references\" style=\"position:relative;\"><a href=\"#references\" aria-label=\"references permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>References</h3>\n<p>The issues with <code>transfer()</code> are outlined here:</p>\n<p><a href=\"https://consensys.net/diligence/blog/2019/09/stop-using-soliditys-transfer-now/\">Stop Using Solidity’s transfer() Now</a></p>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>As <code>withdraw</code> is runnable by the DiamondStorage.contractOwner only the reentrancy isn’t an issue and <code>transfer()</code> can be just replaced.</p>\n<p>Using low-level <code>call.value(amount)</code> with the corresponding result check or using the OpenZeppelin’s <code>Address.sendValue</code> is advised:</p>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/Address.sol#L60\">Address.sol#L60</a></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/14#issuecomment-1096542341\">H3xept (Li.Fi) resolved and commented</a>:</strong></p>\n<blockquote>\n<p>Fixed in lifinance/lifi-contracts@274a41b047b3863d9ae232eefea04896dc32d853</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/14#issuecomment-1100714322\">gzeon (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Sponsor confirmed with fix.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 42 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/68\">report highlighted below</a> by <strong>hake</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/190\">defsec</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/139\">rayn</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/105\">hyh</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/50\">saian</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/46\">CertoraInc</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/177\">SolidityScan</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/56\">0xDjango</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/40\">hickuphh3</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/29\">0v3rf10w</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/121\">catchup</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/197\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/71\">kenta</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/169\">PPrieditis</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/26\">BouSalman</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/188\">sorrynotsorry</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/52\">Dravee</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/114\">Picodes</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/126\">VAD37</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/72\">dimitri</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/215\">Hawkeye</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/82\">robee</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/81\">shenwilly</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/165\">WatchPug</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/127\">ych18</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/147\">0xkatana</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/179\">obront</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/173\">PranavG</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/79\">aga7hokakological</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/168\">Jujic</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/111\">kirk-baird</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/42\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/116\">cthulhu_cult</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/157\">hubble</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/148\">JMukesh</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/153\">Kenshin</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/202\">peritoflores</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/107\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/7\">samruna</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/204\">shw</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/194\">tchkvsky</a>, and <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/217\">teryanarmen</a>.</em></p>\n<h2 id=\"l-01-initnxtp-can-be-initialized-multiple-times\" style=\"position:relative;\"><a href=\"#l-01-initnxtp-can-be-initialized-multiple-times\" aria-label=\"l 01 initnxtp can be initialized multiple times permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] <code>initNXTP</code> can be initialized multiple times.</h2>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/NXTPFacet.sol#L33-L37\">L33-37</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function initNXTP(ITransactionManager _txMgrAddr) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Storage storage s = getStorage();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        LibDiamond.enforceIsContractOwner();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        s.nxtpTxManager = _txMgrAddr;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>The function <code>initNXTP</code> has init in its name, suggesting that it should only be called once to intiliaze the <code>nxtpTxManager</code>. However, it can be called multiple times to overwrite the address.</p>\n<p>Recommend setting the address in a <code>constructor</code> or reverting if address is already set. Third option would be changing the name from <code>initNXTP</code> to something like <code>setNXTP</code> to better align function names with their functionality.</p>\n<p>Note: Same issue is present in <code>initHop</code> and <code>initCbridge</code>.</p>\n<h2 id=\"l-02-no-zero-value-checks-for-both-_nxtpdataamount-and-msgvalue-in-startbridgetokensvianxtp\" style=\"position:relative;\"><a href=\"#l-02-no-zero-value-checks-for-both-_nxtpdataamount-and-msgvalue-in-startbridgetokensvianxtp\" aria-label=\"l 02 no zero value checks for both _nxtpdataamount and msgvalue in startbridgetokensvianxtp permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] No zero value checks for both <code>_nxtpData.amount</code> and <code>msg.value</code> in <code>startBridgeTokensViaNXTP</code>.</h2>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/NXTPFacet.sol#L46-L60\">L46-60</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function startBridgeTokensViaNXTP(LiFiData memory _lifiData, ITransactionManager.PrepareArgs memory _nxtpData)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        public</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        payable</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Ensure sender has enough to complete the bridge transaction</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address sendingAssetId = _nxtpData.invariantData.sendingAssetId;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (sendingAssetId == address(0)) require(msg.value == _nxtpData.amount, &quot;ERR_INVALID_AMOUNT&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 _sendingAssetIdBalance = LibAsset.getOwnBalance(sendingAssetId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            LibAsset.transferFromERC20(sendingAssetId, msg.sender, address(this), _nxtpData.amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            require(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                LibAsset.getOwnBalance(sendingAssetId) - _sendingAssetIdBalance == _nxtpData.amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                &quot;ERR_INVALID_AMOUNT&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<p>Lack of zero value check on both <code>_nxtpData.amount</code> and <code>msg.value</code> allow bridge to be wastefully started.</p>\n<p>Recommend implementing a <code>require</code> function such as(line 50):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">require(msg.value &gt; 0 || _nxtpData.amount &gt; 0, &quot;Amount must be greater than zero!&quot;);</span></span></code></pre>\n<h2 id=\"l-03-no-zero-address-check-for-adding-dex-contract-in-adddex-batchadddex-removedex-and-batchremovedex\" style=\"position:relative;\"><a href=\"#l-03-no-zero-address-check-for-adding-dex-contract-in-adddex-batchadddex-removedex-and-batchremovedex\" aria-label=\"l 03 no zero address check for adding dex contract in adddex batchadddex removedex and batchremovedex permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] No zero address check for adding DEX contract in <code>addDex</code>, <code>batchAddDex</code>, <code>removeDex</code> and <code>batchRemoveDex</code>.</h2>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/DexManagerFacet.sol#L17-L22\">addDex</a></p>\n<p>Zero address check would prevent adding harmful DEX contracts by mistake. If zero address DEXs are whitelisted, users could burn their tokens on accident.</p>\n<h2 id=\"l-04-unchecked-transfer-in-withdrawfacetsol\" style=\"position:relative;\"><a href=\"#l-04-unchecked-transfer-in-withdrawfacetsol\" aria-label=\"l 04 unchecked transfer in withdrawfacetsol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04] Unchecked <code>transfer</code> in <code>WithdrawFacet.sol</code></h2>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/WithdrawFacet.sol#L20-L36\">WithdrawFacet.sol</a></p>\n<p>Boolean return value for <code>transfer</code> is not checked.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">assert(_amount &lt;= self.balance);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            payable(sendTo).transfer(_amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else {</span></span></code></pre>\n<p>I recommend implementing <code>call</code> instead:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">(bool success, ) = sendTo.call.value(_amount)(&quot;&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">require(success, &quot;Transfer failed.&quot;);</span></span></code></pre>\n<h2 id=\"n-01-initnxtp-and-inithop-emit-no-event\" style=\"position:relative;\"><a href=\"#n-01-initnxtp-and-inithop-emit-no-event\" aria-label=\"n 01 initnxtp and inithop emit no event permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] <code>initNXTP</code> and <code>initHop</code> emit no event.</h2>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/NXTPFacet.sol#L33-L37\">NXTPFacet.sol: L33-37</a><br>\n<a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/HopFacet.sol#L40-L52\">HopFacet.sol: L40-52</a><br></p>\n<p>Emitting an event with the initialization of <code>nxtpTxManager</code> and <code>initHop</code> can increase the protocols transparency and trust. <code>CbridgeFacet.initCbridge</code> emits an event, so keeping it consistent is also good practice.</p>\n<h2 id=\"n-02-minor-typo-in-comment-in-line-31-conatains---contains\" style=\"position:relative;\"><a href=\"#n-02-minor-typo-in-comment-in-line-31-conatains---contains\" aria-label=\"n 02 minor typo in comment in line 31 conatains   contains permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-02] Minor typo in comment in line 31. Conatains - Contains.</h2>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/HopFacet.sol#L131\">L31</a></p>\n<p>Fix typo.</p>\n<h2 id=\"n-03-implementation-of-startbridgetokensviacbridge-has-same-functionality-but-deviates-from-conventions-set-in-startbridgetokensviahop-and-startbridgetokensvianxt\" style=\"position:relative;\"><a href=\"#n-03-implementation-of-startbridgetokensviacbridge-has-same-functionality-but-deviates-from-conventions-set-in-startbridgetokensviahop-and-startbridgetokensvianxt\" aria-label=\"n 03 implementation of startbridgetokensviacbridge has same functionality but deviates from conventions set in startbridgetokensviahop and startbridgetokensvianxt permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-03] Implementation of <code>startBridgeTokensViaCBridge</code> has same functionality but deviates from conventions set in <code>startBridgeTokensViaHop</code> and <code>startBridgeTokensViaNXT</code></h2>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/CBridgeFacet.sol#L57-L84\">L57-84</a><br>\n<a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/HopFacet.sol#L61-L72\">L61-72</a><br></p>\n<p>By comparing <code>startBridgeTokensViaCBridge</code> to <code>startBridgeTokensViaHop</code> and <code>startBridgeTokensViaNXT</code> we can see that the first deviates from the other two, despite containing the same functionality. This hurts readbility. Please implement <code>startBridgeTokensViaCBridge</code> in the same manner the other <code>startBridge</code> functions have been implemented. Differences can be seen below.</p>\n<p><code>startBridgeTokensViaCBridge</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function startBridgeTokensViaCBridge(LiFiData memory _lifiData, CBridgeData calldata _cBridgeData) public payable {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (_cBridgeData.token != address(0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 _fromTokenBalance = LibAsset.getOwnBalance(_cBridgeData.token);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            LibAsset.transferFromERC20(_cBridgeData.token, msg.sender, address(this), _cBridgeData.amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            require(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                LibAsset.getOwnBalance(_cBridgeData.token) - _fromTokenBalance == _cBridgeData.amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                &quot;ERR_INVALID_AMOUNT&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            require(msg.value &gt;= _cBridgeData.amount, &quot;ERR_INVALID_AMOUNT&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<p><code>startBridgeTokensViaHop</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function startBridgeTokensViaHop(LiFiData memory _lifiData, HopData calldata _hopData) public payable {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address sendingAssetId = _bridge(_hopData.asset).token;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (sendingAssetId == address(0)) require(msg.value == _hopData.amount, &quot;ERR_INVALID_AMOUNT&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 _sendingAssetIdBalance = LibAsset.getOwnBalance(sendingAssetId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            LibAsset.transferFromERC20(sendingAssetId, msg.sender, address(this), _hopData.amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            require(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                LibAsset.getOwnBalance(sendingAssetId) - _sendingAssetIdBalance == _hopData.amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                &quot;ERR_INVALID_AMOUNT&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<h2 id=\"n-04-commented-code-in-diamondloupefacetsol\" style=\"position:relative;\"><a href=\"#n-04-commented-code-in-diamondloupefacetsol\" aria-label=\"n 04 commented code in diamondloupefacetsol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-04] Commented code in <code>DiamondLoupeFacet.sol</code>.</h2>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/DiamondLoupeFacet.sol#L9-L16\">DiamondLoupeFacet.sol</a></p>\n<p>Please delete code snippet below as it serves no purpose.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// Diamond Loupe Functions</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ////////////////////////////////////////////////////////////////////</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /// These functions are expected to be called frequently by tools.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // struct Facet {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //     address facetAddress;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //     bytes4[] functionSelectors;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // }</span></span></code></pre>\n<h2 id=\"n-05-incosistent-return-type-within-diamondloupefacetsol-contract\" style=\"position:relative;\"><a href=\"#n-05-incosistent-return-type-within-diamondloupefacetsol-contract\" aria-label=\"n 05 incosistent return type within diamondloupefacetsol contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-05] Incosistent return type within <code>DiamondLoupeFacet.sol</code> contract.</h2>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/DiamondLoupeFacet.sol#L61-L65\">supportsInterface</a></p>\n<p>The function <code>supportsInterface</code> uses an unamed return, while the rest of the contract uses named returns. Please keep it consistent within contracts and accross the project if possible to improve readibility.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function supportsInterface(bytes4 _interfaceId) external view override returns (bool) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        LibDiamond.DiamondStorage storage ds = LibDiamond.diamondStorage();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return ds.supportedInterfaces[_interfaceId];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h2 id=\"n-06-no-events-when-approvingblocking-a-dex-contract\" style=\"position:relative;\"><a href=\"#n-06-no-events-when-approvingblocking-a-dex-contract\" aria-label=\"n 06 no events when approvingblocking a dex contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-06] No events when approving/blocking a DEX contract.</h2>\n<p><a href=\"https://github.com/code-423n4/2022-03-lifinance/blob/main/src/Facets/DexManagerFacet.sol\">DexManagerFacet.sol</a></p>\n<p>Implementing events here would increase transparency and trust.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/68#issuecomment-1092565997\">H3xept (Li.Fi) commented</a>:</strong></p>\n<blockquote>\n<p>[L-01] All init functions are secure as they are marked as onlyOwner; the contract owner might still find it relevant to re-initialise the facet.</p>\n<p>[L-04] Fixed in lifinance/lifi-contracts@9daa1a2bb3a2cf5be938a75746c46fa272b1010a</p>\n<p>[N-06] Fixed in lifinance/lifi-contracts@daa93cb66d510040966a7e226d97da155139dd0d</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 37 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/44\">report highlighted below</a> by <strong>Dravee</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/182\">defsec</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/83\">robee</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/28\">0v3rf10w</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/51\">saian</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/167\">rfa</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/70\">kenta</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/100\">FSchmoede</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/45\">CertoraInc</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/171\">Jujic</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/122\">catchup</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/20\">TerrierLover</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/39\">hickuphh3</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/196\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/172\">Funen</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/178\">SolidityScan</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/183\">Tomio</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/166\">WatchPug</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/170\">PPrieditis</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/99\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/146\">0xkatana</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/69\">hake</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/212\">teryanarmen</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/43\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/125\">ych18</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/201\">peritoflores</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/6\">samruna</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/22\">dimitri</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/49\">minhquanym</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/77\">0xDjango</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/93\">ACai</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/115\">Picodes</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/140\">rayn</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/149\">Kenshin</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/180\">obront</a>, <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/199\">tchkvsky</a>, and <a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/206\">Hawkeye</a>.</em></p>\n<h2 id=\"g-01-storage-help-the-optimizer-by-declaring-a-storage-variable-instead-of-repeatedly-fetching-a-value-in-storage-for-reading-and-writing\" style=\"position:relative;\"><a href=\"#g-01-storage-help-the-optimizer-by-declaring-a-storage-variable-instead-of-repeatedly-fetching-a-value-in-storage-for-reading-and-writing\" aria-label=\"g 01 storage help the optimizer by declaring a storage variable instead of repeatedly fetching a value in storage for reading and writing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Storage: Help the optimizer by declaring a storage variable instead of repeatedly fetching a value in storage (for reading and writing)</h2>\n<p>To help the optimizer, declare a <code>storage</code> type variable and use it instead of repeatedly fetching the value in a map or an array.</p>\n<p>The effect can be quite significant.</p>\n<p>Instances include (check the <code>@audit</code> tags):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DexManagerFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">20</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexWhitelist</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_dex</span><span class=\"mtk1\">] == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">) { </span><span class=\"mtk3\">//@audit gas: fetch 1 for &quot;s.dexWhitelist[_dexs]&quot; (help the optimizer by storing this in a storage variable)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">24</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexWhitelist</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_dex</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">; </span><span class=\"mtk3\">//@audit gas: fetch 2 for &quot;s.dexWhitelist[_dex]&quot; (help the optimizer by using the previously suggested storage variable for this SSTORE)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">34</span><span class=\"mtk1\">:             </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexWhitelist</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_dexs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]] == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">) { </span><span class=\"mtk3\">//@audit gas: fetch 1 for &quot;s.dexWhitelist[_dexs[i]]&quot; (help the optimizer by storing this in a storage variable)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">37</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexWhitelist</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_dexs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">; </span><span class=\"mtk3\">//@audit gas: fetch 2 for &quot;s.dexWhitelist[_dexs[i]]&quot; (help the optimizer by using the previously suggested storage variable for this SSTORE)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">47</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexWhitelist</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_dex</span><span class=\"mtk1\">] == </span><span class=\"mtk4\">false</span><span class=\"mtk1\">) { </span><span class=\"mtk3\">//@audit gas: fetch 1 for &quot;s.dexWhitelist[_dexs]&quot; (help the optimizer by storing this in a storage variable)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">51</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexWhitelist</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_dex</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">false</span><span class=\"mtk1\">; </span><span class=\"mtk3\">//@audit gas: fetch 2 for &quot;s.dexWhitelist[_dex]&quot; (help the optimizer by using the previously suggested storage variable for this SSTORE)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">66</span><span class=\"mtk1\">:             </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexWhitelist</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_dexs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]] == </span><span class=\"mtk4\">false</span><span class=\"mtk1\">) { </span><span class=\"mtk3\">//@audit gas: fetch 1 for &quot;s.dexWhitelist[_dexs[i]]&quot; (help the optimizer by storing this in a storage variable)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">69</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexWhitelist</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_dexs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]] = </span><span class=\"mtk4\">false</span><span class=\"mtk1\">; </span><span class=\"mtk3\">//@audit gas: fetch 2 for &quot;s.dexWhitelist[_dexs[i]]&quot; (help the optimizer by using the previously suggested storage variable for this SSTORE)</span></span></span></code></pre>\n<h2 id=\"g-02-storage-emitting-storage-values\" style=\"position:relative;\"><a href=\"#g-02-storage-emitting-storage-values\" aria-label=\"g 02 storage emitting storage values permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] Storage: Emitting storage values</h2>\n<p>Here, the values emitted shouldn’t be read from storage. The existing memory values should be used instead:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CBridgeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">45</span><span class=\"mtk1\">          </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">cBridge</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_cBridge</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">46</span><span class=\"mtk1\">          </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">cBridgeChainId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_chainId</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">47</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Inited</span><span class=\"mtk1\">(</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">cBridge</span><span class=\"mtk1\">, </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">cBridgeChainId</span><span class=\"mtk1\">); </span><span class=\"mtk3\">//@audit gas: should emit Inited(_cBridge, _chainId)</span></span></span></code></pre>\n<h2 id=\"g-03-variables-no-need-to-explicitly-initialize-variables-with-default-values\" style=\"position:relative;\"><a href=\"#g-03-variables-no-need-to-explicitly-initialize-variables-with-default-values\" aria-label=\"g 03 variables no need to explicitly initialize variables with default values permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] Variables: No need to explicitly initialize variables with default values</h2>\n<p>If a variable is not set/initialized, it is assumed to have the default value (<code>0</code> for <code>uint</code>, <code>false</code> for <code>bool</code>, <code>address(0)</code> for address…). Explicitly initializing it with its default value is an anti-pattern and wastes gas.</p>\n<p>Instances include:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">WithdrawFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">10</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">NATIVE_ASSET</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibAsset</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">21</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">NATIVE_ASSETID</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>I suggest removing explicit initializations for default values.</p>\n<h2 id=\"g-04-variables-constants-expressions-are-expressions-not-constants\" style=\"position:relative;\"><a href=\"#g-04-variables-constants-expressions-are-expressions-not-constants\" aria-label=\"g 04 variables constants expressions are expressions not constants permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] Variables: “constants” expressions are expressions, not constants</h2>\n<p>Due to how <code>constant</code> variables are implemented (replacements at compile-time), an expression assigned to a <code>constant</code> variable is recomputed each time that the variable is used, which wastes some gas.</p>\n<p>If the variable was <code>immutable</code> instead: the calculation would only be done once at deploy time (in the constructor), and then the result would be saved and read directly at runtime rather than being recalculated.</p>\n<p>See: <a href=\"https://github.com/ethereum/solidity/issues/9232\">ethereum/solidity#9232</a></p>\n<blockquote>\n<p>Consequences: each usage of a “constant” costs ~100gas more on each access (it is still a little better than storing the result in storage, but not much..). since these are not real constants, they can’t be referenced from a real constant environment (e.g. from assembly, or from another library )</p>\n</blockquote>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CBridgeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">18</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">NAMESPACE</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;com.lifi.facets.cbridge2&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">HopFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">18</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">NAMESPACE</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;com.lifi.facets.hop&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NXTPFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">18</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">NAMESPACE</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;com.lifi.facets.nxtp&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">7</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">DIAMOND_STORAGE_POSITION</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;diamond.standard.diamond.storage&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Change these expressions from <code>constant</code> to <code>immutable</code> and implement the calculation in the constructor or hardcode these values in the constants and add a comment to say how the value was calculated.</p>\n<h2 id=\"g-05-comparisons-boolean-comparisons\" style=\"position:relative;\"><a href=\"#g-05-comparisons-boolean-comparisons\" aria-label=\"g 05 comparisons boolean comparisons permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] Comparisons: Boolean comparisons</h2>\n<p>Comparing to a constant (<code>true</code> or <code>false</code>) is a bit more expensive than directly checking the returned boolean value.\nI suggest using <code>if(directValue)</code> instead of <code>if(directValue == true)</code> and <code>if(!directValue)</code> instead of <code>if(directValue == false)</code> here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DexManagerFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">20</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexWhitelist</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_dex</span><span class=\"mtk1\">] == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DexManagerFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">34</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexWhitelist</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_dexs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]] == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DexManagerFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">47</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexWhitelist</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_dex</span><span class=\"mtk1\">] == </span><span class=\"mtk4\">false</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DexManagerFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">66</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexWhitelist</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_dexs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]] == </span><span class=\"mtk4\">false</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Swapper</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">16</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">ls</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexWhitelist</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_swapData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">approveTo</span><span class=\"mtk1\">] == </span><span class=\"mtk4\">true</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">ls</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexWhitelist</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_swapData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">callTo</span><span class=\"mtk1\">] == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span></code></pre>\n<h2 id=\"g-06-comparisons--0-is-less-efficient-than--0-for-unsigned-integers-with-proof\" style=\"position:relative;\"><a href=\"#g-06-comparisons--0-is-less-efficient-than--0-for-unsigned-integers-with-proof\" aria-label=\"g 06 comparisons  0 is less efficient than  0 for unsigned integers with proof permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] Comparisons: <code>> 0</code> is less efficient than <code>!= 0</code> for unsigned integers (with proof)</h2>\n<p><code>!= 0</code> costs less gas compared to <code>> 0</code> for unsigned integers in <code>require</code> statements with the optimizer enabled (6 gas)</p>\n<p>Proof: While it may seem that <code>> 0</code> is cheaper than <code>!=</code>, this is only true without the optimizer enabled and outside a require statement. If you enable the optimizer at 10k AND you’re in a <code>require</code> statement, this will save gas. You can see this tweet for more proofs: <a href=\"https://twitter.com/gzeon/status/1485428085885640706\">https://twitter.com/gzeon/status/1485428085885640706</a></p>\n<p>I suggest changing <code>> 0</code> with <code>!= 0</code> here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AnyswapFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">92</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_postSwapBalance</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERR_INVALID_AMOUNT&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AnyswapFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">105</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_postSwapBalance</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERR_INVALID_AMOUNT&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CBridgeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">105</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_postSwapBalance</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERR_INVALID_AMOUNT&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CBridgeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">116</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_postSwapBalance</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERR_INVALID_AMOUNT&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">HopFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">109</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_postSwapBalance</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERR_INVALID_AMOUNT&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NXTPFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">98</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_postSwapBalance</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERR_INVALID_AMOUNT&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">84</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LibDiamondCut: No selectors in facet to cut&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">102</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LibDiamondCut: No selectors in facet to cut&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">121</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LibDiamondCut: No selectors in facet to cut&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">189</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_calldata</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LibDiamondCut: _calldata is empty but _init is not address(0)&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">212</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contractSize</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_errorMessage</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Also, please enable the Optimizer.</p>\n<h2 id=\"g-07-for-loops-an-arrays-length-should-be-cached-to-save-gas-in-for-loops\" style=\"position:relative;\"><a href=\"#g-07-for-loops-an-arrays-length-should-be-cached-to-save-gas-in-for-loops\" aria-label=\"g 07 for loops an arrays length should be cached to save gas in for loops permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-07] For-Loops: An array’s length should be cached to save gas in for-loops</h2>\n<p>Reading array length at each iteration of the loop takes 6 gas (3 for mload and 3 to place memory_offset) in the stack.</p>\n<p>Caching the array length in the stack saves around 3 gas per iteration.</p>\n<p>Here, I suggest storing the array’s length in a variable before the for-loop, and use it instead:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DexManagerFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">33</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_dexs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DexManagerFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">52</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DexManagerFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">65</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_dexs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DexManagerFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">70</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">HopFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">48</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_tokens</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Swapper</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">14</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_swapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">67</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">facetIndex</span><span class=\"mtk1\">; </span><span class=\"mtk12\">facetIndex</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_diamondCut</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">facetIndex</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">92</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\">; </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">110</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\">; </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">125</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\">; </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p>This is already done here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DiamondLoupeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">24</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numFacets</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<h2 id=\"g-08-for-loops-i-costs-less-gas-compared-to-i\" style=\"position:relative;\"><a href=\"#g-08-for-loops-i-costs-less-gas-compared-to-i\" aria-label=\"g 08 for loops i costs less gas compared to i permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-08] For-Loops: <code>++i</code> costs less gas compared to <code>i++</code></h2>\n<p><code>++i</code> costs less gas compared to <code>i++</code> for unsigned integer, as pre-increment is cheaper (about 5 gas per iteration)</p>\n<p><code>i++</code> increments <code>i</code> and returns the initial value of <code>i</code>. Which means:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">i</span><span class=\"mtk1\">++; </span><span class=\"mtk3\">// == 1 but i == 2  </span></span></span></code></pre>\n<p>But <code>++i</code> returns the actual incremented value:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// == 2 and i == 2 too, so no need for a temporary variable  </span></span></span></code></pre>\n<p>In the first case, the compiler has to create a temporary variable (when used) for returning <code>1</code> instead of <code>2</code></p>\n<p>Instances include:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DexManagerFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">33</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_dexs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DexManagerFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">52</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DexManagerFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">65</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_dexs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DexManagerFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">70</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DiamondLoupeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">24</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numFacets</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">HopFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">48</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_tokens</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Swapper</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">14</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_swapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">67</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">facetIndex</span><span class=\"mtk1\">; </span><span class=\"mtk12\">facetIndex</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_diamondCut</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">facetIndex</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">92</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\">; </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">97</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">selectorPosition</span><span class=\"mtk1\">++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">110</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\">; </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">116</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">selectorPosition</span><span class=\"mtk1\">++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">125</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\">; </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p>I suggest using <code>++i</code> instead of <code>i++</code> to increment the value of an uint variable.</p>\n<h2 id=\"g-09-for-loops-increments-can-be-unchecked\" style=\"position:relative;\"><a href=\"#g-09-for-loops-increments-can-be-unchecked\" aria-label=\"g 09 for loops increments can be unchecked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-09] For-Loops: Increments can be unchecked</h2>\n<p>In Solidity 0.8+, there’s a default overflow check on unsigned integers. It’s possible to uncheck this in for-loops and save some gas at each iteration, but at the cost of some code readability, as this uncheck cannot be made inline.</p>\n<p><a href=\"https://github.com/ethereum/solidity/issues/10695\">ethereum/solidity#10695</a></p>\n<p>Instances include:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DexManagerFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">33</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_dexs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DexManagerFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">52</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DexManagerFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">65</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_dexs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DexManagerFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">70</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DiamondLoupeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">24</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numFacets</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">67</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">facetIndex</span><span class=\"mtk1\">; </span><span class=\"mtk12\">facetIndex</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_diamondCut</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">facetIndex</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">92</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\">; </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">97</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">selectorPosition</span><span class=\"mtk1\">++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">110</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\">; </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">116</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">selectorPosition</span><span class=\"mtk1\">++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">125</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\">; </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">selectorIndex</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p>The code would go from:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numIterations</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk3\">// ...  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}  </span></span></span></code></pre>\n<p>to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numIterations</span><span class=\"mtk1\">;) {  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk3\">// ...  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> { ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">; }  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}  </span></span></span></code></pre>\n<p>I suggest not unchecking the increments at these places as the risk of overflow is existent for <code>uint8</code> there:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">HopFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">48</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_tokens</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Swapper</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">14</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_swapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<h2 id=\"g-10-arithmetics-unchecked-blocks-for-arithmetics-operations-that-cant-underflowoverflow\" style=\"position:relative;\"><a href=\"#g-10-arithmetics-unchecked-blocks-for-arithmetics-operations-that-cant-underflowoverflow\" aria-label=\"g 10 arithmetics unchecked blocks for arithmetics operations that cant underflowoverflow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-10] Arithmetics: <code>unchecked</code> blocks for arithmetics operations that can’t underflow/overflow</h2>\n<p>Solidity version 0.8+ comes with implicit overflow and underflow checks on unsigned integers. When an overflow or an underflow isn’t possible (as an example, when a comparison is made before the arithmetic operation, or the operation doesn’t depend on user input), some gas can be saved by using an <code>unchecked</code> block: <a href=\"https://docs.soliditylang.org/en/v0.8.10/control-structures.html#checked-or-unchecked-arithmetic\">Checked or Unchecked Arithmetic</a>.<br></p>\n<p>I suggest wrapping with an <code>unchecked</code> block here (see <code>@audit</code> tags for more details):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AnyswapFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">46</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">LibAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getOwnBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">underlyingToken</span><span class=\"mtk1\">) - </span><span class=\"mtk12\">_fromTokenBalance</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_anyswapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk3\">//@audit gas: should be unchecked (can&#39;t underflow)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">90</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_postSwapBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">LibAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getOwnBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">underlyingToken</span><span class=\"mtk1\">) - </span><span class=\"mtk12\">_fromTokenBalance</span><span class=\"mtk1\">;  </span><span class=\"mtk3\">//@audit gas: should be unchecked (can&#39;t underflow)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">101</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">).</span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_fromBalance</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">_anyswapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERR_INVALID_AMOUNT&quot;</span><span class=\"mtk1\">);  </span><span class=\"mtk3\">//@audit gas: should be unchecked (can&#39;t underflow)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">103</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_postSwapBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">).</span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_fromBalance</span><span class=\"mtk1\">;  </span><span class=\"mtk3\">//@audit gas: should be unchecked (can&#39;t underflow)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CBridgeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">64</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">LibAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getOwnBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_cBridgeData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">) - </span><span class=\"mtk12\">_fromTokenBalance</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_cBridgeData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,  </span><span class=\"mtk3\">//@audit gas: should be unchecked (can&#39;t underflow)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">103</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_postSwapBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">LibAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getOwnBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_cBridgeData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">) - </span><span class=\"mtk12\">_fromTokenBalance</span><span class=\"mtk1\">;  </span><span class=\"mtk3\">//@audit gas: should be unchecked (can&#39;t underflow)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">114</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_postSwapBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">).</span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_fromBalance</span><span class=\"mtk1\">;  </span><span class=\"mtk3\">//@audit gas: should be unchecked (can&#39;t underflow)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DexManagerFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">85</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">index</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dexs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">];  </span><span class=\"mtk3\">//@audit gas: should be unchecked (used in a for-loop that wouldn&#39;t call this function if &quot;s.dexs.length == 0&quot;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">GenericSwapFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">28</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">postSwapBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">LibAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getOwnBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_lifiData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">receivingAssetId</span><span class=\"mtk1\">) - </span><span class=\"mtk12\">receivingAssetIdBalance</span><span class=\"mtk1\">;  </span><span class=\"mtk3\">//@audit gas: should be unchecked (can&#39;t underflow)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">HopFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">69</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">LibAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getOwnBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sendingAssetId</span><span class=\"mtk1\">) - </span><span class=\"mtk12\">_sendingAssetIdBalance</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_hopData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,  </span><span class=\"mtk3\">//@audit gas: should be unchecked (can&#39;t underflow)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">107</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_postSwapBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">LibAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getOwnBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sendingAssetId</span><span class=\"mtk1\">) - </span><span class=\"mtk12\">_sendingAssetIdBalance</span><span class=\"mtk1\">;  </span><span class=\"mtk3\">//@audit gas: should be unchecked (can&#39;t underflow)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NXTPFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">57</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">LibAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getOwnBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sendingAssetId</span><span class=\"mtk1\">) - </span><span class=\"mtk12\">_sendingAssetIdBalance</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_nxtpData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,  </span><span class=\"mtk3\">//@audit gas: should be unchecked (can&#39;t underflow)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">96</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_postSwapBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">LibAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getOwnBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sendingAssetId</span><span class=\"mtk1\">) - </span><span class=\"mtk12\">_sendingAssetIdBalance</span><span class=\"mtk1\">;  </span><span class=\"mtk3\">//@audit gas: should be unchecked (can&#39;t underflow)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">165</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">postSwapBalance</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">startingBalance</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">166</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">finalBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">postSwapBalance</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">startingBalance</span><span class=\"mtk1\">;  </span><span class=\"mtk3\">//@audit gas: should be unchecked (see L165)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">159</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastSelectorPosition</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ds</span><span class=\"mtk1\">.</span><span class=\"mtk12\">facetFunctionSelectors</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_facetAddress</span><span class=\"mtk1\">].</span><span class=\"mtk12\">functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">; </span><span class=\"mtk3\">//@audit gas: should be unchecked (only called inside for-loops of length &gt; 0)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">173</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastFacetAddressPosition</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ds</span><span class=\"mtk1\">.</span><span class=\"mtk12\">facetAddresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">; </span><span class=\"mtk3\">//@audit gas: should be unchecked (only called inside for-loops of length &gt; 0)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibSwap</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">48</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">toAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">LibAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getOwnBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_swapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">receivingAssetId</span><span class=\"mtk1\">) - </span><span class=\"mtk12\">toAmount</span><span class=\"mtk1\">; </span><span class=\"mtk3\">//@audit gas: should be unchecked (can&#39;t underflow)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibUtil</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">11</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_res</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">68</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;Transaction reverted silently&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">12</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">revertData</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_res</span><span class=\"mtk1\">.</span><span class=\"mtk11\">slice</span><span class=\"mtk1\">(</span><span class=\"mtk7\">4</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_res</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">4</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// Remove the selector which is the first 4 bytes //@audit gas: should be unchecked (see L11)</span></span></span></code></pre>\n<h2 id=\"g-11-visibility-public-functions-to-external\" style=\"position:relative;\"><a href=\"#g-11-visibility-public-functions-to-external\" aria-label=\"g 11 visibility public functions to external permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-11] Visibility: Public functions to external</h2>\n<p>The following functions could be set external to save gas and improve code quality.\nExternal call cost is less expensive than of public functions.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> - </span><span class=\"mtk12\">AnyswapFacet</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startBridgeTokensViaAnyswap</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ILiFi</span><span class=\"mtk1\">.</span><span class=\"mtk12\">LiFiData</span><span class=\"mtk1\">,</span><span class=\"mtk12\">AnyswapFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">AnyswapData</span><span class=\"mtk1\">) (</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AnyswapFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">#</span><span class=\"mtk7\">35</span><span class=\"mtk1\">-</span><span class=\"mtk7\">66</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> - </span><span class=\"mtk12\">CBridgeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startBridgeTokensViaCBridge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ILiFi</span><span class=\"mtk1\">.</span><span class=\"mtk12\">LiFiData</span><span class=\"mtk1\">,</span><span class=\"mtk12\">CBridgeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">CBridgeData</span><span class=\"mtk1\">) (</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CBridgeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">#</span><span class=\"mtk7\">57</span><span class=\"mtk1\">-</span><span class=\"mtk7\">84</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> - </span><span class=\"mtk12\">GenericSwapFacet</span><span class=\"mtk1\">.</span><span class=\"mtk11\">swapTokensGeneric</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ILiFi</span><span class=\"mtk1\">.</span><span class=\"mtk12\">LiFiData</span><span class=\"mtk1\">,</span><span class=\"mtk12\">LibSwap</span><span class=\"mtk1\">.</span><span class=\"mtk12\">SwapData</span><span class=\"mtk1\">[]) (</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">GenericSwapFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">#</span><span class=\"mtk7\">22</span><span class=\"mtk1\">-</span><span class=\"mtk7\">43</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> - </span><span class=\"mtk12\">HopFacet</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startBridgeTokensViaHop</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ILiFi</span><span class=\"mtk1\">.</span><span class=\"mtk12\">LiFiData</span><span class=\"mtk1\">,</span><span class=\"mtk12\">HopFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">HopData</span><span class=\"mtk1\">) (</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">HopFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">#</span><span class=\"mtk7\">61</span><span class=\"mtk1\">-</span><span class=\"mtk7\">87</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> - </span><span class=\"mtk12\">NXTPFacet</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startBridgeTokensViaNXTP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ILiFi</span><span class=\"mtk1\">.</span><span class=\"mtk12\">LiFiData</span><span class=\"mtk1\">,</span><span class=\"mtk12\">ITransactionManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">PrepareArgs</span><span class=\"mtk1\">) (</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NXTPFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">#</span><span class=\"mtk7\">46</span><span class=\"mtk1\">-</span><span class=\"mtk7\">76</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> - </span><span class=\"mtk12\">NXTPFacet</span><span class=\"mtk1\">.</span><span class=\"mtk11\">completeBridgeTokensViaNXTP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ILiFi</span><span class=\"mtk1\">.</span><span class=\"mtk12\">LiFiData</span><span class=\"mtk1\">,</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) (</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NXTPFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">#</span><span class=\"mtk7\">124</span><span class=\"mtk1\">-</span><span class=\"mtk7\">140</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> - </span><span class=\"mtk12\">NXTPFacet</span><span class=\"mtk1\">.</span><span class=\"mtk11\">swapAndCompleteBridgeTokensViaNXTP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ILiFi</span><span class=\"mtk1\">.</span><span class=\"mtk12\">LiFiData</span><span class=\"mtk1\">,</span><span class=\"mtk12\">LibSwap</span><span class=\"mtk1\">.</span><span class=\"mtk12\">SwapData</span><span class=\"mtk1\">[],</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) (</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NXTPFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">#</span><span class=\"mtk7\">150</span><span class=\"mtk1\">-</span><span class=\"mtk7\">171</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> - </span><span class=\"mtk12\">WithdrawFacet</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) (</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">WithdrawFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">#</span><span class=\"mtk7\">20</span><span class=\"mtk1\">-</span><span class=\"mtk7\">38</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<h2 id=\"g-12-errors-reduce-the-size-of-error-messages-long-revert-strings\" style=\"position:relative;\"><a href=\"#g-12-errors-reduce-the-size-of-error-messages-long-revert-strings\" aria-label=\"g 12 errors reduce the size of error messages long revert strings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-12] Errors: Reduce the size of error messages (Long revert Strings)</h2>\n<p>Shortening revert strings to fit in 32 bytes will decrease deployment time gas and will decrease runtime gas when the revert condition is met.</p>\n<p>Revert strings that are longer than 32 bytes require at least one additional mstore, along with additional overhead for computing memory offset, etc.</p>\n<p>Revert strings > 32 bytes:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AnyswapFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">133</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">chainid</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">_anyswapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toChainId</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Cannot bridge to the same network.&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CBridgeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">147</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">cBridgeChainId</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">_cBridgeData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dstChainId</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Cannot bridge to the same network.&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">HopFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">146</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hopChainId</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">_hopData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">chainId</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Cannot bridge to the same network.&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">56</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">diamondStorage</span><span class=\"mtk1\">().</span><span class=\"mtk12\">contractOwner</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LibDiamond: Must be contract owner&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">76</span><span class=\"mtk1\">:                </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;LibDiamondCut: Incorrect FacetCutAction&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">84</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LibDiamondCut: No selectors in facet to cut&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">86</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_facetAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;LibDiamondCut: Add facet can&#39;t be address(0)&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">95</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oldFacetAddress</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;LibDiamondCut: Can&#39;t add function that already exists&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">102</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LibDiamondCut: No selectors in facet to cut&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">104</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_facetAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;LibDiamondCut: Add facet can&#39;t be address(0)&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">113</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oldFacetAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">_facetAddress</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LibDiamondCut: Can&#39;t replace function with same function&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">121</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LibDiamondCut: No selectors in facet to cut&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">124</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_facetAddress</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;LibDiamondCut: Remove facet address must be address(0)&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">133</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">enforceHasContractCode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_facetAddress</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LibDiamondCut: New facet has no code&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">154</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_facetAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;LibDiamondCut: Can&#39;t remove function that doesn&#39;t exist&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">156</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_facetAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;LibDiamondCut: Can&#39;t remove immutable function&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">187</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_calldata</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LibDiamondCut: _init is address(0) but_calldata is not empty&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">189</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_calldata</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LibDiamondCut: _calldata is empty but _init is not address(0)&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">200</span><span class=\"mtk1\">:                    </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;LibDiamondCut: _init function reverted&quot;</span><span class=\"mtk1\">); </span></span></span></code></pre>\n<p>I suggest shortening the revert strings to fit in 32 bytes, or that using custom errors as described next.</p>\n<h2 id=\"g-13-errors-use-custom-errors-instead-of-revert-strings-to-save-gas\" style=\"position:relative;\"><a href=\"#g-13-errors-use-custom-errors-instead-of-revert-strings-to-save-gas\" aria-label=\"g 13 errors use custom errors instead of revert strings to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-13] Errors: Use Custom Errors instead of Revert Strings to save Gas</h2>\n<p>Custom errors from Solidity 0.8.4 are cheaper than revert strings (cheaper deployment cost and runtime cost when the revert condition is met)</p>\n<p>Source: <a href=\"https://blog.soliditylang.org/2021/04/21/custom-errors/\">Custom Errors in Solidity</a>:</p>\n<blockquote>\n<p>Starting from <a href=\"https://github.com/ethereum/solidity/releases/tag/v0.8.4\">Solidity v0.8.4</a>, there is a convenient and gas-efficient way to explain to users why an operation failed through the use of custom errors. Until now, you could already use strings to give more information about failures (e.g., <code>revert(\"Insufficient funds.\");</code>), but they are rather expensive, especially when it comes to deploy cost, and it is difficult to use dynamic information in them.</p>\n</blockquote>\n<p>Custom errors are defined using the <code>error</code> statement, which can be used inside and outside of contracts (including interfaces and libraries).</p>\n<p>Instances include:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AnyswapFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">45</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AnyswapFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">50</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_anyswapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERR_INVALID_AMOUNT&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AnyswapFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">92</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_postSwapBalance</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERR_INVALID_AMOUNT&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AnyswapFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">101</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">).</span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_fromBalance</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">_anyswapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERR_INVALID_AMOUNT&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AnyswapFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">105</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_postSwapBalance</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERR_INVALID_AMOUNT&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AnyswapFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">133</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">chainid</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">_anyswapData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">toChainId</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Cannot bridge to the same network.&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CBridgeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">63</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CBridgeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">68</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">_cBridgeData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERR_INVALID_AMOUNT&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CBridgeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">105</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_postSwapBalance</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERR_INVALID_AMOUNT&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CBridgeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">116</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_postSwapBalance</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERR_INVALID_AMOUNT&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CBridgeFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">147</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">cBridgeChainId</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">_cBridgeData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dstChainId</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Cannot bridge to the same network.&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">HopFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">64</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">sendingAssetId</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_hopData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERR_INVALID_AMOUNT&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">HopFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">68</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">HopFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">109</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_postSwapBalance</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERR_INVALID_AMOUNT&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">HopFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">146</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hopChainId</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">_hopData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">chainId</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Cannot bridge to the same network.&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NXTPFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">52</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">sendingAssetId</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_nxtpData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERR_INVALID_AMOUNT&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NXTPFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">56</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NXTPFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">98</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_postSwapBalance</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERR_INVALID_AMOUNT&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NXTPFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">131</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;INVALID_ETH_AMOUNT&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NXTPFacet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">133</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ETH_WITH_ERC&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Facets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Swapper</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">15</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibAsset</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">50</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;#TNA:028&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibAsset</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">114</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(!</span><span class=\"mtk11\">isNativeAsset</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assetId</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;#IA:034&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibAsset</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">129</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(!</span><span class=\"mtk11\">isNativeAsset</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assetId</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;#DA:034&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">56</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">diamondStorage</span><span class=\"mtk1\">().</span><span class=\"mtk12\">contractOwner</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LibDiamond: Must be contract owner&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">84</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LibDiamondCut: No selectors in facet to cut&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">86</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_facetAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;LibDiamondCut: Add facet can&#39;t be address(0)&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">95</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oldFacetAddress</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;LibDiamondCut: Can&#39;t add function that already exists&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">102</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LibDiamondCut: No selectors in facet to cut&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">104</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_facetAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;LibDiamondCut: Add facet can&#39;t be address(0)&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">113</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oldFacetAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">_facetAddress</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LibDiamondCut: Can&#39;t replace function with same function&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">121</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_functionSelectors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LibDiamondCut: No selectors in facet to cut&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">124</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_facetAddress</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;LibDiamondCut: Remove facet address must be address(0)&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">154</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_facetAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;LibDiamondCut: Can&#39;t remove function that doesn&#39;t exist&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">156</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_facetAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;LibDiamondCut: Can&#39;t remove immutable function&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">187</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_calldata</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LibDiamondCut: _init is address(0) but_calldata is not empty&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">189</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_calldata</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LibDiamondCut: _calldata is empty but _init is not address(0)&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LibDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">212</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contractSize</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_errorMessage</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiFiDiamond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">38</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">facet</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Diamond: Function does not exist&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>I suggest replacing revert strings with custom errors.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-03-lifinance-findings/issues/44#issuecomment-1084404471\">H3xept (Li.Fi) commented</a>:</strong></p>\n<blockquote>\n<p><strong>Re: No need to explicitly initialize variables with default values</strong><br>\n<code>constant</code> variables must have an initialiser — but your suggestion is right. I changed <br>\n<code>address private constant NATIVE_ASSET = address(0)</code><br>\nto <br>\n<code>address private constant NATIVE_ASSET = 0x0000000000000000000000000000000000000000;</code></p>\n<p><strong>Re: ++i</strong><br>\nWe internally decided not to have prefix increments for now.</p>\n<p><strong>Re: unchecked maths</strong><br>\nWe internally decided to avoid unchecked operations for now.</p>\n<p><strong>Re: prefix increments</strong><br>\nWe internally decided to avoid previx increments for now.</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-2\">High Risk Findings (2)</a></p>\n<ul>\n<li><a href=\"#h-01-reliance-on-lifidatareceivingassetid-can-cause-loss-of-funds\">[H-01] Reliance on <code>lifiData.receivingAssetId</code> can cause loss of funds</a></li>\n<li><a href=\"#h-02-all-swapping-functions-lack-checks-for-returned-tokens\">[H-02] All swapping functions lack checks for returned tokens</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-13\">Medium Risk Findings (13)</a></p>\n<ul>\n<li><a href=\"#m-01-anyswapfacet-can-be-exploited-to-approve-arbitrary-tokens\">[M-01] <code>AnyswapFacet</code> can be exploited to approve arbitrary tokens.</a></li>\n<li><a href=\"#m-02-anyone-can-get-swaps-for-free-given-certain-conditions-in-swap\">[M-02] Anyone can get swaps for free given certain conditions in <code>swap</code>.</a></li>\n<li><a href=\"#m-03-libswap-excess-funds-from-swaps-are-not-returned\">[M-03] LibSwap: Excess funds from swaps are not returned</a></li>\n<li><a href=\"#m-04-msgvalue-is-sent-multipletimes-when-performing-a-swap\">[M-04] <code>msg.value</code> is Sent Multipletimes When Performing a Swap</a></li>\n<li><a href=\"#m-05-cbridge-integration-fails-to-send-native-tokens\">[M-05] cBridge integration fails to send native tokens</a></li>\n<li><a href=\"#m-06-dexmanagerfacet-batchremovedex-removes-first-dex-only\">[M-06] DexManagerFacet: batchRemoveDex() removes first dex only</a></li>\n<li><a href=\"#m-07-erc20-bridging-functions-do-not-revert-on-non-zero-msgvalue\">[M-07] ERC20 bridging functions do not revert on non-zero msg.value</a></li>\n<li><a href=\"#m-08-swap-functions-are-reenterable\">[M-08] Swap functions are Reenterable</a></li>\n<li><a href=\"#m-09-should-prevent-users-from-sending-more-native-tokens-in-the-startbridgetokensviacbridge-function\">[M-09] Should prevent users from sending more native tokens in the <code>startBridgeTokensViaCBridge</code> function</a></li>\n<li><a href=\"#m-10-infinite-approval-to-an-arbitrary-address-can-be-used-to-steal-all-the-funds-from-the-contract\">[M-10] Infinite approval to an arbitrary address can be used to steal all the funds from the contract</a></li>\n<li><a href=\"#m-11-failed-transfer-with-low-level-call-wont-revert\">[M-11] Failed transfer with low level call won’t revert</a></li>\n<li><a href=\"#m-12-reputation-risks-with-contractowner\">[M-12] Reputation Risks with <code>contractOwner</code></a></li>\n<li><a href=\"#m-13-withdrawfacets-withdraw-calls-native-payabletransfer-which-can-be-unusable-for-diamondstorage-owner-contract\">[M-13] WithdrawFacet’s <code>withdraw</code> calls native <code>payable.transfer</code>, which can be unusable for DiamondStorage owner contract</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#l-01-initnxtp-can-be-initialized-multiple-times\">L-01 <code>initNXTP</code> can be initialized multiple times.</a></li>\n<li><a href=\"#l-02-no-zero-value-checks-for-both-_nxtpdataamount-and-msgvalue-in-startbridgetokensvianxtp\">L-02 No zero value checks for both <code>_nxtpData.amount</code> and <code>msg.value</code> in <code>startBridgeTokensViaNXTP</code>.</a></li>\n<li><a href=\"#l-03-no-zero-address-check-for-adding-dex-contract-in-adddex-batchadddex-removedex-and-batchremovedex\">L-03 No zero address check for adding DEX contract in <code>addDex</code>, <code>batchAddDex</code>, <code>removeDex</code> and <code>batchRemoveDex</code>.</a></li>\n<li><a href=\"#l-04-unchecked-transfer-in-withdrawfacetsol\">L-04 Unchecked <code>transfer</code> in <code>WithdrawFacet.sol</code></a></li>\n<li><a href=\"#n-01-initnxtp-and-inithop-emit-no-event\">N-01 <code>initNXTP</code> and <code>initHop</code> emit no event.</a></li>\n<li><a href=\"#n-02-minor-typo-in-comment-in-line-31-conatains---contains\">N-02 Minor typo in comment in line 31. Conatains - Contains.</a></li>\n<li><a href=\"#n-03-implementation-of-startbridgetokensviacbridge-has-same-functionality-but-deviates-from-conventions-set-in-startbridgetokensviahop-and-startbridgetokensvianxt\">N-03 Implementation of <code>startBridgeTokensViaCBridge</code> has same functionality but deviates from conventions set in <code>startBridgeTokensViaHop</code> and <code>startBridgeTokensViaNXT</code></a></li>\n<li><a href=\"#n-04-commented-code-in-diamondloupefacetsol\">N-04 Commented code in <code>DiamondLoupeFacet.sol</code>.</a></li>\n<li><a href=\"#n-05-incosistent-return-type-within-diamondloupefacetsol-contract\">N-05 Incosistent return type within <code>DiamondLoupeFacet.sol</code> contract.</a></li>\n<li><a href=\"#n-06-no-events-when-approvingblocking-a-dex-contract\">N-06 No events when approving/blocking a DEX contract.</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#g-01-storage-help-the-optimizer-by-declaring-a-storage-variable-instead-of-repeatedly-fetching-a-value-in-storage-for-reading-and-writing\">G-01 Storage: Help the optimizer by declaring a storage variable instead of repeatedly fetching a value in storage (for reading and writing)</a></li>\n<li><a href=\"#g-02-storage-emitting-storage-values\">G-02 Storage: Emitting storage values</a></li>\n<li><a href=\"#g-03-variables-no-need-to-explicitly-initialize-variables-with-default-values\">G-03 Variables: No need to explicitly initialize variables with default values</a></li>\n<li><a href=\"#g-04-variables-constants-expressions-are-expressions-not-constants\">G-04 Variables: “constants” expressions are expressions, not constants</a></li>\n<li><a href=\"#g-05-comparisons-boolean-comparisons\">G-05 Comparisons: Boolean comparisons</a></li>\n<li><a href=\"#g-06-comparisons--0-is-less-efficient-than--0-for-unsigned-integers-with-proof\">G-06 Comparisons: <code>> 0</code> is less efficient than <code>!= 0</code> for unsigned integers (with proof)</a></li>\n<li><a href=\"#g-07-for-loops-an-arrays-length-should-be-cached-to-save-gas-in-for-loops\">G-07 For-Loops: An array’s length should be cached to save gas in for-loops</a></li>\n<li><a href=\"#g-08-for-loops-i-costs-less-gas-compared-to-i\">G-08 For-Loops: <code>++i</code> costs less gas compared to <code>i++</code></a></li>\n<li><a href=\"#g-09-for-loops-increments-can-be-unchecked\">G-09 For-Loops: Increments can be unchecked</a></li>\n<li><a href=\"#g-10-arithmetics-unchecked-blocks-for-arithmetics-operations-that-cant-underflowoverflow\">G-10 Arithmetics: <code>unchecked</code> blocks for arithmetics operations that can’t underflow/overflow</a></li>\n<li><a href=\"#g-11-visibility-public-functions-to-external\">G-11 Visibility: Public functions to external</a></li>\n<li><a href=\"#g-12-errors-reduce-the-size-of-error-messages-long-revert-strings\">G-12 Errors: Reduce the size of error messages (Long revert Strings)</a></li>\n<li><a href=\"#g-13-errors-use-custom-errors-instead-of-revert-strings-to-save-gas\">G-13 Errors: Use Custom Errors instead of Revert Strings to save Gas</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}