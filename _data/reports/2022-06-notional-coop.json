{
  "circa": {
    "title": "Notional x Index Coop",
    "sponsor": "Notional",
    "slug": "2022-06-notional-coop",
    "date": "2022-07-18",
    "findings": "https://github.com/code-423n4/2022-06-notional-coop-findings/issues",
    "contest": 124
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Notional x Index Coop smart contract system written in Solidity. The audit contest took place between June 7—June 14 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>81 Wardens contributed reports to the Notional x Index Coop:</p>\n<ol>\n<li><a href=\"https://twitter.com/jonah1005w\">jonah1005</a></li>\n<li>unforgiven</li>\n<li>xiaoming90</li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li>0xDjango</li>\n<li><a href=\"https://twitter.com/berndartmueller\">berndartmueller</a></li>\n<li>GreyArt (<a href=\"https://twitter.com/HickupH\">hickuphh3</a> and <a href=\"https://twitter.com/itsmeSTYJ\">itsmeSTYJ</a>)</li>\n<li>Meera</li>\n<li>minhquanym</li>\n<li><a href=\"https://twitter.com/KenzoAgada\">kenzo</a></li>\n<li>0x52</li>\n<li>IllIllI</li>\n<li><a href=\"https://github.com/antoncoding\">antonttc</a></li>\n<li>GimelSec (<a href=\"https://twitter.com/rayn731\">rayn</a> and sces60107)</li>\n<li>sorrynotsorry</li>\n<li><a href=\"https://twitter.com/JoeStakey\">joestakey</a></li>\n<li>0xkatana</li>\n<li>0x29A (0x4non and rotcivegaf)</li>\n<li>0x1f8b</li>\n<li>0xf15ers (remora and twojoy)</li>\n<li><a href=\"https://instagram.com/vanensurya\">Funen</a></li>\n<li><a href=\"https://twitter.com/0xhyh\">hyh</a></li>\n<li><a href=\"https://twitter.com/PierrickGT\">PierrickGT</a></li>\n<li><a href=\"https://chom.dev\">Chom</a></li>\n<li>delfin454000</li>\n<li>Waze</li>\n<li><a href=\"https://twitter.com/thePicodes\">Picodes</a></li>\n<li><a href=\"https://twitter.com/Deivitto\">Deivitto</a></li>\n<li><a href=\"https://twitter.com/father0fBl0cks\">fatherOfBlocks</a></li>\n<li><a href=\"https://github.com/0xKitsune\">0xKitsune</a></li>\n<li><a href=\"https://mobile.twitter.com/tomj_bb\">TomJ</a></li>\n<li>TerrierLover</li>\n<li>simon135</li>\n<li>_Adam</li>\n<li>slywaters</li>\n<li>oyc_109</li>\n<li><a href=\"https://twitter.com/ellahinator\">ellahi</a></li>\n<li>saian</li>\n<li>sach1r0</li>\n<li><a href=\"https://twitter.com/catchup22\">catchup</a></li>\n<li><a href=\"https://twitter.com/c3ph_\">c3phas</a></li>\n<li><a href=\"https://twitter.com/Sm4rty_\">Sm4rty</a></li>\n<li>Cityscape</li>\n<li><a href=\"https://twitter.com/0xNazgul\">0xNazgul</a></li>\n<li>hake</li>\n<li>0xmint</li>\n<li><a href=\"https://github.com/htadashi\">Tadashi</a></li>\n<li>Lambda</li>\n<li><a href=\"https://twitter.com/hansfriese\">hansfriese</a></li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li>zzzitron</li>\n<li>Trumpero</li>\n<li><a href=\"http://seanseefried.org/blog\">sseefried</a></li>\n<li>cloudjunky</li>\n<li>cccz</li>\n<li><a href=\"https://twitter.com/Cryptonicle1\">Bronicle</a></li>\n<li><a href=\"https://nethermind.io/\">Nethermind</a></li>\n<li>dipp</li>\n<li>cryptphi</li>\n<li>0xNineDec</li>\n<li><a href=\"https://github.com/z3s/\">z3s</a></li>\n<li><a href=\"https://twitter.com/sm4rtcontr4ct\">JC</a></li>\n<li>ayeslick</li>\n<li><a href=\"https://twitter.com/meidhiwirara\">Tomio</a></li>\n<li><a href=\"https://www.instagram.com/riyan_rfa/\">rfa</a></li>\n<li><a href=\"https://twitter.com/8olidity\">8olidity</a></li>\n<li><a href=\"https://twitter.com/0xSolus\">0xSolus</a></li>\n<li>UnusualTurtle</li>\n<li>asutorufos</li>\n<li>samruna</li>\n<li><a href=\"https://twitter.com/0xKaden\">kaden</a></li>\n<li>ElKu</li>\n<li>DavidGialdi</li>\n<li><a href=\"https://twitter.com/_0v3rf10w\">0v3rf10w</a></li>\n<li><a href=\"https://twitter.com/ynnadt1\">ynnad</a></li>\n<li><a href=\"https://twitter.com/fitraldys\">Fitraldys</a></li>\n<li>djxploit</li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/gzeon\">gzeon</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/itsmetechjay\">itsmetechjay</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 11 unique vulnerabilities. Of these vulnerabilities, 1 received a risk rating in the category of HIGH severity and 10 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 61 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 55 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-06-notional-coop\">C4 Notional x Index Coop repository</a>, and is composed of 5 smart contracts written in the Solidity programming language and includes 914 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-1\" style=\"position:relative;\"><a href=\"#high-risk-findings-1\" aria-label=\"high risk findings 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (1)</h1>\n<h2 id=\"h-01-rounding-issues-in-certain-functions\" style=\"position:relative;\"><a href=\"#h-01-rounding-issues-in-certain-functions\" aria-label=\"h 01 rounding issues in certain functions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/155\">[H-01] Rounding Issues In Certain Functions</a></h2>\n<p><em>Submitted by xiaoming90, also found by berndartmueller, GreyArt, jonah1005, kenzo, and minhquanym</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L52\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L52</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L134\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L134</a></p>\n<h3 id=\"background\" style=\"position:relative;\"><a href=\"#background\" aria-label=\"background permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Background</h3>\n<p>Per EIP 4626’s Security Considerations (<a href=\"https://eips.ethereum.org/EIPS/eip-4626\">https://eips.ethereum.org/EIPS/eip-4626</a>)</p>\n<blockquote>\n<p>Finally, ERC-4626 Vault implementers should be aware of the need for specific, opposing rounding directions across the different mutable and view methods, as it is considered most secure to favor the Vault itself during calculations over its users:</p>\n<ul>\n<li>If (1) it’s calculating how many shares to issue to a user for a certain amount of the underlying tokens they provide or (2) it’s determining the amount of the underlying tokens to transfer to them for returning a certain amount of shares, it should round <em>down</em>.</li>\n<li>If (1) it’s calculating the amount of shares a user has to supply to receive a given amount of the underlying tokens or (2) it’s calculating the amount of underlying tokens a user has to provide to receive a certain amount of shares, it should round <em>up</em>.</li>\n</ul>\n</blockquote>\n<p>Thus, the result of the <code>previewMint</code> and <code>previewWithdraw</code> should be rounded up.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The current implementation of <code>convertToShares</code> function will round down the number of shares returned due to how solidity handles Integer Division. ERC4626 expects the returned value of <code>convertToShares</code> to be rounded down. Thus, this function behaves as expected.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L52\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L52</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">convertToShares</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Scales assets by the value of a single unit of fCash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">unitfCashValue</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getPresentValue</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Constants</span><span class=\"mtk1\">.</span><span class=\"mtk12\">INTERNAL_TOKEN_PRECISION</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">assets</span><span class=\"mtk1\"> * </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Constants</span><span class=\"mtk1\">.</span><span class=\"mtk12\">INTERNAL_TOKEN_PRECISION</span><span class=\"mtk1\">)) / </span><span class=\"mtk12\">unitfCashValue</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">assets</span><span class=\"mtk1\"> * </span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">()) / </span><span class=\"mtk11\">totalAssets</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>ERC 4626 expects the result returned from <code>previewWithdraw</code> function to be rounded up. However, within the <code>previewWithdraw</code> function, it calls the <code>convertToShares</code> function. Recall earlier that the <code>convertToShares</code> function returned a rounded down value,  thus <code>previewWithdraw</code> will return a rounded down value instead of round up value. Thus, this function does not behave as expected.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L134\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L134</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">previewWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">hasMatured</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">shares</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">convertToShares</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// If withdrawing non-matured assets, we sell them on the market (i.e. borrow)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">getDecodedID</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">shares</span><span class=\"mtk1\">, </span><span class=\"mtk3\">/* */</span><span class=\"mtk1\">, </span><span class=\"mtk3\">/* */</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">NotionalV2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getfCashBorrowFromPrincipal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><code>previewWithdraw</code> and <code>previewMint</code> functions rely on <code>NotionalV2.getfCashBorrowFromPrincipal</code> and <code>NotionalV2.getDepositFromfCashLend</code> functions. Due to the nature of time-boxed contest, I was unable to verify if <code>NotionalV2.getfCashBorrowFromPrincipal</code> and <code>NotionalV2.getDepositFromfCashLend</code> functions return a rounded down or up value. If a rounded down value is returned from these functions, <code>previewWithdraw</code> and <code>previewMint</code> functions would not behave as expected.</p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Other protocols that integrate with Notional’s fCash wrapper might wrongly assume that the functions handle rounding as per ERC4626 expectation. Thus, it might cause some intergration problem in the future that can lead to wide range of issues for both parties.</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Ensure that the rounding of vault’s functions behave as expected. Following are the expected rounding direction for each vault function:</p>\n<ul>\n<li>previewMint(uint256 shares) - Round Up ⬆</li>\n<li>previewWithdraw(uint256 assets) - Round Up ⬆</li>\n<li>previewRedeem(uint256 shares) - Round Down ⬇</li>\n<li>previewDeposit(uint256 assets) - Round Down ⬇</li>\n<li>convertToAssets(uint256 shares) - Round Down ⬇</li>\n<li>convertToShares(uint256 assets) - Round Down ⬇</li>\n</ul>\n<p><code>previewMint</code> returns the  amount of assets that would be deposited to mint specific amount of shares. Thus, the amount of assets must be rounded up, so that the vault won’t be shortchanged.</p>\n<p><code>previewWithdraw</code> returns the amount of shares that would be burned to withdraw specific amount of asset. Thus, the amount of shares must to be rounded up, so that the vault won’t be shortchanged.</p>\n<p>Following is the OpenZeppelin’s vault implementation for rounding reference:</p>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/extensions/ERC20TokenizedVault.sol\">https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/extensions/ERC20TokenizedVault.sol</a></p>\n<p>Alternatively, if such alignment of rounding could not be achieved due to technical limitation, at the minimum, document this limitation in the comment so that the developer performing the integration is aware of this.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/155\">jeffywu (Notional) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/155#issuecomment-1166534716\">gzeoneth (judge) increased severity to High and commented</a>:</strong></p>\n<blockquote>\n<p>Judging this and all duplicate regarding EIP4626 implementation as High Risk. </p>\n</blockquote>\n<blockquote>\n<p>EIP4626 is aimed to create a consistent and robust implementation patterns for Tokenized Vaults. A slight deviation from 4626 would broke composability and potentially lead to loss of fund (POC in <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/88\">https://github.com/code-423n4/2022-06-notional-coop-findings/issues/88</a> can be an example). It is counterproductive to implement EIP4626 but does not conform to it fully. Especially it does seem that most of the time <code>deposit</code> would be successful but not <code>withdraw</code>, making it even more dangerous when an immutable consumer application mistakenly used the wfcash contract.</p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-10\" style=\"position:relative;\"><a href=\"#medium-risk-findings-10\" aria-label=\"medium risk findings 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (10)</h1>\n<h2 id=\"m-01-fcash-of-the-wrong-maturity-and-asset-can-be-sent-to-wrapper-address-before-wrapper-is-deployed-\" style=\"position:relative;\"><a href=\"#m-01-fcash-of-the-wrong-maturity-and-asset-can-be-sent-to-wrapper-address-before-wrapper-is-deployed-\" aria-label=\"m 01 fcash of the wrong maturity and asset can be sent to wrapper address before wrapper is deployed  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/115\">[M-01] fCash of the wrong maturity and asset can be sent to wrapper address before wrapper is deployed </a></h2>\n<p><em>Submitted by 0x52, also found by jonah1005 and unforgiven</em></p>\n<p>Minting becomes impossible</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>onERC1155Received is only called when the size of the code deployed at the address contains code. Since create2 is used to deploy the contract, the address can be calculated before the contract is deployed. A malicious actor could send the address fCash of a different maturity or asset before the contract is deployed and since nothing has been deployed, onERC1155Received will not be called and the address will accept the fCash. After the contract is deployed and correct fCash is sent to the address, onERC1155Received will check the length of the assets held by the address and it will be more than 1 (fCash of correct asset and maturity and fCash with wrong maturity or asset sent before deployment). This will cause the contract to always revert essentially breaking the mint completely.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>When the contract is created create a function that reads how many fCash assets are at the address and send them away if they aren’t of the correct asset and maturity</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/115#issuecomment-1156413858\">jeffywu (Notional) confirmed, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>I will need to write a PoC to confirm that this is the case but it seems plausible to me.</p>\n</blockquote>\n<blockquote>\n<p>Based on the Judging Criteria, this does not result in loss of funds. This will result in a loss of availability (available funds actually increase).</p>\n<p>My opinion is medium severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/115#issuecomment-1166516282\">gzeoneth (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Judging this as Med Risk due to no loss of funds and only possible before contract deployment.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-deposit-and-mint-and-_redeeminternal-in-wfcasherc4626-will-revert-for-all-fcash-that-asset-token-is-underlying-token-because-they-always-call-_mintinternal-with-useunderlyingtrue\" style=\"position:relative;\"><a href=\"#m-02-deposit-and-mint-and-_redeeminternal-in-wfcasherc4626-will-revert-for-all-fcash-that-asset-token-is-underlying-token-because-they-always-call-_mintinternal-with-useunderlyingtrue\" aria-label=\"m 02 deposit and mint and _redeeminternal in wfcasherc4626 will revert for all fcash that asset token is underlying token because they always call _mintinternal with useunderlyingtrue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/82\">[M-02] deposit() and mint() and _redeemInternal() in wfCashERC4626() will revert for all fcash that asset token is underlying token because they always call _mintInternal() with useUnderlying==True</a></h2>\n<p><em>Submitted by unforgiven</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L177-L184\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L177-L184</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L168-L175\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L168-L175</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L225-L241\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L225-L241</a></p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>For some <code>fcash</code> the asset token is underlying token (<code>asset.tokenType == TokenType.NonMintable</code>) and <code>NotionalV2</code> will not handle minting with <code>useUnderlying==True</code> for those <code>fcash</code>s (according to what I asked from sponsor). In summery most of the logics in <code>wfCashERC4626</code> will not work for those <code>fcash</code> tokens.</p>\n<p>when for some <code>fcash</code> asset token is underlying token, all calls to <code>NotionalV2</code> should be with <code>useUnderlying==False</code>. but <code>deposit()</code> and <code>mint()</code> in <code>wfCashERC4626</code> contract call <code>_mintInternal()</code> with <code>useUnderlying==True</code> and it calls <code>NotionalV2.batchLend()</code> with <code>depositUnderlying==true</code> so the <code>NotionV2</code> call will fail for <code>fcash</code> tokens that asset token is underlying token and it would cause  that <code>deposit()</code> and <code>mint()</code>  logic <code>wfCashERC4626</code>  will not work and contract will be useless for those tokens.\n<code>_redeemInternal()</code> issue is similar and it calls <code>_burn()</code> with <code>redeemToUnderlying: true</code> which execution eventually calls <code>NotionalV2.batchBalanceAndTradeAction()</code> with <code>toUnderlying=True</code> which will revert so <code>_redeemInternal()</code> will fail and because <code>withdraw()</code> and <code>redeem</code> use it, so they will not work too for those <code>fcash</code> tokens that asset token is underlying token.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is <code>deposit()</code> and <code>mint()</code>  code in <code>wfCashERC4626</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    /** @dev See {IERC4626-deposit} */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function deposit(uint256 assets, address receiver) public override returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 shares = previewDeposit(assets);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Will revert if matured</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _mintInternal(assets, _safeUint88(shares), receiver, 0, true);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit Deposit(msg.sender, receiver, assets, shares);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return shares;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /** @dev See {IERC4626-mint} */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function mint(uint256 shares, address receiver) public override returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 assets = previewMint(shares);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Will revert if matured</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _mintInternal(assets, _safeUint88(shares), receiver, 0, true);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit Deposit(msg.sender, receiver, assets, shares);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return assets;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see they both call <code>_mintInternal()</code> with last parameter as <code>true</code> which is <code>useUnderlying</code>’s value. This is <code>_mintInternal()</code> code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _mintInternal(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 depositAmountExternal,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint88 fCashAmount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address receiver,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint32 minImpliedRate,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bool useUnderlying</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) internal nonReentrant {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(!hasMatured(), &quot;fCash matured&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (IERC20 token, bool isETH) = getToken(useUnderlying);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 balanceBefore = isETH ? address(this).balance : token.balanceOf(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // If dealing in ETH, we use WETH in the wrapper instead of ETH. NotionalV2 uses</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // ETH natively but due to pull payment requirements for batchLend, it does not support</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // ETH. batchLend only supports ERC20 tokens like cETH or aETH. Since the wrapper is a compatibility</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // layer, it will support WETH so integrators can deal solely in ERC20 tokens. Instead of using</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // &quot;batchLend&quot; we will use &quot;batchBalanceActionWithTrades&quot;. The difference is that &quot;batchLend&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // is more gas efficient (does not require and additional redeem call to asset tokens). If using cETH</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // then everything will proceed via batchLend.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (isETH) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            IERC20((address(WETH))).safeTransferFrom(msg.sender, address(this), depositAmountExternal);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            WETH.withdraw(depositAmountExternal);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            BalanceActionWithTrades[] memory action = EncodeDecode.encodeLendETHTrade(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                getCurrencyId(),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                getMarketIndex(),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                depositAmountExternal,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                fCashAmount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                minImpliedRate</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Notional will return any residual ETH as the native token. When we _sendTokensToReceiver those</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // native ETH tokens will be wrapped back to WETH.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            NotionalV2.batchBalanceAndTradeAction{value: depositAmountExternal}(address(this), action);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Transfers tokens in for lending, Notional will transfer from this contract.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            token.safeTransferFrom(msg.sender, address(this), depositAmountExternal);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Executes a lending action on Notional</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            BatchLend[] memory action = EncodeDecode.encodeLendTrade(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                getCurrencyId(),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                getMarketIndex(),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                fCashAmount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                minImpliedRate,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                useUnderlying</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            NotionalV2.batchLend(address(this), action);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Mints ERC20 tokens for the receiver, the false flag denotes that we will not do an</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // operatorAck</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _mint(receiver, fCashAmount, &quot;&quot;, &quot;&quot;, false);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _sendTokensToReceiver(token, msg.sender, isETH, balanceBefore);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see it calls <code>NotionalV2</code> functions with <code>useUnderlying=True</code> but according to sponsor clarification <code>NotionalV2</code> would fail and revert for those calls because <code>useUnderlying=True</code> and <code>fcash</code>’s asset token is underlying token (<code>asset.tokenType == TokenType.NonMintable</code>).\nSo in summery for <code>fcash</code> tokens which asset token is underlying token <code>NotionalV2</code> won’t handle calls which include <code>useUnderlying==True</code> but in <code>wfCashERC4626</code> contract functions like <code>deposit()</code>, <code>mint()</code>, <code>withdraw()</code> and <code>redeem()</code> they all uses <code>useUnderlying==True</code> always so <code>wfCashERC4626</code> won’t work for those specific type of tokens which asset token is underlying token(<code>asset.tokenType == TokenType.NonMintable</code>)</p>\n<p>the detail explanations for functions <code>withdraw()</code> and <code>redeem()</code> are similar.</p>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VIM</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Check that if for that <code>fcash</code> token asset token  is underlying token or not and set <code>useUnderlying</code> based on that.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/82#issuecomment-1156418524\">jeffywu (Notional) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/82#issuecomment-1166520574\">gzeoneth (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>There doesn’t seems to be loss of fund as <code>deposit</code> and <code>mint</code> would revert. Judging as Med Risk.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-the-logic-of-_isunderlying-in-notionaltrademodule-is-wrong-which-will-cause-mintfcashposition-and-redeemfcashposition-revert-on-fcash-tokens-which-asset-token-is-underlying-token-assettokentype--tokentypenonmintable\" style=\"position:relative;\"><a href=\"#m-03-the-logic-of-_isunderlying-in-notionaltrademodule-is-wrong-which-will-cause-mintfcashposition-and-redeemfcashposition-revert-on-fcash-tokens-which-asset-token-is-underlying-token-assettokentype--tokentypenonmintable\" aria-label=\"m 03 the logic of _isunderlying in notionaltrademodule is wrong which will cause mintfcashposition and redeemfcashposition revert on fcash tokens which asset token is underlying token assettokentype  tokentypenonmintable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/87\">[M-03] The logic of _isUnderlying() in NotionalTradeModule is wrong which will cause mintFCashPosition() and redeemFCashPosition() revert on <code>fcash</code> tokens which asset token is underlying token (asset.tokenType == TokenType.NonMintable)</a></h2>\n<p><em>Submitted by unforgiven</em></p>\n<p>For some <code>fcash</code> the asset token is underlying token (<code>asset.tokenType == TokenType.NonMintable</code>) and <code>NotionalV2</code> will not handle minting or burning when it is called with <code>useUnderlying==True</code> for those <code>fcash</code>s (according to what I asked from sponsor). In summery most of the logics in <code>NotionalTradeModule</code> will not work for those <code>fcash</code> tokens because <code>_isUnderlying()</code> returns <code>true</code> result for those tokens which would make <code>NotionalTradeModule</code>’s logic for <code>mintFCashPosition()</code> and <code>redeemFCashPosition()</code> will eventually call <code>redeemToUnderlying()</code> and <code>mintViaUnderlying()</code> in <code>wfCashLogic</code> and those function in <code>wfCashLogic</code> will call <code>NotionalV2</code> with <code>useUnderlying==True</code> and <code>NotionalV2</code> will fail and revert for <code>fcash</code> tokens which asset token is underlying token, so the whole transaction will fail and <code>_mintFCashPosition()</code> and <code>_redeemFCashPosition()</code>  logic in <code>NotionalTradeModule</code> will not work for those <code>fcash</code> tokens and manager can’t add them to <code>set</code> protocol.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>when for some <code>fcash</code> asset token is underlying token, all calls to <code>NotionalV2</code> should be with <code>useUnderlying==False</code>. but <code>_isUnderlying()</code> in <code>NotionalTradeModule</code> contract first check that <code>isUnderlying = _paymentToken == underlyingToken</code> so for <code>fcash</code> tokens where asset token is underlying token it is going to return <code>isUnderlying==True</code>. let’s assume that for some specific <code>fcash</code> asset token is underlying token (<code>asset.tokenType == TokenType.NonMintable</code>) and follow the code execution.\nThis is <code>_isUnderlying()</code> code in <code>NotionalTradeModule</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _isUnderlying(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IWrappedfCashComplete _fCashPosition,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC20 _paymentToken</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    internal</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    view</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    returns(bool isUnderlying)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (IERC20 underlyingToken, IERC20 assetToken) = _getUnderlyingAndAssetTokens(_fCashPosition);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        isUnderlying = _paymentToken == underlyingToken;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if(!isUnderlying) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            require(_paymentToken == assetToken, &quot;Token is neither asset nor underlying token&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see it calls <code>_getUnderlyingAndAssetTokens()</code> and then check <code>_paymentToken == underlyingToken</code> to see that if payment token is equal to <code>underlyingToken</code>. <code>_getUnderlyingAndAssetTokens()</code> uses <code>getUnderlyingToken()</code> and <code>getAssetToken()</code> in <code>wfCashBase</code>. This is <code>getUnderlyingToken()</code> code in <code>wfCashBase</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    /// @notice Returns the token and precision of the token that this token settles</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /// to. For example, fUSDC will return the USDC token address and 1e6. The zero</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /// address will represent ETH.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function getUnderlyingToken() public view override returns (IERC20 underlyingToken, int256 underlyingPrecision) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (Token memory asset, Token memory underlying) = NotionalV2.getCurrency(getCurrencyId());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (asset.tokenType == TokenType.NonMintable) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // In this case the asset token is the underlying</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            return (IERC20(asset.tokenAddress), asset.decimals);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            return (IERC20(underlying.tokenAddress), underlying.decimals);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see for our specific <code>fcash</code> token this function will return asset token as underlying token. so for this specific <code>fcash</code> token, the asset token and underlying token will be same in <code>_isUnderlying()</code> of <code>NationalTradeModule</code> but because code first check <code>isUnderlying = _paymentToken == underlyingToken</code> so the function will return <code>isUnderlying=True</code> as a result for our specific <code>fcash</code> token (which asset token is underlying token)\nThis is <code>_mintFCashPosition()</code> and <code>_redeemFCashPosition()</code> code in <code>NotionalTradeModule</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    /**</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     * @dev Redeem a given fCash position from the specified send token (either underlying or asset token)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     * @dev Alo adjust the components / position of the set token accordingly</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _mintFCashPosition(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ISetToken _setToken,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IWrappedfCashComplete _fCashPosition,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC20 _sendToken,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _fCashAmount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _maxSendAmount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    internal</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    returns(uint256 sentAmount)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if(_fCashAmount == 0) return 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bool fromUnderlying = _isUnderlying(_fCashPosition, _sendToken);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _approve(_setToken, _fCashPosition, _sendToken, _maxSendAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 preTradeSendTokenBalance = _sendToken.balanceOf(address(_setToken));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 preTradeReceiveTokenBalance = _fCashPosition.balanceOf(address(_setToken));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _mint(_setToken, _fCashPosition, _maxSendAmount, _fCashAmount, fromUnderlying);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (sentAmount,) = _updateSetTokenPositions(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _setToken,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(_sendToken),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            preTradeSendTokenBalance,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(_fCashPosition),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            preTradeReceiveTokenBalance</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(sentAmount &lt;= _maxSendAmount, &quot;Overspent&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit FCashMinted(_setToken, _fCashPosition, _sendToken, _fCashAmount, sentAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /**</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     * @dev Redeem a given fCash position for the specified receive token (either underlying or asset token)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     * @dev Alo adjust the components / position of the set token accordingly</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _redeemFCashPosition(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ISetToken _setToken,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IWrappedfCashComplete _fCashPosition,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC20 _receiveToken,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _fCashAmount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _minReceiveAmount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    internal</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    returns(uint256 receivedAmount)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if(_fCashAmount == 0) return 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bool toUnderlying = _isUnderlying(_fCashPosition, _receiveToken);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 preTradeReceiveTokenBalance = _receiveToken.balanceOf(address(_setToken));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 preTradeSendTokenBalance = _fCashPosition.balanceOf(address(_setToken));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _redeem(_setToken, _fCashPosition, _fCashAmount, toUnderlying);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (, receivedAmount) = _updateSetTokenPositions(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _setToken,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(_fCashPosition),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            preTradeSendTokenBalance,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(_receiveToken),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            preTradeReceiveTokenBalance</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(receivedAmount &gt;= _minReceiveAmount, &quot;Not enough received amount&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit FCashRedeemed(_setToken, _fCashPosition, _receiveToken, _fCashAmount, receivedAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see they both uses <code>_isUnderlying()</code> to find out that if <code>_sendToken</code> is asset token or underlying token. for our specific <code>fcash</code> token, the result of <code>_isUnderlying()</code> will be <code>True</code> and <code>_mintFCashPosition()</code> and <code>_redeemFCashPosition()</code>  will call <code>_mint()</code> and <code>_redeem()</code> with <code>toUnderlying</code> set as <code>True</code>. This is <code>_mint()</code> and <code>_redeem()</code> code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    /**</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     * @dev Invokes the wrappedFCash token&#39;s mint function from the setToken</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _mint(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ISetToken _setToken,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IWrappedfCashComplete _fCashPosition,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _maxAssetAmount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _fCashAmount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bool _fromUnderlying</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    internal</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint32 minImpliedRate = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bytes4 functionSelector = </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _fromUnderlying ? _fCashPosition.mintViaUnderlying.selector : _fCashPosition.mintViaAsset.selector;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bytes memory mintCallData = abi.encodeWithSelector(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            functionSelector,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _maxAssetAmount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint88(_fCashAmount),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(_setToken),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            minImpliedRate,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _fromUnderlying</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _setToken.invoke(address(_fCashPosition), 0, mintCallData);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /**</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     * @dev Redeems the given amount of fCash token on behalf of the setToken</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _redeem(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ISetToken _setToken,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IWrappedfCashComplete _fCashPosition,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _fCashAmount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bool _toUnderlying</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    internal</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint32 maxImpliedRate = type(uint32).max;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bytes4 functionSelector =</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _toUnderlying ? _fCashPosition.redeemToUnderlying.selector : _fCashPosition.redeemToAsset.selector;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bytes memory redeemCallData = abi.encodeWithSelector(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            functionSelector,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _fCashAmount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(_setToken),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            maxImpliedRate</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _setToken.invoke(address(_fCashPosition), 0, redeemCallData);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see they are using <code>_toUnderlying</code> value to decide calling between (<code>mintViaUnderlying()</code> or <code>mintViaAsset()</code>) and (<code>redeemToUnderlying()</code> or <code>redeemToAsset()</code>), for our specific <code>fcash</code> <code>_toUnderlying</code> will be <code>True</code> so those functions will call <code>mintViaUnderlying()</code> and <code>redeemToUnderlying()</code> in <code>wfCashLogic</code>.\n<code>mintViaUnderlying()</code> and <code>redeemToUnderlying()</code> in <code>wfCashLogic</code> execution flow eventually would call <code>NotionalV2</code> functions with <code>useUnderlying=True</code> for this specific <code>fcash</code> token, but <code>NotionalV2</code> will revert for that call because for that <code>fcash</code> token asset token is underlying token and <code>NotionalV2</code> can’t handle calls with <code>useUnderlying==True</code> for that <code>fcash</code> Token. This will cause all the transaction to fail and manager can’t call <code>redeemFCashPosition()</code> or <code>mintFCashPosition()</code> functions for those <code>fcash</code> tokens that asset token is underlying token.\nIn summery <code>NotionalTradeModule</code> logic will not work for all <code>fcash</code> tokens becasue the logic of <code>_isUnderlying()</code> is wrong for <code>fcash</code> tokens that asset token is underlying token.</p>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VIM</p>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change the logic of <code>_isUnderlying()</code> in <code>NotionalTradeModule</code> so it returns correct results for all <code>fcash</code> tokens. One simple solution can be that it first check <code>payment token</code>  value with <code>asset token</code> value.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/87#issuecomment-1156022313\">ckoopmann (Index Coop) confirmed, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Will need input from @jeffywu here, is the description of the Notional side of things correct ? </p>\n<p>I’ll also try to reproduce this issue in a test maybe to make sure if it is valid.</p>\n<p>Not sure if this is “High Risk” as no funds seem to be at risk. However from the description it might render the <code>NotionalTradeModule</code> incompatible with certain fCash tokens, which we certainly want to avoid. So will have to review this in more detail.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/87#issuecomment-1156585499\">jeffywu (Notional) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with @ckoopmann that severity should be reduced here, what this would cause is a revert not any loss of funds.</p>\n<p>The simple fix would just be to always use <code>mintViaAsset</code> and <code>mintViaUnderlying</code> for the case when fCash has a non-mintable type (currently there are no fCash assets of this type and none planned). However, we can also add the ability to query this on the wfCash side to make things more compatible.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/87#issuecomment-1157114524\">ckoopmann (Index Coop) commented</a>:</strong></p>\n<blockquote>\n<p>@jeffywu What do you think of the suggested mitigation strategy ? </p>\n<p>As far as I understand we would just have to change:\n<code>isUnderlying = _paymentToken == underlyingToken;</code> to <code>isUnderlying = _paymentToken != assetToken;</code> to avoid the described issue, no ?  </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/87#issuecomment-1157570874\">jeffywu (Notional) commented</a>:</strong></p>\n<blockquote>\n<p>To make this more fool proof what I can do is just add a check on the wrapped fCash side to see if the token is non-mintable and then override the useUnderlying flag internally there. I think that will be a better solution since getUnderlyingToken already has logic to return the asset token when it is marked as non-mintable. That would mean that you would not need to make any changes, I think this will make it easier for integrating developers in the future.</p>\n<p>Specifically add checks here:\n<a href=\"https://github.com/notional-finance/wrapped-fcash/blob/master/contracts/wfCashLogic.sol#L57-L58\">https://github.com/notional-finance/wrapped-fcash/blob/master/contracts/wfCashLogic.sol#L57-L58</a>\nand here:\n<a href=\"https://github.com/notional-finance/wrapped-fcash/blob/master/contracts/wfCashLogic.sol#L210-L211\">https://github.com/notional-finance/wrapped-fcash/blob/master/contracts/wfCashLogic.sol#L210-L211</a></p>\n<p>and overwrite the incoming useUnderlying if we are in this situation.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/87#issuecomment-1159612676\">ckoopmann (Index Coop) commented</a>:</strong></p>\n<blockquote>\n<p>@jeffywu Sounds great to me. If I understand correctly that means I would not have to change anything on the trade module side. Let me know if that is incorrect.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/87#issuecomment-1159704963\">jeffywu (Notional) resolved and commented</a>:</strong></p>\n<blockquote>\n<p>@ckoopmann, no changes necessary on your side. You can see the changes <a href=\"https://github.com/notional-finance/wrapped-fcash/pull/11/commits/0ab1ae1080c8eb14fd24d180a01f8ec2c8919022#diff-7c9f6e4700cce75c3c2abb4902f45f7398dcac73135a605b59825b26de7d6af0R60\">here</a>.</p>\n</blockquote>\n<blockquote>\n<p><a href=\"https://github.com/notional-finance/wrapped-fcash/pull/11/commits/0ab1ae1080c8eb14fd24d180a01f8ec2c8919022#diff-7c9f6e4700cce75c3c2abb4902f45f7398dcac73135a605b59825b26de7d6af0R245\">https://github.com/notional-finance/wrapped-fcash/pull/11/commits/0ab1ae1080c8eb14fd24d180a01f8ec2c8919022#diff-7c9f6e4700cce75c3c2abb4902f45f7398dcac73135a605b59825b26de7d6af0R245</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/87#issuecomment-1166523407\">gzeoneth (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>There doesn’t seems to be loss of fund as it would revert. Judging as Med Risk.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-iswrappedfcash-check-is-a-gas-bomb\" style=\"position:relative;\"><a href=\"#m-04-iswrappedfcash-check-is-a-gas-bomb\" aria-label=\"m 04 iswrappedfcash check is a gas bomb permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/188\">[M-04] <code>IsWrappedFcash</code> check is a gas bomb</a></h2>\n<p><em>Submitted by jonah1005</em></p>\n<p>In the <code>_isWrappedFCash</code> check, the <code>notionalTradeModule</code> check whether the component is a wrappedCash with the following logic.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">try</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IWrappedfCash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_fCashPosition</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getDecodedID</span><span class=\"mtk1\">() </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maturity</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">try</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wrappedfCashFactory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">computeAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_maturity</span><span class=\"mtk1\">) </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_computedAddress</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fCashPosition</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_computedAddress</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">catch</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">catch</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p>The above logic is dangerous when <code>_fCashPosition</code> do not revert on <code>getDecodedID</code> but instead give a wrong format of return value. The contract would try to decode the return value into <code>returns(uint16 _currencyId, uint40 _maturity)</code> and revert. The revert would consume what ever gas it’s provided.</p>\n<p><a href=\"https://etherscan.io/address/0x4Ddc2D193948926D02f9B1fE9e1daa0718270ED5\">CETH</a> is an example.\nThere’s a fallback function in <code>ceth</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">requireNoError</span><span class=\"mtk1\">(</span><span class=\"mtk11\">mintInternal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;mint failed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>As a result, calling <code>getDecodedID</code> would not revert. Instead, calling <code>getDecodedID</code> of <code>CETH</code> would consume all remaining gas.\nThis creates so many issues. First, users would waste too much gas on a regular operation. Second, the transaction might fail if <code>ceth</code> is not the last position. Third, the wallet contract can not interact with set token with ceth as it consumes all gas.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The following contract may fail to redeem setTokens as it consumes too much gas (with 20M gas limit).</p>\n<p><a href=\"https://gist.github.com/Jonah246/fad9e489fe84a6fb8b4894d7377fd8a2\">Test.sol</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">test</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">cToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">issueModule</span><span class=\"mtk1\">), </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">wfCash</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">issueModule</span><span class=\"mtk1\">), </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">issueModule</span><span class=\"mtk1\">.</span><span class=\"mtk11\">issue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">setToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">issueModule</span><span class=\"mtk1\">.</span><span class=\"mtk11\">redeem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">setToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Also, we can check how much gas it consumes with the following function.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TestWrappedFCash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fCashPosition</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(!</span><span class=\"mtk12\">_fCashPosition</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isContract</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">try</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IWrappedfCash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_fCashPosition</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getDecodedID</span><span class=\"mtk1\">() </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maturity</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">try</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wrappedfCashFactory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">computeAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_maturity</span><span class=\"mtk1\">) </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_computedAddress</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fCashPosition</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_computedAddress</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">catch</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">catch</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Test this function with <code>cdai</code> and <code>ceth</code>, we can observe that there’s huge difference of gas consumption here.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Gas used:            30376 of 130376</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Gas used:            19479394 of 19788041</span></span></code></pre>\n<h3 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Hardhat</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>I recommend building a map in the notionalTradeModule and inserting the wrappeCash in the <code>mintFCashPosition</code> function.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">addWrappedCash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maturity</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">computedAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">wrappedfCashFactory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">computeAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_maturity</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">wrappedFCash</span><span class=\"mtk1\">[</span><span class=\"mtk12\">computedAddress</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Or we could replace the try-catch pattern with a low-level function call and check the return value’s length before decoding it.</p>\n<p>Something like this might be a fix.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">returndata</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">target</span><span class=\"mtk1\">.</span><span class=\"mtk11\">delegatecall</span><span class=\"mtk1\">(</span><span class=\"mtk12\">data</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">success</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">returndata</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">DECODED_ID_RETURN_LENGTH</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk3\">// abi.decode ....</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/188#issuecomment-1156028172\">ckoopmann (Index Coop) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Correct, this is an issue that I also recently ran into (after the contest had already started) when doing additional tests.\nMy solution was to just add a fixed gas limit to the <code>getDecodedID</code> call which seemed to solve it. </p>\n<p>In an earlier version of the contract I had a manual mapping as suggested here, however this is not ideal since the setToken could obtain fCash positions using other SetModules (such as the general TradeModule) which would then not be registered in this mapping. </p>\n<p>Limiting the gas usage of these calls seems like an easier and more robust mitigation strategy. (might want to make these gas limits updateable though)</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/188#issuecomment-1166539232\">gzeoneth (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Valid but don’t think this is High Risk, <code>eth_estimateGas</code> should fail preventing most user from interacting with a ridiculous gas limit. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-transferfcash-does-not-work-as-expected\" style=\"position:relative;\"><a href=\"#m-05-transferfcash-does-not-work-as-expected\" aria-label=\"m 05 transferfcash does not work as expected permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/98\">[M-05] transferfCash does not work as expected</a></h2>\n<p><em>Submitted by csanuragjain</em></p>\n<p>If maturity is reached and user has asked for redeem with opts.transferfCash as true, then if (hasMatured()) turns true at wfCashLogic.sol#L216 causing fcash to be cashed out in underlying token and then sent to receiver. So receiver obtains underlying when fcash was expected. The sender wont get an error thinking fcash transfer was success</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>User A calls redeem with opts.transferfCash as true and receiver as User B</li>\n<li>Since maturity is reached so instead of transferring the fCash, contract would simply cash out fCash and sent the underlying token to the receiver which was not expected</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>If opts.transferfCash is true and maturity is reached then throw an error mentioning that fCash can no longer be transferred</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/98#issuecomment-1156551710\">jeffywu (Notional) confirmed</a>:</strong></p>\n<blockquote>\n<p>Sounds reasonable.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-users-might-not-be-able-to-purchase-or-redeem-settoken\" style=\"position:relative;\"><a href=\"#m-06-users-might-not-be-able-to-purchase-or-redeem-settoken\" aria-label=\"m 06 users might not be able to purchase or redeem settoken permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/154\">[M-06] Users Might Not Be Able To Purchase Or Redeem SetToken</a></h2>\n<p><em>Submitted by xiaoming90, also found by berndartmueller</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L309\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L309</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L385\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L385</a></p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Whenever a setToken is issued or redeemed, the <code>moduleIssueHook</code> and <code>moduleRedeemHook</code> will be triggered. These two hooks will in turn call the <code>_redeemMaturedPositions</code> function to ensure that no matured fCash positions remain in the Set by redeeming any matured fCash position.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L309\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L309</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\"> Hook called once before setToken issuance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\"> Ensures that no matured fCash positions are in the set when it is issued</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">moduleIssueHook</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ISetToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk3\">/* _setTokenAmount */</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyModule</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_redeemMaturedPositions</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\"> Hook called once before setToken redemption</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\"> Ensures that no matured fCash positions are in the set when it is redeemed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">moduleRedeemHook</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ISetToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk3\">/* _setTokenAmount */</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyModule</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_redeemMaturedPositions</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The <code>_redeemMaturedPositions</code> will loop through all its fCash positions and attempts to redeem any fCash position that has already matured. However, if one of the fCash redemptions fails, it will cause the entire function to revert. If this happens, no one could purchase or redeem the setToken because <code>moduleIssueHook</code> and <code>modileRedeemHook</code> hooks will revert every single time. Thus, the setToken issuance and redemption will stop working entirely and  this setToken can be considered “bricked”.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L385\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L385</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\"> Redeem all matured fCash positions for the given SetToken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_redeemMaturedPositions</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ISetToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ISetToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Position</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">positions</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPositions</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">positionsLength</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">toUnderlying</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">redeemToUnderlying</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">positionsLength</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Check that the given position is an equity position</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">unit</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">component</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">component</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_isWrappedFCash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">component</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">IWrappedfCashComplete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fCashPosition</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IWrappedfCashComplete</span><span class=\"mtk1\">(</span><span class=\"mtk12\">component</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fCashPosition</span><span class=\"mtk1\">.</span><span class=\"mtk11\">hasMatured</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    (</span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiveToken</span><span class=\"mtk1\">,) = </span><span class=\"mtk12\">fCashPosition</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">toUnderlying</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receiveToken</span><span class=\"mtk1\">) == </span><span class=\"mtk12\">ETH_ADDRESS</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk12\">receiveToken</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fCashBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">fCashPosition</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">_redeemFCashPosition</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">fCashPosition</span><span class=\"mtk1\">, </span><span class=\"mtk12\">receiveToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">fCashBalance</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>User will not be able to purchase or redeem the setToken. User’s fund will be stuck in the SetToken Contract. Unable to remove matured fCash positions from SetToken and update positions of its asset token.</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>This is a problem commonly encountered whenever a method of a smart contract calls another contract – you cannot rely on the other contract to work 100% of the time, and it is dangerous to assume that the external call will always be successful.</p>\n<p>It is recommended to:</p>\n<ul>\n<li>Consider alternate method of updating the asset position so that the SetToken’s core functions (e.g. issuance and redemption) will not be locked if one of the matured fCash redemptions fails.</li>\n<li>Evaluate if <code>_redeemMaturedPositions</code> really need to be called during SetToken’s issuance and redemption. If not, consider removing them from the hooks, so that any issue or revert within <code>_redeemMaturedPositions</code> won’t cause the SetToken’s issuance and redemption functions to stop working entirely.</li>\n<li>Consider implementing additional function to give manager/user an option to specify a list of matured fCash positions to redeem instead of forcing them to redeem all matured fCash positions at one go.</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/154#issuecomment-1155999746\">ckoopmann (Index Coop) acknowledged, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>The <code>_isWrappedFCash(component)</code> should make sure that these calls are only executed on valid wrappedfCash instances deployed from the configured factory. </p>\n<p>The issue does not outline a practical scenario / test case where this issue would actually arise.\nIf it did the manager could probably still remove / redeem the component either via this module, or one of the other Trade modules.</p>\n<p>However I’ll have to look into this if I can find a scenario where this would actually arise.\nI will also consider making this redeem step optional, but I will have to think more about this as this might introduce other more serious issues.</p>\n</blockquote>\n<blockquote>\n<p>@jeffywu Do you see any scenario where the redemption of a matured fCash position might fail in this context`? </p>\n<p>EDIT: Just noticed that <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/226\">https://github.com/code-423n4/2022-06-notional-coop-findings/issues/226</a> mentions (among others) the scenario of USDC tokens being blocked which I guess is unlikely but outside of our control. This makes me think we might want to make the redemption of matured tokens during issuance / redemption optional.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/154#issuecomment-1157134636\">ckoopmann (Index Coop) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Changed label from acknowledged to confirmed, since on second thought I think we likely want to adopt some kind of mitigation strategy for this. However still tentative / unclear which strategy we want to adopt.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-residual-allowance-might-allow-tokens-in-settoken-to-be-stolen\" style=\"position:relative;\"><a href=\"#m-07-residual-allowance-might-allow-tokens-in-settoken-to-be-stolen\" aria-label=\"m 07 residual allowance might allow tokens in settoken to be stolen permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/160\">[M-07] Residual Allowance Might Allow Tokens In SetToken To Be Stolen</a></h2>\n<p><em>Submitted by xiaoming90</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L418\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L418</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L493\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L493</a></p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Whenever <code>_mintFCashPosition</code> function is called to mint new fCash position, the contract will call the <code>_approve</code> function to set the allowance to <code>_maxSendAmount</code> so that the fCash Wrapper contact can pull the payment tokens from the SetToken contract during minting.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L418\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L418</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_mintFCashPosition</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ISetToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IWrappedfCashComplete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fCashPosition</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_sendToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fCashAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxSendAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sentAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_fCashAmount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fromUnderlying</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_isUnderlying</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_fCashPosition</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_sendToken</span><span class=\"mtk1\">); </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_fCashPosition</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_sendToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_maxSendAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">preTradeSendTokenBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_sendToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">preTradeReceiveTokenBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_fCashPosition</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_fCashPosition</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_maxSendAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_fCashAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">fromUnderlying</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Note that <code>_maxSendAmount</code> is the maximum amount of payment tokens that is allowed to be consumed during minting. This is not the actual amount of payment tokens consumed during the minting process. Thus, after the minting, there will definitely be some residual allowance since it is unlikely that the fCash wrapper contract will consume the exact maximum amount during minting.</p>\n<p>The following piece of code shows that having some residual allowance is expected. The <code>_approve</code> function will not set the allowance unless there is insufficient allowance.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L493\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L493</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\"> Approve the given wrappedFCash instance to spend the setToken&#39;s sendToken </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_approve</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ISetToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IWrappedfCashComplete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fCashPosition</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_sendToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxAssetAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_sendToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">allowance</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_fCashPosition</span><span class=\"mtk1\">)) &lt; </span><span class=\"mtk12\">_maxAssetAmount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">approveCallData</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSelector</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_sendToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">approve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_fCashPosition</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_maxAssetAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">invoke</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_sendToken</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">approveCallData</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Having residual allowance increases the risk of the asset tokens being stolen from the SetToken contract. SetToken contract is where all the tokens/assets are held. If the Notional’s fCash wrapper contract is compromised, it will allow the compromised fCash wrapper contract to withdraw funds from the SetToken contract due to the residual allowance.</p>\n<p>Note that Notional’s fCash wrapper contract is not totally immutable, as it is a upgradeable contract. This is an additional risk factor to be considered. If the Notional’s deployer account is compromised, the attacker could upgrade the Notional’s fCash wrapper contract to a malicious one to withdraw funds from the Index Coop’s SetToken contract due to the residual allowance.</p>\n<p>Index Coop and Notional are two separate protocols and teams. Thus, it is a good security practice not to place any trust on external party wherever possible to ensure that if one party is compromised, it won’t affect the other party. Thus, there should not be any residual allowance that allows Notional’s contract to withdraw funds from Index Coop’s contract in any circumstance.</p>\n<p>In the worst case scenario, a “lazy” manager might simply set the <code>_maxAssetAmount</code> to <code>type(uint256).max</code>. Thus, this will result in large amount of residual allowance left, and expose the SetToken contract to significant risk.</p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Approve the allowance on-demand whenever _<code>mintFCashPosition</code> is called, and reset the allowance back to zero after each minting process to eliminate any residual allowance.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">function _mintFCashPosition(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ISetToken _setToken,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    IWrappedfCashComplete _fCashPosition,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    IERC20 _sendToken,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 _fCashAmount,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 _maxSendAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">returns(uint256 sentAmount)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    if(_fCashAmount == 0) return 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    bool fromUnderlying = _isUnderlying(_fCashPosition, _sendToken); </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    _approve(_setToken, _fCashPosition, _sendToken, _maxSendAmount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 preTradeSendTokenBalance = _sendToken.balanceOf(address(_setToken));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 preTradeReceiveTokenBalance = _fCashPosition.balanceOf(address(_setToken));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    _mint(_setToken, _fCashPosition, _maxSendAmount, _fCashAmount, fromUnderlying)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t..SNIP..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t// Reset the allowance back to zero after minting</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t_approve(_setToken, _fCashPosition, _sendToken, 0);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Update the <code>_approve</code> accordingly to remove the if-statement related to residual allowance.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">function _approve(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ISetToken _setToken,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    IWrappedfCashComplete _fCashPosition,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    IERC20 _sendToken,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 _maxAssetAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    if(IERC20(_sendToken).allowance(address(_setToken), address(_fCashPosition)) &lt; _maxAssetAmount) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        bytes memory approveCallData = abi.encodeWithSelector(_sendToken.approve.selector, address(_fCashPosition), _maxAssetAmount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        _setToken.invoke(address(_sendToken), 0, approveCallData);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/160#issuecomment-1156002724\">ckoopmann (Index Coop) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>This looks like a prudent suggestion.\nWill review and potentially adopt the suggested mitigation.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-dos-set-token-through-erc777-hook\" style=\"position:relative;\"><a href=\"#m-08-dos-set-token-through-erc777-hook\" aria-label=\"m 08 dos set token through erc777 hook permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/168\">[M-08] DOS set token through erc777 hook</a></h2>\n<p><em>Submitted by jonah1005</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/main/index-coop-notional-trade-module/contracts/protocol/modules/v1/DebtIssuanceModule.sol#L131-L141\">https://github.com/code-423n4/2022-06-notional-coop/blob/main/index-coop-notional-trade-module/contracts/protocol/modules/v1/DebtIssuanceModule.sol#L131-L141</a></p>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC777/ERC777.sol#L376-L380\">https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC777/ERC777.sol#L376-L380</a></p>\n<h3 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The <code>wfCash</code> is an <code>erc777</code> token. <a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC777/ERC777.sol#L376-L380\">ERC777.sol#L376-L380</a> Users can get the control flow before sending token and after receiving tokens. This creates attack vectors that require extra caution in designing modules. Any combination of modules may lead to a possible exploit. To elaborate on the dangerousness of the re-entrancy attack, a possible scenario is presented.</p>\n<p>Before the exploit, we first elaborate on three attack vectors:</p>\n<ol>\n<li><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/main/index-coop-notional-trade-module/contracts/protocol/modules/v1/DebtIssuanceModule.sol#L131-L141\">DebtIssuanceModule.sol#L131-L141</a> The issuance module would pull tokens from the sender before minting setToken.</li>\n</ol>\n<p>Assume there are three compoenents in this set. 1. CDai. 2. wfCash  In the <code>_callTokensToSend</code>, the setToken has received <code>cdai</code> and the <code>totalSupply</code> is still the same.</p>\n<ol start=\"2\">\n<li><code>nonReentrant</code> does not protect cross-contract re-entrancy. This means, that during the <code>issue</code> of issuance module, users can trigger other modules’ functions.</li>\n<li>Restricted functions with <code>onlyManagerAndValidSet</code> modifier may be triggered by the exploiter as well. Manager of a setToken is usually a manager contract. Assume it’s a multisig-wallet, the exploiter can front-run the execute transaction and replay the payload during his exploit. Note, a private transaction from flash-bot can still be front-run. Please refer to the <a href=\"https://docs.flashbots.net/flashbots-protect/rpc/uncle-bandits\">uncle bandit risk</a></li>\n</ol>\n<p>Given the above attack vectors, the exploiter have enough weapons to exploit the <code>setToken</code> at a propriate time. Note that different combination of modules may have different exploit paths. As long as the above attack vectors remain, the setToken is vulnerable.</p>\n<p>Assume a setToken with <code>CompoundLeverageModule</code>, <code>NotionalTradeModule</code> and <code>BasicIssuanceModule</code> with the following positions: 1. CDAI: 100  2. wfCash-DAI 100  and totalSupply = 100. The community decides to remove the <code>compoundLeverageModule</code> from the set token. Since <code>notionalTradeModule</code> can handle cDAI, the community vote to just call <code>removeModule</code> to remove <code>compoundLeverageModule</code>. The exploiter has the time to build an exploit and wait the right timing to come.</p>\n<ol start=\"0\">\n<li>The exploiter listen the manager multisig wallet.</li>\n<li>Exploiter issue 10 setToken.</li>\n<li>During the <code>_callTokensToSend</code> of <code>wfcash</code>, the totalSupply = 100, CDAI = 110, wfCash-DAI = 110.</li>\n<li>Call <code>sync</code> of <code>CompoundLeverageModule</code>. <code>_getCollateralPosition</code> get  <code>_cToken.balanceOf(address(_setToken)) = 110</code> and <code>totalSupply = 100</code> and update the <code>DefaultUnit</code> of <code>CETH</code> 1,1X.</li>\n<li>Replay multisig wallet’s payload and remove <code>compoundLeverageModule</code>.</li>\n<li>The <code>setToken</code> can no longer issue / redeem as it would raise <code>undercollateralized</code> error. Further, <code>setValuer</code> would give a pumped valuation that may cause harm to other protocols.</li>\n</ol>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://gist.github.com/Jonah246/13e58b59765c0334189c99a9f29c6dab\">POC</a>\nThe exploit is quite lengthy. Please check the <code>Attack.sol</code> for the main exploit logic.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">register</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_ERC1820_REGISTRY</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setInterfaceImplementer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_TOKENS_SENDER_INTERFACE_HASH</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_ERC1820_REGISTRY</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setInterfaceImplementer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_TOKENS_SENDER_INTERFACE_HASH</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">attack</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">cToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">issueModule</span><span class=\"mtk1\">), </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">wfCash</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">issueModule</span><span class=\"mtk1\">), </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">issueModule</span><span class=\"mtk1\">.</span><span class=\"mtk11\">issue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">setToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">tokensToSend</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">operator</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userData</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">operatorData</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">compoundModule</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sync</span><span class=\"mtk1\">(</span><span class=\"mtk12\">setToken</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">manager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">removeModule</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">setToken</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The design choice of wfcash being an <code>ERC777</code> seems unnecessary to me. Over the past two years, ERC777 leads to so many exploits. <a href=\"https://defirate.com/imbtc-uniswap-hack/\">IMBTC-UNISWAP</a> <a href=\"https://twitter.com/CreamdotFinance/status/1432249771750686721?s=20\">CREAM-AMP</a> I recommend the team use ERC20 instead.</p>\n<p>If the SetToken team considers supporting ERC777 necessary, I recommend implementing protocol-wide cross-contract reentrancy prevention. Please refer to Rari-Capital. <a href=\"https://github.com/Rari-Capital/fuse-v1/blob/development/src/core/Comptroller.sol#L1978-L2002\">Comptroller.sol#L1978-L2002</a></p>\n<p>Note that, <code>Rari</code> was <a href=\"https://www.coindesk.com/business/2022/04/30/defi-lender-rari-capitalfei-loses-80m-in-hack/\">exploited</a> given this reentrancy prevention. Simply making <code>nonReentrant</code> cross-contact prevention may not be enough. I recommend to setToken protocol going through every module and re-consider whether it’s re-entrancy safe.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/168#issuecomment-1156059002\">ckoopmann (Index Coop) commented</a>:</strong></p>\n<blockquote>\n<p>@jeffywu : What do you think ? Can we drop the ERC777 interface from wfCash (it’s not used by the NotionalTradeModule afaik).\nIf not, I’ll have to review this issue in more details and see if we need a mitigation on our side.</p>\n<p>Note that the issue mostly references the DebtIssuanceModule which we probably wont / cant change unless there is a major vulnerability.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/168#issuecomment-1156580278\">jeffywu (Notional) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>@ckoopmann I think we can just drop ERC777</p>\n</blockquote>\n<hr>\n<h2 id=\"m-09-silent-overflow-of-_fcashamount\" style=\"position:relative;\"><a href=\"#m-09-silent-overflow-of-_fcashamount\" aria-label=\"m 09 silent overflow of _fcashamount permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/239\">[M-09] Silent overflow of <code>_fCashAmount</code></a></h2>\n<p><em>Submitted by GreyArt, also found by Meera</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L526\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L526</a></p>\n<h3 id=\"description\" style=\"position:relative;\"><a href=\"#description\" aria-label=\"description permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>If a <code>_fCashAmount</code> value that is greater than uint88 is passed into the <code>_mint</code> function, downcasting it to uint88 will silently overflow.</p>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Use a safe downcast function e.g. wfCashLogic::_safeUint88</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_safeUint88</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">x</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint88</span><span class=\"mtk1\">) {</span><span class=\"mtk12\">hil</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">x</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint88</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">uint88</span><span class=\"mtk1\">(</span><span class=\"mtk12\">x</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/239#issuecomment-1168122818\">ckoopmann (Index Coop) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>This seems reasonable and we’ll probably adopt the suggested mitigation approach.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-10-user-can-alter-amount-returned-by-redeem-function-due-to-control-transfer\" style=\"position:relative;\"><a href=\"#m-10-user-can-alter-amount-returned-by-redeem-function-due-to-control-transfer\" aria-label=\"m 10 user can alter amount returned by redeem function due to control transfer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/235\">[M-10] User can alter amount returned by redeem function due to control transfer</a></h2>\n<p><em>Submitted by 0xDjango</em></p>\n<p>Control is transferred to the receiver when receiving the ERC777. They are able to transfer the ERC777 to another account, at which time the before and after balance calculation will be incorrect.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 balanceBefore = IERC20(asset()).balanceOf(receiver);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (msg.sender != owner) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _spendAllowance(owner, msg.sender, shares);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _redeemInternal(shares, receiver, owner);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/////////////</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Control is transferred to user. They can alter their balance here.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">///////////</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 balanceAfter = IERC20(asset()).balanceOf(receiver);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 assets = balanceAfter - balanceBefore;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">//////////</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Assets can be as low as 0 if they have transferred the same amount out as received.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">//////////</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit Withdraw(msg.sender, receiver, owner, assets, shares);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return assets;</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/235#issuecomment-1156430793\">jeffywu (Notional) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>Control of the contract is not transferred to anyone during a <code>balanceOf</code> call which is read only. No state can be modified.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/235#issuecomment-1156545128\">fatherGoose1 (warden) commented</a>:</strong></p>\n<blockquote>\n<p>The control is transferred in <code>_redeemInternal()</code> which calls <code>_burn()</code> on the ERC777 which transfers control. </p>\n<p><code>_burn()</code> function logic here: <a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/109778c17c7020618ea4e035efb9f0f9b82d43ca/contracts/token/ERC777/ERC777.sol#L390-L400\">https://github.com/OpenZeppelin/openzeppelin-contracts/blob/109778c17c7020618ea4e035efb9f0f9b82d43ca/contracts/token/ERC777/ERC777.sol#L390-L400</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/235#issuecomment-1156599036\">jeffywu (Notional) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Understood, will change to confirmed.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 61 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/215\">report highlighted below</a> by <strong>berndartmueller</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/112\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/152\">GimelSec</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/192\">sorrynotsorry</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/164\">xiaoming90</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/104\">GreyArt</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/150\">Meera</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/222\">jonah1005</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/84\">joestakey</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/80\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/202\">Funen</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/186\">0xf15ers</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/63\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/227\">Picodes</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/228\">hyh</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/122\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/131\">Deivitto</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/142\">zzzitron</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/165\">Trumpero</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/177\">TomJ</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/69\">TerrierLover</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/93\">sseefried</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/209\">simon135</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/101\">PierrickGT</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/10\">oyc_109</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/146\">minhquanym</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/218\">ellahi</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/96\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/94\">cloudjunky</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/138\">Chom</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/44\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/220\">Bronicle</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/194\">antonttc</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/234\">0xDjango</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/114\">0x29A</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/40\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/16\">Sm4rty</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/180\">saian</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/29\">sach1r0</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/189\">Nethermind</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/169\">kenzo</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/190\">hake</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/208\">dipp</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/120\">delfin454000</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/92\">cryptphi</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/170\">Cityscape</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/140\">catchup</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/205\">c3phas</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/48\">0xNineDec</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/27\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/210\">0xmint</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/128\">_Adam</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/136\">z3s</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/171\">Waze</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/233\">Tadashi</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/119\">slywaters</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/73\">Lambda</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/232\">JC</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/125\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/106\">ayeslick</a>, and <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/49\">0xkatana</a>.</em></p>\n<h2 id=\"codebase-impressions--summary\" style=\"position:relative;\"><a href=\"#codebase-impressions--summary\" aria-label=\"codebase impressions  summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Codebase Impressions &#x26; Summary</h2>\n<p>Overall, the contracts are very well implemented and the code quality is very high. Protocol developers provided adequate documentation and information on the protocol.</p>\n<p>Running the test suite is extensive and covers most of the code, however, a few things stood out:</p>\n<ul>\n<li><code>test_wrapped_fcash.test_transfer_fcash_contract</code> is skipped</li>\n<li>many tests are failing on the forked mainnet due to using addresses with insufficient token balances (e.g. <code>whales.DAI_EOA</code> has insufficient DAI tokens)</li>\n<li>the <code>notionalTradeModule.spec</code> test suite has many open <code>TODOs</code></li>\n</ul>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<ul>\n<li>\n<p>Low Risk</p>\n<ul>\n<li>[L-01] Zero-address checks are missing</li>\n<li>[L-02] Use of floating pragma</li>\n<li>[L-03] Events not emitted for important state changes</li>\n<li>[L-04] Matured fCash positions not automatically redeemed in <code>NotionalTradeModule.initialize</code></li>\n<li>[L-05] Misleading <code>NotionalTradeModule._mintFCashPosition</code> function comments]</li>\n<li>[L-06] Misleading comment in <code>wfCashLogic._burn</code> function</li>\n<li>[L-07] Matured fCash can still be wrapped via <code>ERC1155</code> <code>transfer</code></li>\n<li>[L-08] Contracts are using outdated OpenZeppelin version <code>^3.4.2-solc-0.7</code></li>\n<li>[L-09] <code>wfCashERC4626</code> contract does not conform to <code>EIP4626</code></li>\n</ul>\n</li>\n<li>\n<p>Non-Critical Findings</p>\n<ul>\n<li>[N-01] Use the <code>isETH</code> return value from <code>wfCashBase.getToken</code> instead of checking equality with <code>ETH_ADDRESS</code></li>\n</ul>\n</li>\n</ul>\n<h2 id=\"l-01-zero-address-checks-are-missing\" style=\"position:relative;\"><a href=\"#l-01-zero-address-checks-are-missing\" aria-label=\"l 01 zero address checks are missing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] Zero-address checks are missing</h2>\n<p>Zero-address checks are a best practice for input validation of critical address parameters. While the codebase applies this to most cases, there are many places where this is missing in constructors and setters.</p>\n<p>Impact: Accidental use of zero-addresses may result in exceptions, burn fees/tokens, or force redeployment of contracts.</p>\n<h3 id=\"findings\" style=\"position:relative;\"><a href=\"#findings\" aria-label=\"findings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Findings</h3>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol\">NotionalTradeModule.sol</a></strong></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L140\">L140</a> - <code>wrappedfCashFactory = _wrappedfCashFactory;</code><br>\n<a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L141\">L141</a> - <code>weth = _weth;</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashBase.sol\">wfCashBase.sol</a></strong></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashBase.sol#L30\">L30</a> - <code>NotionalV2 = _notional;</code><br>\n<a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashBase.sol#L31\">L31</a> - <code>WETH = _weth;</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/proxy/WrappedfCashFactory.sol\">WrappedfCashFactory.sol</a></strong></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/proxy/WrappedfCashFactory.sol#L18\">L18</a> - <code>BEACON = _beacon;</code></p>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add zero-address checks, e.g.:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_weth</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Zero-address&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"l-02-use-of-floating-pragma\" style=\"position:relative;\"><a href=\"#l-02-use-of-floating-pragma\" aria-label=\"l 02 use of floating pragma permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] Use of floating pragma</h2>\n<p>Contracts should be deployed with the same compiler version and flags that they have been tested with thoroughly. Locking the pragma helps to ensure that contracts do not accidentally get deployed using, for example, an outdated compiler version that might introduce bugs that affect the contract system negatively.</p>\n<p><a href=\"https://swcregistry.io/docs/SWC-103\">https://swcregistry.io/docs/SWC-103</a></p>\n<h3 id=\"findings-1\" style=\"position:relative;\"><a href=\"#findings-1\" aria-label=\"findings 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Findings</h3>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L2\">wfCashERC4626.sol</a> <code>pragma solidity ^0.8.0;</code></p>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Lock the pragma version to the same version as used in the other contracts and also consider known bugs (<a href=\"https://github.com/ethereum/solidity/releases\">https://github.com/ethereum/solidity/releases</a>) for the compiler version that is chosen.</p>\n<p>Pragma statements can be allowed to float when a contract is intended for consumption by other developers, as in the case with contracts in a library or EthPM package. Otherwise, the developer would need to manually update the pragma in order to compile it locally.</p>\n<h2 id=\"l-03-events-not-emitted-for-important-state-changes\" style=\"position:relative;\"><a href=\"#l-03-events-not-emitted-for-important-state-changes\" aria-label=\"l 03 events not emitted for important state changes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] Events not emitted for important state changes</h2>\n<p>When changing state variables events are not emitted. Emitting events allows monitoring activities with off-chain monitoring tools.</p>\n<h3 id=\"findings-2\" style=\"position:relative;\"><a href=\"#findings-2\" aria-label=\"findings 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Findings</h3>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L301\">NotionalTradeModule.sol#L301</a> <code>function setRedeemToUnderlying(ISetToken _setToken, bool _toUnderlying)</code></p>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Emit events for state variable changes.</p>\n<h2 id=\"l-04-matured-fcash-positions-not-automatically-redeemed-in-notionaltrademoduleinitialize\" style=\"position:relative;\"><a href=\"#l-04-matured-fcash-positions-not-automatically-redeemed-in-notionaltrademoduleinitialize\" aria-label=\"l 04 matured fcash positions not automatically redeemed in notionaltrademoduleinitialize permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04] Matured fCash positions not automatically redeemed in <code>NotionalTradeModule.initialize</code></h2>\n<p>The function comments imply that matured fCash positions are redeemed within <code>NotionalTradeModule.initialize</code>. However, this redemption is not implemented in this function.</p>\n<h3 id=\"findings-3\" style=\"position:relative;\"><a href=\"#findings-3\" aria-label=\"findings 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Findings</h3>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L216\">NotionalTradeModule.sol#L216</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">* </span><span class=\"mtk12\">Redeem</span><span class=\"mtk1\"> </span><span class=\"mtk12\">all</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fCash</span><span class=\"mtk1\"> </span><span class=\"mtk12\">positions</span><span class=\"mtk1\"> </span><span class=\"mtk12\">that</span><span class=\"mtk1\"> </span><span class=\"mtk12\">have</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reached</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\"> </span><span class=\"mtk12\">for</span><span class=\"mtk1\"> </span><span class=\"mtk12\">their</span><span class=\"mtk1\"> </span><span class=\"mtk12\">asset</span><span class=\"mtk1\"> </span><span class=\"mtk11\">token</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">cToken</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider calling the function <code>_redeemMaturedPositions</code> to redeem matured fCash positions or adapt the function comments.</p>\n<h2 id=\"l-05-misleading-notionaltrademodule_mintfcashposition-function-comments\" style=\"position:relative;\"><a href=\"#l-05-misleading-notionaltrademodule_mintfcashposition-function-comments\" aria-label=\"l 05 misleading notionaltrademodule_mintfcashposition function comments permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-05] Misleading <code>NotionalTradeModule._mintFCashPosition</code> function comments</h2>\n<p>The function comments imply that the given fCash position is redeemed. However, this function implements <strong>minting</strong> fCash tokens.</p>\n<h3 id=\"findings-4\" style=\"position:relative;\"><a href=\"#findings-4\" aria-label=\"findings 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Findings</h3>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L415\">NotionalTradeModule.sol#L415</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">* @</span><span class=\"mtk12\">dev</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Redeem</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> </span><span class=\"mtk12\">given</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fCash</span><span class=\"mtk1\"> </span><span class=\"mtk12\">position</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\"> </span><span class=\"mtk12\">the</span><span class=\"mtk1\"> </span><span class=\"mtk12\">specified</span><span class=\"mtk1\"> </span><span class=\"mtk12\">send</span><span class=\"mtk1\"> </span><span class=\"mtk11\">token</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">either</span><span class=\"mtk1\"> </span><span class=\"mtk12\">underlying</span><span class=\"mtk1\"> </span><span class=\"mtk12\">or</span><span class=\"mtk1\"> </span><span class=\"mtk12\">asset</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Fix the comments to mention minting instead of redeeming.</p>\n<h2 id=\"l-06-misleading-comment-in-wfcashlogic_burn-function\" style=\"position:relative;\"><a href=\"#l-06-misleading-comment-in-wfcashlogic_burn-function\" aria-label=\"l 06 misleading comment in wfcashlogic_burn function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-06] Misleading comment in <code>wfCashLogic._burn</code> function</h2>\n<p>The comment next to the <code>_withdrawCashToAccount</code> function call implies that the <code>from</code> address is the withdrawal receiver. However, <code>opts.receiver</code> is the receiver.</p>\n<h3 id=\"findings-5\" style=\"position:relative;\"><a href=\"#findings-5\" aria-label=\"findings 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Findings</h3>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashLogic.sol#L230\">wfCashLogic.sol#L230</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk3\">// Transfer withdrawn tokens to the `from` address // @audit-info wrong comment - should be `... to the `opts.receiver` address`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">_withdrawCashToAccount</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">opts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">_safeUint88</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assetInternalCashClaim</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">opts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">redeemToUnderlying</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  );</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Fix the comment.</p>\n<h2 id=\"l-07-matured-fcash-can-still-be-wrapped-via-erc1155-transfer\" style=\"position:relative;\"><a href=\"#l-07-matured-fcash-can-still-be-wrapped-via-erc1155-transfer\" aria-label=\"l 07 matured fcash can still be wrapped via erc1155 transfer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-07] Matured fCash can still be wrapped via <code>ERC1155</code> <code>transfer</code></h2>\n<p>Contrary to the key invariants stated in the <a href=\"https://github.com/code-423n4/2022-06-notional-coop/\">README</a> (<em>“After maturity, wrapped fCash can no longer be minted.”</em>), matured fCash can be sent to this <code>wfCash</code> contract to receive wrapped fCash tokens in return.</p>\n<h3 id=\"findings-6\" style=\"position:relative;\"><a href=\"#findings-6\" aria-label=\"findings 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Findings</h3>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashLogic.sol#L107-L152\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashLogic.sol#L107-L152</a></p>\n<h3 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider adding a check for fCash maturity:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(!</span><span class=\"mtk11\">hasMatured</span><span class=\"mtk1\">(), </span><span class=\"mtk8\">&quot;fCash matured&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"l-08-contracts-are-using-outdated-openzeppelin-version-342-solc-07\" style=\"position:relative;\"><a href=\"#l-08-contracts-are-using-outdated-openzeppelin-version-342-solc-07\" aria-label=\"l 08 contracts are using outdated openzeppelin version 342 solc 07 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-08] Contracts are using outdated OpenZeppelin version <code>^3.4.2-solc-0.7</code></h2>\n<p>Within <code>notional-wrapped-fcash</code> <code>package.json</code>, an outdated OZ version is used (which has known vulnerabilities, see <a href=\"https://snyk.io/vuln/npm%3A%40openzeppelin%2Fcontracts\">https://snyk.io/vuln/npm%3A%40openzeppelin%2Fcontracts</a>).</p>\n<p>However, as <code>Brownie</code> is used to install dependencies and compile the contracts, using this outdated version declared in the <code>package.json</code> does not impose any risks so far.</p>\n<p>Anyway, to prevent any issues in the future (e.g. using solely <code>hardhat</code> to compile and deploy the contracts), upgrade the used OZ packages within the <code>package.json</code> to the latest versions.</p>\n<p>See similar findings:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/81\">https://github.com/code-423n4/2022-02-hubble-findings/issues/81</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/81\">https://github.com/code-423n4/2022-02-hubble-findings/issues/81</a></li>\n</ul>\n<h3 id=\"findings-7\" style=\"position:relative;\"><a href=\"#findings-7\" aria-label=\"findings 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Findings</h3>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/main/notional-wrapped-fcash/package.json#L14\">https://github.com/code-423n4/2022-06-notional-coop/blob/main/notional-wrapped-fcash/package.json#L14</a></p>\n<h3 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider using the latest OZ packages within <code>package.json</code>.</p>\n<h2 id=\"l-09-wfcasherc4626-contract-does-not-conform-to-eip4626\" style=\"position:relative;\"><a href=\"#l-09-wfcasherc4626-contract-does-not-conform-to-eip4626\" aria-label=\"l 09 wfcasherc4626 contract does not conform to eip4626 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-09] <code>wfCashERC4626</code> contract does not conform to <code>EIP4626</code></h2>\n<p>The <code>wfCashERC4626</code> contract implements the <code>EIP4626</code> standard (<a href=\"https://eips.ethereum.org/EIPS/eip-4626\">EIP-4626: Tokenized Vault Standard</a>).</p>\n<p>However, according to <code>EIP4626</code>, the below-mentioned functions do not fully adhere to the specs. They possibly revert due to <code>require</code> checks or revert due to external calls reverting.</p>\n<h3 id=\"findings-8\" style=\"position:relative;\"><a href=\"#findings-8\" aria-label=\"findings 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Findings</h3>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L47\">L47</a> - <code>function totalAssets() public view override returns (uint256)</code></p>\n<p>Possibly reverts due to <code>_getMaturedValue</code> and <code>_getPresentValue</code> reverting.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L52\">L52</a> - <code>function convertToShares(uint256 assets) public view override returns (uint256 shares)</code></p>\n<p>Possibly reverts due to <code>_getPresentValue</code> and <code>totalAssets</code> reverting.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L64\">L64</a> - <code>function convertToAssets(uint256 shares) public view override returns (uint256 assets)</code></p>\n<p>Possibly reverts due to <code>_getPresentValue</code> and <code>totalAssets</code> reverting.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L85\">L85</a> - <code>function maxWithdraw(address owner) public view override returns (uint256)</code></p>\n<p>Possibly reverts due to <code>convertToShares</code> within <code>previewWithdraw</code> reverting.</p>\n<h3 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Given the circumstances, in most of the mentioned cases, it’s not possible to implement it without ever reverting. Nevertheless, I want to point out that this contract does not fully conform with the <code>EIP4626</code> standard.</p>\n<h2 id=\"n-01-use-the-iseth-return-value-from-wfcashbasegettoken-instead-of-checking-equality-with-eth_address\" style=\"position:relative;\"><a href=\"#n-01-use-the-iseth-return-value-from-wfcashbasegettoken-instead-of-checking-equality-with-eth_address\" aria-label=\"n 01 use the iseth return value from wfcashbasegettoken instead of checking equality with eth_address permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] Use the <code>isETH</code> return value from <code>wfCashBase.getToken</code> instead of checking equality with <code>ETH_ADDRESS</code></h2>\n<p>The <code>wfCashBase.getToken</code> returns <code>bool isETH</code> which can be used to figure out if the returned token is the native ETH token.</p>\n<h3 id=\"findings-9\" style=\"position:relative;\"><a href=\"#findings-9\" aria-label=\"findings 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Findings</h3>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L400-L403\">NotionalTradeModule.sol#L400-L403</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiveToken</span><span class=\"mtk1\">,) = </span><span class=\"mtk12\">fCashPosition</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">toUnderlying</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receiveToken</span><span class=\"mtk1\">) == </span><span class=\"mtk12\">ETH_ADDRESS</span><span class=\"mtk1\">) { </span><span class=\"mtk3\">// @audit-info use returned `isETH` variable from above function instead</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">receiveToken</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-19\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-19\" aria-label=\"recommended mitigation steps 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider using the returned <code>isETH</code> variable:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiveToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isETH</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">fCashPosition</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">toUnderlying</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">isETH</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">receiveToken</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/215#issuecomment-1158384906\">ckoopmann (Index Coop) commented</a>:</strong></p>\n<blockquote>\n<p>Very nice QA report imo. All the issues regarding the NotionalTradeModule are valid and actionable. Also good format and concise description of the issues and proposed mitigation / fix.</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 55 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/111\">report highlighted below</a> by <strong>IllIllI</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/184\">antonttc</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/148\">Meera</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/187\">0xKitsune</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/83\">joestakey</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/50\">0xkatana</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/113\">0x29A</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/39\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/172\">Waze</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/100\">PierrickGT</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/223\">hyh</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/105\">GreyArt</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/117\">delfin454000</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/204\">Chom</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/213\">berndartmueller</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/149\">TomJ</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/107\">Tomio</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/70\">TerrierLover</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/118\">slywaters</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/158\">simon135</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/175\">rfa</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/71\">8olidity</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/185\">0xf15ers</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/127\">_Adam</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/64\">0xSolus</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/173\">UnusualTurtle</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/178\">saian</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/28\">sach1r0</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/224\">Picodes</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/9\">oyc_109</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/217\">ellahi</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/130\">Deivitto</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/141\">catchup</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/212\">c3phas</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/41\">asutorufos</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/7\">Sm4rty</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/2\">samruna</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/55\">kaden</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/203\">Funen</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/121\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/134\">ElKu</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/81\">DavidGialdi</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/95\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/166\">Cityscape</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/26\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/201\">0v3rf10w</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/109\">ynnad</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/231\">Tadashi</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/147\">minhquanym</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/72\">Lambda</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/124\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/191\">hake</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/230\">Fitraldys</a>, <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/25\">djxploit</a>, and <a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/211\">0xmint</a>.</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"left\">Issue</th>\n<th align=\"center\">Instances</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td align=\"left\">Avoid contract existence checks by using solidity version 0.8.10 or later</td>\n<td align=\"center\">6</td>\n</tr>\n<tr>\n<td>2</td>\n<td align=\"left\">Multiple accesses of a mapping/array should use a local variable cache</td>\n<td align=\"center\">5</td>\n</tr>\n<tr>\n<td>3</td>\n<td align=\"left\"><code>internal</code> functions only called once can be inlined to save gas</td>\n<td align=\"center\">7</td>\n</tr>\n<tr>\n<td>4</td>\n<td align=\"left\"><code>&#x3C;array>.length</code> should not be looked up in every loop of a <code>for</code>-loop</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>5</td>\n<td align=\"left\"><code>require()</code>/<code>revert()</code> strings longer than 32 bytes cost extra gas</td>\n<td align=\"center\">4</td>\n</tr>\n<tr>\n<td>6</td>\n<td align=\"left\"><code>private</code> functions not called by the contract should be removed to save deployment gas</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>7</td>\n<td align=\"left\">Optimize names to save gas</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>8</td>\n<td align=\"left\">Using <code>bool</code>s for storage incurs overhead</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td>9</td>\n<td align=\"left\">Use a more recent version of solidity</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>10</td>\n<td align=\"left\">Use a more recent version of solidity</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>11</td>\n<td align=\"left\">It costs more gas to initialize non-<code>constant</code>/non-<code>immutable</code> variables to zero than to let the default of zero be applied</td>\n<td align=\"center\">7</td>\n</tr>\n<tr>\n<td>12</td>\n<td align=\"left\"><code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</td>\n<td align=\"center\">5</td>\n</tr>\n<tr>\n<td>13</td>\n<td align=\"left\">Splitting <code>require()</code> statements that use <code>&#x26;&#x26;</code> saves gas</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>14</td>\n<td align=\"left\">Usage of <code>uints</code>/<code>ints</code> smaller than 32 bytes (256 bits) incurs overhead</td>\n<td align=\"center\">53</td>\n</tr>\n<tr>\n<td>15</td>\n<td align=\"left\"><code>abi.encode()</code> is less efficient than <code>abi.encodePacked()</code></td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td>16</td>\n<td align=\"left\">Using <code>private</code> rather than <code>public</code> for constants, saves gas</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>17</td>\n<td align=\"left\">Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</td>\n<td align=\"center\">17</td>\n</tr>\n<tr>\n<td>18</td>\n<td align=\"left\">Functions guaranteed to revert when called by normal users can be marked <code>payable</code></td>\n<td align=\"center\">14</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 133 instances over 18 issues</p>\n<h2 id=\"1-avoid-contract-existence-checks-by-using-solidity-version-0810-or-later\" style=\"position:relative;\"><a href=\"#1-avoid-contract-existence-checks-by-using-solidity-version-0810-or-later\" aria-label=\"1 avoid contract existence checks by using solidity version 0810 or later permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[1] Avoid contract existence checks by using solidity version 0.8.10 or later</h2>\n<p>Prior to 0.8.10 the compiler inserted extra code, including <code>EXTCODESIZE</code> (<strong>700 gas</strong>), to check for contract existence for external calls. In more recent solidity versions, the compiler will not insert these checks if the external call has a return value</p>\n<p><em>There are 6 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">index</span><span class=\"mtk1\">-</span><span class=\"mtk12\">coop</span><span class=\"mtk1\">-</span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">trade</span><span class=\"mtk1\">-</span><span class=\"mtk10\">module</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">protocol</span><span class=\"mtk1\">/</span><span class=\"mtk12\">modules</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NotionalTradeModule</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit registerToIssuanceModule()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">239</span><span class=\"mtk1\">:              </span><span class=\"mtk15\">try</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IDebtIssuanceModule</span><span class=\"mtk1\">(</span><span class=\"mtk12\">modules</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">registerToIssuanceModule</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">) {} </span><span class=\"mtk15\">catch</span><span class=\"mtk1\"> {}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit unregisterFromIssuanceModule()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">256</span><span class=\"mtk1\">:                  </span><span class=\"mtk15\">try</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IDebtIssuanceModule</span><span class=\"mtk1\">(</span><span class=\"mtk12\">modules</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">unregisterFromIssuanceModule</span><span class=\"mtk1\">(</span><span class=\"mtk12\">setToken</span><span class=\"mtk1\">) {} </span><span class=\"mtk15\">catch</span><span class=\"mtk1\"> {}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit allowance()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">501</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_sendToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">allowance</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_fCashPosition</span><span class=\"mtk1\">)) &lt; </span><span class=\"mtk12\">_maxAssetAmount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit getDecodedID()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">639</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">try</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IWrappedfCash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_fCashPosition</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getDecodedID</span><span class=\"mtk1\">() </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maturity</span><span class=\"mtk1\">){</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L239\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L239</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">wrapped</span><span class=\"mtk1\">-</span><span class=\"mtk12\">fcash</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">wfCashERC4626</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit balanceOf()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">212</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceBefore</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk11\">asset</span><span class=\"mtk1\">()).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit balanceOf()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">219</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceAfter</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk11\">asset</span><span class=\"mtk1\">()).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L212\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L212</a></p>\n<h2 id=\"2-multiple-accesses-of-a-mappingarray-should-use-a-local-variable-cache\" style=\"position:relative;\"><a href=\"#2-multiple-accesses-of-a-mappingarray-should-use-a-local-variable-cache\" aria-label=\"2 multiple accesses of a mappingarray should use a local variable cache permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[2] Multiple accesses of a mapping/array should use a local variable cache</h2>\n<p>The instances below point to the second+ access of a value inside a mapping/array, within a function. Caching a mapping’s value in a local <code>storage</code> variable when the value is accessed <a href=\"https://gist.github.com/IllIllI000/ec23a57daa30a8f8ca8b9681c8ccefb0\">multiple times</a>, saves <strong>~42 gas per access</strong> due to not having to recalculate the key’s keccak256 hash (Gkeccak256 - <strong>30 gas</strong>) and that calculation’s associated stack operations. Caching an array’s struct avoids recalculating the array offsets into memory</p>\n<p><em>There are 5 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">index</span><span class=\"mtk1\">-</span><span class=\"mtk12\">coop</span><span class=\"mtk1\">-</span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">trade</span><span class=\"mtk1\">-</span><span class=\"mtk10\">module</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">protocol</span><span class=\"mtk1\">/</span><span class=\"mtk12\">modules</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NotionalTradeModule</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit positions[i] on line 395</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">396</span><span class=\"mtk1\">:                  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">component</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">component</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit positions[i] on line 607</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">608</span><span class=\"mtk1\">:                  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">component</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">component</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit positions[i] on line 619</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">620</span><span class=\"mtk1\">:                  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">component</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">component</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L396\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L396</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">wrapped</span><span class=\"mtk1\">-</span><span class=\"mtk12\">fcash</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">wfCashLogic</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit assets[0] on line 133</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">134</span><span class=\"mtk1\">:                  </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit assets[0] on line 134</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">135</span><span class=\"mtk1\">:                  </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">assetType</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashLogic.sol#L134\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashLogic.sol#L134</a></p>\n<h2 id=\"3-internal-functions-only-called-once-can-be-inlined-to-save-gas\" style=\"position:relative;\"><a href=\"#3-internal-functions-only-called-once-can-be-inlined-to-save-gas\" aria-label=\"3 internal functions only called once can be inlined to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[3] <code>internal</code> functions only called once can be inlined to save gas</h2>\n<p>Not inlining costs <strong>20 to 40 gas</strong> because of two extra <code>JUMP</code> instructions and additional stack operations needed for function calls.</p>\n<p><em>There are 7 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">index</span><span class=\"mtk1\">-</span><span class=\"mtk12\">coop</span><span class=\"mtk1\">-</span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">trade</span><span class=\"mtk1\">-</span><span class=\"mtk10\">module</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">protocol</span><span class=\"mtk1\">/</span><span class=\"mtk12\">modules</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NotionalTradeModule</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">368</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_deployWrappedfCash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maturity</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IWrappedfCashComplete</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">376</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_getWrappedfCash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maturity</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IWrappedfCashComplete</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">418</span><span class=\"mtk1\">       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_mintFCashPosition</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">419           </span><span class=\"mtk12\">ISetToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">420           </span><span class=\"mtk12\">IWrappedfCashComplete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fCashPosition</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">421           </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_sendToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">422           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fCashAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">423           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxSendAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">424       )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">425       </span><span class=\"mtk11\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">426:      </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sentAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">493       </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_approve</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">494           </span><span class=\"mtk12\">ISetToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">495           </span><span class=\"mtk12\">IWrappedfCashComplete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fCashPosition</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">496           </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_sendToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">497:          </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_maxAssetAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">537</span><span class=\"mtk1\">       </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_redeem</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">538</span><span class=\"mtk1\">           </span><span class=\"mtk10\">ISetToken</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_setToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">539</span><span class=\"mtk1\">           </span><span class=\"mtk10\">IWrappedfCashComplete</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_fCashPosition</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">540</span><span class=\"mtk1\">           </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_fCashAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">541</span><span class=\"mtk1\">:          </span><span class=\"mtk10\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_toUnderlying</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">581</span><span class=\"mtk1\">       </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_getUnderlyingAndAssetTokens</span><span class=\"mtk1\">(</span><span class=\"mtk10\">IWrappedfCashComplete</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_fCashPosition</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">582</span><span class=\"mtk1\">       </span><span class=\"mtk10\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">583</span><span class=\"mtk1\">       </span><span class=\"mtk10\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">584</span><span class=\"mtk1\">:      </span><span class=\"mtk10\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk10\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk10\">underlyingToken</span><span class=\"mtk1\">, </span><span class=\"mtk10\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk10\">assetToken</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">596</span><span class=\"mtk1\">       </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_getFCashPositions</span><span class=\"mtk1\">(</span><span class=\"mtk10\">ISetToken</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_setToken</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">597</span><span class=\"mtk1\">       </span><span class=\"mtk10\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">598</span><span class=\"mtk1\">       </span><span class=\"mtk10\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">599</span><span class=\"mtk1\">:      </span><span class=\"mtk10\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk10\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">fCashPositions</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L368\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L368</a></p>\n<h2 id=\"4-arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\" style=\"position:relative;\"><a href=\"#4-arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\" aria-label=\"4 arraylength should not be looked up in every loop of a for loop permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[4] <code>&#x3C;array>.length</code> should not be looked up in every loop of a <code>for</code>-loop</h2>\n<p>The overheads outlined below are <em>PER LOOP</em>, excluding the first loop</p>\n<ul>\n<li>storage arrays incur a Gwarmaccess (<strong>100 gas</strong>)</li>\n<li>memory arrays use <code>MLOAD</code> (<strong>3 gas</strong>)</li>\n<li>calldata arrays use <code>CALLDATALOAD</code> (<strong>3 gas</strong>)</li>\n</ul>\n<p>Caching the length changes each of these to a <code>DUP&#x3C;N></code> (<strong>3 gas</strong>), and gets rid of the extra <code>DUP&#x3C;N></code> needed to store the stack offset</p>\n<p><em>There are 2 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">index</span><span class=\"mtk1\">-</span><span class=\"mtk12\">coop</span><span class=\"mtk1\">-</span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">trade</span><span class=\"mtk1\">-</span><span class=\"mtk10\">module</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">protocol</span><span class=\"mtk1\">/</span><span class=\"mtk12\">modules</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NotionalTradeModule</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">238</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">modules</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L238\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L238</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">index</span><span class=\"mtk1\">-</span><span class=\"mtk12\">coop</span><span class=\"mtk1\">-</span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">trade</span><span class=\"mtk1\">-</span><span class=\"mtk10\">module</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">protocol</span><span class=\"mtk1\">/</span><span class=\"mtk12\">modules</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NotionalTradeModule</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">254</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">modules</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L254\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L254</a></p>\n<h2 id=\"5-requirerevert-strings-longer-than-32-bytes-cost-extra-gas\" style=\"position:relative;\"><a href=\"#5-requirerevert-strings-longer-than-32-bytes-cost-extra-gas\" aria-label=\"5 requirerevert strings longer than 32 bytes cost extra gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[5] <code>require()</code>/<code>revert()</code> strings longer than 32 bytes cost extra gas</h2>\n<p>Each extra chunk of byetes past the original 32 i<a href=\"https://gist.github.com/hrkrshnn/ee8fabd532058307229d65dcd5836ddc#consider-having-short-revert-strings\">incurs an MSTORE</a> which costs 3 gas</p>\n<p><em>There are 4 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">index</span><span class=\"mtk1\">-</span><span class=\"mtk12\">coop</span><span class=\"mtk1\">-</span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">trade</span><span class=\"mtk1\">-</span><span class=\"mtk10\">module</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">protocol</span><span class=\"mtk1\">/</span><span class=\"mtk12\">modules</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NotionalTradeModule</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">169</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isComponent</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_sendToken</span><span class=\"mtk1\">)), </span><span class=\"mtk8\">&quot;Send token must be an index component&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L169\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L169</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">index</span><span class=\"mtk1\">-</span><span class=\"mtk12\">coop</span><span class=\"mtk1\">-</span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">trade</span><span class=\"mtk1\">-</span><span class=\"mtk10\">module</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">protocol</span><span class=\"mtk1\">/</span><span class=\"mtk12\">modules</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NotionalTradeModule</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">199</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isComponent</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wrappedfCash</span><span class=\"mtk1\">)), </span><span class=\"mtk8\">&quot;FCash to redeem must be an index component&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L199\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L199</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">index</span><span class=\"mtk1\">-</span><span class=\"mtk12\">coop</span><span class=\"mtk1\">-</span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">trade</span><span class=\"mtk1\">-</span><span class=\"mtk10\">module</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">protocol</span><span class=\"mtk1\">/</span><span class=\"mtk12\">modules</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NotionalTradeModule</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">378</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wrappedfCashAddress</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isContract</span><span class=\"mtk1\">(), </span><span class=\"mtk8\">&quot;WrappedfCash not deployed for given parameters&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L378\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L378</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">index</span><span class=\"mtk1\">-</span><span class=\"mtk12\">coop</span><span class=\"mtk1\">-</span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">trade</span><span class=\"mtk1\">-</span><span class=\"mtk10\">module</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">protocol</span><span class=\"mtk1\">/</span><span class=\"mtk12\">modules</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NotionalTradeModule</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">4</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">573</span><span class=\"mtk1\">:              </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_paymentToken</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">assetToken</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Token is neither asset nor underlying token&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L573\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L573</a></p>\n<h2 id=\"6-private-functions-not-called-by-the-contract-should-be-removed-to-save-deployment-gas\" style=\"position:relative;\"><a href=\"#6-private-functions-not-called-by-the-contract-should-be-removed-to-save-deployment-gas\" aria-label=\"6 private functions not called by the contract should be removed to save deployment gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[6] <code>private</code> functions not called by the contract should be removed to save deployment gas</h2>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">wrapped</span><span class=\"mtk1\">-</span><span class=\"mtk12\">fcash</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">wfCashERC4626</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">243</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_safeNegInt88</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">x</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">int88</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L243\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L243</a></p>\n<h2 id=\"7-optimize-names-to-save-gas\" style=\"position:relative;\"><a href=\"#7-optimize-names-to-save-gas\" aria-label=\"7 optimize names to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[7] Optimize names to save gas</h2>\n<p><code>public</code>/<code>external</code> function names and <code>public</code> member variable names can be optimized to save gas. See <a href=\"https://gist.github.com/IllIllI000/a5d8b486a8259f9f77891a919febd1a9\">this</a> link for an example of how it works. Below are the interfaces/abstract contracts that can be optimized so that the most frequently-called functions use the least amount of gas possible during method lookup. Method IDs that have two leading zero bytes can save <strong>128 gas</strong> each during deployment, and renaming functions to have lower method IDs will save <strong>22 gas</strong> per call, <a href=\"https://medium.com/joyso/solidity-how-does-function-name-affect-gas-consumption-in-smart-contract-47d270d8ac92\">per sorted position shifted</a></p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">wrapped</span><span class=\"mtk1\">-</span><span class=\"mtk12\">fcash</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">wfCashBase</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit getToken()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">16</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">abstract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wfCashBase</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ERC777Upgradeable</span><span class=\"mtk1\">, </span><span class=\"mtk12\">IWrappedfCash</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashBase.sol#L16\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashBase.sol#L16</a></p>\n<h2 id=\"8-using-bools-for-storage-incurs-overhead\" style=\"position:relative;\"><a href=\"#8-using-bools-for-storage-incurs-overhead\" aria-label=\"8 using bools for storage incurs overhead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[8] Using <code>bool</code>s for storage incurs overhead</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Booleans are more expensive than uint256 or any type that takes up a full</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// word because each write operation emits an extra SLOAD to first read the</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// slot&#39;s contents, replace the bits taken up by the boolean, and then write</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// back. This is the compiler&#39;s defense against contract upgrades and</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// pointer aliasing, and it cannot be disabled.</span></span></span></code></pre>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27\">https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27</a>\nUse <code>uint256(1)</code> and <code>uint256(2)</code> for true/false to avoid a Gwarmaccess (<strong><a href=\"https://gist.github.com/IllIllI000/1b70014db712f8572a72378321250058\">100 gas</a></strong>) for the extra SLOAD, and to avoid Gsset (<strong>20000 gas</strong>) when changing from ‘false’ to ‘true’, after having been ‘true’ in the past</p>\n<p><em>There are 3 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">index</span><span class=\"mtk1\">-</span><span class=\"mtk12\">coop</span><span class=\"mtk1\">-</span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">trade</span><span class=\"mtk1\">-</span><span class=\"mtk10\">module</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">protocol</span><span class=\"mtk1\">/</span><span class=\"mtk12\">modules</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NotionalTradeModule</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">112</span><span class=\"mtk1\">:      </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ISetToken</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">redeemToUnderlying</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L112\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L112</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">index</span><span class=\"mtk1\">-</span><span class=\"mtk12\">coop</span><span class=\"mtk1\">-</span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">trade</span><span class=\"mtk1\">-</span><span class=\"mtk10\">module</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">protocol</span><span class=\"mtk1\">/</span><span class=\"mtk12\">modules</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NotionalTradeModule</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">115</span><span class=\"mtk1\">:      </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ISetToken</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">allowedSetTokens</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L115\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L115</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">index</span><span class=\"mtk1\">-</span><span class=\"mtk12\">coop</span><span class=\"mtk1\">-</span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">trade</span><span class=\"mtk1\">-</span><span class=\"mtk10\">module</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">protocol</span><span class=\"mtk1\">/</span><span class=\"mtk12\">modules</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NotionalTradeModule</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">118</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">anySetAllowed</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L118\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L118</a></p>\n<h2 id=\"9-use-a-more-recent-version-of-solidity\" style=\"position:relative;\"><a href=\"#9-use-a-more-recent-version-of-solidity\" aria-label=\"9 use a more recent version of solidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[9] Use a more recent version of solidity</h2>\n<p>Use a solidity version of at least 0.8.0 to get overflow protection without <code>SafeMath</code>\nUse a solidity version of at least 0.8.2 to get simple compiler automatic inlining\nUse a solidity version of at least 0.8.3 to get better struct packing and cheaper multiple storage reads\nUse a solidity version of at least 0.8.4 to get custom errors, which are cheaper at deployment than <code>revert()/require()</code> strings\nUse a solidity version of at least 0.8.10 to have external calls skip contract existence checks if the external call has a return value</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">index</span><span class=\"mtk1\">-</span><span class=\"mtk12\">coop</span><span class=\"mtk1\">-</span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">trade</span><span class=\"mtk1\">-</span><span class=\"mtk10\">module</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">protocol</span><span class=\"mtk1\">/</span><span class=\"mtk12\">modules</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NotionalTradeModule</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">19</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.6</span><span class=\"mtk1\">.</span><span class=\"mtk7\">10</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L19\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L19</a></p>\n<h2 id=\"10-use-a-more-recent-version-of-solidity\" style=\"position:relative;\"><a href=\"#10-use-a-more-recent-version-of-solidity\" aria-label=\"10 use a more recent version of solidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[10] Use a more recent version of solidity</h2>\n<p>Use a solidity version of at least 0.8.2 to get simple compiler automatic inlining\nUse a solidity version of at least 0.8.3 to get better struct packing and cheaper multiple storage reads\nUse a solidity version of at least 0.8.4 to get custom errors, which are cheaper at deployment than <code>revert()/require()</code> strings\nUse a solidity version of at least 0.8.10 to have external calls skip contract existence checks if the external call has a return value</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">wrapped</span><span class=\"mtk1\">-</span><span class=\"mtk12\">fcash</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">wfCashERC4626</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">2</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> ^</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L2\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L2</a></p>\n<h2 id=\"11-it-costs-more-gas-to-initialize-non-constantnon-immutable-variables-to-zero-than-to-let-the-default-of-zero-be-applied\" style=\"position:relative;\"><a href=\"#11-it-costs-more-gas-to-initialize-non-constantnon-immutable-variables-to-zero-than-to-let-the-default-of-zero-be-applied\" aria-label=\"11 it costs more gas to initialize non constantnon immutable variables to zero than to let the default of zero be applied permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[11] It costs more gas to initialize non-<code>constant</code>/non-<code>immutable</code> variables to zero than to let the default of zero be applied</h2>\n<p><em>There are 7 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">index</span><span class=\"mtk1\">-</span><span class=\"mtk12\">coop</span><span class=\"mtk1\">-</span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">trade</span><span class=\"mtk1\">-</span><span class=\"mtk10\">module</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">protocol</span><span class=\"mtk1\">/</span><span class=\"mtk12\">modules</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NotionalTradeModule</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">48</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ETH_ADDRESS</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">238</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">modules</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">254</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">modules</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">393</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">positionsLength</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">519</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minImpliedRate</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">605</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">positionsLength</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">618</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">positionsLength</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L48\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L48</a></p>\n<h2 id=\"12-i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\" style=\"position:relative;\"><a href=\"#12-i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\" aria-label=\"12 i costs less gas than i especially when its used in for loops   ii   too permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[12] <code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</h2>\n<p>Saves <strong>6 gas per loop</strong></p>\n<p><em>There are 5 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">index</span><span class=\"mtk1\">-</span><span class=\"mtk12\">coop</span><span class=\"mtk1\">-</span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">trade</span><span class=\"mtk1\">-</span><span class=\"mtk10\">module</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">protocol</span><span class=\"mtk1\">/</span><span class=\"mtk12\">modules</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NotionalTradeModule</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">238</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">modules</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">254</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">modules</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">393</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">positionsLength</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">605</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">positionsLength</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">618</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">positionsLength</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L238\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L238</a></p>\n<h2 id=\"13-splitting-require-statements-that-use--saves-gas\" style=\"position:relative;\"><a href=\"#13-splitting-require-statements-that-use--saves-gas\" aria-label=\"13 splitting require statements that use  saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[13] Splitting <code>require()</code> statements that use <code>&#x26;&#x26;</code> saves gas</h2>\n<p>See <a href=\"https://github.com/code-423n4/2022-01-xdefi-findings/issues/128\">this issue</a> which describes the fact that there is a larger deployment gas cost, but with enough runtime calls, the change ends up being cheaper</p>\n<p><em>There are 2 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">wrapped</span><span class=\"mtk1\">-</span><span class=\"mtk12\">fcash</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">wfCashLogic</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">116</span><span class=\"mtk1\">           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">117</span><span class=\"mtk1\">               </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">NotionalV2</span><span class=\"mtk1\">) &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">118</span><span class=\"mtk1\">               </span><span class=\"mtk3\">// Only accept the fcash id that corresponds to the listed currency and maturity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">119</span><span class=\"mtk1\">               </span><span class=\"mtk12\">_id</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">fCashID</span><span class=\"mtk1\"> &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">120</span><span class=\"mtk1\">               </span><span class=\"mtk3\">// Protect against signed value underflows</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">121</span><span class=\"mtk1\">               </span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_value</span><span class=\"mtk1\">) &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">122</span><span class=\"mtk1\">               </span><span class=\"mtk8\">&quot;Invalid&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">123</span><span class=\"mtk1\">:          );</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashLogic.sol#L116-L123\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashLogic.sol#L116-L123</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">wrapped</span><span class=\"mtk1\">-</span><span class=\"mtk12\">fcash</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">wfCashLogic</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">129</span><span class=\"mtk1\">           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">130</span><span class=\"mtk1\">               </span><span class=\"mtk12\">ac</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hasDebt</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0x00</span><span class=\"mtk1\"> &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">131</span><span class=\"mtk1\">               </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">132</span><span class=\"mtk1\">               </span><span class=\"mtk12\">EncodeDecode</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeERC1155Id</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">133</span><span class=\"mtk1\">                   </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">134</span><span class=\"mtk1\">                   </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">135</span><span class=\"mtk1\">                   </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">assetType</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">136</span><span class=\"mtk1\">               ) == </span><span class=\"mtk12\">fCashID</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">137</span><span class=\"mtk1\">:          );</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashLogic.sol#L129-L137\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashLogic.sol#L129-L137</a></p>\n<h2 id=\"14-usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\" style=\"position:relative;\"><a href=\"#14-usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\" aria-label=\"14 usage of uintsints smaller than 32 bytes 256 bits incurs overhead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[14] Usage of <code>uints</code>/<code>ints</code> smaller than 32 bytes (256 bits) incurs overhead</h2>\n<blockquote>\n<p>When using elements that are smaller than 32 bytes, your contract’s gas usage may be higher. This is because the EVM operates on 32 bytes at a time. Therefore, if the element is smaller than that, the EVM must use more operations in order to reduce the size of the element from 32 bytes to the desired size.</p>\n</blockquote>\n<p><a href=\"https://docs.soliditylang.org/en/v0.8.11/internals/layout_in_storage.html\">https://docs.soliditylang.org/en/v0.8.11/internals/layout_in_storage.html</a>\nUse a larger size then downcast where needed</p>\n<p><em>There are 53 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">index</span><span class=\"mtk1\">-</span><span class=\"mtk12\">coop</span><span class=\"mtk1\">-</span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">trade</span><span class=\"mtk1\">-</span><span class=\"mtk10\">module</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">protocol</span><span class=\"mtk1\">/</span><span class=\"mtk12\">modules</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NotionalTradeModule</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">158</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currencyId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">159</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maturity</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">187</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currencyId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">188</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maturity</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">368</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_deployWrappedfCash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maturity</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IWrappedfCashComplete</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">368</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_deployWrappedfCash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maturity</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IWrappedfCashComplete</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">376</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_getWrappedfCash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maturity</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IWrappedfCashComplete</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">376</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_getWrappedfCash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maturity</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IWrappedfCashComplete</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">519</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minImpliedRate</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">545</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxImpliedRate</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint32</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">639</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">try</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IWrappedfCash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_fCashPosition</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getDecodedID</span><span class=\"mtk1\">() </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maturity</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">639</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">try</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IWrappedfCash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_fCashPosition</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getDecodedID</span><span class=\"mtk1\">() </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maturity</span><span class=\"mtk1\">){</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L158\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L158</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">wrapped</span><span class=\"mtk1\">-</span><span class=\"mtk12\">fcash</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">wfCashBase</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">35</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initializer</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">35</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initializer</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">83</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getMaturity</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">93</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getCurrencyId</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">98</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getDecodedID</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">98</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getDecodedID</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">103</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">109</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getMarketIndex</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashBase.sol#L35\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashBase.sol#L35</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">wrapped</span><span class=\"mtk1\">-</span><span class=\"mtk12\">fcash</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxy</span><span class=\"mtk1\">/</span><span class=\"mtk12\">WrappedfCashFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">15</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">event</span><span class=\"mtk1\"> </span><span class=\"mtk11\">WrapperDeployed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wrapper</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">15</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">event</span><span class=\"mtk1\"> </span><span class=\"mtk11\">WrapperDeployed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wrapper</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">21</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_getByteCode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">21</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_getByteCode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">26</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deployWrapper</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">26</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deployWrapper</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">39</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">computeAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">39</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">computeAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/proxy/WrappedfCashFactory.sol#L15\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/proxy/WrappedfCashFactory.sol#L15</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">wrapped</span><span class=\"mtk1\">-</span><span class=\"mtk12\">fcash</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">wfCashERC4626</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">18</span><span class=\"mtk1\">:           </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getCurrencyId</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">31</span><span class=\"mtk1\">:           (</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">getDecodedID</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">31</span><span class=\"mtk1\">:           (</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">getDecodedID</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">100</span><span class=\"mtk1\">:              (</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">getDecodedID</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">100</span><span class=\"mtk1\">:              (</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">getDecodedID</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">120</span><span class=\"mtk1\">:              (</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">getDecodedID</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">120</span><span class=\"mtk1\">:              (</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">getDecodedID</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">139</span><span class=\"mtk1\">:              (</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">getDecodedID</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">139</span><span class=\"mtk1\">:              (</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">getDecodedID</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">157</span><span class=\"mtk1\">:              (</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">getDecodedID</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">157</span><span class=\"mtk1\">:              (</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">getDecodedID</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">243</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_safeNegInt88</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">x</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">int88</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L18\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L18</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">wrapped</span><span class=\"mtk1\">-</span><span class=\"mtk12\">fcash</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">wfCashLogic</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">29</span><span class=\"mtk1\">:           </span><span class=\"mtk12\">uint88</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fCashAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">31</span><span class=\"mtk1\">:           </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minImpliedRate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">43</span><span class=\"mtk1\">:           </span><span class=\"mtk12\">uint88</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fCashAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">45</span><span class=\"mtk1\">:           </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minImpliedRate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">52</span><span class=\"mtk1\">:           </span><span class=\"mtk12\">uint88</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fCashAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">54</span><span class=\"mtk1\">:           </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minImpliedRate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">169</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxImpliedRate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">187</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxImpliedRate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">222</span><span class=\"mtk1\">:              </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getCurrencyId</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">261</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">263</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">uint88</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assetInternalCashClaim</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">279</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxImpliedRate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">315</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_safeUint88</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">x</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint88</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashLogic.sol#L29\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashLogic.sol#L29</a></p>\n<h2 id=\"15-abiencode-is-less-efficient-than-abiencodepacked\" style=\"position:relative;\"><a href=\"#15-abiencode-is-less-efficient-than-abiencodepacked\" aria-label=\"15 abiencode is less efficient than abiencodepacked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[15] <code>abi.encode()</code> is less efficient than <code>abi.encodePacked()</code></h2>\n<p><em>There are 3 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">wrapped</span><span class=\"mtk1\">-</span><span class=\"mtk12\">fcash</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxy</span><span class=\"mtk1\">/</span><span class=\"mtk12\">WrappedfCashFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">23</span><span class=\"mtk1\">:           </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nBeaconProxy</span><span class=\"mtk1\">).</span><span class=\"mtk12\">creationCode</span><span class=\"mtk1\">, </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">BEACON</span><span class=\"mtk1\">, </span><span class=\"mtk12\">initCallData</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/proxy/WrappedfCashFactory.sol#L23\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/proxy/WrappedfCashFactory.sol#L23</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">wrapped</span><span class=\"mtk1\">-</span><span class=\"mtk12\">fcash</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">wfCashERC4626</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">230</span><span class=\"mtk1\">           </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userData</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">231</span><span class=\"mtk1\">               </span><span class=\"mtk11\">RedeemOpts</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">232</span><span class=\"mtk12\">                   redeemToUnderlying:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">233</span><span class=\"mtk12\">                   transferfCash:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">234</span><span class=\"mtk12\">                   receiver:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">235</span><span class=\"mtk12\">                   maxImpliedRate:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">236</span><span class=\"mtk1\">               })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">237</span><span class=\"mtk1\">:          );</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L230-L237\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L230-L237</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">wrapped</span><span class=\"mtk1\">-</span><span class=\"mtk12\">fcash</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">wfCashLogic</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">159</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">opts</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashLogic.sol#L159\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashLogic.sol#L159</a></p>\n<h2 id=\"16-using-private-rather-than-public-for-constants-saves-gas\" style=\"position:relative;\"><a href=\"#16-using-private-rather-than-public-for-constants-saves-gas\" aria-label=\"16 using private rather than public for constants saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[16] Using <code>private</code> rather than <code>public</code> for constants, saves gas</h2>\n<p>If needed, the value can be read from the verified contract source code. Savings are due to the compiler not having to create non-payable getter functions for deployment calldata, and not adding another entry to the method ID table</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">wrapped</span><span class=\"mtk1\">-</span><span class=\"mtk12\">fcash</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxy</span><span class=\"mtk1\">/</span><span class=\"mtk12\">WrappedfCashFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">12</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">SALT</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/proxy/WrappedfCashFactory.sol#L12\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/proxy/WrappedfCashFactory.sol#L12</a></p>\n<h2 id=\"17-use-custom-errors-rather-than-revertrequire-strings-to-save-gas\" style=\"position:relative;\"><a href=\"#17-use-custom-errors-rather-than-revertrequire-strings-to-save-gas\" aria-label=\"17 use custom errors rather than revertrequire strings to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[17] Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</h2>\n<p>Custom errors are available from solidity version 0.8.4. Custom errors save <a href=\"https://gist.github.com/IllIllI000/ad1bd0d29a0101b25e57c293b4b0c746\"><strong>~50 gas</strong></a> each time they’re hitby <a href=\"https://blog.soliditylang.org/2021/04/21/custom-errors/#errors-in-depth\">avoiding having to allocate and store the revert string</a>. Not defining the strings also save deployment gas</p>\n<p><em>There are 17 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">index</span><span class=\"mtk1\">-</span><span class=\"mtk12\">coop</span><span class=\"mtk1\">-</span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">trade</span><span class=\"mtk1\">-</span><span class=\"mtk10\">module</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">protocol</span><span class=\"mtk1\">/</span><span class=\"mtk12\">modules</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NotionalTradeModule</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">169</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isComponent</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_sendToken</span><span class=\"mtk1\">)), </span><span class=\"mtk8\">&quot;Send token must be an index component&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">199</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isComponent</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wrappedfCash</span><span class=\"mtk1\">)), </span><span class=\"mtk8\">&quot;FCash to redeem must be an index component&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">227</span><span class=\"mtk1\">:              </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">allowedSetTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">], </span><span class=\"mtk8\">&quot;Not allowed SetToken&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">234</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isInitializedModule</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getAndValidateAdapter</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DEFAULT_ISSUANCE_MODULE_NAME</span><span class=\"mtk1\">)), </span><span class=\"mtk8\">&quot;Issuance not initialized&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">269</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isInitializedModule</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_debtIssuanceModule</span><span class=\"mtk1\">)), </span><span class=\"mtk8\">&quot;Issuance not initialized&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">280</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isSet</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">)) || </span><span class=\"mtk12\">allowedSetTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">], </span><span class=\"mtk8\">&quot;Invalid SetToken&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">378</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wrappedfCashAddress</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isContract</span><span class=\"mtk1\">(), </span><span class=\"mtk8\">&quot;WrappedfCash not deployed for given parameters&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">449</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sentAmount</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">_maxSendAmount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Overspent&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">485</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receivedAmount</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">_minReceiveAmount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Not enough received amount&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">573</span><span class=\"mtk1\">:              </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_paymentToken</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">assetToken</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Token is neither asset nor underlying token&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L169\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L169</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"64\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">wrapped</span><span class=\"mtk1\">-</span><span class=\"mtk12\">fcash</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">wfCashBase</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">37</span><span class=\"mtk1\">:           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">cashGroup</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maxMarketIndex</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid currency&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">40</span><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">41</span><span class=\"mtk1\">                </span><span class=\"mtk12\">DateTime</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isValidMaturity</span><span class=\"mtk1\">(</span><span class=\"mtk12\">cashGroup</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maxMarketIndex</span><span class=\"mtk1\">, </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">42</span><span class=\"mtk1\">                </span><span class=\"mtk8\">&quot;Invalid maturity&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">43</span><span class=\"mtk1\">:           );</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashBase.sol#L37\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashBase.sol#L37</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"65\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">wrapped</span><span class=\"mtk1\">-</span><span class=\"mtk12\">fcash</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">wfCashERC4626</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">23</span><span class=\"mtk1\">:           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">underlyingExternal</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Must Settle&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L23\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L23</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"66\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">wrapped</span><span class=\"mtk1\">-</span><span class=\"mtk12\">fcash</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">wfCashLogic</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">57</span><span class=\"mtk1\">:           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(!</span><span class=\"mtk11\">hasMatured</span><span class=\"mtk1\">(), </span><span class=\"mtk8\">&quot;fCash matured&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">116</span><span class=\"mtk1\">           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">117</span><span class=\"mtk1\">               </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">NotionalV2</span><span class=\"mtk1\">) &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">118</span><span class=\"mtk1\">               </span><span class=\"mtk3\">// Only accept the fcash id that corresponds to the listed currency and maturity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">119</span><span class=\"mtk1\">               </span><span class=\"mtk12\">_id</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">fCashID</span><span class=\"mtk1\"> &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">120</span><span class=\"mtk1\">               </span><span class=\"mtk3\">// Protect against signed value underflows</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">121</span><span class=\"mtk1\">               </span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_value</span><span class=\"mtk1\">) &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">122</span><span class=\"mtk1\">               </span><span class=\"mtk8\">&quot;Invalid&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">123</span><span class=\"mtk1\">:          );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">211</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">opts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">receiver</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Receiver is zero address&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">225</span><span class=\"mtk1\">:              </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">cashBalance</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Negative Cash Balance&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashLogic.sol#L57\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashLogic.sol#L57</a></p>\n<h2 id=\"18-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" style=\"position:relative;\"><a href=\"#18-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" aria-label=\"18 functions guaranteed to revert when called by normal users can be marked payable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[18] Functions guaranteed to revert when called by normal users can be marked <code>payable</code></h2>\n<p>If a function modifier such as <code>onlyOwner</code> is used, the function will revert if a normal user tries to pay the function. Marking the function as <code>payable</code> will lower the gas cost for legitimate callers because the compiler will not include checks for whether a payment was provided. The extra opcodes avoided are\n<code>CALLVALUE</code>(2),<code>DUP1</code>(3),<code>ISZERO</code>(3),<code>PUSH2</code>(3),<code>JUMPI</code>(10),<code>PUSH1</code>(3),<code>DUP1</code>(3),<code>REVERT</code>(0),<code>JUMPDEST</code>(1),<code>POP</code>(2), which costs an average of about <strong>21 gas per call</strong> to the function, in addition to the extra deployment cost</p>\n<p><em>There are 14 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"67\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">index</span><span class=\"mtk1\">-</span><span class=\"mtk12\">coop</span><span class=\"mtk1\">-</span><span class=\"mtk12\">notional</span><span class=\"mtk1\">-</span><span class=\"mtk12\">trade</span><span class=\"mtk1\">-</span><span class=\"mtk10\">module</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">protocol</span><span class=\"mtk1\">/</span><span class=\"mtk12\">modules</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NotionalTradeModule</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">156</span><span class=\"mtk1\">       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mintFCashPosition</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">157           </span><span class=\"mtk12\">ISetToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">158           </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currencyId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">159           </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maturity</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">160           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_mintAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">161           </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_sendToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">162           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxSendAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">163       )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">164           </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">165           </span><span class=\"mtk11\">nonReentrant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">166           </span><span class=\"mtk11\">onlyManagerAndValidSet</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">167:          </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">185       </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">redeemFCashPosition</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">186           </span><span class=\"mtk12\">ISetToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">187           </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currencyId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">188           </span><span class=\"mtk12\">uint40</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maturity</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">189           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_redeemAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">190           </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_receiveToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">191           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_minReceiveAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">192       )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">193           </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">194           </span><span class=\"mtk11\">nonReentrant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">195           </span><span class=\"mtk11\">onlyManagerAndValidSet</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">196:          </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">210:      </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">redeemMaturedPositions</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ISetToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyValidAndInitializedSet</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">219</span><span class=\"mtk1\">       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">220           </span><span class=\"mtk12\">ISetToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_setToken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">221       )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">222           </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">223           </span><span class=\"mtk11\">onlySetManager</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">, msg.sender)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">224:          </span><span class=\"mtk11\">onlyValidAndPendingSet</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">219       </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">220           </span><span class=\"mtk12\">ISetToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_setToken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">221       )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">222           </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">223           </span><span class=\"mtk11\">onlySetManager</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">, msg.sender)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">224:          </span><span class=\"mtk11\">onlyValidAndPendingSet</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">246:      </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">removeModule</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyValidAndInitializedSet</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ISetToken</span><span class=\"mtk1\">(msg.sender)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">268</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">registerToModule</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ISetToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">IDebtIssuanceModule</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_debtIssuanceModule</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyManagerAndValidSet</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">279</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">updateAllowedSetToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ISetToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_status</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">289</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">updateAnySetAllowed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_anySetAllowed</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">294</span><span class=\"mtk1\">       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setRedeemToUnderlying</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">295           </span><span class=\"mtk12\">ISetToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">296           </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_toUnderlying</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">297       )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">298       </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">299:      </span><span class=\"mtk11\">onlyManagerAndValidSet</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">309:      </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">moduleIssueHook</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ISetToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk3\">/* _setTokenAmount */</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyModule</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">317</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">moduleRedeemHook</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ISetToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk3\">/* _setTokenAmount */</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyModule</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">326</span><span class=\"mtk1\">       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">componentIssueHook</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">327           </span><span class=\"mtk12\">ISetToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">328           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_setTokenAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">329           </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_component</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">330           </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_isEquity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">331:      ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyModule</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">338</span><span class=\"mtk1\">       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">componentRedeemHook</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">339           </span><span class=\"mtk12\">ISetToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">340           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_setTokenAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">341           </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_component</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">342           </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_isEquity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">343:      ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyModule</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_setToken</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L156-L167\">https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L156-L167</a></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-notional-coop-findings/issues/111#issuecomment-1157589271\">jeffywu (Notional) commented</a>:</strong></p>\n<blockquote>\n<p>Well organized report</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-1\">High Risk Findings (1)</a></p>\n<ul>\n<li><a href=\"#h-01-rounding-issues-in-certain-functions\">[H-01] Rounding Issues In Certain Functions</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-10\">Medium Risk Findings (10)</a></p>\n<ul>\n<li><a href=\"#m-01-fcash-of-the-wrong-maturity-and-asset-can-be-sent-to-wrapper-address-before-wrapper-is-deployed-\">[M-01] fCash of the wrong maturity and asset can be sent to wrapper address before wrapper is deployed </a></li>\n<li><a href=\"#m-02-deposit-and-mint-and-_redeeminternal-in-wfcasherc4626-will-revert-for-all-fcash-that-asset-token-is-underlying-token-because-they-always-call-_mintinternal-with-useunderlyingtrue\">[M-02] deposit() and mint() and _redeemInternal() in wfCashERC4626() will revert for all fcash that asset token is underlying token because they always call _mintInternal() with useUnderlying==True</a></li>\n<li><a href=\"#m-03-the-logic-of-_isunderlying-in-notionaltrademodule-is-wrong-which-will-cause-mintfcashposition-and-redeemfcashposition-revert-on-fcash-tokens-which-asset-token-is-underlying-token-assettokentype--tokentypenonmintable\">[M-03] The logic of _isUnderlying() in NotionalTradeModule is wrong which will cause mintFCashPosition() and redeemFCashPosition() revert on <code>fcash</code> tokens which asset token is underlying token (asset.tokenType == TokenType.NonMintable)</a></li>\n<li><a href=\"#m-04-iswrappedfcash-check-is-a-gas-bomb\">[M-04] <code>IsWrappedFcash</code> check is a gas bomb</a></li>\n<li><a href=\"#m-05-transferfcash-does-not-work-as-expected\">[M-05] transferfCash does not work as expected</a></li>\n<li><a href=\"#m-06-users-might-not-be-able-to-purchase-or-redeem-settoken\">[M-06] Users Might Not Be Able To Purchase Or Redeem SetToken</a></li>\n<li><a href=\"#m-07-residual-allowance-might-allow-tokens-in-settoken-to-be-stolen\">[M-07] Residual Allowance Might Allow Tokens In SetToken To Be Stolen</a></li>\n<li><a href=\"#m-08-dos-set-token-through-erc777-hook\">[M-08] DOS set token through erc777 hook</a></li>\n<li><a href=\"#m-09-silent-overflow-of-_fcashamount\">[M-09] Silent overflow of <code>_fCashAmount</code></a></li>\n<li><a href=\"#m-10-user-can-alter-amount-returned-by-redeem-function-due-to-control-transfer\">[M-10] User can alter amount returned by redeem function due to control transfer</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#codebase-impressions--summary\">Codebase Impressions &#x26; Summary</a></li>\n<li><a href=\"#table-of-contents\">Table of Contents</a></li>\n<li><a href=\"#l-01-zero-address-checks-are-missing\">L-01 Zero-address checks are missing</a></li>\n<li><a href=\"#l-02-use-of-floating-pragma\">L-02 Use of floating pragma</a></li>\n<li><a href=\"#l-03-events-not-emitted-for-important-state-changes\">L-03 Events not emitted for important state changes</a></li>\n<li><a href=\"#l-04-matured-fcash-positions-not-automatically-redeemed-in-notionaltrademoduleinitialize\">L-04 Matured fCash positions not automatically redeemed in <code>NotionalTradeModule.initialize</code></a></li>\n<li><a href=\"#l-05-misleading-notionaltrademodule_mintfcashposition-function-comments\">L-05 Misleading <code>NotionalTradeModule._mintFCashPosition</code> function comments</a></li>\n<li><a href=\"#l-06-misleading-comment-in-wfcashlogic_burn-function\">L-06 Misleading comment in <code>wfCashLogic._burn</code> function</a></li>\n<li><a href=\"#l-07-matured-fcash-can-still-be-wrapped-via-erc1155-transfer\">L-07 Matured fCash can still be wrapped via <code>ERC1155</code> <code>transfer</code></a></li>\n<li><a href=\"#l-08-contracts-are-using-outdated-openzeppelin-version-342-solc-07\">L-08 Contracts are using outdated OpenZeppelin version <code>^3.4.2-solc-0.7</code></a></li>\n<li><a href=\"#l-09-wfcasherc4626-contract-does-not-conform-to-eip4626\">L-09 <code>wfCashERC4626</code> contract does not conform to <code>EIP4626</code></a></li>\n<li><a href=\"#n-01-use-the-iseth-return-value-from-wfcashbasegettoken-instead-of-checking-equality-with-eth_address\">N-01 Use the <code>isETH</code> return value from <code>wfCashBase.getToken</code> instead of checking equality with <code>ETH_ADDRESS</code></a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#1-avoid-contract-existence-checks-by-using-solidity-version-0810-or-later\">1 Avoid contract existence checks by using solidity version 0.8.10 or later</a></li>\n<li><a href=\"#2-multiple-accesses-of-a-mappingarray-should-use-a-local-variable-cache\">2 Multiple accesses of a mapping/array should use a local variable cache</a></li>\n<li><a href=\"#3-internal-functions-only-called-once-can-be-inlined-to-save-gas\">3 <code>internal</code> functions only called once can be inlined to save gas</a></li>\n<li><a href=\"#4-arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\">4 <code>&#x3C;array>.length</code> should not be looked up in every loop of a <code>for</code>-loop</a></li>\n<li><a href=\"#5-requirerevert-strings-longer-than-32-bytes-cost-extra-gas\">5 <code>require()</code>/<code>revert()</code> strings longer than 32 bytes cost extra gas</a></li>\n<li><a href=\"#6-private-functions-not-called-by-the-contract-should-be-removed-to-save-deployment-gas\">6 <code>private</code> functions not called by the contract should be removed to save deployment gas</a></li>\n<li><a href=\"#7-optimize-names-to-save-gas\">7 Optimize names to save gas</a></li>\n<li><a href=\"#8-using-bools-for-storage-incurs-overhead\">8 Using <code>bool</code>s for storage incurs overhead</a></li>\n<li><a href=\"#9-use-a-more-recent-version-of-solidity\">9 Use a more recent version of solidity</a></li>\n<li><a href=\"#10-use-a-more-recent-version-of-solidity\">10 Use a more recent version of solidity</a></li>\n<li><a href=\"#11-it-costs-more-gas-to-initialize-non-constantnon-immutable-variables-to-zero-than-to-let-the-default-of-zero-be-applied\">11 It costs more gas to initialize non-<code>constant</code>/non-<code>immutable</code> variables to zero than to let the default of zero be applied</a></li>\n<li><a href=\"#12-i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\">12 <code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</a></li>\n<li><a href=\"#13-splitting-require-statements-that-use--saves-gas\">13 Splitting <code>require()</code> statements that use <code>&#x26;&#x26;</code> saves gas</a></li>\n<li><a href=\"#14-usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\">14 Usage of <code>uints</code>/<code>ints</code> smaller than 32 bytes (256 bits) incurs overhead</a></li>\n<li><a href=\"#15-abiencode-is-less-efficient-than-abiencodepacked\">15 <code>abi.encode()</code> is less efficient than <code>abi.encodePacked()</code></a></li>\n<li><a href=\"#16-using-private-rather-than-public-for-constants-saves-gas\">16 Using <code>private</code> rather than <code>public</code> for constants, saves gas</a></li>\n<li><a href=\"#17-use-custom-errors-rather-than-revertrequire-strings-to-save-gas\">17 Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</a></li>\n<li><a href=\"#18-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\">18 Functions guaranteed to revert when called by normal users can be marked <code>payable</code></a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the audit contest outlined in this document, C4 conducted an analysis of the Notional x Index Coop smart contract system written in Solidity. The audit contest took place between June 7—June 14 2022.\n\n## Wardens\n\n81 Wardens contributed reports to the Notional x Index Coop:\n\n  1. [jonah1005](https://twitter.com/jonah1005w)\n  1. unforgiven\n  1. xiaoming90\n  1. [csanuragjain](https://twitter.com/csanuragjain)\n  1. 0xDjango\n  1. [berndartmueller](https://twitter.com/berndartmueller)\n  1. GreyArt ([hickuphh3](https://twitter.com/HickupH) and [itsmeSTYJ](https://twitter.com/itsmeSTYJ))\n  1. Meera\n  1. minhquanym\n  1. [kenzo](https://twitter.com/KenzoAgada)\n  1. 0x52\n  1. IllIllI\n  1. [antonttc](https://github.com/antoncoding)\n  1. GimelSec ([rayn](https://twitter.com/rayn731) and sces60107)\n  1. sorrynotsorry\n  1. [joestakey](https://twitter.com/JoeStakey)\n  1. 0xkatana\n  1. 0x29A (0x4non and rotcivegaf)\n  1. 0x1f8b\n  1. 0xf15ers (remora and twojoy)\n  1. [Funen](https://instagram.com/vanensurya)\n  1. [hyh](https://twitter.com/0xhyh)\n  1. [PierrickGT](https://twitter.com/PierrickGT)\n  1. [Chom](https://chom.dev)\n  1. delfin454000\n  1. Waze\n  1. [Picodes](https://twitter.com/thePicodes)\n  1. [Deivitto](https://twitter.com/Deivitto)\n  1. [fatherOfBlocks](https://twitter.com/father0fBl0cks)\n  1. [0xKitsune](https://github.com/0xKitsune)\n  1. [TomJ](https://mobile.twitter.com/tomj_bb)\n  1. TerrierLover\n  1. simon135\n  1. _Adam\n  1. slywaters\n  1. oyc_109\n  1. [ellahi](https://twitter.com/ellahinator)\n  1. saian\n  1. sach1r0\n  1. [catchup](https://twitter.com/catchup22)\n  1. [c3phas](https://twitter.com/c3ph_)\n  1. [Sm4rty](https://twitter.com/Sm4rty_)\n  1. Cityscape\n  1. [0xNazgul](https://twitter.com/0xNazgul)\n  1. hake\n  1. 0xmint\n  1. [Tadashi](https://github.com/htadashi)\n  1. Lambda\n  1. [hansfriese](https://twitter.com/hansfriese)\n  1. [Ruhum](https://twitter.com/0xruhum)\n  1. zzzitron\n  1. Trumpero\n  1. [sseefried](http://seanseefried.org/blog)\n  1. cloudjunky\n  1. cccz\n  1. [Bronicle](https://twitter.com/Cryptonicle1)\n  1. [Nethermind](https://nethermind.io/)\n  1. dipp\n  1. cryptphi\n  1. 0xNineDec\n  1. [z3s](https://github.com/z3s/)\n  1. [JC](https://twitter.com/sm4rtcontr4ct)\n  1. ayeslick\n  1. [Tomio](https://twitter.com/meidhiwirara)\n  1. [rfa](https://www.instagram.com/riyan_rfa/)\n  1. [8olidity](https://twitter.com/8olidity)\n  1. [0xSolus](https://twitter.com/0xSolus)\n  1. UnusualTurtle\n  1. asutorufos\n  1. samruna\n  1. [kaden](https://twitter.com/0xKaden)\n  1. ElKu\n  1. DavidGialdi\n  1. [0v3rf10w](https://twitter.com/_0v3rf10w)\n  1. [ynnad](https://twitter.com/ynnadt1)\n  1. [Fitraldys](https://twitter.com/fitraldys)\n  1. djxploit\n\nThis contest was judged by [gzeon](https://twitter.com/gzeon).\n\nFinal report assembled by [itsmetechjay](https://twitter.com/itsmetechjay).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 11 unique vulnerabilities. Of these vulnerabilities, 1 received a risk rating in the category of HIGH severity and 10 received a risk rating in the category of MEDIUM severity.\n\nAdditionally, C4 analysis included 61 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 55 reports recommending gas optimizations.\n\nAll of the issues presented here are linked back to their original finding.\n\n# Scope\n\nThe code under review can be found within the [C4 Notional x Index Coop repository](https://github.com/code-423n4/2022-06-notional-coop), and is composed of 5 smart contracts written in the Solidity programming language and includes 914 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code4rena.com).\n\n# High Risk Findings (1)\n## [[H-01] Rounding Issues In Certain Functions](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/155)\n_Submitted by xiaoming90, also found by berndartmueller, GreyArt, jonah1005, kenzo, and minhquanym_\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L52>\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L134>\n\n### Background\n\nPer EIP 4626's Security Considerations (<https://eips.ethereum.org/EIPS/eip-4626>)\n\n> Finally, ERC-4626 Vault implementers should be aware of the need for specific, opposing rounding directions across the different mutable and view methods, as it is considered most secure to favor the Vault itself during calculations over its users:\n>\n> *   If (1) it’s calculating how many shares to issue to a user for a certain amount of the underlying tokens they provide or (2) it’s determining the amount of the underlying tokens to transfer to them for returning a certain amount of shares, it should round *down*.\n> *   If (1) it’s calculating the amount of shares a user has to supply to receive a given amount of the underlying tokens or (2) it’s calculating the amount of underlying tokens a user has to provide to receive a certain amount of shares, it should round *up*.\n\nThus, the result of the `previewMint` and `previewWithdraw` should be rounded up.\n\n### Proof of Concept\n\nThe current implementation of `convertToShares` function will round down the number of shares returned due to how solidity handles Integer Division. ERC4626 expects the returned value of `convertToShares` to be rounded down. Thus, this function behaves as expected.\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L52>\n\n```solidity\nfunction convertToShares(uint256 assets) public view override returns (uint256 shares) {\n    uint256 supply = totalSupply();\n    if (supply == 0) {\n        // Scales assets by the value of a single unit of fCash\n        uint256 unitfCashValue = _getPresentValue(uint256(Constants.INTERNAL_TOKEN_PRECISION));\n        return (assets * uint256(Constants.INTERNAL_TOKEN_PRECISION)) / unitfCashValue;\n    }\n\n    return (assets * totalSupply()) / totalAssets();\n}\n```\n\nERC 4626 expects the result returned from `previewWithdraw` function to be rounded up. However, within the `previewWithdraw` function, it calls the `convertToShares` function. Recall earlier that the `convertToShares` function returned a rounded down value,  thus `previewWithdraw` will return a rounded down value instead of round up value. Thus, this function does not behave as expected.\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L134>\n\n```solidity\nfunction previewWithdraw(uint256 assets) public view override returns (uint256 shares) {\n    if (hasMatured()) {\n        shares = convertToShares(assets);\n    } else {\n        // If withdrawing non-matured assets, we sell them on the market (i.e. borrow)\n        (uint16 currencyId, uint40 maturity) = getDecodedID();\n        (shares, /* */, /* */) = NotionalV2.getfCashBorrowFromPrincipal(\n            currencyId,\n            assets,\n            maturity,\n            0,\n            block.timestamp,\n            true\n        );\n    }\n}\n```\n\n`previewWithdraw` and `previewMint` functions rely on `NotionalV2.getfCashBorrowFromPrincipal` and `NotionalV2.getDepositFromfCashLend` functions. Due to the nature of time-boxed contest, I was unable to verify if `NotionalV2.getfCashBorrowFromPrincipal` and `NotionalV2.getDepositFromfCashLend` functions return a rounded down or up value. If a rounded down value is returned from these functions, `previewWithdraw` and `previewMint` functions would not behave as expected.\n\n### Impact\n\nOther protocols that integrate with Notional's fCash wrapper might wrongly assume that the functions handle rounding as per ERC4626 expectation. Thus, it might cause some intergration problem in the future that can lead to wide range of issues for both parties.\n\n### Recommended Mitigation Steps\n\nEnsure that the rounding of vault's functions behave as expected. Following are the expected rounding direction for each vault function:\n\n*   previewMint(uint256 shares) - Round Up ⬆\n\n*   previewWithdraw(uint256 assets) - Round Up ⬆\n\n*   previewRedeem(uint256 shares) - Round Down ⬇\n\n*   previewDeposit(uint256 assets) - Round Down ⬇\n\n*   convertToAssets(uint256 shares) - Round Down ⬇\n\n*   convertToShares(uint256 assets) - Round Down ⬇\n\n`previewMint` returns the  amount of assets that would be deposited to mint specific amount of shares. Thus, the amount of assets must be rounded up, so that the vault won't be shortchanged.\n\n`previewWithdraw` returns the amount of shares that would be burned to withdraw specific amount of asset. Thus, the amount of shares must to be rounded up, so that the vault won't be shortchanged.\n\nFollowing is the OpenZeppelin's vault implementation for rounding reference:\n\n<https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/extensions/ERC20TokenizedVault.sol>\n\nAlternatively, if such alignment of rounding could not be achieved due to technical limitation, at the minimum, document this limitation in the comment so that the developer performing the integration is aware of this.\n\n**[jeffywu (Notional) confirmed](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/155)**\n\n**[gzeoneth (judge) increased severity to High and commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/155#issuecomment-1166534716):**\n> Judging this and all duplicate regarding EIP4626 implementation as High Risk. \n\n> EIP4626 is aimed to create a consistent and robust implementation patterns for Tokenized Vaults. A slight deviation from 4626 would broke composability and potentially lead to loss of fund (POC in https://github.com/code-423n4/2022-06-notional-coop-findings/issues/88 can be an example). It is counterproductive to implement EIP4626 but does not conform to it fully. Especially it does seem that most of the time `deposit` would be successful but not `withdraw`, making it even more dangerous when an immutable consumer application mistakenly used the wfcash contract.\n\n\n\n***\n\n \n# Medium Risk Findings (10)\n## [[M-01] fCash of the wrong maturity and asset can be sent to wrapper address before wrapper is deployed ](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/115)\n_Submitted by 0x52, also found by jonah1005 and unforgiven_\n\nMinting becomes impossible\n\n### Proof of Concept\n\nonERC1155Received is only called when the size of the code deployed at the address contains code. Since create2 is used to deploy the contract, the address can be calculated before the contract is deployed. A malicious actor could send the address fCash of a different maturity or asset before the contract is deployed and since nothing has been deployed, onERC1155Received will not be called and the address will accept the fCash. After the contract is deployed and correct fCash is sent to the address, onERC1155Received will check the length of the assets held by the address and it will be more than 1 (fCash of correct asset and maturity and fCash with wrong maturity or asset sent before deployment). This will cause the contract to always revert essentially breaking the mint completely.\n\n### Recommended Mitigation Steps\n\nWhen the contract is created create a function that reads how many fCash assets are at the address and send them away if they aren't of the correct asset and maturity\n\n**[jeffywu (Notional) confirmed, but disagreed with severity and commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/115#issuecomment-1156413858):**\n > I will need to write a PoC to confirm that this is the case but it seems plausible to me.\n\n > Based on the Judging Criteria, this does not result in loss of funds. This will result in a loss of availability (available funds actually increase).\n> \n> My opinion is medium severity.\n> \n\n**[gzeoneth (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/115#issuecomment-1166516282):**\n > Judging this as Med Risk due to no loss of funds and only possible before contract deployment.\n\n\n\n***\n\n## [[M-02] deposit() and mint() and _redeemInternal() in wfCashERC4626() will revert for all fcash that asset token is underlying token because they always call _mintInternal() with useUnderlying==True](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/82)\n_Submitted by unforgiven_\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L177-L184>\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L168-L175>\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L225-L241>\n\n### Impact\n\nFor some `fcash` the asset token is underlying token (`asset.tokenType == TokenType.NonMintable`) and `NotionalV2` will not handle minting with `useUnderlying==True` for those `fcash`s (according to what I asked from sponsor). In summery most of the logics in `wfCashERC4626` will not work for those `fcash` tokens.\n\nwhen for some `fcash` asset token is underlying token, all calls to `NotionalV2` should be with `useUnderlying==False`. but `deposit()` and `mint()` in `wfCashERC4626` contract call `_mintInternal()` with `useUnderlying==True` and it calls `NotionalV2.batchLend()` with `depositUnderlying==true` so the `NotionV2` call will fail for `fcash` tokens that asset token is underlying token and it would cause  that `deposit()` and `mint()`  logic `wfCashERC4626`  will not work and contract will be useless for those tokens.\n`_redeemInternal()` issue is similar and it calls `_burn()` with `redeemToUnderlying: true` which execution eventually calls `NotionalV2.batchBalanceAndTradeAction()` with `toUnderlying=True` which will revert so `_redeemInternal()` will fail and because `withdraw()` and `redeem` use it, so they will not work too for those `fcash` tokens that asset token is underlying token.\n\n### Proof of Concept\n\nThis is `deposit()` and `mint()`  code in `wfCashERC4626`:\n\n        /** @dev See {IERC4626-deposit} */\n        function deposit(uint256 assets, address receiver) public override returns (uint256) {\n            uint256 shares = previewDeposit(assets);\n            // Will revert if matured\n            _mintInternal(assets, _safeUint88(shares), receiver, 0, true);\n            emit Deposit(msg.sender, receiver, assets, shares);\n            return shares;\n        }\n\n        /** @dev See {IERC4626-mint} */\n        function mint(uint256 shares, address receiver) public override returns (uint256) {\n            uint256 assets = previewMint(shares);\n            // Will revert if matured\n            _mintInternal(assets, _safeUint88(shares), receiver, 0, true);\n            emit Deposit(msg.sender, receiver, assets, shares);\n            return assets;\n        }\n\nAs you can see they both call `_mintInternal()` with last parameter as `true` which is `useUnderlying`'s value. This is `_mintInternal()` code:\n\n        function _mintInternal(\n            uint256 depositAmountExternal,\n            uint88 fCashAmount,\n            address receiver,\n            uint32 minImpliedRate,\n            bool useUnderlying\n        ) internal nonReentrant {\n            require(!hasMatured(), \"fCash matured\");\n            (IERC20 token, bool isETH) = getToken(useUnderlying);\n            uint256 balanceBefore = isETH ? address(this).balance : token.balanceOf(address(this));\n\n            // If dealing in ETH, we use WETH in the wrapper instead of ETH. NotionalV2 uses\n            // ETH natively but due to pull payment requirements for batchLend, it does not support\n            // ETH. batchLend only supports ERC20 tokens like cETH or aETH. Since the wrapper is a compatibility\n            // layer, it will support WETH so integrators can deal solely in ERC20 tokens. Instead of using\n            // \"batchLend\" we will use \"batchBalanceActionWithTrades\". The difference is that \"batchLend\"\n            // is more gas efficient (does not require and additional redeem call to asset tokens). If using cETH\n            // then everything will proceed via batchLend.\n            if (isETH) {\n                IERC20((address(WETH))).safeTransferFrom(msg.sender, address(this), depositAmountExternal);\n                WETH.withdraw(depositAmountExternal);\n\n                BalanceActionWithTrades[] memory action = EncodeDecode.encodeLendETHTrade(\n                    getCurrencyId(),\n                    getMarketIndex(),\n                    depositAmountExternal,\n                    fCashAmount,\n                    minImpliedRate\n                );\n                // Notional will return any residual ETH as the native token. When we _sendTokensToReceiver those\n                // native ETH tokens will be wrapped back to WETH.\n                NotionalV2.batchBalanceAndTradeAction{value: depositAmountExternal}(address(this), action);\n            } else {\n                // Transfers tokens in for lending, Notional will transfer from this contract.\n                token.safeTransferFrom(msg.sender, address(this), depositAmountExternal);\n\n                // Executes a lending action on Notional\n                BatchLend[] memory action = EncodeDecode.encodeLendTrade(\n                    getCurrencyId(),\n                    getMarketIndex(),\n                    fCashAmount,\n                    minImpliedRate,\n                    useUnderlying\n                );\n                NotionalV2.batchLend(address(this), action);\n            }\n\n            // Mints ERC20 tokens for the receiver, the false flag denotes that we will not do an\n            // operatorAck\n            _mint(receiver, fCashAmount, \"\", \"\", false);\n\n            _sendTokensToReceiver(token, msg.sender, isETH, balanceBefore);\n        }\n\nAs you can see it calls `NotionalV2` functions with `useUnderlying=True` but according to sponsor clarification `NotionalV2` would fail and revert for those calls because `useUnderlying=True` and `fcash`'s asset token is underlying token (`asset.tokenType == TokenType.NonMintable`).\nSo in summery for `fcash` tokens which asset token is underlying token `NotionalV2` won't handle calls which include `useUnderlying==True` but in `wfCashERC4626` contract functions like `deposit()`, `mint()`, `withdraw()` and `redeem()` they all uses `useUnderlying==True` always so `wfCashERC4626` won't work for those specific type of tokens which asset token is underlying token(`asset.tokenType == TokenType.NonMintable`)\n\nthe detail explanations for functions `withdraw()` and `redeem()` are similar.\n\n### Tools Used\n\nVIM\n\n### Recommended Mitigation Steps\n\nCheck that if for that `fcash` token asset token  is underlying token or not and set `useUnderlying` based on that.\n\n**[jeffywu (Notional) confirmed](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/82#issuecomment-1156418524)**\n\n**[gzeoneth (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/82#issuecomment-1166520574):**\n > There doesn't seems to be loss of fund as `deposit` and `mint` would revert. Judging as Med Risk.\n\n\n\n***\n\n## [[M-03] The logic of _isUnderlying() in NotionalTradeModule is wrong which will cause mintFCashPosition() and redeemFCashPosition() revert on `fcash` tokens which asset token is underlying token (asset.tokenType == TokenType.NonMintable)](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/87)\n_Submitted by unforgiven_\n\nFor some `fcash` the asset token is underlying token (`asset.tokenType == TokenType.NonMintable`) and `NotionalV2` will not handle minting or burning when it is called with `useUnderlying==True` for those `fcash`s (according to what I asked from sponsor). In summery most of the logics in ` NotionalTradeModule  ` will not work for those `fcash` tokens because `_isUnderlying()` returns `true` result for those tokens which would make `NotionalTradeModule`'s logic for `mintFCashPosition()` and `redeemFCashPosition()` will eventually call `redeemToUnderlying()` and `mintViaUnderlying()` in `wfCashLogic` and those function in `wfCashLogic` will call `NotionalV2` with `useUnderlying==True` and `NotionalV2` will fail and revert for `fcash` tokens which asset token is underlying token, so the whole transaction will fail and `_mintFCashPosition()` and `_redeemFCashPosition()`  logic in ` NotionalTradeModule  ` will not work for those `fcash` tokens and manager can't add them to `set` protocol.\n\n### Proof of Concept\n\nwhen for some `fcash` asset token is underlying token, all calls to `NotionalV2` should be with `useUnderlying==False`. but `_isUnderlying()` in `NotionalTradeModule` contract first check that `isUnderlying = _paymentToken == underlyingToken` so for `fcash` tokens where asset token is underlying token it is going to return `isUnderlying==True`. let's assume that for some specific `fcash` asset token is underlying token (`asset.tokenType == TokenType.NonMintable`) and follow the code execution.\nThis is `_isUnderlying()` code in `NotionalTradeModule`:\n\n        function _isUnderlying(\n            IWrappedfCashComplete _fCashPosition,\n            IERC20 _paymentToken\n        )\n        internal\n        view\n        returns(bool isUnderlying)\n        {\n            (IERC20 underlyingToken, IERC20 assetToken) = _getUnderlyingAndAssetTokens(_fCashPosition);\n            isUnderlying = _paymentToken == underlyingToken;\n            if(!isUnderlying) {\n                require(_paymentToken == assetToken, \"Token is neither asset nor underlying token\");\n            }\n        }\n\nAs you can see it calls `_getUnderlyingAndAssetTokens()` and then check `_paymentToken == underlyingToken` to see that if payment token is equal to `underlyingToken`. `_getUnderlyingAndAssetTokens()` uses `getUnderlyingToken()` and `getAssetToken()` in `wfCashBase`. This is `getUnderlyingToken()` code in `wfCashBase`:\n\n        /// @notice Returns the token and precision of the token that this token settles\n        /// to. For example, fUSDC will return the USDC token address and 1e6. The zero\n        /// address will represent ETH.\n        function getUnderlyingToken() public view override returns (IERC20 underlyingToken, int256 underlyingPrecision) {\n            (Token memory asset, Token memory underlying) = NotionalV2.getCurrency(getCurrencyId());\n\n            if (asset.tokenType == TokenType.NonMintable) {\n                // In this case the asset token is the underlying\n                return (IERC20(asset.tokenAddress), asset.decimals);\n            } else {\n                return (IERC20(underlying.tokenAddress), underlying.decimals);\n            }\n        }\n\nAs you can see for our specific `fcash` token this function will return asset token as underlying token. so for this specific `fcash` token, the asset token and underlying token will be same in `_isUnderlying()` of `NationalTradeModule` but because code first check `isUnderlying = _paymentToken == underlyingToken` so the function will return `isUnderlying=True` as a result for our specific `fcash` token (which asset token is underlying token)\nThis is `_mintFCashPosition()` and `_redeemFCashPosition()` code in ` NotionalTradeModule  `:\n\n        /**\n         * @dev Redeem a given fCash position from the specified send token (either underlying or asset token)\n         * @dev Alo adjust the components / position of the set token accordingly\n         */\n        function _mintFCashPosition(\n            ISetToken _setToken,\n            IWrappedfCashComplete _fCashPosition,\n            IERC20 _sendToken,\n            uint256 _fCashAmount,\n            uint256 _maxSendAmount\n        )\n        internal\n        returns(uint256 sentAmount)\n        {\n            if(_fCashAmount == 0) return 0;\n\n            bool fromUnderlying = _isUnderlying(_fCashPosition, _sendToken);\n\n\n            _approve(_setToken, _fCashPosition, _sendToken, _maxSendAmount);\n\n            uint256 preTradeSendTokenBalance = _sendToken.balanceOf(address(_setToken));\n            uint256 preTradeReceiveTokenBalance = _fCashPosition.balanceOf(address(_setToken));\n\n            _mint(_setToken, _fCashPosition, _maxSendAmount, _fCashAmount, fromUnderlying);\n\n\n            (sentAmount,) = _updateSetTokenPositions(\n                _setToken,\n                address(_sendToken),\n                preTradeSendTokenBalance,\n                address(_fCashPosition),\n                preTradeReceiveTokenBalance\n            );\n\n            require(sentAmount <= _maxSendAmount, \"Overspent\");\n            emit FCashMinted(_setToken, _fCashPosition, _sendToken, _fCashAmount, sentAmount);\n        }\n\n        /**\n         * @dev Redeem a given fCash position for the specified receive token (either underlying or asset token)\n         * @dev Alo adjust the components / position of the set token accordingly\n         */\n        function _redeemFCashPosition(\n            ISetToken _setToken,\n            IWrappedfCashComplete _fCashPosition,\n            IERC20 _receiveToken,\n            uint256 _fCashAmount,\n            uint256 _minReceiveAmount\n        )\n        internal\n        returns(uint256 receivedAmount)\n        {\n            if(_fCashAmount == 0) return 0;\n\n            bool toUnderlying = _isUnderlying(_fCashPosition, _receiveToken);\n            uint256 preTradeReceiveTokenBalance = _receiveToken.balanceOf(address(_setToken));\n            uint256 preTradeSendTokenBalance = _fCashPosition.balanceOf(address(_setToken));\n\n            _redeem(_setToken, _fCashPosition, _fCashAmount, toUnderlying);\n\n\n            (, receivedAmount) = _updateSetTokenPositions(\n                _setToken,\n                address(_fCashPosition),\n                preTradeSendTokenBalance,\n                address(_receiveToken),\n                preTradeReceiveTokenBalance\n            );\n\n\n            require(receivedAmount >= _minReceiveAmount, \"Not enough received amount\");\n            emit FCashRedeemed(_setToken, _fCashPosition, _receiveToken, _fCashAmount, receivedAmount);\n\n        }\n\nAs you can see they both uses `_isUnderlying()` to find out that if `_sendToken` is asset token or underlying token. for our specific `fcash` token, the result of `_isUnderlying()` will be `True` and `_mintFCashPosition()` and `_redeemFCashPosition()`  will call `_mint()` and `_redeem()` with `toUnderlying` set as `True`. This is `_mint()` and `_redeem()` code:\n\n        /**\n         * @dev Invokes the wrappedFCash token's mint function from the setToken\n         */\n        function _mint(\n            ISetToken _setToken,\n            IWrappedfCashComplete _fCashPosition,\n            uint256 _maxAssetAmount,\n            uint256 _fCashAmount,\n            bool _fromUnderlying\n        )\n        internal\n        {\n            uint32 minImpliedRate = 0;\n\n            bytes4 functionSelector = \n                _fromUnderlying ? _fCashPosition.mintViaUnderlying.selector : _fCashPosition.mintViaAsset.selector;\n            bytes memory mintCallData = abi.encodeWithSelector(\n                functionSelector,\n                _maxAssetAmount,\n                uint88(_fCashAmount),\n                address(_setToken),\n                minImpliedRate,\n                _fromUnderlying\n            );\n            _setToken.invoke(address(_fCashPosition), 0, mintCallData);\n        }\n\n        /**\n         * @dev Redeems the given amount of fCash token on behalf of the setToken\n         */\n        function _redeem(\n            ISetToken _setToken,\n            IWrappedfCashComplete _fCashPosition,\n            uint256 _fCashAmount,\n            bool _toUnderlying\n        )\n        internal\n        {\n            uint32 maxImpliedRate = type(uint32).max;\n\n            bytes4 functionSelector =\n                _toUnderlying ? _fCashPosition.redeemToUnderlying.selector : _fCashPosition.redeemToAsset.selector;\n            bytes memory redeemCallData = abi.encodeWithSelector(\n                functionSelector,\n                _fCashAmount,\n                address(_setToken),\n                maxImpliedRate\n            );\n            _setToken.invoke(address(_fCashPosition), 0, redeemCallData);\n        }\n\nAs you can see they are using `_toUnderlying` value to decide calling between (`mintViaUnderlying()` or `mintViaAsset()`) and (`redeemToUnderlying()` or `redeemToAsset()`), for our specific `fcash` `_toUnderlying` will be `True` so those functions will call `mintViaUnderlying()` and `redeemToUnderlying()` in `wfCashLogic`.\n`mintViaUnderlying()` and `redeemToUnderlying()` in `wfCashLogic` execution flow eventually would call `NotionalV2` functions with `useUnderlying=True` for this specific `fcash` token, but `NotionalV2` will revert for that call because for that `fcash` token asset token is underlying token and `NotionalV2` can't handle calls with `useUnderlying==True` for that `fcash` Token. This will cause all the transaction to fail and manager can't call `redeemFCashPosition()` or `mintFCashPosition()` functions for those `fcash` tokens that asset token is underlying token.\nIn summery `NotionalTradeModule` logic will not work for all `fcash` tokens becasue the logic of `_isUnderlying()` is wrong for `fcash` tokens that asset token is underlying token.\n\n### Tools Used\n\nVIM\n\n### Recommended Mitigation Steps\n\nChange the logic of `_isUnderlying()` in `NotionalTradeModule` so it returns correct results for all `fcash` tokens. One simple solution can be that it first check `payment token`  value with `asset token` value.\n\n**[ckoopmann (Index Coop) confirmed, but disagreed with severity and commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/87#issuecomment-1156022313):**\n > Will need input from @jeffywu here, is the description of the Notional side of things correct ? \n> \n> I'll also try to reproduce this issue in a test maybe to make sure if it is valid.\n> \n> Not sure if this is \"High Risk\" as no funds seem to be at risk. However from the description it might render the `NotionalTradeModule` incompatible with certain fCash tokens, which we certainly want to avoid. So will have to review this in more detail.\n\n**[jeffywu (Notional) commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/87#issuecomment-1156585499):**\n > Agree with @ckoopmann that severity should be reduced here, what this would cause is a revert not any loss of funds.\n> \n> The simple fix would just be to always use `mintViaAsset` and `mintViaUnderlying` for the case when fCash has a non-mintable type (currently there are no fCash assets of this type and none planned). However, we can also add the ability to query this on the wfCash side to make things more compatible.\n\n**[ckoopmann (Index Coop) commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/87#issuecomment-1157114524):**\n > @jeffywu What do you think of the suggested mitigation strategy ? \n> \n> As far as I understand we would just have to change:\n> `isUnderlying = _paymentToken == underlyingToken;` to `isUnderlying = _paymentToken != assetToken;` to avoid the described issue, no ?  \n\n**[jeffywu (Notional) commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/87#issuecomment-1157570874):**\n > To make this more fool proof what I can do is just add a check on the wrapped fCash side to see if the token is non-mintable and then override the useUnderlying flag internally there. I think that will be a better solution since getUnderlyingToken already has logic to return the asset token when it is marked as non-mintable. That would mean that you would not need to make any changes, I think this will make it easier for integrating developers in the future.\n> \n> Specifically add checks here:\n> https://github.com/notional-finance/wrapped-fcash/blob/master/contracts/wfCashLogic.sol#L57-L58\n> and here:\n> https://github.com/notional-finance/wrapped-fcash/blob/master/contracts/wfCashLogic.sol#L210-L211\n> \n> and overwrite the incoming useUnderlying if we are in this situation.\n\n**[ckoopmann (Index Coop) commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/87#issuecomment-1159612676):**\n> @jeffywu Sounds great to me. If I understand correctly that means I would not have to change anything on the trade module side. Let me know if that is incorrect.\n\n**[jeffywu (Notional) resolved and commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/87#issuecomment-1159704963):**\n> @ckoopmann, no changes necessary on your side. You can see the changes [here](https://github.com/notional-finance/wrapped-fcash/pull/11/commits/0ab1ae1080c8eb14fd24d180a01f8ec2c8919022#diff-7c9f6e4700cce75c3c2abb4902f45f7398dcac73135a605b59825b26de7d6af0R60).\n\n> https://github.com/notional-finance/wrapped-fcash/pull/11/commits/0ab1ae1080c8eb14fd24d180a01f8ec2c8919022#diff-7c9f6e4700cce75c3c2abb4902f45f7398dcac73135a605b59825b26de7d6af0R245\n\n**[gzeoneth (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/87#issuecomment-1166523407):**\n> There doesn't seems to be loss of fund as it would revert. Judging as Med Risk.\n\n\n\n***\n\n## [[M-04] `IsWrappedFcash` check is a gas bomb](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/188)\n_Submitted by jonah1005_\n\nIn the `_isWrappedFCash` check, the `notionalTradeModule` check whether the component is a wrappedCash with the following logic.\n\n```solidity\n        try IWrappedfCash(_fCashPosition).getDecodedID() returns(uint16 _currencyId, uint40 _maturity){\n            try wrappedfCashFactory.computeAddress(_currencyId, _maturity) returns(address _computedAddress){\n                return _fCashPosition == _computedAddress;\n            } catch {\n                return false;\n            }\n        } catch {\n            return false;\n        }\n```\n\nThe above logic is dangerous when `_fCashPosition` do not revert on `getDecodedID` but instead give a wrong format of return value. The contract would try to decode the return value into `returns(uint16 _currencyId, uint40 _maturity)` and revert. The revert would consume what ever gas it's provided.\n\n[CETH](https://etherscan.io/address/0x4Ddc2D193948926D02f9B1fE9e1daa0718270ED5) is an example.\nThere's a fallback function in `ceth`\n\n```solidity\n    function () external payable {\n        requireNoError(mintInternal(msg.value), \"mint failed\");\n    }\n```\n\nAs a result, calling `getDecodedID` would not revert. Instead, calling `getDecodedID` of `CETH` would consume all remaining gas.\nThis creates so many issues. First, users would waste too much gas on a regular operation. Second, the transaction might fail if `ceth` is not the last position. Third, the wallet contract can not interact with set token with ceth as it consumes all gas.\n\n### Proof of Concept\n\nThe following contract may fail to redeem setTokens as it consumes too much gas (with 20M gas limit).\n\n[Test.sol](https://gist.github.com/Jonah246/fad9e489fe84a6fb8b4894d7377fd8a2)\n\n```solidity\n    function test(uint256 _amount) external {\n        cToken.approve(address(issueModule), uint256(-1));\n        wfCash.approve(address(issueModule), uint256(-1));\n        issueModule.issue(setToken, _amount, address(this));\n        issueModule.redeem(setToken, _amount, address(this));\n    }\n```\n\nAlso, we can check how much gas it consumes with the following function.\n\n```solidity\n    function TestWrappedFCash(address _fCashPosition) public view returns(bool){\n        if(!_fCashPosition.isContract()) {\n            return false;\n        }\n        try IWrappedfCash(_fCashPosition).getDecodedID() returns(uint16 _currencyId, uint40 _maturity){\n            try wrappedfCashFactory.computeAddress(_currencyId, _maturity) returns(address _computedAddress){\n                return _fCashPosition == _computedAddress;\n            } catch {\n                return false;\n            }\n        } catch {\n            return false;\n        }\n    }\n```\n\nTest this function with `cdai` and `ceth`, we can observe that there's huge difference of gas consumption here.\n\n    Gas used:            30376 of 130376\n    Gas used:            19479394 of 19788041\n\n### Tools Used\n\nHardhat\n\n### Recommended Mitigation Steps\n\nI recommend building a map in the notionalTradeModule and inserting the wrappeCash in the `mintFCashPosition` function.\n\n```solidity\nfunction addWrappedCash(uint16 _currencyId, uint40 _maturity) public {\n    address computedAddress = wrappedfCashFactory.computeAddress(_currencyId, _maturity);\n    wrappedFCash[computedAddress] = true;\n}\n```\n\nOr we could replace the try-catch pattern with a low-level function call and check the return value's length before decoding it.\n\nSomething like this might be a fix.\n\n```solidity\n    (bool success, bytes memory returndata) = target.delegatecall(data);\n    if (!success || returndata.length != DECODED_ID_RETURN_LENGTH) {\n        return false;\n    }\n   // abi.decode ....\n```\n\n**[ckoopmann (Index Coop) confirmed and commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/188#issuecomment-1156028172):**\n > Correct, this is an issue that I also recently ran into (after the contest had already started) when doing additional tests.\n> My solution was to just add a fixed gas limit to the `getDecodedID` call which seemed to solve it. \n> \n> In an earlier version of the contract I had a manual mapping as suggested here, however this is not ideal since the setToken could obtain fCash positions using other SetModules (such as the general TradeModule) which would then not be registered in this mapping. \n> \n> Limiting the gas usage of these calls seems like an easier and more robust mitigation strategy. (might want to make these gas limits updateable though)\n\n**[gzeoneth (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/188#issuecomment-1166539232):**\n > Valid but don't think this is High Risk, `eth_estimateGas` should fail preventing most user from interacting with a ridiculous gas limit. \n\n\n\n***\n\n## [[M-05] transferfCash does not work as expected](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/98)\n_Submitted by csanuragjain_\n\nIf maturity is reached and user has asked for redeem with opts.transferfCash as true, then if (hasMatured()) turns true at wfCashLogic.sol#L216 causing fcash to be cashed out in underlying token and then sent to receiver. So receiver obtains underlying when fcash was expected. The sender wont get an error thinking fcash transfer was success\n\n### Proof of Concept\n\n1.  User A calls redeem with opts.transferfCash as true and receiver as User B\n2.  Since maturity is reached so instead of transferring the fCash, contract would simply cash out fCash and sent the underlying token to the receiver which was not expected\n\n### Recommended Mitigation Steps\n\nIf opts.transferfCash is true and maturity is reached then throw an error mentioning that fCash can no longer be transferred\n\n**[jeffywu (Notional) confirmed](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/98#issuecomment-1156551710):**\n > Sounds reasonable.\n\n\n\n***\n\n## [[M-06] Users Might Not Be Able To Purchase Or Redeem SetToken](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/154)\n_Submitted by xiaoming90, also found by berndartmueller_\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L309>\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L385>\n\n### Proof of Concept\n\nWhenever a setToken is issued or redeemed, the `moduleIssueHook` and `moduleRedeemHook` will be triggered. These two hooks will in turn call the `_redeemMaturedPositions` function to ensure that no matured fCash positions remain in the Set by redeeming any matured fCash position.\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L309>\n\n```solidity\n/**\n * @dev Hook called once before setToken issuance\n * @dev Ensures that no matured fCash positions are in the set when it is issued\n */\nfunction moduleIssueHook(ISetToken _setToken, uint256 /* _setTokenAmount */) external override onlyModule(_setToken) {\n    _redeemMaturedPositions(_setToken);\n}\n\n/**\n * @dev Hook called once before setToken redemption\n * @dev Ensures that no matured fCash positions are in the set when it is redeemed\n */\nfunction moduleRedeemHook(ISetToken _setToken, uint256 /* _setTokenAmount */) external override onlyModule(_setToken) {\n    _redeemMaturedPositions(_setToken);\n}\n```\n\nThe `_redeemMaturedPositions` will loop through all its fCash positions and attempts to redeem any fCash position that has already matured. However, if one of the fCash redemptions fails, it will cause the entire function to revert. If this happens, no one could purchase or redeem the setToken because `moduleIssueHook` and `modileRedeemHook` hooks will revert every single time. Thus, the setToken issuance and redemption will stop working entirely and  this setToken can be considered \"bricked\".\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L385>\n\n```solidity\n/**\n * @dev Redeem all matured fCash positions for the given SetToken\n */\nfunction _redeemMaturedPositions(ISetToken _setToken)\ninternal\n{\n    ISetToken.Position[] memory positions = _setToken.getPositions();\n    uint positionsLength = positions.length;\n\n    bool toUnderlying = redeemToUnderlying[_setToken];\n\n    for(uint256 i = 0; i < positionsLength; i++) {\n        // Check that the given position is an equity position\n        if(positions[i].unit > 0) {\n            address component = positions[i].component;\n            if(_isWrappedFCash(component)) {\n                IWrappedfCashComplete fCashPosition = IWrappedfCashComplete(component);\n                if(fCashPosition.hasMatured()) {\n                    (IERC20 receiveToken,) = fCashPosition.getToken(toUnderlying);\n                    if(address(receiveToken) == ETH_ADDRESS) {\n                        receiveToken = weth;\n                    }\n                    uint256 fCashBalance = fCashPosition.balanceOf(address(_setToken));\n                    _redeemFCashPosition(_setToken, fCashPosition, receiveToken, fCashBalance, 0);\n                }\n            }\n        }\n    }\n}\n```\n\n### Impact\n\nUser will not be able to purchase or redeem the setToken. User's fund will be stuck in the SetToken Contract. Unable to remove matured fCash positions from SetToken and update positions of its asset token.\n\n### Recommended Mitigation Steps\n\nThis is a problem commonly encountered whenever a method of a smart contract calls another contract – you cannot rely on the other contract to work 100% of the time, and it is dangerous to assume that the external call will always be successful.\n\nIt is recommended to:\n\n*   Consider alternate method of updating the asset position so that the SetToken's core functions (e.g. issuance and redemption) will not be locked if one of the matured fCash redemptions fails.\n\n*   Evaluate if `_redeemMaturedPositions` really need to be called during SetToken's issuance and redemption. If not, consider removing them from the hooks, so that any issue or revert within `_redeemMaturedPositions` won't cause the SetToken's issuance and redemption functions to stop working entirely.\n\n*   Consider implementing additional function to give manager/user an option to specify a list of matured fCash positions to redeem instead of forcing them to redeem all matured fCash positions at one go.\n\n**[ckoopmann (Index Coop) acknowledged, but disagreed with severity and commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/154#issuecomment-1155999746):**\n > The `_isWrappedFCash(component)` should make sure that these calls are only executed on valid wrappedfCash instances deployed from the configured factory. \n> \n> The issue does not outline a practical scenario / test case where this issue would actually arise. \n> If it did the manager could probably still remove / redeem the component either via this module, or one of the other Trade modules.\n> \n> However I'll have to look into this if I can find a scenario where this would actually arise.\n> I will also consider making this redeem step optional, but I will have to think more about this as this might introduce other more serious issues.\n\n > @jeffywu Do you see any scenario where the redemption of a matured fCash position might fail in this context`? \n> \n> EDIT: Just noticed that https://github.com/code-423n4/2022-06-notional-coop-findings/issues/226 mentions (among others) the scenario of USDC tokens being blocked which I guess is unlikely but outside of our control. This makes me think we might want to make the redemption of matured tokens during issuance / redemption optional.\n\n**[ckoopmann (Index Coop) confirmed and commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/154#issuecomment-1157134636):**\n > Changed label from acknowledged to confirmed, since on second thought I think we likely want to adopt some kind of mitigation strategy for this. However still tentative / unclear which strategy we want to adopt.\n\n\n\n***\n\n## [[M-07] Residual Allowance Might Allow Tokens In SetToken To Be Stolen](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/160)\n_Submitted by xiaoming90_\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L418>\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L493>\n\n### Proof of Concept\n\nWhenever `_mintFCashPosition` function is called to mint new fCash position, the contract will call the `_approve` function to set the allowance to `_maxSendAmount` so that the fCash Wrapper contact can pull the payment tokens from the SetToken contract during minting.\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L418>\n\n```solidity\nfunction _mintFCashPosition(\n    ISetToken _setToken,\n    IWrappedfCashComplete _fCashPosition,\n    IERC20 _sendToken,\n    uint256 _fCashAmount,\n    uint256 _maxSendAmount\n)\ninternal\nreturns(uint256 sentAmount)\n{\n    if(_fCashAmount == 0) return 0;\n    bool fromUnderlying = _isUnderlying(_fCashPosition, _sendToken); \n\n    _approve(_setToken, _fCashPosition, _sendToken, _maxSendAmount);\n\n    uint256 preTradeSendTokenBalance = _sendToken.balanceOf(address(_setToken));\n    uint256 preTradeReceiveTokenBalance = _fCashPosition.balanceOf(address(_setToken));\n\n    _mint(_setToken, _fCashPosition, _maxSendAmount, _fCashAmount, fromUnderlying)\n\n\t..SNIP..\n}\n```\n\nNote that `_maxSendAmount` is the maximum amount of payment tokens that is allowed to be consumed during minting. This is not the actual amount of payment tokens consumed during the minting process. Thus, after the minting, there will definitely be some residual allowance since it is unlikely that the fCash wrapper contract will consume the exact maximum amount during minting.\n\nThe following piece of code shows that having some residual allowance is expected. The `_approve` function will not set the allowance unless there is insufficient allowance.\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L493>\n\n```solidity\n/**\n * @dev Approve the given wrappedFCash instance to spend the setToken's sendToken \n */\nfunction _approve(\n    ISetToken _setToken,\n    IWrappedfCashComplete _fCashPosition,\n    IERC20 _sendToken,\n    uint256 _maxAssetAmount\n)\ninternal\n{\n    if(IERC20(_sendToken).allowance(address(_setToken), address(_fCashPosition)) < _maxAssetAmount) {\n        bytes memory approveCallData = abi.encodeWithSelector(_sendToken.approve.selector, address(_fCashPosition), _maxAssetAmount);\n        _setToken.invoke(address(_sendToken), 0, approveCallData);\n    }\n}\n```\n\n### Impact\n\nHaving residual allowance increases the risk of the asset tokens being stolen from the SetToken contract. SetToken contract is where all the tokens/assets are held. If the Notional's fCash wrapper contract is compromised, it will allow the compromised fCash wrapper contract to withdraw funds from the SetToken contract due to the residual allowance.\n\nNote that Notional's fCash wrapper contract is not totally immutable, as it is a upgradeable contract. This is an additional risk factor to be considered. If the Notional's deployer account is compromised, the attacker could upgrade the Notional's fCash wrapper contract to a malicious one to withdraw funds from the Index Coop's SetToken contract due to the residual allowance.\n\nIndex Coop and Notional are two separate protocols and teams. Thus, it is a good security practice not to place any trust on external party wherever possible to ensure that if one party is compromised, it won't affect the other party. Thus, there should not be any residual allowance that allows Notional's contract to withdraw funds from Index Coop's contract in any circumstance.\n\nIn the worst case scenario, a \"lazy\" manager might simply set the `_maxAssetAmount` to `type(uint256).max`. Thus, this will result in large amount of residual allowance left, and expose the SetToken contract to significant risk.\n\n### Recommended Mitigation Steps\n\nApprove the allowance on-demand whenever \\_`mintFCashPosition` is called, and reset the allowance back to zero after each minting process to eliminate any residual allowance.\n\n```diff\nfunction _mintFCashPosition(\n    ISetToken _setToken,\n    IWrappedfCashComplete _fCashPosition,\n    IERC20 _sendToken,\n    uint256 _fCashAmount,\n    uint256 _maxSendAmount\n)\ninternal\nreturns(uint256 sentAmount)\n{\n    if(_fCashAmount == 0) return 0;\n    bool fromUnderlying = _isUnderlying(_fCashPosition, _sendToken); \n\n    _approve(_setToken, _fCashPosition, _sendToken, _maxSendAmount);\n\n    uint256 preTradeSendTokenBalance = _sendToken.balanceOf(address(_setToken));\n    uint256 preTradeReceiveTokenBalance = _fCashPosition.balanceOf(address(_setToken));\n\n    _mint(_setToken, _fCashPosition, _maxSendAmount, _fCashAmount, fromUnderlying)\n\n\t..SNIP..\n\t\n+\t// Reset the allowance back to zero after minting\n+\t_approve(_setToken, _fCashPosition, _sendToken, 0);\n}\n```\n\nUpdate the `_approve` accordingly to remove the if-statement related to residual allowance.\n\n```diff\nfunction _approve(\n    ISetToken _setToken,\n    IWrappedfCashComplete _fCashPosition,\n    IERC20 _sendToken,\n    uint256 _maxAssetAmount\n)\ninternal\n{\n-    if(IERC20(_sendToken).allowance(address(_setToken), address(_fCashPosition)) < _maxAssetAmount) {\n        bytes memory approveCallData = abi.encodeWithSelector(_sendToken.approve.selector, address(_fCashPosition), _maxAssetAmount);\n        _setToken.invoke(address(_sendToken), 0, approveCallData);\n-    }\n}\n```\n\n\n**[ckoopmann (Index Coop) confirmed and commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/160#issuecomment-1156002724):**\n> This looks like a prudent suggestion.\n> Will review and potentially adopt the suggested mitigation.\n\n\n\n***\n\n## [[M-08] DOS set token through erc777 hook](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/168)\n_Submitted by jonah1005_\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/main/index-coop-notional-trade-module/contracts/protocol/modules/v1/DebtIssuanceModule.sol#L131-L141>\n\n<https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC777/ERC777.sol#L376-L380>\n\n### Impact\n\nThe `wfCash` is an `erc777` token. [ERC777.sol#L376-L380](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC777/ERC777.sol#L376-L380) Users can get the control flow before sending token and after receiving tokens. This creates attack vectors that require extra caution in designing modules. Any combination of modules may lead to a possible exploit. To elaborate on the dangerousness of the re-entrancy attack, a possible scenario is presented.\n\nBefore the exploit, we first elaborate on three attack vectors:\n\n1.  [DebtIssuanceModule.sol#L131-L141](https://github.com/code-423n4/2022-06-notional-coop/blob/main/index-coop-notional-trade-module/contracts/protocol/modules/v1/DebtIssuanceModule.sol#L131-L141) The issuance module would pull tokens from the sender before minting setToken.\n\nAssume there are three compoenents in this set. 1. CDai. 2. wfCash  In the `_callTokensToSend`, the setToken has received `cdai` and the `totalSupply` is still the same.\n\n2.  `nonReentrant` does not protect cross-contract re-entrancy. This means, that during the `issue` of issuance module, users can trigger other modules' functions.\n\n3.  Restricted functions with `onlyManagerAndValidSet` modifier may be triggered by the exploiter as well. Manager of a setToken is usually a manager contract. Assume it's a multisig-wallet, the exploiter can front-run the execute transaction and replay the payload during his exploit. Note, a private transaction from flash-bot can still be front-run. Please refer to the [uncle bandit risk](https://docs.flashbots.net/flashbots-protect/rpc/uncle-bandits)\n\nGiven the above attack vectors, the exploiter have enough weapons to exploit the `setToken` at a propriate time. Note that different combination of modules may have different exploit paths. As long as the above attack vectors remain, the setToken is vulnerable.\n\nAssume a setToken with `CompoundLeverageModule`, `NotionalTradeModule` and `BasicIssuanceModule` with the following positions: 1. CDAI: 100  2. wfCash-DAI 100  and totalSupply = 100. The community decides to remove the `compoundLeverageModule` from the set token. Since `notionalTradeModule` can handle cDAI, the community vote to just call `removeModule` to remove `compoundLeverageModule`. The exploiter has the time to build an exploit and wait the right timing to come.\n\n0.  The exploiter listen the manager multisig wallet.\n1.  Exploiter issue 10 setToken.\n2.  During the `_callTokensToSend` of `wfcash`, the totalSupply = 100, CDAI = 110, wfCash-DAI = 110.\n3.  Call `sync` of `CompoundLeverageModule`. `_getCollateralPosition` get  `_cToken.balanceOf(address(_setToken)) = 110` and `totalSupply = 100` and update the `DefaultUnit` of `CETH` 1,1X.\n4.  Replay multisig wallet's payload and remove `compoundLeverageModule`.\n5.  The `setToken` can no longer issue / redeem as it would raise `undercollateralized` error. Further, `setValuer` would give a pumped valuation that may cause harm to other protocols.\n\n### Proof of Concept\n\n[POC](https://gist.github.com/Jonah246/13e58b59765c0334189c99a9f29c6dab)\nThe exploit is quite lengthy. Please check the `Attack.sol` for the main exploit logic.\n\n```solidity\n    function register() public {\n        _ERC1820_REGISTRY.setInterfaceImplementer(address(this), _TOKENS_SENDER_INTERFACE_HASH, address(this));\n        _ERC1820_REGISTRY.setInterfaceImplementer(address(this), _TOKENS_SENDER_INTERFACE_HASH, address(this));\n    }\n\n    function attack(uint256 _amount) external {\n        cToken.approve(address(issueModule), uint256(-1));\n        wfCash.approve(address(issueModule), uint256(-1));\n        issueModule.issue(setToken, _amount, address(this));\n    }\n\n    function tokensToSend(\n        address operator,\n        address from,\n        address to,\n        uint256 amount,\n        bytes calldata userData,\n        bytes calldata operatorData\n    ) external {\n        compoundModule.sync(setToken, false);\n        manager.removeModule(address(setToken));\n    }\n```\n\n### Recommended Mitigation Steps\n\nThe design choice of wfcash being an `ERC777` seems unnecessary to me. Over the past two years, ERC777 leads to so many exploits. [IMBTC-UNISWAP](https://defirate.com/imbtc-uniswap-hack/) [CREAM-AMP](https://twitter.com/CreamdotFinance/status/1432249771750686721?s=20) I recommend the team use ERC20 instead.\n\nIf the SetToken team considers supporting ERC777 necessary, I recommend implementing protocol-wide cross-contract reentrancy prevention. Please refer to Rari-Capital. [Comptroller.sol#L1978-L2002](https://github.com/Rari-Capital/fuse-v1/blob/development/src/core/Comptroller.sol#L1978-L2002)\n\nNote that, `Rari` was [exploited](https://www.coindesk.com/business/2022/04/30/defi-lender-rari-capitalfei-loses-80m-in-hack/) given this reentrancy prevention. Simply making `nonReentrant` cross-contact prevention may not be enough. I recommend to setToken protocol going through every module and re-consider whether it's re-entrancy safe.\n\n**[ckoopmann (Index Coop) commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/168#issuecomment-1156059002):**\n > @jeffywu : What do you think ? Can we drop the ERC777 interface from wfCash (it's not used by the NotionalTradeModule afaik). \n> If not, I'll have to review this issue in more details and see if we need a mitigation on our side.\n> \n> Note that the issue mostly references the DebtIssuanceModule which we probably wont / cant change unless there is a major vulnerability.\n\n**[jeffywu (Notional) confirmed and commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/168#issuecomment-1156580278):**\n > @ckoopmann I think we can just drop ERC777\n\n\n\n***\n\n## [[M-09] Silent overflow of `_fCashAmount`](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/239)\n_Submitted by GreyArt, also found by Meera_\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L526>\n\n### Description\n\nIf a `_fCashAmount` value that is greater than uint88 is passed into the `_mint` function, downcasting it to uint88 will silently overflow.\n\n### Recommended Mitigation Steps\n\n```solidity\n// Use a safe downcast function e.g. wfCashLogic::_safeUint88\nfunction _safeUint88(uint256 x) internal pure returns (uint88) {hil\n    require(x <= uint256(type(uint88).max));\n    return uint88(x);\n}\n```\n\n**[ckoopmann (Index Coop) confirmed and commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/239#issuecomment-1168122818):**\n> This seems reasonable and we'll probably adopt the suggested mitigation approach.\n\n\n\n***\n\n## [[M-10] User can alter amount returned by redeem function due to control transfer](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/235)\n_Submitted by 0xDjango_\n\nControl is transferred to the receiver when receiving the ERC777. They are able to transfer the ERC777 to another account, at which time the before and after balance calculation will be incorrect.\n\n            uint256 balanceBefore = IERC20(asset()).balanceOf(receiver);\n\n\n            if (msg.sender != owner) {\n                _spendAllowance(owner, msg.sender, shares);\n            }\n            _redeemInternal(shares, receiver, owner);\n    /////////////\n    Control is transferred to user. They can alter their balance here.\n    ///////////\n\n            uint256 balanceAfter = IERC20(asset()).balanceOf(receiver);\n            uint256 assets = balanceAfter - balanceBefore;\n\n    //////////\n    Assets can be as low as 0 if they have transferred the same amount out as received.\n    //////////\n\n            emit Withdraw(msg.sender, receiver, owner, assets, shares);\n            return assets;\n\n**[jeffywu (Notional) disputed and commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/235#issuecomment-1156430793):**\n > Control of the contract is not transferred to anyone during a `balanceOf` call which is read only. No state can be modified.\n\n**[fatherGoose1 (warden) commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/235#issuecomment-1156545128):**\n > The control is transferred in `_redeemInternal()` which calls `_burn()` on the ERC777 which transfers control. \n> \n> `_burn()` function logic here: https://github.com/OpenZeppelin/openzeppelin-contracts/blob/109778c17c7020618ea4e035efb9f0f9b82d43ca/contracts/token/ERC777/ERC777.sol#L390-L400\n\n**[jeffywu (Notional) confirmed and commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/235#issuecomment-1156599036):**\n > Understood, will change to confirmed.\n\n\n\n***\n\n\n\n# Low Risk and Non-Critical Issues\n\nFor this contest, 61 reports were submitted by wardens detailing low risk and non-critical issues. The [report highlighted below](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/215) by **berndartmueller** received the top score from the judge.\n\n*The following wardens also submitted reports: [IllIllI](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/112), [GimelSec](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/152), [sorrynotsorry](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/192), [xiaoming90](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/164), [GreyArt](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/104), [Meera](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/150), [jonah1005](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/222), [joestakey](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/84), [unforgiven](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/80), [Funen](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/202), [0xf15ers](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/186), [Ruhum](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/63), [Picodes](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/227), [hyh](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/228), [fatherOfBlocks](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/122), [Deivitto](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/131), [zzzitron](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/142), [Trumpero](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/165), [TomJ](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/177), [TerrierLover](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/69), [sseefried](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/93), [simon135](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/209), [PierrickGT](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/101), [oyc_109](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/10), [minhquanym](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/146), [ellahi](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/218), [csanuragjain](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/96), [cloudjunky](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/94), [Chom](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/138), [cccz](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/44), [Bronicle](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/220), [antonttc](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/194), [0xDjango](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/234), [0x29A](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/114), [0x1f8b](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/40), [Sm4rty](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/16), [saian](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/180), [sach1r0](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/29), [Nethermind](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/189), [kenzo](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/169), [hake](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/190), [dipp](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/208), [delfin454000](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/120), [cryptphi](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/92), [Cityscape](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/170), [catchup](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/140), [c3phas](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/205), [0xNineDec](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/48), [0xNazgul](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/27), [0xmint](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/210), [_Adam](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/128), [z3s](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/136), [Waze](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/171), [Tadashi](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/233), [slywaters](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/119), [Lambda](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/73), [JC](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/232), [hansfriese](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/125), [ayeslick](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/106), and [0xkatana](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/49).*\n\n## Codebase Impressions & Summary\n\nOverall, the contracts are very well implemented and the code quality is very high. Protocol developers provided adequate documentation and information on the protocol.\n\nRunning the test suite is extensive and covers most of the code, however, a few things stood out:\n\n*   `test_wrapped_fcash.test_transfer_fcash_contract` is skipped\n*   many tests are failing on the forked mainnet due to using addresses with insufficient token balances (e.g. `whales.DAI_EOA` has insufficient DAI tokens)\n*   the `notionalTradeModule.spec` test suite has many open `TODOs`\n\n## Table of Contents\n\n*   Low Risk\n    *   [L-01] Zero-address checks are missing\n    *   [L-02] Use of floating pragma\n    *   [L-03] Events not emitted for important state changes\n    *   [L-04] Matured fCash positions not automatically redeemed in `NotionalTradeModule.initialize`\n    *   [L-05] Misleading `NotionalTradeModule._mintFCashPosition` function comments]\n    *   [L-06] Misleading comment in `wfCashLogic._burn` function\n    *   [L-07] Matured fCash can still be wrapped via `ERC1155` `transfer`\n    *   [L-08] Contracts are using outdated OpenZeppelin version `^3.4.2-solc-0.7`\n    *   [L-09] `wfCashERC4626` contract does not conform to `EIP4626`\n*   Non-Critical Findings\n    *   [N-01] Use the `isETH` return value from `wfCashBase.getToken` instead of checking equality with `ETH_ADDRESS`\n\n## [L-01] Zero-address checks are missing\n\nZero-address checks are a best practice for input validation of critical address parameters. While the codebase applies this to most cases, there are many places where this is missing in constructors and setters.\n\nImpact: Accidental use of zero-addresses may result in exceptions, burn fees/tokens, or force redeployment of contracts.\n\n### Findings\n\n**[NotionalTradeModule.sol](https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol)**\n\n[L140](https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L140) - `wrappedfCashFactory = _wrappedfCashFactory;`\\\n[L141](https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L141) - `weth = _weth;`\n\n**[wfCashBase.sol](https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashBase.sol)**\n\n[L30](https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashBase.sol#L30) - `NotionalV2 = _notional;`\\\n[L31](https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashBase.sol#L31) - `WETH = _weth;`\n\n**[WrappedfCashFactory.sol](https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/proxy/WrappedfCashFactory.sol)**\n\n[L18](https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/proxy/WrappedfCashFactory.sol#L18) - `BEACON = _beacon;`\n\n### Recommended Mitigation Steps\n\nAdd zero-address checks, e.g.:\n\n```solidity\nrequire(_weth != address(0), \"Zero-address\");\n```\n\n## [L-02] Use of floating pragma\n\nContracts should be deployed with the same compiler version and flags that they have been tested with thoroughly. Locking the pragma helps to ensure that contracts do not accidentally get deployed using, for example, an outdated compiler version that might introduce bugs that affect the contract system negatively.\n\n<https://swcregistry.io/docs/SWC-103>\n\n### Findings\n\n[wfCashERC4626.sol](https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L2) `pragma solidity ^0.8.0;`\n\n### Recommended Mitigation Steps\n\nLock the pragma version to the same version as used in the other contracts and also consider known bugs (<https://github.com/ethereum/solidity/releases>) for the compiler version that is chosen.\n\nPragma statements can be allowed to float when a contract is intended for consumption by other developers, as in the case with contracts in a library or EthPM package. Otherwise, the developer would need to manually update the pragma in order to compile it locally.\n\n## [L-03] Events not emitted for important state changes\n\nWhen changing state variables events are not emitted. Emitting events allows monitoring activities with off-chain monitoring tools.\n\n### Findings\n\n[NotionalTradeModule.sol#L301](https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L301) `function setRedeemToUnderlying(ISetToken _setToken, bool _toUnderlying)`\n\n### Recommended Mitigation Steps\n\nEmit events for state variable changes.\n\n## [L-04] Matured fCash positions not automatically redeemed in `NotionalTradeModule.initialize`\n\nThe function comments imply that matured fCash positions are redeemed within `NotionalTradeModule.initialize`. However, this redemption is not implemented in this function.\n\n### Findings\n\n[NotionalTradeModule.sol#L216](https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L216)\n\n```solidity\n* Redeem all fCash positions that have reached maturity for their asset token (cToken)\n```\n\n### Recommended Mitigation Steps\n\nConsider calling the function `_redeemMaturedPositions` to redeem matured fCash positions or adapt the function comments.\n\n## [L-05] Misleading `NotionalTradeModule._mintFCashPosition` function comments\n\nThe function comments imply that the given fCash position is redeemed. However, this function implements **minting** fCash tokens.\n\n### Findings\n\n[NotionalTradeModule.sol#L415](https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L415)\n\n```solidity\n* @dev Redeem a given fCash position from the specified send token (either underlying or asset token)\n```\n\n### Recommended Mitigation Steps\n\nFix the comments to mention minting instead of redeeming.\n\n## [L-06] Misleading comment in `wfCashLogic._burn` function\n\nThe comment next to the `_withdrawCashToAccount` function call implies that the `from` address is the withdrawal receiver. However, `opts.receiver` is the receiver.\n\n### Findings\n\n[wfCashLogic.sol#L230](https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashLogic.sol#L230)\n\n```solidity\n // Transfer withdrawn tokens to the `from` address // @audit-info wrong comment - should be `... to the `opts.receiver` address`\n  _withdrawCashToAccount(\n      currencyId,\n      opts.receiver,\n      _safeUint88(assetInternalCashClaim),\n      opts.redeemToUnderlying\n  );\n```\n\n### Recommended Mitigation Steps\n\nFix the comment.\n\n## [L-07] Matured fCash can still be wrapped via `ERC1155` `transfer`\n\nContrary to the key invariants stated in the [README](https://github.com/code-423n4/2022-06-notional-coop/) (*\"After maturity, wrapped fCash can no longer be minted.\"*), matured fCash can be sent to this `wfCash` contract to receive wrapped fCash tokens in return.\n\n### Findings\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashLogic.sol#L107-L152>\n\n### Recommended Mitigation Steps\n\nConsider adding a check for fCash maturity:\n\n```solidity\nrequire(!hasMatured(), \"fCash matured\");\n```\n\n## [L-08] Contracts are using outdated OpenZeppelin version `^3.4.2-solc-0.7`\n\nWithin `notional-wrapped-fcash` `package.json`, an outdated OZ version is used (which has known vulnerabilities, see <https://snyk.io/vuln/npm%3A%40openzeppelin%2Fcontracts>).\n\nHowever, as `Brownie` is used to install dependencies and compile the contracts, using this outdated version declared in the `package.json` does not impose any risks so far.\n\nAnyway, to prevent any issues in the future (e.g. using solely `hardhat` to compile and deploy the contracts), upgrade the used OZ packages within the `package.json` to the latest versions.\n\nSee similar findings:\n\n*   <https://github.com/code-423n4/2022-02-hubble-findings/issues/81>\n*   <https://github.com/code-423n4/2022-02-hubble-findings/issues/81>\n\n### Findings\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/main/notional-wrapped-fcash/package.json#L14>\n\n### Recommended Mitigation Steps\n\nConsider using the latest OZ packages within `package.json`.\n\n## [L-09] `wfCashERC4626` contract does not conform to `EIP4626`\n\nThe `wfCashERC4626` contract implements the `EIP4626` standard ([EIP-4626: Tokenized Vault Standard](https://eips.ethereum.org/EIPS/eip-4626)).\n\nHowever, according to `EIP4626`, the below-mentioned functions do not fully adhere to the specs. They possibly revert due to `require` checks or revert due to external calls reverting.\n\n### Findings\n\n[L47](https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L47) - `function totalAssets() public view override returns (uint256)`\n\nPossibly reverts due to `_getMaturedValue` and `_getPresentValue` reverting.\n\n[L52](https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L52) - `function convertToShares(uint256 assets) public view override returns (uint256 shares)`\n\nPossibly reverts due to `_getPresentValue` and `totalAssets` reverting.\n\n[L64](https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L64) - `function convertToAssets(uint256 shares) public view override returns (uint256 assets)`\n\nPossibly reverts due to `_getPresentValue` and `totalAssets` reverting.\n\n[L85](https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L85) - `function maxWithdraw(address owner) public view override returns (uint256)`\n\nPossibly reverts due to `convertToShares` within `previewWithdraw` reverting.\n\n### Recommended Mitigation Steps\n\nGiven the circumstances, in most of the mentioned cases, it's not possible to implement it without ever reverting. Nevertheless, I want to point out that this contract does not fully conform with the `EIP4626` standard.\n\n## [N-01] Use the `isETH` return value from `wfCashBase.getToken` instead of checking equality with `ETH_ADDRESS`\n\nThe `wfCashBase.getToken` returns `bool isETH` which can be used to figure out if the returned token is the native ETH token.\n\n### Findings\n\n[NotionalTradeModule.sol#L400-L403](https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L400-L403)\n\n```solidity\n(IERC20 receiveToken,) = fCashPosition.getToken(toUnderlying);\nif(address(receiveToken) == ETH_ADDRESS) { // @audit-info use returned `isETH` variable from above function instead\n    receiveToken = weth;\n}\n```\n\n### Recommended Mitigation Steps\n\nConsider using the returned `isETH` variable:\n\n```solidity\n(IERC20 receiveToken, bool isETH) = fCashPosition.getToken(toUnderlying);\nif(isETH) {\n    receiveToken = weth;\n}\n```\n**[ckoopmann (Index Coop) commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/215#issuecomment-1158384906):**\n > Very nice QA report imo. All the issues regarding the NotionalTradeModule are valid and actionable. Also good format and concise description of the issues and proposed mitigation / fix.\n\n***\n\n# Gas Optimizations\n\nFor this contest, 55 reports were submitted by wardens detailing gas optimizations. The [report highlighted below](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/111) by **IllIllI** received the top score from the judge.\n\n*The following wardens also submitted reports: [antonttc](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/184), [Meera](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/148), [0xKitsune](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/187), [joestakey](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/83), [0xkatana](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/50), [0x29A](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/113), [0x1f8b](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/39), [Waze](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/172), [PierrickGT](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/100), [hyh](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/223), [GreyArt](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/105), [delfin454000](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/117), [Chom](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/204), [berndartmueller](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/213), [TomJ](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/149), [Tomio](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/107), [TerrierLover](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/70), [slywaters](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/118), [simon135](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/158), [rfa](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/175), [8olidity](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/71), [0xf15ers](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/185), [_Adam](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/127), [0xSolus](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/64), [UnusualTurtle](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/173), [saian](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/178), [sach1r0](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/28), [Picodes](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/224), [oyc_109](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/9), [ellahi](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/217), [Deivitto](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/130), [catchup](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/141), [c3phas](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/212), [asutorufos](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/41), [Sm4rty](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/7), [samruna](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/2), [kaden](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/55), [Funen](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/203), [fatherOfBlocks](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/121), [ElKu](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/134), [DavidGialdi](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/81), [csanuragjain](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/95), [Cityscape](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/166), [0xNazgul](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/26), [0v3rf10w](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/201), [ynnad](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/109), [Tadashi](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/231), [minhquanym](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/147), [Lambda](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/72), [hansfriese](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/124), [hake](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/191), [Fitraldys](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/230), [djxploit](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/25), and [0xmint](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/211).*\n\n|    | Issue                                                                                                                       | Instances |\n| -- | :-------------------------------------------------------------------------------------------------------------------------- | :-------: |\n| 1  | Avoid contract existence checks by using solidity version 0.8.10 or later                                                   |     6     |\n| 2  | Multiple accesses of a mapping/array should use a local variable cache                                                      |     5     |\n| 3  | `internal` functions only called once can be inlined to save gas                                                            |     7     |\n| 4  | `<array>.length` should not be looked up in every loop of a `for`-loop                                                      |     2     |\n| 5  | `require()`/`revert()` strings longer than 32 bytes cost extra gas                                                          |     4     |\n| 6  | `private` functions not called by the contract should be removed to save deployment gas                                     |     1     |\n| 7  | Optimize names to save gas                                                                                                  |     1     |\n| 8  | Using `bool`s for storage incurs overhead                                                                                   |     3     |\n| 9  | Use a more recent version of solidity                                                                                       |     1     |\n| 10 | Use a more recent version of solidity                                                                                       |     1     |\n| 11 | It costs more gas to initialize non-`constant`/non-`immutable` variables to zero than to let the default of zero be applied |     7     |\n| 12 | `++i` costs less gas than `i++`, especially when it's used in `for`-loops (`--i`/`i--` too)                                 |     5     |\n| 13 | Splitting `require()` statements that use `&&` saves gas                                                                    |     2     |\n| 14 | Usage of `uints`/`ints` smaller than 32 bytes (256 bits) incurs overhead                                                    |     53    |\n| 15 | `abi.encode()` is less efficient than `abi.encodePacked()`                                                                  |     3     |\n| 16 | Using `private` rather than `public` for constants, saves gas                                                               |     1     |\n| 17 | Use custom errors rather than `revert()`/`require()` strings to save gas                                                    |     17    |\n| 18 | Functions guaranteed to revert when called by normal users can be marked `payable`                                          |     14    |\n\nTotal: 133 instances over 18 issues\n\n## [1] Avoid contract existence checks by using solidity version 0.8.10 or later\n\nPrior to 0.8.10 the compiler inserted extra code, including `EXTCODESIZE` (**700 gas**), to check for contract existence for external calls. In more recent solidity versions, the compiler will not insert these checks if the external call has a return value\n\n*There are 6 instances of this issue:*\n\n```solidity\nFile: index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol\n\n/// @audit registerToIssuanceModule()\n239:              try IDebtIssuanceModule(modules[i]).registerToIssuanceModule(_setToken) {} catch {}\n\n/// @audit unregisterFromIssuanceModule()\n256:                  try IDebtIssuanceModule(modules[i]).unregisterFromIssuanceModule(setToken) {} catch {}\n\n/// @audit allowance()\n501:          if(IERC20(_sendToken).allowance(address(_setToken), address(_fCashPosition)) < _maxAssetAmount) {\n\n/// @audit getDecodedID()\n639:          try IWrappedfCash(_fCashPosition).getDecodedID() returns(uint16 _currencyId, uint40 _maturity){\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L239>\n\n```solidity\nFile: notional-wrapped-fcash/contracts/wfCashERC4626.sol\n\n/// @audit balanceOf()\n212:          uint256 balanceBefore = IERC20(asset()).balanceOf(receiver);\n\n/// @audit balanceOf()\n219:          uint256 balanceAfter = IERC20(asset()).balanceOf(receiver);\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L212>\n\n## [2] Multiple accesses of a mapping/array should use a local variable cache\n\nThe instances below point to the second+ access of a value inside a mapping/array, within a function. Caching a mapping's value in a local `storage` variable when the value is accessed [multiple times](https://gist.github.com/IllIllI000/ec23a57daa30a8f8ca8b9681c8ccefb0), saves **\\~42 gas per access** due to not having to recalculate the key's keccak256 hash (Gkeccak256 - **30 gas**) and that calculation's associated stack operations. Caching an array's struct avoids recalculating the array offsets into memory\n\n*There are 5 instances of this issue:*\n\n```solidity\nFile: index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol\n\n/// @audit positions[i] on line 395\n396:                  address component = positions[i].component;\n\n/// @audit positions[i] on line 607\n608:                  address component = positions[i].component;\n\n/// @audit positions[i] on line 619\n620:                  address component = positions[i].component;\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L396>\n\n```solidity\nFile: notional-wrapped-fcash/contracts/wfCashLogic.sol\n\n/// @audit assets[0] on line 133\n134:                  assets[0].maturity,\n\n/// @audit assets[0] on line 134\n135:                  assets[0].assetType\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashLogic.sol#L134>\n\n## [3] `internal` functions only called once can be inlined to save gas\n\nNot inlining costs **20 to 40 gas** because of two extra `JUMP` instructions and additional stack operations needed for function calls.\n\n*There are 7 instances of this issue:*\n\n```solidity\nFile: index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol\n\n368:      function _deployWrappedfCash(uint16 _currencyId, uint40 _maturity) internal returns(IWrappedfCashComplete) {\n\n376:      function _getWrappedfCash(uint16 _currencyId, uint40 _maturity) internal view returns(IWrappedfCashComplete) {\n\n418       function _mintFCashPosition(\n419           ISetToken _setToken,\n420           IWrappedfCashComplete _fCashPosition,\n421           IERC20 _sendToken,\n422           uint256 _fCashAmount,\n423           uint256 _maxSendAmount\n424       )\n425       internal\n426:      returns(uint256 sentAmount)\n\n493       function _approve(\n494           ISetToken _setToken,\n495           IWrappedfCashComplete _fCashPosition,\n496           IERC20 _sendToken,\n497:          uint256 _maxAssetAmount\n\n537       function _redeem(\n538           ISetToken _setToken,\n539           IWrappedfCashComplete _fCashPosition,\n540           uint256 _fCashAmount,\n541:          bool _toUnderlying\n\n581       function _getUnderlyingAndAssetTokens(IWrappedfCashComplete _fCashPosition)\n582       internal\n583       view\n584:      returns(IERC20 underlyingToken, IERC20 assetToken)\n\n596       function _getFCashPositions(ISetToken _setToken)\n597       internal\n598       view\n599:      returns(address[] memory fCashPositions)\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L368>\n\n## [4] `<array>.length` should not be looked up in every loop of a `for`-loop\n\nThe overheads outlined below are *PER LOOP*, excluding the first loop\n\n*   storage arrays incur a Gwarmaccess (**100 gas**)\n*   memory arrays use `MLOAD` (**3 gas**)\n*   calldata arrays use `CALLDATALOAD` (**3 gas**)\n\nCaching the length changes each of these to a `DUP<N>` (**3 gas**), and gets rid of the extra `DUP<N>` needed to store the stack offset\n\n*There are 2 instances of this issue:*\n\n```solidity\nFile: index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol   #1\n\n238:          for(uint256 i = 0; i < modules.length; i++) {\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L238>\n\n```solidity\nFile: index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol   #2\n\n254:          for(uint256 i = 0; i < modules.length; i++) {\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L254>\n\n## [5] `require()`/`revert()` strings longer than 32 bytes cost extra gas\n\nEach extra chunk of byetes past the original 32 i[incurs an MSTORE](https://gist.github.com/hrkrshnn/ee8fabd532058307229d65dcd5836ddc#consider-having-short-revert-strings) which costs 3 gas\n\n*There are 4 instances of this issue:*\n\n```solidity\nFile: index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol   #1\n\n169:          require(_setToken.isComponent(address(_sendToken)), \"Send token must be an index component\");\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L169>\n\n```solidity\nFile: index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol   #2\n\n199:          require(_setToken.isComponent(address(wrappedfCash)), \"FCash to redeem must be an index component\");\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L199>\n\n```solidity\nFile: index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol   #3\n\n378:          require(wrappedfCashAddress.isContract(), \"WrappedfCash not deployed for given parameters\");\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L378>\n\n```solidity\nFile: index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol   #4\n\n573:              require(_paymentToken == assetToken, \"Token is neither asset nor underlying token\");\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L573>\n\n## [6] `private` functions not called by the contract should be removed to save deployment gas\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: notional-wrapped-fcash/contracts/wfCashERC4626.sol   #1\n\n243:      function _safeNegInt88(uint256 x) private pure returns (int88) {\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L243>\n\n## [7] Optimize names to save gas\n\n`public`/`external` function names and `public` member variable names can be optimized to save gas. See [this](https://gist.github.com/IllIllI000/a5d8b486a8259f9f77891a919febd1a9) link for an example of how it works. Below are the interfaces/abstract contracts that can be optimized so that the most frequently-called functions use the least amount of gas possible during method lookup. Method IDs that have two leading zero bytes can save **128 gas** each during deployment, and renaming functions to have lower method IDs will save **22 gas** per call, [per sorted position shifted](https://medium.com/joyso/solidity-how-does-function-name-affect-gas-consumption-in-smart-contract-47d270d8ac92)\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: notional-wrapped-fcash/contracts/wfCashBase.sol   #1\n\n/// @audit getToken()\n16:   abstract contract wfCashBase is ERC777Upgradeable, IWrappedfCash {\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashBase.sol#L16>\n\n## [8] Using `bool`s for storage incurs overhead\n\n```solidity\n    // Booleans are more expensive than uint256 or any type that takes up a full\n    // word because each write operation emits an extra SLOAD to first read the\n    // slot's contents, replace the bits taken up by the boolean, and then write\n    // back. This is the compiler's defense against contract upgrades and\n    // pointer aliasing, and it cannot be disabled.\n```\n\n<https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27>\nUse `uint256(1)` and `uint256(2)` for true/false to avoid a Gwarmaccess (**[100 gas](https://gist.github.com/IllIllI000/1b70014db712f8572a72378321250058)**) for the extra SLOAD, and to avoid Gsset (**20000 gas**) when changing from 'false' to 'true', after having been 'true' in the past\n\n*There are 3 instances of this issue:*\n\n```solidity\nFile: index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol   #1\n\n112:      mapping(ISetToken => bool) public redeemToUnderlying;\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L112>\n\n```solidity\nFile: index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol   #2\n\n115:      mapping(ISetToken => bool) public allowedSetTokens;\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L115>\n\n```solidity\nFile: index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol   #3\n\n118:      bool public anySetAllowed;\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L118>\n\n## [9] Use a more recent version of solidity\n\nUse a solidity version of at least 0.8.0 to get overflow protection without `SafeMath`\nUse a solidity version of at least 0.8.2 to get simple compiler automatic inlining\nUse a solidity version of at least 0.8.3 to get better struct packing and cheaper multiple storage reads\nUse a solidity version of at least 0.8.4 to get custom errors, which are cheaper at deployment than `revert()/require()` strings\nUse a solidity version of at least 0.8.10 to have external calls skip contract existence checks if the external call has a return value\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol   #1\n\n19:   pragma solidity 0.6.10;\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L19>\n\n## [10] Use a more recent version of solidity\n\nUse a solidity version of at least 0.8.2 to get simple compiler automatic inlining\nUse a solidity version of at least 0.8.3 to get better struct packing and cheaper multiple storage reads\nUse a solidity version of at least 0.8.4 to get custom errors, which are cheaper at deployment than `revert()/require()` strings\nUse a solidity version of at least 0.8.10 to have external calls skip contract existence checks if the external call has a return value\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: notional-wrapped-fcash/contracts/wfCashERC4626.sol   #1\n\n2:    pragma solidity ^0.8.0;\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L2>\n\n## [11] It costs more gas to initialize non-`constant`/non-`immutable` variables to zero than to let the default of zero be applied\n\n*There are 7 instances of this issue:*\n\n```solidity\nFile: index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol\n\n48:       address internal constant ETH_ADDRESS = address(0);\n\n238:          for(uint256 i = 0; i < modules.length; i++) {\n\n254:          for(uint256 i = 0; i < modules.length; i++) {\n\n393:          for(uint256 i = 0; i < positionsLength; i++) {\n\n519:          uint32 minImpliedRate = 0;\n\n605:          for(uint256 i = 0; i < positionsLength; i++) {\n\n618:          for(uint256 i = 0; i < positionsLength; i++) {\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L48>\n\n## [12] `++i` costs less gas than `i++`, especially when it's used in `for`-loops (`--i`/`i--` too)\n\nSaves **6 gas per loop**\n\n*There are 5 instances of this issue:*\n\n```solidity\nFile: index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol\n\n238:          for(uint256 i = 0; i < modules.length; i++) {\n\n254:          for(uint256 i = 0; i < modules.length; i++) {\n\n393:          for(uint256 i = 0; i < positionsLength; i++) {\n\n605:          for(uint256 i = 0; i < positionsLength; i++) {\n\n618:          for(uint256 i = 0; i < positionsLength; i++) {\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L238>\n\n## [13] Splitting `require()` statements that use `&&` saves gas\n\nSee [this issue](https://github.com/code-423n4/2022-01-xdefi-findings/issues/128) which describes the fact that there is a larger deployment gas cost, but with enough runtime calls, the change ends up being cheaper\n\n*There are 2 instances of this issue:*\n\n```solidity\nFile: notional-wrapped-fcash/contracts/wfCashLogic.sol   #1\n\n116           require(\n117               msg.sender == address(NotionalV2) &&\n118               // Only accept the fcash id that corresponds to the listed currency and maturity\n119               _id == fCashID &&\n120               // Protect against signed value underflows\n121               int256(_value) > 0,\n122               \"Invalid\"\n123:          );\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashLogic.sol#L116-L123>\n\n```solidity\nFile: notional-wrapped-fcash/contracts/wfCashLogic.sol   #2\n\n129           require(\n130               ac.hasDebt == 0x00 &&\n131               assets.length == 1 &&\n132               EncodeDecode.encodeERC1155Id(\n133                   assets[0].currencyId,\n134                   assets[0].maturity,\n135                   assets[0].assetType\n136               ) == fCashID\n137:          );\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashLogic.sol#L129-L137>\n\n## [14] Usage of `uints`/`ints` smaller than 32 bytes (256 bits) incurs overhead\n\n> When using elements that are smaller than 32 bytes, your contract’s gas usage may be higher. This is because the EVM operates on 32 bytes at a time. Therefore, if the element is smaller than that, the EVM must use more operations in order to reduce the size of the element from 32 bytes to the desired size.\n\n<https://docs.soliditylang.org/en/v0.8.11/internals/layout_in_storage.html>\nUse a larger size then downcast where needed\n\n*There are 53 instances of this issue:*\n\n```solidity\nFile: index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol\n\n158:          uint16 _currencyId,\n\n159:          uint40 _maturity,\n\n187:          uint16 _currencyId,\n\n188:          uint40 _maturity,\n\n368:      function _deployWrappedfCash(uint16 _currencyId, uint40 _maturity) internal returns(IWrappedfCashComplete) {\n\n368:      function _deployWrappedfCash(uint16 _currencyId, uint40 _maturity) internal returns(IWrappedfCashComplete) {\n\n376:      function _getWrappedfCash(uint16 _currencyId, uint40 _maturity) internal view returns(IWrappedfCashComplete) {\n\n376:      function _getWrappedfCash(uint16 _currencyId, uint40 _maturity) internal view returns(IWrappedfCashComplete) {\n\n519:          uint32 minImpliedRate = 0;\n\n545:          uint32 maxImpliedRate = type(uint32).max;\n\n639:          try IWrappedfCash(_fCashPosition).getDecodedID() returns(uint16 _currencyId, uint40 _maturity){\n\n639:          try IWrappedfCash(_fCashPosition).getDecodedID() returns(uint16 _currencyId, uint40 _maturity){\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L158>\n\n```solidity\nFile: notional-wrapped-fcash/contracts/wfCashBase.sol\n\n35:       function initialize(uint16 currencyId, uint40 maturity) external override initializer {\n\n35:       function initialize(uint16 currencyId, uint40 maturity) external override initializer {\n\n83:       function getMaturity() public view override returns (uint40 maturity) {\n\n93:       function getCurrencyId() public view override returns (uint16 currencyId) {\n\n98:       function getDecodedID() public view override returns (uint16 currencyId, uint40 maturity) {\n\n98:       function getDecodedID() public view override returns (uint16 currencyId, uint40 maturity) {\n\n103:      function decimals() public pure override returns (uint8) {\n\n109:      function getMarketIndex() public view override returns (uint8) {\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashBase.sol#L35>\n\n```solidity\nFile: notional-wrapped-fcash/contracts/proxy/WrappedfCashFactory.sol\n\n15:       event WrapperDeployed(uint16 currencyId, uint40 maturity, address wrapper);\n\n15:       event WrapperDeployed(uint16 currencyId, uint40 maturity, address wrapper);\n\n21:       function _getByteCode(uint16 currencyId, uint40 maturity) internal view returns (bytes memory) {\n\n21:       function _getByteCode(uint16 currencyId, uint40 maturity) internal view returns (bytes memory) {\n\n26:       function deployWrapper(uint16 currencyId, uint40 maturity) external returns (address) {\n\n26:       function deployWrapper(uint16 currencyId, uint40 maturity) external returns (address) {\n\n39:       function computeAddress(uint16 currencyId, uint40 maturity) public view returns (address) {\n\n39:       function computeAddress(uint16 currencyId, uint40 maturity) public view returns (address) {\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/proxy/WrappedfCashFactory.sol#L15>\n\n```solidity\nFile: notional-wrapped-fcash/contracts/wfCashERC4626.sol\n\n18:           uint16 currencyId = getCurrencyId();\n\n31:           (uint16 currencyId, uint40 maturity) = getDecodedID();\n\n31:           (uint16 currencyId, uint40 maturity) = getDecodedID();\n\n100:              (uint16 currencyId, uint40 maturity) = getDecodedID();\n\n100:              (uint16 currencyId, uint40 maturity) = getDecodedID();\n\n120:              (uint16 currencyId, uint40 maturity) = getDecodedID();\n\n120:              (uint16 currencyId, uint40 maturity) = getDecodedID();\n\n139:              (uint16 currencyId, uint40 maturity) = getDecodedID();\n\n139:              (uint16 currencyId, uint40 maturity) = getDecodedID();\n\n157:              (uint16 currencyId, uint40 maturity) = getDecodedID();\n\n157:              (uint16 currencyId, uint40 maturity) = getDecodedID();\n\n243:      function _safeNegInt88(uint256 x) private pure returns (int88) {\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L18>\n\n```solidity\nFile: notional-wrapped-fcash/contracts/wfCashLogic.sol\n\n29:           uint88 fCashAmount,\n\n31:           uint32 minImpliedRate\n\n43:           uint88 fCashAmount,\n\n45:           uint32 minImpliedRate\n\n52:           uint88 fCashAmount,\n\n54:           uint32 minImpliedRate,\n\n169:          uint32 maxImpliedRate\n\n187:          uint32 maxImpliedRate\n\n222:              uint16 currencyId = getCurrencyId();\n\n261:          uint16 currencyId,\n\n263:          uint88 assetInternalCashClaim,\n\n279:          uint32 maxImpliedRate\n\n315:      function _safeUint88(uint256 x) internal pure returns (uint88) {\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashLogic.sol#L29>\n\n## [15] `abi.encode()` is less efficient than `abi.encodePacked()`\n\n*There are 3 instances of this issue:*\n\n```solidity\nFile: notional-wrapped-fcash/contracts/proxy/WrappedfCashFactory.sol   #1\n\n23:           return abi.encodePacked(type(nBeaconProxy).creationCode, abi.encode(BEACON, initCallData));\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/proxy/WrappedfCashFactory.sol#L23>\n\n```solidity\nFile: notional-wrapped-fcash/contracts/wfCashERC4626.sol   #2\n\n230           bytes memory userData = abi.encode(\n231               RedeemOpts({\n232                   redeemToUnderlying: true,\n233                   transferfCash: false,\n234                   receiver: receiver,\n235                   maxImpliedRate: 0\n236               })\n237:          );\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L230-L237>\n\n```solidity\nFile: notional-wrapped-fcash/contracts/wfCashLogic.sol   #3\n\n159:          bytes memory data = abi.encode(opts);\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashLogic.sol#L159>\n\n## [16] Using `private` rather than `public` for constants, saves gas\n\nIf needed, the value can be read from the verified contract source code. Savings are due to the compiler not having to create non-payable getter functions for deployment calldata, and not adding another entry to the method ID table\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: notional-wrapped-fcash/contracts/proxy/WrappedfCashFactory.sol   #1\n\n12:       bytes32 public constant SALT = 0;\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/proxy/WrappedfCashFactory.sol#L12>\n\n## [17] Use custom errors rather than `revert()`/`require()` strings to save gas\n\nCustom errors are available from solidity version 0.8.4. Custom errors save [**\\~50 gas**](https://gist.github.com/IllIllI000/ad1bd0d29a0101b25e57c293b4b0c746) each time they're hitby [avoiding having to allocate and store the revert string](https://blog.soliditylang.org/2021/04/21/custom-errors/#errors-in-depth). Not defining the strings also save deployment gas\n\n*There are 17 instances of this issue:*\n\n```solidity\nFile: index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol\n\n169:          require(_setToken.isComponent(address(_sendToken)), \"Send token must be an index component\");\n\n199:          require(_setToken.isComponent(address(wrappedfCash)), \"FCash to redeem must be an index component\");\n\n227:              require(allowedSetTokens[_setToken], \"Not allowed SetToken\");\n\n234:          require(_setToken.isInitializedModule(getAndValidateAdapter(DEFAULT_ISSUANCE_MODULE_NAME)), \"Issuance not initialized\");\n\n269:          require(_setToken.isInitializedModule(address(_debtIssuanceModule)), \"Issuance not initialized\");\n\n280:          require(controller.isSet(address(_setToken)) || allowedSetTokens[_setToken], \"Invalid SetToken\");\n\n378:          require(wrappedfCashAddress.isContract(), \"WrappedfCash not deployed for given parameters\");\n\n449:          require(sentAmount <= _maxSendAmount, \"Overspent\");\n\n485:          require(receivedAmount >= _minReceiveAmount, \"Not enough received amount\");\n\n573:              require(_paymentToken == assetToken, \"Token is neither asset nor underlying token\");\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L169>\n\n```solidity\nFile: notional-wrapped-fcash/contracts/wfCashBase.sol\n\n37:           require(cashGroup.maxMarketIndex > 0, \"Invalid currency\");\n\n40            require(\n41                DateTime.isValidMaturity(cashGroup.maxMarketIndex, maturity, block.timestamp),\n42                \"Invalid maturity\"\n43:           );\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashBase.sol#L37>\n\n```solidity\nFile: notional-wrapped-fcash/contracts/wfCashERC4626.sol\n\n23:           require(underlyingExternal > 0, \"Must Settle\");\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashERC4626.sol#L23>\n\n```solidity\nFile: notional-wrapped-fcash/contracts/wfCashLogic.sol\n\n57:           require(!hasMatured(), \"fCash matured\");\n\n116           require(\n117               msg.sender == address(NotionalV2) &&\n118               // Only accept the fcash id that corresponds to the listed currency and maturity\n119               _id == fCashID &&\n120               // Protect against signed value underflows\n121               int256(_value) > 0,\n122               \"Invalid\"\n123:          );\n\n211:          require(opts.receiver != address(0), \"Receiver is zero address\");\n\n225:              require(0 < cashBalance, \"Negative Cash Balance\");\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/notional-wrapped-fcash/contracts/wfCashLogic.sol#L57>\n\n## [18] Functions guaranteed to revert when called by normal users can be marked `payable`\n\nIf a function modifier such as `onlyOwner` is used, the function will revert if a normal user tries to pay the function. Marking the function as `payable` will lower the gas cost for legitimate callers because the compiler will not include checks for whether a payment was provided. The extra opcodes avoided are\n`CALLVALUE`(2),`DUP1`(3),`ISZERO`(3),`PUSH2`(3),`JUMPI`(10),`PUSH1`(3),`DUP1`(3),`REVERT`(0),`JUMPDEST`(1),`POP`(2), which costs an average of about **21 gas per call** to the function, in addition to the extra deployment cost\n\n*There are 14 instances of this issue:*\n\n```solidity\nFile: index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol\n\n156       function mintFCashPosition(\n157           ISetToken _setToken,\n158           uint16 _currencyId,\n159           uint40 _maturity,\n160           uint256 _mintAmount,\n161           address _sendToken,\n162           uint256 _maxSendAmount\n163       )\n164           external\n165           nonReentrant\n166           onlyManagerAndValidSet(_setToken)\n167:          returns(uint256)\n\n185       function redeemFCashPosition(\n186           ISetToken _setToken,\n187           uint16 _currencyId,\n188           uint40 _maturity,\n189           uint256 _redeemAmount,\n190           address _receiveToken,\n191           uint256 _minReceiveAmount\n192       )\n193           external\n194           nonReentrant\n195           onlyManagerAndValidSet(_setToken)\n196:          returns(uint256)\n\n210:      function redeemMaturedPositions(ISetToken _setToken) public nonReentrant onlyValidAndInitializedSet(_setToken) {\n\n219       function initialize(\n220           ISetToken _setToken\n221       )\n222           external\n223           onlySetManager(_setToken, msg.sender)\n224:          onlyValidAndPendingSet(_setToken)\n\n219       function initialize(\n220           ISetToken _setToken\n221       )\n222           external\n223           onlySetManager(_setToken, msg.sender)\n224:          onlyValidAndPendingSet(_setToken)\n\n246:      function removeModule() external override onlyValidAndInitializedSet(ISetToken(msg.sender)) {\n\n268:      function registerToModule(ISetToken _setToken, IDebtIssuanceModule _debtIssuanceModule) external onlyManagerAndValidSet(_setToken) {\n\n279:      function updateAllowedSetToken(ISetToken _setToken, bool _status) external onlyOwner {\n\n289:      function updateAnySetAllowed(bool _anySetAllowed) external onlyOwner {\n\n294       function setRedeemToUnderlying(\n295           ISetToken _setToken,\n296           bool _toUnderlying\n297       )\n298       external\n299:      onlyManagerAndValidSet(_setToken)\n\n309:      function moduleIssueHook(ISetToken _setToken, uint256 /* _setTokenAmount */) external override onlyModule(_setToken) {\n\n317:      function moduleRedeemHook(ISetToken _setToken, uint256 /* _setTokenAmount */) external override onlyModule(_setToken) {\n\n326       function componentIssueHook(\n327           ISetToken _setToken,\n328           uint256 _setTokenAmount,\n329           IERC20 _component,\n330           bool _isEquity\n331:      ) external override onlyModule(_setToken) {\n\n338       function componentRedeemHook(\n339           ISetToken _setToken,\n340           uint256 _setTokenAmount,\n341           IERC20 _component,\n342           bool _isEquity\n343:      ) external override onlyModule(_setToken) {\n```\n\n<https://github.com/code-423n4/2022-06-notional-coop/blob/6f8c325f604e2576e2fe257b6b57892ca181509a/index-coop-notional-trade-module/contracts/protocol/modules/v1/NotionalTradeModule.sol#L156-L167>\n\n**[jeffywu (Notional) commented](https://github.com/code-423n4/2022-06-notional-coop-findings/issues/111#issuecomment-1157589271):**\n > Well organized report\n\n\n\n\n***\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}